<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drivers Dashboard - Lynx Lite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  
  <!-- Feedback Storage System -->
  <script src="feedback-storage.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
      transition: background-color 0.3s, color 0.3s;
    }
    .dark body {
      background: linear-gradient(to bottom, #18181b, #27272a);
      color: #e5e7eb;
    }
    .dark .bg-white {
      background: #23272f !important;
      color: #e5e7eb !important;
    }
    .dark .text-gray-900 {
      color: #f3f4f6 !important;
    }
    .dark .text-gray-600 {
      color: #d1d5db !important;
    }
    .widget-card {
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: move;
    }
    .widget-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
    }
    .alert-item {
      transition: opacity 0.3s;
    }
    .alert-item.snoozed {
      opacity: 0.5;
    }
    .timeline-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }

    .sidebar-hidden {
      transform: translateX(-100%);
    }
    .alert-toast {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    @media (max-width: 768px) {
      header {
        left: 0 !important;
      }
      #sidebar {
        width: 100% !important;
        position: fixed;
        z-index: 30;
        top: 5rem !important;
        height: calc(100vh - 5rem) !important;
        transform: translateX(-100%);
      }
      #sidebar.active {
        transform: translateX(0);
      }
      #main-content-container {
        margin-left: 0 !important;
        padding-left: 1rem !important;
        padding-right: 1rem !important;
      }
      .widget-grid, .grid {
        grid-template-columns: 1fr !important;
      }
      .fleet-table {
        display: none;
      }
      .mobile-driver-cards {
        display: block;
      }
      .hidden-mobile {
        display: none !important;
      }
    }
    
    .sidebar-hidden + main {
      margin-left: 0 !important;
    }
    
    .sidebar-hidden ~ header {
      left: 0 !important;
    }
    
    @media (min-width: 769px) {
      .mobile-driver-cards {
        display: none;
      }
    }
    .fleet-table th, .fleet-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .fleet-table th {
      background: #f1f5f9;
      font-weight: 600;
    }
    .dark .fleet-table th {
      background: #374151;
    }
    .dark .fleet-table td {
      border-bottom: 1px solid #4b5563;
    }
    .driver-selector {
      min-width: 200px;
    }
    
    /* Fleet overview styles - driver navigation styles removed */
    .driver-status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    
    .status-active { background-color: #10b981; }
    .status-on-break { background-color: #f59e0b; }
    .status-offline { background-color: #ef4444; }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <header class="bg-white dark:bg-gray-800 shadow flex justify-between items-center px-6 py-4 z-30 fixed top-0 left-72 right-0" aria-label="Driver Dashboard Header">
    <div class="flex items-center space-x-4">
      <button id="sidebar-toggle" class="text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle Sidebar" tabindex="0">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <h1 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">Fleet Management Dashboard</h1>
    </div>
    <div class="flex items-center space-x-3">
      <input type="text" id="quick-search" placeholder="Search fleet data..." class="hidden md:block border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-4 py-2 rounded-lg w-48 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" aria-label="Quick Search">
      <div class="flex items-center space-x-2">
        <button id="voice-command-btn" class="text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 p-2" aria-label="Voice Command" tabindex="0">
          <i class="fas fa-microphone"></i>
        </button>
        <button id="dark-mode-toggle" class="text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 p-2" aria-label="Toggle Dark Mode" tabindex="0">
          <i class="fas fa-moon"></i>
        </button>
        <button id="sos-button" class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500 text-sm" aria-label="Emergency SOS" tabindex="0">
          <i class="fas fa-exclamation-triangle mr-1"></i>
          <span class="hidden sm:inline">SOS</span>
        </button>
        <button id="feedback-toggle" class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700 transition-colors flex items-center gap-2 text-sm" title="Submit Feedback">
          <i class="fas fa-comment-dots"></i>
          <span class="hidden lg:inline">Feedback</span>
        </button>
      </div>
    </div>
  </header>

  <aside id="sidebar" class="w-64 bg-blue-900 text-white flex flex-col py-6 px-4 fixed top-20 left-0 h-[calc(100vh-5rem)] z-20 transition-transform duration-300" aria-label="Driver Navigation">
    <nav class="space-y-4">
      <a href="index.html" class="nav-link group flex items-center px-3 py-2 text-sm font-semibold text-white bg-blue-700 rounded-lg" role="menuitem" tabindex="0">
        <i class="fas fa-tachometer-alt fa-fw mr-3"></i><span class="nav-text">Main Dashboard</span>
      </a>
      <a href="#" class="nav-link group flex items-center px-3 py-2 text-sm font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-700" data-view="fleet-overview" role="menuitem" tabindex="0">
        <i class="fas fa-users fa-fw mr-3"></i><span class="nav-text">Fleet Overview</span>
      </a>
      <a href="#" class="nav-link group flex items-center px-3 py-2 text-sm font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-700" data-view="dashboard" role="menuitem" tabindex="0">
        <i class="fas fa-tachometer-alt fa-fw mr-3"></i><span class="nav-text">Individual Dashboard</span>
      </a>
      <a href="#" class="nav-link group flex items-center px-3 py-2 text-sm font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-700" data-view="messages" role="menuitem" tabindex="0">
        <i class="fas fa-envelope fa-fw mr-3"></i><span class="nav-text">Messages</span>
        <span id="unread-count" class="ml-auto bg-red-500 text-white text-xs rounded-full px-2 py-1 hidden">3</span>
      </a>
      <a href="#" class="nav-link group flex items-center px-3 py-2 text-sm font-medium text-blue-200 rounded-lg hover...

System: ...text-white hover:bg-blue-700" role="menuitem" tabindex="0">
        <i class="fas fa-question-circle fa-fw mr-3"></i><span class="nav-text">Help & Support</span>
      </a>
    </nav>
  </aside>

  <main id="main-content-container" class="flex-1 bg-transparent ml-64 pt-20 px-6 min-h-screen" aria-label="Main Content">
    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-20 right-4 z-50 space-y-2"></div>
    
    <!-- Add Driver Modal -->
    <div id="add-driver-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="add-driver-title">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 id="add-driver-title" class="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
            <i class="fas fa-user-plus mr-3 text-blue-600"></i>
            Add New Driver - Onboarding
          </h3>
          <button id="close-add-driver-modal" class="text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-2xl" aria-label="Close Modal">×</button>
        </div>
        
        <form id="add-driver-form" class="space-y-6">
          <!-- Personal Information -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
              <i class="fas fa-user mr-2 text-blue-600"></i>
              Personal Information
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">First Name *</label>
                <input type="text" id="driver-first-name" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Name *</label>
                <input type="text" id="driver-last-name" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date of Birth *</label>
                <input type="date" id="driver-dob" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Gender</label>
                <select id="driver-gender" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="">Select Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                  <option value="prefer-not-to-say">Prefer not to say</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address *</label>
                <input type="email" id="driver-email" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone Number *</label>
                <input type="tel" id="driver-phone" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
            </div>
          </div>

          <!-- Address Information -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
              <i class="fas fa-map-marker-alt mr-2 text-green-600"></i>
              Address Information
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Street Address *</label>
                <input type="text" id="driver-address" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">City *</label>
                <input type="text" id="driver-city" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">State/Province *</label>
                <input type="text" id="driver-state" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ZIP/Postal Code *</label>
                <input type="text" id="driver-zip" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Country *</label>
                <input type="text" id="driver-country" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
            </div>
          </div>

          <!-- License Information -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
              <i class="fas fa-id-card mr-2 text-purple-600"></i>
              Driver's License Information
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">License Number *</label>
                <input type="text" id="driver-license-number" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">License Type *</label>
                <select id="driver-license-type" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="">Select License Type</option>
                  <option value="Class A">Class A (Commercial)</option>
                  <option value="Class B">Class B (Commercial)</option>
                  <option value="Class C">Class C (Commercial)</option>
                  <option value="Class D">Class D (Regular)</option>
                  <option value="CDL">CDL (Commercial Driver's License)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">License State/Province *</label>
                <input type="text" id="driver-license-state" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">License Expiry Date *</label>
                <input type="date" id="driver-license-expiry" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Years of Driving Experience *</label>
                <input type="number" id="driver-experience" min="0" max="50" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Endorsements</label>
                <select id="driver-endorsements" multiple class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="H">H - Hazardous Materials</option>
                  <option value="N">N - Tank Vehicles</option>
                  <option value="P">P - Passenger Vehicles</option>
                  <option value="S">S - School Buses</option>
                  <option value="T">T - Double/Triple Trailers</option>
                  <option value="X">X - Hazardous Materials & Tank Vehicles</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Employment Information -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
              <i class="fas fa-briefcase mr-2 text-orange-600"></i>
              Employment Information
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employment Start Date *</label>
                <input type="date" id="driver-start-date" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Department/Group *</label>
                <select id="driver-department" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="">Select Department</option>
                  <option value="Delivery">Delivery</option>
                  <option value="Service">Service</option>
                  <option value="Executive">Executive</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Logistics">Logistics</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Position/Title *</label>
                <input type="text" id="driver-position" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employee ID</label>
                <input type="text" id="driver-employee-id" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Hourly Rate</label>
                <input type="number" id="driver-hourly-rate" min="0" step="0.01" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employment Status *</label>
                <select id="driver-status" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="">Select Status</option>
                  <option value="Full-time">Full-time</option>
                  <option value="Part-time">Part-time</option>
                  <option value="Contract">Contract</option>
                  <option value="Temporary">Temporary</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Emergency Contact -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
              <i class="fas fa-phone-alt mr-2 text-red-600"></i>
              Emergency Contact
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Emergency Contact Name *</label>
                <input type="text" id="driver-emergency-name" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Relationship *</label>
                <select id="driver-emergency-relationship" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="">Select Relationship</option>
                  <option value="Spouse">Spouse</option>
                  <option value="Parent">Parent</option>
                  <option value="Sibling">Sibling</option>
                  <option value="Child">Child</option>
                  <option value="Friend">Friend</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Emergency Contact Phone *</label>
                <input type="tel" id="driver-emergency-phone" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Emergency Contact Email</label>
                <input type="email" id="driver-emergency-email" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
            </div>
          </div>

          <!-- Medical Information -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
              <i class="fas fa-heartbeat mr-2 text-pink-600"></i>
              Medical Information
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Medical Certificate Expiry *</label>
                <input type="date" id="driver-medical-expiry" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Blood Type</label>
                <select id="driver-blood-type" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="">Select Blood Type</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Medical Conditions (if any)</label>
                <textarea id="driver-medical-conditions" rows="3" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="List any medical conditions, allergies, or medications..."></textarea>
              </div>
            </div>
          </div>

          <!-- Vehicle Assignment -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
              <i class="fas fa-truck mr-2 text-teal-600"></i>
              Vehicle Assignment
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Preferred Vehicle Type</label>
                <select id="driver-vehicle-type" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="">Select Vehicle Type</option>
                  <option value="Light Truck">Light Truck</option>
                  <option value="Heavy Truck">Heavy Truck</option>
                  <option value="Van">Van</option>
                  <option value="Car">Car</option>
                  <option value="Bus">Bus</option>
                  <option value="Trailer">Trailer</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Assigned Vehicle ID</label>
                <input type="text" id="driver-assigned-vehicle" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., VEH-001">
              </div>
            </div>
          </div>

          <!-- Notes & Additional Information -->
          <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
              <i class="fas fa-sticky-note mr-2 text-yellow-600"></i>
              Notes & Additional Information
            </h4>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Special Notes</label>
              <textarea id="driver-notes" rows="4" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Any additional notes, special requirements, or important information about the driver..."></textarea>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex justify-end gap-4 pt-6 border-t border-gray-200 dark:border-gray-600">
            <button type="button" id="cancel-add-driver" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
            <button type="button" id="save-draft-driver" class="px-6 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
              <i class="fas fa-save mr-2"></i>Save Draft
            </button>
            <button type="submit" id="submit-add-driver" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              <i class="fas fa-user-plus mr-2"></i>Add Driver
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- Voice Command Modal -->
    <div id="voice-command-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="voice-command-title">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
        <h3 id="voice-command-title" class="text-lg font-bold text-gray-900 dark:text-white mb-4">Voice Command</h3>
        <div class="space-y-4">
          <input type="text" id="voice-input" placeholder="Say 'Navigate to Warehouse A' or 'Log break'" class="block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2">
          <div class="flex justify-end gap-2">
            <button id="cancel-voice" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
            <button id="submit-voice" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Eco-Driving Tip Modal -->
    <div id="eco-tip-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="eco-tip-title">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
        <h3 id="eco-tip-title" class="text-lg font-bold text-gray-900 dark:text-white mb-4">Eco-Driving Tip</h3>
        <div id="eco-tip-content" class="space-y-4 text-gray-600 dark:text-gray-400"></div>
        <div class="flex justify-end gap-2 mt-4">
          <button id="close-eco-tip" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">Close</button>
        </div>
      </div>
    </div>
    <!-- Dashboard View -->
    <div id="dashboard-view" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-4">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">Individual Driver Dashboard</h2>
          <div class="flex items-center gap-2">
            <label for="driver-selector" class="text-sm font-medium text-gray-700 dark:text-gray-300">Driver:</label>
            <select id="driver-selector" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 px-3 py-2 min-w-48">
              <option value="">Select Driver</option>
            </select>
          </div>
        </div>
        <div class="flex items-center gap-2">
        <button id="customize-dashboard-btn" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
          <i class="fas fa-sliders-h mr-1"></i>Customize
        </button>
          <button id="export-driver-data-btn" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm font-medium">
            <i class="fas fa-download mr-1"></i>Export Data
          </button>
          <button id="print-driver-report-btn" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 text-sm font-medium">
            <i class="fas fa-print mr-1"></i>Print Report
          </button>
      </div>
      </div>

      <!-- Executive Controls Panel -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
          <i class="fas fa-crown mr-2 text-yellow-600"></i>
          Executive Management Controls
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- Driver Status Management -->
          <div class="space-y-3">
            <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Status Management</h4>
            <div class="space-y-2">
              <button id="suspend-driver-btn" class="w-full bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700">
                <i class="fas fa-user-slash mr-1"></i>Suspend Driver
              </button>
              <button id="activate-driver-btn" class="w-full bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
                <i class="fas fa-user-check mr-1"></i>Activate Driver
              </button>
              <button id="terminate-driver-btn" class="w-full bg-red-800 text-white px-3 py-2 rounded text-sm hover:bg-red-900">
                <i class="fas fa-user-times mr-1"></i>Terminate Driver
              </button>
            </div>
          </div>

          <!-- Performance Management -->
          <div class="space-y-3">
            <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Performance Actions</h4>
            <div class="space-y-2">
              <button id="issue-warning-btn" class="w-full bg-yellow-500 text-white px-3 py-2 rounded text-sm hover:bg-yellow-600">
                <i class="fas fa-exclamation-triangle mr-1"></i>Issue Warning
              </button>
              <button id="schedule-training-btn" class="w-full bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                <i class="fas fa-graduation-cap mr-1"></i>Schedule Training
              </button>
              <button id="performance-review-btn" class="w-full bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">
                <i class="fas fa-clipboard-check mr-1"></i>Performance Review
              </button>
            </div>
          </div>

          <!-- Vehicle & Route Management -->
          <div class="space-y-3">
            <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Vehicle & Route</h4>
            <div class="space-y-2">
              <button id="assign-vehicle-btn" class="w-full bg-indigo-600 text-white px-3 py-2 rounded text-sm hover:bg-indigo-700">
                <i class="fas fa-truck mr-1"></i>Assign Vehicle
              </button>
              <button id="change-route-btn" class="w-full bg-teal-600 text-white px-3 py-2 rounded text-sm hover:bg-teal-700">
                <i class="fas fa-route mr-1"></i>Change Route
              </button>
              <button id="emergency-stop-btn" class="w-full bg-red-700 text-white px-3 py-2 rounded text-sm hover:bg-red-800">
                <i class="fas fa-stop-circle mr-1"></i>Emergency Stop
              </button>
            </div>
          </div>

          <!-- Communication & Monitoring -->
          <div class="space-y-3">
            <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Communication</h4>
            <div class="space-y-2">
              <button id="emergency-call-btn" class="w-full bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700">
                <i class="fas fa-phone-alt mr-1"></i>Emergency Call
              </button>
              <button id="send-urgent-message-btn" class="w-full bg-orange-600 text-white px-3 py-2 rounded text-sm hover:bg-orange-700">
                <i class="fas fa-comment-exclamation mr-1"></i>Urgent Message
              </button>
              <button id="enable-monitoring-btn" class="w-full bg-gray-600 text-white px-3 py-2 rounded text-sm hover:bg-gray-700">
                <i class="fas fa-eye mr-1"></i>Enable Monitoring
              </button>
            </div>
          </div>
        </div>

        <!-- Advanced Executive Options -->
        <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Quick Actions -->
            <div class="space-y-2">
              <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Quick Actions</h4>
              <div class="flex gap-2">
                <button id="lock-vehicle-btn" class="flex-1 bg-gray-600 text-white px-2 py-1 rounded text-xs hover:bg-gray-700">
                  <i class="fas fa-lock mr-1"></i>Lock Vehicle
                </button>
                <button id="disable-eld-btn" class="flex-1 bg-gray-600 text-white px-2 py-1 rounded text-xs hover:bg-gray-700">
                  <i class="fas fa-power-off mr-1"></i>Disable ELD
                </button>
              </div>
            </div>

            <!-- Compliance Actions -->
            <div class="space-y-2">
              <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Compliance</h4>
              <div class="flex gap-2">
                <button id="drug-test-btn" class="flex-1 bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">
                  <i class="fas fa-flask mr-1"></i>Drug Test
                </button>
                <button id="medical-review-btn" class="flex-1 bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">
                  <i class="fas fa-heartbeat mr-1"></i>Medical Review
                </button>
              </div>
            </div>

            <!-- Administrative -->
            <div class="space-y-2">
              <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Administrative</h4>
              <div class="flex gap-2">
                <button id="update-schedule-btn" class="flex-1 bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">
                  <i class="fas fa-calendar mr-1"></i>Update Schedule
                </button>
                <button id="payroll-adjust-btn" class="flex-1 bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">
                  <i class="fas fa-dollar-sign mr-1"></i>Payroll Adjust
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Direct Driver Messaging Panel -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
          <i class="fas fa-comments mr-2 text-blue-600"></i>
          Direct Driver Communication
        </h3>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Quick Message Templates -->
          <div class="lg:col-span-1">
            <h4 class="font-semibold text-gray-900 dark:text-white text-sm mb-3">Quick Message Templates</h4>
            <div class="space-y-2">
              <button class="quick-message-btn w-full text-left px-3 py-2 rounded bg-blue-50 dark:bg-blue-900 text-blue-700 dark:text-blue-200 text-sm hover:bg-blue-100 dark:hover:bg-blue-800" data-template="safety-reminder">
                <i class="fas fa-shield-alt mr-2"></i>Safety Reminder
              </button>
              <button class="quick-message-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-template="route-update">
                <i class="fas fa-route mr-2"></i>Route Update
              </button>
              <button class="quick-message-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-template="break-reminder">
                <i class="fas fa-coffee mr-2"></i>Break Reminder
              </button>
              <button class="quick-message-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-template="performance-feedback">
                <i class="fas fa-star mr-2"></i>Performance Feedback
              </button>
              <button class="quick-message-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-template="maintenance-alert">
                <i class="fas fa-tools mr-2"></i>Maintenance Alert
              </button>
              <button class="quick-message-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-template="weather-warning">
                <i class="fas fa-cloud-rain mr-2"></i>Weather Warning
              </button>
            </div>
          </div>

          <!-- Message Composer -->
          <div class="lg:col-span-2">
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <h4 class="font-semibold text-gray-900 dark:text-white text-sm">Send Message to Driver</h4>
                <div class="flex gap-2">
                  <button id="send-message-btn" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
                    <i class="fas fa-paper-plane mr-1"></i>Send Message
                  </button>
                  <button id="schedule-message-btn" class="bg-yellow-600 text-white px-4 py-2 rounded text-sm hover:bg-yellow-700">
                    <i class="fas fa-clock mr-1"></i>Schedule
                  </button>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message Priority</label>
                  <select id="driver-message-priority" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="normal">Normal</option>
                    <option value="high">High Priority</option>
                    <option value="urgent">Urgent</option>
                    <option value="emergency">Emergency</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message Type</label>
                  <select id="driver-message-type" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="text">Text Message</option>
                    <option value="alert">Alert</option>
                    <option value="notification">Notification</option>
                    <option value="instruction">Instruction</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject</label>
                <input type="text" id="driver-message-subject" placeholder="Enter message subject..." 
                       class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message Content</label>
                <textarea id="driver-message-content" rows="4" placeholder="Type your message to the driver..." 
                          class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white resize-none"></textarea>
              </div>
              
              <div class="flex items-center gap-4">
                <label class="flex items-center">
                  <input type="checkbox" id="require-acknowledgment" class="rounded">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Require acknowledgment</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" id="send-push-notification" class="rounded">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Send push notification</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" id="record-voice-message" class="rounded">
                  <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Record voice message</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Messages with Driver -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center">
            <i class="fas fa-history mr-2 text-green-600"></i>
            Recent Messages with Driver
          </h3>
          <button id="view-all-messages-btn" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
            <i class="fas fa-envelope mr-1"></i>View All Messages
          </button>
        </div>
        
        <div id="recent-messages-container" class="space-y-3 max-h-64 overflow-y-auto">
          <!-- Recent messages will be populated here -->
          <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">Route Update</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">2 hours ago</span>
              </div>
              <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">Sent</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400">Updated route due to construction on Highway 101. Please follow new GPS directions.</p>
          </div>
          
          <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">Break Reminder</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">4 hours ago</span>
              </div>
              <span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">Acknowledged</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400">Time for your scheduled break. Please pull over safely and take 30 minutes.</p>
          </div>
          
          <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">Performance Feedback</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">1 day ago</span>
              </div>
              <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">Sent</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400">Excellent driving performance this week! Your safety score improved by 15 points.</p>
          </div>
        </div>
      </div>

      <div id="widget-grid" class="widget-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

        <!-- Vehicle Status -->
        <div class="widget-card bg-white p-6 rounded-lg" data-widget="vehicle-status">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Vehicle Status</h3>
          <div class="space-y-2">
            <div>Fuel: <span id="vehicle-fuel">75%</span> <i class="fas fa-gas-pump text-green-600"></i></div>
            <div>Engine Temp: <span id="vehicle-engine-temp">95°C</span> <i class="fas fa-thermometer-half text-blue-600"></i></div>
            <div>Tire Pressure: <span id="vehicle-tire-pressure">32 psi</span> <i class="fas fa-tire text-gray-600"></i></div>
            <div>Battery: <span id="vehicle-battery">90%</span> <i class="fas fa-battery-full text-green-600"></i></div>
            <div>Mileage: <span id="vehicle-mileage">25,000 km</span> <i class="fas fa-tachometer-alt text-gray-600"></i></div>
          </div>
          <button id="report-issue-btn" class="mt-4 bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600"><i class="fas fa-exclamation-circle mr-1"></i>Report Issue</button>
        </div>
        <!-- Performance Score -->
        <div class="widget-card bg-white p-6 rounded-lg" data-widget="performance-score">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Driver's Metrics</h3>
          <canvas id="performance-chart" height="200"></canvas>
          <div class="mt-4 text-center">
            <span class="text-2xl font-bold text-purple-600" id="driver-score">85/100</span>
            <div class="text-sm text-gray-600 dark:text-gray-400">Safe Driving Score</div>
            <div class="flex justify-center mt-2">
              <i class="fas fa-trophy text-yellow-500 text-2xl mr-2" title="Gold Badge for Efficiency"></i>
              <i class="fas fa-shield-alt text-blue-500 text-2xl mr-2" title="Safety Badge"></i>
              <i class="fas fa-star text-green-500 text-2xl" title="Compliance Badge"></i>
            </div>
          </div>
        </div>
        <!-- Alerts and Tips -->
        <div class="widget-card bg-white p-6 rounded-lg" data-widget="alerts-tips">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Alerts & Tips</h3>
          <ul id="alert-list" class="space-y-2 max-h-40 overflow-y-auto"></ul>
          <div class="mt-4 flex gap-2">
            <button id="log-eld-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"><i class="fas fa-file-alt mr-1"></i>Log ELD</button>
            <button id="clear-alerts-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300"><i class="fas fa-trash mr-1"></i>Clear Alerts</button>
          </div>
        </div>
        <!-- Trip Timeline -->
        <div class="widget-card bg-white p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-3" data-widget="trip-timeline">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Trip Timeline</h3>
          <div id="timeline-container" class="space-y-4"></div>
        </div>
        <!-- Messages -->
        <div class="widget-card bg-white p-6 rounded-lg col-span-1 md:col-span-2 lg:col-span-3" data-widget="messages">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Messages from Dispatch</h3>
          <div id="message-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
          <div class="mt-4 flex">
            <input type="text" id="message-input" placeholder="Type message..." class="flex-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-4 py-2 rounded-l-lg focus:ring-2 focus:ring-blue-500">
            <button id="send-message-btn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>

        <!-- Executive Analytics -->
        <div class="widget-card bg-white p-6 rounded-lg col-span-1 md:col-span-2" data-widget="executive-analytics">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-chart-line mr-2 text-purple-600"></i>
            Executive Analytics
          </h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="text-center p-3 bg-purple-50 dark:bg-purple-900 rounded-lg">
              <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="driver-efficiency-score">92%</div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Efficiency Score</div>
            </div>
            <div class="text-center p-3 bg-green-50 dark:bg-green-900 rounded-lg">
              <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="driver-compliance-rate">98%</div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Compliance Rate</div>
            </div>
            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
              <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="driver-safety-index">85</div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Safety Index</div>
            </div>
            <div class="text-center p-3 bg-orange-50 dark:bg-orange-900 rounded-lg">
              <div class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="driver-cost-per-mile">$0.42</div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Cost/Mile</div>
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <button id="generate-report-btn" class="flex-1 bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">
              <i class="fas fa-file-chart mr-1"></i>Generate Report
            </button>
            <button id="compare-drivers-btn" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
              <i class="fas fa-balance-scale mr-1"></i>Compare Drivers
            </button>
          </div>
        </div>

        <!-- Compliance & Legal -->
        <div class="widget-card bg-white p-6 rounded-lg" data-widget="compliance-legal">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-gavel mr-2 text-red-600"></i>
            Compliance & Legal
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center p-2 bg-yellow-50 dark:bg-yellow-900 rounded">
              <span class="text-sm font-medium">License Expiry</span>
              <span class="text-sm text-yellow-600 dark:text-yellow-400" id="license-expiry-status">45 days</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-green-50 dark:bg-green-900 rounded">
              <span class="text-sm font-medium">Medical Certificate</span>
              <span class="text-sm text-green-600 dark:text-green-400" id="medical-cert-status">Valid</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-red-50 dark:bg-red-900 rounded">
              <span class="text-sm font-medium">Drug Test</span>
              <span class="text-sm text-red-600 dark:text-red-400" id="drug-test-status">Due</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-blue-50 dark:bg-blue-900 rounded">
              <span class="text-sm font-medium">Training Status</span>
              <span class="text-sm text-blue-600 dark:text-blue-400" id="training-status">Current</span>
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <button id="schedule-compliance-btn" class="flex-1 bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700">
              <i class="fas fa-calendar-plus mr-1"></i>Schedule Tests
            </button>
            <button id="view-compliance-history-btn" class="flex-1 bg-gray-600 text-white px-3 py-2 rounded text-sm hover:bg-gray-700">
              <i class="fas fa-history mr-1"></i>View History
            </button>
          </div>
        </div>

        <!-- Financial Management -->
        <div class="widget-card bg-white p-6 rounded-lg" data-widget="financial-management">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-dollar-sign mr-2 text-green-600"></i>
            Financial Overview
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium">Hourly Rate</span>
              <span class="text-sm font-bold text-green-600" id="driver-hourly-rate-display">$25.50</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium">This Week</span>
              <span class="text-sm font-bold text-blue-600" id="driver-weekly-earnings">$1,020.00</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium">Overtime Hours</span>
              <span class="text-sm font-bold text-orange-600" id="driver-overtime-hours">8.5 hrs</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium">Bonus Eligible</span>
              <span class="text-sm font-bold text-purple-600" id="driver-bonus-status">Yes</span>
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <button id="adjust-payrate-btn" class="flex-1 bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
              <i class="fas fa-edit mr-1"></i>Adjust Pay Rate
            </button>
            <button id="view-payroll-btn" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
              <i class="fas fa-file-invoice-dollar mr-1"></i>View Payroll
            </button>
          </div>
        </div>

        <!-- Risk Assessment -->
        <div class="widget-card bg-white p-6 rounded-lg col-span-1 md:col-span-2" data-widget="risk-assessment">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-shield-alt mr-2 text-orange-600"></i>
            Risk Assessment & Insurance
          </h3>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="text-center p-3 bg-orange-50 dark:bg-orange-900 rounded-lg">
              <div class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="risk-score">Low</div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Risk Level</div>
            </div>
            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
              <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="insurance-premium">$1,200</div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Annual Premium</div>
            </div>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Accidents (3 years)</span>
              <span class="font-medium text-green-600" id="accident-count">0</span>
            </div>
            <div class="flex justify-between">
              <span>Violations (3 years)</span>
              <span class="font-medium text-yellow-600" id="violation-count">2</span>
            </div>
            <div class="flex justify-between">
              <span>Claims Filed</span>
              <span class="font-medium text-red-600" id="claims-count">0</span>
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <button id="update-insurance-btn" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
              <i class="fas fa-shield mr-1"></i>Update Insurance
            </button>
            <button id="risk-review-btn" class="flex-1 bg-orange-600 text-white px-3 py-2 rounded text-sm hover:bg-orange-700">
              <i class="fas fa-chart-bar mr-1"></i>Risk Review
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Fleet Overview View -->
    <div id="fleet-overview-view" class="">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white">Fleet Overview</h2>
        <button id="add-driver-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center text-sm font-medium">
          <i class="fas fa-user-plus mr-2"></i>Add New Driver
        </button>
      </div>
      
      <!-- Fleet Statistics Summary -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6">
        <div class="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-md flex items-center justify-center">
                <i class="fas fa-users text-blue-600 dark:text-blue-400"></i>
              </div>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Drivers</p>
              <p class="text-xl md:text-2xl font-semibold text-gray-900 dark:text-white" id="total-drivers">100</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-md flex items-center justify-center">
                <i class="fas fa-shield-alt text-green-600 dark:text-green-400"></i>
              </div>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Drivers</p>
              <p class="text-xl md:text-2xl font-semibold text-gray-900 dark:text-white" id="active-drivers">--</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-md flex items-center justify-center">
                <i class="fas fa-star text-yellow-600 dark:text-yellow-400"></i>
              </div>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg Safety Score</p>
              <p class="text-xl md:text-2xl font-semibold text-gray-900 dark:text-white" id="avg-safety-score">--</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900 rounded-md flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-purple-600 dark:text-purple-400"></i>
              </div>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Alerts Today</p>
              <p class="text-xl md:text-2xl font-semibold text-gray-900 dark:text-white" id="alerts-today">--</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="widget-card bg-white p-4 md:p-6 rounded-lg">
        <h3 class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-4">Driver List</h3>
        
        <!-- Desktop Table View -->
        <div class="overflow-x-auto hidden md:block">
          <table class="fleet-table w-full text-sm text-gray-900 dark:text-gray-200">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all-drivers" /></th>
                <th>ID</th>
                <th>Name</th>
                <th>Score</th>
                <th>Safe Driving</th>
                <th>Efficiency</th>
                <th>Compliance</th>
                <th class="hidden-mobile">Harsh Braking</th>
                <th class="hidden-mobile">Speeding</th>
                <th class="hidden-mobile">Idling</th>
                <th>Camera</th>
              </tr>
            </thead>
            <tbody id="driver-table-body"></tbody>
          </table>
        </div>
        
        <!-- Mobile Card View -->
        <div class="mobile-driver-cards md:hidden space-y-4" id="driver-cards-mobile">
          <!-- Mobile driver cards will be populated here -->
        </div>
        
        <!-- Bulk Action Bar -->
        <div id="bulk-action-bar" class="hidden mt-4 bg-blue-50 dark:bg-blue-900 p-3 md:p-4 rounded flex flex-wrap items-center gap-2 md:gap-4">
          <span id="selected-count" class="font-semibold text-blue-700 dark:text-blue-200 text-sm">0 selected</span>
          <div class="flex flex-wrap gap-2">
            <button id="bulk-message-btn" class="bg-blue-600 text-white px-2 md:px-3 py-1 rounded hover:bg-blue-700 text-sm"><i class="fas fa-envelope mr-1"></i><span class="hidden sm:inline">Message</span></button>
            <button id="bulk-group-btn" class="bg-green-600 text-white px-2 md:px-3 py-1 rounded hover:bg-green-700 text-sm"><i class="fas fa-users mr-1"></i><span class="hidden sm:inline">Group</span></button>
            <button id="bulk-remove-btn" class="bg-red-600 text-white px-2 md:px-3 py-1 rounded hover:bg-red-700 text-sm"><i class="fas fa-user-times mr-1"></i><span class="hidden sm:inline">Remove</span></button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Cameras View -->
    <div id="cameras-view" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white">Driver Camera Monitoring</h2>
        <div class="flex gap-2">
          <button id="refresh-cameras-btn" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
            <i class="fas fa-sync-alt mr-1"></i>Refresh Feeds
          </button>
          <button id="toggle-recording-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm font-medium">
            <i class="fas fa-record-vinyl mr-1"></i>Start Recording
          </button>
        </div>
      </div>
      
      <!-- Camera Controls -->
      <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
        <div class="flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3 sm:gap-4">
          <div class="flex items-center gap-2 w-full sm:w-auto">
            <label for="camera-filter" class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">Filter:</label>
            <select id="camera-filter" class="flex-1 sm:flex-none bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg px-3 py-2">
              <option value="all">All Cameras</option>
              <option value="active">Active Drivers</option>
              <option value="alerts">Alert Status</option>
              <option value="offline">Offline</option>
            </select>
          </div>
          <div class="flex items-center gap-2 w-full sm:w-auto">
            <label for="camera-layout" class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">Layout:</label>
            <select id="camera-layout" class="flex-1 sm:flex-none bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg px-3 py-2">
              <option value="grid-4">2x2 Grid</option>
              <option value="grid-9">3x3 Grid</option>
              <option value="grid-16">4x4 Grid</option>
              <option value="single">Single View</option>
            </select>
          </div>
          <button id="fullscreen-cameras-btn" class="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-lg hover:bg-gray-300 text-sm w-full sm:w-auto">
            <i class="fas fa-expand mr-1"></i>Fullscreen
          </button>
        </div>
      </div>

      <!-- Camera Grid -->
      <div id="camera-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6 mb-6">
        <!-- Camera feeds will be populated here -->
      </div>

      <!-- Camera Alerts Panel -->
      <div class="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-lg shadow">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Live Camera Alerts</h3>
        <div id="camera-alerts" class="space-y-2 max-h-40 overflow-y-auto">
          <!-- Camera alerts will be populated here -->
        </div>
      </div>
    </div>

    <!-- Enhanced Messages View -->
    <div id="messages-view" class="hidden">
      <!-- Messages Header with Statistics -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Fleet Communications Center</h2>
            <p class="text-gray-600 dark:text-gray-400">Manage all fleet communications, alerts, and notifications</p>
          </div>
        <div class="flex gap-2">
          <button id="compose-message-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium">
            <i class="fas fa-plus mr-1"></i>Compose Message
          </button>
            <button id="bulk-actions-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-medium">
              <i class="fas fa-tasks mr-1"></i>Bulk Actions
            </button>
            <button id="export-messages-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-medium">
              <i class="fas fa-download mr-1"></i>Export
          </button>
        </div>
      </div>

        <!-- Message Statistics Dashboard -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
          <div class="text-center p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="total-messages-count">156</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Total Messages</div>
          </div>
          <div class="text-center p-3 bg-red-50 dark:bg-red-900 rounded-lg">
            <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="unread-messages-count">23</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Unread</div>
          </div>
          <div class="text-center p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg">
            <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="urgent-messages-count">5</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Urgent</div>
          </div>
          <div class="text-center p-3 bg-green-50 dark:bg-green-900 rounded-lg">
            <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="sent-messages-count">89</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Sent Today</div>
          </div>
          <div class="text-center p-3 bg-purple-50 dark:bg-purple-900 rounded-lg">
            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="response-rate">94%</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Response Rate</div>
          </div>
          <div class="text-center p-3 bg-indigo-50 dark:bg-indigo-900 rounded-lg">
            <div class="text-2xl font-bold text-indigo-600 dark:text-indigo-400" id="avg-response-time">2.3m</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Avg Response</div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Enhanced Message Filters & Contacts -->
        <div class="lg:col-span-1 space-y-4">
          <!-- Advanced Message Filters -->
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
              <i class="fas fa-filter mr-2 text-blue-600"></i>Advanced Filters
            </h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date Range</label>
                <select id="date-filter" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="today">Today</option>
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                  <option value="custom">Custom Range</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message Type</label>
                <select id="type-filter" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="all">All Types</option>
                  <option value="text">Text Messages</option>
                  <option value="voice">Voice Messages</option>
                  <option value="alert">Alerts</option>
                  <option value="notification">Notifications</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                <select id="status-filter" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                  <option value="all">All Status</option>
                  <option value="read">Read</option>
                  <option value="unread">Unread</option>
                  <option value="archived">Archived</option>
                  <option value="flagged">Flagged</option>
                </select>
              </div>
            </div>
            
            <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
              <h4 class="font-semibold text-gray-900 dark:text-white text-sm mb-2">Quick Filters</h4>
            <div class="space-y-2">
                <button class="message-filter-btn w-full text-left px-3 py-2 rounded bg-blue-50 dark:bg-blue-900 text-blue-700 dark:text-blue-200 text-sm" data-filter="all">
                  <i class="fas fa-inbox mr-2"></i>All Messages <span class="float-right" id="all-count">156</span>
              </button>
                <button class="message-filter-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-filter="unread">
                  <i class="fas fa-envelope mr-2"></i>Unread <span class="float-right" id="unread-count">23</span>
              </button>
                <button class="message-filter-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-filter="urgent">
                  <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>Urgent <span class="float-right" id="urgent-count">5</span>
              </button>
                <button class="message-filter-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-filter="dispatchers">
                  <i class="fas fa-user-tie mr-2"></i>From Dispatchers <span class="float-right" id="dispatcher-count">45</span>
              </button>
                <button class="message-filter-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-filter="drivers">
                  <i class="fas fa-users mr-2"></i>From Drivers <span class="float-right" id="driver-count">67</span>
              </button>
                <button class="message-filter-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-filter="alerts">
                  <i class="fas fa-bell mr-2"></i>System Alerts <span class="float-right" id="alert-count">12</span>
                </button>
                <button class="message-filter-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-filter="flagged">
                  <i class="fas fa-flag mr-2 text-orange-500"></i>Flagged <span class="float-right" id="flagged-count">8</span>
                </button>
                <button class="message-filter-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-filter="archived">
                  <i class="fas fa-archive mr-2"></i>Archived <span class="float-right" id="archived-count">34</span>
              </button>
              </div>
            </div>
          </div>

          <!-- Enhanced Quick Contacts -->
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
              <i class="fas fa-address-book mr-2 text-green-600"></i>Quick Contacts
            </h3>
            <div class="space-y-3" id="quick-contacts">
              <!-- Quick contacts will be populated here -->
            </div>
            <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
              <button id="manage-contacts-btn" class="w-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-sm hover:bg-gray-200 dark:hover:bg-gray-600">
                <i class="fas fa-cog mr-1"></i>Manage Contacts
              </button>
          </div>
        </div>

          <!-- Message Templates -->
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
              <i class="fas fa-file-alt mr-2 text-purple-600"></i>Message Templates
            </h3>
            <div class="space-y-2">
              <button class="template-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-template="emergency">
                <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>Emergency Alert
              </button>
              <button class="template-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-template="maintenance">
                <i class="fas fa-tools mr-2 text-blue-500"></i>Maintenance Notice
              </button>
              <button class="template-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-template="safety">
                <i class="fas fa-shield-alt mr-2 text-green-500"></i>Safety Reminder
              </button>
              <button class="template-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-template="schedule">
                <i class="fas fa-calendar mr-2 text-purple-500"></i>Schedule Update
              </button>
              <button class="template-btn w-full text-left px-3 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-sm" data-template="weather">
                <i class="fas fa-cloud mr-2 text-gray-500"></i>Weather Alert
              </button>
            </div>
            <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
              <button id="manage-templates-btn" class="w-full bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 px-3 py-2 rounded text-sm hover:bg-purple-200 dark:hover:bg-purple-800">
                <i class="fas fa-edit mr-1"></i>Manage Templates
              </button>
            </div>
          </div>
        </div>

        <!-- Enhanced Message List & Content -->
        <div class="lg:col-span-3">
          <!-- Message List Header -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-4">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Messages</h3>
                <div class="flex items-center gap-2">
                    <button id="mark-all-read-btn" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
                      <i class="fas fa-check-double mr-1"></i>Mark All Read
                    </button>
                    <button id="archive-selected-btn" class="bg-gray-600 text-white px-3 py-2 rounded text-sm hover:bg-gray-700">
                      <i class="fas fa-archive mr-1"></i>Archive
                    </button>
                    <button id="delete-selected-btn" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700">
                      <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="relative">
                  <input type="text" id="message-search" placeholder="Search messages..." 
                           class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white w-64">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                  </div>
                  <button id="refresh-messages-btn" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                  </button>
                  <button id="auto-refresh-toggle" class="bg-yellow-600 text-white px-3 py-2 rounded text-sm hover:bg-yellow-700">
                    <i class="fas fa-clock mr-1"></i>Auto Refresh
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Message List with Enhanced Features -->
            <div id="message-list-container" class="max-h-96 overflow-y-auto">
              <!-- Enhanced message list will be populated here -->
            </div>
          </div>

          <!-- Enhanced Message Composer -->
          <div id="message-composer" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 hidden">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Compose Message</h3>
              <div class="flex gap-2">
                <button id="save-draft-btn" class="bg-gray-600 text-white px-3 py-2 rounded text-sm hover:bg-gray-700">
                  <i class="fas fa-save mr-1"></i>Save Draft
                </button>
                <button id="preview-message-btn" class="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">
                  <i class="fas fa-eye mr-1"></i>Preview
                </button>
              </div>
            </div>
            
            <form id="compose-form" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Recipients</label>
                  <select id="message-recipients" multiple class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="all-drivers">All Drivers</option>
                    <option value="all-dispatchers">All Dispatchers</option>
                    <option value="active-drivers">Active Drivers Only</option>
                    <option value="management">Management Team</option>
                    <option value="maintenance">Maintenance Team</option>
                    <option value="safety">Safety Department</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority</label>
                  <select id="message-priority" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="normal">Normal</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                    <option value="emergency">Emergency</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message Type</label>
                  <select id="message-type" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="text">Text Message</option>
                    <option value="voice">Voice Message</option>
                    <option value="alert">Alert</option>
                    <option value="notification">Notification</option>
                    <option value="announcement">Announcement</option>
                  </select>
              </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject</label>
                <input type="text" id="message-subject" placeholder="Enter message subject" 
                       class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message Content</label>
                <div class="border border-gray-300 dark:border-gray-600 rounded-md">
                  <div class="flex border-b border-gray-300 dark:border-gray-600">
                    <button type="button" class="px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="formatText('bold')">
                      <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="formatText('italic')">
                      <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="formatText('underline')">
                      <i class="fas fa-underline"></i>
                    </button>
                    <button type="button" class="px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" onclick="insertEmoji()">
                      😊
                    </button>
              </div>
                  <textarea id="message-content" rows="6" placeholder="Type your message here..." 
                            class="w-full p-3 focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white resize-none"></textarea>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex items-center gap-4">
                  <label class="flex items-center">
                <input type="checkbox" id="schedule-message" class="rounded">
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Schedule for later</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" id="require-acknowledgment" class="rounded">
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Require acknowledgment</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" id="send-notification" class="rounded">
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Send push notification</span>
                  </label>
              </div>
                <div>
                  <input type="datetime-local" id="schedule-time" class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 text-sm dark:bg-gray-700 dark:text-white hidden">
                </div>
              </div>
              
              <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex gap-2">
                <button type="button" id="cancel-compose" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                  Cancel
                </button>
                  <button type="button" id="save-as-template" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    <i class="fas fa-save mr-1"></i>Save as Template
                  </button>
                </div>
                <div class="flex gap-2">
                  <button type="button" id="send-later" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                    <i class="fas fa-clock mr-1"></i>Send Later
                  </button>
                <button type="button" id="send-message" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  <i class="fas fa-paper-plane mr-1"></i>Send Message
                </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Sample fleet data
    // Generate 100 demo drivers with varied metrics
    const fleetData = Array.from({ length: 100 }, (_, i) => {
      const id = `DRV-${(i + 1).toString().padStart(3, '0')}`;
      const name = `Driver ${i + 1}`;
      // Create some variation and clusters
      const clusterType = i % 3;
      let safeDriving, efficiency, compliance, harshBraking, speeding, idling, score;
      if (clusterType === 0) {
        safeDriving = 40 + Math.random() * 20;
        efficiency = 20 + Math.random() * 15;
        compliance = 15 + Math.random() * 15;
        harshBraking = Math.floor(Math.random() * 3);
        speeding = Math.floor(Math.random() * 2);
        idling = Math.floor(Math.random() * 4);
      } else if (clusterType === 1) {
        safeDriving = 55 + Math.random() * 10;
        efficiency = 30 + Math.random() * 10;
        compliance = 20 + Math.random() * 10;
        harshBraking = Math.floor(Math.random() * 2);
        speeding = Math.floor(Math.random() * 2);
        idling = Math.floor(Math.random() * 3);
      } else {
        safeDriving = 30 + Math.random() * 15;
        efficiency = 10 + Math.random() * 15;
        compliance = 10 + Math.random() * 10;
        harshBraking = Math.floor(Math.random() * 6);
        speeding = Math.floor(Math.random() * 5);
        idling = Math.floor(Math.random() * 7);
      }
      score = Math.round((safeDriving + efficiency + compliance) / 3 + 50 - (harshBraking + speeding + idling) * 2);
      return {
        id,
        name,
        performance: {
          score,
          metrics: {
            safeDriving,
            efficiency,
            compliance,
            harshBraking,
            speeding,
            idling
          }
        }
      };
    });

    // Camera data and management
    const cameraData = fleetData.map(driver => ({
      id: driver.id,
      name: driver.name,
      cameraId: `CAM-${driver.id.slice(4)}`,
      status: ['online', 'offline', 'alert'][Math.floor(Math.random() * 3)],
      quality: ['HD', '4K', 'SD'][Math.floor(Math.random() * 3)],
      recording: Math.random() > 0.5,
      lastUpdate: new Date().toLocaleTimeString(),
      alertType: ['none', 'fatigue', 'distraction', 'speeding', 'harsh_braking'][Math.floor(Math.random() * 5)],
      // Simulate camera feed URL (in real implementation, these would be actual camera stream URLs)
      feedUrl: `https://picsum.photos/400/300?random=${Math.floor(Math.random() * 1000)}&blur=1`,
      location: {
        lat: 40.7128 + (Math.random() - 0.5) * 0.1,
        lng: -74.0060 + (Math.random() - 0.5) * 0.1
      }
    }));

    let currentCameraLayout = 'grid-4';
    let isRecording = false;
    let cameraAlerts = [];

    // Render Camera Grid
    function renderCameraGrid(cameras = cameraData, layout = currentCameraLayout) {
      const grid = document.getElementById('camera-grid');
      if (!grid) return;

      // Set grid layout classes
      grid.className = 'grid gap-6 mb-6';
      switch (layout) {
        case 'grid-4':
          grid.className += ' grid-cols-1 md:grid-cols-2 lg:grid-cols-2';
          cameras = cameras.slice(0, 4);
          break;
        case 'grid-9':
          grid.className += ' grid-cols-1 md:grid-cols-2 lg:grid-cols-3';
          cameras = cameras.slice(0, 9);
          break;
        case 'grid-16':
          grid.className += ' grid-cols-1 md:grid-cols-3 lg:grid-cols-4';
          cameras = cameras.slice(0, 16);
          break;
        case 'single':
          grid.className += ' grid-cols-1';
          cameras = cameras.slice(0, 1);
          break;
      }

      grid.innerHTML = '';

      cameras.forEach(camera => {
        const statusColor = camera.status === 'online' ? 'bg-green-500' : 
                           camera.status === 'alert' ? 'bg-red-500' : 'bg-gray-500';
        const alertBadge = camera.alertType !== 'none' ? 
          `<span class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded-full">
            ${camera.alertType.replace('_', ' ').toUpperCase()}
          </span>` : '';

        const cameraCard = document.createElement('div');
        cameraCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden relative';
        cameraCard.innerHTML = `
          <div class="relative">
            ${alertBadge}
            <img src="${camera.feedUrl}" alt="${camera.name} Camera Feed" 
                 class="w-full h-48 object-cover ${camera.status === 'offline' ? 'grayscale' : ''}"
                 onerror="this.src='https://via.placeholder.com/400x300/374151/9CA3AF?text=Camera+Offline'">
            <div class="absolute bottom-2 left-2 flex items-center gap-2">
              <span class="w-3 h-3 rounded-full ${statusColor}"></span>
              <span class="text-white text-sm font-medium bg-black bg-opacity-50 px-2 py-1 rounded">
                ${camera.status.toUpperCase()}
              </span>
              ${camera.recording ? '<i class="fas fa-record-vinyl text-red-500"></i>' : ''}
            </div>
          </div>
          <div class="p-4">
            <div class="flex justify-between items-start mb-2">
              <div>
                <h4 class="font-semibold text-gray-900 dark:text-white">${camera.name}</h4>
                <p class="text-sm text-gray-500 dark:text-gray-400">${camera.cameraId}</p>
              </div>
              <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">
                ${camera.quality}
              </span>
            </div>
            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-3">
              <span>Last Update: ${camera.lastUpdate}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="enlargeCamera('${camera.id}')" 
                      class="flex-1 bg-blue-600 text-white text-xs px-3 py-2 rounded hover:bg-blue-700">
                <i class="fas fa-expand mr-1"></i>Enlarge
              </button>
              <button onclick="toggleCameraRecording('${camera.id}')" 
                      class="bg-red-600 text-white text-xs px-3 py-2 rounded hover:bg-red-700">
                <i class="fas fa-${camera.recording ? 'stop' : 'record-vinyl'} mr-1"></i>
                ${camera.recording ? 'Stop' : 'Record'}
              </button>
            </div>
          </div>
        `;
        grid.appendChild(cameraCard);
      });

      console.log(`Rendered ${cameras.length} camera feeds in ${layout} layout`);
    }

    // Camera Alert Management
    function addCameraAlert(driverId, alertType, message) {
      const camera = cameraData.find(c => c.id === driverId);
      if (!camera) return;

      const alert = {
        id: Date.now(),
        driverId,
        driverName: camera.name,
        cameraId: camera.cameraId,
        alertType,
        message,
        timestamp: new Date().toLocaleTimeString(),
        severity: alertType === 'fatigue' || alertType === 'distraction' ? 'high' : 'medium'
      };

      cameraAlerts.unshift(alert);
      if (cameraAlerts.length > 10) cameraAlerts.pop(); // Keep only last 10 alerts

      renderCameraAlerts();
      showToast(`Camera Alert: ${message} for ${camera.name}`);
    }

    function renderCameraAlerts() {
      const container = document.getElementById('camera-alerts');
      if (!container) return;

      if (cameraAlerts.length === 0) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">No active camera alerts</p>';
        return;
      }

      container.innerHTML = '';
      cameraAlerts.forEach(alert => {
        const severityColor = alert.severity === 'high' ? 'text-red-600' : 'text-yellow-600';
        const alertElement = document.createElement('div');
        alertElement.className = `flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded ${severityColor}`;
        alertElement.innerHTML = `
          <div>
            <span class="font-medium">${alert.driverName} (${alert.cameraId})</span>
            <p class="text-sm">${alert.message}</p>
            <span class="text-xs text-gray-500 dark:text-gray-400">${alert.timestamp}</span>
          </div>
          <button onclick="dismissCameraAlert(${alert.id})" 
                  class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
            <i class="fas fa-times"></i>
          </button>
        `;
        container.appendChild(alertElement);
      });
    }

    // Camera Control Functions
    function enlargeCamera(driverId) {
      const camera = cameraData.find(c => c.id === driverId);
      if (!camera) return;

      // Create fullscreen modal for camera
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="relative max-w-6xl max-h-screen p-4">
          <button onclick="this.parentElement.parentElement.remove()" 
                  class="absolute top-2 right-2 text-white hover:text-gray-300 text-2xl z-10">
            <i class="fas fa-times"></i>
          </button>
          <img src="${camera.feedUrl}" alt="${camera.name} Camera Feed" 
               class="max-w-full max-h-full object-contain">
          <div class="absolute bottom-4 left-4 text-white">
            <h3 class="text-xl font-bold">${camera.name}</h3>
            <p class="text-sm opacity-75">${camera.cameraId} - ${camera.quality}</p>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function toggleCameraRecording(driverId) {
      const camera = cameraData.find(c => c.id === driverId);
      if (!camera) return;

      camera.recording = !camera.recording;
      showToast(`Recording ${camera.recording ? 'started' : 'stopped'} for ${camera.name}`);
      renderCameraGrid();
    }

    function dismissCameraAlert(alertId) {
      cameraAlerts = cameraAlerts.filter(alert => alert.id !== alertId);
      renderCameraAlerts();
    }

    // Refresh single camera feed
    function refreshSingleCamera(driverId) {
      const camera = cameraData.find(c => c.id === driverId);
      if (!camera) return;

      camera.lastUpdate = new Date().toLocaleTimeString();
      camera.feedUrl = `https://picsum.photos/640/480?random=${Math.floor(Math.random() * 1000)}&blur=1`;
      
      // Update the image in the modal
      const modal = document.querySelector('.fixed');
      if (modal) {
        const img = modal.querySelector('img');
        const timeSpan = modal.querySelector('.text-sm');
        if (img) img.src = camera.feedUrl;
        if (timeSpan) timeSpan.textContent = `Quality: ${camera.quality} • Last Update: ${camera.lastUpdate}`;
      }
      
      showToast(`Camera feed refreshed for ${camera.name}`);
    }

    // Simulate real-time camera alerts
    function simulateCameraAlerts() {
      setInterval(() => {
        if (Math.random() > 0.85) { // 15% chance every 30 seconds
          const randomCamera = cameraData[Math.floor(Math.random() * Math.min(10, cameraData.length))];
          const alertTypes = [
            { type: 'fatigue', message: 'Driver showing signs of fatigue' },
            { type: 'distraction', message: 'Driver distraction detected' },
            { type: 'speeding', message: 'Speeding violation detected' },
            { type: 'harsh_braking', message: 'Harsh braking detected' }
          ];
          const randomAlert = alertTypes[Math.floor(Math.random() * alertTypes.length)];
          
          randomCamera.alertType = randomAlert.type;
          randomCamera.status = 'alert';
          
          addCameraAlert(randomCamera.id, randomAlert.type, randomAlert.message);
          
          // Reset alert after 30 seconds
          setTimeout(() => {
            randomCamera.alertType = 'none';
            randomCamera.status = 'online';
            renderCameraGrid();
          }, 30000);
        }
      }, 30000); // Check every 30 seconds
    }

    // Enhanced Messages System
    let messagesData = [
      {
        id: 1,
        from: 'Dispatcher Central',
        to: 'All Drivers',
        subject: 'Route Update - Highway 101 Closure',
        content: 'Highway 101 southbound is closed due to construction. Please use alternate routes. Expected reopening: 6 PM.',
        timestamp: new Date(Date.now() - 3600000),
        priority: 'urgent',
        read: false,
        type: 'dispatcher'
      },
      {
        id: 2,
        from: 'Safety Department',
        to: 'All Drivers',
        subject: 'Weekly Safety Reminder',
        content: 'Remember to perform your pre-trip inspections and maintain safe following distances.',
        timestamp: new Date(Date.now() - 7200000),
        priority: 'normal',
        read: true,
        type: 'dispatcher'
      },
      {
        id: 3,
        from: 'Driver 025',
        to: 'Dispatch',
        subject: 'Vehicle Issue - Brake Warning Light',
        content: 'My brake warning light came on. Currently at mile marker 45 on I-95. Need assistance.',
        timestamp: new Date(Date.now() - 1800000),
        priority: 'urgent',
        read: false,
        type: 'driver'
      },
      {
        id: 4,
        from: 'System Alert',
        to: 'Fleet Manager',
        subject: 'Driver DRV-012 - Speeding Alert',
        content: 'Driver DRV-012 exceeded speed limit by 15 mph on Route 66. Speed: 80 mph in 65 mph zone.',
        timestamp: new Date(Date.now() - 900000),
        priority: 'normal',
        read: false,
        type: 'alert'
      },
      {
        id: 5,
        from: 'Maintenance',
        to: 'All Drivers',
        subject: 'Scheduled Maintenance Reminder',
        content: 'Vehicle VEH-045 is due for scheduled maintenance. Please return to depot by end of shift.',
        timestamp: new Date(Date.now() - 10800000),
        priority: 'normal',
        read: true,
        type: 'dispatcher'
      }
    ];

    let currentMessageFilter = 'all';
    let unreadCount = 0;

    // Initialize Messages System
    function initMessagesSystem() {
      updateUnreadCount();
      renderQuickContacts();
      renderMessageList();
      setupMessageEventListeners();
    }

    // Update unread message count
    function updateUnreadCount() {
      unreadCount = messagesData.filter(msg => !msg.read).length;
      const unreadBadge = document.getElementById('unread-count');
      const unreadMessagesCount = document.getElementById('unread-messages-count');
      
      if (unreadCount > 0) {
        unreadBadge.textContent = unreadCount;
        unreadBadge.classList.remove('hidden');
      } else {
        unreadBadge.classList.add('hidden');
      }
      
      if (unreadMessagesCount) {
        unreadMessagesCount.textContent = unreadCount;
      }
      
      // Update filter counts
      updateFilterCounts();
    }

    // Update filter counts
    function updateFilterCounts() {
      document.getElementById('all-count').textContent = messagesData.length;
      document.getElementById('urgent-count').textContent = messagesData.filter(msg => msg.priority === 'urgent').length;
      document.getElementById('dispatcher-count').textContent = messagesData.filter(msg => msg.type === 'dispatcher').length;
      document.getElementById('driver-count').textContent = messagesData.filter(msg => msg.type === 'driver').length;
      document.getElementById('alert-count').textContent = messagesData.filter(msg => msg.type === 'alert').length;
    }

    // Render Quick Contacts
    function renderQuickContacts() {
      const container = document.getElementById('quick-contacts');
      const contacts = [
        { name: 'Dispatcher Central', status: 'online', role: 'dispatcher' },
        { name: 'Safety Department', status: 'online', role: 'safety' },
        { name: 'Maintenance Team', status: 'away', role: 'maintenance' },
        { name: 'Fleet Manager', status: 'online', role: 'manager' },
        { name: 'Emergency Services', status: 'online', role: 'emergency' }
      ];

      container.innerHTML = '';
      contacts.forEach(contact => {
        const statusColor = contact.status === 'online' ? 'bg-green-400' : 
                           contact.status === 'away' ? 'bg-yellow-400' : 'bg-gray-400';
        
        const contactElement = document.createElement('div');
        contactElement.className = 'flex items-center justify-between p-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded cursor-pointer';
        contactElement.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full ${statusColor}"></span>
            <span class="text-sm font-medium text-gray-900 dark:text-white">${contact.name}</span>
          </div>
          <button class="text-blue-600 hover:text-blue-700" onclick="startQuickMessage('${contact.name}')">
            <i class="fas fa-comment text-xs"></i>
          </button>
        `;
        container.appendChild(contactElement);
      });
    }

    // Render Message List
    function renderMessageList() {
      const container = document.getElementById('message-list-container');
      let filteredMessages = messagesData;

      // Apply filters
      if (currentMessageFilter === 'unread') {
        filteredMessages = messagesData.filter(msg => !msg.read);
      } else if (currentMessageFilter === 'urgent') {
        filteredMessages = messagesData.filter(msg => msg.priority === 'urgent');
      } else if (currentMessageFilter === 'dispatchers') {
        filteredMessages = messagesData.filter(msg => msg.type === 'dispatcher');
      } else if (currentMessageFilter === 'drivers') {
        filteredMessages = messagesData.filter(msg => msg.type === 'driver');
      } else if (currentMessageFilter === 'alerts') {
        filteredMessages = messagesData.filter(msg => msg.type === 'alert');
      }

      // Sort by timestamp (newest first)
      filteredMessages.sort((a, b) => b.timestamp - a.timestamp);

      container.innerHTML = '';
      if (filteredMessages.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-gray-400">No messages found</div>';
        return;
      }

      filteredMessages.forEach(message => {
        const isUnread = !message.read;
        const priorityIcon = message.priority === 'urgent' ? '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>' :
                            message.priority === 'emergency' ? '<i class="fas fa-exclamation-circle text-red-600 mr-1"></i>' : '';
        
        const messageElement = document.createElement('div');
        messageElement.className = `p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer ${isUnread ? 'bg-blue-50 dark:bg-blue-900' : ''}`;
        messageElement.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex items-center gap-2">
              ${priorityIcon}
              <span class="font-medium text-gray-900 dark:text-white ${isUnread ? 'font-bold' : ''}">${message.from}</span>
              ${isUnread ? '<span class="w-2 h-2 bg-blue-500 rounded-full"></span>' : ''}
            </div>
            <span class="text-xs text-gray-500 dark:text-gray-400">${formatTimestamp(message.timestamp)}</span>
          </div>
          <div class="mb-1">
            <span class="text-sm font-medium text-gray-900 dark:text-white">${message.subject}</span>
          </div>
          <div class="text-sm text-gray-600 dark:text-gray-400 truncate">${message.content}</div>
          <div class="flex justify-between items-center mt-2">
            <span class="text-xs text-gray-500 dark:text-gray-400">To: ${message.to}</span>
            <div class="flex gap-2">
              <button onclick="replyToMessage(${message.id})" class="text-blue-600 hover:text-blue-700 text-xs">
                <i class="fas fa-reply mr-1"></i>Reply
              </button>
              ${isUnread ? `<button onclick="markAsRead(${message.id})" class="text-green-600 hover:text-green-700 text-xs">
                <i class="fas fa-check mr-1"></i>Mark Read
              </button>` : ''}
            </div>
          </div>
        `;
        
        messageElement.addEventListener('click', () => viewMessage(message.id));
        container.appendChild(messageElement);
      });
    }

    // Setup Message Event Listeners
    function setupMessageEventListeners() {
      // Message filter buttons
      document.querySelectorAll('.message-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          currentMessageFilter = btn.dataset.filter;
          document.querySelectorAll('.message-filter-btn').forEach(b => {
            b.classList.remove('bg-blue-50', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-200');
          });
          btn.classList.add('bg-blue-50', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-200');
          renderMessageList();
        });
      });

      // Compose message button
      document.getElementById('compose-message-btn').addEventListener('click', () => {
        document.getElementById('message-composer').classList.toggle('hidden');
        populateRecipients();
      });

      // Cancel compose
      document.getElementById('cancel-compose').addEventListener('click', () => {
        document.getElementById('message-composer').classList.add('hidden');
        clearComposeForm();
      });

      // Send message
      document.getElementById('send-message').addEventListener('click', () => {
        sendMessage();
      });

      // Mark all as read
      document.getElementById('mark-all-read-btn').addEventListener('click', () => {
        markAllAsRead();
      });

      // Schedule message checkbox
      document.getElementById('schedule-message').addEventListener('change', (e) => {
        const scheduleTime = document.getElementById('schedule-time');
        if (e.target.checked) {
          scheduleTime.classList.remove('hidden');
        } else {
          scheduleTime.classList.add('hidden');
        }
      });

      // Message search
      document.getElementById('message-search').addEventListener('input', (e) => {
        searchMessages(e.target.value);
      });

      // Refresh messages
      document.getElementById('refresh-messages-btn').addEventListener('click', () => {
        refreshMessages();
      });
    }

    // Message utility functions
    function formatTimestamp(timestamp) {
      const now = new Date();
      const diff = now - timestamp;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      return timestamp.toLocaleDateString();
    }

    function startQuickMessage(contactName) {
      document.getElementById('message-composer').classList.remove('hidden');
      document.getElementById('message-recipients').value = contactName;
      document.getElementById('message-subject').focus();
    }

    function populateRecipients() {
      const select = document.getElementById('message-recipients');
      // Add individual drivers to recipients
      fleetData.slice(0, 10).forEach(driver => {
        const option = document.createElement('option');
        option.value = driver.id;
        option.textContent = driver.name;
        select.appendChild(option);
      });
    }

    function sendMessage() {
      const recipients = Array.from(document.getElementById('message-recipients').selectedOptions).map(option => option.text);
      const priority = document.getElementById('message-priority').value;
      const subject = document.getElementById('message-subject').value;
      const content = document.getElementById('message-content').value;
      
      if (!subject || !content || recipients.length === 0) {
        showToast('Please fill in all required fields');
        return;
      }

      const newMessage = {
        id: messagesData.length + 1,
        from: 'You',
        to: recipients.join(', '),
        subject: subject,
        content: content,
        timestamp: new Date(),
        priority: priority,
        read: true,
        type: 'sent'
      };

      messagesData.unshift(newMessage);
      showToast(`Message sent to ${recipients.length} recipient(s)`);
      clearComposeForm();
      document.getElementById('message-composer').classList.add('hidden');
      renderMessageList();
    }

    function clearComposeForm() {
      document.getElementById('message-recipients').selectedIndex = -1;
      document.getElementById('message-priority').value = 'normal';
      document.getElementById('message-subject').value = '';
      document.getElementById('message-content').value = '';
      document.getElementById('schedule-message').checked = false;
      document.getElementById('schedule-time').classList.add('hidden');
    }

    function markAsRead(messageId) {
      const message = messagesData.find(msg => msg.id === messageId);
      if (message) {
        message.read = true;
        updateUnreadCount();
        renderMessageList();
        showToast('Message marked as read');
      }
    }

    function markAllAsRead() {
      messagesData.forEach(msg => msg.read = true);
      updateUnreadCount();
      renderMessageList();
      showToast('All messages marked as read');
    }

    function replyToMessage(messageId) {
      const message = messagesData.find(msg => msg.id === messageId);
      if (message) {
        document.getElementById('message-composer').classList.remove('hidden');
        document.getElementById('message-subject').value = `Re: ${message.subject}`;
        document.getElementById('message-content').value = `\n\n--- Original Message ---\nFrom: ${message.from}\nSubject: ${message.subject}\n${message.content}`;
        document.getElementById('message-content').focus();
      }
    }

    function viewMessage(messageId) {
      const message = messagesData.find(msg => msg.id === messageId);
      if (message && !message.read) {
        markAsRead(messageId);
      }
    }

    function searchMessages(query) {
      if (!query) {
        renderMessageList();
        return;
      }
      
      const filteredMessages = messagesData.filter(msg => 
        msg.subject.toLowerCase().includes(query.toLowerCase()) ||
        msg.content.toLowerCase().includes(query.toLowerCase()) ||
        msg.from.toLowerCase().includes(query.toLowerCase())
      );
      
      const container = document.getElementById('message-list-container');
      container.innerHTML = '';
      
      if (filteredMessages.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-gray-400">No messages found</div>';
        return;
      }
      
      // Re-render with filtered results (reuse existing render logic)
      renderMessageList();
    }

    function refreshMessages() {
      // Simulate receiving new messages
      const newMessage = {
        id: messagesData.length + 1,
        from: `Driver ${Math.floor(Math.random() * 100) + 1}`,
        to: 'Dispatch',
        subject: 'Status Update',
        content: 'Delivery completed successfully. Heading to next location.',
        timestamp: new Date(),
        priority: 'normal',
        read: false,
        type: 'driver'
      };
      
      messagesData.unshift(newMessage);
      updateUnreadCount();
      renderMessageList();
      showToast('Messages refreshed - 1 new message received');
    }

    // Render Driver Table
    function renderDriverTable(drivers = fleetData) {
      console.log('Rendering driver table with', drivers.length, 'drivers');
      const tbody = document.getElementById('driver-table-body');
      if (!tbody) {
        console.error('Driver table body not found');
        return;
      }
      
      tbody.innerHTML = '';
      
      drivers.forEach(driver => {
        // Generate random status for demonstration
        const statuses = ['Active', 'On Break', 'Offline'];
        const statusColors = ['status-active', 'status-on-break', 'status-offline'];
        const randomStatus = Math.floor(Math.random() * statuses.length);
        const status = statuses[randomStatus];
        const statusColor = statusColors[randomStatus];
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="driver-checkbox" data-driver-id="${driver.id}" /></td>
          <td><span class="font-medium">${driver.id}</span></td>
          <td>
            <div class="flex items-center gap-2">
              <span class="driver-status-indicator ${statusColor}"></span>
              <span class="font-medium text-blue-600 hover:text-blue-800 cursor-pointer hover:underline transition-colors duration-200" 
                    onclick="openDriverDashboard('${driver.id}')" 
                    title="Click to view ${driver.name}'s individual dashboard">${driver.name}</span>
            </div>
          </td>
          <td><span class="text-lg font-bold ${driver.performance.score >= 80 ? 'text-green-600' : driver.performance.score >= 60 ? 'text-yellow-600' : 'text-red-600'}">${driver.performance.score}</span></td>
          <td><span class="text-blue-600 font-medium">${driver.performance.metrics.safeDriving.toFixed(1)}</span></td>
          <td><span class="text-green-600 font-medium">${driver.performance.metrics.efficiency.toFixed(1)}</span></td>
          <td><span class="text-purple-600 font-medium">${driver.performance.metrics.compliance.toFixed(1)}</span></td>
          <td><span class="text-red-600 font-medium">${driver.performance.metrics.harshBraking}</span></td>
          <td><span class="text-orange-600 font-medium">${driver.performance.metrics.speeding}</span></td>
          <td><span class="text-yellow-600 font-medium">${driver.performance.metrics.idling}</span></td>
          <td>
            <button class="view-camera-btn text-blue-600 hover:text-blue-800 text-sm bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded" data-driver-id="${driver.id}" title="View Camera">
              <i class="fas fa-video mr-1"></i>View
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      console.log('Added', drivers.length, 'rows to table');

      // Camera view button logic
      tbody.querySelectorAll('.view-camera-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const driverId = btn.dataset.driverId;
          openDriverCameraModal(driverId);
        });
      });

      // Checkbox functionality
      tbody.querySelectorAll('.driver-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionBar);
      });
      
      // Select all functionality
      const selectAllCheckbox = document.getElementById('select-all-drivers');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', (e) => {
          const checkboxes = tbody.querySelectorAll('.driver-checkbox');
          checkboxes.forEach(cb => cb.checked = e.target.checked);
          updateBulkActionBar();
        });
      }
    }
    
    // Update bulk action bar based on selected drivers
    function updateBulkActionBar() {
      const checkboxes = document.querySelectorAll('.driver-checkbox:checked');
      const bulkActionBar = document.getElementById('bulk-action-bar');
      const selectedCount = document.getElementById('selected-count');
      
      if (checkboxes.length > 0) {
        bulkActionBar.classList.remove('hidden');
        selectedCount.textContent = `${checkboxes.length} selected`;
      } else {
        bulkActionBar.classList.add('hidden');
      }
    }

    // Open driver's individual dashboard
    function openDriverDashboard(driverId) {
      const driver = fleetData.find(d => d.id === driverId);
      if (!driver) {
        showToast('Driver not found');
        return;
      }
      
      // Update the current driver data
      updateDriverData(driverId);
      
      // Switch to the individual dashboard view
      switchView('dashboard');
      
      // Show toast notification
      showToast(`Switched to ${driver.name}'s individual dashboard`);
    }

    function openDriverModal(driverId) {
      const driver = fleetData.find(d => d.id === driverId);
      if (!driver) return;
      const modal = document.getElementById('driver-details-modal');
      const content = document.getElementById('driver-modal-content');
      content.innerHTML = `
        <div class="mb-2"><span class="font-semibold">ID:</span> ${driver.id}</div>
        <div class="mb-2"><span class="font-semibold">Name:</span> ${driver.name}</div>
        <div class="mb-2"><span class="font-semibold">Score:</span> ${driver.performance.score}</div>
        <div class="mb-2"><span class="font-semibold">Safe Driving:</span> ${driver.performance.metrics.safeDriving.toFixed(1)}</div>
        <div class="mb-2"><span class="font-semibold">Efficiency:</span> ${driver.performance.metrics.efficiency.toFixed(1)}</div>
        <div class="mb-2"><span class="font-semibold">Compliance:</span> ${driver.performance.metrics.compliance.toFixed(1)}</div>
        <div class="mb-2"><span class="font-semibold">Harsh Braking:</span> ${driver.performance.metrics.harshBraking}</div>
        <div class="mb-2"><span class="font-semibold">Speeding:</span> ${driver.performance.metrics.speeding}</div>
        <div class="mb-2"><span class="font-semibold">Idling:</span> ${driver.performance.metrics.idling}</div>
      `;
      modal.classList.remove('hidden');
    }

    // Open driver camera modal
    function openDriverCameraModal(driverId) {
      const driver = fleetData.find(d => d.id === driverId);
      const camera = cameraData.find(c => c.id === driverId);
      if (!driver || !camera) return;

      const statusColor = camera.status === 'online' ? 'bg-green-500' : 
                         camera.status === 'alert' ? 'bg-red-500' : 'bg-gray-500';
      const alertBadge = camera.alertType !== 'none' ? 
        `<span class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded-full">
          ${camera.alertType.replace('_', ' ').toUpperCase()}
        </span>` : '';

      // Create camera modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="relative max-w-4xl max-h-screen p-4">
          <button onclick="this.parentElement.parentElement.remove()" 
                  class="absolute top-2 right-2 text-white hover:text-gray-300 text-2xl z-10">
            <i class="fas fa-times"></i>
          </button>
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <div class="relative">
              ${alertBadge}
              <img src="${camera.feedUrl}" alt="${camera.name} Camera Feed" 
                   class="w-full h-96 object-cover ${camera.status === 'offline' ? 'grayscale' : ''}"
                   onerror="this.src='https://via.placeholder.com/640x480/374151/9CA3AF?text=Camera+Offline'">
              <div class="absolute bottom-2 left-2 flex items-center gap-2">
                <span class="w-3 h-3 rounded-full ${statusColor}"></span>
                <span class="text-white text-sm font-medium bg-black bg-opacity-50 px-2 py-1 rounded">
                  ${camera.status.toUpperCase()}
                </span>
                ${camera.recording ? '<i class="fas fa-record-vinyl text-red-500"></i>' : ''}
              </div>
            </div>
            <div class="p-6">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3 class="text-xl font-bold text-gray-900 dark:text-white">${driver.name}</h3>
                  <p class="text-sm text-gray-500 dark:text-gray-400">${camera.cameraId} • Driver ID: ${driver.id}</p>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Quality: ${camera.quality} • Last Update: ${camera.lastUpdate}</p>
                </div>
                <div class="flex flex-col gap-2">
                  <span class="text-lg font-bold ${driver.performance.score >= 80 ? 'text-green-600' : driver.performance.score >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                    Score: ${driver.performance.score}
                  </span>
                </div>
              </div>
              <div class="flex gap-3">
                <button onclick="toggleCameraRecording('${camera.id}')" 
                        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                  <i class="fas fa-${camera.recording ? 'stop' : 'record-vinyl'} mr-1"></i>
                  ${camera.recording ? 'Stop Recording' : 'Start Recording'}
                </button>
                <button onclick="refreshSingleCamera('${camera.id}')" 
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                  <i class="fas fa-sync-alt mr-1"></i>Refresh Feed
                </button>
                <button onclick="this.closest('.fixed').remove()" 
                        class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                  <i class="fas fa-times mr-1"></i>Close
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Driver details modal (structure)
    if (!document.getElementById('driver-details-modal')) {
      const modal = document.createElement('div');
      modal.id = 'driver-details-modal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4" id="driver-modal-title">Driver Details</h3>
          <div id="driver-modal-content" class="mb-4"></div>
          <div class="flex justify-end gap-2 mt-4">
            <button id="close-driver-modal" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('close-driver-modal').onclick = () => {
        modal.classList.add('hidden');
      };
    }
    
    // Add Driver Modal Functionality
    function initAddDriverModal() {
      const addDriverBtn = document.getElementById('add-driver-btn');
      const addDriverModal = document.getElementById('add-driver-modal');
      const closeAddDriverModal = document.getElementById('close-add-driver-modal');
      const cancelAddDriver = document.getElementById('cancel-add-driver');
      const saveDraftDriver = document.getElementById('save-draft-driver');
      const addDriverForm = document.getElementById('add-driver-form');

      // Open modal
      addDriverBtn.addEventListener('click', () => {
        addDriverModal.classList.remove('hidden');
        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('driver-start-date').value = today;
        // Set max date for DOB (18 years ago)
        const maxDate = new Date();
        maxDate.setFullYear(maxDate.getFullYear() - 18);
        document.getElementById('driver-dob').max = maxDate.toISOString().split('T')[0];
      });

      // Close modal
      function closeModal() {
        addDriverModal.classList.add('hidden');
        addDriverForm.reset();
      }

      closeAddDriverModal.addEventListener('click', closeModal);
      cancelAddDriver.addEventListener('click', closeModal);

      // Close modal when clicking outside
      addDriverModal.addEventListener('click', (e) => {
        if (e.target === addDriverModal) {
          closeModal();
        }
      });

      // Save draft functionality
      saveDraftDriver.addEventListener('click', () => {
        const formData = collectFormData();
        if (formData) {
          // Save to localStorage
          const drafts = JSON.parse(localStorage.getItem('driverDrafts') || '[]');
          drafts.push({
            ...formData,
            id: `DRAFT-${Date.now()}`,
            timestamp: new Date().toISOString(),
            status: 'draft'
          });
          localStorage.setItem('driverDrafts', JSON.stringify(drafts));
          showToast('Driver draft saved successfully');
          closeModal();
        }
      });

      // Form submission
      addDriverForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = collectFormData();
        if (formData) {
          addNewDriver(formData);
          closeModal();
        }
      });
    }

    // Collect form data
    function collectFormData() {
      const requiredFields = [
        'driver-first-name', 'driver-last-name', 'driver-dob', 'driver-email', 'driver-phone',
        'driver-address', 'driver-city', 'driver-state', 'driver-zip', 'driver-country',
        'driver-license-number', 'driver-license-type', 'driver-license-state', 'driver-license-expiry',
        'driver-experience', 'driver-start-date', 'driver-department', 'driver-position', 'driver-status',
        'driver-emergency-name', 'driver-emergency-relationship', 'driver-emergency-phone',
        'driver-medical-expiry'
      ];

      // Check required fields
      for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          showToast(`Please fill in ${field.previousElementSibling.textContent.replace(' *', '')}`, 'error');
          field.focus();
          return null;
        }
      }

      // Validate email
      const email = document.getElementById('driver-email').value;
      if (!isValidEmail(email)) {
        showToast('Please enter a valid email address', 'error');
        return null;
      }

      // Validate phone
      const phone = document.getElementById('driver-phone').value;
      if (!isValidPhone(phone)) {
        showToast('Please enter a valid phone number', 'error');
        return null;
      }

      // Validate license expiry
      const licenseExpiry = new Date(document.getElementById('driver-license-expiry').value);
      if (licenseExpiry <= new Date()) {
        showToast('License expiry date must be in the future', 'error');
        return null;
      }

      // Validate medical expiry
      const medicalExpiry = new Date(document.getElementById('driver-medical-expiry').value);
      if (medicalExpiry <= new Date()) {
        showToast('Medical certificate expiry date must be in the future', 'error');
        return null;
      }

      // Collect all form data
      const formData = {
        personal: {
          firstName: document.getElementById('driver-first-name').value,
          lastName: document.getElementById('driver-last-name').value,
          dateOfBirth: document.getElementById('driver-dob').value,
          gender: document.getElementById('driver-gender').value,
          email: document.getElementById('driver-email').value,
          phone: document.getElementById('driver-phone').value
        },
        address: {
          street: document.getElementById('driver-address').value,
          city: document.getElementById('driver-city').value,
          state: document.getElementById('driver-state').value,
          zip: document.getElementById('driver-zip').value,
          country: document.getElementById('driver-country').value
        },
        license: {
          number: document.getElementById('driver-license-number').value,
          type: document.getElementById('driver-license-type').value,
          state: document.getElementById('driver-license-state').value,
          expiry: document.getElementById('driver-license-expiry').value,
          experience: parseInt(document.getElementById('driver-experience').value),
          endorsements: Array.from(document.getElementById('driver-endorsements').selectedOptions).map(option => option.value)
        },
        employment: {
          startDate: document.getElementById('driver-start-date').value,
          department: document.getElementById('driver-department').value,
          position: document.getElementById('driver-position').value,
          employeeId: document.getElementById('driver-employee-id').value,
          hourlyRate: document.getElementById('driver-hourly-rate').value ? parseFloat(document.getElementById('driver-hourly-rate').value) : null,
          status: document.getElementById('driver-status').value
        },
        emergency: {
          name: document.getElementById('driver-emergency-name').value,
          relationship: document.getElementById('driver-emergency-relationship').value,
          phone: document.getElementById('driver-emergency-phone').value,
          email: document.getElementById('driver-emergency-email').value
        },
        medical: {
          certificateExpiry: document.getElementById('driver-medical-expiry').value,
          bloodType: document.getElementById('driver-blood-type').value,
          conditions: document.getElementById('driver-medical-conditions').value
        },
        training: {
          defensiveDriving: document.getElementById('driver-defensive-driving').value,
          hazmat: document.getElementById('driver-hazmat').value,
          firstAid: document.getElementById('driver-first-aid').value,
          cpr: document.getElementById('driver-cpr').value,
          additionalCerts: document.getElementById('driver-additional-certs').value
        },
        vehicle: {
          preferredType: document.getElementById('driver-vehicle-type').value,
          assignedVehicle: document.getElementById('driver-assigned-vehicle').value
        },
        notes: document.getElementById('driver-notes').value
      };

      return formData;
    }

    // Validation functions
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function isValidPhone(phone) {
      const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
      return phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''));
    }

    // Add new driver to the system
    function addNewDriver(formData) {
      // Generate new driver ID
      const newDriverId = `DRV-${String(fleetData.length + 1).padStart(3, '0')}`;
      
      // Create new driver object
      const newDriver = {
        id: newDriverId,
        name: `${formData.personal.firstName} ${formData.personal.lastName}`,
        performance: {
          score: 85, // Default score for new drivers
          metrics: {
            safeDriving: 50,
            efficiency: 25,
            compliance: 25,
            harshBraking: 0,
            speeding: 0,
            idling: 0
          }
        },
        // Store all onboarding data
        onboardingData: formData,
        // Add to camera data
        cameraData: {
          id: newDriverId,
          name: `${formData.personal.firstName} ${formData.personal.lastName}`,
          cameraId: `CAM-${newDriverId.slice(4)}`,
          status: 'offline',
          quality: 'HD',
          recording: false,
          lastUpdate: new Date().toLocaleTimeString(),
          alertType: 'none',
          feedUrl: `https://picsum.photos/400/300?random=${Math.floor(Math.random() * 1000)}&blur=1`,
          location: {
            lat: 40.7128 + (Math.random() - 0.5) * 0.1,
            lng: -74.0060 + (Math.random() - 0.5) * 0.1
          }
        }
      };

      // Add to fleet data
      fleetData.push(newDriver);
      cameraData.push(newDriver.cameraData);

      // Update UI
      updateFleetStatistics();
      renderDriverTable(fleetData);
      
      // Show success message
      showToast(`Driver ${newDriver.name} added successfully! ID: ${newDriverId}`);
      
      // Log the addition
      console.log('New driver added:', newDriver);
      
      // In a real application, this would:
      // - Send welcome email to driver
      // - Create driver account
      // - Assign vehicle if specified
      // - Schedule training if needed
      // - Send notifications to relevant departments
    }

    // Add bulk action event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const bulkMessageBtn = document.getElementById('bulk-message-btn');
      const bulkGroupBtn = document.getElementById('bulk-group-btn');
      const bulkRemoveBtn = document.getElementById('bulk-remove-btn');
      
      if (bulkMessageBtn) {
        bulkMessageBtn.addEventListener('click', () => {
          const selected = document.querySelectorAll('.driver-checkbox:checked');
          showToast(`Message sent to ${selected.length} selected drivers`);
        });
      }
      
      if (bulkGroupBtn) {
        bulkGroupBtn.addEventListener('click', () => {
          const selected = document.querySelectorAll('.driver-checkbox:checked');
          showToast(`${selected.length} drivers added to group`);
        });
      }
      
      if (bulkRemoveBtn) {
        bulkRemoveBtn.addEventListener('click', () => {
          const selected = document.querySelectorAll('.driver-checkbox:checked');
          if (confirm(`Are you sure you want to remove ${selected.length} drivers?`)) {
            showToast(`${selected.length} drivers removed`);
            // Here you would actually remove the drivers from fleetData
            updateBulkActionBar();
          }
        });
      }

      // Initialize messaging system
      updateUnreadCount();
      
      // Initialize Add Driver modal
      initAddDriverModal();
      
      // Add navigation click handlers
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          // Only prevent default for links without href or with href="#" or internal view switching
          if (!link.href || link.href.endsWith('#') || link.href.endsWith(window.location.href.split('#')[0]) || link.dataset.view) {
            e.preventDefault();
            const view = link.dataset.view;
            if (view) {
              switchView(view);
            }
          }
          // For actual navigation links, let them work normally
        });
      });
    });

    // Driver data with eco-driving metrics
    let driverData = {
      id: 'DRV-001',
      name: 'Driver 1',
      vehicle: {
        id: 'VEH-001',
        fuel: 75,
        engineTemp: 95,
        tirePressure: 32,
        battery: 90,
        mileage: 25000
      },
      performance: {
        score: 85,
        metrics: {
          safeDriving: 50,
          efficiency: 25,
          compliance: 25,
          harshBraking: 2,
          speeding: 1,
          idling: 3
        },
        badges: ['Efficiency', 'Safety', 'Compliance']
      },
      trip: {
        eta: '45 min',
        distance: '30 km',
        traffic: 'Low',
        route: [
          [51.505, -0.09],
          [51.51, -0.1],
          [51.52, -0.08]
        ]
      },
      alerts: [
        { type: 'Fatigue Alert', message: 'Time to take a break!', severity: 'Warning', timestamp: new Date().toLocaleTimeString(), snoozed: false },
        { type: 'Eco Tip', message: 'Maintain steady speed for better fuel efficiency', severity: 'Info', timestamp: new Date().toLocaleTimeString(), snoozed: false },
        { type: 'Log Hours', message: '4/8 hours driven today', severity: 'Info', timestamp: new Date().toLocaleTimeString(), snoozed: false }
      ],
      messages: [
        { sender: 'Dispatch', content: 'New route assigned: Delivery to Warehouse A', timestamp: new Date().toLocaleTimeString() },
        { sender: 'Dispatch', content: 'Traffic delay ahead, reroute suggested', timestamp: new Date().toLocaleTimeString() }
      ],
      timeline: [
        { event: 'Trip Started', timestamp: new Date(Date.now() - 2 * 3600000).toLocaleTimeString(), type: 'start' },
        { event: 'Harsh Braking', timestamp: new Date(Date.now() - 1.5 * 3600000).toLocaleTimeString(), type: 'alert' },
        { event: 'Rest Stop', timestamp: new Date(Date.now() - 1 * 3600000).toLocaleTimeString(), type: 'stop' },
        { event: 'Speeding Detected', timestamp: new Date(Date.now() - 0.5 * 3600000).toLocaleTimeString(), type: 'alert' }
      ]
    };

    // Eco-driving tips database
    const ecoTips = {
      harshBraking: {
        message: 'Reduce harsh braking to improve your safety score by 5%.',
        details: 'Harsh braking increases fuel consumption and wear on brakes. Try anticipating stops earlier and braking gradually.'
      },
      speeding: {
        message: 'Avoid speeding to boost efficiency by 10%.',
        details: 'Speeding reduces fuel efficiency and increases safety risks. Maintain posted speed limits for optimal performance.'
      },
      idling: {
        message: 'Minimize idling to save fuel and improve your score.',
        details: 'Excessive idling wastes fuel and increases emissions. Turn off the engine during long stops when safe.'
      }
    };

    // Dashboard customization
    let dashboardConfig = JSON.parse(localStorage.getItem('driverDashboardConfig')) || [
      'trip-map', 'vehicle-status', 'performance-score', 'alerts-tips', 'trip-timeline', 'messages'
    ];

    // Map functionality removed

    // Render Performance Chart
    let performanceChart;
    function renderPerformanceChart() {
      const ctx = document.getElementById('performance-chart').getContext('2d');
      if (performanceChart) performanceChart.destroy();
      performanceChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: [
            'Safe Driving',
            'Efficiency',
            'Compliance',
            'Harsh Braking',
            'Speeding',
            'Idling'
          ],
          datasets: [{
            label: 'Driver Metrics',
            data: [
              driverData.performance.metrics.safeDriving,
              driverData.performance.metrics.efficiency,
              driverData.performance.metrics.compliance,
              100 - driverData.performance.metrics.harshBraking * 10,
              100 - driverData.performance.metrics.speeding * 10,
              100 - driverData.performance.metrics.idling * 10
            ],
            backgroundColor: 'rgba(37,99,235,0.2)',
            borderColor: '#2563eb',
            pointBackgroundColor: [
              '#2563eb',
              '#16A34A',
              '#EAB308',
              '#EF4444',
              '#F59E42',
              '#10B981'
            ],
            pointRadius: 5,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.chart.data.labels[context.dataIndex];
                  const value = context.formattedValue;
                  return `${label}: ${value}`;
                }
              }
            }
          },
          scales: {
            r: {
              angleLines: { display: true },
              suggestedMin: 0,
              suggestedMax: 100,
              pointLabels: {
                font: { size: 14, weight: 'bold' },
                color: '#2563eb'
              },
              grid: { color: '#e5e7eb' },
              ticks: {
                stepSize: 20,
                color: '#64748b',
                font: { size: 12 }
              }
            }
          }
        }
      });
    }

    // Render Alerts with Eco-Driving Tips
    function renderAlerts() {
      const list = document.getElementById('alert-list');
      list.innerHTML = '';
      driverData.alerts.forEach((alert, index) => {
        if (!alert.snoozed) {
          const severityColor = alert.severity === 'Warning' ? 'text-yellow-600' : alert.severity === 'Critical' ? 'text-red-600' : 'text-green-600';
          const isEcoTip = alert.type === 'Eco Tip';
          const item = document.createElement('li');
          item.className = `alert-item flex justify-between items-center ${severityColor}`;
          item.innerHTML = `
            <div>
              <i class="fas ${alert.severity === 'Warning' ? 'fa-bell' : alert.severity === 'Critical' ? 'fa-exclamation-triangle' : 'fa-lightbulb'} mr-1"></i>
              ${alert.message} <span class="text-xs">(${alert.timestamp})</span>
            </div>
            <div class="flex gap-2">
              ${isEcoTip ? `<button class="learn-more text-gray-600 dark:text-gray-400 hover:text-gray-800" data-tip="${alert.message}" title="Learn More" aria-label="Learn More about ${alert.message}">
                <i class="fas fa-info-circle"></i>
              </button>` : ''}
              <button class="snooze-alert text-gray-600 dark:text-gray-400 hover:text-gray-800" data-index="${index}" title="Snooze Alert" aria-label="Snooze ${alert.message}">
                <i class="fas fa-clock"></i>
              </button>
            </div>
          `;
          list.appendChild(item);
        }
      });
      document.querySelectorAll('.snooze-alert').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          driverData.alerts[index].snoozed = true;
          showToast(`Alert "${driverData.alerts[index].message}" snoozed.`);
          renderAlerts();
        });
      });
      document.querySelectorAll('.learn-more').forEach(btn => {
        btn.addEventListener('click', () => {
          const tipMessage = btn.dataset.tip;
          const tipKey = Object.keys(ecoTips).find(key => ecoTips[key].message === tipMessage);
          if (tipKey) {
            const modal = document.getElementById('eco-tip-modal');
            document.getElementById('eco-tip-content').innerHTML = `
              <p class="font-semibold">${ecoTips[tipKey].message}</p>
              <p>${ecoTips[tipKey].details}</p>
            `;
            modal.classList.remove('hidden');
          }
        });
      });
    }

    // Render Messages
    function renderMessages() {
      const list = document.getElementById('message-list');
      list.innerHTML = '';
      driverData.messages.forEach(msg => {
        const item = document.createElement('div');
        item.className = 'p-2 bg-gray-100 dark:bg-gray-700 rounded';
        item.innerHTML = `<strong>${msg.sender}</strong>: ${msg.content} <span class="text-xs text-gray-500 dark:text-gray-400">(${msg.timestamp})</span>`;
        list.appendChild(item);
      });
    }

    // Render Trip Timeline
    function renderTimeline() {
      const container = document.getElementById('timeline-container');
      container.innerHTML = '';
      driverData.timeline.forEach(event => {
        const color = event.type === 'start' ? 'bg-green-500' : event.type === 'alert' ? 'bg-red-500' : event.type === 'info' ? 'bg-yellow-500' : 'bg-blue-500';
        const item = document.createElement('div');
        item.className = 'flex items-center space-x-2';
        item.innerHTML = `
          <span class="timeline-dot ${color}"></span>
          <div>${event.event} <span class="text-xs text-gray-500 dark:text-gray-400">(${event.timestamp})</span></div>
        `;
        container.appendChild(item);
      });
    }

    // Toast Notifications
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'alert-toast bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg';
      toast.textContent = message;
      document.getElementById('toast-container').appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    // Switch Views
    function switchView(view) {
      const dashboardView = document.getElementById('dashboard-view');
      const fleetView = document.getElementById('fleet-overview-view');
      const camerasView = document.getElementById('cameras-view');
      const messagesView = document.getElementById('messages-view');
      const navLinks = document.querySelectorAll('.nav-link');
      
      navLinks.forEach(link => {
        link.classList.remove('bg-blue-700', 'text-white');
        link.classList.add('text-blue-200');
        if (link.dataset.view === view) {
          link.classList.add('bg-blue-700', 'text-white');
          link.classList.remove('text-blue-200');
        }
      });
      
      // Hide all views first
      dashboardView.classList.add('hidden');
      fleetView.classList.add('hidden');
      camerasView.classList.add('hidden');
      messagesView.classList.add('hidden');
      
      if (view === 'dashboard') {
        dashboardView.classList.remove('hidden');
      } else if (view === 'fleet-overview') {
        fleetView.classList.remove('hidden');
        updateFleetStatistics();
        renderDriverTable(fleetData);
        console.log('Switched to fleet overview, rendering driver table');
      } else if (view === 'cameras') {
        camerasView.classList.remove('hidden');
        renderCameraGrid();
        renderCameraAlerts();
        console.log('Switched to cameras view');
      } else if (view === 'messages') {
        messagesView.classList.remove('hidden');
        initMessagesSystem();
        console.log('Switched to messages view');
      }
    }

    // Update Fleet Statistics
    function updateFleetStatistics() {
      const totalDrivers = fleetData.length;
      const activeDrivers = fleetData.filter(d => d.performance.score >= 80).length;
      const avgSafetyScore = fleetData.reduce((sum, d) => sum + d.performance.score, 0) / totalDrivers;
      const alertsToday = Math.floor(Math.random() * 25) + 5; // Simulated data
      
      document.getElementById('total-drivers').textContent = totalDrivers;
      document.getElementById('active-drivers').textContent = activeDrivers;
      document.getElementById('avg-safety-score').textContent = avgSafetyScore.toFixed(1);
      document.getElementById('alerts-today').textContent = alertsToday;
    }

    // Initialize Driver Selector for Individual Dashboard
    function initDriverSelector() {
      const selector = document.getElementById('driver-selector');
      if (selector) {
        // Populate driver options
        selector.innerHTML = '<option value="">Select Driver</option>';
        fleetData.forEach(driver => {
          const option = document.createElement('option');
          option.value = driver.id;
          option.textContent = `${driver.name} (${driver.id})`;
          selector.appendChild(option);
        });
        
        // Set current driver as selected
        selector.value = driverData.id;
        
        // Add change event listener
        selector.addEventListener('change', (e) => {
          const selectedDriverId = e.target.value;
          if (selectedDriverId && selectedDriverId !== driverData.id) {
            updateDriverData(selectedDriverId);
            showToast(`Switched to ${fleetData.find(d => d.id === selectedDriverId)?.name || 'driver'}`);
          }
        });
      }
    }

    // Fleet overview mode - driver navigation removed as requested

    // Update Driver Data
    function updateDriverData(driverId) {
      const selectedDriver = fleetData.find(d => d.id === driverId);
      if (!selectedDriver) return;
      // Update driverData with selected driver's performance metrics
      driverData = {
        ...driverData,
        id: selectedDriver.id,
        name: selectedDriver.name,
        performance: selectedDriver.performance,
        vehicle: {
          ...driverData.vehicle,
          id: `VEH-${driverId.slice(4)}`,
          fuel: 70 + Math.random() * 20, // Randomize vehicle data slightly
          engineTemp: 90 + Math.random() * 10,
          tirePressure: 30 + Math.random() * 4,
          battery: 85 + Math.random() * 10,
          mileage: 24000 + Math.random() * 2000
        },
        trip: {
          ...driverData.trip,
          eta: `${40 + Math.floor(Math.random() * 20)} min`,
          distance: `${25 + Math.floor(Math.random() * 10)} km`,
          traffic: ['Low', 'Moderate', 'High'][Math.floor(Math.random() * 3)],
          route: [
            [51.505 + (Math.random() - 0.5) * 0.02, -0.09 + (Math.random() - 0.5) * 0.02],
            [51.51 + (Math.random() - 0.5) * 0.02, -0.1 + (Math.random() - 0.5) * 0.02],
            [51.52 + (Math.random() - 0.5) * 0.02, -0.08 + (Math.random() - 0.5) * 0.02]
          ]
        },
        alerts: [
          { type: 'Fatigue Alert', message: 'Time to take a break!', severity: 'Warning', timestamp: new Date().toLocaleTimeString(), snoozed: false },
          { type: 'Eco Tip', message: 'Maintain steady speed for better fuel efficiency', severity: 'Info', timestamp: new Date().toLocaleTimeString(), snoozed: false }
        ],
        messages: [
          { sender: 'Dispatch', content: `New route assigned for ${selectedDriver.name}`, timestamp: new Date().toLocaleTimeString() }
        ],
        timeline: [
          { event: 'Trip Started', timestamp: new Date(Date.now() - 2 * 3600000).toLocaleTimeString(), type: 'start' },
          { event: 'Rest Stop', timestamp: new Date(Date.now() - 1 * 3600000).toLocaleTimeString(), type: 'stop' }
        ]
      };
      // Update UI
      updateTripInfo();
      // Map functionality removed
      document.getElementById('vehicle-fuel').textContent = `${driverData.vehicle.fuel.toFixed(1)}%`;
      document.getElementById('vehicle-engine-temp').textContent = `${driverData.vehicle.engineTemp.toFixed(1)}°C`;
      document.getElementById('vehicle-tire-pressure').textContent = `${driverData.vehicle.tirePressure.toFixed(1)} psi`;
      document.getElementById('vehicle-battery').textContent = `${driverData.vehicle.battery.toFixed(1)}%`;
      document.getElementById('vehicle-mileage').textContent = `${driverData.vehicle.mileage.toLocaleString()} km`;
      document.getElementById('driver-score').textContent = `${driverData.performance.score.toFixed(1)}/100`;
      renderPerformanceChart();
      renderAlerts();
      renderMessages();
      renderTimeline();
      
      // Update driver selector dropdown
      const selector = document.getElementById('driver-selector');
      if (selector) {
        selector.value = driverId;
      }
      
      // Update welcome header with driver name
      const welcomeHeader = document.querySelector('#dashboard-view h2');
      if (welcomeHeader) {
        welcomeHeader.textContent = `Welcome, ${selectedDriver.name}`;
      }
    }

    // Event Listeners
    document.getElementById('sidebar-toggle').addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      const main = document.getElementById('main-content-container');
      const header = document.querySelector('header');
      
      // Check if we're on mobile
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        sidebar.classList.toggle('active');
      } else {
        sidebar.classList.toggle('sidebar-hidden');
        main.classList.toggle('ml-64');
        main.classList.toggle('ml-0');
        
        // Toggle header position
        if (sidebar.classList.contains('sidebar-hidden')) {
          header.style.left = '0';
        } else {
          header.style.left = '18rem'; // 72 / 4 = 18rem (left-72)
        }
      }
    });
    
    // Close mobile sidebar when clicking outside
    document.addEventListener('click', (e) => {
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile && sidebar.classList.contains('active')) {
        if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
          sidebar.classList.remove('active');
        }
      }
    });

    // Fleet overview mode - keyboard shortcuts removed with driver navigation

    document.getElementById('dark-mode-toggle').addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const icon = document.getElementById('dark-mode-toggle').querySelector('i');
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
    });

    // Safe event listener setup with null checks
    const sosButton = document.getElementById('sos-button');
    if (sosButton) {
      sosButton.addEventListener('click', () => {
        showToast('Emergency SOS activated! Dispatch notified.');
      });
    }

    const startNavigationBtn = document.getElementById('start-navigation');
    if (startNavigationBtn) {
      startNavigationBtn.addEventListener('click', () => {
        showToast('Navigation started.');
        driverData.trip.eta = '40 min';
        driverData.trip.distance = '28 km';
        driverData.trip.traffic = 'Moderate';
        updateTripInfo();
      });
    }

    const rerouteBtn = document.getElementById('reroute-btn');
    if (rerouteBtn) {
      rerouteBtn.addEventListener('click', () => {
        showToast('Rerouting... New route calculated.');
        driverData.trip.route = [
          [51.505, -0.09],
          [51.515, -0.095],
          [51.525, -0.085]
        ];
        driverData.trip.eta = '42 min';
        driverData.trip.distance = '29 km';
        driverData.trip.traffic = 'Low';
        updateTripInfo();
        // Map functionality removed
      });
    }

    document.getElementById('report-issue-btn').addEventListener('click', () => {
      showToast('Issue reported to dispatch.');
      driverData.alerts.push({
        type: 'Vehicle Issue',
        message: 'Driver reported vehicle issue',
        severity: 'Warning',
        timestamp: new Date().toLocaleTimeString(),
        snoozed: false
      });
      renderAlerts();
    });

    document.getElementById('log-eld-btn').addEventListener('click', () => {
      showToast('ELD hours logged successfully.');
      driverData.alerts.push({
        type: 'ELD Log',
        message: 'Hours logged: 4.5/8 hours',
        severity: 'Info',
        timestamp: new Date().toLocaleTimeString(),
        snoozed: false
      });
      renderAlerts();
    });

    document.getElementById('clear-alerts-btn').addEventListener('click', () => {
      driverData.alerts.forEach(a => a.snoozed = true);
      showToast('All alerts cleared.');
      renderAlerts();
    });

    document.getElementById('send-message-btn').addEventListener('click', () => {
      const input = document.getElementById('message-input');
      if (input.value.trim()) {
        driverData.messages.push({
          sender: driverData.name,
          content: input.value,
          timestamp: new Date().toLocaleTimeString()
        });
        showToast('Message sent to dispatch.');
        input.value = '';
        renderMessages();
      }
    });

    document.getElementById('voice-command-btn').addEventListener('click', () => {
      document.getElementById('voice-command-modal').classList.remove('hidden');
    });

    document.getElementById('submit-voice').addEventListener('click', () => {
      const input = document.getElementById('voice-input').value.toLowerCase();
      if (input.includes('navigate')) {
        showToast('Navigating to requested destination.');
        driverData.trip.eta = '50 min';
        driverData.trip.distance = '35 km';
        driverData.trip.traffic = 'High';
        updateTripInfo();
      } else if (input.includes('log break')) {
        showToast('Break logged successfully.');
        driverData.timeline.push({
          event: 'Break Taken',
          timestamp: new Date().toLocaleTimeString(),
          type: 'stop'
        });
        renderTimeline();
      }
      document.getElementById('voice-command-modal').classList.add('hidden');
    });

    document.getElementById('cancel-voice').addEventListener('click', () => {
      document.getElementById('voice-command-modal').classList.add('hidden');
    });

    document.getElementById('close-eco-tip').addEventListener('click', () => {
      document.getElementById('eco-tip-modal').classList.add('hidden');
    });

    document.getElementById('customize-dashboard-btn').addEventListener('click', () => {
      showToast('Drag widgets to reorder or hide them.');
      const grid = document.getElementById('widget-grid');
      grid.classList.add('border-2', 'border-dashed', 'border-blue-400');
      setTimeout(() => grid.classList.remove('border-2', 'border-dashed', 'border-blue-400'), 5000);
    });

    Sortable.create(document.getElementById('widget-grid'), {
      animation: 150,
      onEnd: function(evt) {
        const widgets = Array.from(document.querySelectorAll('.widget-card')).map(w => w.dataset.widget);
        dashboardConfig = widgets;
        localStorage.setItem('driverDashboardConfig', JSON.stringify(dashboardConfig));
        showToast('Dashboard layout saved.');
      }
    });

    // Camera Event Listeners
    document.getElementById('refresh-cameras-btn').addEventListener('click', () => {
      // Refresh camera feeds
      cameraData.forEach(camera => {
        camera.lastUpdate = new Date().toLocaleTimeString();
        camera.feedUrl = `https://picsum.photos/400/300?random=${Math.floor(Math.random() * 1000)}&blur=1`;
      });
      renderCameraGrid();
      showToast('Camera feeds refreshed');
    });

    document.getElementById('toggle-recording-btn').addEventListener('click', () => {
      isRecording = !isRecording;
      const button = document.getElementById('toggle-recording-btn');
      
      if (isRecording) {
        button.innerHTML = '<i class="fas fa-stop mr-1"></i>Stop Recording';
        button.className = button.className.replace('bg-red-600 hover:bg-red-700', 'bg-green-600 hover:bg-green-700');
        // Start recording for all cameras
        cameraData.forEach(camera => camera.recording = true);
        showToast('Started recording all cameras');
      } else {
        button.innerHTML = '<i class="fas fa-record-vinyl mr-1"></i>Start Recording';
        button.className = button.className.replace('bg-green-600 hover:bg-green-700', 'bg-red-600 hover:bg-red-700');
        // Stop recording for all cameras
        cameraData.forEach(camera => camera.recording = false);
        showToast('Stopped recording all cameras');
      }
      renderCameraGrid();
    });

    document.getElementById('camera-filter').addEventListener('change', (e) => {
      const filter = e.target.value;
      let filteredCameras = cameraData;
      
      switch (filter) {
        case 'active':
          filteredCameras = cameraData.filter(c => c.status === 'online');
          break;
        case 'alerts':
          filteredCameras = cameraData.filter(c => c.status === 'alert');
          break;
        case 'offline':
          filteredCameras = cameraData.filter(c => c.status === 'offline');
          break;
        default:
          filteredCameras = cameraData;
      }
      
      renderCameraGrid(filteredCameras, currentCameraLayout);
      showToast(`Showing ${filteredCameras.length} cameras (${filter})`);
    });

    document.getElementById('camera-layout').addEventListener('change', (e) => {
      currentCameraLayout = e.target.value;
      renderCameraGrid(cameraData, currentCameraLayout);
      showToast(`Changed to ${currentCameraLayout} layout`);
    });

    document.getElementById('fullscreen-cameras-btn').addEventListener('click', () => {
      const camerasView = document.getElementById('cameras-view');
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else {
        camerasView.requestFullscreen().catch(err => {
          showToast('Could not enable fullscreen mode');
        });
      }
    });

    // Update Trip Info
    function updateTripInfo() {
      document.getElementById('trip-eta').textContent = driverData.trip.eta;
      document.getElementById('trip-distance').textContent = driverData.trip.distance;
      document.getElementById('trip-traffic').textContent = driverData.trip.traffic;
    }

    // Simulate Real-Time Updates with Eco-Driving Tips
    function simulateRealTimeUpdates() {
      setInterval(() => {
        driverData.vehicle.fuel = Math.max(0, driverData.vehicle.fuel - Math.random() * 0.5);
        driverData.vehicle.engineTemp = 90 + Math.random() * 10;
        driverData.vehicle.tirePressure = 30 + Math.random() * 4;
        driverData.vehicle.battery = Math.max(0, driverData.vehicle.battery - Math.random() * 0.2);
        driverData.vehicle.mileage += Math.floor(Math.random() * 10);
        if (driverData.vehicle.fuel < 20 && !driverData.alerts.some(a => a.message === 'Low Fuel')) {
          driverData.alerts.push({
            type: 'Low Fuel',
            message: 'Low Fuel: Refuel soon',
            severity: 'Warning',
            timestamp: new Date().toLocaleTimeString(),
            snoozed: false
          });
        }
        // Add eco-driving tips based on performance metrics
        if (Math.random() > 0.8 && driverData.performance.metrics.harshBraking > 2 && !driverData.alerts.some(a => a.message === ecoTips.harshBraking.message)) {
          driverData.alerts.push({
            type: 'Eco Tip',
            message: ecoTips.harshBraking.message,
            severity: 'Info',
            timestamp: new Date().toLocaleTimeString(),
            snoozed: false
          });
          driverData.timeline.push({
            event: 'Eco Tip: Harsh Braking',
            timestamp: new Date().toLocaleTimeString(),
            type: 'info'
          });
        } else if (Math.random() > 0.85 && driverData.performance.metrics.speeding > 1 && !driverData.alerts.some(a => a.message === ecoTips.speeding.message)) {
          driverData.alerts.push({
            type: 'Eco Tip',
            message: ecoTips.speeding.message,
            severity: 'Info',
            timestamp: new Date().toLocaleTimeString(),
            snoozed: false
          });
          driverData.timeline.push({
            event: 'Eco Tip: Speeding',
            timestamp: new Date().toLocaleTimeString(),
            type: 'info'
          });
        } else if (Math.random() > 0.9 && driverData.performance.metrics.idling > 2 && !driverData.alerts.some(a => a.message === ecoTips.idling.message)) {
          driverData.alerts.push({
            type: 'Eco Tip',
            message: ecoTips.idling.message,
            severity: 'Info',
            timestamp: new Date().toLocaleTimeString(),
            snoozed: false
          });
          driverData.timeline.push({
            event: 'Eco Tip: Idling',
            timestamp: new Date().toLocaleTimeString(),
            type: 'info'
          });
        }
        if (Math.random() > 0.9) {
          driverData.performance.score = Math.min(100, Math.max(0, driverData.performance.score + (Math.random() - 0.5) * 2));
          driverData.performance.metrics.safeDriving += (Math.random() - 0.5) * 2;
          driverData.performance.metrics.efficiency += (Math.random() - 0.5) * 2;
          driverData.performance.metrics.compliance += (Math.random() - 0.5) * 2;
          driverData.performance.metrics.harshBraking += Math.random() > 0.9 ? 1 : 0;
          driverData.performance.metrics.speeding += Math.random() > 0.9 ? 1 : 0;
          driverData.performance.metrics.idling += Math.random() > 0.9 ? 1 : 0;
          // Update fleetData for the current driver
          const currentDriver = fleetData.find(d => d.id === driverData.id);
          if (currentDriver) {
            currentDriver.performance = { ...driverData.performance };
          }
        }
        document.getElementById('vehicle-fuel').textContent = `${driverData.vehicle.fuel.toFixed(1)}%`;
        document.getElementById('vehicle-engine-temp').textContent = `${driverData.vehicle.engineTemp.toFixed(1)}°C`;
        document.getElementById('vehicle-tire-pressure').textContent = `${driverData.vehicle.tirePressure.toFixed(1)} psi`;
        document.getElementById('vehicle-battery').textContent = `${driverData.vehicle.battery.toFixed(1)}%`;
        document.getElementById('vehicle-mileage').textContent = `${driverData.vehicle.mileage.toLocaleString()} km`;
        document.getElementById('driver-score').textContent = `${driverData.performance.score.toFixed(1)}/100`;
        renderPerformanceChart();
        renderAlerts();
        renderTimeline();
      }, 10000);
    }

    // Keyboard Navigation and View Switching
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        // Only prevent default for links without href or with href="#" or internal view switching
        if (!link.href || link.href.endsWith('#') || link.href.endsWith(window.location.href.split('#')[0]) || link.dataset.view) {
          e.preventDefault();
          const view = link.dataset.view;
          if (view) {
            switchView(view);
          }
        }
        // For actual navigation links, let them work normally
      });
      link.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          link.click();
        }
      });
    });

    // Initial Render
    function initDashboard() {
      console.log('Initializing dashboard with fleet data:', fleetData.length, 'drivers');
      
      const grid = document.getElementById('widget-grid');
      const widgets = Array.from(grid.children);
      grid.innerHTML = '';
      dashboardConfig.forEach(widgetId => {
        const widget = widgets.find(w => w.dataset.widget === widgetId);
        if (widget) grid.appendChild(widget);
      });
      // Map initialization removed
      renderPerformanceChart();
      renderAlerts();
      renderMessages();
      renderTimeline();
      initDriverSelector();
      
      // Set initial welcome message with driver name
      const welcomeHeader = document.querySelector('#dashboard-view h2');
      if (welcomeHeader && driverData.name) {
        welcomeHeader.textContent = `Welcome, ${driverData.name}`;
      }
      
      // Ensure driver table is rendered on fleet overview
      renderDriverTable(fleetData);
      console.log('Initial driver table render completed');
      
      // Initialize camera alerts simulation
      setInterval(() => {
        if (Math.random() < 0.1) { // 10% chance every 3 seconds
          const alertTypes = ['Speed Violation', 'Distracted Driving', 'Harsh Braking', 'Lane Deviation'];
          const alertType = alertTypes[Math.floor(Math.random() * alertTypes.length)];
          const camera = cameraData[Math.floor(Math.random() * cameraData.length)];
          addCameraAlert(`Camera ${camera.id}`, alertType);
        }
      }, 3000);

      // Auto-refresh camera feeds every 30 seconds
      setInterval(() => {
        if (document.getElementById('cameras-view').style.display !== 'none') {
          cameraData.forEach(camera => {
            camera.lastUpdate = new Date().toLocaleTimeString();
            if (Math.random() < 0.05) { // 5% chance to change status
              const statuses = ['online', 'offline', 'alert'];
              camera.status = statuses[Math.floor(Math.random() * statuses.length)];
            }
          });
          renderCameraGrid();
        }
      }, 30000);
      
      simulateRealTimeUpdates();
      switchView('fleet-overview');
    }

    // Direct Driver Messaging System
    let driverMessages = [];
    let messageTemplates = {
      'safety-reminder': {
        subject: 'Safety Reminder',
        content: 'Please remember to maintain safe following distances and adhere to all traffic laws. Your safety is our top priority.',
        priority: 'normal',
        type: 'instruction'
      },
      'route-update': {
        subject: 'Route Update',
        content: 'Your route has been updated due to traffic conditions. Please follow the new GPS directions.',
        priority: 'high',
        type: 'instruction'
      },
      'break-reminder': {
        subject: 'Break Reminder',
        content: 'It\'s time for your scheduled break. Please pull over safely and take your required rest period.',
        priority: 'normal',
        type: 'notification'
      },
      'performance-feedback': {
        subject: 'Performance Feedback',
        content: 'Great job on your recent performance! Your safety score has improved. Keep up the excellent work!',
        priority: 'normal',
        type: 'notification'
      },
      'maintenance-alert': {
        subject: 'Maintenance Alert',
        content: 'Your vehicle requires scheduled maintenance. Please return to the depot at the end of your shift.',
        priority: 'high',
        type: 'alert'
      },
      'weather-warning': {
        subject: 'Weather Warning',
        content: 'Severe weather conditions ahead. Please reduce speed and exercise extra caution.',
        priority: 'urgent',
        type: 'alert'
      }
    };

    // Initialize Driver Messaging System
    function initDriverMessaging() {
      setupMessageEventListeners();
      loadMessageTemplates();
      renderRecentMessages();
    }

    // Setup message event listeners
    function setupMessageEventListeners() {
      // Quick message template buttons
      document.querySelectorAll('.quick-message-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const template = messageTemplates[btn.dataset.template];
          if (template) {
            fillMessageTemplate(template);
          }
        });
      });

      // Send message button
      document.getElementById('send-message-btn').addEventListener('click', sendDriverMessage);
      
      // Schedule message button
      document.getElementById('schedule-message-btn').addEventListener('click', scheduleDriverMessage);
      
      // View all messages button
      document.getElementById('view-all-messages-btn').addEventListener('click', () => {
        switchView('messages');
      });

      // Executive control message buttons
      document.getElementById('send-urgent-message-btn').addEventListener('click', () => {
        showUrgentMessageModal();
      });

      document.getElementById('emergency-call-btn').addEventListener('click', () => {
        initiateEmergencyCall();
      });
    }

    // Fill message template
    function fillMessageTemplate(template) {
      document.getElementById('driver-message-subject').value = template.subject;
      document.getElementById('driver-message-content').value = template.content;
      document.getElementById('driver-message-priority').value = template.priority;
      document.getElementById('driver-message-type').value = template.type;
      
      // Highlight the selected template
      document.querySelectorAll('.quick-message-btn').forEach(btn => {
        btn.classList.remove('bg-blue-50', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-200');
      });
      event.target.classList.add('bg-blue-50', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-200');
    }

    // Send message to driver
    function sendDriverMessage() {
      const subject = document.getElementById('driver-message-subject').value.trim();
      const content = document.getElementById('driver-message-content').value.trim();
      const priority = document.getElementById('driver-message-priority').value;
      const type = document.getElementById('driver-message-type').value;
      const requireAck = document.getElementById('require-acknowledgment').checked;
      const pushNotification = document.getElementById('send-push-notification').checked;
      const voiceMessage = document.getElementById('record-voice-message').checked;

      if (!subject || !content) {
        showToast('Please fill in both subject and message content', 'error');
        return;
      }

      const message = {
        id: Date.now(),
        subject: subject,
        content: content,
        priority: priority,
        type: type,
        timestamp: new Date(),
        status: 'sent',
        requireAcknowledgment: requireAck,
        pushNotification: pushNotification,
        voiceMessage: voiceMessage,
        driverId: driverData.id,
        driverName: driverData.name
      };

      // Add to messages array
      driverMessages.unshift(message);
      
      // Update recent messages display
      renderRecentMessages();
      
      // Clear form
      clearMessageForm();
      
      // Show success message
      showToast(`Message sent to ${driverData.name} successfully!`);
      
      // Simulate message delivery
      simulateMessageDelivery(message);
    }

    // Schedule message for later
    function scheduleDriverMessage() {
      const subject = document.getElementById('driver-message-subject').value.trim();
      const content = document.getElementById('driver-message-content').value.trim();
      
      if (!subject || !content) {
        showToast('Please fill in both subject and message content', 'error');
        return;
      }

      // Show scheduling modal
      const scheduledTime = prompt('Enter scheduled time (HH:MM):');
      if (scheduledTime) {
        const message = {
          id: Date.now(),
          subject: subject,
          content: content,
          priority: document.getElementById('driver-message-priority').value,
          type: document.getElementById('driver-message-type').value,
          scheduledTime: scheduledTime,
          status: 'scheduled',
          driverId: driverData.id,
          driverName: driverData.name
        };

        driverMessages.unshift(message);
        renderRecentMessages();
        clearMessageForm();
        showToast(`Message scheduled for ${scheduledTime}`);
      }
    }

    // Clear message form
    function clearMessageForm() {
      document.getElementById('driver-message-subject').value = '';
      document.getElementById('driver-message-content').value = '';
      document.getElementById('driver-message-priority').value = 'normal';
      document.getElementById('driver-message-type').value = 'text';
      document.getElementById('require-acknowledgment').checked = false;
      document.getElementById('send-push-notification').checked = false;
      document.getElementById('record-voice-message').checked = false;
      
      // Reset template highlighting
      document.querySelectorAll('.quick-message-btn').forEach(btn => {
        btn.classList.remove('bg-blue-50', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-200');
      });
    }

    // Render recent messages
    function renderRecentMessages() {
      const container = document.getElementById('recent-messages-container');
      if (!container) return;

      // Get recent messages for current driver (last 5)
      const recentMessages = driverMessages
        .filter(msg => msg.driverId === driverData.id)
        .slice(0, 5);

      if (recentMessages.length === 0) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm text-center py-4">No recent messages</p>';
        return;
      }

      container.innerHTML = '';
      recentMessages.forEach(message => {
        const messageElement = document.createElement('div');
        messageElement.className = 'p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
        
        const priorityColor = message.priority === 'urgent' ? 'bg-red-500' : 
                             message.priority === 'high' ? 'bg-yellow-500' : 'bg-green-500';
        
        const statusBadge = message.status === 'sent' ? 
          '<span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">Sent</span>' :
          message.status === 'acknowledged' ?
          '<span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">Acknowledged</span>' :
          '<span class="text-xs bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 px-2 py-1 rounded">Scheduled</span>';

        messageElement.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 ${priorityColor} rounded-full"></span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${message.subject}</span>
              <span class="text-xs text-gray-500 dark:text-gray-400">${formatTimeAgo(message.timestamp)}</span>
            </div>
            ${statusBadge}
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400">${message.content}</p>
        `;
        
        container.appendChild(messageElement);
      });
    }

    // Show urgent message modal
    function showUrgentMessageModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Send Urgent Message</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject</label>
              <input type="text" id="urgent-subject" placeholder="Urgent message subject" 
                     class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message</label>
              <textarea id="urgent-content" rows="4" placeholder="Urgent message content..." 
                        class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 dark:bg-gray-700 dark:text-white"></textarea>
            </div>
          </div>
          <div class="flex justify-end gap-2 mt-6">
            <button onclick="this.closest('.fixed').remove()" 
                    class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
              Cancel
            </button>
            <button onclick="sendUrgentMessage()" 
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
              Send Urgent Message
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Send urgent message
    function sendUrgentMessage() {
      const subject = document.getElementById('urgent-subject').value.trim();
      const content = document.getElementById('urgent-content').value.trim();
      
      if (!subject || !content) {
        showToast('Please fill in both subject and message content', 'error');
        return;
      }

      const message = {
        id: Date.now(),
        subject: subject,
        content: content,
        priority: 'urgent',
        type: 'alert',
        timestamp: new Date(),
        status: 'sent',
        requireAcknowledgment: true,
        pushNotification: true,
        driverId: driverData.id,
        driverName: driverData.name
      };

      driverMessages.unshift(message);
      renderRecentMessages();
      
      // Close modal
      document.querySelector('.fixed').remove();
      
      showToast(`Urgent message sent to ${driverData.name}!`);
      simulateMessageDelivery(message);
    }

    // Initiate emergency call
    function initiateEmergencyCall() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-phone-alt text-red-600 mr-2"></i>Emergency Call
          </h3>
          <p class="text-gray-600 dark:text-gray-400 mb-4">
            Initiating emergency call to ${driverData.name}...
          </p>
          <div class="flex justify-center mb-4">
            <div class="animate-pulse">
              <i class="fas fa-phone text-4xl text-red-600"></i>
            </div>
          </div>
          <div class="flex justify-end gap-2">
            <button onclick="this.closest('.fixed').remove()" 
                    class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
              Cancel Call
            </button>
            <button onclick="endEmergencyCall()" 
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
              End Call
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Simulate call connection
      setTimeout(() => {
        showToast('Emergency call connected to driver');
      }, 2000);
    }

    // End emergency call
    function endEmergencyCall() {
      document.querySelector('.fixed').remove();
      showToast('Emergency call ended');
    }

    // Simulate message delivery
    function simulateMessageDelivery(message) {
      setTimeout(() => {
        if (message.requireAcknowledgment) {
          // Simulate acknowledgment after 30 seconds
          setTimeout(() => {
            message.status = 'acknowledged';
            renderRecentMessages();
            showToast(`${driverData.name} acknowledged your message`);
          }, 30000);
        }
      }, 2000);
    }

    // Format time ago
    function formatTimeAgo(timestamp) {
      const now = new Date();
      const diff = now - timestamp;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      return timestamp.toLocaleDateString();
    }

    // Load message templates
    function loadMessageTemplates() {
      // Templates are already defined above
      console.log('Message templates loaded:', Object.keys(messageTemplates).length);
    }

    initDashboard();
    initDriverMessaging();

    // ===== FEEDBACK SYSTEM =====
    class FeedbackManager {
      constructor() {
        this.storage = window.feedbackStorage;
        this.setupEventListeners();
      }

      setupEventListeners() {
        // Feedback toggle button
        const feedbackToggle = document.getElementById('feedback-toggle');
        if (feedbackToggle) {
          feedbackToggle.addEventListener('click', () => this.openFeedbackModal());
        }

        // Modal controls
        const closeFeedbackModal = document.getElementById('close-feedback-modal');
        if (closeFeedbackModal) {
          closeFeedbackModal.addEventListener('click', () => this.closeFeedbackModal());
        }

        const cancelFeedbackBtn = document.getElementById('cancel-feedback-btn');
        if (cancelFeedbackBtn) {
          cancelFeedbackBtn.addEventListener('click', () => this.closeFeedbackModal());
        }

        // Form submission
        const feedbackForm = document.getElementById('feedback-form');
        if (feedbackForm) {
          feedbackForm.addEventListener('submit', (e) => this.handleSubmitFeedback(e));
        }

        // Character counter
        const feedbackNote = document.getElementById('feedback-note');
        if (feedbackNote) {
          feedbackNote.addEventListener('input', () => this.updateCharacterCount());
        }

        // Submit another feedback
        const submitAnotherBtn = document.getElementById('submit-another-feedback');
        if (submitAnotherBtn) {
          submitAnotherBtn.addEventListener('click', () => this.resetFeedbackForm());
        }

        // Feedback controls
        const refreshBtn = document.getElementById('refresh-feedback');
        const exportBtn = document.getElementById('export-feedback');
        const clearBtn = document.getElementById('clear-feedback');

        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => this.loadFeedback());
        }
        if (exportBtn) {
          exportBtn.addEventListener('click', () => this.exportFeedback());
        }
        if (clearBtn) {
          clearBtn.addEventListener('click', () => this.clearAllFeedback());
        }
      }

      openFeedbackModal() {
        const modal = document.getElementById('feedback-modal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          
          // Focus on first input
          const nameInput = document.getElementById('feedback-name');
          if (nameInput) {
            setTimeout(() => nameInput.focus(), 100);
          }
        }
      }

      closeFeedbackModal() {
        const modal = document.getElementById('feedback-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      openViewFeedbackModal() {
        const modal = document.getElementById('view-feedback-modal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          this.loadFeedback();
        }
      }

      closeViewFeedbackModal() {
        const modal = document.getElementById('view-feedback-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      updateCharacterCount() {
        const textarea = document.getElementById('feedback-note');
        const counter = document.getElementById('char-count');
        if (textarea && counter) {
          const count = textarea.value.length;
          counter.textContent = count;
          
          if (count > 1000) {
            counter.style.color = '#ef4444';
            textarea.value = textarea.value.substring(0, 1000);
            counter.textContent = '1000';
          } else {
            counter.style.color = '#6b7280';
          }
        }
      }

      async handleSubmitFeedback(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-feedback-btn');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
        submitBtn.disabled = true;

        try {
          const formData = new FormData(e.target);
          const feedbackData = {
            id: Date.now().toString(),
            name: formData.get('name'),
            note: formData.get('note'),
            timestamp: new Date().toISOString(),
            system: 'Drivers Management System'
          };

          // Validate required fields
          if (!feedbackData.name || !feedbackData.note) {
            throw new Error('Please fill in all required fields');
          }

          // Save using the feedback storage system
          const success = this.storage.saveFeedback(feedbackData);
          if (!success) {
            throw new Error('Failed to save feedback to storage');
          }
          
          // Show success message
          this.showSuccessMessage();
          
        } catch (error) {
          console.error('Error submitting feedback:', error);
          alert('Error submitting feedback: ' + error.message);
          
          // Restore button state
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      showSuccessMessage() {
        const form = document.getElementById('feedback-form');
        const success = document.getElementById('feedback-success');
        
        if (form && success) {
          form.classList.add('hidden');
          success.classList.remove('hidden');
        }
      }

      resetFeedbackForm() {
        const form = document.getElementById('feedback-form');
        const success = document.getElementById('feedback-success');
        const submitBtn = document.getElementById('submit-feedback-btn');
        
        if (form) {
          form.reset();
          form.classList.remove('hidden');
        }
        
        if (success) {
          success.classList.add('hidden');
        }
        
        if (submitBtn) {
          submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Feedback';
          submitBtn.disabled = false;
        }

        // Reset character counter
        const counter = document.getElementById('char-count');
        if (counter) {
          counter.textContent = '0';
        }
      }

      loadFeedback() {
        const feedbackList = document.getElementById('feedback-list');
        if (!feedbackList) return;

        // Get all feedback from storage
        const allFeedback = this.storage.getAllFeedback();

        // Sort by timestamp (newest first)
        allFeedback.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (allFeedback.length === 0) {
          feedbackList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-comments text-4xl mb-3"></i>
              <p>No feedback submitted yet. Encourage your team to share their thoughts!</p>
            </div>
          `;
          return;
        }

        // Render feedback items
        feedbackList.innerHTML = allFeedback.map(item => this.renderFeedbackItem(item)).join('');
      }

      renderFeedbackItem(feedback) {
        const date = new Date(feedback.timestamp).toLocaleDateString();
        const time = new Date(feedback.timestamp).toLocaleTimeString();

        return `
          <div class="border border-gray-200 rounded-lg p-4 bg-white hover:shadow-md transition-shadow">
            <div class="flex items-start gap-3 mb-3">
              <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                <span class="text-orange-600 font-semibold">${feedback.name.charAt(0).toUpperCase()}</span>
              </div>
              <div class="flex-1">
                <h4 class="font-semibold text-gray-900">${feedback.name}</h4>
                <p class="text-xs text-gray-500">${date} at ${time}</p>
              </div>
            </div>
            
            <div class="mb-3">
              <p class="text-gray-700 leading-relaxed">${feedback.note}</p>
            </div>
          </div>
        `;
      }

      exportFeedback() {
        try {
          this.storage.exportFeedback();
          this.showNotification('Feedback exported successfully!', 'success');
        } catch (error) {
          console.error('Error exporting feedback:', error);
          this.showNotification('Error exporting feedback', 'error');
        }
      }

      clearAllFeedback() {
        if (confirm('Are you sure you want to clear all feedback? This action cannot be undone.')) {
          this.storage.clearAllFeedback();
          this.loadFeedback();
          this.showNotification('All feedback cleared successfully!', 'success');
        }
      }

      showNotification(message, type = 'info') {
        // Create a simple notification
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
          type === 'success' ? 'bg-green-500 text-white' :
          type === 'error' ? 'bg-red-500 text-white' :
          'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }
    }

    // Initialize feedback system
    let feedbackManager;
    document.addEventListener('DOMContentLoaded', function() {
      feedbackManager = new FeedbackManager();
    });
  </script>



  <!-- Feedback Submission Modal -->
  <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-comment-dots text-orange-600"></i>
          Submit Feedback & Suggestions
        </h3>
        <button id="close-feedback-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="mb-6">
        <p class="text-gray-600 text-sm leading-relaxed">
          Help us improve the drivers management system! Share your thoughts on the design, features, usability, or suggest new functionality. Your feedback is valuable and will be reviewed by our development team.
        </p>
      </div>

      <form id="feedback-form" class="space-y-6">
        <!-- Name Field -->
        <div>
          <label for="feedback-name" class="block text-sm font-medium text-gray-700 mb-2">
            Your Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="feedback-name" 
            name="name"
            required
            placeholder="Enter your full name"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors"
          >
        </div>

        <!-- Feedback/Note Field -->
        <div>
          <label for="feedback-note" class="block text-sm font-medium text-gray-700 mb-2">
            Feedback & Comments <span class="text-red-500">*</span>
          </label>
          <textarea 
            id="feedback-note" 
            name="note"
            required
            rows="8"
            placeholder="Please describe your feedback, suggestions, or issues in detail. Be specific about what you liked, what could be improved, or what new features you'd like to see..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors resize-vertical"
          ></textarea>
          <div class="mt-1 text-xs text-gray-500">
            <span id="char-count">0</span>/1000 characters
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row gap-3 pt-4">
          <button 
            type="submit" 
            id="submit-feedback-btn"
            class="flex-1 px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 focus:ring-4 focus:ring-orange-500/20 transition-all font-medium flex items-center justify-center gap-2"
          >
            <i class="fas fa-paper-plane"></i>
            Submit Feedback
          </button>
          <button 
            type="button" 
            id="cancel-feedback-btn"
            class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:ring-4 focus:ring-gray-500/20 transition-all font-medium"
          >
            Cancel
          </button>
        </div>
      </form>

      <!-- Success Message -->
      <div id="feedback-success" class="hidden text-center py-8">
        <div class="mb-4">
          <i class="fas fa-check-circle text-5xl text-green-500"></i>
        </div>
        <h4 class="text-xl font-bold text-gray-900 mb-2">Feedback Submitted Successfully!</h4>
        <p class="text-gray-600 mb-4">Thank you for your valuable feedback. Our team will review it and get back to you if needed.</p>
        <button id="submit-another-feedback" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
          Submit Another Feedback
        </button>
      </div>
    </div>
  </div>

  <!-- View Feedback Modal -->
  <div id="view-feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-comments text-orange-600"></i>
          Submitted Feedback & Comments
        </h3>
        <button id="close-view-feedback-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- Feedback Controls -->
      <div class="mb-6 flex flex-wrap gap-3">
        <button id="refresh-feedback" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
          <i class="fas fa-sync mr-1"></i> Refresh
        </button>
        <button id="export-feedback" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
          <i class="fas fa-download mr-1"></i> Export JSON
        </button>
        <button id="clear-feedback" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
          <i class="fas fa-trash mr-1"></i> Clear All
        </button>
      </div>

      <!-- Feedback List -->
      <div id="feedback-list" class="space-y-4 max-h-96 overflow-y-auto">
        <!-- Feedback items will be populated here -->
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-comments text-4xl mb-3"></i>
          <p>No feedback submitted yet. Encourage your team to share their thoughts!</p>
        </div>
      </div>
    </div>
  </div>
</body>
</html>