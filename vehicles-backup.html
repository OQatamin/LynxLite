<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Vehicles - Lynx Lite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Leaflet MarkerCluster for fleet map widget -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="drivers-data.js"></script>
  <script src="vehicles-data.js"></script>
  <!-- Fleet Map Widget Integration -->
  <script src="fleet-map-widget.js"></script>
  <script src="map-integration-helper.js"></script>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark body {
      background: linear-gradient(to bottom, #1f2937, #111827);
      color: #f3f4f6;
    }
    .dark .bg-white {
      background: #1f2937;
    }
    .dark .text-gray-900 {
      color: #f3f4f6;
    }
    .dark .text-gray-600 {
      color: #d1d5db;
    }
    .vehicle-card {
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .vehicle-card:hover {
      box-shadow: 0 8px 24px rgba(37,99,235,0.2);
      transform: translateY(-2px) scale(1.01);
    }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px;
    }
    .status-online { background: #16A34A; }
    .status-offline { background: #DC2626; }
    .status-idling { background: #EAB308; }
    .status-driving { background: #2563eb; }
    .status-maintenance { background: #f59e42; }
    .status-alert { background: #f43f5e; }
    .vehicle-action-btn {
      transition: all 0.2s ease;
      border: none;
      outline: none;
      cursor: pointer;
    }
    .vehicle-action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .vehicle-action-btn:active {
      transform: translateY(0);
    }
    .analytics-widget {
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      cursor: move;
    }
    .dark .analytics-widget {
      background: linear-gradient(145deg, #374151, #1f2937);
    }
    .leaflet-container {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .sidebar-hidden {
      transform: translateX(-100%);
    }
    .alert-feed {
      transition: transform 0.3s ease;
    }
    .alert-feed-hidden {
      transform: translateX(100%);
    }
    .alert-item {
      transition: opacity 0.3s;
    }
    .alert-item.snoozed {
      opacity: 0.5;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <header class="bg-white dark:bg-gray-800 shadow flex flex-wrap justify-between items-center px-6 py-4 z-30 fixed top-0 left-0 w-full">
    <div class="flex items-center space-x-4">
      <button id="sidebar-toggle" class="text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle Sidebar" tabindex="0">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Fleet Vehicles</h1>
      <span class="ml-4 px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-sm font-semibold" title="Current User Role">Admin</span>
    </div>
    <div class="flex items-center space-x-2 md:space-x-4 flex-wrap">
      <input type="text" id="vehicle-search" placeholder="Search Vehicle, Driver, VIN..." class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-4 py-2 rounded-lg w-48 md:w-64 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" aria-label="Search Vehicles">
      <button id="filter-btn" class="p-2 text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Filter Vehicles" tabindex="0" title="Filter Vehicles">
        <i class="fas fa-filter"></i>
      </button>
      <button id="alert-feed-toggle" class="p-2 text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle Alert Feed" tabindex="0" title="Show Alerts Feed">
        <i class="fas fa-bell"></i>
      </button>
      <div class="relative group">
        <button id="bulk-action-btn" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 flex items-center text-sm" aria-label="Bulk Actions" tabindex="0" title="Bulk Actions">
          <i class="fas fa-tasks mr-1"></i> <span class="hidden md:inline">Bulk Actions</span>
          <i class="fas fa-caret-down ml-2"></i>
        </button>
        <div id="bulk-actions-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg z-30 border border-gray-200 dark:border-gray-700">
          <button class="block w-full text-left px-4 py-2 hover:bg-blue-50 dark:hover:bg-gray-700" id="bulk-assign-driver">Assign Driver</button>
          <button class="block w-full text-left px-4 py-2 hover:bg-blue-50 dark:hover:bg-gray-700" id="bulk-schedule-maintenance">Schedule Maintenance</button>
          <button class="block w-full text-left px-4 py-2 hover:bg-blue-50 dark:hover:bg-gray-700" id="bulk-send-message">Send Message</button>
        </div>
      </div>
      <button id="bulk-maintenance-btn" class="bg-yellow-500 text-white px-3 py-2 rounded-lg hover:bg-yellow-600 focus:ring-2 focus:ring-yellow-500 flex items-center text-sm" aria-label="Bulk Maintenance" tabindex="0" title="Bulk Maintenance Scheduling">
        <i class="fas fa-tools mr-1"></i> <span class="hidden lg:inline">Bulk Maintenance</span>
      </button>
      <button id="add-vehicle-btn" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 flex items-center text-sm" aria-label="Add Vehicle" tabindex="0" title="Add Vehicle">
        <i class="fas fa-plus mr-1"></i> <span class="hidden md:inline">Add Vehicle</span>
      </button>
      <button id="create-group-btn" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500 flex items-center text-sm" aria-label="Create Group" tabindex="0" title="Create Vehicle Group">
        <i class="fas fa-layer-group mr-1"></i> <span class="hidden lg:inline">Create Group</span>
      </button>
      <button id="toggle-table-view" class="p-2 text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle Table View" tabindex="0" title="Switch to Table/List View">
        <i class="fas fa-table"></i>
      </button>
      <button id="theme-toggle" class="p-2 text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle Theme" tabindex="0" title="Toggle Light/Dark Mode">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </header>
  <aside id="sidebar" class="w-64 bg-blue-900 text-white flex flex-col py-6 px-4 fixed top-16 left-0 h-[calc(100vh-4rem)] z-20 transition-transform duration-300" aria-label="Main Navigation">
    <nav class="space-y-4">
      <a href="index.html" class="nav-link group flex items-center px-3 py-2 text-sm font-semibold text-white bg-blue-700 rounded-lg" role="menuitem" tabindex="0">
        <i class="fas fa-tachometer-alt fa-fw mr-3"></i><span class="nav-text">Dashboard</span>
      </a>
      <a href="vehicles.html" class="nav-link group flex items-center px-3 py-2 text-sm font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-700" role="menuitem" tabindex="0">
        <i class="fas fa-truck fa-fw mr-3"></i><span class="nav-text">Vehicles</span>
      </a>
      <a href="#" class="nav-link group flex items-center px-3 py-2 text-sm font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-700" role="menuitem" tabindex="0">
        <i class="fas fa-cogs fa-fw mr-3"></i><span class="nav-text">Settings</span>
      </a>
      <a href="#" class="nav-link group flex items-center px-3 py-2 text-sm font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-700" role="menuitem" tabindex="0">
        <i class="fas fa-question-circle fa-fw mr-3"></i><span class="nav-text">Help & Support</span>
      </a>
    </nav>
  </aside>
  <!-- Alert Feed Sidebar -->
  <aside id="alert-feed" class="w-80 bg-white dark:bg-gray-800 text-gray-900 dark:text-white flex flex-col py-6 px-4 fixed top-16 right-0 h-[calc(100vh-4rem)] z-20 transition-transform duration-300 alert-feed alert-feed-hidden" aria-label="Alert Feed">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Alerts</h2>
      <button id="clear-all-alerts" class="text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Clear All Alerts" tabindex="0">
        <i class="fas fa-trash"></i>
      </button>
    </div>
    <div class="mb-4">
      <select id="alert-filter-type" class="block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2">
        <option value="">All Alerts</option>
        <option value="Low Fuel">Low Fuel</option>
        <option value="High Temp">High Temp</option>
        <option value="Predictive Maintenance">Predictive Maintenance</option>
        <option value="Geofence Violation">Geofence Violation</option>
      </select>
      <select id="alert-filter-group" class="mt-2 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2">
        <option value="">All Groups</option>
        <option value="Delivery">Delivery</option>
        <option value="Service">Service</option>
        <option value="Executive">Executive</option>
      </select>
    </div>
    <div id="alert-list" class="flex-1 overflow-y-auto space-y-2"></div>
  </aside>
  <main id="main-content-container" class="flex-1 ml-64 pt-24 px-8" aria-label="Main Content">
    <!-- Filter Modal -->
    <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="filter-modal-title">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
        <h3 id="filter-modal-title" class="text-lg font-bold text-gray-900 dark:text-white mb-4">Filter Vehicles</h3>
        <div class="space-y-4">
          <div>
            <label for="filter-status" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Status</label>
            <select id="filter-status" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2">
              <option value="">All</option>
              <option value="Driving">Driving</option>
              <option value="Idling">Idling</option>
              <option value="Parked">Parked</option>
              <option value="Offline">Offline</option>
              <option value="Maintenance">Maintenance</option>
              <option value="Alert">Alert</option>
            </select>
          </div>
          <div>
            <label for="filter-group" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Group</label>
            <select id="filter-group" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2">
              <option value="">All</option>
              <option value="Delivery">Delivery</option>
              <option value="Service">Service</option>
              <option value="Executive">Executive</option>
            </select>
          </div>
          <div>
            <label for="filter-driver" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Driver</label>
            <input type="text" id="filter-driver" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2" placeholder="Enter driver name">
          </div>
          <div class="flex justify-between gap-2">
            <button id="save-filter-preset" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700" title="Save current filter as preset">Save Preset</button>
            <div class="flex gap-2">
              <button id="clear-filter" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">Clear</button>
              <button id="apply-filter" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Apply</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Geofence Settings Modal -->
    <div id="geofence-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="geofence-modal-title">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
          <h3 id="geofence-modal-title" class="text-lg font-bold text-gray-900 dark:text-white">Geofence Settings</h3>
          <button id="close-geofence-modal" class="text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-xl" aria-label="Close Modal">Ã—</button>
        </div>
        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg">
            <div class="flex items-center gap-2 text-blue-800 dark:text-blue-200 text-sm">
              <i class="fas fa-lightbulb"></i>
              <span>Tip: Click on the map to quickly set the geofence center, or enter coordinates manually below.</span>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="geofence-lat" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Center Latitude</label>
              <input type="number" id="geofence-lat" value="51.5074" step="0.0001" min="-90" max="90" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., 51.5074">
            </div>
            <div>
              <label for="geofence-lng" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Center Longitude</label>
              <input type="number" id="geofence-lng" value="-0.1278" step="0.0001" min="-180" max="180" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., -0.1278">
            </div>
          </div>
          
          <div>
            <label for="geofence-radius" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Radius (km)</label>
            <div class="flex items-center gap-3">
              <input type="range" id="geofence-radius-slider" min="0.1" max="50" step="0.1" value="5" class="flex-1">
              <input type="number" id="geofence-radius" value="5" step="0.1" min="0.1" max="50" class="w-20 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <span class="text-sm text-gray-500">km</span>
            </div>
            <div class="text-xs text-gray-500 mt-1">Area: <span id="geofence-area">78.54</span> kmÂ²</div>
          </div>
          
          <div>
            <label for="geofence-name" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Geofence Name (Optional)</label>
            <input type="text" id="geofence-name" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., City Center Zone">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Alert Settings</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" id="geofence-entry-alert" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Alert when vehicle enters geofence</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" id="geofence-exit-alert" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Alert when vehicle exits geofence</span>
              </label>
            </div>
          </div>
          
          <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
            <button id="cancel-geofence" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancel</button>
            <button id="preview-geofence" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Preview on Map</button>
            <button id="apply-geofence" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Apply Geofence</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Analytics Widgets -->
    <div id="analytics-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div class="analytics-widget flex items-center justify-between" data-widget="total-vehicles">
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Total Vehicles</div>
          <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="total-vehicles">--</div>
        </div>
        <i class="fas fa-truck text-3xl text-blue-400 dark:text-blue-300"></i>
      </div>
      <div class="analytics-widget flex items-center justify-between" data-widget="active-vehicles">
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Active (Driving)</div>
          <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="active-vehicles">--</div>
        </div>
        <i class="fas fa-route text-3xl text-green-400 dark:text-green-300"></i>
      </div>
      <div class="analytics-widget flex items-center justify-between" data-widget="maintenance-vehicles">
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400">In Maintenance</div>
          <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="maintenance-vehicles">--</div>
        </div>
        <i class="fas fa-tools text-3xl text-yellow-400 dark:text-yellow-300"></i>
      </div>
      <div class="analytics-widget flex items-center justify-between" data-widget="alert-vehicles">
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Alerts</div>
          <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="alert-vehicles">--</div>
        </div>
        <i class="fas fa-exclamation-triangle text-3xl text-red-400 dark:text-red-300"></i>
      </div>
      <div class="analytics-widget flex items-center justify-between" data-widget="avg-driver-score">
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Avg Driver Score</div>
          <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="avg-driver-score">--</div>
        </div>
        <i class="fas fa-star text-3xl text-purple-400 dark:text-purple-300"></i>
      </div>
    </div>
    

    
    <!-- Vehicle Types & Shifts Management -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Vehicle Types Section -->
      <section class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">Vehicle Types</h2>
          <button id="add-vehicle-type" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 flex items-center text-sm">
            <i class="fas fa-plus mr-2"></i>Add Type
          </button>
        </div>
        <div id="vehicle-types-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Vehicle types will be rendered here -->
        </div>
      </section>

      <!-- Shift Schedules Section -->
      <section class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">Shift Schedules</h2>
          <button id="add-shift-schedule" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 flex items-center text-sm">
            <i class="fas fa-plus mr-2"></i>Add Shift
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <th class="text-left py-2 px-3 text-sm font-medium text-gray-900 dark:text-white">Shift</th>
                <th class="text-left py-2 px-3 text-sm font-medium text-gray-900 dark:text-white">Time</th>
                <th class="text-left py-2 px-3 text-sm font-medium text-gray-900 dark:text-white">Days</th>
                <th class="text-left py-2 px-3 text-sm font-medium text-gray-900 dark:text-white">Drivers</th>
                <th class="text-left py-2 px-3 text-sm font-medium text-gray-900 dark:text-white">Actions</th>
              </tr>
            </thead>
            <tbody id="shifts-table-body">
              <!-- Shifts will be rendered here -->
            </tbody>
          </table>
        </div>
      </section>
    </div>
    
    <!-- Vehicle List & Map -->
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Vehicle List -->
      <section class="flex-1">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">Vehicles</h2>
          <div class="flex gap-2 items-center">
            <div class="relative">
              <select id="sort-vehicles" class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-3 py-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Sort by...</option>
                <option value="status">Status</option>
                <option value="driver-score-desc">Driver Score (High to Low)</option>
                <option value="last-update">Last Update (Recent first)</option>
                <option value="fuel-asc">Fuel Level (Low first)</option>
              </select>
            </div>
            <button class="text-blue-600 dark:text-blue-400 hover:text-blue-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500" id="export-csv-btn">
              <i class="fas fa-download mr-1"></i>Export CSV
            </button>
            <button class="text-blue-600 dark:text-blue-400 hover:text-blue-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500" id="customize-dashboard-btn">
              <i class="fas fa-sliders-h mr-1"></i>Customize
            </button>
          </div>
        </div>
        <div id="vehicle-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          <!-- Loading indicator -->
          <div id="loading-indicator" class="col-span-full flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600 dark:text-gray-400">Loading vehicles...</span>
          </div>
        </div>
        <!-- Table View (hidden by default) -->
        <div id="vehicle-table-view" class="hidden overflow-x-auto mt-4">
          <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg shadow">
            <thead>
              <tr>
                <th class="p-2"><input type="checkbox" id="select-all-table"></th>
                <th class="p-2">ID</th>
                <th class="p-2">Make & Model</th>
                <th class="p-2">Driver</th>
                <th class="p-2">Status</th>
                <th class="p-2">Group</th>
                <th class="p-2">Last Ping</th>
                <th class="p-2">Driver Score</th>
                <th class="p-2">Alerts</th>
                <th class="p-2">Actions</th>
              </tr>
            </thead>
            <tbody id="vehicle-table-body"></tbody>
          </table>
        </div>
        <div class="flex justify-between mt-6">
          <button id="prev-page" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300" disabled>Previous</button>
          <span id="page-info" class="text-sm text-gray-600 dark:text-gray-400">Page 1</span>
          <button id="next-page" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">Next</button>
        </div>

        <!-- Create Group Modal -->
        <div id="create-group-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="create-group-modal-title">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
            <h3 id="create-group-modal-title" class="text-lg font-bold text-gray-900 dark:text-white mb-4">Create Vehicle Group</h3>
            <div class="space-y-4">
              <div>
                <label for="group-name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Group Name</label>
                <input type="text" id="group-name" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2" placeholder="Enter group name">
              </div>
              <div class="flex justify-end gap-2">
                <button id="cancel-create-group" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-create-group" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Create</button>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- Map and Analytics -->
      <section class="w-full lg:w-[600px] xl:w-[700px]">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Vehicle Locations</h3>
          <div id="map" style="height: 450px; max-height: 450px; overflow: hidden; border-radius: 6px; border: 1px solid #e5e7eb;"></div>
          <!-- FleetMapWidget has its own complete control system - no additional buttons needed -->
          <div id="geofence-status" class="mt-2 text-sm text-gray-600 dark:text-gray-400 hidden">
            <div class="flex items-center gap-2">
              <i class="fas fa-info-circle"></i>
              <span>Click on the map to set geofence center, then adjust radius</span>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Fleet Utilization</h3>
          <canvas id="utilization-chart" height="120"></canvas>
        </div>
      </section>
    </div>
    <!-- Vehicle Details Modal -->
    <div id="vehicle-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden p-4" role="dialog" aria-labelledby="vehicle-modal-title">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] relative flex flex-col">
        <div class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700">
          <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-2xl" aria-label="Close Modal">Ã—</button>
          <h2 class="text-xl font-bold text-gray-900 dark:text-white pr-8">Vehicle Details</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-6">
          <div id="vehicle-modal-content"></div>
        </div>
      </div>
    </div>
  </main>
  <script>
    // Vehicle manufacturers and models data
    const vehicleTypes = {
      'Ford': ['Transit', 'E-Series', 'F-150', 'Ranger', 'Transit Connect'],
      'Mercedes-Benz': ['Sprinter', 'Vito', 'Actros', 'Atego', 'Citan'],
      'Volkswagen': ['Crafter', 'Caddy', 'Amarok', 'Transporter'],
      'Iveco': ['Daily', 'Eurocargo', 'Stralis', 'S-Way'],
      'MAN': ['TGE', 'TGM', 'TGS', 'TGX'],
      'Volvo': ['FH', 'FM', 'FE', 'FL'],
      'Scania': ['P-Series', 'G-Series', 'R-Series', 'S-Series'],
      'DAF': ['LF', 'CF', 'XF'],
      'Isuzu': ['D-Max', 'NPR', 'NQR', 'FRR'],
      'Mitsubishi': ['Fuso Canter', 'L200', 'Outlander']
    };

    // Generate realistic plate numbers
    function generatePlateNumber() {
      const formats = [
        () => `${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String(Math.floor(Math.random() * 90) + 10)} ${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}`, // UK format: AB12 CDE
        () => `${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}-${String(Math.floor(Math.random() * 9000) + 1000)}`, // AAA-1234
        () => `${String(Math.floor(Math.random() * 9000) + 1000)}-${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}`, // 1234-AAA
        () => `${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String(Math.floor(Math.random() * 900) + 100)}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}` // A123BB
      ];
      const selectedFormat = formats[Math.floor(Math.random() * formats.length)];
      return selectedFormat();
    }

    // Generate violation history for drivers
    function generateViolationHistory() {
      const violationTypes = [
        { type: 'Speeding', severity: 'High', points: 3, description: 'Exceeded speed limit by 10+ km/h' },
        { type: 'Harsh Braking', severity: 'Medium', points: 2, description: 'Sudden braking detected' },
        { type: 'Harsh Acceleration', severity: 'Medium', points: 2, description: 'Rapid acceleration detected' },
        { type: 'Idling', severity: 'Low', points: 1, description: 'Excessive engine idling' },
        { type: 'Geofence Violation', severity: 'High', points: 3, description: 'Vehicle left designated area' },
        { type: 'Maintenance Overdue', severity: 'Medium', points: 2, description: 'Scheduled maintenance not completed' },
        { type: 'Fuel Waste', severity: 'Low', points: 1, description: 'Poor fuel efficiency detected' },
        { type: 'Route Deviation', severity: 'Medium', points: 2, description: 'Vehicle deviated from assigned route' }
      ];
      
      const history = [];
      const numViolations = Math.floor(Math.random() * 5); // 0-4 violations
      
      for (let i = 0; i < numViolations; i++) {
        const violation = violationTypes[Math.floor(Math.random() * violationTypes.length)];
        const daysAgo = Math.floor(Math.random() * 30) + 1; // 1-30 days ago
        
        history.push({
          ...violation,
          date: new Date(Date.now() - daysAgo * 24 * 3600000).toLocaleDateString(),
          time: new Date(Date.now() - daysAgo * 24 * 3600000).toLocaleTimeString(),
          location: `${(51.5 + (Math.random() - 0.5) * 0.1).toFixed(6)}, ${(-0.09 + (Math.random() - 0.5) * 0.1).toFixed(6)}`,
          resolved: Math.random() > 0.3, // 70% resolved
          warningIssued: Math.random() > 0.5 // 50% had warnings issued
        });
      }
      
      return history;
    }

    // Map fleet status to vehicles page status
    function mapFleetStatusToVehiclesPage(fleetStatus) {
      const statusMap = {
        'active': 'Driving',
        'idle': 'Idling',
        'offline': 'Offline'
      };
      return statusMap[fleetStatus] || 'Parked';
    }

    // Initialize vehicles data with proper error handling and fallbacks
    let vehicles = [];
    
    function initializeVehiclesData() {
      console.log('ðŸ”„ Initializing vehicles data...');
      console.log('ðŸ” Data sources check:');
      console.log('  - UnifiedFleetData available:', typeof window.UnifiedFleetData !== 'undefined');
      console.log('  - SharedVehicleData available:', typeof window.SharedVehicleData !== 'undefined');
      console.log('  - VehiclesDataAPI available:', typeof VehiclesDataAPI !== 'undefined');
      console.log('  - DriversDataAPI available:', typeof DriversDataAPI !== 'undefined');
      
      try {
        // Use the unified fleet data to ensure all systems show identical information
        if (typeof window.UnifiedFleetData !== 'undefined') {
          vehicles = window.UnifiedFleetData.getVehiclesForVehiclesPage();
          console.log('âœ… Using unified fleet data system:', vehicles.length, 'vehicles loaded with full compatibility');
        } else if (typeof window.SharedVehicleData !== 'undefined') {
          vehicles = window.SharedVehicleData.getVehiclesForVehiclesPage();
          console.log('âœ… Using shared vehicle data store:', vehicles.length, 'vehicles loaded');
        } else if (typeof VehiclesDataAPI !== 'undefined') {
          vehicles = VehiclesDataAPI.generateExtendedFleet(50);
          console.log('âœ… Using centralized vehicles data:', vehicles.length, 'vehicles loaded');
        } else {
          console.log('âš ï¸ No advanced vehicle data sources available, generating fallback data...');
          
          // Generate simple fallback data
          vehicles = Array.from({ length: 20 }, (_, i) => ({
            id: `VEH-${String(i + 1).padStart(3, '0')}`,
            driver: `Driver ${i + 1}`,
            status: ['Driving', 'Idling', 'Parked', 'Maintenance'][i % 4],
            manufacturer: ['Toyota', 'Ford', 'Mercedes', 'Volvo'][i % 4],
            model: ['Hiace', 'Transit', 'Sprinter', 'FH'][i % 4],
            plateNumber: `DEMO-${String(i + 1).padStart(3, '0')}`,
            year: 2020 + (i % 5),
            lat: 31.9539 + (Math.random() - 0.5) * 0.1,
            lng: 35.9106 + (Math.random() - 0.5) * 0.1,
            health: { 
              fuel: Math.floor(Math.random() * 80) + 20,
              mileage: 10000 + (i * 1000),
              maintenanceRisk: ['Low', 'Medium', 'High'][i % 3],
              engineTemp: Math.floor(Math.random() * 40) + 80,
              batteryLevel: Math.floor(Math.random() * 50) + 50
            },
            driverBehavior: { 
              score: Math.floor(Math.random() * 40) + 60,
              violations: Math.floor(Math.random() * 5),
              safetyRating: ['A', 'B', 'C'][i % 3]
            },
            alerts: Math.random() > 0.7 ? ['Low Fuel'] : [],
            group: ['Delivery', 'Service', 'Executive'][i % 3],
            route: {
              eta: new Date(Date.now() + Math.random() * 2 * 3600000).toLocaleTimeString(),
              distance: (Math.random() * 50 + 10).toFixed(1),
              currentSpeed: Math.floor(Math.random() * 80) + 20,
              destination: `Location ${i + 1}`,
              progress: Math.floor(Math.random() * 100)
            },
            utilization: Math.floor(Math.random() * 40) + 60,
            lastPing: new Date(Date.now() - Math.random() * 1800000).toLocaleTimeString()
          }));
          console.log('âœ… Generated fallback vehicle data:', vehicles.length, 'vehicles');
        }
        
        console.log('ðŸ“Š Final vehicles array length:', vehicles.length);
        return vehicles.length > 0;
        
      } catch (error) {
        console.error('âŒ Error initializing vehicles data:', error);
        
        // Emergency fallback if everything fails
        if (vehicles.length === 0) {
          console.log('ðŸ†˜ Creating emergency fallback data...');
          vehicles = Array.from({ length: 10 }, (_, i) => ({
            id: `VEH-${String(i + 1).padStart(3, '0')}`,
            driver: `Emergency Driver ${i + 1}`,
            status: ['Driving', 'Idling', 'Parked'][i % 3],
            manufacturer: 'Toyota',
            model: 'Emergency',
            plateNumber: `EMG-${String(i + 1).padStart(3, '0')}`,
            year: 2020,
            lat: 31.9539,
            lng: 35.9106,
            health: { fuel: 50, mileage: 10000, maintenanceRisk: 'Low' },
            driverBehavior: { score: 75 },
            alerts: [],
            group: 'Emergency',
            route: { eta: '12:00', distance: '10.0', currentSpeed: 50 },
            utilization: 75,
            lastPing: new Date().toLocaleTimeString()
          }));
          console.log('ðŸ†˜ Emergency fallback data created:', vehicles.length, 'vehicles');
        }
        return vehicles.length > 0;
      }
    }
    
    // Initialize vehicles data immediately
    console.log('ðŸš€ Starting vehicle data initialization...');
    const dataLoaded = initializeVehiclesData();
    console.log('ðŸŽ¯ Vehicle data initialization completed. Success:', dataLoaded, '| Vehicle count:', vehicles.length);
        const manufacturerKeys = Object.keys(vehicleTypes);
        const manufacturer = manufacturerKeys[i % manufacturerKeys.length];
        const models = vehicleTypes[manufacturer];
        const model = models[i % models.length];
        
        // Get driver data for this vehicle
        const driverInfo = vehicleDriverData[i] || {
          driverName: `Driver ${i + 1}`,
          driverScore: Math.floor(Math.random() * 1000) + 1500,
          safetyScore: Math.floor(Math.random() * 30) + 70,
          efficiency: Math.floor(Math.random() * 40) + 60
        };
      
      return {
        id: `VEH-${String(i + 1).padStart(3, '0')}`,
        vin: `VIN${100000 + i}`,
        plateNumber: generatePlateNumber(),
        manufacturer: manufacturer,
        model: model,
        year: 2018 + (i % 7), // Years from 2018 to 2024
        driver: driverInfo.driverName,
        driverId: driverInfo.driverId,
        status: ['Driving', 'Idling', 'Parked', 'Offline', 'Maintenance', 'Alert'][Math.floor(Math.random() * 6)],
        group: ['Delivery', 'Service', 'Executive'][i % 3],
        lat: 51.5 + (Math.random() - 0.5) * 0.1,
        lng: -0.09 + (Math.random() - 0.5) * 0.1,
        lastPing: new Date(Date.now() - Math.random() * 3600000).toLocaleTimeString(),
        health: {
          fuel: Math.floor(Math.random() * 100),
          battery: Math.floor(Math.random() * 100),
          engineTemp: 80 + Math.random() * 60,
          tirePressure: 30 + Math.random() * 10,
          mileage: 10000 + Math.floor(Math.random() * 90000),
          nextService: new Date(Date.now() + Math.random() * 30 * 24 * 3600000).toLocaleDateString(),
          // Predictive maintenance data
          oilLife: Math.floor(Math.random() * 100),
          brakeWear: Math.floor(Math.random() * 100),
          transmissionHealth: Math.floor(Math.random() * 100),
          suspensionHealth: Math.floor(Math.random() * 100),
          maintenanceRisk: ['Low', 'Medium', 'High'][Math.floor(Math.random() * 3)],
          predictedFailures: Math.random() > 0.8 ? ['Brake Pads', 'Oil Change'] : Math.random() > 0.9 ? ['Transmission Service'] : [],
          maintenanceCost: Math.floor(Math.random() * 2000) + 500
        },
        alerts: Math.random() > 0.8 ? ['Low Fuel', 'High Temp'] : Math.random() > 0.6 ? ['Predictive Maintenance'] : Math.random() > 0.9 ? ['Geofence Violation'] : [],
        utilization: Array.from({ length: 7 }, () => Math.floor(Math.random() * 10)),
        driverBehavior: {
          score: driverInfo.driverScore || Math.floor(Math.random() * 100),
          harshBraking: driverInfo.harshBraking || Math.floor(Math.random() * 5),
          speeding: driverInfo.speeding || Math.floor(Math.random() * 5),
          idling: driverInfo.idling || Math.floor(Math.random() * 5),
          harshAcceleration: driverInfo.harshAcceleration || Math.floor(Math.random() * 5),
          cornering: driverInfo.cornering || Math.floor(Math.random() * 5),
          // Enhanced scoring metrics from driver data
          safetyRating: driverInfo.safetyScore >= 95 ? 'Excellent' : 
                       driverInfo.safetyScore >= 85 ? 'Good' : 
                       driverInfo.safetyScore >= 70 ? 'Average' : 'Poor',
          fuelEfficiency: driverInfo.fuelEfficiency || Math.floor(Math.random() * 100),
          onTimeDelivery: driverInfo.onTimeDeliveries && driverInfo.totalDeliveries ? 
                         Math.round((driverInfo.onTimeDeliveries / driverInfo.totalDeliveries) * 100) :
                         Math.floor(Math.random() * 100),
          weeklyTrend: Math.random() > 0.5 ? 'improving' : 'declining',
          totalDrivingHours: Math.floor(Math.random() * 40) + 20,
          violations: driverInfo.incidents || Math.floor(Math.random() * 3),
          violationHistory: generateViolationHistory(),
          // Additional synchronized data
          customerRating: driverInfo.customerRating || (Math.random() * 1.5 + 3.5).toFixed(1),
          totalDeliveries: driverInfo.totalDeliveries || Math.floor(Math.random() * 200) + 50,
          experience: driverInfo.experience || `${Math.floor(Math.random() * 5) + 1} years`,
          region: driverInfo.region || ['North District', 'South District', 'East District', 'West District', 'Central District'][i % 5],
          achievements: driverInfo.achievements || []
        },
        route: {
          eta: new Date(Date.now() + Math.random() * 2 * 3600000).toLocaleTimeString(),
          distance: (Math.random() * 50 + 10).toFixed(1),
          trafficDelay: Math.floor(Math.random() * 30),
          // Enhanced route and monitoring data
          currentSpeed: Math.floor(Math.random() * 80) + 20,
          speedLimit: [30, 50, 70, 80][Math.floor(Math.random() * 4)],
          fuelConsumption: (Math.random() * 15 + 5).toFixed(1), // L/100km
          engineHours: Math.floor(Math.random() * 1000) + 500,
          carbonEmissions: (Math.random() * 200 + 50).toFixed(1), // kg CO2
          lastMaintenanceDate: new Date(Date.now() - Math.random() * 90 * 24 * 3600000).toLocaleDateString(),
          nextInspection: new Date(Date.now() + Math.random() * 180 * 24 * 3600000).toLocaleDateString()
        }
      };
    });
        }
        
        console.log('Final vehicles array length:', vehicles.length);
        return vehicles.length > 0;
        
      } catch (error) {
        console.error('Error initializing vehicles data:', error);
        // Ensure we have some fallback data
        if (vehicles.length === 0) {
          vehicles = Array.from({ length: 10 }, (_, i) => ({
            id: `VEH-${String(i + 1).padStart(3, '0')}`,
            driver: `Driver ${i + 1}`,
            status: ['Driving', 'Idling', 'Parked'][i % 3],
            manufacturer: 'Toyota',
            model: 'Hiace',
            plateNumber: `DEMO-${i + 1}`,
            year: 2020,
            lat: 31.9539 + (Math.random() - 0.5) * 0.1,
            lng: 35.9106 + (Math.random() - 0.5) * 0.1,
            health: { 
              fuel: 50 + (i * 5),
              mileage: 10000 + (i * 1000),
              maintenanceRisk: 'Low'
            },
            driverBehavior: { score: 75 + (i * 2) },
            alerts: [],
            group: ['Delivery', 'Service', 'Executive'][i % 3],
            route: {
              eta: new Date(Date.now() + Math.random() * 2 * 3600000).toLocaleTimeString(),
              distance: (Math.random() * 50 + 10).toFixed(1),
              currentSpeed: Math.floor(Math.random() * 80) + 20
            }
          }));
          console.log('âš ï¸ Using emergency fallback data:', vehicles.length, 'vehicles');
        }
        return false;
      }
    }
    
    // Initialize vehicles data immediately
    const dataLoaded = initializeVehiclesData();
    console.log('Vehicles data initialization result:', dataLoaded);

    // Alert data with severity
    const alertData = [];
    vehicles.forEach(v => {
      v.alerts.forEach(a => {
        const severity = a === 'Geofence Violation' || a === 'High Temp' ? 'Critical' :
                         a === 'Low Fuel' ? 'Warning' : 'Info';
        alertData.push({
          vehicleId: v.id,
          group: v.group,
          alert: a,
          severity,
          timestamp: new Date(Date.now() - Math.random() * 3600000).toLocaleTimeString(),
          snoozed: false
        });
      });
    });

    // Pagination and Filters
    let currentPage = 1;
    const vehiclesPerPage = 9;
    let filters = { status: '', group: '' };
    let currentSort = '';
    let geofence = null;
    let alertFilters = { type: '', group: '' };

    // Dashboard customization
    let dashboardConfig = JSON.parse(localStorage.getItem('dashboardConfig')) || [
      'total-vehicles', 'active-vehicles', 'maintenance-vehicles', 'alert-vehicles', 'avg-driver-score'
    ];

    function sortVehicles(vehicles, sortBy) {
      if (!sortBy) return vehicles;
      
      return [...vehicles].sort((a, b) => {
        switch (sortBy) {
          case 'status':
            const statusOrder = { 'Alert': 0, 'Maintenance': 1, 'Driving': 2, 'Idling': 3, 'Parked': 4, 'Offline': 5 };
            return (statusOrder[a.status] || 999) - (statusOrder[b.status] || 999);
          
          case 'driver-score-desc':
            return b.driverBehavior.score - a.driverBehavior.score;
          
          case 'last-update':
            // Convert time strings to comparable format (most recent first)
            const timeA = new Date(`1970/01/01 ${a.lastPing}`).getTime();
            const timeB = new Date(`1970/01/01 ${b.lastPing}`).getTime();
            return timeB - timeA;
          
          case 'fuel-asc':
            return a.health.fuel - b.health.fuel;
          
          case 'maintenance-risk':
            const riskOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
            return (riskOrder[a.health.maintenanceRisk] || 3) - (riskOrder[b.health.maintenanceRisk] || 3);
          
          case 'speed-desc':
            return b.route.currentSpeed - a.route.currentSpeed;
          
          case 'efficiency-desc':
            return b.driverBehavior.fuelEfficiency - a.driverBehavior.fuelEfficiency;
          
          case 'mileage-desc':
            return b.health.mileage - a.health.mileage;
          
          default:
            return 0;
        }
      });
    }

    function renderVehicleList(page = 1, filter = '', filters = {}, skipHeavyRenders = false) {
      // Use the vehicles array directly since this is a demo
      const list = document.getElementById('vehicle-list');
      const loadingIndicator = document.getElementById('loading-indicator');
      
      // Hide loading indicator and clear list
      if (loadingIndicator) loadingIndicator.style.display = 'none';
      list.innerHTML = '';
      
      // Optimized filtering - only filter if there's actually a filter
      let filtered = vehicles;
      if (filter || filters.status || filters.group) {
        const filterLower = filter.toLowerCase();
        filtered = vehicles.filter(v =>
          (!filter || 
           v.id.toLowerCase().includes(filterLower) ||
           v.driver.toLowerCase().includes(filterLower) ||
           v.plateNumber.toLowerCase().includes(filterLower) ||
           v.manufacturer.toLowerCase().includes(filterLower) ||
           v.model.toLowerCase().includes(filterLower)) &&
          (!filters.status || v.status === filters.status) &&
          (!filters.group || v.group === filters.group)
        );
      }

      // Apply sorting
      filtered = sortVehicles(filtered, currentSort);
          const start = (page - 1) * vehiclesPerPage;
          const end = start + vehiclesPerPage;
          const paginated = filtered.slice(start, end);
          
          // Use DocumentFragment for better performance
          const fragment = document.createDocumentFragment();
          
          paginated.forEach(vehicle => {
            const card = document.createElement('div');
            card.className = 'vehicle-card bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex flex-col gap-2 relative';
            card.innerHTML = `
              <div class="flex items-center justify-between">
                <div>
                  <span class="status-dot status-${vehicle.status.toLowerCase()}"></span>
                  <span class="font-bold text-gray-900 dark:text-white">${vehicle.id}</span>
                  <span class="ml-2 text-xs px-2 py-1 rounded bg-blue-100 dark:bg-blue-600 text-blue-800 dark:text-blue-100">${vehicle.group}</span>
                </div>
                <button class="vehicle-action-btn px-2 py-1 rounded text-blue-600 dark:text-blue-400 hover:bg-blue-100" title="View Details" aria-label="View ${vehicle.id} Details"><i class="fas fa-eye"></i></button>
              </div>
              <div class="text-sm text-gray-600 dark:text-gray-400">
                <span class="font-medium text-gray-900 dark:text-white">${vehicle.manufacturer} ${vehicle.model}</span>
                <span class="ml-2 text-xs text-gray-500">(${vehicle.year})</span>
              </div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Plate: <span class="font-mono font-medium">${vehicle.plateNumber}</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Driver: <span class="font-medium">${vehicle.driver}</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Status: <span class="font-medium">${vehicle.status}</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Last Ping: <span class="font-mono">${vehicle.lastPing}</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Driver Score: <span class="font-medium">${vehicle.driverBehavior.score}/100</span> <span class="text-xs ${vehicle.driverBehavior.weeklyTrend === 'improving' ? 'text-green-600' : 'text-red-600'}">(${vehicle.driverBehavior.weeklyTrend})</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Speed: <span class="font-medium ${vehicle.route.currentSpeed > vehicle.route.speedLimit ? 'text-red-600' : 'text-green-600'}">${vehicle.route.currentSpeed} km/h</span> <span class="text-xs text-gray-500">(limit: ${vehicle.route.speedLimit})</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Fuel Efficiency: <span class="font-medium">${vehicle.route.fuelConsumption}L/100km</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">ETA: <span class="font-medium">${vehicle.route.eta}</span></div>
              ${vehicle.health.maintenanceRisk === 'High' ? `<div class="text-xs text-red-600 dark:text-red-400 font-semibold flex items-center"><i class="fas fa-exclamation-triangle mr-1"></i>High Maintenance Risk</div>` : ''}

              <div class="flex flex-wrap gap-2 mt-3 justify-start">
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-blue-600 hover:text-white flex items-center justify-center" title="Send Message" aria-label="Send Message to ${vehicle.driver}"><i class="fas fa-envelope text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-blue-600 hover:text-white flex items-center justify-center" title="Schedule Maintenance" aria-label="Schedule Maintenance for ${vehicle.id}"><i class="fas fa-tools text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-blue-600 hover:text-white flex items-center justify-center" title="Assign Driver" aria-label="Assign Driver to ${vehicle.id}"><i class="fas fa-user-plus text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-purple-600 hover:text-white flex items-center justify-center" title="View Camera" aria-label="View Camera for ${vehicle.id}"><i class="fas fa-video text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-indigo-600 hover:text-white flex items-center justify-center" title="View on Map" aria-label="View ${vehicle.id} on Map"><i class="fas fa-map-marker-alt text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-orange-600 hover:text-white flex items-center justify-center" title="View Logs" aria-label="View Logs for ${vehicle.id}"><i class="fas fa-file-alt text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-teal-600 hover:text-white flex items-center justify-center" title="Set Geofence for Driver" aria-label="Set Geofence for ${vehicle.driver}"><i class="fas fa-draw-polygon text-sm"></i></button>
                <button class="vehicle-action-btn warning-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-red-600 hover:text-white flex items-center justify-center" title="Issue Warning" aria-label="Issue Warning to ${vehicle.driver}" data-vehicle-id="${vehicle.id}"><i class="fas fa-exclamation-triangle text-sm"></i></button>
              </div>
              ${vehicle.alerts.length > 0 ? `<div class="mt-2 text-xs text-red-600 dark:text-red-400 font-semibold">Alerts: ${vehicle.alerts.join(', ')}</div>` : ''}
            `;
            card.querySelector('.fa-eye').parentElement.onclick = () => showVehicleModal(vehicle);
            
            // Add event listeners for the new action buttons
            card.querySelector('.fa-video').parentElement.onclick = () => viewVehicleCamera(vehicle);
            card.querySelector('.fa-map-marker-alt').parentElement.onclick = () => viewVehicleOnMap(vehicle);
            card.querySelector('.fa-file-alt').parentElement.onclick = () => viewVehicleLogs(vehicle);
            card.querySelector('.fa-draw-polygon').parentElement.onclick = () => setGeofenceForDriver(vehicle);
            card.querySelector('.warning-btn').onclick = () => issueWarningToDriver(vehicle);
            
            fragment.appendChild(card);
          });
          
          list.appendChild(fragment);
          
          document.getElementById('page-info').textContent = `Page ${page}`;
          document.getElementById('prev-page').disabled = page === 1;
          document.getElementById('next-page').disabled = end >= filtered.length;
          
          // Update analytics efficiently
          updateAnalytics();
          
          // Only render heavy components when needed
          if (!skipHeavyRenders) {
            renderUtilizationChart();
            renderMap(filtered.slice(0, 30));
            renderAlertFeed();
          } else if (window.vehiclesPageMap) {
            // Update map with current filtered vehicles even during light renders
            syncVehicleDataToMap(filtered.slice(0, 30));
          }
    }
    
    // Separate analytics update function for better performance
    function updateAnalytics() {
      document.getElementById('total-vehicles').textContent = vehicles.length;
      document.getElementById('active-vehicles').textContent = vehicles.filter(v => v.status === 'Driving').length;
      document.getElementById('maintenance-vehicles').textContent = vehicles.filter(v => v.status === 'Maintenance').length;
      document.getElementById('alert-vehicles').textContent = vehicles.filter(v => v.alerts.length > 0).length;
      document.getElementById('avg-driver-score').textContent = (vehicles.reduce((sum, v) => sum + v.driverBehavior.score, 0) / vehicles.length).toFixed(1);
    }

    // Render Alert Feed
    function renderAlertFeed() {
      const list = document.getElementById('alert-list');
      list.innerHTML = '';
      let filteredAlerts = alertData.filter(a =>
        (alertFilters.type === '' || a.alert === alertFilters.type) &&
        (alertFilters.group === '' || a.group === alertFilters.group) &&
        !a.snoozed
      );
      filteredAlerts.forEach((alert, index) => {
        const severityColor = alert.severity === 'Critical' ? 'bg-red-600' :
                             alert.severity === 'Warning' ? 'bg-yellow-500' : 'bg-blue-500';
        const item = document.createElement('div');
        item.className = `alert-item p-3 rounded-lg ${severityColor} text-white flex justify-between items-center`;
        item.innerHTML = `
          <div>
            <span class="font-bold">${alert.vehicleId}</span> - ${alert.alert} (${alert.group})<br>
            <span class="text-xs">${alert.timestamp}</span>
          </div>
          <div class="flex gap-2">
            <button class="snooze-alert text-white hover:text-gray-200" data-index="${index}" title="Snooze Alert" aria-label="Snooze ${alert.alert} for ${alert.vehicleId}">
              <i class="fas fa-clock"></i>
            </button>
            <button class="view-vehicle text-white hover:text-gray-200" data-vehicle-id="${alert.vehicleId}" title="View Vehicle" aria-label="View ${alert.vehicleId} Details">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        `;
        list.appendChild(item);
      });
      // Add event listeners for snooze and view
      document.querySelectorAll('.snooze-alert').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = parseInt(btn.dataset.index);
          alertData[index].snoozed = true;
          showToast(`Alert for ${alertData[index].vehicleId} snoozed.`);
          renderAlertFeed();
        });
      });
      document.querySelectorAll('.view-vehicle').forEach(btn => {
        btn.addEventListener('click', () => {
          const vehicle = vehicles.find(v => v.id === btn.dataset.vehicleId);
          if (vehicle) showVehicleModal(vehicle);
        });
      });
    }

    // Event Listeners
    document.getElementById('vehicle-search').addEventListener('input', function() {
      currentPage = 1;
      renderVehicleList(currentPage, this.value, filters);
    });

    // Event delegation for warning buttons (fallback)
    document.addEventListener('click', function(event) {
      if (event.target.closest('.warning-btn')) {
        const warningBtn = event.target.closest('.warning-btn');
        const vehicleId = warningBtn.getAttribute('data-vehicle-id');
        const vehicle = vehicles.find(v => v.id === vehicleId);
        
        if (vehicle) {
          console.log('Warning button clicked via event delegation for vehicle:', vehicle.id);
          issueWarningToDriver(vehicle);
        } else {
          console.error('Vehicle not found for ID:', vehicleId);
        }
      }
    });
    document.getElementById('sort-vehicles').addEventListener('change', function() {
      currentSort = this.value;
      currentPage = 1;
      renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
    });
    document.getElementById('prev-page').addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
      }
    });
    document.getElementById('next-page').addEventListener('click', function() {
      currentPage++;
      renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
    });
    document.getElementById('filter-btn').addEventListener('click', () => {
      document.getElementById('filter-modal').classList.remove('hidden');
    });
    document.getElementById('apply-filter').addEventListener('click', () => {
      filters.status = document.getElementById('filter-status').value;
      filters.group = document.getElementById('filter-group').value;
      currentPage = 1;
      renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
      document.getElementById('filter-modal').classList.add('hidden');
    });
    document.getElementById('clear-filter').addEventListener('click', () => {
      filters = { status: '', group: '' };
      document.getElementById('filter-status').value = '';
      document.getElementById('filter-group').value = '';
      currentPage = 1;
      renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
      document.getElementById('filter-modal').classList.add('hidden');
    });
    document.getElementById('alert-feed-toggle').addEventListener('click', () => {
      const alertFeed = document.getElementById('alert-feed');
      alertFeed.classList.toggle('alert-feed-hidden');
    });
    document.getElementById('alert-filter-type').addEventListener('change', function() {
      alertFilters.type = this.value;
      renderAlertFeed();
    });
    document.getElementById('alert-filter-group').addEventListener('change', function() {
      alertFilters.group = this.value;
      renderAlertFeed();
    });
    document.getElementById('clear-all-alerts').addEventListener('click', () => {
      alertData.forEach(a => a.snoozed = true);
      showToast('All alerts cleared.');
      renderAlertFeed();
    });
    document.getElementById('sidebar-toggle').addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      const main = document.getElementById('main-content-container');
      sidebar.classList.toggle('sidebar-hidden');
      main.classList.toggle('ml-64');
      main.classList.toggle('ml-0');
    });
    document.getElementById('theme-toggle').addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const icon = document.getElementById('theme-toggle').querySelector('i');
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
    });

    // Vehicle Modal
    function showVehicleModal(vehicle) {
      const modal = document.getElementById('vehicle-modal');
      const content = document.getElementById('vehicle-modal-content');
      content.innerHTML = `
        <div class="space-y-6">
          <!-- Vehicle Header -->
          <div class="flex items-center justify-between">
            <div>
              <h3 id="vehicle-modal-title" class="text-2xl font-bold text-gray-900 dark:text-white">${vehicle.id} <span class="ml-2 text-sm px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-600 text-blue-800 dark:text-blue-100">${vehicle.group}</span></h3>
              <div class="flex items-center mt-2">
                <span class="status-dot status-${vehicle.status.toLowerCase()} mr-2"></span>
                <span class="font-medium text-gray-700 dark:text-gray-300">${vehicle.status}</span>
              </div>
            </div>
          </div>

          <!-- Vehicle Info Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Basic Vehicle Info -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h4 class="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                <i class="fas fa-truck mr-2 text-blue-600"></i>Vehicle Information
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Manufacturer:</span>
                  <span class="font-medium">${vehicle.manufacturer} ${vehicle.model}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Year:</span>
                  <span class="font-medium">${vehicle.year}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Plate Number:</span>
                  <span class="font-mono font-medium">${vehicle.plateNumber}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">VIN:</span>
                  <span class="font-mono text-xs">${vehicle.vin}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Driver:</span>
                  <span class="font-medium">${vehicle.driver}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Mileage:</span>
                  <span class="font-medium">${vehicle.health.mileage.toLocaleString()} km</span>
                </div>
              </div>
            </div>

            <!-- Current Status -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h4 class="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                <i class="fas fa-chart-line mr-2 text-green-600"></i>Current Status
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Last Ping:</span>
                  <span class="font-medium">${vehicle.lastPing}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Current Speed:</span>
                  <span class="font-medium ${vehicle.route.currentSpeed > vehicle.route.speedLimit ? 'text-red-600' : 'text-green-600'}">${vehicle.route.currentSpeed} km/h</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Speed Limit:</span>
                  <span class="font-medium">${vehicle.route.speedLimit} km/h</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Fuel Level:</span>
                  <span class="font-medium">${vehicle.health.fuel}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Battery:</span>
                  <span class="font-medium">${vehicle.health.battery}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Engine Temp:</span>
                  <span class="font-medium">${vehicle.health.engineTemp.toFixed(1)}Â°C</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Driver Performance Section -->
          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800">
            <h4 class="font-semibold text-blue-800 dark:text-blue-300 mb-3 flex items-center">
              <i class="fas fa-user-check mr-2"></i>Driver Performance
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">${vehicle.driverBehavior.score}</div>
                <div class="text-gray-600 dark:text-gray-400">Overall Score</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold ${vehicle.driverBehavior.safetyRating === 'Excellent' ? 'text-green-600' : vehicle.driverBehavior.safetyRating === 'Poor' ? 'text-red-600' : 'text-yellow-600'}">${vehicle.driverBehavior.safetyRating}</div>
                <div class="text-gray-600 dark:text-gray-400">Safety Rating</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-green-600">${vehicle.driverBehavior.fuelEfficiency}%</div>
                <div class="text-gray-600 dark:text-gray-400">Fuel Efficiency</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-blue-600">${vehicle.driverBehavior.onTimeDelivery}%</div>
                <div class="text-gray-600 dark:text-gray-400">On-Time Delivery</div>
              </div>
            </div>
          </div>

          <!-- Predictive Maintenance Section -->
          ${vehicle.health.maintenanceRisk !== 'Low' || vehicle.health.predictedFailures.length > 0 ? `
          <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 border border-orange-200 dark:border-orange-800">
            <h4 class="font-semibold text-orange-800 dark:text-orange-300 mb-3 flex items-center">
              <i class="fas fa-tools mr-2"></i>Predictive Maintenance
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div class="text-center">
                <div class="text-lg font-semibold ${vehicle.health.maintenanceRisk === 'High' ? 'text-red-600' : 'text-yellow-600'}">${vehicle.health.maintenanceRisk}</div>
                <div class="text-gray-600 dark:text-gray-400">Risk Level</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-blue-600">${vehicle.health.oilLife}%</div>
                <div class="text-gray-600 dark:text-gray-400">Oil Life</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-orange-600">${vehicle.health.brakeWear}%</div>
                <div class="text-gray-600 dark:text-gray-400">Brake Wear</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-purple-600">${vehicle.health.transmissionHealth}%</div>
                <div class="text-gray-600 dark:text-gray-400">Transmission</div>
              </div>
            </div>
            ${vehicle.health.predictedFailures.length > 0 ? `
            <div class="mt-3 p-3 bg-red-50 dark:bg-red-900/20 rounded border border-red-200 dark:border-red-800">
              <div class="text-sm">
                <strong class="text-red-800 dark:text-red-300">Predicted Issues:</strong>
                <span class="text-red-600 dark:text-red-400 ml-2">${vehicle.health.predictedFailures.join(', ')}</span>
              </div>
            </div>
            ` : ''}
          </div>
          ` : ''}

          <!-- Charts Section -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
              <h4 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Utilization (Last 7 days)</h4>
              <canvas id="modal-utilization-chart" height="200"></canvas>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
              <h4 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Driver Behavior</h4>
              <canvas id="modal-driver-behavior-chart" height="200"></canvas>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
            <button class="vehicle-action-btn px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors" title="Send Message" aria-label="Send Message to ${vehicle.driver}">
              <i class="fas fa-envelope mr-1"></i>Message
            </button>
            <button class="vehicle-action-btn px-4 py-2 rounded bg-yellow-500 text-white hover:bg-yellow-600 transition-colors" title="Schedule Maintenance" aria-label="Schedule Maintenance for ${vehicle.id}">
              <i class="fas fa-tools mr-1"></i>Maintenance
            </button>
            <button class="vehicle-action-btn px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition-colors" title="Assign Driver" aria-label="Assign Driver to ${vehicle.id}">
              <i class="fas fa-user-plus mr-1"></i>Assign
            </button>
            <button class="vehicle-action-btn px-4 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 transition-colors" title="View Camera" aria-label="View Camera for ${vehicle.id}">
              <i class="fas fa-video mr-1"></i>Camera
            </button>
            <button class="vehicle-action-btn px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 transition-colors" title="View on Map" aria-label="View ${vehicle.id} on Map">
              <i class="fas fa-map-marker-alt mr-1"></i>Map
            </button>
            <button class="vehicle-action-btn px-4 py-2 rounded bg-orange-600 text-white hover:bg-orange-700 transition-colors" title="View Logs" aria-label="View Logs for ${vehicle.id}">
              <i class="fas fa-file-alt mr-1"></i>Logs
            </button>
          </div>
        </div>
      `;
      modal.classList.remove('hidden');
      setTimeout(() => {
        new Chart(document.getElementById('modal-utilization-chart').getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
            datasets: [{
              label: 'Hours Used',
              data: vehicle.utilization,
              backgroundColor: '#2563eb'
            }]
          },
          options: { plugins: { legend: { display: false } } }
        });
        new Chart(document.getElementById('modal-driver-behavior-chart').getContext('2d'), {
          type: 'radar',
          data: {
            labels: ['Harsh Braking', 'Speeding', 'Idling', 'Harsh Acceleration', 'Cornering'],
            datasets: [{
              label: 'Driver Behavior',
              data: [
                vehicle.driverBehavior.harshBraking,
                vehicle.driverBehavior.speeding,
                vehicle.driverBehavior.idling,
                vehicle.driverBehavior.harshAcceleration,
                vehicle.driverBehavior.cornering
              ],
              backgroundColor: 'rgba(37,99,235,0.2)',
              borderColor: '#2563eb'
            }]
          },
          options: { plugins: { legend: { display: false } } }
        });

        // Add event listeners for modal action buttons
        setTimeout(() => {
          const modalCameraBtn = modal.querySelector('.fa-video').parentElement;
          const modalMapBtn = modal.querySelector('.fa-map-marker-alt').parentElement;
          const modalLogsBtn = modal.querySelector('.fa-file-alt').parentElement;
          
          if (modalCameraBtn) modalCameraBtn.onclick = () => viewVehicleCamera(vehicle);
          if (modalMapBtn) modalMapBtn.onclick = () => viewVehicleOnMap(vehicle);
          if (modalLogsBtn) modalLogsBtn.onclick = () => viewVehicleLogs(vehicle);
        }, 50);
      }, 100);
    }
    document.getElementById('close-modal').onclick = () => {
      document.getElementById('vehicle-modal').classList.add('hidden');
    };

    // Vehicle Action Functions
    function viewVehicleCamera(vehicle) {
      showToast(`Opening camera view for ${vehicle.id}`, 'info');
      // TODO: Implement camera view modal or redirect to camera system
      // This could open a modal with live camera feed or redirect to a dedicated camera page
    }

    function viewVehicleOnMap(vehicle) {
      showToast(`Centering map on ${vehicle.id}`, 'info');
      // TODO: Implement map centering functionality
      // This should center the map on the vehicle's current location
      if (window.map && window.vehicles) {
        const vehicleMarker = window.vehicles.find(v => v.id === vehicle.id);
        if (vehicleMarker && vehicleMarker.lat && vehicleMarker.lng) {
          window.map.setView([vehicleMarker.lat, vehicleMarker.lng], 15);
        }
      }
    }

    function viewVehicleLogs(vehicle) {
      showToast(`Opening logs for ${vehicle.id}`, 'info');
      // TODO: Implement logs view modal
      // This could open a modal with vehicle logs, maintenance history, alerts, etc.
    }

    function setGeofenceForDriver(vehicle) {
      console.log('Setting geofence for driver:', vehicle.driver, 'vehicle:', vehicle.id);
      
      if (!isMapReady()) {
        showToast('Please wait for the map to load before setting geofences', 'warning');
        return;
      }
      
      // Show driver-specific geofence modal
      showDriverGeofenceModal(vehicle);
    }
    window.onclick = function(event) {
      const vehicleModal = document.getElementById('vehicle-modal');
      const filterModal = document.getElementById('filter-modal');
      const geofenceModal = document.getElementById('geofence-modal');
      const createGroupModal = document.getElementById('create-group-modal');
      
      if (event.target === vehicleModal) vehicleModal.classList.add('hidden');
      if (event.target === filterModal) filterModal.classList.add('hidden');
      if (event.target === geofenceModal) {
        geofenceModal.classList.add('hidden');
        // Clear temporary elements when clicking outside
        if (tempGeofenceCircle) {
          map.removeLayer(tempGeofenceCircle);
          tempGeofenceCircle = null;
        }
      }
      if (event.target === createGroupModal) createGroupModal.classList.add('hidden');
    };

    // Utilization Chart (Fleet)
    let utilizationChart;
    function renderUtilizationChart() {
      const ctx = document.getElementById('utilization-chart').getContext('2d');
      const data = Array(7).fill(0);
      vehicles.forEach(v => v.utilization.forEach((u, i) => data[i] += u));
      if (utilizationChart) utilizationChart.destroy();
      utilizationChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
          datasets: [{
            label: 'Total Hours Used',
            data,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37,99,235,0.1)',
            fill: true
          }]
        },
        options: { plugins: { legend: { display: false } } }
      });
    }

    // Map with Geofence (Enhanced)
    let map, markers = [], polylines = [], geofenceCircle = null, tempGeofenceCircle = null;
    let lastRenderedVehicles = new Set();
    let isGeofenceMode = false;
    let geofenceMarker = null;
    let mapReady = false;
    
    // Enhanced geofence variables for polygon support
    let geofencePolygon = null;
    let tempGeofencePolygon = null;
    let geofencePoints = [];
    let isDrawingPolygon = false;
    let geofenceType = 'circle'; // 'circle' or 'polygon'
    
    // Helper function to check if map is ready
    function isMapReady() {
      return (map && mapReady) || window.vehiclesPageMap;
    }

    // Initialize fleet map widget for vehicles page
    async function initializeVehiclesPageMap(vehiclesToShow) {
      try {
        console.log('Initializing vehicles page map widget...');
        
        // Create map widget instance
        if (typeof FleetMapWidget !== 'undefined') {
          window.vehiclesPageMap = new FleetMapWidget('map', {
            defaultCenter: [31.9539, 35.9106], // Jordan coordinates
            defaultZoom: 11,
            mapHeight: '450px' // Match the container height exactly
          });

          // Initialize the map
          const success = await window.vehiclesPageMap.init();
          
          if (success) {
            console.log('Vehicles page map widget initialized successfully');
            
            // Force immediate data synchronization with unified fleet data
            if (typeof window.UnifiedFleetData !== 'undefined') {
              const unifiedVehicles = window.UnifiedFleetData.getVehiclesForDashboard(); // ALL 200 vehicles
              window.vehiclesPageMap.vehicleData = unifiedVehicles;
              window.vehiclesPageMap.updateVehicles();
              console.log('Forced sync with unified fleet data on vehicles page map initialization - FULL DATASET:', unifiedVehicles.length, 'vehicles');
            } else {
              // Fallback sync
              syncVehicleDataToMap(vehiclesToShow);
            }
            
            // Force update statistics after data sync
            setTimeout(() => {
              if (window.vehiclesPageMap) {
                window.vehiclesPageMap.updateStatistics();
                console.log('Updated vehicles page map statistics');
              }
            }, 100);
            
            // Update map when vehicles data changes
            mapReady = true;
            window.map = window.vehiclesPageMap.map; // For compatibility with existing code
            
            // Expose globally for other functions
            window.vehiclesFleetMap = window.vehiclesPageMap;
            
            return;
          }
        }
        
        throw new Error('FleetMapWidget not available');
        
      } catch (error) {
        console.error('Failed to initialize vehicles page map widget:', error);
        throw error;
      }
    }

    // Sync vehicle data from vehicles page to map widget
    function syncVehicleDataToMap(vehiclesToShow) {
      if (!window.vehiclesPageMap) return;
      
      try {
        // Use unified fleet data for perfect synchronization
        if (typeof window.UnifiedFleetData !== 'undefined') {
          // Get ALL vehicles that the main dashboard uses (same 200 vehicles)
          const unifiedVehicles = window.UnifiedFleetData.getVehiclesForDashboard();
          window.vehiclesPageMap.vehicleData = unifiedVehicles;
          window.vehiclesPageMap.updateVehicles();
          
          // Force update statistics with proper delay
          setTimeout(() => {
            window.vehiclesPageMap.updateStatistics();
          }, 50);
          
          console.log(`Synced ${unifiedVehicles.length} vehicles from unified fleet data to vehicles page map (FULL DATASET)`);
          return;
        }
        
        // Fallback: If main dashboard map widget exists, use its data directly for consistency
        if (window.fleetMap && window.fleetMap.vehicleData && window.fleetMap.vehicleData.length > 0) {
          // Use ALL the same vehicle data as main dashboard (all 200 vehicles)
          const dashboardVehicles = window.fleetMap.vehicleData;
          window.vehiclesPageMap.vehicleData = dashboardVehicles;
          window.vehiclesPageMap.updateVehicles();
          
          // Force update statistics with proper delay
          setTimeout(() => {
            window.vehiclesPageMap.updateStatistics();
          }, 50);
          
          console.log(`Synced ${dashboardVehicles.length} vehicles from main dashboard to vehicles page map (FULL DATASET)`);
          return;
        }

        // Fallback: convert vehicles page data to map widget format
        if (!vehiclesToShow) return;
        
        const mapVehicles = vehiclesToShow.map((vehicle, index) => ({
          id: vehicle.id.replace('VEH-', 'FL-'), // Convert to fleet ID format
          vehicleId: vehicle.id,
          name: `${vehicle.manufacturer} ${vehicle.model}`,
          driver: vehicle.driver,
          driverId: vehicle.driverId,
          status: mapVehicleStatus(vehicle.status),
          location: [vehicle.lat, vehicle.lng],
          speed: vehicle.route ? vehicle.route.currentSpeed : Math.floor(Math.random() * 60) + 20,
          heading: Math.floor(Math.random() * 360),
          fuel: vehicle.health.fuel,
          lastUpdate: new Date(),
          route: vehicle.route ? vehicle.route.distance + ' km remaining' : 'Available',
          locked: false,
          manufacturer: vehicle.manufacturer,
          model: vehicle.model,
          plateNumber: vehicle.plateNumber,
          year: vehicle.year,
          mileage: vehicle.health.mileage,
          maintenanceRisk: vehicle.health.maintenanceRisk
        }));

        // Update map widget with vehicles data
        window.vehiclesPageMap.vehicleData = mapVehicles;
        window.vehiclesPageMap.updateVehicles();
        
        // Force update statistics with proper delay
        setTimeout(() => {
          window.vehiclesPageMap.updateStatistics();
        }, 50);
        
        console.log(`Synced ${mapVehicles.length} vehicles to map widget`);
        
      } catch (error) {
        console.error('Error syncing vehicle data to map:', error);
      }
    }

    // Map vehicle status from vehicles page to map widget format
    function mapVehicleStatus(status) {
      const statusMap = {
        'Driving': 'active',
        'Idling': 'idle', 
        'Parked': 'idle',
        'Maintenance': 'offline',
        'Offline': 'offline',
        'Alert': 'offline'
      };
      return statusMap[status] || 'idle';
    }

    // Global function to sync vehicles data with main dashboard
    window.syncVehiclesPageWithDashboard = function() {
      if (window.vehiclesPageMap) {
        try {
          // Use unified fleet data system for perfect synchronization
          if (typeof window.UnifiedFleetData !== 'undefined') {
            // Get the latest data from unified system (ALL 200 vehicles)
            const unifiedVehicles = window.UnifiedFleetData.getVehiclesForDashboard();
            
            // Update vehicles page map widget
            window.vehiclesPageMap.vehicleData = unifiedVehicles;
            window.vehiclesPageMap.updateVehicles();
            
            // Force update statistics
            setTimeout(() => {
              window.vehiclesPageMap.updateStatistics();
            }, 50);
            
            console.log(`Synced ${unifiedVehicles.length} vehicles from unified fleet data to vehicles page (FULL DATASET)`);
            return;
          }
          
          // Fallback: sync with main dashboard map widget
          if (window.fleetMap && window.fleetMap.vehicleData) {
            // Get vehicle data from main dashboard map widget
            const dashboardVehicles = window.fleetMap.vehicleData;
            
            // Update vehicles page map with dashboard data
            if (dashboardVehicles && dashboardVehicles.length > 0) {
              const syncedVehicles = dashboardVehicles; // Take ALL vehicles
              
              // Update vehicles page map widget
              window.vehiclesPageMap.vehicleData = syncedVehicles;
              window.vehiclesPageMap.updateVehicles();
              
              // Force update statistics
              setTimeout(() => {
                window.vehiclesPageMap.updateStatistics();
              }, 50);
              
              console.log(`Synced ${syncedVehicles.length} vehicles from dashboard to vehicles page (FULL DATASET)`);
            }
          }
        } catch (error) {
          console.error('Error syncing vehicles data:', error);
        }
      }
    };

    // Auto-sync with unified data system every 30 seconds
    setInterval(() => {
      if (window.vehiclesPageMap && (window.UnifiedFleetData || window.fleetMap)) {
        window.syncVehiclesPageWithDashboard();
        
        // Verify data synchronization
        if (window.fleetMap && window.vehiclesPageMap && window.UnifiedFleetData) {
          const dashboardData = window.fleetMap.vehicleData;
          const vehiclesPageData = window.vehiclesPageMap.vehicleData;
          
          console.log('=== MAP WIDGET SYNCHRONIZATION VERIFICATION ===');
          console.log('Dashboard map vehicles:', dashboardData.length);
          console.log('Vehicles page map vehicles:', vehiclesPageData.length);
          
          if (dashboardData.length > 0 && vehiclesPageData.length > 0) {
            // Calculate statistics for both
            const dashboardStats = dashboardData.reduce((acc, v) => { acc[v.status] = (acc[v.status] || 0) + 1; return acc; }, {});
            const vehiclesPageStats = vehiclesPageData.reduce((acc, v) => { acc[v.status] = (acc[v.status] || 0) + 1; return acc; }, {});
            
            console.log('Dashboard statistics:', dashboardStats);
            console.log('Vehicles page statistics:', vehiclesPageStats);
            
            const statsMatch = JSON.stringify(dashboardStats) === JSON.stringify(vehiclesPageStats);
            console.log('Statistics match:', statsMatch ? 'âœ… YES' : 'âŒ NO');
            
            if (!statsMatch) {
              console.warn('Statistics mismatch detected! Check data synchronization.');
            }
          }
          console.log('=== END VERIFICATION ===');
        }
      }
    }, 30000);
    
    function renderMap(vehiclesToShow) {
      if (!window.vehiclesPageMap && !map) {
        try {
          // Initialize the fleet map widget for vehicles page
          initializeVehiclesPageMap(vehiclesToShow);
          return;
        } catch (error) {
          console.error('Failed to initialize fleet map widget, falling back to basic map:', error);
          // Fallback to basic Leaflet map
          map = L.map('map').setView([31.9539, 35.9106], 11); // Jordan coordinates
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
          }).addTo(map);
        }
      } else if (window.vehiclesPageMap) {
        // Map widget exists, just update the vehicle data
        syncVehicleDataToMap(vehiclesToShow);
        return;
      }
      
      // Fallback map setup (for basic Leaflet map)
      if (map) {
        // Add map click handler for geofence placement
        map.on('click', function(e) {
          console.log('Map clicked:', e.latlng, 'Geofence mode:', isGeofenceMode, 'Type:', geofenceType);
          if (isGeofenceMode) {
            console.log('Processing geofence click for type:', geofenceType);
            if (geofenceType === 'circle') {
              setGeofenceFromMap(e.latlng.lat, e.latlng.lng);
            } else if (geofenceType === 'polygon') {
              addPolygonPoint(e.latlng.lat, e.latlng.lng);
            }
          } else {
            console.log('Map clicked but not in geofence mode');
          }
        });
        
        // Add double-click handler to finish polygon drawing
        map.on('dblclick', function(e) {
          if (isGeofenceMode && geofenceType === 'polygon' && geofencePoints.length >= 3) {
            finishPolygonDrawing();
          }
        });
        
        // Add map ready event
        map.whenReady(() => {
          console.log('Map is ready');
          mapReady = true;
          showToast('Map loaded successfully', 'success');
        });
      }
      
      // Create a set of current vehicle IDs for comparison
      const currentVehicleIds = new Set(vehiclesToShow.map(v => v.id));
      
      // Remove markers for vehicles no longer in the list
      markers = markers.filter(marker => {
        const vehicleId = marker.vehicleId;
        if (!currentVehicleIds.has(vehicleId)) {
          map.removeLayer(marker);
          return false;
        }
        return true;
      });
      
      // Remove polylines for vehicles no longer driving
      polylines.forEach(p => map.removeLayer(p));
      polylines = [];
      
      vehiclesToShow.forEach(vehicle => {
        // Check if marker already exists for this vehicle
        let existingMarker = markers.find(m => m.vehicleId === vehicle.id);
        
        // Color coding for vehicle status
        let markerColor = '#2563eb'; // default blue
        switch(vehicle.status) {
          case 'Driving': markerColor = '#16a34a'; break; // green
          case 'Alert': markerColor = '#dc2626'; break; // red
          case 'Maintenance': markerColor = '#f59e0b'; break; // yellow
          case 'Offline': markerColor = '#6b7280'; break; // gray
        }
        
        if (existingMarker) {
          // Update existing marker position and popup
          existingMarker.setLatLng([vehicle.lat, vehicle.lng]);
          existingMarker.setPopupContent(`
            <div class="p-2">
              <div class="font-bold text-lg">${vehicle.id}</div>
              <div class="text-sm text-gray-600">Driver: ${vehicle.driver}</div>
              <div class="text-sm">Status: <span class="font-medium" style="color: ${markerColor}">${vehicle.status}</span></div>
              <div class="text-sm">Fuel: ${vehicle.health.fuel}%</div>
              <div class="text-sm">ETA: ${vehicle.route.eta}</div>
              ${vehicle.alerts.length > 0 ? `<div class="text-xs text-red-600 mt-1">âš ï¸ ${vehicle.alerts.join(', ')}</div>` : ''}
            </div>
          `);
        } else {
          // Create custom icon with color
          const customIcon = L.divIcon({
            className: 'custom-vehicle-marker',
            html: `<div style="background-color: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          });
          
          const marker = L.marker([vehicle.lat, vehicle.lng], { icon: customIcon })
            .bindPopup(`
              <div class="p-2">
                <div class="font-bold text-lg">${vehicle.id}</div>
                <div class="text-sm text-gray-600">Driver: ${vehicle.driver}</div>
                <div class="text-sm">Status: <span class="font-medium" style="color: ${markerColor}">${vehicle.status}</span></div>
                <div class="text-sm">Fuel: ${vehicle.health.fuel}%</div>
                <div class="text-sm">ETA: ${vehicle.route.eta}</div>
                ${vehicle.alerts.length > 0 ? `<div class="text-xs text-red-600 mt-1">âš ï¸ ${vehicle.alerts.join(', ')}</div>` : ''}
              </div>
            `);
          marker.vehicleId = vehicle.id;
          marker.addTo(map);
          markers.push(marker);
        }
        
        if (vehicle.status === 'Driving') {
          const route = [
            [vehicle.lat, vehicle.lng],
            [vehicle.lat + (Math.random() - 0.5) * 0.02, vehicle.lng + (Math.random() - 0.5) * 0.02]
          ];
          const polyline = L.polyline(route, { 
            color: vehicle.route.trafficDelay > 15 ? '#DC2626' : '#2563eb',
            weight: 3,
            opacity: 0.7
          }).addTo(map);
          polylines.push(polyline);
        }
        
        // Enhanced geofence violation detection
        if (geofence && vehicle.status === 'Driving') {
          try {
            let isInside = false;
            const wasInside = vehicle.wasInsideGeofence || false;
            
            if (geofence.type === 'circle') {
              const distance = map.distance([vehicle.lat, vehicle.lng], [geofence.lat, geofence.lng]) / 1000;
              isInside = distance <= geofence.radius;
            } else if (geofence.type === 'polygon') {
              // Polygon geofence check using ray casting algorithm
              const points = geofence.points;
              const lat = vehicle.lat;
              const lng = vehicle.lng;
              
              for (let i = 0, j = points.length - 1; i < points.length; j = i++) {
                const xi = points[i][0], yi = points[i][1];
                const xj = points[j][0], yj = points[j][1];
                
                if (((yi > lng) !== (yj > lng)) && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi)) {
                  isInside = !isInside;
                }
              }
            }
            
            // Check for entry/exit events
            if (!wasInside && isInside && geofence.entryAlert) {
              // Vehicle entered geofence
              if (!vehicle.alerts.includes('Entered Geofence')) {
                vehicle.alerts.push('Entered Geofence');
                addAlert(vehicle.id, vehicle.group, 'Entered Geofence', 'Info');
              }
            } else if (wasInside && !isInside && geofence.exitAlert) {
              // Vehicle exited geofence
              if (!vehicle.alerts.includes('Exited Geofence')) {
                vehicle.alerts.push('Exited Geofence');
                addAlert(vehicle.id, vehicle.group, 'Exited Geofence', 'Warning');
              }
            }
            
            vehicle.wasInsideGeofence = isInside;
            
          } catch (error) {
            console.warn('Error calculating geofence distance:', error);
          }
        }
      });
      
      // Update geofence circle
      updateGeofenceDisplay();
      
      lastRenderedVehicles = currentVehicleIds;
    }
    
    function setGeofenceFromMap(lat, lng) {
      // Update form values
      document.getElementById('geofence-lat').value = lat.toFixed(6);
      document.getElementById('geofence-lng').value = lng.toFixed(6);
      
      // Place or update geofence marker
      if (geofenceMarker) {
        map.removeLayer(geofenceMarker);
      }
      
      geofenceMarker = L.marker([lat, lng], {
        icon: L.divIcon({
          className: 'geofence-center-marker',
          html: '<div style="background-color: #8b5cf6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(139,92,246,0.5);"></div>',
          iconSize: [22, 22],
          iconAnchor: [11, 11]
        })
      }).bindPopup(`
        <div class="p-2">
          <div class="font-bold text-sm">Geofence Center</div>
          <div class="text-xs">Lat: ${lat.toFixed(6)}</div>
          <div class="text-xs">Lng: ${lng.toFixed(6)}</div>
        </div>
      `).addTo(map);
      
      // Update preview circle with current radius
      const radius = parseFloat(document.getElementById('geofence-radius').value) || 5;
      updateGeofencePreview(lat, lng, radius);
      
      // Exit geofence drawing mode
      isGeofenceMode = false;
      const btn = document.getElementById('geofence-btn');
      btn.innerHTML = '<i class="fas fa-draw-polygon mr-2"></i>Draw Geofence';
      btn.className = 'px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center text-sm';
      document.getElementById('geofence-status').classList.add('hidden');
      map.getContainer().style.cursor = '';
      
      // Auto-open settings modal for configuration
      document.getElementById('geofence-modal').classList.remove('hidden');
      
      showToast('Geofence center set! Configure settings and click Apply.', 'success');
    }
    
    // Polygon drawing functions
    function addPolygonPoint(lat, lng) {
      geofencePoints.push([lat, lng]);
      
      // Add point marker
      const pointMarker = L.marker([lat, lng], {
        icon: L.divIcon({
          className: 'polygon-point-marker',
          html: `<div style="background-color: #8b5cf6; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(139,92,246,0.5);"><span style="color: white; font-size: 8px; font-weight: bold; position: absolute; top: -2px; left: 2px;">${geofencePoints.length}</span></div>`,
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        })
      }).bindPopup(`
        <div class="p-1">
          <div class="font-bold text-xs">Point ${geofencePoints.length}</div>
          <div class="text-xs">Lat: ${lat.toFixed(6)}</div>
          <div class="text-xs">Lng: ${lng.toFixed(6)}</div>
        </div>
      `).addTo(map);
      
      // Store marker reference for cleanup
      if (!window.polygonMarkers) window.polygonMarkers = [];
      window.polygonMarkers.push(pointMarker);
      
      // Update preview polygon
      updatePolygonPreview();
      
      // Update status
      const statusDiv = document.getElementById('geofence-status');
      if (geofencePoints.length < 3) {
        statusDiv.innerHTML = `<i class="fas fa-mouse-pointer mr-2"></i>Point ${geofencePoints.length} added. Need ${3 - geofencePoints.length} more points minimum. Double-click to finish.`;
      } else {
        statusDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${geofencePoints.length} points added. Double-click to finish drawing.`;
      }
      
      showToast(`Point ${geofencePoints.length} added. ${geofencePoints.length < 3 ? `Need ${3 - geofencePoints.length} more.` : 'Double-click to finish.'}`, 'info');
    }
    
    function updatePolygonPreview() {
      if (geofencePoints.length < 2) return;
      
      // Remove existing preview
      if (tempGeofencePolygon) {
        map.removeLayer(tempGeofencePolygon);
        tempGeofencePolygon = null;
      }
      
      // Create preview polygon (line for 2 points, polygon for 3+)
      if (geofencePoints.length === 2) {
        tempGeofencePolygon = L.polyline(geofencePoints, {
          color: '#8b5cf6',
          weight: 3,
          dashArray: '5, 5',
          opacity: 0.8
        }).addTo(map);
      } else {
        tempGeofencePolygon = L.polygon(geofencePoints, {
          color: '#8b5cf6',
          fillColor: '#8b5cf6',
          fillOpacity: 0.2,
          weight: 3,
          dashArray: '5, 5'
        }).addTo(map);
        
        // Calculate and display area
        const area = calculatePolygonArea(geofencePoints);
        tempGeofencePolygon.bindPopup(`
          <div class="p-2">
            <div class="font-bold text-sm">Polygon Preview</div>
            <div class="text-xs">${geofencePoints.length} points</div>
            <div class="text-xs">Area: ${area.toFixed(2)} kmÂ²</div>
          </div>
        `);
      }
    }
    
    function calculatePolygonArea(points) {
      if (points.length < 3) return 0;
      
      // Calculate area using the shoelace formula
      let area = 0;
      const n = points.length;
      
      for (let i = 0; i < n; i++) {
        const j = (i + 1) % n;
        area += points[i][0] * points[j][1];
        area -= points[j][0] * points[i][1];
      }
      
      area = Math.abs(area) / 2;
      
      // Convert from square degrees to square kilometers (rough approximation)
      // 1 degree latitude â‰ˆ 111 km, 1 degree longitude â‰ˆ 111 * cos(latitude) km
      const avgLat = points.reduce((sum, p) => sum + p[0], 0) / points.length;
      const latToKm = 111;
      const lngToKm = 111 * Math.cos(avgLat * Math.PI / 180);
      
      return area * latToKm * lngToKm;
    }
    
    function finishPolygonDrawing() {
      if (geofencePoints.length < 3) {
        showToast('Need at least 3 points to create a polygon', 'error');
        return;
      }
      
      // Clear preview
      if (tempGeofencePolygon) {
        map.removeLayer(tempGeofencePolygon);
        tempGeofencePolygon = null;
      }
      
      // Exit drawing mode
      isGeofenceMode = false;
      const btn = document.getElementById('geofence-btn');
      btn.innerHTML = '<i class="fas fa-draw-polygon mr-2"></i>Draw Geofence';
      btn.className = 'px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center text-sm';
      document.getElementById('geofence-status').classList.add('hidden');
      map.getContainer().style.cursor = '';
      
      // Calculate polygon center for form
      const centerLat = geofencePoints.reduce((sum, p) => sum + p[0], 0) / geofencePoints.length;
      const centerLng = geofencePoints.reduce((sum, p) => sum + p[1], 0) / geofencePoints.length;
      
      // Update form with polygon data
      document.getElementById('geofence-lat').value = centerLat.toFixed(6);
      document.getElementById('geofence-lng').value = centerLng.toFixed(6);
      
      // Hide radius controls for polygon
      const radiusControls = document.querySelectorAll('[id*="radius"], [for*="radius"]');
      radiusControls.forEach(el => {
        if (el.closest('.mb-4')) el.closest('.mb-4').style.display = 'none';
      });
      
      // Show polygon info
      const area = calculatePolygonArea(geofencePoints);
      const areaElement = document.getElementById('geofence-area');
      if (areaElement) {
        areaElement.textContent = area.toFixed(2);
        areaElement.parentElement.innerHTML = `Area: <span id="geofence-area">${area.toFixed(2)}</span> kmÂ² (${geofencePoints.length} points)`;
      }
      
      // Auto-open settings modal
      document.getElementById('geofence-modal').classList.remove('hidden');
      
      showToast(`Polygon with ${geofencePoints.length} points created! Configure settings and apply.`, 'success');
    }
    
    function clearPolygonPoints() {
      geofencePoints = [];
      
      // Clear polygon markers
      if (window.polygonMarkers) {
        window.polygonMarkers.forEach(marker => map.removeLayer(marker));
        window.polygonMarkers = [];
      }
      
      // Clear preview
      if (tempGeofencePolygon) {
        map.removeLayer(tempGeofencePolygon);
        tempGeofencePolygon = null;
      }
    }
    
    function updateGeofencePreview(lat, lng, radius) {
      if (!map) return;
      
      // Validate inputs
      if (isNaN(lat) || isNaN(lng) || isNaN(radius) || radius <= 0) {
        console.warn('Invalid geofence parameters:', { lat, lng, radius });
        return;
      }
      
      // Remove existing preview circle
      if (tempGeofenceCircle) {
        map.removeLayer(tempGeofenceCircle);
        tempGeofenceCircle = null;
      }
      
      // Create new preview circle
      try {
        tempGeofenceCircle = L.circle([lat, lng], {
          radius: radius * 1000, // Convert km to meters
          color: '#8b5cf6',
          fillColor: '#8b5cf6',
          fillOpacity: 0.2,
          weight: 2,
          dashArray: '5, 5'
        }).addTo(map);
        
        // Update area calculation
        const area = Math.PI * radius * radius;
        const areaElement = document.getElementById('geofence-area');
        if (areaElement) {
          areaElement.textContent = area.toFixed(2);
        }
        
        // Add popup to preview circle
        tempGeofenceCircle.bindPopup(`
          <div class="p-2">
            <div class="font-bold text-sm">Geofence Preview</div>
            <div class="text-xs">Radius: ${radius} km</div>
            <div class="text-xs">Area: ${area.toFixed(2)} kmÂ²</div>
          </div>
        `);
        
      } catch (error) {
        console.error('Error creating geofence preview:', error);
        showToast('Error creating geofence preview', 'error');
      }
    }
    
    function updateGeofenceDisplay() {
      if (geofence) {
        // Clear existing geofence displays
        if (geofenceCircle) {
          map.removeLayer(geofenceCircle);
          geofenceCircle = null;
        }
        if (geofencePolygon) {
          map.removeLayer(geofencePolygon);
          geofencePolygon = null;
        }
        if (geofenceMarker) {
          map.removeLayer(geofenceMarker);
          geofenceMarker = null;
        }
        
        if (geofence.type === 'polygon' && geofence.points) {
          // Create polygon geofence
          geofencePolygon = L.polygon(geofence.points, {
            color: '#dc2626',
            fillColor: '#dc2626',
            fillOpacity: 0.15,
            weight: 3
          }).addTo(map);
          
          // Add center marker for polygon
          geofenceMarker = L.marker([geofence.lat, geofence.lng], {
            icon: L.divIcon({
              className: 'geofence-center-marker',
              html: '<div style="background-color: #dc2626; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(220,38,38,0.5);"></div>',
              iconSize: [22, 22],
              iconAnchor: [11, 11]
            })
          }).bindPopup(`
            <div class="p-2">
              <div class="font-bold">Geofence: ${geofence.name || 'Unnamed'}</div>
              <div class="text-sm">Type: Polygon (${geofence.points.length} points)</div>
              <div class="text-sm">Area: ${geofence.area ? geofence.area.toFixed(2) : 'N/A'} kmÂ²</div>
            </div>
          `).addTo(map);
          
        } else {
          // Create circle geofence (default)
          geofenceCircle = L.circle([geofence.lat, geofence.lng], {
            radius: geofence.radius * 1000,
            color: '#dc2626',
            fillColor: '#dc2626',
            fillOpacity: 0.15,
            weight: 3
          }).addTo(map);
          
          // Add geofence center marker
          geofenceMarker = L.marker([geofence.lat, geofence.lng], {
            icon: L.divIcon({
              className: 'geofence-center-marker',
              html: '<div style="background-color: #dc2626; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(220,38,38,0.5);"></div>',
              iconSize: [22, 22],
              iconAnchor: [11, 11]
            })
          }).bindPopup(`
            <div class="p-2">
              <div class="font-bold">Geofence: ${geofence.name || 'Unnamed'}</div>
              <div class="text-sm">Radius: ${geofence.radius} km</div>
              <div class="text-sm">Area: ${(Math.PI * geofence.radius * geofence.radius).toFixed(2)} kmÂ²</div>
            </div>
          `).addTo(map);
        }
        
        // Show clear button
        document.getElementById('clear-geofence-btn').classList.remove('hidden');
      } else {
        // Hide clear button
        document.getElementById('clear-geofence-btn').classList.add('hidden');
      }
    }
    
    function addAlert(vehicleId, group, alertType, severity) {
      alertData.push({
        vehicleId,
        group,
        alert: alertType,
        severity,
        timestamp: new Date().toLocaleTimeString(),
        snoozed: false
      });
      renderAlertFeed();
    }

    // Enhanced Toast Notifications with Priority System
    function showToast(message, type = 'info', priority = 'normal') {
      const toast = document.createElement('div');
      
      let bgColor, icon;
      switch(type) {
        case 'success':
          bgColor = 'bg-green-600';
          icon = 'fa-check-circle';
          break;
        case 'error':
          bgColor = 'bg-red-600';
          icon = 'fa-exclamation-circle';
          break;
        case 'warning':
          bgColor = 'bg-yellow-600';
          icon = 'fa-exclamation-triangle';
          break;
        case 'critical':
          bgColor = 'bg-red-800';
          icon = 'fa-exclamation-triangle';
          break;
        default:
          bgColor = 'bg-blue-600';
          icon = 'fa-info-circle';
      }
      
      const priorityClass = priority === 'high' ? 'z-60 animate-pulse' : 'z-50';
      const duration = priority === 'high' ? 10000 : 5000;
      
      toast.className = `alert-toast ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg fixed top-20 right-4 ${priorityClass} flex items-center gap-2 max-w-sm`;
      toast.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
        <button class="ml-2 text-white hover:text-gray-200" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      document.body.appendChild(toast);
      
      // Auto remove
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => {
            toast.remove();
          }, 300);
        }
      }, duration);
    }

    // Real-time Alert System
    function checkCriticalAlerts() {
      vehicles.forEach(vehicle => {
        // Speed limit violations
        if (vehicle.route.currentSpeed > vehicle.route.speedLimit && vehicle.status === 'Driving') {
          if (!vehicle.alerts.includes('Speed Violation')) {
            vehicle.alerts.push('Speed Violation');
            showToast(`${vehicle.id} exceeding speed limit: ${vehicle.route.currentSpeed}/${vehicle.route.speedLimit} km/h`, 'critical', 'high');
            addAlert(vehicle.id, vehicle.group, 'Speed Violation', 'Critical');
          }
        }
        
        // Critical maintenance alerts
        if (vehicle.health.maintenanceRisk === 'High' && !vehicle.alerts.includes('Critical Maintenance')) {
          vehicle.alerts.push('Critical Maintenance');
          showToast(`${vehicle.id} requires immediate maintenance attention`, 'warning', 'high');
          addAlert(vehicle.id, vehicle.group, 'Critical Maintenance', 'Critical');
        }
        
        // Low fuel critical alert
        if (vehicle.health.fuel < 15 && !vehicle.alerts.includes('Critical Fuel Low')) {
          vehicle.alerts.push('Critical Fuel Low');
          showToast(`${vehicle.id} fuel critically low: ${vehicle.health.fuel}%`, 'error', 'high');
          addAlert(vehicle.id, vehicle.group, 'Critical Fuel Low', 'Critical');
        }
      });
    }

    // Export CSV
    document.getElementById('export-csv-btn').onclick = () => {
      try {
        const csv = [
          'ID,VIN,Plate Number,Driver,Status,Group,Last Ping,Fuel,Battery,Engine Temp,Tire Pressure,Mileage,Next Service,Alerts,Driver Score,Harsh Braking,Speeding,Idling,Harsh Acceleration,Cornering,ETA,Distance,Traffic Delay'
        ];
        vehicles.forEach(v => {
          csv.push(
            `${v.id},${v.vin},${v.plateNumber},${v.driver},${v.status},${v.group},${v.lastPing},${v.health.fuel},${v.health.battery},${v.health.engineTemp.toFixed(1)},${v.health.tirePressure.toFixed(1)},${v.health.mileage},${v.health.nextService},"${v.alerts.join(';')}",${v.driverBehavior.score},${v.driverBehavior.harshBraking},${v.driverBehavior.speeding},${v.driverBehavior.idling},${v.driverBehavior.harshAcceleration},${v.driverBehavior.cornering},${v.route.eta},${v.route.distance},${v.route.trafficDelay}`
          );
        });
        const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'vehicles.csv';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Vehicle data exported successfully.');
      } catch (error) {
        console.error('Error exporting CSV:', error);
        showToast('Error exporting vehicle data.');
      }
    };

    // Bulk Actions (Enhanced with Executive Steps)
    let selectedVehicles = new Set();
    
    function toggleVehicleSelection(vehicleId) {
      if (selectedVehicles.has(vehicleId)) {
        selectedVehicles.delete(vehicleId);
      } else {
        selectedVehicles.add(vehicleId);
      }
      updateBulkActionButton();
      updateVehicleSelectionUI();
    }
    
    function selectAllVehicles() {
      const visibleVehicles = document.querySelectorAll('.vehicle-card');
      visibleVehicles.forEach(card => {
        const vehicleId = card.dataset.vehicleId;
        if (vehicleId) selectedVehicles.add(vehicleId);
      });
      updateBulkActionButton();
      updateVehicleSelectionUI();
    }
    
    function clearAllSelections() {
      selectedVehicles.clear();
      updateBulkActionButton();
      updateVehicleSelectionUI();
    }
    
    function updateBulkActionButton() {
      const bulkBtn = document.getElementById('bulk-action-btn');
      if (bulkBtn) {
        bulkBtn.textContent = selectedVehicles.size > 0 ? 
          `Bulk Actions (${selectedVehicles.size})` : 'Bulk Actions';
        bulkBtn.disabled = selectedVehicles.size === 0;
      }
    }
    
    function updateVehicleSelectionUI() {
      document.querySelectorAll('.vehicle-card').forEach(card => {
        const vehicleId = card.dataset.vehicleId;
        const checkbox = card.querySelector('.vehicle-checkbox');
        if (checkbox && vehicleId) {
          checkbox.checked = selectedVehicles.has(vehicleId);
        }
      });
    }
    
    function showBulkActionsModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-tasks mr-2 text-blue-600"></i>
            Bulk Actions - ${selectedVehicles.size} Vehicle(s) Selected
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button onclick="executeBulkMaintenance()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-tools text-yellow-600 mr-3 text-xl"></i>
                <span class="font-semibold">Schedule Maintenance</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Schedule maintenance for selected vehicles</p>
            </button>
            
            <button onclick="executeBulkDriverAssignment()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-user-plus text-green-600 mr-3 text-xl"></i>
                <span class="font-semibold">Assign Drivers</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Assign or reassign drivers to vehicles</p>
            </button>
            
            <button onclick="executeBulkGroupChange()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-layer-group text-purple-600 mr-3 text-xl"></i>
                <span class="font-semibold">Change Group</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Move vehicles to different groups</p>
            </button>
            
            <button onclick="executeBulkStatusUpdate()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-orange-50 dark:hover:bg-orange-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-exchange-alt text-orange-600 mr-3 text-xl"></i>
                <span class="font-semibold">Update Status</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Change status for multiple vehicles</p>
            </button>
            
            <button onclick="executeBulkExport()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-download text-indigo-600 mr-3 text-xl"></i>
                <span class="font-semibold">Export Data</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Export selected vehicles data</p>
            </button>
            
            <button onclick="executeBulkAlertClear()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-bell-slash text-red-600 mr-3 text-xl"></i>
                <span class="font-semibold">Clear Alerts</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Clear all alerts for selected vehicles</p>
            </button>
          </div>
          
          <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Selected Vehicles:</h4>
            <div class="max-h-32 overflow-y-auto bg-gray-50 dark:bg-gray-700 rounded p-3">
              ${Array.from(selectedVehicles).map(id => {
                const vehicle = vehicles.find(v => v.id === id);
                return vehicle ? `<span class="inline-block bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs mr-2 mb-1">${vehicle.id} - ${vehicle.driver}</span>` : '';
              }).join('')}
            </div>
          </div>
          
          <div class="flex justify-end gap-3 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    document.getElementById('bulk-action-btn').addEventListener('click', () => {
      if (selectedVehicles.size === 0) {
        showToast('Please select vehicles first', 'warning');
        return;
      }
      showBulkActionsModal();
    });

    // Add Vehicle and Create Group event listeners
    document.getElementById('add-vehicle-btn').addEventListener('click', showAddVehicleModal);
    
    // Add create group button functionality
    document.addEventListener('DOMContentLoaded', () => {
      const createGroupBtn = document.createElement('button');
      createGroupBtn.innerHTML = '<i class="fas fa-layer-group mr-2"></i>Create Group';
      createGroupBtn.className = 'px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200';
      createGroupBtn.onclick = showCreateGroupModal;
      
      // Add button to controls section
      const controlsSection = document.querySelector('.flex.flex-wrap.gap-4.mb-6');
      if (controlsSection) {
        controlsSection.appendChild(createGroupBtn);
      }
    });

    // Executive Bulk Action Functions
    function executeBulkMaintenance() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-tools mr-2 text-yellow-600"></i>
            Schedule Bulk Maintenance
          </h3>
          <form id="bulk-maintenance-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Maintenance Type</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select maintenance type</option>
                  <option value="routine">Routine Service</option>
                  <option value="oil-change">Oil Change</option>
                  <option value="brake-inspection">Brake Inspection</option>
                  <option value="tire-rotation">Tire Rotation</option>
                  <option value="transmission">Transmission Service</option>
                  <option value="emergency">Emergency Repair</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Scheduled Date</label>
                <input type="date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required 
                       min="${new Date().toISOString().split('T')[0]}">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="low">Low Priority</option>
                  <option value="medium" selected>Medium Priority</option>
                  <option value="high">High Priority</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Service Provider</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select service provider</option>
                  <option value="main-garage">Main Garage</option>
                  <option value="certified-dealer">Certified Dealer</option>
                  <option value="mobile-service">Mobile Service</option>
                  <option value="third-party">Third Party Contractor</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Additional Notes</label>
                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                          placeholder="Enter any additional maintenance notes..."></textarea>
              </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                Schedule Maintenance
              </button>
            </div>
          </form>
        </div>
      `;
      
      modal.querySelector('#bulk-maintenance-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Process maintenance scheduling
        Array.from(selectedVehicles).forEach(vehicleId => {
          const vehicle = vehicles.find(v => v.id === vehicleId);
          if (vehicle) {
            vehicle.status = 'Maintenance';
            vehicle.alerts.push('Scheduled Maintenance');
          }
        });
        
        showToast(`Maintenance scheduled for ${selectedVehicles.size} vehicles`, 'success');
        selectedVehicles.clear();
        updateBulkActionButton();
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        modal.remove();
        document.querySelector('.fixed.inset-0').remove(); // Close bulk actions modal
      });
      
      document.body.appendChild(modal);
    }

    function executeBulkDriverAssignment() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-user-plus mr-2 text-green-600"></i>
            Bulk Driver Assignment
          </h3>
          <form id="bulk-driver-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assignment Mode</label>
                <select id="assignment-mode" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select assignment mode</option>
                  <option value="specific">Assign Specific Driver</option>
                  <option value="auto">Auto-Assign Available Drivers</option>
                  <option value="unassign">Unassign Current Drivers</option>
                </select>
              </div>
              <div id="specific-driver-section" class="hidden">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Driver</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                  <option value="">Choose a driver</option>
                  ${Array.from({length: 20}, (_, i) => `<option value="Driver ${i + 1}">Driver ${i + 1}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Effective Date</label>
                <input type="datetime-local" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required 
                       value="${new Date().toISOString().slice(0, 16)}">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assignment Notes</label>
                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                          placeholder="Enter assignment notes or special instructions..."></textarea>
              </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Assign Drivers
              </button>
            </div>
          </form>
        </div>
      `;
      
      // Show/hide specific driver section based on mode
      modal.querySelector('#assignment-mode').addEventListener('change', (e) => {
        const specificSection = modal.querySelector('#specific-driver-section');
        if (e.target.value === 'specific') {
          specificSection.classList.remove('hidden');
        } else {
          specificSection.classList.add('hidden');
        }
      });
      
      modal.querySelector('#bulk-driver-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const mode = modal.querySelector('#assignment-mode').value;
        
        Array.from(selectedVehicles).forEach(vehicleId => {
          const vehicle = vehicles.find(v => v.id === vehicleId);
          if (vehicle) {
            switch(mode) {
              case 'specific':
                const selectedDriver = modal.querySelector('#specific-driver-section select').value;
                if (selectedDriver) vehicle.driver = selectedDriver;
                break;
              case 'auto':
                vehicle.driver = `Driver ${Math.floor(Math.random() * 50) + 1}`;
                break;
              case 'unassign':
                vehicle.driver = 'Unassigned';
                break;
            }
          }
        });
        
        showToast(`Driver assignment completed for ${selectedVehicles.size} vehicles`, 'success');
        selectedVehicles.clear();
        updateBulkActionButton();
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        modal.remove();
        document.querySelector('.fixed.inset-0').remove();
      });
      
      document.body.appendChild(modal);
    }

    function executeBulkGroupChange() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-layer-group mr-2 text-purple-600"></i>
            Change Vehicle Groups
          </h3>
          <form id="bulk-group-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Target Group</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select target group</option>
                  <option value="Delivery">Delivery</option>
                  <option value="Service">Service</option>
                  <option value="Executive">Executive</option>
                  <option value="Maintenance">Maintenance Pool</option>
                  <option value="Reserved">Reserved Fleet</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Transfer Reason</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select reason</option>
                  <option value="operational">Operational Requirements</option>
                  <option value="maintenance">Maintenance Schedule</option>
                  <option value="seasonal">Seasonal Adjustment</option>
                  <option value="capacity">Capacity Optimization</option>
                  <option value="replacement">Vehicle Replacement</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Effective Date</label>
                <input type="date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required 
                       value="${new Date().toISOString().split('T')[0]}">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Transfer Notes</label>
                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                          placeholder="Enter reason for group transfer..."></textarea>
              </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                Transfer Vehicles
              </button>
            </div>
          </form>
        </div>
      `;
      
      modal.querySelector('#bulk-group-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const targetGroup = modal.querySelector('select').value;
        
        Array.from(selectedVehicles).forEach(vehicleId => {
          const vehicle = vehicles.find(v => v.id === vehicleId);
          if (vehicle) {
            vehicle.group = targetGroup;
          }
        });
        
        showToast(`${selectedVehicles.size} vehicles transferred to ${targetGroup} group`, 'success');
        selectedVehicles.clear();
        updateBulkActionButton();
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        modal.remove();
        document.querySelector('.fixed.inset-0').remove();
      });
      
      document.body.appendChild(modal);
    }

    function executeBulkStatusUpdate() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-exchange-alt mr-2 text-orange-600"></i>
            Bulk Status Update
          </h3>
          <form id="bulk-status-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">New Status</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select new status</option>
                  <option value="Driving">Driving</option>
                  <option value="Idling">Idling</option>
                  <option value="Parked">Parked</option>
                  <option value="Offline">Offline</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Alert">Alert</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status Change Reason</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select reason</option>
                  <option value="scheduled">Scheduled Operation</option>
                  <option value="emergency">Emergency Response</option>
                  <option value="maintenance">Maintenance Required</option>
                  <option value="inspection">Inspection Period</option>
                  <option value="administrative">Administrative Action</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Update Notes</label>
                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                          placeholder="Enter reason for status change..."></textarea>
              </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                Update Status
              </button>
            </div>
          </form>
        </div>
      `;
      
      modal.querySelector('#bulk-status-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const newStatus = modal.querySelector('select').value;
        
        Array.from(selectedVehicles).forEach(vehicleId => {
          const vehicle = vehicles.find(v => v.id === vehicleId);
          if (vehicle) {
            vehicle.status = newStatus;
          }
        });
        
        showToast(`Status updated to "${newStatus}" for ${selectedVehicles.size} vehicles`, 'success');
        selectedVehicles.clear();
        updateBulkActionButton();
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        modal.remove();
        document.querySelector('.fixed.inset-0').remove();
      });
      
      document.body.appendChild(modal);
    }

    function executeBulkExport() {
      const selectedVehicleData = Array.from(selectedVehicles).map(id => 
        vehicles.find(v => v.id === id)
      ).filter(v => v);
      
      const csv = [
        'ID,VIN,Plate Number,Driver,Status,Group,Last Ping,Fuel,Battery,Engine Temp,Tire Pressure,Mileage,Next Service,Alerts,Driver Score'
      ];
      
      selectedVehicleData.forEach(v => {
        csv.push(
          `${v.id},${v.vin},${v.plateNumber},${v.driver},${v.status},${v.group},${v.lastPing},${v.health.fuel},${v.health.battery},${v.health.engineTemp.toFixed(1)},${v.health.tirePressure.toFixed(1)},${v.health.mileage},${v.health.nextService},"${v.alerts.join(';')}",${v.driverBehavior.score}`
        );
      });
      
      const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `selected_vehicles_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast(`Exported ${selectedVehicles.size} vehicles to CSV`, 'success');
      selectedVehicles.clear();
      updateBulkActionButton();
      document.querySelector('.fixed.inset-0').remove();
    }

    function executeBulkAlertClear() {
      Array.from(selectedVehicles).forEach(vehicleId => {
        const vehicle = vehicles.find(v => v.id === vehicleId);
        if (vehicle) {
          vehicle.alerts = [];
        }
      });
      
      // Also clear from alertData
      alertData.forEach(alert => {
        if (selectedVehicles.has(alert.vehicleId)) {
          alert.snoozed = true;
        }
      });
      
      showToast(`Alerts cleared for ${selectedVehicles.size} vehicles`, 'success');
      selectedVehicles.clear();
      updateBulkActionButton();
      renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
      renderAlertFeed();
      document.querySelector('.fixed.inset-0').remove();
    }

    // Add Vehicle Modal Function
    function showAddVehicleModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-plus-circle mr-2 text-blue-600"></i>
            Add New Vehicle - Executive Registration
          </h3>
          
          <form id="add-vehicle-form">
            <!-- Step 1: Vehicle Information -->
            <div class="space-y-6">
              <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-blue-800 dark:text-blue-300 mb-3">Step 1: Vehicle Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">VIN Number *</label>
                    <input type="text" name="vin" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           required maxlength="17" placeholder="17-character VIN">
                    <small class="text-gray-500">Vehicle Identification Number</small>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Plate Number *</label>
                    <input type="text" name="plateNumber" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           required placeholder="License plate number">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Manufacturer *</label>
                    <select name="manufacturer" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                      <option value="">Select manufacturer</option>
                      <option value="Ford">Ford</option>
                      <option value="Mercedes-Benz">Mercedes-Benz</option>
                      <option value="Volkswagen">Volkswagen</option>
                      <option value="Iveco">Iveco</option>
                      <option value="MAN">MAN</option>
                      <option value="Volvo">Volvo</option>
                      <option value="Scania">Scania</option>
                      <option value="DAF">DAF</option>
                      <option value="Isuzu">Isuzu</option>
                      <option value="Mitsubishi">Mitsubishi</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Model *</label>
                    <input type="text" name="model" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           required placeholder="Vehicle model">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Year *</label>
                    <input type="number" name="year" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           required min="1990" max="2024" placeholder="2024">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vehicle Type *</label>
                    <select name="type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                      <option value="">Select type</option>
                      <option value="Van">Van</option>
                      <option value="Truck">Truck</option>
                      <option value="Car">Car</option>
                      <option value="Bus">Bus</option>
                      <option value="SUV">SUV</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Step 2: Assignment & Operations -->
              <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-green-800 dark:text-green-300 mb-3">Step 2: Assignment & Operations</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fleet Group *</label>
                    <select name="group" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                      <option value="">Select group</option>
                      <option value="Delivery">Delivery</option>
                      <option value="Service">Service</option>
                      <option value="Executive">Executive</option>
                      <option value="Maintenance">Maintenance</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assign Driver</label>
                    <select name="driver" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                      <option value="Unassigned">No Driver Assigned</option>
                      ${Array.from({length: 20}, (_, i) => `<option value="Driver ${i + 1}">Driver ${i + 1}</option>`).join('')}
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Initial Status *</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                      <option value="Parked">Parked</option>
                      <option value="Offline">Offline</option>
                      <option value="Maintenance">Maintenance</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Service Date</label>
                    <input type="date" name="serviceDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                  </div>
                </div>
              </div>

              <!-- Step 3: Technical Specifications -->
              <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-yellow-800 dark:text-yellow-300 mb-3">Step 3: Technical Specifications</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fuel Capacity (L)</label>
                    <input type="number" name="fuelCapacity" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           placeholder="80" min="20" max="200">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Load Capacity (kg)</label>
                    <input type="number" name="loadCapacity" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           placeholder="1000" min="200" max="10000">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Mileage</label>
                    <input type="number" name="mileage" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           placeholder="50000" min="0">
                  </div>
                </div>
              </div>

              <!-- Step 4: Registration Notes -->
              <div class="bg-gray-50 dark:bg-gray-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-800 dark:text-gray-300 mb-3">Step 4: Registration Notes</h4>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Additional Notes</label>
                  <textarea name="notes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                            placeholder="Enter any additional information about this vehicle..."></textarea>
                </div>
              </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                <i class="fas fa-save mr-2"></i>
                Register Vehicle
              </button>
            </div>
          </form>
        </div>
      `;
      
      // VIN validation
      const vinInput = modal.querySelector('input[name="vin"]');
      vinInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (e.target.value.length === 17) {
          // Basic VIN validation (simplified)
          const isValid = /^[A-HJ-NPR-Z0-9]{17}$/.test(e.target.value);
          e.target.style.borderColor = isValid ? 'green' : 'red';
        }
      });
      
      modal.querySelector('#add-vehicle-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        // Create new vehicle object
        const newVehicle = {
          id: vehicles.length + 1,
          vin: formData.get('vin'),
          plateNumber: formData.get('plateNumber'),
          manufacturer: formData.get('manufacturer'),
          model: formData.get('model'),
          year: parseInt(formData.get('year')),
          type: formData.get('type'),
          driver: formData.get('driver'),
          status: formData.get('status'),
          group: formData.get('group'),
          lastPing: 'Just now',
          health: {
            fuel: Math.floor(Math.random() * 100),
            battery: Math.floor(Math.random() * 100),
            engineTemp: 85 + Math.random() * 15,
            tirePressure: 32 + Math.random() * 8,
            mileage: parseInt(formData.get('mileage')) || Math.floor(Math.random() * 100000),
            nextService: formData.get('serviceDate') || '2024-12-01'
          },
          alerts: [],
          driverBehavior: {
            score: 85 + Math.floor(Math.random() * 15),
            violations: Math.floor(Math.random() * 5)
          },
          speed: 0,
          location: { lat: 40.7128 + (Math.random() - 0.5) * 0.1, lng: -74.0060 + (Math.random() - 0.5) * 0.1 }
        };
        
        vehicles.push(newVehicle);
        
        showToast(`Vehicle ${newVehicle.plateNumber} registered successfully`, 'success');
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        updateStatistics();
        modal.remove();
      });
      
      document.body.appendChild(modal);
    }

    function showCreateGroupModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-layer-group mr-2 text-purple-600"></i>
            Create New Fleet Group
          </h3>
          
          <form id="create-group-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Group Name *</label>
                <input type="text" name="groupName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                       required placeholder="Enter group name">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Group Type *</label>
                <select name="groupType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select group type</option>
                  <option value="Operational">Operational</option>
                  <option value="Service">Service</option>
                  <option value="Geographic">Geographic</option>
                  <option value="Temporary">Temporary</option>
                  <option value="Special Purpose">Special Purpose</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority Level *</label>
                <select name="priority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select priority</option>
                  <option value="High">High Priority</option>
                  <option value="Medium">Medium Priority</option>
                  <option value="Low">Low Priority</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Maximum Vehicles</label>
                <input type="number" name="maxVehicles" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                       min="1" max="100" placeholder="50">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Operating Hours</label>
                <div class="grid grid-cols-2 gap-2">
                  <input type="time" name="startTime" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" value="08:00">
                  <input type="time" name="endTime" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" value="18:00">
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Group Manager</label>
                <select name="manager" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                  <option value="">No manager assigned</option>
                  <option value="Manager 1">Manager 1</option>
                  <option value="Manager 2">Manager 2</option>
                  <option value="Manager 3">Manager 3</option>
                  <option value="Manager 4">Manager 4</option>
                  <option value="Manager 5">Manager 5</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Group Description</label>
                <textarea name="description" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                          placeholder="Describe the purpose and operations of this group..."></textarea>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Initial Vehicles</label>
                <div class="max-h-32 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                  ${vehicles.slice(0, 10).map(v => `
                    <label class="flex items-center space-x-2 text-sm">
                      <input type="checkbox" name="vehicles" value="${v.id}" class="rounded">
                      <span>${v.plateNumber} - ${v.manufacturer} ${v.model}</span>
                    </label>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Create Group
              </button>
            </div>
          </form>
        </div>
      `;
      
      modal.querySelector('#create-group-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const selectedVehicles = Array.from(formData.getAll('vehicles'));
        
        // Update selected vehicles to new group
        selectedVehicles.forEach(vehicleId => {
          const vehicle = vehicles.find(v => v.id === parseInt(vehicleId));
          if (vehicle) {
            vehicle.group = formData.get('groupName');
          }
        });
        
        showToast(`Group "${formData.get('groupName')}" created with ${selectedVehicles.length} vehicles`, 'success');
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        updateStatistics();
        modal.remove();
      });
      
      document.body.appendChild(modal);
    }



    // =================================================================
    // GEOFENCING FUNCTIONALITY MOVED TO FLEETMAPWIDGET
    // The FleetMapWidget provides complete geofencing capabilities:
    // - Draw circle and polygon geofences
    // - Configure geofence properties and alerts  
    // - Monitor vehicle entry/exit violations
    // - Manage multiple active geofences
    // All duplicate geofencing code has been removed from this page
    // =================================================================
      console.log('Geofence type:', geofenceType);
      console.log('Map container:', document.getElementById('map'));
      console.log('=====================');
      
      if (!isMapReady()) {
        console.log('Map not ready, showing warning');
        showToast('Please wait for the map to load before drawing geofences', 'warning');
        return;
      }
      
      if (!isGeofenceMode) {
        console.log('Showing geofence type modal');
        // Show type selection modal
        showGeofenceTypeModal();
      } else {
        console.log('Canceling geofence drawing');
        // Cancel current drawing
        cancelGeofenceDrawing();
      }
    });
    
    function showGeofenceTypeModal() {
      console.log('Creating geofence type modal');
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-draw-polygon mr-2 text-purple-600"></i>
            Choose Geofence Type
          </h3>
          
          <div class="space-y-4">
            <button id="circle-geofence-btn" class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-circle text-blue-600 text-2xl mr-4"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Circle Geofence</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Click once to set center and radius</div>
                </div>
              </div>
            </button>
            
            <button id="polygon-geofence-btn" class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-draw-polygon text-purple-600 text-2xl mr-4"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Polygon Geofence</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Click to add points, double-click to finish</div>
                </div>
              </div>
            </button>
          </div>
          
          <div class="flex justify-end gap-3 mt-6">
            <button id="cancel-geofence-type" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Add event listeners after modal is created
      document.getElementById('circle-geofence-btn').addEventListener('click', () => {
        console.log('Circle geofence button clicked');
        startGeofenceDrawing('circle');
      });
      
      document.getElementById('polygon-geofence-btn').addEventListener('click', () => {
        console.log('Polygon geofence button clicked');
        startGeofenceDrawing('polygon');
      });
      
      document.getElementById('cancel-geofence-type').addEventListener('click', () => {
        console.log('Cancel geofence type button clicked');
        modal.remove();
      });
    }
    
    function startGeofenceDrawing(type) {
      console.log('Starting geofence drawing, type:', type, 'map ready:', isMapReady());
      
      geofenceType = type;
      isGeofenceMode = true;
      
      // Clear any existing drawing state
      clearPolygonPoints();
      
      const btn = document.getElementById('geofence-btn');
      const statusDiv = document.getElementById('geofence-status');
      
      if (type === 'circle') {
        btn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancel Circle';
        btn.className = 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center text-sm';
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = '<i class="fas fa-crosshairs mr-2"></i>Click on the map to set circle center';
        showToast('Click on the map to set circle center', 'info');
      } else {
        btn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancel Polygon';
        btn.className = 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center text-sm';
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = '<i class="fas fa-mouse-pointer mr-2"></i>Click to add polygon points (min 3), double-click to finish';
        showToast('Click to add polygon points. Need minimum 3 points. Double-click to finish.', 'info');
      }
      
      if (map) {
        map.getContainer().style.cursor = 'crosshair';
        console.log('Map cursor set to crosshair');
      } else {
        console.error('Map not available for geofence drawing');
        showToast('Map not available. Please refresh the page.', 'error');
        return;
      }
      
      // Close type selection modal
      const typeModal = document.querySelector('.fixed.inset-0');
      if (typeModal) {
        typeModal.remove();
      }
      
      console.log('Geofence drawing mode activated:', type);
    }

    function showDriverGeofenceModal(vehicle) {
      console.log('Showing driver geofence modal for:', vehicle.driver);
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-draw-polygon mr-2 text-teal-600"></i>
            Set Geofence for ${vehicle.driver}
          </h3>
          
          <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="text-sm text-gray-600 dark:text-gray-300">
              <strong>Vehicle:</strong> ${vehicle.id} (${vehicle.manufacturer} ${vehicle.model})<br>
              <strong>Current Location:</strong> ${vehicle.lat.toFixed(6)}, ${vehicle.lng.toFixed(6)}<br>
              <strong>Status:</strong> ${vehicle.status}
            </div>
          </div>
          
          <div class="space-y-4">
            <button id="driver-circle-geofence" class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-teal-500 hover:bg-teal-50 dark:hover:bg-teal-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-circle text-teal-600 text-2xl mr-4"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Circle Geofence</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Set radius around current location</div>
                </div>
              </div>
            </button>
            
            <button id="driver-polygon-geofence" class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-teal-500 hover:bg-teal-50 dark:hover:bg-teal-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-draw-polygon text-teal-600 text-2xl mr-4"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Custom Polygon</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Draw custom area on map</div>
                </div>
              </div>
            </button>
            
            <button id="driver-center-map" class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-crosshairs text-blue-600 text-2xl mr-4"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Center Map on Vehicle</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Focus map on current location</div>
                </div>
              </div>
            </button>
          </div>
          
          <div class="flex justify-end gap-3 mt-6">
            <button id="cancel-driver-geofence" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Add event listeners
      document.getElementById('driver-circle-geofence').addEventListener('click', () => {
        modal.remove();
        startDriverGeofenceDrawing(vehicle, 'circle');
      });
      
      document.getElementById('driver-polygon-geofence').addEventListener('click', () => {
        modal.remove();
        startDriverGeofenceDrawing(vehicle, 'polygon');
      });
      
      document.getElementById('driver-center-map').addEventListener('click', () => {
        modal.remove();
        centerMapOnVehicle(vehicle);
      });
      
      document.getElementById('cancel-driver-geofence').addEventListener('click', () => {
        modal.remove();
      });
    }

    function startDriverGeofenceDrawing(vehicle, type) {
      console.log('Starting driver geofence drawing:', type, 'for vehicle:', vehicle.id);
      
      geofenceType = type;
      isGeofenceMode = true;
      
      // Clear any existing drawing state
      clearPolygonPoints();
      
      const btn = document.getElementById('geofence-btn');
      const statusDiv = document.getElementById('geofence-status');
      
      if (type === 'circle') {
        // Pre-fill the geofence modal with vehicle's current location
        document.getElementById('geofence-lat').value = vehicle.lat.toFixed(6);
        document.getElementById('geofence-lng').value = vehicle.lng.toFixed(6);
        document.getElementById('geofence-name').value = `Geofence for ${vehicle.driver}`;
        
        btn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancel Circle';
        btn.className = 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center text-sm';
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = `<i class="fas fa-crosshairs mr-2"></i>Setting geofence for ${vehicle.driver}. Click on map to adjust center or use current location.`;
        
        // Center map on vehicle
        centerMapOnVehicle(vehicle);
        
        // Show the geofence settings modal
        document.getElementById('geofence-modal').classList.remove('hidden');
        
        showToast(`Setting circle geofence for ${vehicle.driver}. Vehicle location pre-filled.`, 'info');
        
      } else {
        btn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancel Polygon';
        btn.className = 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center text-sm';
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = `<i class="fas fa-mouse-pointer mr-2"></i>Drawing polygon geofence for ${vehicle.driver}. Click to add points, double-click to finish.`;
        
        // Center map on vehicle
        centerMapOnVehicle(vehicle);
        
        showToast(`Drawing polygon geofence for ${vehicle.driver}. Click to add points, double-click to finish.`, 'info');
      }
      
      if (map) {
        map.getContainer().style.cursor = 'crosshair';
      }
    }

    function centerMapOnVehicle(vehicle) {
      if (window.vehiclesPageMap && vehicle.lat && vehicle.lng) {
        // Use fleet map widget
        window.vehiclesPageMap.map.setView([vehicle.lat, vehicle.lng], 15);
        showToast(`Map centered on ${vehicle.driver}'s location`, 'info');
      } else if (map && vehicle.lat && vehicle.lng) {
        // Use fallback Leaflet map
        map.setView([vehicle.lat, vehicle.lng], 15);
        showToast(`Map centered on ${vehicle.driver}'s location`, 'info');
      }
    }

    function issueWarningToDriver(vehicle) {
      console.log('Issuing warning to driver:', vehicle.driver, 'vehicle:', vehicle.id);
      console.log('Vehicle data:', vehicle);
      
      // Check for current violations
      const currentViolations = checkCurrentViolations(vehicle);
      console.log('Current violations found:', currentViolations);
      
      // Show warning modal with violation details
      showWarningModal(vehicle, currentViolations);
    }

    function checkCurrentViolations(vehicle) {
      const violations = [];
      
      // Check for speeding
      if (vehicle.route.currentSpeed > vehicle.route.speedLimit) {
        violations.push({
          type: 'Speeding',
          severity: 'High',
          description: `Current speed: ${Math.round(vehicle.route.currentSpeed)} km/h (Limit: ${vehicle.route.speedLimit} km/h)`,
          points: 3
        });
      }
      
      // Check for harsh driving behavior
      if (vehicle.driverBehavior.harshBraking > 3) {
        violations.push({
          type: 'Harsh Braking',
          severity: 'Medium',
          description: `${vehicle.driverBehavior.harshBraking} harsh braking incidents detected`,
          points: 2
        });
      }
      
      if (vehicle.driverBehavior.harshAcceleration > 3) {
        violations.push({
          type: 'Harsh Acceleration',
          severity: 'Medium',
          description: `${vehicle.driverBehavior.harshAcceleration} harsh acceleration incidents detected`,
          points: 2
        });
      }
      
      // Check for maintenance issues
      if (vehicle.health.maintenanceRisk === 'High') {
        violations.push({
          type: 'Maintenance Risk',
          severity: 'Medium',
          description: 'Vehicle requires immediate maintenance attention',
          points: 2
        });
      }
      
      // Check for fuel efficiency
      if (vehicle.route.fuelConsumption > 12) {
        violations.push({
          type: 'Fuel Inefficiency',
          severity: 'Low',
          description: `High fuel consumption: ${Math.round(vehicle.route.fuelConsumption)}L/100km`,
          points: 1
        });
      }
      
      // Check for geofence violations (if any alerts contain geofence)
      if (vehicle.alerts.includes('Geofence Violation')) {
        violations.push({
          type: 'Geofence Violation',
          severity: 'High',
          description: 'Vehicle has left designated geofence area',
          points: 3
        });
      }
      
      return violations;
    }

    function showWarningModal(vehicle, currentViolations) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      
      const hasCurrentViolations = currentViolations.length > 0;
      const hasViolationHistory = vehicle.driverBehavior.violationHistory.length > 0;
      
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>
            Issue Warning - ${vehicle.driver}
          </h3>
          
          <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="text-sm text-gray-600 dark:text-gray-300">
              <strong>Vehicle:</strong> ${vehicle.id} (${vehicle.manufacturer} ${vehicle.model})<br>
              <strong>Current Status:</strong> ${vehicle.status}<br>
              <strong>Driver Score:</strong> ${Math.round(vehicle.driverBehavior.score)}/100<br>
              <strong>Total Violations:</strong> ${vehicle.driverBehavior.violations}
            </div>
          </div>
          
          ${hasCurrentViolations ? `
            <div class="mb-4">
              <h4 class="font-semibold text-red-600 dark:text-red-400 mb-2 flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Current Violations Detected
              </h4>
              <div class="space-y-2">
                ${currentViolations.map(violation => `
                  <div class="p-3 border-l-4 border-red-500 bg-red-50 dark:bg-red-900/20 rounded-r-lg">
                    <div class="flex justify-between items-start">
                      <div>
                        <div class="font-semibold text-red-700 dark:text-red-300">${violation.type}</div>
                        <div class="text-sm text-red-600 dark:text-red-400">${violation.description}</div>
                      </div>
                      <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                        violation.severity === 'High' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                        violation.severity === 'Medium' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                        'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                      }">${violation.severity}</span>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : `
            <div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 rounded-r-lg">
              <div class="flex items-center">
                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                <span class="text-green-700 dark:text-green-300 font-semibold">No current violations detected</span>
              </div>
            </div>
          `}
          
          ${hasViolationHistory ? `
            <div class="mb-4">
              <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                <i class="fas fa-history mr-2"></i>
                Recent Violation History
              </h4>
              <div class="max-h-40 overflow-y-auto space-y-2">
                ${vehicle.driverBehavior.violationHistory.slice(0, 5).map(violation => `
                  <div class="p-2 border border-gray-200 dark:border-gray-600 rounded-lg text-sm">
                    <div class="flex justify-between items-start">
                      <div>
                        <div class="font-medium">${violation.type}</div>
                        <div class="text-gray-600 dark:text-gray-400">${violation.date} at ${violation.time}</div>
                        <div class="text-xs text-gray-500">${violation.description}</div>
                      </div>
                      <div class="text-right">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                          violation.resolved ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                        }">${violation.resolved ? 'Resolved' : 'Pending'}</span>
                        ${violation.warningIssued ? '<div class="text-xs text-orange-600 mt-1">Warning Issued</div>' : ''}
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <div class="space-y-3">
            <h4 class="font-semibold text-gray-700 dark:text-gray-300">Warning Options</h4>
            
            <button id="issue-verbal-warning" class="w-full p-3 border-2 border-yellow-200 dark:border-yellow-600 rounded-lg hover:border-yellow-500 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-comment text-yellow-600 text-xl mr-3"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Verbal Warning</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Send immediate notification to driver</div>
                </div>
              </div>
            </button>
            
            <button id="issue-written-warning" class="w-full p-3 border-2 border-orange-200 dark:border-orange-600 rounded-lg hover:border-orange-500 hover:bg-orange-50 dark:hover:bg-orange-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-file-alt text-orange-600 text-xl mr-3"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Written Warning</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Issue formal written warning</div>
                </div>
              </div>
            </button>
            
            <button id="schedule-meeting" class="w-full p-3 border-2 border-red-200 dark:border-red-600 rounded-lg hover:border-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-calendar-alt text-red-600 text-xl mr-3"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Schedule Meeting</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Arrange face-to-face discussion</div>
                </div>
              </div>
            </button>
          </div>
          
          <div class="flex justify-end gap-3 mt-6">
            <button id="cancel-warning" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Add event listeners
      document.getElementById('issue-verbal-warning').addEventListener('click', () => {
        issueWarning(vehicle, 'Verbal', currentViolations);
        modal.remove();
      });
      
      document.getElementById('issue-written-warning').addEventListener('click', () => {
        issueWarning(vehicle, 'Written', currentViolations);
        modal.remove();
      });
      
      document.getElementById('schedule-meeting').addEventListener('click', () => {
        issueWarning(vehicle, 'Meeting', currentViolations);
        modal.remove();
      });
      
      document.getElementById('cancel-warning').addEventListener('click', () => {
        modal.remove();
      });
    }

    function issueWarning(vehicle, warningType, violations) {
      const timestamp = new Date().toLocaleString();
      const warningData = {
        vehicleId: vehicle.id,
        driver: vehicle.driver,
        type: warningType,
        violations: violations,
        timestamp: timestamp,
        status: 'Issued'
      };
      
      // Store warning in localStorage (in a real app, this would go to a database)
      const warnings = JSON.parse(localStorage.getItem('driverWarnings') || '[]');
      warnings.push(warningData);
      localStorage.setItem('driverWarnings', JSON.stringify(warnings));
      
      // Update vehicle's violation history
      violations.forEach(violation => {
        vehicle.driverBehavior.violationHistory.push({
          ...violation,
          date: new Date().toLocaleDateString(),
          time: new Date().toLocaleTimeString(),
          location: `${vehicle.lat.toFixed(6)}, ${vehicle.lng.toFixed(6)}`,
          resolved: false,
          warningIssued: true,
          warningType: warningType
        });
      });
      
      // Show confirmation
      const violationText = violations.length > 0 ? 
        ` for ${violations.length} violation${violations.length > 1 ? 's' : ''}` : '';
      
      showToast(`${warningType} warning issued to ${vehicle.driver}${violationText}`, 'warning');
      
      // Log the warning
      console.log(`Warning issued:`, warningData);
      
      // In a real application, this would trigger:
      // - SMS/Email notification to driver
      // - Dashboard notification
      // - Report generation
      // - Escalation if needed
    }
    
    function cancelGeofenceDrawing() {
      isGeofenceMode = false;
      const btn = document.getElementById('geofence-btn');
      btn.innerHTML = '<i class="fas fa-draw-polygon mr-2"></i>Draw Geofence';
      btn.className = 'px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center text-sm';
      document.getElementById('geofence-status').classList.add('hidden');
      
      if (map) {
        map.getContainer().style.cursor = '';
      }
      
      // Clear temporary elements
      if (tempGeofenceCircle) {
        map.removeLayer(tempGeofenceCircle);
        tempGeofenceCircle = null;
      }
      clearPolygonPoints();
      
      if (geofenceMarker && !geofence) {
        map.removeLayer(geofenceMarker);
        geofenceMarker = null;
      }
      
      showToast('Geofence drawing cancelled', 'info');
    }

    document.getElementById('geofence-settings-btn').addEventListener('click', () => {
      const modal = document.getElementById('geofence-modal');
      if (modal) {
        modal.classList.remove('hidden');
        // Auto-show preview if coordinates are set
        const lat = parseFloat(document.getElementById('geofence-lat').value);
        const lng = parseFloat(document.getElementById('geofence-lng').value);
        const radius = parseFloat(document.getElementById('geofence-radius').value);
        if (!isNaN(lat) && !isNaN(lng) && !isNaN(radius)) {
          updateGeofencePreview(lat, lng, radius);
        }
      }
    });

    document.getElementById('clear-geofence-btn').addEventListener('click', () => {
      if (confirm('Are you sure you want to clear the current geofence?')) {
        geofence = null;
        
        // Clear all geofence elements from map
        if (geofenceCircle) {
          map.removeLayer(geofenceCircle);
          geofenceCircle = null;
        }
        if (geofencePolygon) {
          map.removeLayer(geofencePolygon);
          geofencePolygon = null;
        }
        if (geofenceMarker) {
          map.removeLayer(geofenceMarker);
          geofenceMarker = null;
        }
        if (tempGeofenceCircle) {
          map.removeLayer(tempGeofenceCircle);
          tempGeofenceCircle = null;
        }
        if (tempGeofencePolygon) {
          map.removeLayer(tempGeofencePolygon);
          tempGeofencePolygon = null;
        }
        
        // Clear polygon drawing state
        clearPolygonPoints();
        isDrawingPolygon = false;
        geofenceType = 'circle';
        
        // Clear form
        document.getElementById('geofence-name').value = '';
        document.getElementById('geofence-lat').value = '51.5074';
        document.getElementById('geofence-lng').value = '-0.1278';
        document.getElementById('geofence-radius').value = '5';
        document.getElementById('geofence-radius-slider').value = '5';
        
        // Remove geofence-related alerts
        vehicles.forEach(v => {
          v.alerts = v.alerts.filter(alert => 
            !alert.includes('Geofence') && !alert.includes('Entered') && !alert.includes('Exited')
          );
          v.wasInsideGeofence = false;
        });
        
        updateGeofenceDisplay();
        showToast('Geofence cleared successfully', 'success');
      }
    });

    // Test Geofence Function
    document.getElementById('test-geofence-btn').addEventListener('click', () => {
      console.log('=== GEOFENCE TEST ===');
      console.log('1. Testing map element:', document.getElementById('map'));
      console.log('2. Testing map object:', map);
      console.log('3. Testing map ready function:', isMapReady());
      console.log('4. Testing geofence variables:');
      console.log('   - isGeofenceMode:', isGeofenceMode);
      console.log('   - geofenceType:', geofenceType);
      console.log('   - geofencePoints:', geofencePoints);
      console.log('5. Testing Leaflet availability:', typeof L);
      console.log('6. Testing map click handlers:', map ? 'Map exists' : 'No map');
      
      if (map) {
        console.log('7. Map is available, testing click event...');
        // Simulate a map click
        const center = map.getCenter();
        console.log('8. Map center:', center);
        console.log('9. Testing geofence mode:', isGeofenceMode);
        
        if (isGeofenceMode) {
          console.log('10. In geofence mode, testing click processing...');
          if (geofenceType === 'circle') {
            console.log('11. Processing circle geofence click');
            setGeofenceFromMap(center.lat, center.lng);
          } else if (geofenceType === 'polygon') {
            console.log('11. Processing polygon geofence click');
            addPolygonPoint(center.lat, center.lng);
          }
        } else {
          console.log('10. Not in geofence mode');
        }
      } else {
        console.log('7. Map is not available');
      }
      
      console.log('=== END TEST ===');
      showToast('Geofence test completed. Check console for details.', 'info');
    });

    // Enhanced modal controls
    document.getElementById('close-geofence-modal').addEventListener('click', () => {
      document.getElementById('geofence-modal').classList.add('hidden');
    });

    document.getElementById('cancel-geofence').addEventListener('click', () => {
      document.getElementById('geofence-modal').classList.add('hidden');
      
      // Clear temporary elements
      if (tempGeofenceCircle) {
        map.removeLayer(tempGeofenceCircle);
        tempGeofenceCircle = null;
      }
    });

    // Radius slider synchronization
    document.getElementById('geofence-radius-slider').addEventListener('input', function() {
      const radius = parseFloat(this.value);
      document.getElementById('geofence-radius').value = radius;
      
      // Update area calculation
      const area = Math.PI * radius * radius;
      document.getElementById('geofence-area').textContent = area.toFixed(2);
      
      // Update preview if coordinates are set
      const lat = parseFloat(document.getElementById('geofence-lat').value);
      const lng = parseFloat(document.getElementById('geofence-lng').value);
      if (!isNaN(lat) && !isNaN(lng)) {
        updateGeofencePreview(lat, lng, radius);
      }
    });

    document.getElementById('geofence-radius').addEventListener('input', function() {
      const radius = parseFloat(this.value);
      document.getElementById('geofence-radius-slider').value = radius;
      
      // Update area calculation
      const area = Math.PI * radius * radius;
      document.getElementById('geofence-area').textContent = area.toFixed(2);
      
      // Update preview if coordinates are set
      const lat = parseFloat(document.getElementById('geofence-lat').value);
      const lng = parseFloat(document.getElementById('geofence-lng').value);
      if (!isNaN(lat) && !isNaN(lng)) {
        updateGeofencePreview(lat, lng, radius);
      }
    });

    // Coordinate input handlers
    ['geofence-lat', 'geofence-lng'].forEach(id => {
      document.getElementById(id).addEventListener('input', function() {
        const lat = parseFloat(document.getElementById('geofence-lat').value);
        const lng = parseFloat(document.getElementById('geofence-lng').value);
        const radius = parseFloat(document.getElementById('geofence-radius').value);
        
        if (!isNaN(lat) && !isNaN(lng) && !isNaN(radius)) {
          updateGeofencePreview(lat, lng, radius);
          
          // Update marker position
          if (geofenceMarker) {
            geofenceMarker.setLatLng([lat, lng]);
          } else {
            setGeofenceFromMap(lat, lng);
          }
        }
      });
    });

    document.getElementById('preview-geofence').addEventListener('click', () => {
      const lat = parseFloat(document.getElementById('geofence-lat').value);
      const lng = parseFloat(document.getElementById('geofence-lng').value);
      const radius = parseFloat(document.getElementById('geofence-radius').value);
      
      if (isNaN(lat) || isNaN(lng) || isNaN(radius)) {
        showToast('Please enter valid coordinates and radius', 'error');
        return;
      }
      
      if (!isMapReady()) {
        showToast('Map not ready. Please wait and try again.', 'error');
        return;
      }
      
      updateGeofencePreview(lat, lng, radius);
      
      // Center map on geofence
      try {
        const zoomLevel = Math.max(8, Math.min(15, 15 - Math.log10(radius)));
        map.setView([lat, lng], zoomLevel);
        showToast('Geofence preview updated on map', 'success');
      } catch (error) {
        console.error('Error updating map view:', error);
        showToast('Error updating map view', 'error');
      }
    });

    document.getElementById('apply-geofence').addEventListener('click', () => {
      const name = document.getElementById('geofence-name').value.trim();
      const entryAlert = document.getElementById('geofence-entry-alert').checked;
      const exitAlert = document.getElementById('geofence-exit-alert').checked;
      
      if (geofencePoints.length >= 3) {
        // Apply polygon geofence
        const area = calculatePolygonArea(geofencePoints);
        const centerLat = geofencePoints.reduce((sum, p) => sum + p[0], 0) / geofencePoints.length;
        const centerLng = geofencePoints.reduce((sum, p) => sum + p[1], 0) / geofencePoints.length;
        
        geofence = {
          type: 'polygon',
          points: [...geofencePoints],
          lat: centerLat,
          lng: centerLng,
          area: area,
          name: name || 'Unnamed Polygon Geofence',
          entryAlert,
          exitAlert
        };
        
        // Clear drawing state
        clearPolygonPoints();
        
        updateGeofenceDisplay();
        document.getElementById('geofence-modal').classList.add('hidden');
        
        showToast(`Polygon geofence "${geofence.name}" applied successfully!`, 'success');
        
      } else {
        // Apply circle geofence
        const lat = parseFloat(document.getElementById('geofence-lat').value);
        const lng = parseFloat(document.getElementById('geofence-lng').value);
        const radius = parseFloat(document.getElementById('geofence-radius').value);
        
        if (isNaN(lat) || lat < -90 || lat > 90) {
          showToast('Please enter a valid latitude (-90 to 90)', 'error');
          return;
        }
        
        if (isNaN(lng) || lng < -180 || lng > 180) {
          showToast('Please enter a valid longitude (-180 to 180)', 'error');
          return;
        }
        
        if (isNaN(radius) || radius <= 0) {
          showToast('Please enter a valid radius (greater than 0)', 'error');
          return;
        }
        
        geofence = {
          type: 'circle',
          lat,
          lng,
          radius,
          name: name || 'Unnamed Circle Geofence',
          entryAlert,
          exitAlert
        };
        
        // Clear temporary preview
        if (tempGeofenceCircle) {
          map.removeLayer(tempGeofenceCircle);
          tempGeofenceCircle = null;
        }
        
        updateGeofenceDisplay();
        document.getElementById('geofence-modal').classList.add('hidden');
        
        showToast(`Circle geofence "${geofence.name}" applied successfully!`, 'success');
      }
      
      // Reset drawing mode
      isGeofenceMode = false;
      const btn = document.getElementById('geofence-btn');
      btn.innerHTML = '<i class="fas fa-draw-polygon mr-2"></i>Draw Geofence';
      btn.className = 'px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center text-sm';
      document.getElementById('geofence-status').classList.add('hidden');
      if (map) {
        map.getContainer().style.cursor = '';
      }
    });

    // Customize Dashboard
    document.getElementById('customize-dashboard-btn').addEventListener('click', () => {
      showToast('Drag widgets to reorder or hide them.');
      const grid = document.getElementById('analytics-grid');
      grid.classList.add('border-2', 'border-dashed', 'border-blue-400');
      setTimeout(() => grid.classList.remove('border-2', 'border-dashed', 'border-blue-400'), 5000);
    });
    Sortable.create(document.getElementById('analytics-grid'), {
      animation: 150,
      onEnd: function(evt) {
        const widgets = Array.from(document.querySelectorAll('.analytics-widget')).map(w => w.dataset.widget);
        dashboardConfig = widgets;
        localStorage.setItem('dashboardConfig', JSON.stringify(dashboardConfig));
        showToast('Dashboard layout saved.');
      }
    });

    // Simulated Real-Time Updates
    function simulateRealTimeUpdates() {
      let updateCounter = 0;
      setInterval(() => {
        vehicles.forEach(v => {
          v.lastPing = new Date().toLocaleTimeString();
          if (v.status === 'Driving') {
            v.lat += (Math.random() - 0.5) * 0.001;
            v.lng += (Math.random() - 0.5) * 0.001;
            v.health.fuel = Math.max(0, v.health.fuel - Math.random() * 0.5);
            v.route.eta = new Date(Date.now() + (Math.random() * 1.5 + 0.5) * 3600000).toLocaleTimeString();
            v.route.trafficDelay += Math.random() > 0.7 ? Math.floor(Math.random() * 5) : 0;
            v.driverBehavior.score = Math.min(100, Math.max(0, v.driverBehavior.score + (Math.random() - 0.5) * 2));
            
            // Update speed realistically
            v.route.currentSpeed = Math.max(0, Math.min(120, v.route.currentSpeed + (Math.random() - 0.5) * 10));
            
            // Update health metrics
            v.health.oilLife = Math.max(0, v.health.oilLife - Math.random() * 0.1);
            v.health.brakeWear = Math.max(0, v.health.brakeWear - Math.random() * 0.05);
            
            if (Math.random() > 0.9) v.driverBehavior.harshBraking += 1;
            if (Math.random() > 0.9) v.driverBehavior.speeding += 1;
            if (Math.random() > 0.9) v.driverBehavior.idling += 1;
            if (Math.random() > 0.9) v.driverBehavior.harshAcceleration += 1;
            if (Math.random() > 0.9) v.driverBehavior.cornering += 1;
          }
          if (v.health.mileage > 50000 && Math.random() > 0.95 && !v.alerts.includes('Predictive Maintenance')) {
            v.alerts.push('Predictive Maintenance');
            alertData.push({
              vehicleId: v.id,
              group: v.group,
              alert: 'Predictive Maintenance',
              severity: 'Info',
              timestamp: new Date().toLocaleTimeString(),
              snoozed: false
            });
          }
          if (v.health.fuel < 10 && !v.alerts.includes('Low Fuel')) {
            v.alerts.push('Low Fuel');
            alertData.push({
              vehicleId: v.id,
              group: v.group,
              alert: 'Low Fuel',
              severity: 'Warning',
              timestamp: new Date().toLocaleTimeString(),
              snoozed: false
            });
          }
          if (geofence && v.status === 'Driving') {
            let isOutside = false;
            
            if (geofence.type === 'circle') {
              const distance = map.distance([v.lat, v.lng], [geofence.lat, geofence.lng]) / 1000;
              isOutside = distance > geofence.radius;
            } else if (geofence.type === 'polygon') {
              // Polygon geofence check using ray casting algorithm
              const points = geofence.points;
              const lat = v.lat;
              const lng = v.lng;
              let inside = false;
              
              for (let i = 0, j = points.length - 1; i < points.length; j = i++) {
                const xi = points[i][0], yi = points[i][1];
                const xj = points[j][0], yj = points[j][1];
                
                if (((yi > lng) !== (yj > lng)) && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi)) {
                  inside = !inside;
                }
              }
              
              isOutside = !inside;
            }
            
            if (isOutside && !v.alerts.includes('Geofence Violation')) {
              v.alerts.push('Geofence Violation');
              alertData.push({
                vehicleId: v.id,
                group: v.group,
                alert: 'Geofence Violation',
                severity: 'Critical',
                timestamp: new Date().toLocaleTimeString(),
                snoozed: false
              });
            }
          }
        });
        
        updateCounter++;
        
        // Check for critical alerts every update
        checkCriticalAlerts();
        
        // Only render heavy components every 3rd update (30 seconds) instead of every update
        const shouldRenderHeavy = updateCounter % 3 === 0;
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters, !shouldRenderHeavy);
        
        // Update alerts every update since they're critical
        if (!shouldRenderHeavy) {
          renderAlertFeed();
        }
      }, 10000);
    }

    // Vehicle Types & Shifts Management System
    class VehicleTypesShiftsManager {
      constructor() {
        this.vehicleTypes = [
          {
            id: 'delivery-truck',
            name: 'Delivery Truck',
            category: 'Heavy Duty',
            icon: 'fa-truck',
            color: 'blue',
            maxWeight: '26,000 kg',
            fuelType: 'Diesel',
            licenseRequired: 'CDL-A',
            activeUnits: 45,
            specifications: {
              length: '12.2m',
              width: '2.5m',
              height: '4.0m',
              capacity: '60 cubic meters'
            }
          },
          {
            id: 'service-van',
            name: 'Service Van',
            category: 'Light Commercial',
            icon: 'fa-shuttle-van',
            color: 'green',
            maxWeight: '3,500 kg',
            fuelType: 'Gasoline',
            licenseRequired: 'Class B',
            activeUnits: 32,
            specifications: {
              length: '5.9m',
              width: '2.0m',
              height: '2.8m',
              capacity: '15 cubic meters'
            }
          },
          {
            id: 'passenger-car',
            name: 'Passenger Car',
            category: 'Light Duty',
            icon: 'fa-car',
            color: 'purple',
            maxWeight: '2,000 kg',
            fuelType: 'Hybrid',
            licenseRequired: 'Class C',
            activeUnits: 23,
            specifications: {
              length: '4.5m',
              width: '1.8m',
              height: '1.5m',
              capacity: '5 passengers'
            }
          }
        ];

        this.shifts = [
          {
            id: 'morning-shift',
            name: 'Morning Shift',
            icon: 'fa-sun',
            color: 'blue',
            startTime: '06:00',
            endTime: '14:00',
            days: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
            assignedDrivers: 15,
            vehicleTypes: ['delivery-truck', 'service-van'],
            payModifier: 1.0
          },
          {
            id: 'afternoon-shift',
            name: 'Afternoon Shift',
            icon: 'fa-sun',
            color: 'orange',
            startTime: '14:00',
            endTime: '22:00',
            days: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
            assignedDrivers: 12,
            vehicleTypes: ['delivery-truck', 'service-van', 'passenger-car'],
            payModifier: 1.1
          },
          {
            id: 'night-shift',
            name: 'Night Shift',
            icon: 'fa-moon',
            color: 'indigo',
            startTime: '22:00',
            endTime: '06:00',
            days: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            assignedDrivers: 8,
            vehicleTypes: ['service-van', 'passenger-car'],
            payModifier: 1.25
          }
        ];

        this.init();
      }

      init() {
        this.bindEvents();
        this.renderVehicleTypes();
        this.renderShiftSchedules();
      }

      bindEvents() {
        // Add vehicle type button
        document.getElementById('add-vehicle-type').addEventListener('click', () => {
          this.showVehicleTypeForm();
        });

        // Add shift schedule button
        document.getElementById('add-shift-schedule').addEventListener('click', () => {
          this.showShiftForm();
        });
      }

      renderVehicleTypes() {
        const grid = document.getElementById('vehicle-types-grid');
        grid.innerHTML = this.vehicleTypes.map(type => `
          <div class="vehicle-type-card bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-${type.color}-100 dark:bg-${type.color}-900 rounded-lg flex items-center justify-center">
                  <i class="fas ${type.icon} text-${type.color}-600 dark:text-${type.color}-400 text-lg"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-900 dark:text-white text-sm">${type.name}</h4>
                  <span class="text-xs text-gray-500 dark:text-gray-400">${type.category}</span>
                </div>
              </div>
              <div class="flex gap-1">
                <button class="edit-vehicle-type p-1 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900 rounded transition-colors" data-id="${type.id}" title="Edit">
                  <i class="fas fa-edit text-xs"></i>
                </button>
                <button class="delete-vehicle-type p-1 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900 rounded transition-colors" data-id="${type.id}" title="Delete">
                  <i class="fas fa-trash text-xs"></i>
                </button>
              </div>
            </div>
            <div class="space-y-2 text-xs">
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Max Weight:</span>
                <span class="font-medium text-gray-900 dark:text-white">${type.maxWeight}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Fuel Type:</span>
                <span class="font-medium text-gray-900 dark:text-white">${type.fuelType}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">License:</span>
                <span class="font-medium text-gray-900 dark:text-white">${type.licenseRequired}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Active Units:</span>
                <span class="font-medium text-green-600 dark:text-green-400">${type.activeUnits}</span>
              </div>
            </div>
          </div>
        `).join('');

        // Bind edit and delete buttons
        grid.querySelectorAll('.edit-vehicle-type').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.editVehicleType(e.target.closest('button').dataset.id);
          });
        });

        grid.querySelectorAll('.delete-vehicle-type').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.deleteVehicleType(e.target.closest('button').dataset.id);
          });
        });
      }

      renderShiftSchedules() {
        const tbody = document.getElementById('shifts-table-body');
        tbody.innerHTML = this.shifts.map(shift => `
          <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="py-3 px-3">
              <div class="flex items-center">
                <div class="w-6 h-6 bg-${shift.color}-100 dark:bg-${shift.color}-900 rounded-full flex items-center justify-center mr-2">
                  <i class="fas ${shift.icon} text-${shift.color}-600 dark:text-${shift.color}-400 text-xs"></i>
                </div>
                <span class="font-medium text-gray-900 dark:text-white text-sm">${shift.name}</span>
              </div>
            </td>
            <td class="py-3 px-3 text-sm text-gray-900 dark:text-gray-300">${this.formatTime(shift.startTime)} - ${this.formatTime(shift.endTime)}</td>
            <td class="py-3 px-3">
              <span class="inline-flex px-2 py-1 text-xs font-semibold bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-full">
                ${shift.days.join('-')}
              </span>
            </td>
            <td class="py-3 px-3 text-sm text-gray-900 dark:text-gray-300">${shift.assignedDrivers}</td>
            <td class="py-3 px-3">
              <div class="flex gap-1">
                <button class="edit-shift p-1 text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900 rounded transition-colors" data-id="${shift.id}" title="Edit">
                  <i class="fas fa-edit text-xs"></i>
                </button>
                <button class="delete-shift p-1 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900 rounded transition-colors" data-id="${shift.id}" title="Delete">
                  <i class="fas fa-trash text-xs"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');

        // Bind edit and delete buttons
        tbody.querySelectorAll('.edit-shift').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.editShift(e.target.dataset.id);
          });
        });

        tbody.querySelectorAll('.delete-shift').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.deleteShift(e.target.dataset.id);
          });
        });
      }

      formatTime(time24) {
        const [hours, minutes] = time24.split(':');
        const hour12 = hours % 12 || 12;
        const ampm = hours < 12 ? 'AM' : 'PM';
        return `${hour12}:${minutes} ${ampm}`;
      }

      showVehicleTypeForm() {
        this.showToast('Vehicle Type form would open here', 'info');
        // TODO: Implement vehicle type form modal
      }

      showShiftForm() {
        this.showToast('Shift Schedule form would open here', 'info');
        // TODO: Implement shift form modal
      }

      editVehicleType(id) {
        const vehicleType = this.vehicleTypes.find(v => v.id === id);
        this.showToast(`Edit ${vehicleType.name} form would open here`, 'info');
        // TODO: Implement edit vehicle type functionality
      }

      deleteVehicleType(id) {
        const vehicleType = this.vehicleTypes.find(v => v.id === id);
        if (confirm(`Are you sure you want to delete ${vehicleType.name}?`)) {
          this.vehicleTypes = this.vehicleTypes.filter(v => v.id !== id);
          this.renderVehicleTypes();
          this.showToast(`${vehicleType.name} deleted successfully`, 'success');
        }
      }

      editShift(id) {
        const shift = this.shifts.find(s => s.id === id);
        this.showToast(`Edit ${shift.name} form would open here`, 'info');
        // TODO: Implement edit shift functionality
      }

      deleteShift(id) {
        const shift = this.shifts.find(s => s.id === id);
        if (confirm(`Are you sure you want to delete ${shift.name}?`)) {
          this.shifts = this.shifts.filter(s => s.id !== id);
          this.renderShiftSchedules();
          this.showToast(`${shift.name} deleted successfully`, 'success');
        }
      }

      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
        toast.className = `fixed top-20 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => {
            toast.remove();
          }, 300);
        }, 3000);
      }
    }

    // Initialize the Vehicle Types & Shifts Manager
    window.vehicleTypesShiftsManager = new VehicleTypesShiftsManager();

    // Keyboard Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          link.click();
        }
      });
    });

    // Initial render
    function initDashboard() {
      // Show loading state immediately
      const loadingIndicator = document.getElementById('loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'flex';
      }
      
      // Initialize dashboard layout
      const grid = document.getElementById('analytics-grid');
      const widgets = Array.from(grid.children);
      grid.innerHTML = '';
      dashboardConfig.forEach(widgetId => {
        const widget = widgets.find(w => w.dataset.widget === widgetId);
        if (widget) grid.appendChild(widget);
      });
      
      // Render vehicles immediately (this will hide loading indicator)
      renderVehicleList(1, '', {}, true); // Skip heavy renders initially
      updateAnalytics();
      
      // Load heavy components after a short delay
      setTimeout(() => {
        renderUtilizationChart();
        renderMap(vehicles.slice(0, 30));
        renderAlertFeed();
      }, 200);
      
      // Start real-time updates after everything is loaded
      setTimeout(() => {
        simulateRealTimeUpdates();
        // Initialize critical monitoring
        checkCriticalAlerts();
        showToast('Enhanced fleet monitoring system activated', 'success');
      }, 600);
    }
    initDashboard();
    

  </script>
</body>
</html>