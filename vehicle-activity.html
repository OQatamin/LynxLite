<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Activity Report - Lynx Lite Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <!-- Feedback Storage System -->
  <script src="feedback-storage.js"></script>
  
  <style>
    /* Font Imports */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    /* Base Styles */
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(to bottom, #f9fafb, #e5e7eb);
      color: #1f2937;
      line-height: 1.6;
      font-size: 16px;
    }

    /* Header */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: background 0.3s ease;
    }

    /* Dark Mode Styles */
    body.dark-mode {
      background: linear-gradient(to bottom, #111827, #1f2937);
      color: #d1d5db;
    }
    body.dark-mode header {
      background: #1f2937;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
    }
    body.dark-mode .widget-card {
      background: linear-gradient(145deg, #1f2937, #111827);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      color: #d1d5db;
    }
    body.dark-mode .report-table th {
      background: #374151;
      color: #d1d5db;
    }
    body.dark-mode .report-table td {
      border-color: #374151;
    }
    body.dark-mode .report-table tr:hover {
      background: #4b5563;
    }
    body.dark-mode .bg-gray-100 {
      background: #1f2937 !important;
    }
    body.dark-mode .text-gray-500 {
      color: #9ca3af !important;
    }
    body.dark-mode .text-gray-900 {
      color: #d1d5db !important;
    }
    body.dark-mode .border-gray-300 {
      border-color: #374151 !important;
    }
    body.dark-mode .bg-blue-600 {
      background: #3b82f6 !important;
    }
    body.dark-mode .bg-gray-200 {
      background: #374151 !important;
    }

    /* Widget Card */
    .widget-card {
      background: linear-gradient(145deg, #ffffff, #f9fafb);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.05);
      border-radius: 12px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .widget-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    /* Report Table */
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    .report-table th, .report-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    .report-table th {
      background: #f3f4f6;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .report-table th:hover {
      background: #e5e7eb;
    }
    .report-table th.sort-asc::after {
      content: ' ↑';
    }
    .report-table th.sort-desc::after {
      content: ' ↓';
    }
    .report-table tr:hover {
      background: #f1f5f9;
      transition: background 0.2s ease;
    }

    /* Filter Modal */
    .filter-modal {
      transition: opacity 0.3s ease;
    }
    .filter-modal .bg-white {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      main {
        padding: 1.5rem;
      }
      .widget-card {
        padding: 1.5rem;
      }
      .report-table th, .report-table td {
        padding: 0.5rem;
        font-size: 0.9rem;
      }
      .text-2xl {
        font-size: 1.5rem;
      }
      .max-w-7xl {
        max-width: 100%;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <header class="bg-white shadow flex justify-between items-center px-6 py-4 z-30 fixed top-0 left-0 w-full" aria-label="Vehicle Activity Header">
    <div class="flex items-center space-x-4">
      <a href="index.html" class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300" aria-label="Back to Dashboard">
        <i class="fas fa-arrow-left text-xl"></i>
      </a>
      <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Vehicle Activity Report</h1>
    </div>
    <div class="flex items-center space-x-4">
      <button id="filter-toggle" class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300" aria-label="Toggle Filter" tabindex="0">
        <i class="fas fa-filter text-xl"></i>
      </button>
      <div class="relative">
        <select id="export-format" class="border border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300" aria-label="Export Format">
          <option value="csv">Export as CSV</option>
          <option value="pdf">Export as PDF</option>
        </select>
      </div>
      <button id="export-activity" class="text-blue-600 hover:text-blue-700 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300" aria-label="Export Activity" tabindex="0">
        <i class="fas fa-download mr-2"></i>Export
      </button>
      <button id="dark-mode-toggle" class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-300" aria-label="Toggle Dark Mode" tabindex="0">
        <i class="fas fa-moon text-xl"></i>
      </button>
      
      <!-- Feedback Button -->
      <div class="text-center">
        <button id="feedback-toggle" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-all hover:scale-105 shadow-lg flex items-center gap-2 font-medium" title="Submit Feedback">
          <i class="fas fa-comment-dots text-lg"></i>
          Submit Feedback
        </button>
        <p class="text-xs text-gray-500 mt-1">Feedback automatically sent to Google Sheets</p>
      </div>
    </div>
  </header>

  <!-- Filter Modal -->
  <div id="filter-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 filter-modal" role="dialog" aria-label="Filter Activity Modal">
    <div class="bg-white p-8 rounded-lg shadow-lg w-96">
      <h3 class="text-2xl font-bold text-gray-900 mb-6">Filter Activity</h3>
      <div class="space-y-6">
        <div>
          <label for="vehicle-filter" class="block text-sm font-semibold text-gray-700 mb-2">Vehicle</label>
          <select id="vehicle-filter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300" aria-label="Filter by Vehicle">
            <option value="all">All</option>
          </select>
        </div>
        <div>
          <label for="driver-filter" class="block text-sm font-semibold text-gray-700 mb-2">Driver</label>
          <select id="driver-filter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300" aria-label="Filter by Driver">
            <option value="all">All</option>
          </select>
        </div>
        <div>
          <label for="status-filter" class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
          <select id="status-filter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300" aria-label="Filter by Status">
            <option value="all">All</option>
            <option value="Driving">Driving</option>
            <option value="Idling">Idling</option>
            <option value="Parked">Parked</option>
            <option value="Offline">Offline</option>
          </select>
        </div>
        <div>
          <label for="group-filter" class="block text-sm font-semibold text-gray-700 mb-2">Vehicle Group</label>
          <select id="group-filter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300" aria-label="Filter by Group">
            <option value="all">All</option>
            <option value="Delivery">Delivery Trucks</option>
            <option value="Service">Service Vans</option>
          </select>
        </div>
        <div>
          <label for="date-range" class="block text-sm font-semibold text-gray-700 mb-2">Date Range</label>
          <select id="date-range" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300" aria-label="Filter by Date Range">
            <option value="all">All Time</option>
            <option value="24h">Last 24 Hours</option>
            <option value="7d">Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
          </select>
        </div>
        <div class="flex justify-end space-x-3">
          <button id="filter-apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition-all duration-300" tabindex="0">Apply</button>
          <button id="filter-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 focus:ring-2 focus:ring-gray-500 transition-all duration-300" tabindex="0">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <main class="pt-24 px-6 max-w-7xl mx-auto">
    <div class="widget-card p-8">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center">
          <i class="fas fa-chart-bar text-blue-600 mr-2"></i>Vehicle Activity Overview
        </h2>
        <div class="flex items-center gap-2">
          <label for="quick-date-range" class="text-sm font-semibold text-gray-700 mr-2">Period:</label>
          <select id="quick-date-range" class="border border-gray-300 px-3 py-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
            <option value="all">All Time</option>
            <option value="24h">Last 24 Hours</option>
            <option value="7d">Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
          </select>
        </div>
      </div>
             <!-- Vehicle Overview Dashboard -->
       <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
         <div class="bg-gray-100 p-4 rounded-lg">
           <h3 class="text-sm font-semibold text-gray-700">Total Vehicles</h3>
           <p id="total-vehicles" class="text-2xl font-bold text-indigo-600">0</p>
         </div>
         <div class="bg-gray-100 p-4 rounded-lg">
           <h3 class="text-sm font-semibold text-gray-700">Total Distance</h3>
           <p id="total-distance" class="text-2xl font-bold text-blue-600">0 km</p>
         </div>
         <div class="bg-gray-100 p-4 rounded-lg">
           <h3 class="text-sm font-semibold text-gray-700">Avg Fuel Efficiency</h3>
           <p id="avg-efficiency" class="text-2xl font-bold text-green-600">0 km/L</p>
         </div>
         <div class="bg-gray-100 p-4 rounded-lg">
           <h3 class="text-sm font-semibold text-gray-700">Active Vehicles</h3>
           <p id="active-vehicles" class="text-2xl font-bold text-purple-600">0</p>
         </div>
         <div class="bg-gray-100 p-4 rounded-lg">
           <h3 class="text-sm font-semibold text-gray-700">Active Alerts</h3>
           <p id="active-alerts-count" class="text-2xl font-bold text-red-600">0</p>
           <p class="text-xs text-gray-600 mt-1">Vehicles with alerts</p>
         </div>
       </div>



             <!-- Multi-Level Dashboard Navigation -->
       <div class="mb-8">
         <div class="flex items-center justify-between mb-6">
           <h3 class="text-xl font-bold text-gray-900 flex items-center">
             <i class="fas fa-layer-group text-indigo-600 mr-2"></i>Multi-Level Vehicle Dashboard
           </h3>
           <div class="flex space-x-2">
             <button id="overview-tab" class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition-colors active">
               <i class="fas fa-eye mr-1"></i>Overview
             </button>
             <button id="performance-tab" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300 transition-colors">
               <i class="fas fa-chart-line mr-1"></i>Performance
             </button>
             <button id="driver-impact-tab" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300 transition-colors">
               <i class="fas fa-user-cog mr-1"></i>Driver Impact
             </button>
             <button id="routes-tab" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300 transition-colors">
               <i class="fas fa-route mr-1"></i>Routes
             </button>
             <button id="costs-tab" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300 transition-colors">
               <i class="fas fa-dollar-sign mr-1"></i>Costs
             </button>
           </div>
         </div>
       </div>

       <!-- Overview Section (Original Vehicle Activity Content) -->
       <div id="overview-section" class="mb-8">
         <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
           <div class="col-span-1 md:col-span-2 flex justify-end mb-2">
             <label for="chart-period" class="text-sm font-semibold text-gray-700 mr-2">Chart Period:</label>
             <select id="chart-period" class="border border-gray-300 px-2 py-1 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
               <option value="24h">Last 24 Hours</option>
               <option value="7d">Last 7 Days</option>
               <option value="30d">Last 30 Days</option>
             </select>
           </div>
           <div>
             <h3 class="text-lg font-semibold text-gray-900 mb-2">Total Distance (km)</h3>
             <canvas id="distanceChart" height="120"></canvas>
           </div>
           <div>
             <h3 class="text-lg font-semibold text-gray-900 mb-2">Fuel Efficiency (km/L)</h3>
             <canvas id="efficiencyChart" height="120"></canvas>
           </div>
         </div>
         <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Vehicle Activity</h3>
         <table class="report-table">
           <thead>
             <tr>
               <th data-sort="vehicleId">Vehicle ID</th>
               <th data-sort="driver">Driver</th>
               <th data-sort="status">Status</th>
               <th data-sort="distance">Distance (km)</th>
               <th data-sort="efficiency">Fuel Efficiency (km/L)</th>
               <th data-sort="lastUpdated">Last Updated</th>
               <th data-sort="alerts">Active Alerts</th>
               <th>Actions</th>
             </tr>
           </thead>
           <tbody id="activity-table-body"></tbody>
         </table>
         <div class="flex justify-between mt-6">
           <button id="prev-page" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-300" disabled>Previous</button>
           <span id="page-info" class="text-sm text-gray-600">Page 1</span>
           <button id="next-page" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-300">Next</button>
         </div>
       </div>

      <!-- Vehicle Performance Dashboard -->
      <div id="performance-section" class="hidden mb-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-chart-line text-purple-600 mr-2"></i>Vehicle Performance Details
          </h3>
          <div class="flex space-x-2">
            <select id="performance-period" class="border border-gray-300 px-3 py-1 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="7d">Last 7 Days</option>
              <option value="30d">Last 30 Days</option>
              <option value="90d">Last 90 Days</option>
            </select>
            <button id="refresh-performance" class="px-3 py-1 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition-colors">
              <i class="fas fa-sync-alt mr-1"></i>Refresh
            </button>
          </div>
        </div>

        <!-- Performance Scorecards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-blue-800">Vehicle Performance Score</h4>
              <i class="fas fa-star text-blue-600"></i>
            </div>
            <p id="vehicle-performance-score" class="text-2xl font-bold text-blue-700">85/100</p>
            <p class="text-xs text-blue-600 mt-1">Overall vehicle rating</p>
            <div class="mt-2">
              <div class="w-full bg-blue-200 rounded-full h-2">
                <div id="performance-score-bar" class="bg-blue-600 h-2 rounded-full" style="width: 85%"></div>
              </div>
            </div>
          </div>

          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-green-800">Vehicle Efficiency Score</h4>
              <i class="fas fa-leaf text-green-600"></i>
            </div>
            <p id="vehicle-efficiency-score" class="text-2xl font-bold text-green-700">78/100</p>
            <p class="text-xs text-green-600 mt-1">Fuel & operational</p>
            <div class="mt-2">
              <div class="w-full bg-green-200 rounded-full h-2">
                <div id="efficiency-score-bar" class="bg-green-600 h-2 rounded-full" style="width: 78%"></div>
              </div>
            </div>
          </div>

          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-purple-800">Vehicle Utilization Rate</h4>
              <i class="fas fa-clock text-purple-600"></i>
            </div>
            <p id="vehicle-utilization" class="text-2xl font-bold text-purple-700">72%</p>
            <p class="text-xs text-purple-600 mt-1">Active time ratio</p>
            <div class="mt-2">
              <div class="w-full bg-purple-200 rounded-full h-2">
                <div id="utilization-bar" class="bg-purple-600 h-2 rounded-full" style="width: 72%"></div>
              </div>
            </div>
          </div>

          <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-orange-800">Vehicle Health Score</h4>
              <i class="fas fa-heartbeat text-orange-600"></i>
            </div>
            <p id="vehicle-health-score" class="text-2xl font-bold text-orange-700">91/100</p>
            <p class="text-xs text-orange-600 mt-1">Maintenance status</p>
            <div class="mt-2">
              <div class="w-full bg-orange-200 rounded-full h-2">
                <div id="health-score-bar" class="bg-orange-600 h-2 rounded-full" style="width: 91%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vehicle Performance Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-chart-bar text-blue-600 mr-2"></i>Vehicle Performance Trends
            </h4>
            <canvas id="vehiclePerformanceChart" height="200"></canvas>
          </div>

          <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-chart-pie text-green-600 mr-2"></i>Vehicle Health Distribution
            </h4>
            <canvas id="vehicleHealthChart" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Driver Impact on Vehicle Performance -->
      <div id="driver-impact-section" class="hidden mb-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-user-cog text-blue-600 mr-2"></i>Driver Impact on Vehicle Performance
          </h3>
          <div class="flex space-x-2">
            <select id="driver-impact-period" class="border border-gray-300 px-3 py-1 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="7d">Last 7 Days</option>
              <option value="30d">Last 30 Days</option>
              <option value="90d">Last 90 Days</option>
            </select>
            <button id="refresh-driver-impact" class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
              <i class="fas fa-sync-alt mr-1"></i>Refresh
            </button>
          </div>
        </div>

        <!-- Driver Impact Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-blue-800">Best Driver Impact</h4>
              <i class="fas fa-user-check text-blue-600"></i>
            </div>
            <p id="best-driver-impact" class="text-2xl font-bold text-blue-700">+15%</p>
            <p class="text-xs text-blue-600 mt-1">Efficiency improvement</p>
          </div>

          <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-red-800">Worst Driver Impact</h4>
              <i class="fas fa-user-times text-red-600"></i>
            </div>
            <p id="worst-driver-impact" class="text-2xl font-bold text-red-700">-8%</p>
            <p class="text-xs text-red-600 mt-1">Efficiency reduction</p>
          </div>

          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-green-800">Avg Driver Impact</h4>
              <i class="fas fa-users text-green-600"></i>
            </div>
            <p id="avg-driver-impact" class="text-2xl font-bold text-green-700">+3.2%</p>
            <p class="text-xs text-green-600 mt-1">Fleet average</p>
          </div>

          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-purple-800">Training Needed</h4>
              <i class="fas fa-graduation-cap text-purple-600"></i>
            </div>
            <p id="training-needed" class="text-2xl font-bold text-purple-700">12</p>
            <p class="text-xs text-purple-600 mt-1">Drivers</p>
          </div>
        </div>

        <!-- Driver-Vehicle Correlation Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-chart-scatter text-blue-600 mr-2"></i>Driver-Vehicle Efficiency Correlation
            </h4>
            <canvas id="driverVehicleCorrelationChart" height="200"></canvas>
          </div>

          <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-chart-bar text-green-600 mr-2"></i>Driver Impact by Vehicle
            </h4>
            <canvas id="driverImpactByVehicleChart" height="200"></canvas>
          </div>
        </div>

        <!-- Driver Performance Table -->
        <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
          <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-table text-purple-600 mr-2"></i>Driver Performance Impact on Vehicles
          </h4>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Driver</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Primary Vehicle</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Efficiency Impact</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Maintenance Impact</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Safety Score</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="driver-impact-table" class="bg-white divide-y divide-gray-200">
                <!-- Dynamic content will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Vehicle Route Analysis -->
      <div id="routes-section" class="hidden mb-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-route text-green-600 mr-2"></i>Vehicle Route Analysis
          </h3>
          <div class="flex space-x-2">
            <select id="route-period" class="border border-gray-300 px-3 py-1 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="7d">Last 7 Days</option>
              <option value="30d">Last 30 Days</option>
              <option value="90d">Last 90 Days</option>
            </select>
            <button id="refresh-routes" class="px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors">
              <i class="fas fa-sync-alt mr-1"></i>Refresh
            </button>
          </div>
        </div>

        <!-- Route Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-green-800">Total Routes</h4>
              <i class="fas fa-map-marked-alt text-green-600"></i>
            </div>
            <p id="total-routes" class="text-2xl font-bold text-green-700">156</p>
            <p class="text-xs text-green-600 mt-1">This period</p>
          </div>

          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-blue-800">Avg Route Efficiency</h4>
              <i class="fas fa-route text-blue-600"></i>
            </div>
            <p id="avg-route-efficiency" class="text-2xl font-bold text-blue-700">87%</p>
            <p class="text-xs text-blue-600 mt-1">Optimal vs actual</p>
          </div>

          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-purple-800">Route Optimization</h4>
              <i class="fas fa-magic text-purple-600"></i>
            </div>
            <p id="route-optimization" class="text-2xl font-bold text-purple-700">12%</p>
            <p class="text-xs text-purple-600 mt-1">Potential savings</p>
          </div>

          <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-orange-800">Idle Time</h4>
              <i class="fas fa-clock text-orange-600"></i>
            </div>
            <p id="route-idle-time" class="text-2xl font-bold text-orange-700">8.5%</p>
            <p class="text-xs text-orange-600 mt-1">Of total time</p>
          </div>
        </div>

        <!-- Route Analysis Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-chart-line text-green-600 mr-2"></i>Vehicle Route Efficiency Trends
            </h4>
            <canvas id="routeEfficiencyChart" height="200"></canvas>
          </div>

          <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-chart-bar text-blue-600 mr-2"></i>Route Performance by Vehicle
            </h4>
            <canvas id="routePerformanceChart" height="200"></canvas>
          </div>
        </div>

        <!-- Route Details Table -->
        <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
          <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-table text-purple-600 mr-2"></i>Vehicle Route Details
          </h4>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehicle</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Route Type</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distance</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Efficiency</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fuel Used</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Optimization</th>
                </tr>
              </thead>
              <tbody id="route-details-table" class="bg-white divide-y divide-gray-200">
                <!-- Dynamic content will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Vehicle Cost Analysis -->
      <div id="costs-section" class="hidden mb-8">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900 flex items-center">
            <i class="fas fa-dollar-sign text-red-600 mr-2"></i>Vehicle Operational Costs
          </h3>
          <div class="flex space-x-2">
            <select id="cost-period" class="border border-gray-300 px-3 py-1 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="7d">Last 7 Days</option>
              <option value="30d">Last 30 Days</option>
              <option value="90d">Last 90 Days</option>
            </select>
            <button id="refresh-costs" class="px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors">
              <i class="fas fa-sync-alt mr-1"></i>Refresh
            </button>
          </div>
        </div>

        <!-- Cost Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border border-red-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-red-800">Total Vehicle Costs</h4>
              <i class="fas fa-dollar-sign text-red-600"></i>
            </div>
            <p id="total-vehicle-costs" class="text-2xl font-bold text-red-700">$45,280</p>
            <p class="text-xs text-red-600 mt-1">This period</p>
          </div>

          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-blue-800">Fuel Costs</h4>
              <i class="fas fa-gas-pump text-blue-600"></i>
            </div>
            <p id="fuel-costs" class="text-2xl font-bold text-blue-700">$18,450</p>
            <p class="text-xs text-blue-600 mt-1">40.7% of total</p>
          </div>

          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-green-800">Maintenance Costs</h4>
              <i class="fas fa-tools text-green-600"></i>
            </div>
            <p id="maintenance-costs" class="text-2xl font-bold text-green-700">$12,890</p>
            <p class="text-xs text-green-600 mt-1">28.5% of total</p>
          </div>

          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-semibold text-purple-800">Operational Costs</h4>
              <i class="fas fa-cogs text-purple-600"></i>
            </div>
            <p id="operational-costs" class="text-2xl font-bold text-purple-700">$13,940</p>
            <p class="text-xs text-purple-600 mt-1">30.8% of total</p>
          </div>
        </div>

        <!-- Cost Analysis Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-chart-pie text-red-600 mr-2"></i>Vehicle Cost Breakdown
            </h4>
            <canvas id="vehicleCostBreakdownChart" height="200"></canvas>
          </div>

          <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-chart-line text-blue-600 mr-2"></i>Cost Trends by Vehicle
            </h4>
            <canvas id="vehicleCostTrendsChart" height="200"></canvas>
          </div>
        </div>

        <!-- Cost Details Table -->
        <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
          <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-table text-purple-600 mr-2"></i>Vehicle Cost Details
          </h4>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehicle</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Cost</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fuel Cost</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Maintenance</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operational</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost per km</th>
                </tr>
              </thead>
              <tbody id="vehicle-costs-table" class="bg-white divide-y divide-gray-200">
                <!-- Dynamic content will be populated here -->
              </tbody>
            </table>
                   </div>


        
     </div>
   </main>

  <!-- Alert Details Modal -->
  <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-900">Vehicle Alerts</h3>
        <button onclick="closeAlertModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div id="alert-modal-content"></div>
    </div>
  </div>

  <script>
    // Utility function to filter activities
    function filterActivities(activities) {
      return activities.filter(activity => {
        const matchesVehicle = filters.vehicle === 'all' || activity.vehicleId === filters.vehicle;
        const matchesDriver = filters.driver === 'all' || activity.driver === filters.driver;
        const matchesStatus = filters.status === 'all' || activity.status === filters.status;
        const matchesGroup = filters.group === 'all' || activity.group === filters.group;
        
        const now = new Date();
        let dateMatch = true;
        if (filters.dateRange === '24h') {
          dateMatch = (now - new Date(activity.lastUpdated)) <= 24 * 60 * 60 * 1000;
        } else if (filters.dateRange === '7d') {
          dateMatch = (now - new Date(activity.lastUpdated)) <= 7 * 24 * 60 * 60 * 1000;
        } else if (filters.dateRange === '30d') {
          dateMatch = (now - new Date(activity.lastUpdated)) <= 30 * 24 * 60 * 60 * 1000;
        }
        return matchesVehicle && matchesDriver && matchesStatus && matchesGroup && dateMatch;
      });
    }

    // Utility function to create refresh button handler
    function createRefreshHandler(calculationFunction, buttonElement) {
      return () => {
        calculationFunction();
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Refreshing...';
        setTimeout(() => {
          buttonElement.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>Refresh';
        }, 1000);
      };
    }
    // Simulated vehicle activity data with alert integration
    let vehicleActivity = Array.from({ length: 50 }, (_, i) => {
      const vehicleId = `VEHICLE-${String(i + 1).padStart(3, '0')}`;
      
      // Generate realistic alerts for some vehicles
      const alertTypes = ['camera-issues', 'black-trips', 'over-speeding', 'towing'];
      const hasAlerts = Math.random() < 0.4; // 40% of vehicles have alerts
      const alerts = hasAlerts ? Array.from({ length: Math.floor(Math.random() * 3) + 1 }, (_, j) => ({
        id: `ALERT-${i+1}-${j+1}`,
        type: alertTypes[Math.floor(Math.random() * alertTypes.length)],
        severity: ['critical', 'warning', 'info'][Math.floor(Math.random() * 3)],
        message: `Alert ${j+1} for ${vehicleId}`,
        timestamp: new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000),
        resolved: false
      })) : [];
      
      return {
        vehicleId: vehicleId,
        driver: `Driver ${i + 1}`,
        status: ['Driving', 'Idling', 'Parked', 'Offline'][Math.floor(Math.random() * 4)],
        distance: Math.floor(Math.random() * 200) + 50,
        efficiency: (7 + Math.random() * 3).toFixed(1),
        lastUpdated: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000),
        group: i < 25 ? 'Delivery' : 'Service',
        alerts: alerts
      };
    });

    // Pagination and sorting variables
    const activitiesPerPage = 10;
    let currentPage = 1;
    let sortColumn = 'vehicleId';
    let sortDirection = 'asc';
    let filters = { vehicle: 'all', driver: 'all', status: 'all', group: 'all', dateRange: 'all' };

         // Update summary metrics
     function updateSummaryMetrics(filteredActivities) {
       const totalDistance = filteredActivities.reduce((sum, a) => sum + a.distance, 0);
       const avgEfficiency = filteredActivities.length ? (filteredActivities.reduce((sum, a) => sum + parseFloat(a.efficiency), 0) / filteredActivities.length).toFixed(1) : 0;
       const activeVehicles = filteredActivities.filter(activity => activity.status === 'Driving').length;
       
       // Calculate alert statistics
       const vehiclesWithAlerts = filteredActivities.filter(activity => 
         activity.alerts && activity.alerts.some(alert => !alert.resolved)
       ).length;
       
       // Calculate total unique vehicles (stable fleet size with minimal variation)
       const allUniqueVehicles = new Set(vehicleActivity.map(activity => activity.vehicleId));
       const baseTotalVehicles = allUniqueVehicles.size;
       
       // Add minimal, predictable variation based on period
       let totalVehicles = baseTotalVehicles;
       const dateRange = document.getElementById('quick-date-range')?.value || 'all';
       
       if (dateRange === '24h') {
         // For 24 hours, show 1-2 fewer vehicles (maintenance/offline)
         totalVehicles = Math.max(baseTotalVehicles - 1, baseTotalVehicles - 2);
       } else if (dateRange === '7d') {
         // For 7 days, show the standard fleet size
         totalVehicles = baseTotalVehicles;
       } else if (dateRange === '30d') {
         // For 30 days, show 0-1 more vehicles (returning from maintenance)
         totalVehicles = baseTotalVehicles + (Math.random() > 0.5 ? 1 : 0);
       } else {
         // For all time, show the full fleet
         totalVehicles = baseTotalVehicles;
       }

       document.getElementById('total-vehicles').textContent = totalVehicles;
       document.getElementById('total-distance').textContent = `${totalDistance} km`;
       document.getElementById('avg-efficiency').textContent = `${avgEfficiency} km/L`;
       document.getElementById('active-vehicles').textContent = activeVehicles;
       document.getElementById('active-alerts-count').textContent = vehiclesWithAlerts;
     }

           // Multi-Level Dashboard Tab Navigation
      function initializeDashboardTabs() {
        const tabs = ['overview', 'performance', 'driver-impact', 'routes', 'costs'];
        
        // Hide all sections except overview initially
        tabs.forEach(tab => {
          const section = document.getElementById(`${tab}-section`);
          if (section && tab !== 'overview') {
            section.classList.add('hidden');
          }
        });
        
        tabs.forEach(tab => {
          const tabButton = document.getElementById(`${tab}-tab`);
          const section = document.getElementById(`${tab}-section`);
          
          if (tabButton && section) {
            tabButton.addEventListener('click', () => {
              console.log(`Tab clicked: ${tab}`);
              // Hide all sections
              tabs.forEach(t => {
                const s = document.getElementById(`${t}-section`);
                const b = document.getElementById(`${t}-tab`);
                if (s) s.classList.add('hidden');
                if (b) {
                  b.classList.remove('bg-indigo-600', 'text-white');
                  b.classList.add('bg-gray-200', 'text-gray-700');
                }
              });
              
              // Show selected section
              section.classList.remove('hidden');
              tabButton.classList.remove('bg-gray-200', 'text-gray-700');
              tabButton.classList.add('bg-indigo-600', 'text-white');
              console.log(`Section ${tab}-section should now be visible`);
              
                          // Load section data
            loadSectionData(tab);
            

            });
          }
        });
      }

           // Load data for each dashboard section
      function loadSectionData(section) {
        switch(section) {
          case 'overview':
            // Refresh the overview charts and table
            renderActivityTable(currentPage);
            renderCharts();
            break;
          case 'performance':
            calculateVehiclePerformance();
            break;
          case 'driver-impact':
            calculateDriverImpact();
            break;
          case 'routes':
            calculateRouteAnalysis();
            break;
                   case 'costs':
           calculateVehicleCosts();
           break;

        }
      }

     // Calculate vehicle performance metrics
     function calculateVehiclePerformance() {
       const filteredActivities = filterActivities(vehicleActivity);

       if (filteredActivities.length === 0) return;

       // Calculate performance scores
       const performanceScores = filteredActivities.map(activity => {
         let score = 0;
         const efficiency = parseFloat(activity.efficiency);
         if (efficiency >= 8) score += 40;
         else if (efficiency >= 7) score += 30;
         else if (efficiency >= 6) score += 20;
         else score += 10;

         if (activity.status === 'Driving') score += 30;
         else if (activity.status === 'Idling') score += 15;
         else if (activity.status === 'Parked') score += 10;
         else score += 5;

         const alertCount = activity.alerts ? activity.alerts.filter(alert => !alert.resolved).length : 0;
         score += Math.max(0, 30 - (alertCount * 10));

         return Math.min(score, 100);
       });

       const avgPerformanceScore = Math.round(performanceScores.reduce((sum, score) => sum + score, 0) / performanceScores.length);

       // Calculate efficiency scores
       const efficiencyScores = filteredActivities.map(activity => {
         const efficiency = parseFloat(activity.efficiency);
         const distance = activity.distance;
         const status = activity.status;
         
         let score = 0;
         if (efficiency >= 8) score += 50;
         else if (efficiency >= 7) score += 40;
         else if (efficiency >= 6) score += 30;
         else score += 20;

         if (distance > 100) score += 20;
         else if (distance > 50) score += 15;
         else score += 10;

         if (status === 'Driving') score += 30;
         else if (status === 'Idling') score += 10;
         else score += 5;

         return Math.min(score, 100);
       });

       const avgEfficiencyScore = Math.round(efficiencyScores.reduce((sum, score) => sum + score, 0) / efficiencyScores.length);

       // Calculate utilization rates
       const utilizationRates = filteredActivities.map(activity => {
         const status = activity.status;
         if (status === 'Driving') return 90;
         else if (status === 'Idling') return 60;
         else if (status === 'Parked') return 30;
         else return 10;
       });

       const avgUtilization = Math.round(utilizationRates.reduce((sum, rate) => sum + rate, 0) / utilizationRates.length);

       // Calculate health scores
       const healthScores = filteredActivities.map(activity => {
         let score = 100;
         const alertCount = activity.alerts ? activity.alerts.filter(alert => !alert.resolved).length : 0;
         score -= alertCount * 15;
         return Math.max(score, 0);
       });

       const avgHealthScore = Math.round(healthScores.reduce((sum, score) => sum + score, 0) / healthScores.length);

       // Update UI
       document.getElementById('vehicle-performance-score').textContent = `${avgPerformanceScore}/100`;
       document.getElementById('performance-score-bar').style.width = `${avgPerformanceScore}%`;

       document.getElementById('vehicle-efficiency-score').textContent = `${avgEfficiencyScore}/100`;
       document.getElementById('efficiency-score-bar').style.width = `${avgEfficiencyScore}%`;

       document.getElementById('vehicle-utilization').textContent = `${avgUtilization}%`;
       document.getElementById('utilization-bar').style.width = `${avgUtilization}%`;

       document.getElementById('vehicle-health-score').textContent = `${avgHealthScore}/100`;
       document.getElementById('health-score-bar').style.width = `${avgHealthScore}%`;

       // Render performance charts
       renderVehiclePerformanceCharts(filteredActivities);
     }

     // Calculate driver impact on vehicle performance
     function calculateDriverImpact() {
       const filteredActivities = filterActivities(vehicleActivity);

       if (filteredActivities.length === 0) return;

       // Group by driver and calculate impact
       const driverImpact = {};
       filteredActivities.forEach(activity => {
         if (!driverImpact[activity.driver]) {
           driverImpact[activity.driver] = {
             vehicleId: activity.vehicleId,
             efficiency: parseFloat(activity.efficiency),
             distance: activity.distance,
             status: activity.status,
             alertCount: activity.alerts ? activity.alerts.filter(alert => !alert.resolved).length : 0
           };
         } else {
           driverImpact[activity.driver].efficiency = (driverImpact[activity.driver].efficiency + parseFloat(activity.efficiency)) / 2;
           driverImpact[activity.driver].distance += activity.distance;
           driverImpact[activity.driver].alertCount += activity.alerts ? activity.alerts.filter(alert => !alert.resolved).length : 0;
         }
       });

       // Calculate impact scores
       const impactScores = Object.entries(driverImpact).map(([driver, data]) => {
         const baseEfficiency = 7.5; // Fleet average
         const efficiencyImpact = ((data.efficiency - baseEfficiency) / baseEfficiency) * 100;
         const maintenanceImpact = Math.max(0, 100 - (data.alertCount * 20));
         const safetyScore = Math.max(0, 100 - (data.alertCount * 15));
         
         return {
           driver,
           vehicleId: data.vehicleId,
           efficiencyImpact: Math.round(efficiencyImpact * 10) / 10,
           maintenanceImpact,
           safetyScore
         };
       });

       // Update overview cards
       const bestImpact = impactScores.reduce((max, score) => 
         score.efficiencyImpact > max.efficiencyImpact ? score : max
       );
       const worstImpact = impactScores.reduce((min, score) => 
         score.efficiencyImpact < min.efficiencyImpact ? score : min
       );
       const avgImpact = Math.round(impactScores.reduce((sum, score) => sum + score.efficiencyImpact, 0) / impactScores.length * 10) / 10;
       const trainingNeeded = impactScores.filter(score => score.efficiencyImpact < -5).length;

       document.getElementById('best-driver-impact').textContent = `+${bestImpact.efficiencyImpact}%`;
       document.getElementById('worst-driver-impact').textContent = `${worstImpact.efficiencyImpact}%`;
       document.getElementById('avg-driver-impact').textContent = `+${avgImpact}%`;
       document.getElementById('training-needed').textContent = trainingNeeded;

       // Populate driver impact table
       const tableBody = document.getElementById('driver-impact-table');
       tableBody.innerHTML = '';
       
       impactScores.forEach(score => {
         const row = document.createElement('tr');
         row.innerHTML = `
           <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${score.driver}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${score.vehicleId}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             <span class="${score.efficiencyImpact >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold">
               ${score.efficiencyImpact >= 0 ? '+' : ''}${score.efficiencyImpact}%
             </span>
           </td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             <span class="${score.maintenanceImpact >= 80 ? 'text-green-600' : score.maintenanceImpact >= 60 ? 'text-yellow-600' : 'text-red-600'} font-semibold">
               ${score.maintenanceImpact}%
             </span>
           </td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             <span class="${score.safetyScore >= 80 ? 'text-green-600' : score.safetyScore >= 60 ? 'text-yellow-600' : 'text-red-600'} font-semibold">
               ${score.safetyScore}%
             </span>
           </td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             <button class="text-indigo-600 hover:text-indigo-900">View Details</button>
           </td>
         `;
         tableBody.appendChild(row);
       });

       // Render driver impact charts
       renderDriverImpactCharts(filteredActivities, impactScores);
     }

     // Calculate route analysis
     function calculateRouteAnalysis() {
       const filteredActivities = filterActivities(vehicleActivity);

       if (filteredActivities.length === 0) return;

       // Generate route data
       const totalRoutes = filteredActivities.length;
       const avgRouteEfficiency = Math.round((filteredActivities.reduce((sum, a) => sum + parseFloat(a.efficiency), 0) / filteredActivities.length) * 10);
       const routeOptimization = Math.floor(Math.random() * 20) + 5; // 5-25% potential savings
       const routeIdleTime = Math.round((Math.random() * 15) + 5); // 5-20% idle time

       document.getElementById('total-routes').textContent = totalRoutes;
       document.getElementById('avg-route-efficiency').textContent = `${avgRouteEfficiency}%`;
       document.getElementById('route-optimization').textContent = `${routeOptimization}%`;
       document.getElementById('route-idle-time').textContent = `${routeIdleTime}%`;

       // Populate route details table
       const tableBody = document.getElementById('route-details-table');
       tableBody.innerHTML = '';
       
       const topVehicles = filteredActivities.slice(0, 10);
       topVehicles.forEach(activity => {
         const routeType = activity.group === 'Delivery' ? 'Delivery Route' : 'Service Route';
         const fuelUsed = Math.round(activity.distance / parseFloat(activity.efficiency) * 10) / 10;
         const optimization = Math.floor(Math.random() * 15) + 5;
         
         const row = document.createElement('tr');
         row.innerHTML = `
           <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${activity.vehicleId}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${routeType}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${activity.distance} km</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             <span class="${parseFloat(activity.efficiency) >= 8 ? 'text-green-600' : parseFloat(activity.efficiency) >= 7 ? 'text-yellow-600' : 'text-red-600'} font-semibold">
               ${activity.efficiency} km/L
             </span>
           </td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fuelUsed} L</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             <span class="text-blue-600 font-semibold">${optimization}%</span>
           </td>
         `;
         tableBody.appendChild(row);
       });

       // Render route analysis charts
       renderRouteAnalysisCharts(filteredActivities);
     }

     // Calculate vehicle costs
     function calculateVehicleCosts() {
       const filteredActivities = filterActivities(vehicleActivity);

       if (filteredActivities.length === 0) return;

       // Calculate costs
       const totalCosts = 45280;
       const fuelCosts = Math.round(totalCosts * 0.407);
       const maintenanceCosts = Math.round(totalCosts * 0.285);
       const operationalCosts = Math.round(totalCosts * 0.308);

       document.getElementById('total-vehicle-costs').textContent = `$${totalCosts.toLocaleString()}`;
       document.getElementById('fuel-costs').textContent = `$${fuelCosts.toLocaleString()}`;
       document.getElementById('maintenance-costs').textContent = `$${maintenanceCosts.toLocaleString()}`;
       document.getElementById('operational-costs').textContent = `$${operationalCosts.toLocaleString()}`;

       // Populate vehicle costs table
       const tableBody = document.getElementById('vehicle-costs-table');
       tableBody.innerHTML = '';
       
       const topVehicles = filteredActivities.slice(0, 10);
       topVehicles.forEach(activity => {
         const totalCost = Math.round(Math.random() * 5000) + 2000;
         const fuelCost = Math.round(totalCost * 0.4);
         const maintenanceCost = Math.round(totalCost * 0.3);
         const operationalCost = Math.round(totalCost * 0.3);
         const costPerKm = Math.round((totalCost / activity.distance) * 100) / 100;
         
         const row = document.createElement('tr');
         row.innerHTML = `
           <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${activity.vehicleId}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${totalCost.toLocaleString()}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${fuelCost.toLocaleString()}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${maintenanceCost.toLocaleString()}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${operationalCost.toLocaleString()}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             <span class="${costPerKm <= 2 ? 'text-green-600' : costPerKm <= 3 ? 'text-yellow-600' : 'text-red-600'} font-semibold">
               $${costPerKm}/km
             </span>
           </td>
         `;
         tableBody.appendChild(row);
       });

       // Render cost analysis charts
       renderVehicleCostCharts(filteredActivities);
     }

         // Render table rows with pagination
     function renderActivityTable(page = 1) {
       const tbody = document.getElementById('activity-table-body');
       tbody.innerHTML = '';

       // Apply filters
       const filteredActivities = filterActivities(vehicleActivity);

      // Sort activities
      filteredActivities.sort((a, b) => {
        let valA = a[sortColumn];
        let valB = b[sortColumn];
        if (sortColumn === 'distance' || sortColumn === 'efficiency') {
          valA = parseFloat(valA);
          valB = parseFloat(valB);
        } else if (sortColumn === 'lastUpdated') {
          valA = new Date(valA);
          valB = new Date(valB);
        }
        if (sortDirection === 'asc') {
          return valA > valB ? 1 : -1;
        } else {
          return valA < valB ? 1 : -1;
        }
      });

      // Update summary metrics
      updateSummaryMetrics(filteredActivities);

      // Paginate activities
      const start = (page - 1) * activitiesPerPage;
      const end = start + activitiesPerPage;
      const paginatedActivities = filteredActivities.slice(start, end);

      // Render table rows
      paginatedActivities.forEach(activity => {
        const tr = document.createElement('tr');
        
        // Generate alert status display
        let alertStatus = '';
        let alertCount = 0;
        let criticalAlerts = 0;
        let warningAlerts = 0;
        let infoAlerts = 0;
        
        if (activity.alerts && activity.alerts.length > 0) {
          activity.alerts.forEach(alert => {
            if (!alert.resolved) {
              alertCount++;
              if (alert.severity === 'critical') criticalAlerts++;
              else if (alert.severity === 'warning') warningAlerts++;
              else if (alert.severity === 'info') infoAlerts++;
            }
          });
          
          if (alertCount > 0) {
            alertStatus = `
              <div class="flex items-center space-x-1">
                ${criticalAlerts > 0 ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">${criticalAlerts} Critical</span>` : ''}
                ${warningAlerts > 0 ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">${warningAlerts} Warning</span>` : ''}
                ${infoAlerts > 0 ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${infoAlerts} Info</span>` : ''}
              </div>
            `;
          }
        }
        
        // Generate action buttons
        const alertButtons = alertCount > 0 ? `
          <div class="flex space-x-1 mb-1">
            <button onclick="viewAlerts('${activity.vehicleId}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
              <i class="fas fa-eye mr-1"></i>View
            </button>
            <button onclick="resolveAlerts('${activity.vehicleId}')" class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors">
              <i class="fas fa-check mr-1"></i>Resolve
            </button>
          </div>
        ` : `
          <span class="text-gray-400 text-sm mb-1 block">No alerts</span>
        `;
        
        const actionButtons = `
          ${alertButtons}
          <button onclick="analyzeVehicle('${activity.vehicleId}')" class="px-3 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700 transition-colors">
            <i class="fas fa-chart-line mr-1"></i>Analyze
          </button>
        `;
        
        tr.innerHTML = `
          <td>${activity.vehicleId}</td>
          <td>${activity.driver}</td>
          <td class="${activity.status === 'Driving' ? 'text-green-600' : activity.status === 'Idling' ? 'text-yellow-500' : activity.status === 'Parked' ? 'text-blue-600' : 'text-gray-500'}">${activity.status}</td>
          <td>${activity.distance}</td>
          <td>${activity.efficiency}</td>
          <td>${new Date(activity.lastUpdated).toLocaleString()}</td>
          <td>${alertStatus || '<span class="text-green-600 text-sm">✓ No Alerts</span>'}</td>
          <td>${actionButtons}</td>
        `;
        tbody.appendChild(tr);
      });

      // Update pagination controls
      document.getElementById('page-info').textContent = `Page ${page}`;
      document.getElementById('prev-page').disabled = page === 1;
      document.getElementById('next-page').disabled = end >= filteredActivities.length;
    }

         // Render charts
     let chartPeriod = '7d';
     function renderCharts() {
       const now = new Date();
       // Determine period in ms
       let periodMs = 7 * 24 * 60 * 60 * 1000;
       if (chartPeriod === '24h') periodMs = 24 * 60 * 60 * 1000;
       else if (chartPeriod === '30d') periodMs = 30 * 24 * 60 * 60 * 1000;

       const filteredActivities = filterActivities(vehicleActivity);

      // Aggregate by day for line chart
      const dayMap = {};
      filteredActivities.forEach(a => {
        const d = new Date(a.lastUpdated);
        const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        if (!dayMap[key]) dayMap[key] = { totalDistance: 0, totalEfficiency: 0, count: 0 };
        dayMap[key].totalDistance += a.distance;
        dayMap[key].totalEfficiency += parseFloat(a.efficiency);
        dayMap[key].count++;
      });
      const sortedDays = Object.keys(dayMap).sort();
      const distanceData = sortedDays.map(day => dayMap[day].totalDistance);
      const efficiencyData = sortedDays.map(day => dayMap[day].count ? (dayMap[day].totalEfficiency / dayMap[day].count).toFixed(2) : 0);

      // Destroy previous charts if any
      if (window._distanceChart) window._distanceChart.destroy();
      if (window._efficiencyChart) window._efficiencyChart.destroy();

      window._distanceChart = new Chart(document.getElementById('distanceChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: sortedDays,
          datasets: [{
            label: 'Total Distance (km)',
            data: distanceData,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37,99,235,0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: { enabled: true }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Distance (km)' } },
            x: { title: { display: true, text: 'Date' }, ticks: { maxTicksLimit: 10, autoSkip: true } }
          }
        }
      });
      window._efficiencyChart = new Chart(document.getElementById('efficiencyChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: sortedDays,
          datasets: [{
            label: 'Avg Fuel Efficiency (km/L)',
            data: efficiencyData,
            borderColor: '#059669',
            backgroundColor: 'rgba(16,185,129,0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: { enabled: true }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Fuel Efficiency (km/L)' } },
            x: { title: { display: true, text: 'Date' }, ticks: { maxTicksLimit: 10, autoSkip: true } }
          }
        }
      });
    }
    

    // Populate filter dropdowns
    function populateFilters() {
      const vehicleFilter = document.getElementById('vehicle-filter');
      const driverFilter = document.getElementById('driver-filter');
      const vehicles = [...new Set(vehicleActivity.map(a => a.vehicleId))];
      const drivers = [...new Set(vehicleActivity.map(a => a.driver))];
      vehicles.forEach(vehicle => {
        const option = document.createElement('option');
        option.value = vehicle;
        option.textContent = vehicle;
        vehicleFilter.appendChild(option);
      });
      drivers.forEach(driver => {
        const option = document.createElement('option');
        option.value = driver;
        option.textContent = driver;
        driverFilter.appendChild(option);
      });
    }

    // Filter controls
    const filterModal = document.getElementById('filter-modal');
    const filterToggle = document.getElementById('filter-toggle');
    const filterApply = document.getElementById('filter-apply');
    const filterCancel = document.getElementById('filter-cancel');

    filterToggle.addEventListener('click', () => filterModal.classList.toggle('hidden'));

    filterApply.addEventListener('click', () => {
      filters.vehicle = document.getElementById('vehicle-filter').value;
      filters.driver = document.getElementById('driver-filter').value;
      filters.status = document.getElementById('status-filter').value;
      filters.group = document.getElementById('group-filter').value;
      filters.dateRange = document.getElementById('date-range').value;
      currentPage = 1;
      renderActivityTable(currentPage);
      renderCharts();
      filterModal.classList.add('hidden');
    });

    filterCancel.addEventListener('click', () => {
      filterModal.classList.add('hidden');
    });

    // Sorting controls
    document.querySelectorAll('.report-table th').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.dataset.sort;
        if (sortColumn === column) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = column;
          sortDirection = 'asc';
        }
        document.querySelectorAll('.report-table th').forEach(header => {
          header.classList.remove('sort-asc', 'sort-desc');
        });
        th.classList.add(`sort-${sortDirection}`);
        renderActivityTable(currentPage);
      });
    });

    // Pagination controls
    document.getElementById('prev-page').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderActivityTable(currentPage);
      }
    });

    document.getElementById('next-page').addEventListener('click', () => {
      currentPage++;
      renderActivityTable(currentPage);
    });

         // Export activity data
     document.getElementById('export-activity').addEventListener('click', () => {
       const format = document.getElementById('export-format').value;
       const filteredActivities = filterActivities(vehicleActivity);

      if (format === 'csv') {
        const csvContent = [
          'Vehicle ID,Driver,Status,Distance (km),Fuel Efficiency (km/L),Last Updated,Group',
          ...filteredActivities.map(a => `${a.vehicleId},${a.driver},${a.status},${a.distance},${a.efficiency},${new Date(a.lastUpdated).toISOString()},${a.group}`)
        ].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'vehicle_activity.csv';
        link.click();
        URL.revokeObjectURL(link.href);
      } else if (format === 'pdf') {
        const element = document.querySelector('.widget-card');
        const opt = {
          margin: 0.5,
          filename: 'vehicle_activity_report.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().from(element).set(opt).save();
      }
    });

    // Dark mode toggle
    document.getElementById('dark-mode-toggle').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDarkMode = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode);
      document.getElementById('dark-mode-toggle').innerHTML = `<i class="fas fa-${isDarkMode ? 'sun' : 'moon'} text-xl"></i>`;
    });

    // Load dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      document.getElementById('dark-mode-toggle').innerHTML = '<i class="fas fa-sun text-xl"></i>';
    }

    // Simulated WebSocket for real-time updates
    function simulateWebSocketUpdates() {
      setInterval(() => {
        const randomIndex = Math.floor(Math.random() * vehicleActivity.length);
        const activity = vehicleActivity[randomIndex];
        activity.distance += Math.floor(Math.random() * 10);
        activity.efficiency = (7 + Math.random() * 3).toFixed(1);
        activity.status = ['Driving', 'Idling', 'Parked', 'Offline'][Math.floor(Math.random() * 4)];
        activity.lastUpdated = new Date();
        renderActivityTable(currentPage);
        renderCharts();
      }, 30000); // Simulate update every 30 seconds
    }

    // Alert action functions
    function viewAlerts(vehicleId) {
      const activity = vehicleActivity.find(a => a.vehicleId === vehicleId);
      if (!activity || !activity.alerts || activity.alerts.length === 0) {
        alert('No alerts found for this vehicle');
        return;
      }

      const modal = document.getElementById('alert-modal');
      const content = document.getElementById('alert-modal-content');
      
      let alertHtml = `
        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
          <h4 class="font-semibold text-gray-900">${activity.vehicleId} - ${activity.driver}</h4>
          <p class="text-sm text-gray-600">Current Status: <span class="font-medium">${activity.status}</span></p>
        </div>
        <div class="space-y-3">
      `;
      
      activity.alerts.forEach(alert => {
        if (!alert.resolved) {
          const severityColor = alert.severity === 'critical' ? 'red' : alert.severity === 'warning' ? 'yellow' : 'blue';
          const severityBg = alert.severity === 'critical' ? 'bg-red-50' : alert.severity === 'warning' ? 'bg-yellow-50' : 'bg-blue-50';
          const severityText = alert.severity === 'critical' ? 'text-red-800' : alert.severity === 'warning' ? 'text-yellow-800' : 'text-blue-800';
          
          alertHtml += `
            <div class="p-4 ${severityBg} border border-${severityColor}-200 rounded-lg">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="flex items-center space-x-2 mb-2">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${severityColor}-100 ${severityText}">
                      ${alert.severity.charAt(0).toUpperCase() + alert.severity.slice(1)}
                    </span>
                    <span class="text-sm text-gray-600">${alert.type.replace('-', ' ').toUpperCase()}</span>
                  </div>
                  <p class="text-gray-900 font-medium">${alert.message}</p>
                  <p class="text-sm text-gray-600 mt-1">Created: ${new Date(alert.timestamp).toLocaleString()}</p>
                </div>
                <div class="flex space-x-2">
                  <button onclick="resolveAlert('${alert.id}')" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors">
                    <i class="fas fa-check mr-1"></i>Resolve
                  </button>
                  <button onclick="viewAlertDetails('${alert.id}')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">
                    <i class="fas fa-eye mr-1"></i>Details
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      });
      
      alertHtml += '</div>';
      content.innerHTML = alertHtml;
      modal.classList.remove('hidden');
    }

    function closeAlertModal() {
      document.getElementById('alert-modal').classList.add('hidden');
    }

    function resolveAlerts(vehicleId) {
      const activity = vehicleActivity.find(a => a.vehicleId === vehicleId);
      if (!activity || !activity.alerts) return;
      
      activity.alerts.forEach(alert => {
        if (!alert.resolved) {
          alert.resolved = true;
          alert.resolvedAt = new Date();
        }
      });
      
      renderActivityTable(currentPage);
      closeAlertModal();
    }

    function resolveAlert(alertId) {
      // Find and resolve specific alert
      vehicleActivity.forEach(activity => {
        if (activity.alerts) {
          const alert = activity.alerts.find(a => a.id === alertId);
          if (alert) {
            alert.resolved = true;
            alert.resolvedAt = new Date();
          }
        }
      });
      
      renderActivityTable(currentPage);
      // Refresh modal content
      const currentVehicle = document.querySelector('#alert-modal-content h4').textContent.split(' - ')[0];
      viewAlerts(currentVehicle);
    }

    function viewAlertDetails(alertId) {
      // Navigate to active alerts page for detailed view
      window.open('active-alerts.html', '_blank');
    }

         // Chart rendering functions
     function renderVehiclePerformanceCharts(filteredActivities) {
       // Vehicle Performance Trends Chart
       const performanceCtx = document.getElementById('vehiclePerformanceChart');
       if (performanceCtx) {
         if (window._vehiclePerformanceChart) window._vehiclePerformanceChart.destroy();
         
         const top10Vehicles = filteredActivities.slice(0, 10);
         const labels = top10Vehicles.map(v => v.vehicleId);
         const performanceData = top10Vehicles.map(v => {
           const efficiency = parseFloat(v.efficiency);
           const status = v.status;
           const alertCount = v.alerts ? v.alerts.filter(alert => !alert.resolved).length : 0;
           
           let score = 0;
           if (efficiency >= 8) score += 40;
           else if (efficiency >= 7) score += 30;
           else if (efficiency >= 6) score += 20;
           else score += 10;

           if (status === 'Driving') score += 30;
           else if (status === 'Idling') score += 15;
           else if (status === 'Parked') score += 10;
           else score += 5;

           score += Math.max(0, 30 - (alertCount * 10));
           return Math.min(score, 100);
         });

         window._vehiclePerformanceChart = new Chart(performanceCtx.getContext('2d'), {
           type: 'line',
           data: {
             labels: labels,
             datasets: [{
               label: 'Performance Score',
               data: performanceData,
               borderColor: '#3b82f6',
               backgroundColor: 'rgba(59, 130, 246, 0.1)',
               fill: true,
               tension: 0.3,
               pointRadius: 4,
               pointBackgroundColor: '#3b82f6'
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { display: false },
               tooltip: { enabled: true }
             },
             scales: {
               y: { 
                 beginAtZero: true, 
                 title: { display: true, text: 'Performance Score' },
                 max: 100
               },
               x: { 
                 title: { display: true, text: 'Vehicle ID' },
                 ticks: { maxTicksLimit: 10 }
               }
             }
           }
         });
       }

       // Vehicle Health Distribution Chart
       const healthCtx = document.getElementById('vehicleHealthChart');
       if (healthCtx) {
         if (window._vehicleHealthChart) window._vehicleHealthChart.destroy();
         
         const healthCategories = ['Excellent (90-100)', 'Good (70-89)', 'Fair (50-69)', 'Poor (0-49)'];
         const healthData = [25, 35, 25, 15]; // Simulated distribution

         window._vehicleHealthChart = new Chart(healthCtx.getContext('2d'), {
           type: 'doughnut',
           data: {
             labels: healthCategories,
             datasets: [{
               data: healthData,
               backgroundColor: [
                 '#10b981', '#3b82f6', '#f59e0b', '#ef4444'
               ],
               borderWidth: 2,
               borderColor: '#ffffff'
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { 
                 position: 'bottom',
                 labels: { padding: 20 }
               },
               tooltip: { enabled: true }
             }
           }
         });
       }
     }

     function renderDriverImpactCharts(filteredActivities, impactScores) {
       // Driver-Vehicle Efficiency Correlation Chart
       const correlationCtx = document.getElementById('driverVehicleCorrelationChart');
       if (correlationCtx) {
         if (window._driverVehicleCorrelationChart) window._driverVehicleCorrelationChart.destroy();
         
         const top8Drivers = impactScores.slice(0, 8);
         const labels = top8Drivers.map(d => d.driver);
         const efficiencyData = top8Drivers.map(d => d.efficiencyImpact);

         window._driverVehicleCorrelationChart = new Chart(correlationCtx.getContext('2d'), {
           type: 'bar',
           data: {
             labels: labels,
             datasets: [{
               label: 'Efficiency Impact (%)',
               data: efficiencyData,
               backgroundColor: efficiencyData.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
               borderColor: efficiencyData.map(v => v >= 0 ? '#10b981' : '#ef4444'),
               borderWidth: 1
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { display: false },
               tooltip: { enabled: true }
             },
             scales: {
               y: { 
                 beginAtZero: true, 
                 title: { display: true, text: 'Impact (%)' }
               },
               x: { 
                 title: { display: true, text: 'Driver' },
                 ticks: { maxTicksLimit: 8 }
               }
             }
           }
         });
       }

       // Driver Impact by Vehicle Chart
       const impactCtx = document.getElementById('driverImpactByVehicleChart');
       if (impactCtx) {
         if (window._driverImpactByVehicleChart) window._driverImpactByVehicleChart.destroy();
         
         const top6Drivers = impactScores.slice(0, 6);
         const labels = top6Drivers.map(d => d.vehicleId);
         const maintenanceData = top6Drivers.map(d => d.maintenanceImpact);
         const safetyData = top6Drivers.map(d => d.safetyScore);

         window._driverImpactByVehicleChart = new Chart(impactCtx.getContext('2d'), {
           type: 'bar',
           data: {
             labels: labels,
             datasets: [
               {
                 label: 'Maintenance Impact',
                 data: maintenanceData,
                 backgroundColor: 'rgba(59, 130, 246, 0.8)',
                 borderColor: '#3b82f6',
                 borderWidth: 1
               },
               {
                 label: 'Safety Score',
                 data: safetyData,
                 backgroundColor: 'rgba(16, 185, 129, 0.8)',
                 borderColor: '#10b981',
                 borderWidth: 1
               }
             ]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { display: true },
               tooltip: { enabled: true }
             },
             scales: {
               y: { 
                 beginAtZero: true, 
                 title: { display: true, text: 'Score (%)' },
                 max: 100
               },
               x: { 
                 title: { display: true, text: 'Vehicle ID' },
                 ticks: { maxTicksLimit: 6 }
               }
             }
           }
         });
       }
     }

     function renderRouteAnalysisCharts(filteredActivities) {
       // Route Efficiency Trends Chart
       const efficiencyCtx = document.getElementById('routeEfficiencyChart');
       if (efficiencyCtx) {
         if (window._routeEfficiencyChart) window._routeEfficiencyChart.destroy();
         
         const top10Vehicles = filteredActivities.slice(0, 10);
         const labels = top10Vehicles.map(v => v.vehicleId);
         const efficiencyData = top10Vehicles.map(v => parseFloat(v.efficiency));

         window._routeEfficiencyChart = new Chart(efficiencyCtx.getContext('2d'), {
           type: 'line',
           data: {
             labels: labels,
             datasets: [{
               label: 'Route Efficiency (km/L)',
               data: efficiencyData,
               borderColor: '#10b981',
               backgroundColor: 'rgba(16, 185, 129, 0.1)',
               fill: true,
               tension: 0.3,
               pointRadius: 4,
               pointBackgroundColor: '#10b981'
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { display: false },
               tooltip: { enabled: true }
             },
             scales: {
               y: { 
                 beginAtZero: true, 
                 title: { display: true, text: 'Efficiency (km/L)' },
                 max: 10
               },
               x: { 
                 title: { display: true, text: 'Vehicle ID' },
                 ticks: { maxTicksLimit: 10 }
               }
             }
           }
         });
       }

       // Route Performance by Vehicle Chart
       const performanceCtx = document.getElementById('routePerformanceChart');
       if (performanceCtx) {
         if (window._routePerformanceChart) window._routePerformanceChart.destroy();
         
         const top8Vehicles = filteredActivities.slice(0, 8);
         const labels = top8Vehicles.map(v => v.vehicleId);
         const distanceData = top8Vehicles.map(v => v.distance);
         const optimizationData = top8Vehicles.map(() => Math.floor(Math.random() * 20) + 5);

         window._routePerformanceChart = new Chart(performanceCtx.getContext('2d'), {
           type: 'bar',
           data: {
             labels: labels,
             datasets: [
               {
                 label: 'Distance (km)',
                 data: distanceData,
                 backgroundColor: 'rgba(59, 130, 246, 0.8)',
                 borderColor: '#3b82f6',
                 borderWidth: 1,
                 yAxisID: 'y'
               },
               {
                 label: 'Optimization (%)',
                 data: optimizationData,
                 backgroundColor: 'rgba(139, 92, 246, 0.8)',
                 borderColor: '#8b5cf6',
                 borderWidth: 1,
                 yAxisID: 'y1'
               }
             ]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { display: true },
               tooltip: { enabled: true }
             },
             scales: {
               y: { 
                 type: 'linear',
                 display: true,
                 position: 'left',
                 title: { display: true, text: 'Distance (km)' }
               },
               y1: { 
                 type: 'linear',
                 display: true,
                 position: 'right',
                 title: { display: true, text: 'Optimization (%)' },
                 max: 25,
                 grid: { drawOnChartArea: false }
               },
               x: { 
                 title: { display: true, text: 'Vehicle ID' },
                 ticks: { maxTicksLimit: 8 }
               }
             }
           }
         });
       }
     }

     function renderVehicleCostCharts(filteredActivities) {
       // Vehicle Cost Breakdown Chart
       const breakdownCtx = document.getElementById('vehicleCostBreakdownChart');
       if (breakdownCtx) {
         if (window._vehicleCostBreakdownChart) window._vehicleCostBreakdownChart.destroy();
         
         const costCategories = ['Fuel Costs', 'Maintenance', 'Operational'];
         const costData = [18450, 12890, 13940];

         window._vehicleCostBreakdownChart = new Chart(breakdownCtx.getContext('2d'), {
           type: 'doughnut',
           data: {
             labels: costCategories,
             datasets: [{
               data: costData,
               backgroundColor: [
                 '#3b82f6', '#10b981', '#8b5cf6'
               ],
               borderWidth: 2,
               borderColor: '#ffffff'
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { 
                 position: 'bottom',
                 labels: { padding: 20 }
               },
               tooltip: { 
                 enabled: true,
                 callbacks: {
                   label: function(context) {
                     const total = context.dataset.data.reduce((a, b) => a + b, 0);
                     const percentage = ((context.parsed / total) * 100).toFixed(1);
                     return `${context.label}: $${context.parsed.toLocaleString()} (${percentage}%)`;
                   }
                 }
               }
             }
           }
         });
       }

       // Cost Trends by Vehicle Chart
       const trendsCtx = document.getElementById('vehicleCostTrendsChart');
       if (trendsCtx) {
         if (window._vehicleCostTrendsChart) window._vehicleCostTrendsChart.destroy();
         
         const top8Vehicles = filteredActivities.slice(0, 8);
         const labels = top8Vehicles.map(v => v.vehicleId);
         const totalCostData = top8Vehicles.map(() => Math.round(Math.random() * 5000) + 2000);
         const costPerKmData = totalCostData.map((cost, i) => Math.round((cost / filteredActivities[i].distance) * 100) / 100);

         window._vehicleCostTrendsChart = new Chart(trendsCtx.getContext('2d'), {
           type: 'line',
           data: {
             labels: labels,
             datasets: [
               {
                 label: 'Total Cost ($)',
                 data: totalCostData,
                 borderColor: '#ef4444',
                 backgroundColor: 'rgba(239, 68, 68, 0.1)',
                 fill: true,
                 tension: 0.3,
                 pointRadius: 4,
                 pointBackgroundColor: '#ef4444',
                 yAxisID: 'y'
               },
               {
                 label: 'Cost per km ($)',
                 data: costPerKmData,
                 borderColor: '#f59e0b',
                 backgroundColor: 'rgba(245, 158, 11, 0.1)',
                 fill: true,
                 tension: 0.3,
                 pointRadius: 4,
                 pointBackgroundColor: '#f59e0b',
                 yAxisID: 'y1'
               }
             ]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { display: true },
               tooltip: { enabled: true }
             },
             scales: {
               y: { 
                 type: 'linear',
                 display: true,
                 position: 'left',
                 title: { display: true, text: 'Total Cost ($)' }
               },
               y1: { 
                 type: 'linear',
                 display: true,
                 position: 'right',
                 title: { display: true, text: 'Cost per km ($)' },
                 grid: { drawOnChartArea: false }
               },
               x: { 
                 title: { display: true, text: 'Vehicle ID' },
                 ticks: { maxTicksLimit: 8 }
               }
             }
           }
         });
       }
     }

     // Event listeners for dashboard controls
     function initializeDashboardControls() {
       // Performance dashboard controls
       const performancePeriod = document.getElementById('performance-period');
       const refreshPerformance = document.getElementById('refresh-performance');
       
       if (performancePeriod) {
         performancePeriod.addEventListener('change', calculateVehiclePerformance);
       }
       
       if (refreshPerformance) {
         refreshPerformance.addEventListener('click', createRefreshHandler(calculateVehiclePerformance, refreshPerformance));
       }

       // Driver impact controls
       const driverImpactPeriod = document.getElementById('driver-impact-period');
       const refreshDriverImpact = document.getElementById('refresh-driver-impact');
       
       if (driverImpactPeriod) {
         driverImpactPeriod.addEventListener('change', calculateDriverImpact);
       }
       
       if (refreshDriverImpact) {
         refreshDriverImpact.addEventListener('click', createRefreshHandler(calculateDriverImpact, refreshDriverImpact));
       }

       // Route analysis controls
       const routePeriod = document.getElementById('route-period');
       const refreshRoutes = document.getElementById('refresh-routes');
       
       if (routePeriod) {
         routePeriod.addEventListener('change', calculateRouteAnalysis);
       }
       
       if (refreshRoutes) {
         refreshRoutes.addEventListener('click', createRefreshHandler(calculateRouteAnalysis, refreshRoutes));
       }

       // Cost analysis controls
       const costPeriod = document.getElementById('cost-period');
       const refreshCosts = document.getElementById('refresh-costs');
       
       if (costPeriod) {
         costPeriod.addEventListener('change', calculateVehicleCosts);
       }
       
                if (refreshCosts) {
           refreshCosts.addEventListener('click', createRefreshHandler(calculateVehicleCosts, refreshCosts));
         }

         // Individual vehicle controls
         const individualPeriod = document.getElementById('individual-period');
         const refreshIndividual = document.getElementById('refresh-individual');
         
         if (individualPeriod) {
           individualPeriod.addEventListener('change', () => {
             if (selectedIndividualVehicle) {
               analyzeIndividualVehicle(selectedIndividualVehicle);
             }
           });
         }
         
         if (refreshIndividual) {
           refreshIndividual.addEventListener('click', () => {
             if (selectedIndividualVehicle) {
               analyzeIndividualVehicle(selectedIndividualVehicle);
             }
             refreshIndividual.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Refreshing...';
             setTimeout(() => {
               refreshIndividual.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>Refresh';
             }, 1000);
           });
         }
     }

     // Individual vehicle analysis functions
     let selectedIndividualVehicle = null;
     
     function initializeIndividualVehicleSelectors() {
       console.log('Initializing individual vehicle selectors...');
       const vehicleSelect = document.getElementById('individual-vehicle-select');
       const vehicleAnalysisSelect = document.getElementById('individual-vehicle-analysis');
       const viewDetailsBtn = document.getElementById('view-vehicle-details');
       const analyzeBtn = document.getElementById('analyze-vehicle');
       
       console.log('Vehicle select elements found:', { vehicleSelect, vehicleAnalysisSelect });
       console.log('Vehicle activity data length:', vehicleActivity.length);
       
       // Populate vehicle selectors
       const vehicles = [...new Set(vehicleActivity.map(a => a.vehicleId))];
       console.log('Unique vehicles found:', vehicles);
       
       [vehicleSelect, vehicleAnalysisSelect].forEach(select => {
         if (select) {
           select.innerHTML = '<option value="">Select a vehicle</option>';
           vehicles.forEach(vehicle => {
             const option = document.createElement('option');
             option.value = vehicle;
             option.textContent = vehicle;
             select.appendChild(option);
           });
           console.log(`Populated ${select.id} with ${vehicles.length} vehicles`);
         } else {
           console.log(`Select element not found for: ${select}`);
         }
       });
       
       // Quick vehicle selector (top of page)
       if (vehicleSelect) {
         vehicleSelect.addEventListener('change', (e) => {
           const vehicleId = e.target.value;
           if (vehicleId) {
             showQuickVehicleStats(vehicleId);
             viewDetailsBtn.disabled = false;
           } else {
             hideQuickVehicleStats();
             viewDetailsBtn.disabled = true;
           }
         });
       }
       
       
       
       // Individual analysis selector
       if (vehicleAnalysisSelect) {
         vehicleAnalysisSelect.addEventListener('change', (e) => {
           const vehicleId = e.target.value;
           analyzeBtn.disabled = !vehicleId;
         });
       }
       
       // Analyze button
       if (analyzeBtn) {
         analyzeBtn.addEventListener('click', () => {
           const vehicleId = vehicleAnalysisSelect.value;
           if (vehicleId) {
             analyzeIndividualVehicle(vehicleId);
           }
         });
       }
     }
     
     function showQuickVehicleStats(vehicleId) {
       const vehicle = vehicleActivity.find(v => v.vehicleId === vehicleId);
       if (!vehicle) return;
       
       document.getElementById('selected-vehicle-id').textContent = vehicleId;
       document.getElementById('selected-vehicle-status').textContent = vehicle.status;
       document.getElementById('selected-vehicle-distance').textContent = `${vehicle.distance} km`;
       document.getElementById('selected-vehicle-efficiency').textContent = `${vehicle.efficiency} km/L`;
       
       document.getElementById('quick-vehicle-stats').classList.remove('hidden');
     }
     
     function hideQuickVehicleStats() {
       document.getElementById('quick-vehicle-stats').classList.add('hidden');
     }
     
     function analyzeIndividualVehicle(vehicleId) {
       console.log('analyzeIndividualVehicle called with vehicleId:', vehicleId);
       selectedIndividualVehicle = vehicleId;
       const vehicle = vehicleActivity.find(v => v.vehicleId === vehicleId);
       if (!vehicle) {
         console.log('Vehicle not found in vehicleActivity data');
         return;
       }
       console.log('Vehicle found:', vehicle);
       
       // Update header
       document.getElementById('individual-vehicle-title').textContent = `${vehicleId} Analysis`;
       document.getElementById('individual-vehicle-subtitle').textContent = `Driver: ${vehicle.driver}`;
       
       // Update status badges
       const statusElement = document.getElementById('individual-vehicle-status');
       statusElement.textContent = vehicle.status;
       statusElement.className = `px-3 py-1 rounded-full text-sm font-medium ${
         vehicle.status === 'Driving' ? 'bg-green-100 text-green-800' :
         vehicle.status === 'Idling' ? 'bg-yellow-100 text-yellow-800' :
         vehicle.status === 'Parked' ? 'bg-blue-100 text-blue-800' :
         'bg-gray-100 text-gray-800'
       }`;
       
       document.getElementById('individual-vehicle-group').textContent = vehicle.group;
       
       // Calculate individual metrics
       const period = document.getElementById('individual-period').value;
       const individualData = calculateIndividualVehicleMetrics(vehicleId, period);
       
       // Update metrics
       document.getElementById('individual-total-distance').textContent = `${individualData.totalDistance} km`;
       document.getElementById('individual-fuel-efficiency').textContent = `${individualData.avgEfficiency} km/L`;
       document.getElementById('individual-active-time').textContent = `${individualData.activeTime}%`;
       document.getElementById('individual-health-score').textContent = `${individualData.healthScore}/100`;
       
       // Render charts
       renderIndividualVehicleCharts(vehicleId, period);
       
       // Populate activity table
       populateIndividualActivityTable(vehicleId, period);
       
       // Show dashboard
       const dashboard = document.getElementById('individual-dashboard');
       if (dashboard) {
         dashboard.classList.remove('hidden');
         console.log('Individual dashboard should now be visible');
       } else {
         console.log('Individual dashboard element not found when trying to show it');
       }
     }
     
     function calculateIndividualVehicleMetrics(vehicleId, period) {
       // Simulate individual vehicle data for the selected period
       const baseVehicle = vehicleActivity.find(v => v.vehicleId === vehicleId);
       if (!baseVehicle) return { totalDistance: 0, avgEfficiency: 0, activeTime: 0, healthScore: 0 };
       
       // Generate historical data for the vehicle
       const days = period === '24h' ? 1 : period === '7d' ? 7 : period === '30d' ? 30 : 90;
       const historicalData = Array.from({ length: days }, (_, i) => ({
         date: new Date(Date.now() - (days - i - 1) * 24 * 60 * 60 * 1000),
         distance: Math.floor(Math.random() * 200) + 50,
         efficiency: (7 + Math.random() * 3).toFixed(1),
         status: ['Driving', 'Idling', 'Parked', 'Offline'][Math.floor(Math.random() * 4)],
         alerts: Math.random() < 0.3 ? Math.floor(Math.random() * 3) : 0
       }));
       
       const totalDistance = historicalData.reduce((sum, d) => sum + d.distance, 0);
       const avgEfficiency = (historicalData.reduce((sum, d) => sum + parseFloat(d.efficiency), 0) / historicalData.length).toFixed(1);
       const activeTime = Math.round((historicalData.filter(d => d.status === 'Driving').length / historicalData.length) * 100);
       const healthScore = Math.max(0, 100 - (historicalData.reduce((sum, d) => sum + d.alerts, 0) * 15));
       
       return { totalDistance, avgEfficiency, activeTime, healthScore };
     }
     
     function renderIndividualVehicleCharts(vehicleId, period) {
       // Performance Trends Chart
       const performanceCtx = document.getElementById('individualPerformanceChart');
       if (performanceCtx) {
         if (window._individualPerformanceChart) window._individualPerformanceChart.destroy();
         
         const days = period === '24h' ? 1 : period === '7d' ? 7 : period === '30d' ? 30 : 90;
         const labels = Array.from({ length: days }, (_, i) => {
           const date = new Date(Date.now() - (days - i - 1) * 24 * 60 * 60 * 1000);
           return date.toLocaleDateString();
         });
         
         const performanceData = Array.from({ length: days }, () => Math.floor(Math.random() * 100) + 20);
         
         window._individualPerformanceChart = new Chart(performanceCtx.getContext('2d'), {
           type: 'line',
           data: {
             labels: labels,
             datasets: [{
               label: 'Performance Score',
               data: performanceData,
               borderColor: '#3b82f6',
               backgroundColor: 'rgba(59, 130, 246, 0.1)',
               fill: true,
               tension: 0.3,
               pointRadius: 3
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { display: false },
               tooltip: { enabled: true }
             },
             scales: {
               y: { 
                 beginAtZero: true, 
                 title: { display: true, text: 'Performance Score' },
                 max: 100
               },
               x: { 
                 title: { display: true, text: 'Date' },
                 ticks: { maxTicksLimit: 10 }
               }
             }
           }
         });
       }
       
       // Status Distribution Chart
       const statusCtx = document.getElementById('individualStatusChart');
       if (statusCtx) {
         if (window._individualStatusChart) window._individualStatusChart.destroy();
         
         const statusData = {
           'Driving': Math.floor(Math.random() * 40) + 30,
           'Idling': Math.floor(Math.random() * 20) + 10,
           'Parked': Math.floor(Math.random() * 30) + 20,
           'Offline': Math.floor(Math.random() * 10) + 5
         };
         
         window._individualStatusChart = new Chart(statusCtx.getContext('2d'), {
           type: 'doughnut',
           data: {
             labels: Object.keys(statusData),
             datasets: [{
               data: Object.values(statusData),
               backgroundColor: [
                 '#10b981', '#f59e0b', '#3b82f6', '#6b7280'
               ],
               borderWidth: 2,
               borderColor: '#ffffff'
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { 
                 position: 'bottom',
                 labels: { padding: 20 }
               },
               tooltip: { enabled: true }
             }
           }
         });
       }
     }
     
     function populateIndividualActivityTable(vehicleId, period) {
       const tableBody = document.getElementById('individual-activity-table');
       tableBody.innerHTML = '';
       
       const days = period === '24h' ? 1 : period === '7d' ? 7 : period === '30d' ? 30 : 90;
       const baseVehicle = vehicleActivity.find(v => v.vehicleId === vehicleId);
       
       for (let i = days - 1; i >= 0; i--) {
         const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
         const distance = Math.floor(Math.random() * 200) + 50;
         const efficiency = (7 + Math.random() * 3).toFixed(1);
         const status = ['Driving', 'Idling', 'Parked', 'Offline'][Math.floor(Math.random() * 4)];
         const alerts = Math.random() < 0.3 ? Math.floor(Math.random() * 3) : 0;
         
         const row = document.createElement('tr');
         row.innerHTML = `
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${date.toLocaleDateString()}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${baseVehicle.driver}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             <span class="px-2 py-1 rounded-full text-xs font-medium ${
               status === 'Driving' ? 'bg-green-100 text-green-800' :
               status === 'Idling' ? 'bg-yellow-100 text-yellow-800' :
               status === 'Parked' ? 'bg-blue-100 text-blue-800' :
               'bg-gray-100 text-gray-800'
             }">${status}</span>
           </td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${distance} km</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${efficiency} km/L</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             ${alerts > 0 ? 
               `<span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">${alerts} alerts</span>` :
               '<span class="text-green-600 text-sm">✓ No alerts</span>'
             }
           </td>
         `;
         tableBody.appendChild(row);
       }
     }

     // Individual Vehicle Analysis Modal
     function analyzeVehicle(vehicleId) {
       console.log('analyzeVehicle called with vehicleId:', vehicleId);
       const vehicle = vehicleActivity.find(v => v.vehicleId === vehicleId);
       if (!vehicle) {
         console.log('Vehicle not found in vehicleActivity data');
         return;
       }
       
       // Show modal
       const modal = document.getElementById('vehicle-analysis-modal');
       modal.classList.remove('hidden');
       
       // Update modal header
       document.getElementById('modal-vehicle-title').textContent = `${vehicleId} Analysis`;
       document.getElementById('modal-vehicle-subtitle').textContent = `Driver: ${vehicle.driver}`;
       
       // Update status badges
       const statusElement = document.getElementById('modal-vehicle-status');
       statusElement.textContent = vehicle.status;
       statusElement.className = `px-3 py-1 rounded-full text-sm font-medium ${
         vehicle.status === 'Driving' ? 'bg-green-100 text-green-800' :
         vehicle.status === 'Idling' ? 'bg-yellow-100 text-yellow-800' :
         vehicle.status === 'Parked' ? 'bg-blue-100 text-blue-800' :
         'bg-gray-100 text-gray-800'
       }`;
       
       document.getElementById('modal-vehicle-group').textContent = vehicle.group;
       
       // Calculate and display metrics
       const metrics = calculateIndividualVehicleMetrics(vehicleId, '7d');
       document.getElementById('modal-total-distance').textContent = `${metrics.totalDistance} km`;
       document.getElementById('modal-fuel-efficiency').textContent = `${metrics.avgEfficiency} km/L`;
       document.getElementById('modal-active-time').textContent = `${metrics.activeTime}%`;
       document.getElementById('modal-health-score').textContent = `${metrics.healthScore}/100`;
       
       // Calculate and display maintenance predictions
       const maintenancePredictions = calculateMaintenancePredictions(vehicleId, metrics);
       displayMaintenancePredictions(maintenancePredictions);
       
       // Calculate and display breakdown risk assessment
       const riskAssessment = calculateBreakdownRisk(vehicleId, metrics, maintenancePredictions);
       displayBreakdownRisk(riskAssessment);
       
       // Store data for export
       window.currentVehicleAnalysis = {
         vehicleId,
         metrics,
         maintenancePredictions,
         riskAssessment,
         currentPerformancePeriod: '7' // Default period
       };
       
       // Render modal charts
       renderModalCharts(vehicleId, '7d');
       
       // Populate modal activity table
       populateModalActivityTable(vehicleId, '7d');
       
       // Add event listener for activity period selector
       const activityPeriodSelector = document.getElementById('activity-period-selector');
       if (activityPeriodSelector) {
         activityPeriodSelector.addEventListener('change', (e) => {
           const selectedPeriod = e.target.value;
           populateModalActivityTable(vehicleId, selectedPeriod);
         });
       }
       
       // Add event listener for performance period selector
       const performancePeriodSelector = document.getElementById('performance-period-selector');
       if (performancePeriodSelector) {
         performancePeriodSelector.addEventListener('change', (e) => {
           const selectedPeriod = e.target.value;
           renderModalCharts(vehicleId, selectedPeriod);
           
           // Update current performance period for export
           if (window.currentVehicleAnalysis) {
             window.currentVehicleAnalysis.currentPerformancePeriod = selectedPeriod;
           }
         });
       }
     }
     
     function closeVehicleAnalysisModal() {
       document.getElementById('vehicle-analysis-modal').classList.add('hidden');
     }
     
     function exportVehicleReport() {
       const vehicleId = document.getElementById('modal-vehicle-title').textContent.split(' ')[0];
       const vehicle = vehicleActivity.find(v => v.vehicleId === vehicleId);
       if (!vehicle) {
         alert('Vehicle data not found');
         return;
       }
       
       // Get current metrics
       const totalDistance = document.getElementById('modal-total-distance').textContent;
       const fuelEfficiency = document.getElementById('modal-fuel-efficiency').textContent;
       const activeTime = document.getElementById('modal-active-time').textContent;
       const healthScore = document.getElementById('modal-health-score').textContent;
       const status = document.getElementById('modal-vehicle-status').textContent;
       const group = document.getElementById('modal-vehicle-group').textContent;
       const driver = document.getElementById('modal-vehicle-subtitle').textContent.split(': ')[1];
       
       // Get current activity data and generate comprehensive history for export
       const currentPeriod = window.currentVehicleAnalysis?.currentActivityPeriod || '7';
       const currentActivityData = window.currentVehicleAnalysis?.activityHistory || [];
       
       // Generate comprehensive historical data for export (always include full history)
       const comprehensiveActivityData = generateHistoricalActivityData(vehicleId, 'all');
       
       // Use current period data for display, but comprehensive data for export
       const activityData = currentActivityData.length > 0 ? currentActivityData : comprehensiveActivityData;
       
       // Create comprehensive report
       const report = {
         vehicleId: vehicleId,
         driver: driver,
         status: status,
         group: group,
         reportDate: new Date().toLocaleDateString(),
         reportTime: new Date().toLocaleTimeString(),
         metrics: {
           totalDistance: totalDistance,
           fuelEfficiency: fuelEfficiency,
           activeTime: activeTime,
           healthScore: healthScore
         },
         activityHistory: {
           currentPeriod: {
             period: currentPeriod,
             data: currentActivityData,
             summary: {
               totalActivities: currentActivityData.length,
               averageDistance: calculateAverageDistance(currentActivityData),
               averageEfficiency: calculateAverageEfficiency(currentActivityData),
               statusBreakdown: calculateStatusBreakdown(currentActivityData),
               alertSummary: calculateAlertSummary(currentActivityData)
             }
           },
           comprehensiveHistory: {
             data: comprehensiveActivityData,
             summary: {
               totalActivities: comprehensiveActivityData.length,
               averageDistance: calculateAverageDistance(comprehensiveActivityData),
               averageEfficiency: calculateAverageEfficiency(comprehensiveActivityData),
               statusBreakdown: calculateStatusBreakdown(comprehensiveActivityData),
               alertSummary: calculateAlertSummary(comprehensiveActivityData)
             }
           }
         },
         predictiveAnalytics: window.currentVehicleAnalysis ? {
           maintenancePredictions: window.currentVehicleAnalysis.maintenancePredictions,
           riskAssessment: window.currentVehicleAnalysis.riskAssessment
         } : null,
         performanceTrends: {
           currentPeriod: {
             period: window.currentVehicleAnalysis?.currentPerformancePeriod || '7',
             data: generatePerformanceTrendData(vehicleId, parseInt(window.currentVehicleAnalysis?.currentPerformancePeriod || '7')),
             labels: generateChartLabels(parseInt(window.currentVehicleAnalysis?.currentPerformancePeriod || '7'))
           },
           comprehensiveHistory: {
             data: generatePerformanceTrendData(vehicleId, 365),
             labels: generateChartLabels(365)
           }
         }
       };
       
       const exportFormat = document.getElementById('export-format').value;
       const timestamp = new Date().toISOString().split('T')[0];
       
       if (exportFormat === 'json') {
         // Export as JSON
         const jsonData = JSON.stringify(report, null, 2);
         const blob = new Blob([jsonData], { type: 'application/json' });
         const url = URL.createObjectURL(blob);
         const link = document.createElement('a');
         link.href = url;
         link.download = `${vehicleId}_analysis_report_${timestamp}.json`;
         document.body.appendChild(link);
         link.click();
         document.body.removeChild(link);
         URL.revokeObjectURL(url);
       } else if (exportFormat === 'text') {
         // Export as formatted text
         const textReport = generateTextReport(report);
         const textBlob = new Blob([textReport], { type: 'text/plain' });
         const textUrl = URL.createObjectURL(textBlob);
         const textLink = document.createElement('a');
         textLink.href = textUrl;
         textLink.download = `${vehicleId}_analysis_report_${timestamp}.txt`;
         document.body.appendChild(textLink);
         textLink.click();
         document.body.removeChild(textLink);
         URL.revokeObjectURL(textUrl);
       } else if (exportFormat === 'pdf') {
         // Export as PDF
         exportAsPDF(report, vehicleId, timestamp);
       }
       
       // Show success message
       showExportSuccessMessage();
     }
     
     function exportAsPDF(report, vehicleId, timestamp) {
       // Create a temporary container for PDF generation
       const pdfContainer = document.createElement('div');
       pdfContainer.style.position = 'absolute';
       pdfContainer.style.left = '-9999px';
       pdfContainer.style.top = '0';
       pdfContainer.style.width = '800px';
       pdfContainer.style.backgroundColor = 'white';
       pdfContainer.style.padding = '40px';
       pdfContainer.style.fontFamily = 'Arial, sans-serif';
       pdfContainer.style.fontSize = '12px';
       pdfContainer.style.lineHeight = '1.4';
       
       const statusBreakdown = Object.entries(report.summary.statusBreakdown)
         .map(([status, count]) => `${status}: ${count}`)
         .join(', ');
       
       pdfContainer.innerHTML = `
         <div style="text-align: center; margin-bottom: 30px;">
           <h1 style="color: #1f2937; margin: 0; font-size: 24px;">VEHICLE ANALYSIS REPORT</h1>
           <p style="color: #6b7280; margin: 5px 0;">Generated on ${report.reportDate} at ${report.reportTime}</p>
         </div>
         
         <div style="margin-bottom: 30px;">
           <h2 style="color: #1f2937; border-bottom: 2px solid #3b82f6; padding-bottom: 5px; margin-bottom: 15px;">VEHICLE INFORMATION</h2>
           <table style="width: 100%; border-collapse: collapse;">
             <tr><td style="padding: 5px; font-weight: bold; width: 150px;">Vehicle ID:</td><td style="padding: 5px;">${report.vehicleId}</td></tr>
             <tr><td style="padding: 5px; font-weight: bold;">Driver:</td><td style="padding: 5px;">${report.driver}</td></tr>
             <tr><td style="padding: 5px; font-weight: bold;">Current Status:</td><td style="padding: 5px;">${report.status}</td></tr>
             <tr><td style="padding: 5px; font-weight: bold;">Group:</td><td style="padding: 5px;">${report.group}</td></tr>
           </table>
         </div>
         
         <div style="margin-bottom: 30px;">
           <h2 style="color: #1f2937; border-bottom: 2px solid #10b981; padding-bottom: 5px; margin-bottom: 15px;">PERFORMANCE METRICS</h2>
           <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
             <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
               <h3 style="margin: 0 0 10px 0; color: #1e40af;">Total Distance</h3>
               <p style="font-size: 18px; font-weight: bold; margin: 0; color: #1e40af;">${report.metrics.totalDistance}</p>
             </div>
             <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
               <h3 style="margin: 0 0 10px 0; color: #166534;">Fuel Efficiency</h3>
               <p style="font-size: 18px; font-weight: bold; margin: 0; color: #166534;">${report.metrics.fuelEfficiency}</p>
             </div>
             <div style="background: #faf5ff; padding: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
               <h3 style="margin: 0 0 10px 0; color: #6b21a8;">Active Time</h3>
               <p style="font-size: 18px; font-weight: bold; margin: 0; color: #6b21a8;">${report.metrics.activeTime}</p>
             </div>
             <div style="background: #fff7ed; padding: 15px; border-radius: 8px; border-left: 4px solid #f97316;">
               <h3 style="margin: 0 0 10px 0; color: #c2410c;">Health Score</h3>
               <p style="font-size: 18px; font-weight: bold; margin: 0; color: #c2410c;">${report.metrics.healthScore}</p>
             </div>
           </div>
         </div>
         
         <div style="margin-bottom: 30px;">
           <h2 style="color: #1f2937; border-bottom: 2px solid #8b5cf6; padding-bottom: 5px; margin-bottom: 15px;">CURRENT PERIOD SUMMARY (${report.activityHistory.currentPeriod.period} days)</h2>
           <table style="width: 100%; border-collapse: collapse; border: 1px solid #d1d5db;">
             <tr style="background: #f9fafb;">
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Total Activities</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.currentPeriod.summary.totalActivities}</td>
             </tr>
             <tr>
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Average Distance</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.currentPeriod.summary.averageDistance}</td>
             </tr>
             <tr style="background: #f9fafb;">
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Average Efficiency</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.currentPeriod.summary.averageEfficiency}</td>
             </tr>
             <tr>
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Status Breakdown</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${currentStatusBreakdown}</td>
             </tr>
             <tr style="background: #f9fafb;">
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Total Alerts</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.currentPeriod.summary.alertSummary.totalAlerts}</td>
             </tr>
             <tr>
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Critical Alerts</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.currentPeriod.summary.alertSummary.criticalAlerts}</td>
             </tr>
             <tr style="background: #f9fafb;">
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Warning Alerts</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.currentPeriod.summary.alertSummary.warningAlerts}</td>
             </tr>
           </table>
         </div>
         
         <div style="margin-bottom: 30px;">
           <h2 style="color: #1f2937; border-bottom: 2px solid #f97316; padding-bottom: 5px; margin-bottom: 15px;">COMPREHENSIVE HISTORY SUMMARY (Since Onboarding)</h2>
           <table style="width: 100%; border-collapse: collapse; border: 1px solid #d1d5db;">
             <tr style="background: #f9fafb;">
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Total Activities</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.comprehensiveHistory.summary.totalActivities}</td>
             </tr>
             <tr>
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Average Distance</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.comprehensiveHistory.summary.averageDistance}</td>
             </tr>
             <tr style="background: #f9fafb;">
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Average Efficiency</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.comprehensiveHistory.summary.averageEfficiency}</td>
             </tr>
             <tr>
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Status Breakdown</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${comprehensiveStatusBreakdown}</td>
             </tr>
             <tr style="background: #f9fafb;">
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Total Alerts</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.comprehensiveHistory.summary.alertSummary.totalAlerts}</td>
             </tr>
             <tr>
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Critical Alerts</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.comprehensiveHistory.summary.alertSummary.criticalAlerts}</td>
             </tr>
             <tr style="background: #f9fafb;">
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Warning Alerts</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.activityHistory.comprehensiveHistory.summary.alertSummary.warningAlerts}</td>
             </tr>
           </table>
         </div>
         
         <div style="margin-bottom: 30px;">
           <h2 style="color: #1f2937; border-bottom: 2px solid #f97316; padding-bottom: 5px; margin-bottom: 15px;">DETAILED ACTIVITY HISTORY (Current Period)</h2>
           <table style="width: 100%; border-collapse: collapse; border: 1px solid #d1d5db; font-size: 10px;">
             <thead>
               <tr style="background: #f3f4f6;">
                 <th style="padding: 6px; border: 1px solid #d1d5db; text-align: left;">Date</th>
                 <th style="padding: 6px; border: 1px solid #d1d5db; text-align: left;">Driver</th>
                 <th style="padding: 6px; border: 1px solid #d1d5db; text-align: left;">Status</th>
                 <th style="padding: 6px; border: 1px solid #d1d5db; text-align: left;">Distance</th>
                 <th style="padding: 6px; border: 1px solid #d1d5db; text-align: left;">Efficiency</th>
                 <th style="padding: 6px; border: 1px solid #d1d5db; text-align: left;">Alerts</th>
               </tr>
             </thead>
             <tbody>
               ${report.activityHistory.currentPeriod.data.map(activity => `
                 <tr>
                   <td style="padding: 6px; border: 1px solid #d1d5db;">${activity.date}</td>
                   <td style="padding: 6px; border: 1px solid #d1d5db;">${activity.driver}</td>
                   <td style="padding: 6px; border: 1px solid #d1d5db;">${activity.status}</td>
                   <td style="padding: 6px; border: 1px solid #d1d5db;">${activity.distance}</td>
                   <td style="padding: 6px; border: 1px solid #d1d5db;">${activity.efficiency}</td>
                   <td style="padding: 6px; border: 1px solid #d1d5db;">${activity.alerts}</td>
                 </tr>
               `).join('')}
             </tbody>
           </table>
         </div>
         
         <div style="margin-bottom: 30px;">
           <h2 style="color: #1f2937; border-bottom: 2px solid #10b981; padding-bottom: 5px; margin-bottom: 15px;">PERFORMANCE TRENDS ANALYSIS</h2>
           <table style="width: 100%; border-collapse: collapse; border: 1px solid #d1d5db;">
             <tr style="background: #f9fafb;">
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Current Period Average</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${Math.round(report.performanceTrends.currentPeriod.data.reduce((sum, val) => sum + val, 0) / report.performanceTrends.currentPeriod.data.length)}/100</td>
             </tr>
             <tr>
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Comprehensive Average</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${Math.round(report.performanceTrends.comprehensiveHistory.data.reduce((sum, val) => sum + val, 0) / report.performanceTrends.comprehensiveHistory.data.length)}/100</td>
             </tr>
             <tr style="background: #f9fafb;">
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Trend Direction</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${Math.round(report.performanceTrends.currentPeriod.data.reduce((sum, val) => sum + val, 0) / report.performanceTrends.currentPeriod.data.length) > Math.round(report.performanceTrends.comprehensiveHistory.data.reduce((sum, val) => sum + val, 0) / report.performanceTrends.comprehensiveHistory.data.length) ? 'Improving' : Math.round(report.performanceTrends.currentPeriod.data.reduce((sum, val) => sum + val, 0) / report.performanceTrends.currentPeriod.data.length) < Math.round(report.performanceTrends.comprehensiveHistory.data.reduce((sum, val) => sum + val, 0) / report.performanceTrends.comprehensiveHistory.data.length) ? 'Declining' : 'Stable'}</td>
             </tr>
             <tr>
               <td style="padding: 8px; border: 1px solid #d1d5db; font-weight: bold;">Performance Records</td>
               <td style="padding: 8px; border: 1px solid #d1d5db;">${report.performanceTrends.comprehensiveHistory.data.length} total records</td>
             </tr>
           </table>
         </div>
         
         <div style="margin-bottom: 30px;">
           <h2 style="color: #1f2937; border-bottom: 2px solid #f97316; padding-bottom: 5px; margin-bottom: 15px;">COMPREHENSIVE ACTIVITY HISTORY (Since Onboarding)</h2>
           <table style="width: 100%; border-collapse: collapse; border: 1px solid #d1d5db; font-size: 8px;">
             <thead>
               <tr style="background: #f3f4f6;">
                 <th style="padding: 4px; border: 1px solid #d1d5db; text-align: left;">Date</th>
                 <th style="padding: 4px; border: 1px solid #d1d5db; text-align: left;">Driver</th>
                 <th style="padding: 4px; border: 1px solid #d1d5db; text-align: left;">Status</th>
                 <th style="padding: 4px; border: 1px solid #d1d5db; text-align: left;">Distance</th>
                 <th style="padding: 4px; border: 1px solid #d1d5db; text-align: left;">Efficiency</th>
                 <th style="padding: 4px; border: 1px solid #d1d5db; text-align: left;">Alerts</th>
               </tr>
             </thead>
             <tbody>
               ${report.activityHistory.comprehensiveHistory.data.map(activity => `
                 <tr>
                   <td style="padding: 4px; border: 1px solid #d1d5db;">${activity.date}</td>
                   <td style="padding: 4px; border: 1px solid #d1d5db;">${activity.driver}</td>
                   <td style="padding: 4px; border: 1px solid #d1d5db;">${activity.status}</td>
                   <td style="padding: 4px; border: 1px solid #d1d5db;">${activity.distance}</td>
                   <td style="padding: 4px; border: 1px solid #d1d5db;">${activity.efficiency}</td>
                   <td style="padding: 4px; border: 1px solid #d1d5db;">${activity.alerts}</td>
                 </tr>
               `).join('')}
             </tbody>
           </table>
         </div>
         
         <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #d1d5db; color: #6b7280;">
           <p style="margin: 0;">Report generated on ${report.reportDate} at ${report.reportTime}</p>
         </div>
       `;
       
       document.body.appendChild(pdfContainer);
       
       // Use html2pdf to generate PDF
       const opt = {
         margin: 0.5,
         filename: `${vehicleId}_analysis_report_${timestamp}.pdf`,
         image: { type: 'jpeg', quality: 0.98 },
         html2canvas: { scale: 2 },
         jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
       };
       
       html2pdf().from(pdfContainer).set(opt).save().then(() => {
         // Remove the temporary container
         document.body.removeChild(pdfContainer);
       });
     }
     
     function calculateMaintenancePredictions(vehicleId, metrics) {
       // Simulate maintenance prediction based on vehicle usage patterns
       const totalDistance = parseInt(metrics.totalDistance);
       const avgEfficiency = parseFloat(metrics.avgEfficiency);
       const activeTime = parseInt(metrics.activeTime);
       
       // Base intervals (in km) for different maintenance types
       const baseIntervals = {
         oilChange: 5000,
         tireRotation: 10000,
         brakeService: 20000,
         majorService: 50000
       };
       
       // Calculate current distance since last service (simulated)
       const currentDistance = totalDistance;
       
       // Adjust intervals based on usage patterns
       const efficiencyFactor = avgEfficiency < 7 ? 0.8 : avgEfficiency > 8 ? 1.2 : 1.0;
       const usageFactor = activeTime > 80 ? 0.9 : activeTime < 50 ? 1.3 : 1.0;
       
       const predictions = {
         oilChange: {
           nextService: Math.round(baseIntervals.oilChange * efficiencyFactor * usageFactor),
           remainingDistance: Math.max(0, Math.round(baseIntervals.oilChange * efficiencyFactor * usageFactor) - currentDistance),
           nextDate: calculateNextServiceDate(Math.round(baseIntervals.oilChange * efficiencyFactor * usageFactor) - currentDistance, avgEfficiency)
         },
         tireRotation: {
           nextService: Math.round(baseIntervals.tireRotation * efficiencyFactor * usageFactor),
           remainingDistance: Math.max(0, Math.round(baseIntervals.tireRotation * efficiencyFactor * usageFactor) - currentDistance),
           nextDate: calculateNextServiceDate(Math.round(baseIntervals.tireRotation * efficiencyFactor * usageFactor) - currentDistance, avgEfficiency)
         },
         brakeService: {
           nextService: Math.round(baseIntervals.brakeService * efficiencyFactor * usageFactor),
           remainingDistance: Math.max(0, Math.round(baseIntervals.brakeService * efficiencyFactor * usageFactor) - currentDistance),
           nextDate: calculateNextServiceDate(Math.round(baseIntervals.brakeService * efficiencyFactor * usageFactor) - currentDistance, avgEfficiency)
         },
         majorService: {
           nextService: Math.round(baseIntervals.majorService * efficiencyFactor * usageFactor),
           remainingDistance: Math.max(0, Math.round(baseIntervals.majorService * efficiencyFactor * usageFactor) - currentDistance),
           nextDate: calculateNextServiceDate(Math.round(baseIntervals.majorService * efficiencyFactor * usageFactor) - currentDistance, avgEfficiency)
         }
       };
       
       return predictions;
     }
     
     function calculateNextServiceDate(remainingDistance, avgEfficiency) {
       // Estimate daily distance based on efficiency and typical usage
       const estimatedDailyDistance = avgEfficiency * 8; // Assume 8 hours of operation
       const daysUntilService = Math.ceil(remainingDistance / estimatedDailyDistance);
       
       const nextDate = new Date();
       nextDate.setDate(nextDate.getDate() + daysUntilService);
       
       return nextDate.toLocaleDateString();
     }
     
     function displayMaintenancePredictions(predictions) {
       // Oil Change
       document.getElementById('next-oil-change').textContent = predictions.oilChange.nextDate;
       document.getElementById('oil-change-distance').textContent = `${predictions.oilChange.remainingDistance} km remaining`;
       
       // Tire Rotation
       document.getElementById('next-tire-rotation').textContent = predictions.tireRotation.nextDate;
       document.getElementById('tire-rotation-distance').textContent = `${predictions.tireRotation.remainingDistance} km remaining`;
       
       // Brake Service
       document.getElementById('next-brake-service').textContent = predictions.brakeService.nextDate;
       document.getElementById('brake-service-distance').textContent = `${predictions.brakeService.remainingDistance} km remaining`;
       
       // Major Service
       document.getElementById('next-major-service').textContent = predictions.majorService.nextDate;
       document.getElementById('major-service-distance').textContent = `${predictions.majorService.remainingDistance} km remaining`;
     }
     
     function calculateBreakdownRisk(vehicleId, metrics, maintenancePredictions) {
       const totalDistance = parseInt(metrics.totalDistance);
       const avgEfficiency = parseFloat(metrics.avgEfficiency);
       const activeTime = parseInt(metrics.activeTime);
       const healthScore = parseInt(metrics.healthScore);
       
       // Calculate individual system health scores
       const engineHealth = calculateEngineHealth(avgEfficiency, totalDistance);
       const transmissionHealth = calculateTransmissionHealth(avgEfficiency, activeTime);
       const brakeHealth = calculateBrakeHealth(totalDistance, maintenancePredictions.brakeService.remainingDistance);
       const electricalHealth = calculateElectricalHealth(healthScore, activeTime);
       
       // Calculate overall risk percentage
       const systemScores = [engineHealth, transmissionHealth, brakeHealth, electricalHealth];
       const averageHealth = systemScores.reduce((sum, score) => sum + score, 0) / systemScores.length;
       const riskPercentage = Math.max(0, Math.min(100, 100 - averageHealth));
       
       // Identify risk factors
       const riskFactors = [];
       if (engineHealth < 70) riskFactors.push('Engine showing signs of wear');
       if (transmissionHealth < 70) riskFactors.push('Transmission efficiency declining');
       if (brakeHealth < 70) riskFactors.push('Brake system needs attention');
       if (electricalHealth < 70) riskFactors.push('Electrical system issues detected');
       if (avgEfficiency < 7) riskFactors.push('Poor fuel efficiency indicates potential problems');
       if (healthScore < 80) riskFactors.push('Multiple alerts indicate system stress');
       if (maintenancePredictions.oilChange.remainingDistance < 500) riskFactors.push('Oil change overdue');
       
       return {
         riskPercentage,
         engineHealth,
         transmissionHealth,
         brakeHealth,
         electricalHealth,
         riskFactors
       };
     }
     
     function calculateEngineHealth(efficiency, distance) {
       // Engine health based on efficiency and distance
       let health = 100;
       
       // Efficiency impact
       if (efficiency < 6) health -= 30;
       else if (efficiency < 7) health -= 20;
       else if (efficiency < 8) health -= 10;
       
       // Distance impact (wear and tear)
       const distanceFactor = Math.min(20, distance / 1000);
       health -= distanceFactor;
       
       return Math.max(0, Math.min(100, health));
     }
     
     function calculateTransmissionHealth(efficiency, activeTime) {
       // Transmission health based on efficiency and usage patterns
       let health = 100;
       
       // Efficiency impact on transmission
       if (efficiency < 6) health -= 25;
       else if (efficiency < 7) health -= 15;
       else if (efficiency < 8) health -= 8;
       
       // Active time impact (overuse)
       if (activeTime > 90) health -= 15;
       else if (activeTime > 80) health -= 8;
       
       return Math.max(0, Math.min(100, health));
     }
     
     function calculateBrakeHealth(distance, brakeServiceRemaining) {
       // Brake health based on distance and service schedule
       let health = 100;
       
       // Distance impact
       const brakeWear = Math.min(30, distance / 500);
       health -= brakeWear;
       
       // Service schedule impact
       if (brakeServiceRemaining < 1000) health -= 20;
       else if (brakeServiceRemaining < 2000) health -= 10;
       
       return Math.max(0, Math.min(100, health));
     }
     
     function calculateElectricalHealth(healthScore, activeTime) {
       // Electrical health based on overall health score and usage
       let health = healthScore;
       
       // Active time impact on electrical system
       if (activeTime > 90) health -= 10;
       else if (activeTime > 80) health -= 5;
       
       return Math.max(0, Math.min(100, health));
     }
     
     function displayBreakdownRisk(riskAssessment) {
       // Update risk percentage and circle
       document.getElementById('risk-percentage').textContent = `${Math.round(riskAssessment.riskPercentage)}%`;
       
       const riskCircle = document.getElementById('risk-circle');
       const circumference = 251.2; // 2 * π * 40
       const offset = circumference - (riskAssessment.riskPercentage / 100) * circumference;
       riskCircle.style.strokeDashoffset = offset;
       
       // Update risk circle color based on percentage
       if (riskAssessment.riskPercentage < 20) {
         riskCircle.style.stroke = '#10b981'; // Green
       } else if (riskAssessment.riskPercentage < 50) {
         riskCircle.style.stroke = '#f59e0b'; // Yellow
       } else {
         riskCircle.style.stroke = '#ef4444'; // Red
       }
       
       // Update system health bars
       document.getElementById('engine-health-score').textContent = `${Math.round(riskAssessment.engineHealth)}%`;
       document.getElementById('engine-health-bar').style.width = `${riskAssessment.engineHealth}%`;
       document.getElementById('engine-health-bar').style.backgroundColor = getHealthColor(riskAssessment.engineHealth);
       
       document.getElementById('transmission-health-score').textContent = `${Math.round(riskAssessment.transmissionHealth)}%`;
       document.getElementById('transmission-health-bar').style.width = `${riskAssessment.transmissionHealth}%`;
       document.getElementById('transmission-health-bar').style.backgroundColor = getHealthColor(riskAssessment.transmissionHealth);
       
       document.getElementById('brake-health-score').textContent = `${Math.round(riskAssessment.brakeHealth)}%`;
       document.getElementById('brake-health-bar').style.width = `${riskAssessment.brakeHealth}%`;
       document.getElementById('brake-health-bar').style.backgroundColor = getHealthColor(riskAssessment.brakeHealth);
       
       document.getElementById('electrical-health-score').textContent = `${Math.round(riskAssessment.electricalHealth)}%`;
       document.getElementById('electrical-health-bar').style.width = `${riskAssessment.electricalHealth}%`;
       document.getElementById('electrical-health-bar').style.backgroundColor = getHealthColor(riskAssessment.electricalHealth);
       
       // Update risk factors list
       const riskFactorsList = document.getElementById('risk-factors-list');
       riskFactorsList.innerHTML = '';
       
       if (riskAssessment.riskFactors.length === 0) {
         riskFactorsList.innerHTML = '<li>No significant risk factors detected</li>';
       } else {
         riskAssessment.riskFactors.forEach(factor => {
           const li = document.createElement('li');
           li.textContent = `• ${factor}`;
           riskFactorsList.appendChild(li);
         });
       }
     }
     
            function getHealthColor(healthScore) {
         if (healthScore >= 80) return '#10b981'; // Green
         if (healthScore >= 60) return '#f59e0b'; // Yellow
         return '#ef4444'; // Red
       }
       
       function generateRecommendations(risk, maintenance) {
         const recommendations = [];
         
         // Maintenance recommendations
         if (maintenance.oilChange.remainingDistance < 1000) {
           recommendations.push('Schedule oil change immediately');
         }
         if (maintenance.brakeService.remainingDistance < 2000) {
           recommendations.push('Plan brake service in the near future');
         }
         if (maintenance.tireRotation.remainingDistance < 1500) {
           recommendations.push('Schedule tire rotation soon');
         }
         
         // Risk-based recommendations
         if (risk.riskPercentage > 50) {
           recommendations.push('High breakdown risk - schedule comprehensive inspection');
         }
         if (risk.engineHealth < 70) {
           recommendations.push('Engine showing wear - consider engine diagnostics');
         }
         if (risk.brakeHealth < 70) {
           recommendations.push('Brake system needs attention - prioritize brake inspection');
         }
         if (risk.transmissionHealth < 70) {
           recommendations.push('Transmission efficiency declining - schedule transmission check');
         }
         if (risk.electricalHealth < 70) {
           recommendations.push('Electrical system issues detected - electrical diagnostics recommended');
         }
         
         // General recommendations
         if (recommendations.length === 0) {
           recommendations.push('Vehicle is in good condition - continue regular maintenance schedule');
         }
         
                return recommendations.map(rec => `• ${rec}`).join('\n');
     }
     
     function generatePerformanceInsights(currentData, comprehensiveData) {
       const insights = [];
       
       const currentAvg = currentData.reduce((sum, val) => sum + val, 0) / currentData.length;
       const comprehensiveAvg = comprehensiveData.reduce((sum, val) => sum + val, 0) / comprehensiveData.length;
       
       // Trend analysis
       if (currentAvg > comprehensiveAvg + 5) {
         insights.push('Performance is significantly improving compared to historical average');
       } else if (currentAvg < comprehensiveAvg - 5) {
         insights.push('Performance is declining compared to historical average - investigation recommended');
       } else {
         insights.push('Performance is stable and consistent with historical patterns');
       }
       
       // Variability analysis
       const currentVariance = Math.sqrt(currentData.reduce((sum, val) => sum + Math.pow(val - currentAvg, 2), 0) / currentData.length);
       const comprehensiveVariance = Math.sqrt(comprehensiveData.reduce((sum, val) => sum + Math.pow(val - comprehensiveAvg, 2), 0) / comprehensiveData.length);
       
       if (currentVariance < comprehensiveVariance * 0.8) {
         insights.push('Performance consistency has improved - more stable operation');
       } else if (currentVariance > comprehensiveVariance * 1.2) {
         insights.push('Performance variability has increased - may indicate operational issues');
       }
       
       // Peak performance analysis
       const currentMax = Math.max(...currentData);
       const comprehensiveMax = Math.max(...comprehensiveData);
       
       if (currentMax >= comprehensiveMax * 0.95) {
         insights.push('Peak performance levels are being maintained');
       } else if (currentMax < comprehensiveMax * 0.8) {
         insights.push('Peak performance has declined - optimization opportunities identified');
       }
       
       // Consistency recommendations
       if (currentVariance > 20) {
         insights.push('High performance variability suggests need for operational improvements');
       }
       
       if (insights.length === 0) {
         insights.push('Performance patterns are within normal operational parameters');
       }
       
       return insights.map(insight => `• ${insight}`).join('\n');
     }
     
     function calculateAverageDistance(activityData) {
       if (activityData.length === 0) return '0 km';
       const total = activityData.reduce((sum, activity) => {
         const distance = parseFloat(activity.distance.replace(' km', ''));
         return sum + (isNaN(distance) ? 0 : distance);
       }, 0);
       return `${(total / activityData.length).toFixed(1)} km`;
     }
     
     function calculateAverageEfficiency(activityData) {
       if (activityData.length === 0) return '0 km/L';
       const total = activityData.reduce((sum, activity) => {
         const efficiency = parseFloat(activity.efficiency.replace(' km/L', ''));
         return sum + (isNaN(efficiency) ? 0 : efficiency);
       }, 0);
       return `${(total / activityData.length).toFixed(1)} km/L`;
     }
     
     function calculateStatusBreakdown(activityData) {
       const breakdown = {};
       activityData.forEach(activity => {
         const status = activity.status.replace(/[^\w\s]/g, '').trim();
         breakdown[status] = (breakdown[status] || 0) + 1;
       });
       return breakdown;
     }
     
     function calculateAlertSummary(activityData) {
       let totalAlerts = 0;
       let criticalAlerts = 0;
       let warningAlerts = 0;
       
       activityData.forEach(activity => {
         if (activity.alerts.includes('alerts')) {
           const alertCount = parseInt(activity.alerts.match(/\d+/)[0]);
           totalAlerts += alertCount;
           if (activity.alerts.includes('Critical')) criticalAlerts += alertCount;
           else if (activity.alerts.includes('Warning')) warningAlerts += alertCount;
         }
       });
       
       return { totalAlerts, criticalAlerts, warningAlerts };
     }
     
     function generateTextReport(report) {
       const currentStatusBreakdown = Object.entries(report.activityHistory.currentPeriod.summary.statusBreakdown)
         .map(([status, count]) => `${status}: ${count}`)
         .join(', ');
       const comprehensiveStatusBreakdown = Object.entries(report.activityHistory.comprehensiveHistory.summary.statusBreakdown)
         .map(([status, count]) => `${status}: ${count}`)
         .join(', ');
       
       let predictiveSection = '';
       if (report.predictiveAnalytics) {
         const maintenance = report.predictiveAnalytics.maintenancePredictions;
         const risk = report.predictiveAnalytics.riskAssessment;
         
         predictiveSection = `

PREDICTIVE ANALYTICS
====================

MAINTENANCE PREDICTIONS
-----------------------
Next Oil Change: ${maintenance.oilChange.nextDate} (${maintenance.oilChange.remainingDistance} km remaining)
Next Tire Rotation: ${maintenance.tireRotation.nextDate} (${maintenance.tireRotation.remainingDistance} km remaining)
Next Brake Service: ${maintenance.brakeService.nextDate} (${maintenance.brakeService.remainingDistance} km remaining)
Next Major Service: ${maintenance.majorService.nextDate} (${maintenance.majorService.remainingDistance} km remaining)

BREAKDOWN RISK ASSESSMENT
-------------------------
Overall Risk Level: ${Math.round(risk.riskPercentage)}%
Engine Health: ${Math.round(risk.engineHealth)}%
Transmission Health: ${Math.round(risk.transmissionHealth)}%
Brake System Health: ${Math.round(risk.brakeHealth)}%
Electrical System Health: ${Math.round(risk.electricalHealth)}%

Risk Factors:
${risk.riskFactors.length > 0 ? risk.riskFactors.map(factor => `• ${factor}`).join('\n') : '• No significant risk factors detected'}

RECOMMENDATIONS
---------------
${generateRecommendations(risk, maintenance)}
`;
       }
       
       // Add performance trends section
       let performanceTrendsSection = '';
       if (report.performanceTrends) {
         const currentTrends = report.performanceTrends.currentPeriod;
         const comprehensiveTrends = report.performanceTrends.comprehensiveHistory;
         
         const currentAvg = Math.round(currentTrends.data.reduce((sum, val) => sum + val, 0) / currentTrends.data.length);
         const comprehensiveAvg = Math.round(comprehensiveTrends.data.reduce((sum, val) => sum + val, 0) / comprehensiveTrends.data.length);
         
         performanceTrendsSection = `

PERFORMANCE TRENDS ANALYSIS
===========================

CURRENT PERIOD PERFORMANCE (${currentTrends.period} days)
---------------------------
Average Performance Score: ${currentAvg}/100
Performance Range: ${Math.min(...currentTrends.data)} - ${Math.max(...currentTrends.data)}
Trend Direction: ${currentAvg > comprehensiveAvg ? 'Improving' : currentAvg < comprehensiveAvg ? 'Declining' : 'Stable'}

COMPREHENSIVE PERFORMANCE HISTORY (Since Onboarding)
---------------------------------------------------
Average Performance Score: ${comprehensiveAvg}/100
Performance Range: ${Math.min(...comprehensiveTrends.data)} - ${Math.max(...comprehensiveTrends.data)}
Total Performance Records: ${comprehensiveTrends.data.length}

PERFORMANCE INSIGHTS
-------------------
${generatePerformanceInsights(currentTrends.data, comprehensiveTrends.data)}
`;
       }
       
       return `VEHICLE ANALYSIS REPORT
===========================================

VEHICLE INFORMATION
-------------------
Vehicle ID: ${report.vehicleId}
Driver: ${report.driver}
Current Status: ${report.status}
Group: ${report.group}
Report Date: ${report.reportDate}
Report Time: ${report.reportTime}

PERFORMANCE METRICS
-------------------
Total Distance: ${report.metrics.totalDistance}
Fuel Efficiency: ${report.metrics.fuelEfficiency}
Active Time: ${report.metrics.activeTime}
Health Score: ${report.metrics.healthScore}

CURRENT PERIOD SUMMARY (${report.activityHistory.currentPeriod.period} days)
------------------
Total Activities: ${report.activityHistory.currentPeriod.summary.totalActivities}
Average Distance: ${report.activityHistory.currentPeriod.summary.averageDistance}
Average Efficiency: ${report.activityHistory.currentPeriod.summary.averageEfficiency}
Status Breakdown: ${currentStatusBreakdown}
Total Alerts: ${report.activityHistory.currentPeriod.summary.alertSummary.totalAlerts}
Critical Alerts: ${report.activityHistory.currentPeriod.summary.alertSummary.criticalAlerts}
Warning Alerts: ${report.activityHistory.currentPeriod.summary.alertSummary.warningAlerts}

COMPREHENSIVE HISTORY SUMMARY (Since Onboarding)
------------------
Total Activities: ${report.activityHistory.comprehensiveHistory.summary.totalActivities}
Average Distance: ${report.activityHistory.comprehensiveHistory.summary.averageDistance}
Average Efficiency: ${report.activityHistory.comprehensiveHistory.summary.averageEfficiency}
Status Breakdown: ${comprehensiveStatusBreakdown}
Total Alerts: ${report.activityHistory.comprehensiveHistory.summary.alertSummary.totalAlerts}
Critical Alerts: ${report.activityHistory.comprehensiveHistory.summary.alertSummary.criticalAlerts}
Warning Alerts: ${report.activityHistory.comprehensiveHistory.summary.alertSummary.warningAlerts}${predictiveSection}${performanceTrendsSection}

DETAILED ACTIVITY HISTORY (Current Period)
-------------------------
${report.activityHistory.currentPeriod.data.map((activity, index) => `
${index + 1}. Date: ${activity.date}
   Driver: ${activity.driver}
   Status: ${activity.status}
   Distance: ${activity.distance}
   Efficiency: ${activity.efficiency}
   Alerts: ${activity.alerts}
`).join('')}

COMPREHENSIVE ACTIVITY HISTORY (Since Onboarding)
-------------------------
${report.activityHistory.comprehensiveHistory.data.map((activity, index) => `
${index + 1}. Date: ${activity.date}
   Driver: ${activity.driver}
   Status: ${activity.status}
   Distance: ${activity.distance}
   Efficiency: ${activity.efficiency}
   Alerts: ${activity.alerts}
`).join('')}

===========================================
Report generated on ${report.reportDate} at ${report.reportTime}
`;
     }
     
     function showExportSuccessMessage() {
       // Create a temporary success message
       const message = document.createElement('div');
       message.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
       message.innerHTML = `
         <div class="flex items-center">
           <i class="fas fa-check-circle mr-2"></i>
           <span>Report exported successfully!</span>
         </div>
       `;
       document.body.appendChild(message);
       
       // Remove after 3 seconds
       setTimeout(() => {
         if (message.parentNode) {
           message.parentNode.removeChild(message);
         }
       }, 3000);
     }
     
     function renderModalCharts(vehicleId, period) {
       // Performance Trends Chart
       const performanceCtx = document.getElementById('modalPerformanceChart');
       if (performanceCtx) {
         if (window._modalPerformanceChart) window._modalPerformanceChart.destroy();
         
         let days;
         if (period === '7') days = 7;
         else if (period === '14') days = 14;
         else if (period === '30') days = 30;
         else if (period === 'all') days = 365; // Full year since onboarding
         else days = 7; // Default
         
         // Generate realistic performance data with trends
         const performanceData = generatePerformanceTrendData(vehicleId, days);
         const labels = generateChartLabels(days);
         
         window._modalPerformanceChart = new Chart(performanceCtx.getContext('2d'), {
           type: 'line',
           data: {
             labels: labels,
             datasets: [{
               label: 'Performance Score',
               data: performanceData,
               borderColor: '#3b82f6',
               backgroundColor: 'rgba(59, 130, 246, 0.1)',
               fill: true,
               tension: 0.3,
               pointRadius: 3
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { display: false },
               tooltip: { 
                 enabled: true,
                 callbacks: {
                   title: function(context) {
                     return `Date: ${context[0].label}`;
                   },
                   label: function(context) {
                     return `Performance Score: ${context.parsed.y}`;
                   }
                 }
               }
             },
             scales: {
               y: { 
                 beginAtZero: true, 
                 title: { display: true, text: 'Performance Score' },
                 max: 100
               },
               x: { 
                 title: { display: true, text: 'Date' },
                 ticks: { 
                   maxTicksLimit: days > 30 ? 20 : 10,
                   autoSkip: true
                 }
               }
             }
           }
         });
       }
       
       // Status Distribution Chart
       const statusCtx = document.getElementById('modalStatusChart');
       if (statusCtx) {
         if (window._modalStatusChart) window._modalStatusChart.destroy();
         
         const statusData = {
           'Driving': Math.floor(Math.random() * 40) + 30,
           'Idling': Math.floor(Math.random() * 20) + 10,
           'Parked': Math.floor(Math.random() * 30) + 20,
           'Offline': Math.floor(Math.random() * 10) + 5
         };
         
         window._modalStatusChart = new Chart(statusCtx.getContext('2d'), {
           type: 'doughnut',
           data: {
             labels: Object.keys(statusData),
             datasets: [{
               data: Object.values(statusData),
               backgroundColor: [
                 '#10b981', '#f59e0b', '#3b82f6', '#6b7280'
               ],
               borderWidth: 2,
               borderColor: '#ffffff'
             }]
           },
           options: {
             responsive: true,
             plugins: {
               legend: { 
                 position: 'bottom',
                 labels: { padding: 20 }
               },
               tooltip: { enabled: true }
             }
           }
         });
       }
     }
     
     function populateModalActivityTable(vehicleId, period) {
       const tableBody = document.getElementById('modal-activity-table');
       tableBody.innerHTML = '';
       
       const baseVehicle = vehicleActivity.find(v => v.vehicleId === vehicleId);
       if (!baseVehicle) return;
       
       // Generate comprehensive historical data
       const historicalData = generateHistoricalActivityData(vehicleId, period);
       
       // Populate table with historical data
       historicalData.forEach(activity => {
         const row = document.createElement('tr');
         row.innerHTML = `
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${activity.date}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${activity.driver}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             <span class="px-2 py-1 rounded-full text-xs font-medium ${
               activity.status === 'Driving' ? 'bg-green-100 text-green-800' :
               activity.status === 'Idling' ? 'bg-yellow-100 text-yellow-800' :
               activity.status === 'Parked' ? 'bg-blue-100 text-blue-800' :
               'bg-gray-100 text-gray-800'
             }">${activity.status}</span>
           </td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${activity.distance} km</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${activity.efficiency} km/L</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
             ${activity.alerts > 0 ? 
               `<span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">${activity.alerts} alerts</span>` :
               '<span class="text-green-600 text-sm">✓ No alerts</span>'
             }
           </td>
         `;
         tableBody.appendChild(row);
       });
       
       // Store the current period data for export
       if (window.currentVehicleAnalysis) {
         window.currentVehicleAnalysis.currentActivityPeriod = period;
         window.currentVehicleAnalysis.activityHistory = historicalData;
       }
     }
     
     function generateHistoricalActivityData(vehicleId, period) {
       const baseVehicle = vehicleActivity.find(v => v.vehicleId === vehicleId);
       if (!baseVehicle) return [];
       
       let days;
       if (period === '7') days = 7;
       else if (period === '14') days = 14;
       else if (period === '30') days = 30;
       else if (period === 'all') days = 365; // Full year since onboarding
       else days = 7; // Default
       
       const historicalData = [];
       
       // Generate realistic historical data with patterns
       for (let i = days - 1; i >= 0; i--) {
         const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
         
         // Create realistic patterns based on day of week and season
         const dayOfWeek = date.getDay();
         const month = date.getMonth();
         
         // Weekend vs weekday patterns
         const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
         const baseDistance = isWeekend ? 30 : 120; // Less activity on weekends
         
         // Seasonal patterns (winter months have different efficiency)
         const isWinter = month >= 11 || month <= 2;
         const efficiencyMultiplier = isWinter ? 0.9 : 1.1;
         
         // Generate realistic data with some randomness
         const distance = Math.floor(baseDistance + (Math.random() - 0.5) * 60);
         const efficiency = (7 + (Math.random() - 0.5) * 2) * efficiencyMultiplier;
         
         // Status distribution based on distance
         let status;
         if (distance > 100) status = 'Driving';
         else if (distance > 30) status = 'Idling';
         else if (distance > 5) status = 'Parked';
         else status = 'Offline';
         
         // Alerts based on efficiency and usage
         let alerts = 0;
         if (efficiency < 6.5) alerts += Math.floor(Math.random() * 2) + 1;
         if (distance > 150) alerts += Math.floor(Math.random() * 2);
         if (Math.random() < 0.1) alerts += 1; // Random alerts
         
         historicalData.push({
           date: date.toLocaleDateString(),
           driver: baseVehicle.driver,
           status: status,
           distance: distance,
           efficiency: efficiency.toFixed(1),
           alerts: alerts
         });
       }
       
       return historicalData;
     }
     
     function generatePerformanceTrendData(vehicleId, days) {
       const baseVehicle = vehicleActivity.find(v => v.vehicleId === vehicleId);
       if (!baseVehicle) return [];
       
       const performanceData = [];
       let basePerformance = 75; // Starting performance score
       
       // Generate realistic performance trends with patterns
       for (let i = 0; i < days; i++) {
         const date = new Date(Date.now() - (days - i - 1) * 24 * 60 * 60 * 1000);
         const dayOfWeek = date.getDay();
         const month = date.getMonth();
         
         // Base performance variations
         let dailyPerformance = basePerformance;
         
         // Weekend effect (slightly lower performance on weekends)
         if (dayOfWeek === 0 || dayOfWeek === 6) {
           dailyPerformance -= 5;
         }
         
         // Seasonal variations
         const isWinter = month >= 11 || month <= 2;
         const isSummer = month >= 5 && month <= 8;
         
         if (isWinter) {
           dailyPerformance -= 8; // Winter performance dip
         } else if (isSummer) {
           dailyPerformance += 3; // Summer performance boost
         }
         
         // Add some realistic trends and patterns
         const trendFactor = Math.sin(i * 0.1) * 10; // Long-term trend
         const weeklyPattern = Math.sin(i * 0.9) * 5; // Weekly pattern
         const randomVariation = (Math.random() - 0.5) * 15; // Random variation
         
         dailyPerformance += trendFactor + weeklyPattern + randomVariation;
         
         // Ensure performance stays within reasonable bounds
         dailyPerformance = Math.max(20, Math.min(100, dailyPerformance));
         
         // Add some performance improvements over time (learning curve)
         if (i > 30) {
           dailyPerformance += Math.min(10, (i - 30) * 0.1);
         }
         
         performanceData.push(Math.round(dailyPerformance));
       }
       
       return performanceData;
     }
     
     function generateChartLabels(days) {
       const labels = [];
       
       for (let i = 0; i < days; i++) {
         const date = new Date(Date.now() - (days - i - 1) * 24 * 60 * 60 * 1000);
         
         // Format labels based on the number of days
         if (days <= 7) {
           // For short periods, show full date
           labels.push(date.toLocaleDateString());
         } else if (days <= 30) {
           // For medium periods, show day and month
           labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
         } else {
           // For long periods, show month and year
           labels.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
         }
       }
       
       return labels;
     }

     // Initialize
     document.addEventListener('DOMContentLoaded', () => {
       // Initialize period selector
       const quickDateRange = document.getElementById('quick-date-range');
       if (quickDateRange) {
         quickDateRange.value = filters.dateRange;
         quickDateRange.addEventListener('change', function() {
           filters.dateRange = this.value;
           currentPage = 1;
           renderActivityTable(currentPage);
           renderCharts();
         });
       }

       // Initialize chart period selector
       const chartPeriodSel = document.getElementById('chart-period');
       if (chartPeriodSel) {
         chartPeriodSel.value = chartPeriod;
         chartPeriodSel.addEventListener('change', function() {
           chartPeriod = this.value;
           renderCharts();
         });
       }

       populateFilters();
       renderActivityTable();
       renderCharts();
       initializeDashboardTabs();
       initializeDashboardControls();
       simulateWebSocketUpdates();
     });
  </script>

  <!-- Vehicle Analysis Modal -->
  <div id="vehicle-analysis-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <!-- Modal Header -->
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center">
            <i class="fas fa-car text-blue-600 mr-2 text-lg"></i>
            <div>
              <h3 id="modal-vehicle-title" class="text-xl font-bold text-gray-900">Vehicle Analysis</h3>
              <p id="modal-vehicle-subtitle" class="text-sm text-gray-600">Detailed performance metrics</p>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <span id="modal-vehicle-status" class="px-3 py-1 rounded-full text-sm font-medium"></span>
            <span id="modal-vehicle-group" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm"></span>
            <div class="flex items-center space-x-2">
              <select id="export-format" class="border border-gray-300 px-2 py-1 rounded text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                <option value="json">JSON</option>
                <option value="text">Text</option>
                <option value="pdf">PDF</option>
              </select>
              <button onclick="exportVehicleReport()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-download mr-2"></i>Export Report
              </button>
            </div>
            <button onclick="closeVehicleAnalysisModal()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>

                 <!-- Modal Metrics -->
         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
           <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
             <div class="flex items-center justify-between mb-2">
               <h4 class="text-sm font-semibold text-blue-800">Total Distance</h4>
               <i class="fas fa-road text-blue-600"></i>
             </div>
             <p id="modal-total-distance" class="text-2xl font-bold text-blue-700">-</p>
             <p class="text-xs text-blue-600 mt-1">This period</p>
           </div>

           <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
             <div class="flex items-center justify-between mb-2">
               <h4 class="text-sm font-semibold text-green-800">Fuel Efficiency</h4>
               <i class="fas fa-gas-pump text-green-600"></i>
             </div>
             <p id="modal-fuel-efficiency" class="text-2xl font-bold text-green-700">-</p>
             <p class="text-xs text-green-600 mt-1">km/L average</p>
           </div>

           <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
             <div class="flex items-center justify-between mb-2">
               <h4 class="text-sm font-semibold text-purple-800">Active Time</h4>
               <i class="fas fa-clock text-purple-600"></i>
             </div>
             <p id="modal-active-time" class="text-2xl font-bold text-purple-700">-</p>
             <p class="text-xs text-purple-600 mt-1">% of period</p>
           </div>

           <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
             <div class="flex items-center justify-between mb-2">
               <h4 class="text-sm font-semibold text-orange-800">Health Score</h4>
               <i class="fas fa-heartbeat text-orange-600"></i>
             </div>
             <p id="modal-health-score" class="text-2xl font-bold text-orange-700">-</p>
             <p class="text-xs text-orange-600 mt-1">Based on alerts</p>
           </div>
         </div>

         <!-- Predictive Analytics Section -->
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
           <!-- Maintenance Prediction -->
           <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
             <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
               <i class="fas fa-tools text-blue-600 mr-2"></i>Maintenance Prediction
             </h4>
             <div class="space-y-4">
               <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                 <div>
                   <p class="text-sm font-medium text-blue-800">Next Oil Change</p>
                   <p class="text-xs text-blue-600">Based on usage patterns</p>
                 </div>
                 <div class="text-right">
                   <p id="next-oil-change" class="text-lg font-bold text-blue-700">-</p>
                   <p id="oil-change-distance" class="text-xs text-blue-600">-</p>
                 </div>
               </div>
               
               <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                 <div>
                   <p class="text-sm font-medium text-green-800">Tire Rotation</p>
                   <p class="text-xs text-green-600">Recommended interval</p>
                 </div>
                 <div class="text-right">
                   <p id="next-tire-rotation" class="text-lg font-bold text-green-700">-</p>
                   <p id="tire-rotation-distance" class="text-xs text-green-600">-</p>
                 </div>
               </div>
               
               <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                 <div>
                   <p class="text-sm font-medium text-purple-800">Brake Service</p>
                   <p class="text-xs text-purple-600">Based on driving patterns</p>
                 </div>
                 <div class="text-right">
                   <p id="next-brake-service" class="text-lg font-bold text-purple-700">-</p>
                   <p id="brake-service-distance" class="text-xs text-purple-600">-</p>
                 </div>
               </div>
               
               <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg">
                 <div>
                   <p class="text-sm font-medium text-orange-800">Major Service</p>
                   <p class="text-xs text-orange-600">Comprehensive maintenance</p>
                 </div>
                 <div class="text-right">
                   <p id="next-major-service" class="text-lg font-bold text-orange-700">-</p>
                   <p id="major-service-distance" class="text-xs text-orange-600">-</p>
                 </div>
               </div>
             </div>
           </div>

           <!-- Breakdown Risk Assessment -->
           <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
             <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
               <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>Breakdown Risk Assessment
             </h4>
             <div class="space-y-4">
               <div class="text-center mb-4">
                 <div class="relative inline-block">
                   <svg class="w-24 h-24 transform -rotate-90">
                     <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/>
                     <circle id="risk-circle" cx="48" cy="48" r="40" stroke="#ef4444" stroke-width="8" fill="none" 
                             stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round"/>
                   </svg>
                   <div class="absolute inset-0 flex items-center justify-center">
                     <div class="text-center">
                       <p id="risk-percentage" class="text-2xl font-bold text-gray-900">-</p>
                       <p class="text-xs text-gray-600">Risk Level</p>
                     </div>
                   </div>
                 </div>
               </div>
               
               <div class="space-y-3">
                 <div class="flex items-center justify-between">
                   <span class="text-sm text-gray-600">Engine Health</span>
                   <div class="flex items-center">
                     <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                       <div id="engine-health-bar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                     </div>
                     <span id="engine-health-score" class="text-xs font-medium text-gray-900">-</span>
                   </div>
                 </div>
                 
                 <div class="flex items-center justify-between">
                   <span class="text-sm text-gray-600">Transmission</span>
                   <div class="flex items-center">
                     <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                       <div id="transmission-health-bar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                     </div>
                     <span id="transmission-health-score" class="text-xs font-medium text-gray-900">-</span>
                   </div>
                 </div>
                 
                 <div class="flex items-center justify-between">
                   <span class="text-sm text-gray-600">Brake System</span>
                   <div class="flex items-center">
                     <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                       <div id="brake-health-bar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                     </div>
                     <span id="brake-health-score" class="text-xs font-medium text-gray-900">-</span>
                   </div>
                 </div>
                 
                 <div class="flex items-center justify-between">
                   <span class="text-sm text-gray-600">Electrical System</span>
                   <div class="flex items-center">
                     <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                       <div id="electrical-health-bar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                     </div>
                     <span id="electrical-health-score" class="text-xs font-medium text-gray-900">-</span>
                   </div>
                 </div>
               </div>
               
               <div id="risk-recommendations" class="mt-4 p-3 bg-red-50 rounded-lg">
                 <p class="text-sm font-medium text-red-800 mb-2">Risk Factors:</p>
                 <ul id="risk-factors-list" class="text-xs text-red-700 space-y-1">
                   <!-- Dynamic content will be populated here -->
                 </ul>
               </div>
             </div>
           </div>
         </div>

                 <!-- Modal Charts -->
         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
           <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
             <div class="flex items-center justify-between mb-4">
               <h4 class="text-lg font-semibold text-gray-900 flex items-center">
                 <i class="fas fa-chart-line text-blue-600 mr-2"></i>Performance Trends
               </h4>
               <div class="flex items-center space-x-2">
                 <label class="text-sm font-medium text-gray-700">Period:</label>
                 <select id="performance-period-selector" class="border border-gray-300 px-2 py-1 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                   <option value="7">Last 7 Days</option>
                   <option value="14">Last 14 Days</option>
                   <option value="30">Last 30 Days</option>
                   <option value="all">Since Onboarding</option>
                 </select>
               </div>
             </div>
             <canvas id="modalPerformanceChart" height="200"></canvas>
           </div>

          <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-chart-pie text-green-600 mr-2"></i>Status Distribution
            </h4>
            <canvas id="modalStatusChart" height="200"></canvas>
          </div>
        </div>

                 <!-- Modal Activity Table -->
         <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
           <div class="flex items-center justify-between mb-4">
             <h4 class="text-lg font-semibold text-gray-900 flex items-center">
               <i class="fas fa-table text-purple-600 mr-2"></i>Activity History
             </h4>
             <div class="flex items-center space-x-2">
               <label class="text-sm font-medium text-gray-700">Period:</label>
               <select id="activity-period-selector" class="border border-gray-300 px-3 py-1 rounded text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                 <option value="7">Last 7 Days</option>
                 <option value="14">Last 14 Days</option>
                 <option value="30">Last 30 Days</option>
                 <option value="all">Since Onboarding</option>
               </select>
             </div>
           </div>
           <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Driver</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distance</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Efficiency</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alerts</th>
                </tr>
              </thead>
              <tbody id="modal-activity-table" class="bg-white divide-y divide-gray-200">
                <!-- Dynamic content will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>



  <!-- Feedback Submission Modal -->
  <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-comment-dots text-orange-600"></i>
          Submit Feedback & Suggestions
        </h3>
        <button id="close-feedback-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="mb-6">
        <p class="text-gray-600 text-sm leading-relaxed">
          Help us improve the vehicle activity reporting system! Share your thoughts on the design, features, usability, or suggest new functionality. Your feedback is valuable and will be reviewed by our development team.
        </p>
      </div>

      <form id="feedback-form" class="space-y-6">
        <!-- Name Field -->
        <div>
          <label for="feedback-name" class="block text-sm font-medium text-gray-700 mb-2">
            Your Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="feedback-name" 
            name="name"
            required
            placeholder="Enter your full name"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors"
          >
        </div>

        <!-- Feedback/Note Field -->
        <div>
          <label for="feedback-note" class="block text-sm font-medium text-gray-700 mb-2">
            Feedback & Comments <span class="text-red-500">*</span>
          </label>
          <textarea 
            id="feedback-note" 
            name="note"
            required
            rows="8"
            placeholder="Please describe your feedback, suggestions, or issues in detail. Be specific about what you liked, what could be improved, or what new features you'd like to see..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors resize-vertical"
          ></textarea>
          <div class="mt-1 text-xs text-gray-500">
            <span id="char-count">0</span>/1000 characters
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row gap-3 pt-4">
          <button 
            type="submit" 
            id="submit-feedback-btn"
            class="flex-1 px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 focus:ring-4 focus:ring-orange-500/20 transition-all font-medium flex items-center justify-center gap-2"
          >
            <i class="fas fa-paper-plane"></i>
            Submit Feedback
          </button>
          <button 
            type="button" 
            id="cancel-feedback-btn"
            class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:ring-4 focus:ring-gray-500/20 transition-all font-medium"
          >
            Cancel
          </button>
        </div>
      </form>

      <!-- Success Message -->
      <div id="feedback-success" class="hidden text-center py-8">
        <div class="mb-4">
          <i class="fas fa-check-circle text-5xl text-green-500"></i>
        </div>
        <h4 class="text-xl font-bold text-gray-900 mb-2">Feedback Submitted Successfully!</h4>
        <p class="text-gray-600 mb-4">Thank you for your valuable feedback. Our team will review it and get back to you if needed.</p>
        <button id="submit-another-feedback" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
          Submit Another Feedback
        </button>
      </div>
    </div>
  </div>

  <!-- View Feedback Modal -->
  <div id="view-feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-comments text-orange-600"></i>
          Submitted Feedback & Comments
        </h3>
        <button id="close-view-feedback-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- Feedback Controls -->
      <div class="mb-6 flex flex-wrap gap-3">
        <button id="refresh-feedback" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
          <i class="fas fa-sync mr-1"></i> Refresh
        </button>
        <button id="export-feedback" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
          <i class="fas fa-download mr-1"></i> Export JSON
        </button>
        <button id="clear-feedback" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
          <i class="fas fa-trash mr-1"></i> Clear All
        </button>
      </div>

      <!-- Feedback List -->
      <div id="feedback-list" class="space-y-4 max-h-96 overflow-y-auto">
        <!-- Feedback items will be populated here -->
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-comments text-4xl mb-3"></i>
          <p>No feedback submitted yet. Encourage your team to share their thoughts!</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== FEEDBACK SYSTEM =====
    class FeedbackManager {
      constructor() {
        this.storage = window.feedbackStorage;
        this.setupEventListeners();
      }

      setupEventListeners() {
        // Feedback toggle button
        const feedbackToggle = document.getElementById('feedback-toggle');
        if (feedbackToggle) {
          feedbackToggle.addEventListener('click', () => this.openFeedbackModal());
        }

        // Modal controls
        const closeFeedbackModal = document.getElementById('close-feedback-modal');
        if (closeFeedbackModal) {
          closeFeedbackModal.addEventListener('click', () => this.closeFeedbackModal());
        }

        const cancelFeedbackBtn = document.getElementById('cancel-feedback-btn');
        if (cancelFeedbackBtn) {
          cancelFeedbackBtn.addEventListener('click', () => this.closeFeedbackModal());
        }

        // Form submission
        const feedbackForm = document.getElementById('feedback-form');
        if (feedbackForm) {
          feedbackForm.addEventListener('submit', (e) => this.handleSubmitFeedback(e));
        }

        // Character counter
        const feedbackNote = document.getElementById('feedback-note');
        if (feedbackNote) {
          feedbackNote.addEventListener('input', () => this.updateCharacterCount());
        }

        // Submit another feedback
        const submitAnotherBtn = document.getElementById('submit-another-feedback');
        if (submitAnotherBtn) {
          submitAnotherBtn.addEventListener('click', () => this.resetFeedbackForm());
        }

        // Feedback controls
        const refreshBtn = document.getElementById('refresh-feedback');
        const exportBtn = document.getElementById('export-feedback');
        const clearBtn = document.getElementById('clear-feedback');

        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => this.loadFeedback());
        }
        if (exportBtn) {
          exportBtn.addEventListener('click', () => this.exportFeedback());
        }
        if (clearBtn) {
          clearBtn.addEventListener('click', () => this.clearAllFeedback());
        }
      }

      openFeedbackModal() {
        const modal = document.getElementById('feedback-modal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          
          // Focus on first input
          const nameInput = document.getElementById('feedback-name');
          if (nameInput) {
            setTimeout(() => nameInput.focus(), 100);
          }
        }
      }

      closeFeedbackModal() {
        const modal = document.getElementById('feedback-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      openViewFeedbackModal() {
        const modal = document.getElementById('view-feedback-modal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          this.loadFeedback();
        }
      }

      closeViewFeedbackModal() {
        const modal = document.getElementById('view-feedback-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      updateCharacterCount() {
        const textarea = document.getElementById('feedback-note');
        const counter = document.getElementById('char-count');
        if (textarea && counter) {
          const count = textarea.value.length;
          counter.textContent = count;
          
          if (count > 1000) {
            counter.style.color = '#ef4444';
            textarea.value = textarea.value.substring(0, 1000);
            counter.textContent = '1000';
          } else {
            counter.style.color = '#6b7280';
          }
        }
      }

      async handleSubmitFeedback(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-feedback-btn');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
        submitBtn.disabled = true;

        try {
          const formData = new FormData(e.target);
          const feedbackData = {
            id: Date.now().toString(),
            name: formData.get('name'),
            note: formData.get('note'),
            timestamp: new Date().toISOString(),
            system: 'Vehicle Activity Reporting System'
          };

          // Validate required fields
          if (!feedbackData.name || !feedbackData.note) {
            throw new Error('Please fill in all required fields');
          }

          // Save using the feedback storage system
          const success = this.storage.saveFeedback(feedbackData);
          if (!success) {
            throw new Error('Failed to save feedback to storage');
          }
          
          // Show success message
          this.showSuccessMessage();
          
        } catch (error) {
          console.error('Error submitting feedback:', error);
          alert('Error submitting feedback: ' + error.message);
          
          // Restore button state
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      showSuccessMessage() {
        const form = document.getElementById('feedback-form');
        const success = document.getElementById('feedback-success');
        
        if (form && success) {
          form.classList.add('hidden');
          success.classList.remove('hidden');
        }
      }

      resetFeedbackForm() {
        const form = document.getElementById('feedback-form');
        const success = document.getElementById('feedback-success');
        const submitBtn = document.getElementById('submit-feedback-btn');
        
        if (form) {
          form.reset();
          form.classList.remove('hidden');
        }
        
        if (success) {
          success.classList.add('hidden');
        }
        
        if (submitBtn) {
          submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Feedback';
          submitBtn.disabled = false;
        }

        // Reset character counter
        const counter = document.getElementById('char-count');
        if (counter) {
          counter.textContent = '0';
        }
      }

      loadFeedback() {
        const feedbackList = document.getElementById('feedback-list');
        if (!feedbackList) return;

        // Get all feedback from storage
        const allFeedback = this.storage.getAllFeedback();

        // Sort by timestamp (newest first)
        allFeedback.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (allFeedback.length === 0) {
          feedbackList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-comments text-4xl mb-3"></i>
              <p>No feedback submitted yet. Encourage your team to share their thoughts!</p>
            </div>
          `;
          return;
        }

        // Render feedback items
        feedbackList.innerHTML = allFeedback.map(item => this.renderFeedbackItem(item)).join('');
      }

      renderFeedbackItem(feedback) {
        const date = new Date(feedback.timestamp).toLocaleDateString();
        const time = new Date(feedback.timestamp).toLocaleTimeString();

        return `
          <div class="border border-gray-200 rounded-lg p-4 bg-white hover:shadow-md transition-shadow">
            <div class="flex items-start gap-3 mb-3">
              <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                <span class="text-orange-600 font-semibold">${feedback.name.charAt(0).toUpperCase()}</span>
              </div>
              <div class="flex-1">
                <h4 class="font-semibold text-gray-900">${feedback.name}</h4>
                <p class="text-xs text-gray-500">${date} at ${time}</p>
              </div>
            </div>
            
            <div class="mb-3">
              <p class="text-gray-700 leading-relaxed">${feedback.note}</p>
            </div>
          </div>
        `;
      }

      exportFeedback() {
        try {
          this.storage.exportFeedback();
          this.showNotification('Feedback exported successfully!', 'success');
        } catch (error) {
          console.error('Error exporting feedback:', error);
          this.showNotification('Error exporting feedback', 'error');
        }
      }

      clearAllFeedback() {
        if (confirm('Are you sure you want to clear all feedback? This action cannot be undone.')) {
          this.storage.clearAllFeedback();
          this.loadFeedback();
          this.showNotification('All feedback cleared successfully!', 'success');
        }
      }

      showNotification(message, type = 'info') {
        // Create a simple notification
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
          type === 'success' ? 'bg-green-500 text-white' :
          type === 'error' ? 'bg-red-500 text-white' :
          'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }
    }

    // Initialize feedback system
    let feedbackManager;
    document.addEventListener('DOMContentLoaded', function() {
      feedbackManager = new FeedbackManager();
    });
  </script>
</body>
</html>