<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Closed Alerts - Lynx Lite</title>
  <!-- Production-ready with React 18, optimized resolution times, and Google Sheets feedback integration -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.2/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <!-- Feedback Storage System -->
  <script src="feedback-storage.js"></script>
  
  <!-- Production environment configuration -->
  <script>
    // Suppress development warnings in production
    const isProduction = window.location.hostname !== 'localhost' && 
                        window.location.hostname !== '127.0.0.1' && 
                        !window.location.hostname.includes('dev') &&
                        !window.location.hostname.includes('test');
    
    if (isProduction) {
      // Suppress console warnings
      const noop = () => {};
      console.warn = noop;
      console.info = noop;
      
      // Suppress specific React warnings
      const originalWarn = console.warn;
      console.warn = function(...args) {
        if (args[0] && typeof args[0] === 'string' && 
            (args[0].includes('ReactDOM.render') || 
             args[0].includes('createRoot') ||
             args[0].includes('React 17'))) {
          return; // Suppress React warnings
        }
        originalWarn.apply(console, args);
      };
    }
  </script>
  
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark body {
      background: linear-gradient(to bottom, #1f2937, #111827);
      color: #f3f4f6;
    }
    .alert-card {
      background: linear-gradient(145deg, #fff, #f8fafc);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-radius: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
      border-left: 8px solid #64748b;
    }
    .dark .alert-card {
      background: linear-gradient(145deg, #374151, #1f2937);
    }
    .alert-card.critical { border-left-color: #DC2626; }
    .alert-card.warning { border-left-color: #EAB308; }
    .alert-card.info { border-left-color: #2563eb; }
    .alert-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(37,99,235,0.2);
    }
    .alert-type-chip {
      font-size: 0.85rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-weight: 600;
      margin-right: 0.5rem;
      display: inline-block;
    }
    .chip-camera-issues { background: #fee2e2; color: #DC2626; }
    .chip-black-trips { background: #fef3c7; color: #92400e; }
    .chip-over-speeding { background: #fef9c3; color: #EAB308; }
    .chip-towing { background: #dbeafe; color: #2563eb; }
    .dark .chip-camera-issues { background: #7f1d1d; color: #fee2e2; }
    .dark .chip-black-trips { background: #92400e; color: #fef3c7; }
    .dark .chip-over-speeding { background: #854d0e; color: #fef9c3; }
    .dark .chip-towing { background: #1e40af; color: #dbeafe; }
    .alert-timestamp { font-size: 0.85rem; color: #64748b; }
    .dark .alert-timestamp { color: #9ca3af; }
    .alert-list { max-height: 60vh; overflow-y: auto; }
    .modal {
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    .dark .modal-content {
      background: #1f2937;
      color: #f3f4f6;
    }
    @media (max-width: 768px) {
      .alert-list { max-height: 50vh; }
      .alert-actions { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Simulated alert data with resolution status - aligned with active alerts
    const initialAlerts = Array.from({ length: 50 }, (_, i) => {
      // Define alert types matching active alerts page
      const alertTypes = ['camera-issues', 'black-trips', 'over-speeding', 'towing'];
      const alertType = alertTypes[i % alertTypes.length];
      
      // Generate realistic messages based on alert type
      let message, details;
      const vehicleId = `VEHICLE-${String(i % 20 + 1).padStart(3, '0')}`;
      const timestamp = new Date(Date.now() - Math.random() * 7 * 24 * 3600000); // Last 7 days
      // Generate realistic resolution time: 5 minutes to 4 hours (300,000 to 14,400,000 ms)
      // This prevents unrealistic resolution times like 677 minutes that were occurring before
      // Previous code was adding up to 24 hours randomly, which could result in very long times
      const resolutionTimeMs = 300000 + Math.random() * 14100000; // 5 min to 4 hours
      const resolutionTimestamp = new Date(timestamp.getTime() + resolutionTimeMs);
      
      switch (alertType) {
        case 'camera-issues':
          message = `Camera ${i % 3 === 0 ? 'disconnected' : i % 2 === 0 ? 'offline' : 'tampering detected'} on ${vehicleId}`;
          details = `Camera monitoring system ${i % 3 === 0 ? 'lost connection' : i % 2 === 0 ? 'went offline' : 'showed signs of tampering'}. Issue was ${i % 2 === 0 ? 'resolved by system restart' : 'fixed by technician'}.`;
          break;
        case 'black-trips':
          message = `Unauthorized trip detected on ${vehicleId} - ${i % 2 === 0 ? 'route deviation' : 'off-schedule activity'}`;
          details = `Vehicle ${vehicleId} was detected ${i % 2 === 0 ? 'deviating from assigned route' : 'operating outside scheduled hours'}. Driver was contacted and ${i % 2 === 0 ? 'returned to route' : 'returned to depot'}.`;
          break;
        case 'over-speeding':
          message = `Speed violation on ${vehicleId} - ${(80 + Math.random() * 40).toFixed(0)} km/h in ${i % 2 === 0 ? '50 km/h' : '60 km/h'} zone`;
          details = `Vehicle ${vehicleId} exceeded speed limit by ${(20 + Math.random() * 20).toFixed(0)} km/h. Driver was ${i % 2 === 0 ? 'warned' : 'issued citation'} and ${i % 2 === 0 ? 'training scheduled' : 'retraining completed'}.`;
          break;
        case 'towing':
          message = `Unauthorized towing detected on ${vehicleId} - ${i % 2 === 0 ? 'unauthorized hookup' : 'unauthorized movement'}`;
          details = `Vehicle ${vehicleId} was detected ${i % 2 === 0 ? 'being hooked up without authorization' : 'moving without proper clearance'}. Issue was ${i % 2 === 0 ? 'resolved by security intervention' : 'resolved by driver verification'}.`;
          break;
        default:
          message = `System alert on ${vehicleId}`;
          details = `General system alert for vehicle ${vehicleId}.`;
      }
      
              return {
      id: `ALERT-${i+1}`,
          vehicleId: vehicleId,
          type: alertType,
          message: message,
          timestamp: timestamp,
      resolved: true,
          resolutionStatus: i % 3 === 0 ? 'resolved' : i % 2 === 0 ? 'archived' : 'closed',
          resolutionTimestamp: resolutionTimestamp,
      snoozed: false,
      snoozeUntil: null,
          details: details,
          duration: Math.floor(Math.random() * 3600) + 300, // 5 minutes to 1 hour
          driverName: i % 4 === 0 ? `Driver-${String(i % 10 + 1).padStart(2, '0')}` : null,
          evidence: i % 2 === 0 ? [
            {
              type: 'image',
              url: `evidence_${i+1}.jpg`,
              timestamp: timestamp
            }
          ] : [],
          // Resolution notes and accountability
          resolutionNotes: i % 3 === 0 ? 
            `Driver contacted via radio at ${resolutionTimestamp.toLocaleTimeString()}. Issue resolved remotely after system diagnostics. Driver acknowledged the alert and returned to assigned route. No further action required.` :
            i % 2 === 0 ? 
            `On-site investigation conducted. Driver interviewed and corrective action implemented. Route deviation explained and documented. Enhanced monitoring activated for this vehicle.` :
            `Technical issue identified and resolved by maintenance team. System updated and tested. Performance metrics restored to normal levels. Alert threshold adjusted to prevent false positives.`,
          resolvedBy: i % 3 === 0 ? 'John Smith (Fleet Manager)' : i % 2 === 0 ? 'Sarah Johnson (Security Officer)' : 'Mike Davis (Technician)',
          resolverId: i % 3 === 0 ? 'USER-001' : i % 2 === 0 ? 'USER-002' : 'USER-003',
          resolverRole: i % 3 === 0 ? 'Fleet Manager' : i % 2 === 0 ? 'Security Officer' : 'Technician',
          resolutionMethod: i % 3 === 0 ? 'Remote Resolution' : i % 2 === 0 ? 'On-site Investigation' : 'System Maintenance',
          // Audit trail information
          auditTrail: {
            resolvedBy: i % 3 === 0 ? 'John Smith (Fleet Manager)' : i % 2 === 0 ? 'Sarah Johnson (Security Officer)' : 'Mike Davis (Technician)',
            resolverId: i % 3 === 0 ? 'USER-001' : i % 2 === 0 ? 'USER-002' : 'USER-003',
            resolverRole: i % 3 === 0 ? 'Fleet Manager' : i % 2 === 0 ? 'Security Officer' : 'Technician',
            resolutionMethod: i % 3 === 0 ? 'Remote Resolution' : i % 2 === 0 ? 'On-site Investigation' : 'System Maintenance',
            procedures: i % 3 === 0 ? [
              'Alert notification received',
              'Remote system diagnostics performed',
              'Driver contacted via radio',
              'Issue resolved remotely',
              'Resolution documented'
            ] : i % 2 === 0 ? [
              'Alert escalated to security',
              'On-site investigation conducted',
              'Evidence collected and documented',
              'Driver interviewed',
              'Corrective action implemented'
            ] : [
              'Technical issue identified',
              'Maintenance team dispatched',
              'Hardware/software updated',
              'System tested and verified',
              'Resolution confirmed'
            ],
            verificationSteps: i % 3 === 0 ? [
              'System status confirmed online',
              'Driver acknowledgment received',
              'No recurrence for 24 hours'
            ] : i % 2 === 0 ? [
              'Route compliance verified',
              'Driver training completed',
              'Monitoring enhanced'
            ] : [
              'System functionality restored',
              'Performance metrics normal',
              'Alert threshold adjusted'
            ],
            complianceNotes: i % 3 === 0 ? 'All procedures followed per fleet management protocol' : 
                            i % 2 === 0 ? 'Security protocols fully implemented' : 
                            'Technical standards maintained',
            supervisorApproval: i % 2 === 0 ? 'Approved by Lisa Wilson (Operations Director)' : 'Auto-approved per protocol',
            qualityScore: Math.floor(Math.random() * 20) + 80, // 80-100
            followUpRequired: i % 4 === 0,
            followUpDate: i % 4 === 0 ? new Date(resolutionTimestamp.getTime() + 7 * 24 * 3600000) : null,
            followUpNotes: i % 4 === 0 ? 'Schedule driver training session' : null
          }
        };
    });

    // Chart instances for analytics
    let resolutionTypeChart = null;
    let resolutionTimeChart = null;

         // Resolution Analytics Component
     const ResolutionAnalytics = ({ alerts }) => {
       const chartContainerRef = React.useRef(null);
       const timeChartContainerRef = React.useRef(null);

       // Calculate type counts at component level so it can be used in JSX
       const typeCounts = React.useMemo(() => {
         const counts = {};
         alerts.forEach(alert => {
           counts[alert.type] = (counts[alert.type] || 0) + 1;
         });
         return counts;
       }, [alerts]);

                     const renderResolutionTypeChart = (alerts) => {
          const ctx = document.getElementById('resolutionTypeChart');
          if (!ctx) {
            console.error('Canvas element resolutionTypeChart not found');
            return;
          }

          // Destroy existing chart if it exists
          if (resolutionTypeChart) {
            resolutionTypeChart.destroy();
          }

          // Use the typeCounts from component level
          
          // Get the top 4 most common types, or use all if less than 4
          const sortedTypes = Object.entries(typeCounts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 4)
            .map(([type]) => type);
          
          // Create chart data with actual types
          const chartData = sortedTypes.map(type => typeCounts[type]);
          const chartLabels = sortedTypes.map(type => 
            type.charAt(0).toUpperCase() + type.slice(1).replace('-', ' ')
          );
         
         console.log('Type counts:', typeCounts);
         console.log('Total alerts:', alerts.length);
         console.log('Sample alert:', alerts[0]);

         // Check if Chart.js is available
         if (typeof Chart === 'undefined') {
           console.error('Chart.js library not loaded');
           return;
         }

                   console.log('Chart data:', chartData);
          console.log('Chart labels:', chartLabels);

          resolutionTypeChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: chartLabels,
              datasets: [{
                label: 'Resolved Alerts',
                data: chartData,
                               backgroundColor: sortedTypes.map((type, index) => {
                  const colors = [
                    'rgba(220, 38, 38, 0.8)',   // Red
                    'rgba(146, 64, 14, 0.8)',   // Amber
                    'rgba(234, 179, 8, 0.8)',   // Yellow
                    'rgba(37, 99, 235, 0.8)'    // Blue
                  ];
                  return colors[index] || 'rgba(107, 114, 128, 0.8)';
                }),
                borderColor: sortedTypes.map((type, index) => {
                  const colors = [
                    'rgba(220, 38, 38, 1)',     // Red
                    'rgba(146, 64, 14, 1)',     // Amber
                    'rgba(234, 179, 8, 1)',     // Yellow
                    'rgba(37, 99, 235, 1)'      // Blue
                  ];
                  return colors[index] || 'rgba(107, 114, 128, 1)';
                }),
               borderWidth: 2,
               borderRadius: 8,
               borderSkipped: false
             }]
           },
           options: {
             responsive: true,
             maintainAspectRatio: false,
             plugins: {
               legend: {
                 display: false
               },
               tooltip: {
                 backgroundColor: document.body.classList.contains('dark') ? '#1f2937' : '#ffffff',
                 titleColor: document.body.classList.contains('dark') ? '#e5e7eb' : '#374151',
                 bodyColor: document.body.classList.contains('dark') ? '#e5e7eb' : '#374151',
                 borderColor: document.body.classList.contains('dark') ? '#4b5563' : '#e5e7eb',
                 borderWidth: 1,
                 callbacks: {
                   label: function(context) {
                     return `Resolved: ${context.parsed.y} alerts`;
                   }
                 }
               }
             },
             scales: {
               y: {
                 beginAtZero: true,
                 grid: {
                   color: document.body.classList.contains('dark') ? '#374151' : '#f3f4f6',
                   lineWidth: 0.5
                 },
                 ticks: {
                   color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280',
                   stepSize: 1
                 }
               },
               x: {
                 grid: {
                   display: false
                 },
                 ticks: {
                   color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280'
                 }
               }
             }
           }
         });
       };

                          

      const renderResolutionTimeChart = (alerts) => {
        const ctx = document.getElementById('resolutionTimeChart');
        if (!ctx) {
          console.error('Canvas element resolutionTimeChart not found');
          return;
        }

         // Destroy existing chart if it exists
         if (resolutionTimeChart) {
           resolutionTimeChart.destroy();
         }

         // Check if Chart.js is available
         if (typeof Chart === 'undefined') {
           console.error('Chart.js library not loaded');
           return;
         }

         console.log('Rendering time chart with alerts:', alerts.length);
         console.log('Sample alert for time chart:', alerts[0]);

         // Get the date range of our alerts - ensure we handle the data correctly
         const alertDates = alerts.map(alert => {
           const date = new Date(alert.resolutionTimestamp);
           return new Date(date.getFullYear(), date.getMonth(), date.getDate());
         });
         
         // Check if we have valid dates
         const validDates = alertDates.filter(date => !isNaN(date.getTime()));
         if (validDates.length === 0) {
           console.error('No valid resolution dates found in alerts');
           return;
         }
         
         const minDate = new Date(Math.min(...validDates));
         const maxDate = new Date(Math.max(...validDates));
         
         console.log('Date range:', minDate.toLocaleDateString(), 'to', maxDate.toLocaleDateString());
         console.log('Total days in range:', Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1);
         
         // If all alerts are on the same day, create a 7-day range for better visualization
         let startDate, endDate;
         if (minDate.getTime() === maxDate.getTime()) {
           // All alerts on same day, create a 7-day range
           startDate = new Date(minDate);
           startDate.setDate(startDate.getDate() - 3); // 3 days before
           endDate = new Date(maxDate);
           endDate.setDate(endDate.getDate() + 3); // 3 days after
           console.log('All alerts on same day, expanding range to:', startDate.toLocaleDateString(), 'to', endDate.toLocaleDateString());
         } else {
           startDate = new Date(minDate);
           endDate = new Date(maxDate);
         }
         
         // Generate labels for the date range of our data
         const labels = [];
         const avgResolutionTimes = [];
         
         const currentDate = new Date(startDate);
         while (currentDate <= endDate) {
           labels.push(currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
           
           // Calculate average resolution time for this date
           const dayStart = new Date(currentDate);
           dayStart.setHours(0, 0, 0, 0);
           const dayEnd = new Date(currentDate);
           dayEnd.setHours(23, 59, 59, 999);

           const dayAlerts = alerts.filter(alert => {
             const alertDate = new Date(alert.resolutionTimestamp);
             return alertDate >= dayStart && alertDate <= dayEnd;
           });

           if (dayAlerts.length > 0) {
             const totalResolutionTime = dayAlerts.reduce((sum, alert) => {
               const resolutionTime = calculateResolutionTime(alert);
               return sum + resolutionTime;
             }, 0);
             const avgTime = Math.round(totalResolutionTime / dayAlerts.length);
             avgResolutionTimes.push(avgTime);
             console.log(`Day ${currentDate.toLocaleDateString()}: ${dayAlerts.length} alerts, avg time: ${avgTime} minutes`);
           } else {
             avgResolutionTimes.push(0);
             console.log(`Day ${currentDate.toLocaleDateString()}: No alerts`);
           }
           
           // Move to next day
           currentDate.setDate(currentDate.getDate() + 1);
         }

         console.log('Time chart data:', { labels, avgResolutionTimes });

         resolutionTimeChart = new Chart(ctx, {
           type: 'line',
           data: {
             labels: labels,
             datasets: [{
               label: 'Average Resolution Time (minutes)',
               data: avgResolutionTimes,
               borderColor: '#8b5cf6',
               backgroundColor: 'rgba(139, 92, 246, 0.1)',
               borderWidth: 3,
               fill: true,
               tension: 0.4,
               pointRadius: 6,
               pointHoverRadius: 8,
               pointBackgroundColor: '#8b5cf6',
               pointBorderColor: '#ffffff',
               pointBorderWidth: 2
             }]
           },
           options: {
             responsive: true,
             maintainAspectRatio: false,
             plugins: {
               legend: {
                 display: false
               },
               tooltip: {
                 backgroundColor: document.body.classList.contains('dark') ? '#1f2937' : '#ffffff',
                 titleColor: document.body.classList.contains('dark') ? '#e5e7eb' : '#374151',
                 bodyColor: document.body.classList.contains('dark') ? '#e5e7eb' : '#374151',
                 borderColor: document.body.classList.contains('dark') ? '#4b5563' : '#e5e7eb',
                 borderWidth: 1,
                 callbacks: {
                   label: function(context) {
                     return `Avg Resolution Time: ${context.parsed.y} minutes`;
                   }
                 }
               }
             },
             scales: {
               y: {
                 beginAtZero: true,
                 grid: {
                   color: document.body.classList.contains('dark') ? '#374151' : '#f3f4f6',
                   lineWidth: 0.5
                 },
                 ticks: {
                   color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280',
                   callback: function(value) {
                     return value + ' min';
                   }
                 }
               },
               x: {
                 grid: {
                   color: document.body.classList.contains('dark') ? '#374151' : '#f3f4f6',
                   lineWidth: 0.5
                 },
                 ticks: {
                   color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280'
                 }
               }
             }
           }
         });
       };

             React.useEffect(() => {
         // Add a longer delay to ensure DOM elements are ready
         const timer = setTimeout(() => {
           if (alerts && alerts.length > 0) {
                           try {
                console.log('Attempting to render charts with', alerts.length, 'alerts');
                renderResolutionTypeChart(alerts);
                renderResolutionTimeChart(alerts);
                
                // Hide fallback displays if charts render successfully
                const fallback1 = document.getElementById('resolutionTypeChartFallback');
                const fallback2 = document.getElementById('resolutionTimeChartFallback');
                const fallbackData1 = document.getElementById('resolutionTypeChartFallbackData');
                const fallbackData2 = document.getElementById('resolutionTimeChartFallbackData');
                if (fallback1) fallback1.classList.add('hidden');
                if (fallback2) fallback2.classList.add('hidden');
                if (fallbackData1) fallbackData1.classList.add('hidden');
                if (fallbackData2) fallbackData2.classList.add('hidden');
              } catch (error) {
                console.error('Error rendering charts:', error);
                // Show fallback content
                const fallback1 = document.getElementById('resolutionTypeChartFallback');
                const fallback2 = document.getElementById('resolutionTimeChartFallback');
                const fallbackData1 = document.getElementById('resolutionTypeChartFallbackData');
                const fallbackData2 = document.getElementById('resolutionTimeChartFallbackData');
                if (fallback1) fallback1.classList.remove('hidden');
                if (fallback2) fallback2.classList.remove('hidden');
                if (fallbackData1) fallbackData1.classList.remove('hidden');
                if (fallbackData2) fallbackData2.classList.remove('hidden');
              }
           } else {
             console.log('No alerts data available for charts');
           }
         }, 500); // Increased delay
         
         return () => clearTimeout(timer);
       }, [alerts]);

             return (
         <div className="mb-8">
           <div className="flex items-center justify-between mb-6">
             <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center">
               <i className="fas fa-chart-line mr-2 text-purple-500"></i>
               Resolution Analytics Dashboard
             </h2>
             <div className="text-sm text-gray-600 dark:text-gray-400">
               <i className="fas fa-info-circle mr-1"></i>
               Critical alerts resolved fastest for safety
             </div>
           </div>
           
                                     {/* Enhanced Data Summary - Comprehensive fleet performance overview */}
              <div className="mb-6 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-700 rounded-xl shadow-sm">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-bold text-gray-900 dark:text-gray-100 flex items-center">
                  <i className="fas fa-chart-pie mr-2 text-blue-600"></i>
                  Comprehensive Data Summary
                </h3>
                <div className="text-xs text-blue-600 dark:text-blue-400 bg-blue-100 dark:bg-blue-800 px-2 py-1 rounded-full">
                  Last 7 Days
                </div>
              </div>
              
              {/* Primary Statistics Row */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
                <div className="text-center">
                  <div className="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-1">{alerts.length}</div>
                  <div className="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">Total Alerts</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-green-600 mb-1">
                    {alerts.length > 0 ? 
                      Math.round(alerts.reduce((sum, alert) => {
                        const func = window.calculateResolutionTime || window.calculateResolutionTimeFallback;
                        return sum + (func ? func(alert) : 30);
                      }, 0) / alerts.length) : 0
                    }
                  </div>
                  <div className="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">Avg Resolution (min)</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-blue-600 mb-1">
                    {alerts.length > 0 ? 
                      Math.min(...alerts.map(alert => window.calculateResolutionTime(alert))) : 0
                    }
                  </div>
                  <div className="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">Fastest (min)</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-purple-600 mb-1">
                    {alerts.length > 0 ? 
                      Math.max(...alerts.map(alert => window.calculateResolutionTime(alert))) : 0
                    }
                  </div>
                  <div className="text-xs text-gray-600 dark:text-gray-400 uppercase tracking-wide">Slowest (min)</div>
                </div>
              </div>

              {/* Alert Type Distribution */}
              <div className="mb-6">
                <h4 className="font-semibold mb-3 text-gray-800 dark:text-gray-200 text-sm uppercase tracking-wide">Alert Type Distribution</h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {Object.entries(typeCounts).map(([type, count], index) => {
                    const percentage = alerts.length > 0 ? Math.round((count / alerts.length) * 100) : 0;
                    const colors = {
                      'camera-issues': 'text-red-600 dark:text-red-400',
                      'black-trips': 'text-amber-600 dark:text-amber-400', 
                      'over-speeding': 'text-yellow-600 dark:text-yellow-400',
                      'towing': 'text-blue-600 dark:text-blue-400'
                    };
                    return (
                      <div key={type} className="bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                        <div className="flex items-center justify-between mb-1">
                          <span className={`font-semibold ${colors[type] || 'text-gray-600'}`}>
                            {type.charAt(0).toUpperCase() + type.slice(1).replace('-', ' ')}
                          </span>
                          <span className="text-lg font-bold text-gray-900 dark:text-gray-100">{count}</span>
                        </div>
                        <div className="text-xs text-gray-500 dark:text-gray-400">{percentage}% of total</div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Performance Metrics */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Resolution Efficiency</span>
                    <span className="text-lg font-bold text-green-600">
                      {alerts.length > 0 ? 
                        Math.round((alerts.filter(alert => window.calculateResolutionTime(alert) <= 60).length / alerts.length) * 100) : 0
                      }%
                    </span>
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Resolved within 1 hour
                  </div>
                </div>
                
                <div className="bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Critical Response</span>
                    <span className="text-lg font-bold text-red-600">
                      {alerts.length > 0 ? 
                        Math.round((alerts.filter(alert => window.calculateResolutionTime(alert) <= 30).length / alerts.length) * 100) : 0
                      }%
                    </span>
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Resolved within 30 min
                  </div>
                </div>
                
                <div className="bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600 dark:text-gray-400">Avg Daily Volume</span>
                    <span className="text-lg font-bold text-blue-600">
                      {Math.ceil(alerts.length / 7)}
                    </span>
                  </div>
                  <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Alerts per day
                  </div>
                </div>
              </div>

              {/* Quick Insights */}
              <div className="mt-4 p-3 bg-blue-100 dark:bg-blue-800/30 rounded-lg border-l-4 border-blue-500">
                <div className="flex items-start">
                  <i className="fas fa-lightbulb text-blue-600 mt-1 mr-2"></i>
                  <div className="text-sm text-blue-800 dark:text-blue-200">
                    <strong>Key Insights:</strong> 
                    {alerts.length > 0 ? (
                      <>
                        {Math.round((alerts.filter(alert => calculateResolutionTime(alert) <= 60).length / alerts.length) * 100) >= 80 ? 
                          ' Excellent response times with over 80% resolved within 1 hour.' :
                          ' Focus on improving response times for better operational efficiency.'
                        }
                        {' '}Most common issue: {Object.entries(typeCounts).reduce((a, b) => typeCounts[a[0]] > typeCounts[b[0]] ? a : b)[0].replace('-', ' ')}.
                      </>
                    ) : ' No alerts data available for analysis.'}
                  </div>
                </div>
              </div>
            </div>
          
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Resolution by Type Chart */}
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
              <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">
                <i className="fas fa-chart-bar mr-2 text-blue-500"></i>
                Resolved Alerts by Type
              </h3>
                             <div className="h-64 relative">
                 <canvas id="resolutionTypeChart" style={{width: '100%', height: '100%'}}></canvas>
                 <div id="resolutionTypeChartFallback" className="hidden text-center text-gray-500 dark:text-gray-400 mt-8">
                   <i className="fas fa-chart-bar text-4xl mb-2"></i>
                   <p>Chart data loading...</p>
                 </div>
                                                     {/* Simple data display as fallback */}
                   <div id="resolutionTypeChartFallbackData" className="hidden mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                     <h4 className="font-semibold mb-2 text-gray-900 dark:text-gray-100">Alert Distribution:</h4>
                     <div className="grid grid-cols-2 gap-2 text-sm">
                       {Object.entries(typeCounts).slice(0, 4).map(([type, count], index) => (
                         <div key={type} className="flex justify-between">
                           <span className={`${index === 0 ? 'text-red-600' : index === 1 ? 'text-amber-600' : index === 2 ? 'text-yellow-600' : 'text-blue-600'}`}>
                             {type.charAt(0).toUpperCase() + type.slice(1).replace('-', ' ')}:
                           </span>
                           <span className="font-semibold">{count}</span>
                         </div>
                       ))}
                     </div>
                   </div>
               </div>
              <div className="mt-4 text-sm text-gray-600 dark:text-gray-400">
                <i className="fas fa-lightbulb mr-1"></i>
                <strong>Insight:</strong> Camera issues and black trips show highest resolution rates, indicating priority handling of security-related alerts.
              </div>
            </div>

            {/* Average Resolution Time Chart */}
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
              <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">
                                 <i className="fas fa-clock mr-2 text-green-500"></i>
                 Average Resolution Time by Day
              </h3>
                             <div className="h-64 relative">
                 <canvas id="resolutionTimeChart" style={{width: '100%', height: '100%'}}></canvas>
                 <div id="resolutionTimeChartFallback" className="hidden text-center text-gray-500 dark:text-gray-400 mt-8">
                   <i className="fas fa-clock text-4xl mb-2"></i>
                   <p>Chart data loading...</p>
                 </div>
                                   {/* Simple data display as fallback */}
                  <div id="resolutionTimeChartFallbackData" className="hidden mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h4 className="font-semibold mb-2 text-gray-900 dark:text-gray-100">Resolution Time Summary:</h4>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600 dark:text-gray-400">Total Alerts:</span>
                        <span className="font-semibold">{alerts.length}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600 dark:text-gray-400">Avg Resolution Time:</span>
                        <span className="font-semibold text-green-600">
                          {alerts.length > 0 ? 
                            Math.round(alerts.reduce((sum, alert) => sum + window.calculateResolutionTime(alert), 0) / alerts.length) : 0
                          } min
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600 dark:text-gray-400">Fastest Resolution:</span>
                        <span className="font-semibold text-blue-600">
                          {alerts.length > 0 ? 
                            Math.min(...alerts.map(alert => window.calculateResolutionTime(alert))) : 0
                          } min
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600 dark:text-gray-400">Slowest Resolution:</span>
                        <span className="font-semibold text-red-600">
                          {alerts.length > 0 ? 
                            Math.max(...alerts.map(alert => window.calculateResolutionTime(alert))) : 0
                          } min
                        </span>
                      </div>
                    </div>
                  </div>
               </div>
              <div className="mt-4 text-sm text-gray-600 dark:text-gray-400">
                <i className="fas fa-lightbulb mr-1"></i>
                <strong>Insight:</strong> Resolution times trending downward, showing improved operational efficiency and faster response to critical alerts.
              </div>
            </div>
          </div>
        </div>
      );
    };

    const AlertCard = ({ alert, onDetails, onReopen }) => (
      <div className={`alert-card p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 ${alert.type}`}>
        <div className="flex-1">
          <div className="mb-2 flex items-center gap-2">
            <span className={`alert-type-chip chip-${alert.type}`}>
              {alert.type === 'camera-issues' && <i className="fas fa-video mr-1"></i>}
              {alert.type === 'black-trips' && <i className="fas fa-route mr-1"></i>}
              {alert.type === 'over-speeding' && <i className="fas fa-tachometer-alt mr-1"></i>}
              {alert.type === 'towing' && <i className="fas fa-truck-pickup mr-1"></i>}
              {alert.type.replace('-', ' ').charAt(0).toUpperCase() + alert.type.replace('-', ' ').slice(1)}
            </span>
            <span className="font-bold text-gray-900 dark:text-gray-100">{alert.vehicleId}</span>
            {alert.driverName && (
              <span className="inline-flex items-center px-2 py-1 bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100 text-xs font-medium rounded-full">
                <i className="fas fa-user mr-1"></i>
                {alert.driverName}
              </span>
            )}
            <span className="alert-timestamp">
              {alert.timestamp.toLocaleString()}
            </span>
            <span className={`text-sm px-2 py-1 rounded-full ${
              alert.resolutionStatus === 'resolved' ? 'bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-100' :
              alert.resolutionStatus === 'archived' ? 'bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-100' :
              'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100'
            }`}>
              {alert.resolutionStatus.charAt(0).toUpperCase() + alert.resolutionStatus.slice(1)}
            </span>
          </div>
          <div className="text-lg text-gray-700 dark:text-gray-300 mb-2">{alert.message}</div>
          <div className="text-sm text-gray-600 dark:text-gray-400">
            <span className="mr-4">
              <i className="fas fa-clock mr-1"></i>
              Duration: {Math.floor(alert.duration / 60)}m {alert.duration % 60}s
            </span>
            <span className="mr-4">
              <i className="fas fa-check-circle mr-1"></i>
              Resolved: {alert.resolutionTimestamp.toLocaleString()}
            </span>
            <span className="mr-4">
              <i className="fas fa-user-shield mr-1"></i>
              By: {alert.resolvedBy}
            </span>
            {alert.evidence && alert.evidence.length > 0 && (
              <span>
                <i className="fas fa-image mr-1"></i>
                Evidence: {alert.evidence.length} item{alert.evidence.length !== 1 ? 's' : ''}
              </span>
            )}
          </div>
          {alert.resolutionNotes && (
            <div className="mt-2 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg">
              <div className="text-sm text-blue-800 dark:text-blue-200">
                <i className="fas fa-sticky-note mr-1"></i>
                <strong>Resolution Notes:</strong> {alert.resolutionNotes}
              </div>
            </div>
          )}
        </div>
        <div className="alert-actions flex gap-2">
          <button
            className="details-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            title="View Details"
            onClick={() => onDetails(alert)}
          >
            <i className="fas fa-info-circle mr-1"></i>Details
          </button>
          <button
            className="audit-btn bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700"
            title="View Audit Trail"
            onClick={() => onDetails({...alert, showAudit: true})}
          >
            <i className="fas fa-shield-alt mr-1"></i>Audit
          </button>
          <button
            className="reopen-btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
            title="Reopen Alert"
             onClick={() => onReopen(alert)}
          >
            <i className="fas fa-undo mr-1"></i>Reopen
          </button>
        </div>
      </div>
    );

    const AlertModal = ({ alert, onClose }) => (
      <div className="modal fixed inset-0 flex items-center justify-center z-50">
        <div className="modal-content p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">
              <i className="fas fa-shield-alt mr-2 text-purple-500"></i>
              Alert Details & Audit Trail
            </h2>
            <button
              onClick={onClose}
              className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
            >
              <i className="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Left Column - Basic Information */}
            <div className="space-y-4">
              <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <h3 className="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                  <i className="fas fa-info-circle mr-2 text-blue-500"></i>
                  Basic Information
                </h3>
                <div className="space-y-2 text-sm">
          <p><strong>Vehicle ID:</strong> {alert.vehicleId}</p>
                  {alert.driverName && <p><strong>Driver:</strong> {alert.driverName}</p>}
                  <p><strong>Type:</strong> 
                    <span className={`ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${alert.type === 'camera-issues' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100' : 
                      alert.type === 'black-trips' ? 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-100' :
                      alert.type === 'over-speeding' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100' :
                      'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100'}`}>
                      {alert.type === 'camera-issues' && <i className="fas fa-video mr-1"></i>}
                      {alert.type === 'black-trips' && <i className="fas fa-route mr-1"></i>}
                      {alert.type === 'over-speeding' && <i className="fas fa-tachometer-alt mr-1"></i>}
                      {alert.type === 'towing' && <i className="fas fa-truck-pickup mr-1"></i>}
                      {alert.type.replace('-', ' ').charAt(0).toUpperCase() + alert.type.replace('-', ' ').slice(1)}
                    </span>
                  </p>
          <p><strong>Message:</strong> {alert.message}</p>
                  <p><strong>Duration:</strong> {Math.floor(alert.duration / 60)}m {alert.duration % 60}s</p>
                </div>
              </div>
              
              <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <h3 className="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                  <i className="fas fa-clock mr-2 text-green-500"></i>
                  Timeline
                </h3>
                <div className="space-y-2 text-sm">
                  <p><strong>Alert Created:</strong> {alert.timestamp.toLocaleString()}</p>
                  <p><strong>Resolved:</strong> {alert.resolutionTimestamp.toLocaleString()}</p>
                                      <p><strong>Resolution Time:</strong> {window.calculateResolutionTime(alert)} minutes</p>
                  <p><strong>Status:</strong> 
                    <span className={`ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                      alert.resolutionStatus === 'resolved' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100' :
                      alert.resolutionStatus === 'archived' ? 'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100' :
                      'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100'
                    }`}>
                      {alert.resolutionStatus.charAt(0).toUpperCase() + alert.resolutionStatus.slice(1)}
                    </span>
                  </p>
                </div>
              </div>

                             <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                 <h3 className="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                   <i className="fas fa-sticky-note mr-2 text-blue-500"></i>
                   Resolution Notes
                 </h3>
                 <div className="text-sm text-gray-700 dark:text-gray-300">
                   {alert.resolutionNotes || 'No resolution notes provided.'}
                 </div>
               </div>

               {alert.reopenHistory && alert.reopenHistory.length > 0 && (
                 <div className="p-4 bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700 rounded-lg">
                   <h3 className="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                     <i className="fas fa-history mr-2 text-orange-500"></i>
                     Reopen History
                   </h3>
                   <div className="space-y-2 text-sm">
                     {alert.reopenHistory.map((reopen, index) => (
                       <div key={index} className="border-l-4 border-orange-400 pl-3">
                         <p className="text-orange-800 dark:text-orange-200">
                           <strong>Reopened by:</strong> {reopen.reopenedBy}
                         </p>
                         <p className="text-orange-700 dark:text-orange-300">
                           <strong>Reason:</strong> {reopen.reason}
                         </p>
                         <p className="text-orange-600 dark:text-orange-400 text-xs">
                           {reopen.timestamp.toLocaleString()}
                         </p>
                       </div>
                     ))}
                   </div>
                 </div>
               )}
            </div>

            {/* Right Column - Audit Trail */}
            <div className="space-y-4">
              <div className="p-4 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-700 rounded-lg">
                <h3 className="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                  <i className="fas fa-user-shield mr-2 text-purple-500"></i>
                  Resolution Accountability
                </h3>
                <div className="space-y-2 text-sm">
                  <p><strong>Resolved By:</strong> {alert.resolvedBy}</p>
                  <p><strong>Resolver ID:</strong> {alert.resolverId}</p>
                  <p><strong>Role:</strong> {alert.resolverRole}</p>
                  <p><strong>Method:</strong> {alert.resolutionMethod}</p>
                  <p><strong>Quality Score:</strong> 
                    <span className={`ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                      alert.auditTrail.qualityScore >= 90 ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100' :
                      alert.auditTrail.qualityScore >= 80 ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100' :
                      'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100'
                    }`}>
                      {alert.auditTrail.qualityScore}/100
                    </span>
                  </p>
                </div>
              </div>

              <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <h3 className="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                  <i className="fas fa-list-check mr-2 text-green-500"></i>
                  Procedures Followed
                </h3>
                <div className="space-y-1 text-sm">
                  {alert.auditTrail.procedures.map((procedure, index) => (
                    <div key={index} className="flex items-start">
                      <i className="fas fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                      <span className="text-gray-700 dark:text-gray-300">{procedure}</span>
                    </div>
                  ))}
                </div>
              </div>

              <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <h3 className="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                  <i className="fas fa-eye mr-2 text-blue-500"></i>
                  Verification Steps
                </h3>
                <div className="space-y-1 text-sm">
                  {alert.auditTrail.verificationSteps.map((step, index) => (
                    <div key={index} className="flex items-start">
                      <i className="fas fa-check text-blue-500 mr-2 mt-0.5"></i>
                      <span className="text-gray-700 dark:text-gray-300">{step}</span>
                    </div>
                  ))}
                </div>
              </div>

              <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <h3 className="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                  <i className="fas fa-gavel mr-2 text-orange-500"></i>
                  Compliance & Approval
                </h3>
                <div className="space-y-2 text-sm">
                  <p><strong>Compliance Notes:</strong> {alert.auditTrail.complianceNotes}</p>
                  <p><strong>Supervisor Approval:</strong> {alert.auditTrail.supervisorApproval}</p>
                  {alert.auditTrail.followUpRequired && (
                    <div className="mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded">
                      <p className="text-yellow-800 dark:text-yellow-200">
                        <i className="fas fa-exclamation-triangle mr-1"></i>
                        <strong>Follow-up Required:</strong> {alert.auditTrail.followUpNotes}
                      </p>
                      <p className="text-yellow-700 dark:text-yellow-300 text-xs mt-1">
                        Due: {alert.auditTrail.followUpDate?.toLocaleDateString()}
                      </p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
          
          <div className="mt-6 flex justify-end">
          <button
              className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            onClick={onClose}
          >
            Close
          </button>
          </div>
        </div>
      </div>
         );

     // Reopen Alert Modal Component
     const ReopenModal = ({ alert, onConfirm, onCancel, reason, setReason, reopenedBy, setReopenedBy }) => (
       <div className="modal fixed inset-0 flex items-center justify-center z-[9999]" style={{backgroundColor: 'rgba(0,0,0,0.8)'}}>
         <div className="modal-content p-6 w-full max-w-2xl">
           <div className="flex justify-between items-center mb-6">
             <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center">
               <i className="fas fa-undo mr-2 text-green-500"></i>
               Reopen Alert
             </h2>
             <button
               onClick={onCancel}
               className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
             >
               <i className="fas fa-times text-xl"></i>
             </button>
           </div>
           
           <div className="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
             <h3 className="font-semibold mb-2 text-gray-900 dark:text-gray-100">Alert Information</h3>
             <div className="text-sm text-gray-700 dark:text-gray-300 space-y-1">
               <p><strong>ID:</strong> {alert.id}</p>
               <p><strong>Vehicle:</strong> {alert.vehicleId}</p>
               <p><strong>Type:</strong> 
                 <span className={`ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${alert.type === 'camera-issues' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100' : 
                   alert.type === 'black-trips' ? 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-100' :
                   alert.type === 'over-speeding' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100' :
                   'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100'}`}>
                   {alert.type.replace('-', ' ').charAt(0).toUpperCase() + alert.type.replace('-', ' ').slice(1)}
                 </span>
               </p>
               <p><strong>Message:</strong> {alert.message}</p>
               <p><strong>Originally Resolved:</strong> {alert.resolutionTimestamp.toLocaleString()}</p>
               <p><strong>Resolved By:</strong> {alert.resolvedBy}</p>
             </div>
           </div>

           <div className="space-y-4">
             <div>
               <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                 <i className="fas fa-user mr-1"></i>
                 Your Name *
               </label>
               <input
                 type="text"
                 value={reopenedBy}
                 onChange={(e) => setReopenedBy(e.target.value)}
                 placeholder="Enter your full name"
                 className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-gray-100"
                 required
               />
             </div>

             <div>
               <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                 <i className="fas fa-comment mr-1"></i>
                 Reason for Reopening *
               </label>
               <select
                 value={reason}
                 onChange={(e) => setReason(e.target.value)}
                 className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-gray-100 mb-2"
                 required
               >
                 <option value="">Select a reason...</option>
                 <option value="Incomplete Resolution">Incomplete Resolution - Issue not fully addressed</option>
                 <option value="New Evidence">New Evidence - Additional information discovered</option>
                 <option value="Recurring Issue">Recurring Issue - Problem has occurred again</option>
                 <option value="Incorrect Resolution">Incorrect Resolution - Wrong solution applied</option>
                 <option value="Follow-up Required">Follow-up Required - Additional investigation needed</option>
                 <option value="Quality Review">Quality Review - Resolution quality check failed</option>
                 <option value="Compliance Issue">Compliance Issue - Regulatory requirements not met</option>
                 <option value="Other">Other - Please specify below</option>
               </select>
             </div>

                           <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  <i className="fas fa-edit mr-1"></i>
                  Additional Details
                </label>
                <textarea
                  placeholder="Provide additional details about why this alert needs to be reopened..."
                  rows="4"
                  className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-700 dark:text-gray-100"
                />
              </div>

             <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4">
               <div className="flex items-start">
                 <i className="fas fa-exclamation-triangle text-yellow-500 mr-2 mt-0.5"></i>
                 <div className="text-sm text-yellow-800 dark:text-yellow-200">
                   <strong>Important:</strong> Reopening an alert will:
                   <ul className="list-disc list-inside mt-1 ml-4">
                     <li>Remove the resolved status and return it to active alerts</li>
                     <li>Create an audit trail entry for accountability</li>
                     <li>Require the alert to be resolved again</li>
                     <li>Notify relevant team members</li>
                   </ul>
                 </div>
               </div>
             </div>
           </div>
           
           <div className="flex justify-end space-x-3 mt-6">
             <button
               className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600"
               onClick={onCancel}
             >
               Cancel
             </button>
                           <button
                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:bg-gray-400"
                onClick={onConfirm}
                disabled={!reason.trim() || !reopenedBy.trim()}
              >
               <i className="fas fa-undo mr-1"></i>
               Confirm Reopen
             </button>
           </div>
        </div>
      </div>
    );

    const App = () => {
      const [alerts, setAlerts] = useState(() => {
        const saved = localStorage.getItem('closedAlerts');
        let alertsData = saved ? JSON.parse(saved, (key, value) => {
          if (key === 'timestamp' || key === 'snoozeUntil' || key === 'resolutionTimestamp') {
            return value ? new Date(value) : null;
          }
          return value;
        }).filter(a => a.resolved) : initialAlerts;
        
        // Clean up any unrealistic resolution times
        alertsData = window.cleanupUnrealisticResolutionTimes(alertsData);
        
        return alertsData;
      });
      const [search, setSearch] = useState('');
      const [typeFilter, setTypeFilter] = useState('');
      const [sortBy, setSortBy] = useState('timestamp');
      const [sortOrder, setSortOrder] = useState('desc');
      const [currentPage, setCurrentPage] = useState(1);
      const [darkMode, setDarkMode] = useState(false);
      const [selectedAlert, setSelectedAlert] = useState(null);
       const [showReopenModal, setShowReopenModal] = useState(false);
       const [alertToReopen, setAlertToReopen] = useState(null);
       const [reopenReason, setReopenReason] = useState('');
       const [reopenedBy, setReopenedBy] = useState('');
       
       
      const [isLoading, setIsLoading] = useState(true);
      const alertsPerPage = 10;

      useEffect(() => {
        localStorage.setItem('closedAlerts', JSON.stringify(alerts));
        setIsLoading(false);
      }, [alerts]);

      useEffect(() => {
        document.body.classList.toggle('dark', darkMode);
      }, [darkMode]);

                           const handleReopenClick = (alert) => {
          setAlertToReopen(alert);
          setShowReopenModal(true);
        };

       const handleReopenConfirm = () => {
         if (!reopenReason.trim() || !reopenedBy.trim()) {
           alert('Please provide both reason and your name before reopening the alert.');
           return;
         }

         const updatedAlerts = alerts.map(a => {
           if (a.id === alertToReopen.id) {
             return {
               ...a,
               resolved: false,
               resolutionStatus: null,
               resolutionTimestamp: null,
               reopenedAt: new Date(),
               reopenedBy: reopenedBy,
               reopenReason: reopenReason,
               reopenHistory: [
                 ...(a.reopenHistory || []),
                 {
                   timestamp: new Date(),
                   reopenedBy: reopenedBy,
                   reason: reopenReason
                 }
               ]
             };
           }
           return a;
         });

         setAlerts(updatedAlerts);
         setShowReopenModal(false);
         setAlertToReopen(null);
         setReopenReason('');
         setReopenedBy('');
       };

       const handleReopenCancel = () => {
         setShowReopenModal(false);
         setAlertToReopen(null);
         setReopenReason('');
         setReopenedBy('');
      };

      const handleExport = () => {
        const csv = [
          ['ID', 'Vehicle ID', 'Driver Name', 'Type', 'Message', 'Timestamp', 'Duration (seconds)', 'Duration (formatted)', 'Resolution Status', 'Resolution Timestamp', 'Resolution Notes', 'Resolved By', 'Resolver ID', 'Resolver Role', 'Resolution Method', 'Quality Score', 'Evidence Count', 'Details'].join(','),
          ...alerts.map(a =>
            [
              a.id,
              a.vehicleId,
              a.driverName || 'N/A',
              a.type,
              `"${a.message.replace(/"/g, '""')}"`,
              a.timestamp.toISOString(),
              a.duration || 0,
              `${Math.floor((a.duration || 0) / 60)}m ${(a.duration || 0) % 60}s`,
              a.resolutionStatus,
              a.resolutionTimestamp.toISOString(),
              `"${(a.resolutionNotes || '').replace(/"/g, '""')}"`,
              a.resolvedBy || 'N/A',
              a.resolverId || 'N/A',
              a.resolverRole || 'N/A',
              a.resolutionMethod || 'N/A',
              a.auditTrail?.qualityScore || 'N/A',
              a.evidence ? a.evidence.length : 0,
              `"${a.details.replace(/"/g, '""')}"`
            ].join(',')
          )
        ].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'closed_alerts.csv';
        a.click();
        URL.revokeObjectURL(url);
      };

      const filteredAlerts = alerts
        .filter(a =>
          (search === '' ||
            a.message.toLowerCase().includes(search.toLowerCase()) ||
            a.vehicleId.toLowerCase().includes(search.toLowerCase())) &&
          (typeFilter === '' || a.type === typeFilter)
        )
        .sort((a, b) => {
          const multiplier = sortOrder === 'asc' ? 1 : -1;
          if (sortBy === 'timestamp') {
            return multiplier * (a.timestamp - b.timestamp);
          } else if (sortBy === 'type') {
            return multiplier * a.type.localeCompare(b.type);
          } else if (sortBy === 'vehicleId') {
            return multiplier * a.vehicleId.localeCompare(b.vehicleId);
          } else if (sortBy === 'resolutionStatus') {
            return multiplier * a.resolutionStatus.localeCompare(b.resolutionStatus);
          } else if (sortBy === 'resolutionTimestamp') {
            return multiplier * (a.resolutionTimestamp - b.resolutionTimestamp);
          }
          return 0;
        });

      const totalPages = Math.ceil(filteredAlerts.length / alertsPerPage);
      const paginatedAlerts = filteredAlerts.slice(
        (currentPage - 1) * alertsPerPage,
        currentPage * alertsPerPage
      );

      return (
        <div className={darkMode ? 'dark' : ''}>
          <header className="bg-white dark:bg-gray-800 shadow flex flex-col md:flex-row justify-between items-center px-6 py-4 z-30 fixed top-0 left-0 w-full">
            <div className="flex items-center space-x-4 mb-4 md:mb-0">
              <a href="index.html" className="text-blue-600 hover:text-blue-800 font-bold text-xl">
                <i className="fas fa-arrow-left mr-2"></i>Back to Dashboard
              </a>
              <h1 className="text-2xl font-bold text-gray-900 dark:text-gray-100">Closed Alerts</h1>
            </div>
            <div className="flex items-center space-x-4">
              <input
                type="text"
                placeholder="Search alerts, vehicle, type..."
                className="border border-gray-300 dark:border-gray-600 px-4 py-2 rounded-lg w-64 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all dark:bg-gray-700 dark:text-gray-100"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                aria-label="Search Alerts"
              />
              <select
                className="border border-gray-300 dark:border-gray-600 px-2 py-1 rounded-lg text-sm dark:bg-gray-700 dark:text-gray-100"
                value={typeFilter}
                onChange={(e) => setTypeFilter(e.target.value)}
              >
                <option value="">All Types</option>
                <option value="camera-issues">Camera Issues</option>
                <option value="black-trips">Black Trips</option>
                <option value="over-speeding">Over Speeding</option>
                <option value="towing">Towing</option>
              </select>
              <select
                className="border border-gray-300 dark:border-gray-600 px-2 py-1 rounded-lg text-sm dark:bg-gray-700 dark:text-gray-100"
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value)}
              >
                <option value="timestamp">Sort by Timestamp</option>
                <option value="type">Sort by Type</option>
                <option value="vehicleId">Sort by Vehicle ID</option>
                <option value="resolutionStatus">Sort by Resolution Status</option>
                <option value="resolutionTimestamp">Sort by Resolution Timestamp</option>
              </select>
              <button
                className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700"
                onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
              >
                <i className={`fas fa-sort-${sortOrder === 'asc' ? 'up' : 'down'} mr-1`}></i>
                {sortOrder === 'asc' ? 'Ascending' : 'Descending'}
              </button>
              <button
                className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700"
                onClick={handleExport}
              >
                <i className="fas fa-download mr-1"></i>Export CSV
              </button>
              <button
                className="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700"
                onClick={() => setDarkMode(!darkMode)}
              >
                <i className={`fas fa-${darkMode ? 'sun' : 'moon'} mr-1`}></i>
                {darkMode ? 'Light' : 'Dark'} Mode
              </button>
              

            </div>
          </header>
          <main className="pt-24 px-6">
            {isLoading ? (
              <div className="text-center text-gray-500 dark:text-gray-400 mt-12">
                Loading alerts...
              </div>
            ) : (
              <>
                {/* Resolution Analytics Dashboard */}
                <ResolutionAnalytics alerts={filteredAlerts} />
                
                {paginatedAlerts.length === 0 ? (
              <div className="text-center text-gray-500 dark:text-gray-400 mt-12">
                No closed alerts found.
              </div>
            ) : (
              <div className="alert-list space-y-4">
                {paginatedAlerts.map(alert => (
                  <AlertCard
                    key={alert.id}
                    alert={alert}
                    onDetails={setSelectedAlert}
                         onReopen={handleReopenClick}
                  />
                ))}
              </div>
                )}
              </>
            )}
            {totalPages > 1 && (
              <div className="flex justify-center mt-6 space-x-2">
                <button
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg disabled:bg-gray-400"
                  onClick={() => setCurrentPage(p => Math.max(p - 1, 1))}
                  disabled={currentPage === 1}
                >
                  Previous
                </button>
                <span className="px-4 py-2 text-gray-900 dark:text-gray-100">
                  Page {currentPage} of {totalPages}
                </span>
                <button
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg disabled:bg-gray-400"
                  onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))}
                  disabled={currentPage === totalPages}
                >
                  Next
                </button>
              </div>
            )}
            {selectedAlert && (
              <AlertModal alert={selectedAlert} onClose={() => setSelectedAlert(null)} />
             )}
                           {showReopenModal && alertToReopen && (
                <ReopenModal
                   alert={alertToReopen}
                   onConfirm={handleReopenConfirm}
                   onCancel={handleReopenCancel}
                   reason={reopenReason}
                   setReason={setReopenReason}
                   reopenedBy={reopenedBy}
                   setReopenedBy={setReopenedBy}
                 />
            )}
          </main>
        </div>
      );
    };

    // Use React 18 createRoot API instead of deprecated ReactDOM.render
    try {
      if (ReactDOM.createRoot) {
        // React 18+ with createRoot
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
      } else {
        // Fallback to React 17 render method
        console.warn('ReactDOM.createRoot not available, falling back to ReactDOM.render');
        ReactDOM.render(<App />, document.getElementById('root'));
      }
    } catch (error) {
      console.error('Error rendering React app:', error);
      // Final fallback
      ReactDOM.render(<App />, document.getElementById('root'));
    }
  </script>

  <!-- Feedback Button - Outside React Component -->
  <!-- Production-ready with Google Sheets integration and fixed resolution time calculations -->
  <div class="fixed bottom-6 right-6 z-40">
    <div class="text-center">
      <button 
        id="feedback-toggle" 
        class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-all hover:scale-105 shadow-lg flex items-center gap-2 font-medium" 
        title="Submit Feedback"
      >
        <i class="fas fa-comment-dots text-lg"></i>
        Submit Feedback
      </button>
      <p class="text-xs text-gray-500 mt-1">Feedback automatically sent to Google Sheets</p>
    </div>
  </div>

  <!-- Feedback Submission Modal -->
  <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-comment-dots text-orange-600"></i>
          Submit Feedback & Suggestions
        </h3>
        <button id="close-feedback-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="mb-6">
        <p class="text-gray-600 text-sm leading-relaxed">
          Help us improve the closed alerts management system! Share your thoughts on the design, features, usability, or suggest new functionality. Your feedback is valuable and will be reviewed by our development team.
        </p>
      </div>

      <form id="feedback-form" class="space-y-6">
        <!-- Name Field -->
        <div>
          <label for="feedback-name" class="block text-sm font-medium text-gray-700 mb-2">
            Your Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="feedback-name" 
            name="name"
            required
            placeholder="Enter your full name"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors"
          >
        </div>

        <!-- Feedback/Note Field -->
        <div>
          <label for="feedback-note" class="block text-sm font-medium text-gray-700 mb-2">
            Feedback & Comments <span class="text-red-500">*</span>
          </label>
          <textarea 
            id="feedback-note" 
            name="note"
            required
            rows="8"
            placeholder="Please describe your feedback, suggestions, or issues in detail. Be specific about what you liked, what could be improved, or what new features you'd like to see..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors resize-vertical"
          ></textarea>
          <div class="mt-1 text-xs text-gray-500">
            <span id="char-count">0</span>/1000 characters
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row gap-3 pt-4">
          <button 
            type="submit" 
            id="submit-feedback-btn"
            class="flex-1 px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 focus:ring-4 focus:ring-orange-500/20 transition-all font-medium flex items-center justify-center gap-2"
          >
            <i class="fas fa-paper-plane"></i>
            Submit Feedback
          </button>
          <button 
            type="button" 
            id="cancel-feedback-btn"
            class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:ring-4 focus:ring-gray-500/20 transition-all font-medium"
          >
            Cancel
          </button>
        </div>
      </form>

      <!-- Success Message -->
      <div id="feedback-success" class="hidden text-center py-8">
        <div class="mb-4">
          <i class="fas fa-check-circle text-5xl text-green-500"></i>
        </div>
        <h4 class="text-xl font-bold text-gray-900 mb-2">Feedback Submitted Successfully!</h4>
        <p class="text-gray-600 mb-4">Thank you for your valuable feedback. Our team will review it and get back to you if needed.</p>
        <button id="submit-another-feedback" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
          Submit Another Feedback
        </button>
      </div>
    </div>
  </div>

  <!-- View Feedback Modal -->
  <div id="view-feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-comments text-orange-600"></i>
          Submitted Feedback & Comments
        </h3>
        <button id="close-view-feedback-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- Feedback Controls -->
      <div class="mb-6 flex flex-wrap gap-3">
        <button id="refresh-feedback" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
          <i class="fas fa-sync mr-1"></i> Refresh
        </button>
        <button id="export-feedback" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
          <i class="fas fa-download mr-1"></i> Export JSON
        </button>
        <button id="clear-feedback" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
          <i class="fas fa-trash mr-1"></i> Clear All
        </button>
      </div>

      <!-- Feedback List -->
      <div id="feedback-list" class="space-y-4 max-h-96 overflow-y-auto">
        <!-- Feedback items will be populated here -->
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-comments text-4xl mb-3"></i>
          <p>No feedback submitted yet. Encourage your team to share their thoughts!</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== FEEDBACK SYSTEM & RESOLUTION TIME FIXES =====
    // Fixed unrealistic resolution times (like 677 minutes) by:
    // 1. Limiting generated resolution times to 5 minutes - 4 hours
    // 2. Adding validation to cap unrealistic values at reasonable limits
    // 3. Cleaning up existing data with unrealistic resolution times
    // 4. Made functions globally available to fix GitHub viewing issues

    // Helper functions for resolution time calculations (defined outside React component)
    // These functions are used by both the React component and the FeedbackManager
    window.calculateResolutionTime = (alert) => {
      // Safety check for missing data
      if (!alert || !alert.resolutionTimestamp || !alert.timestamp) {
        console.warn('Missing timestamp data for alert:', alert);
        return 5; // Default to 5 minutes
      }
      const timeMs = alert.resolutionTimestamp - alert.timestamp;
      const timeMinutes = timeMs / 60000; // Convert to minutes
      
      // Validate: if resolution time is unrealistic (> 24 hours), cap it at 4 hours
      if (timeMinutes > 1440) { // 24 hours = 1440 minutes
        console.warn(`Alert ${alert.id} has unrealistic resolution time: ${timeMinutes} minutes, capping at 240 minutes`);
        return 240; // Cap at 4 hours
      }
      
      // Validate: if resolution time is negative or too small (< 1 minute), set to 5 minutes
      if (timeMinutes < 1) {
        console.warn(`Alert ${alert.id} has unrealistic resolution time: ${timeMinutes} minutes, setting to 5 minutes`);
        return 5; // Minimum 5 minutes
      }
      
      return Math.round(timeMinutes);
    };

    // Fallback function in case the main function isn't available yet
    window.calculateResolutionTimeFallback = (alert) => {
      try {
        if (!alert || !alert.resolutionTimestamp || !alert.timestamp) {
          return 5; // Default to 5 minutes
        }
        const timeMs = alert.resolutionTimestamp - alert.timestamp;
        const timeMinutes = timeMs / 60000;
        
        // Basic validation without complex logic
        if (timeMinutes > 1440 || timeMinutes < 1) {
          return 30; // Return reasonable default
        }
        
        return Math.round(timeMinutes);
      } catch (error) {
        console.error('Error in fallback resolution time calculation:', error);
        return 30; // Safe default
      }
    };

    // Function to clean up any existing unrealistic resolution times in the data
    window.cleanupUnrealisticResolutionTimes = (alerts) => {
      return alerts.map(alert => {
        const timeMs = alert.resolutionTimestamp - alert.timestamp;
        const timeMinutes = timeMs / 60000;
        
        // If resolution time is unrealistic, adjust the resolution timestamp
        if (timeMinutes > 1440 || timeMinutes < 1) {
          const newResolutionTimeMs = 300000 + Math.random() * 14100000; // 5 min to 4 hours
          alert.resolutionTimestamp = new Date(alert.timestamp.getTime() + newResolutionTimeMs);
          console.log(`Fixed unrealistic resolution time for alert ${alert.id}: ${timeMinutes}  ${newResolutionTimeMs / 60000} minutes`);
        }
        
        return alert;
      });
    };

    class FeedbackManager {
      constructor() {
        // Wait for feedback storage to be available
        if (window.feedbackStorage) {
          this.storage = window.feedbackStorage;
        } else {
          // Fallback: create a basic storage if feedback-storage.js is not loaded
          console.warn('Feedback storage not found, creating fallback storage');
          this.storage = {
            saveFeedback: async (data) => {
              // Basic local storage fallback
              const stored = JSON.parse(localStorage.getItem('lynx-dashboard-feedback') || '[]');
              stored.push(data);
              localStorage.setItem('lynx-dashboard-feedback', JSON.stringify(stored));
              return true;
            },
            getAllFeedback: () => {
              return JSON.parse(localStorage.getItem('lynx-dashboard-feedback') || '[]');
            },
            clearAllFeedback: () => {
              localStorage.removeItem('lynx-dashboard-feedback');
            }
          };
        }
        this.setupEventListeners();
      }

      setupEventListeners() {
        // Feedback toggle button
        const feedbackToggle = document.getElementById('feedback-toggle');
        if (feedbackToggle) {
          feedbackToggle.addEventListener('click', () => {
            console.log('Feedback button clicked!');
            this.openFeedbackModal();
          });
        } else {
          console.error('Feedback toggle button not found!');
        }

        // Modal controls
        const closeFeedbackModal = document.getElementById('close-feedback-modal');
        if (closeFeedbackModal) {
          closeFeedbackModal.addEventListener('click', () => this.closeFeedbackModal());
        }

        const cancelFeedbackBtn = document.getElementById('cancel-feedback-btn');
        if (cancelFeedbackBtn) {
          cancelFeedbackBtn.addEventListener('click', () => this.closeFeedbackModal());
        }

        // Form submission
        const feedbackForm = document.getElementById('feedback-form');
        if (feedbackForm) {
          feedbackForm.addEventListener('submit', (e) => {
            console.log('Feedback form submitted!');
            this.handleSubmitFeedback(e);
          });
        } else {
          console.error('Feedback form not found!');
        }

        // Character counter
        const feedbackNote = document.getElementById('feedback-note');
        if (feedbackNote) {
          feedbackNote.addEventListener('input', () => this.updateCharacterCount());
        }

        // Submit another feedback
        const submitAnotherBtn = document.getElementById('submit-another-feedback');
        if (submitAnotherBtn) {
          submitAnotherBtn.addEventListener('click', () => this.resetFeedbackForm());
        }

        // Feedback controls
        const refreshBtn = document.getElementById('refresh-feedback');
        const exportBtn = document.getElementById('export-feedback');
        const clearBtn = document.getElementById('clear-feedback');

        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => this.loadFeedback());
        }
        if (exportBtn) {
          exportBtn.addEventListener('click', () => this.exportFeedback());
        }
        if (clearBtn) {
          clearBtn.addEventListener('click', () => this.clearAllFeedback());
        }
      }

      openFeedbackModal() {
        console.log('Opening feedback modal...');
        const modal = document.getElementById('feedback-modal');
        if (modal) {
          console.log('Modal found, showing it...');
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          
          // Focus on first input
          const nameInput = document.getElementById('feedback-name');
          if (nameInput) {
            setTimeout(() => nameInput.focus(), 100);
          }
        } else {
          console.error('Feedback modal not found!');
        }
      }

      closeFeedbackModal() {
        const modal = document.getElementById('feedback-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      openViewFeedbackModal() {
        const modal = document.getElementById('view-feedback-modal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          this.loadFeedback();
        }
      }

      closeViewFeedbackModal() {
        const modal = document.getElementById('view-feedback-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      updateCharacterCount() {
        const textarea = document.getElementById('feedback-note');
        const counter = document.getElementById('char-count');
        if (textarea && counter) {
          const count = textarea.value.length;
          counter.textContent = count;
          
          if (count > 1000) {
            counter.style.color = '#ef4444';
            textarea.value = textarea.value.substring(0, 1000);
            counter.textContent = '1000';
          } else {
            counter.style.color = '#6b7280';
          }
        }
      }

      async handleSubmitFeedback(e) {
        console.log('handleSubmitFeedback called!');
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-feedback-btn');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
        submitBtn.disabled = true;

        try {
          const formData = new FormData(e.target);
          const feedbackData = {
            id: Date.now().toString(),
            name: formData.get('name'),
            note: formData.get('note'),
            timestamp: new Date().toISOString(),
            system: 'Closed Alerts Management System'
          };

          // Validate required fields
          if (!feedbackData.name || !feedbackData.note) {
            throw new Error('Please fill in all required fields');
          }

          // Save using the feedback storage system (this will save locally AND submit to Google Sheets)
          console.log('About to save feedback:', feedbackData);
          console.log('Storage object:', this.storage);
          const success = await this.storage.saveFeedback(feedbackData);
          console.log('Save result:', success);
          if (!success) {
            throw new Error('Failed to save feedback');
          }
          
          // Show success message
          this.showSuccessMessage();
          
          // Reset form
          e.target.reset();
          
        } catch (error) {
          console.error('Error submitting feedback:', error);
          alert('Error submitting feedback: ' + error.message);
          
          // Restore button state
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      showSuccessMessage() {
        const form = document.getElementById('feedback-form');
        const success = document.getElementById('feedback-success');
        
        if (form && success) {
          form.classList.add('hidden');
          success.classList.remove('hidden');
        }
      }

      resetFeedbackForm() {
        const form = document.getElementById('feedback-form');
        const success = document.getElementById('feedback-success');
        const submitBtn = document.getElementById('submit-feedback-btn');
        
        if (form) {
          form.reset();
          form.classList.remove('hidden');
        }
        
        if (success) {
          success.classList.add('hidden');
        }
        
        if (submitBtn) {
          submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Feedback';
          submitBtn.disabled = false;
        }

        // Reset character counter
        const counter = document.getElementById('char-count');
        if (counter) {
          counter.textContent = '0';
        }
      }

      loadFeedback() {
        const feedbackList = document.getElementById('feedback-list');
        if (!feedbackList) return;

        // Get all feedback from storage
        const allFeedback = this.storage.getAllFeedback();

        // Sort by timestamp (newest first)
        allFeedback.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (allFeedback.length === 0) {
          feedbackList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-comments text-4xl mb-3"></i>
              <p>No feedback submitted yet. Encourage your team to share their thoughts!</p>
            </div>
          `;
          return;
        }

        // Render feedback items
        feedbackList.innerHTML = allFeedback.map(item => this.renderFeedbackItem(item)).join('');
      }

      renderFeedbackItem(feedback) {
        const date = new Date(feedback.timestamp).toLocaleDateString();
        const time = new Date(feedback.timestamp).toLocaleTimeString();

        return `
          <div class="border border-gray-200 rounded-lg p-4 bg-white hover:shadow-md transition-shadow">
            <div class="flex items-start gap-3 mb-3">
              <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                <span class="text-orange-600 font-semibold">${feedback.name.charAt(0).toUpperCase()}</span>
              </div>
              <div class="flex-1">
                <h4 class="font-semibold text-gray-900">${feedback.name}</h4>
                <p class="text-xs text-gray-500">${date} at ${time}</p>
              </div>
            </div>
            
            <div class="mb-3">
              <p class="text-gray-700 leading-relaxed">${feedback.note}</p>
            </div>
          </div>
        `;
      }

      exportFeedback() {
        try {
          this.storage.exportFeedback();
          this.showNotification('Feedback exported successfully!', 'success');
        } catch (error) {
          console.error('Error exporting feedback:', error);
          this.showNotification('Error exporting feedback', 'error');
        }
      }

      clearAllFeedback() {
        if (confirm('Are you sure you want to clear all feedback? This action cannot be undone.')) {
          this.storage.clearAllFeedback();
          this.loadFeedback();
          this.showNotification('All feedback cleared successfully!', 'success');
        }
      }

      showNotification(message, type = 'info') {
        // Create a simple notification
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
          type === 'success' ? 'bg-green-500 text-white' :
          type === 'error' ? 'bg-red-500 text-white' :
          'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }
    }

    // Initialize feedback system
    let feedbackManager;
    document.addEventListener('DOMContentLoaded', function() {
      feedbackManager = new FeedbackManager();
    });
  </script>
</body>
</html>
