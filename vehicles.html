<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Vehicles - Lynx Lite</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  
  <!-- OpenLayers (Advanced Free Mapping Library) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" />
  <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
  
  <!-- Feedback Storage System -->
  <script src="feedback-storage.js"></script>
  
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }
    
    .dark body {
      background: linear-gradient(to bottom, #1f2937, #111827);
      color: #f3f4f6;
    }
    .dark .bg-white {
      background: #1f2937;
    }
    .dark .text-gray-900 {
      color: #f3f4f6;
    }
    .dark .text-gray-600 {
      color: #d1d5db;
    }
    .vehicle-card {
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .vehicle-card:hover {
      box-shadow: 0 8px 24px rgba(37,99,235,0.2);
      transform: translateY(-2px) scale(1.01);
    }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px;
    }
    .status-online { background: #16A34A; }
    .status-offline { background: #DC2626; }
    .status-idling { background: #EAB308; }
    .status-driving { background: #2563eb; }
    .status-maintenance { background: #f59e42; }
    .status-alert { background: #f43f5e; }
    .vehicle-action-btn {
      transition: all 0.2s ease;
      border: none;
      outline: none;
      cursor: pointer;
    }
    .vehicle-action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .vehicle-action-btn:active {
      transform: translateY(0);
    }
    .analytics-widget {
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      cursor: move;
    }
    .dark .analytics-widget {
      background: linear-gradient(145deg, #374151, #1f2937);
    }

    .sidebar-hidden {
      transform: translateX(-100%);
    }
    
    .notification-tray {
      position: fixed;
      right: 0;
      top: 80px;
      width: 320px;
      max-height: 80vh;
      overflow-y: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      padding: 1rem;
      z-index: 40;
      transition: transform 0.3s ease;
      transform: translateX(100%);
    }
    .notification-tray.active {
      transform: translateX(0);
    }
    .dark .notification-tray {
      background: #1f2937;
      color: #f3f4f6;
    }
    
    /* Override z-index for proper layering */
    .z-50 {
      z-index: var(--z-modal, 50) !important;
    }
    
    .z-30 {
      z-index: var(--z-map-controls, 28) !important;
    }
    
    /* Header should be above map controls */
    .header-element {
      z-index: var(--z-header, 35) !important;
      max-height: 120px; /* Limit header height */
      overflow: visible;
    }
    
    /* Optimize header buttons for smaller screens */
    @media (max-width: 1200px) {
      .header-element .flex.items-center.space-x-2.flex-wrap {
        gap: 0.25rem;
      }
      .header-element button {
        padding: 0.375rem 0.5rem !important;
        font-size: 0.875rem;
      }
    }
    
    .z-20 {
      z-index: var(--z-sidebar, 20) !important;
    }
    
    /* Map-specific z-index fixes */
    .ol-overlay-container,
    .ol-popup,
    .vehicles-popup {
      z-index: var(--z-map-elements, 25) !important;
    }
    
    /* Ensure modals are always on top */
    .fixed.inset-0.bg-black,
    .fixed.inset-0.bg-opacity-50,
    .fixed.inset-0.bg-opacity-40 {
      z-index: var(--z-modal, 50) !important;
    }
    .alert-item {
      transition: opacity 0.3s;
    }
    .alert-item.snoozed {
      opacity: 0.5;
    }
    
    /* Map control button styles */
    .map-control-btn {
      background: white;
      color: #374151;
      border: 1px solid #e5e7eb;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      min-height: 40px;
    }
    
    .map-control-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }
    
    .map-control-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #2563eb;
    }
    
    .dark .map-control-btn {
      background: #374151;
      color: #d1d5db;
      border-color: #4b5563;
    }
    
    .dark .map-control-btn:hover {
      background: #4b5563;
      border-color: #6b7280;
    }
    
    .dark .map-control-btn.active {
      background: #2563eb;
      border-color: #1d4ed8;
    }
    
    /* Map statistics styles */
    .map-statistics {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .dark .map-statistics {
      background: rgba(31, 41, 55, 0.95);
      border-color: #4b5563;
    }
    
    /* Notification animations */
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <header class="bg-white dark:bg-gray-800 shadow flex flex-wrap justify-between items-center px-6 py-4 z-30 fixed top-0 left-64 right-0 header-element">
    <div class="flex items-center space-x-4">
      <button id="sidebar-toggle" class="text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle Sidebar" tabindex="0">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Fleet Vehicles</h1>
      <span class="ml-4 px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-sm font-semibold" title="Current User Role">Admin</span>
    </div>
    <div class="flex items-center space-x-2 md:space-x-4 flex-wrap">
      <input type="text" id="vehicle-search" placeholder="Search Vehicle, Driver, VIN..." class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-4 py-2 rounded-lg w-48 md:w-64 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" aria-label="Search Vehicles">
      <button id="filter-btn" class="p-2 text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Filter Vehicles" tabindex="0" title="Filter Vehicles">
        <i class="fas fa-filter"></i>
      </button>
      <button id="notification-toggle" class="text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-yellow-500 transition-colors duration-300 relative" aria-label="Notifications">
        <i class="fas fa-bell text-xl"></i>
        <span id="notification-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden">0</span>
      </button>
      <div class="flex items-center gap-3">
        <label class="flex items-center cursor-pointer" title="Select/Deselect all visible vehicles">
          <input type="checkbox" id="select-all-checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="ml-2 text-sm text-gray-700 dark:text-gray-200 hidden md:inline">Select All</span>
        </label>
        <span id="selection-counter" class="text-sm text-gray-600 dark:text-gray-400 hidden"></span>
      </div>
      <div class="relative group">
        <button id="bulk-action-btn" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 flex items-center text-sm" aria-label="Bulk Actions" tabindex="0" title="Bulk Actions">
          <i class="fas fa-tasks mr-1"></i> <span class="hidden md:inline">Bulk Actions</span>
          <i class="fas fa-caret-down ml-2"></i>
        </button>
        <div id="bulk-actions-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg z-30 border border-gray-200 dark:border-gray-700">
          <button class="block w-full text-left px-4 py-2 hover:bg-blue-50 dark:hover:bg-gray-700" id="bulk-assign-driver">Assign Driver</button>
          <button class="block w-full text-left px-4 py-2 hover:bg-blue-50 dark:hover:bg-gray-700" id="bulk-schedule-maintenance">Schedule Maintenance</button>
          <button class="block w-full text-left px-4 py-2 hover:bg-blue-50 dark:hover:bg-gray-700" id="bulk-send-message">Send Message</button>
        </div>
      </div>
      <button id="bulk-maintenance-btn" class="bg-yellow-500 text-white px-3 py-2 rounded-lg hover:bg-yellow-600 focus:ring-2 focus:ring-yellow-500 flex items-center text-sm" aria-label="Bulk Maintenance" tabindex="0" title="Bulk Maintenance Scheduling">
        <i class="fas fa-tools mr-1"></i> <span class="hidden lg:inline">Bulk Maintenance</span>
      </button>
      <button id="add-vehicle-btn" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 flex items-center text-sm" aria-label="Add Vehicle" tabindex="0" title="Add Vehicle">
        <i class="fas fa-plus mr-1"></i> <span class="hidden md:inline">Add Vehicle</span>
      </button>
      <button id="create-group-btn" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500 flex items-center text-sm" aria-label="Create Group" tabindex="0" title="Create Vehicle Group">
        <i class="fas fa-layer-group mr-1"></i> <span class="hidden lg:inline">Create Group</span>
      </button>
      <button id="toggle-table-view" class="p-2 text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle Table View" tabindex="0" title="Switch to Table/List View">
        <i class="fas fa-table"></i>
      </button>
      <button id="theme-toggle" class="p-2 text-gray-700 dark:text-gray-200 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle Theme" tabindex="0" title="Toggle Light/Dark Mode">
        <i class="fas fa-moon"></i>
      </button>
      
      <!-- Feedback Button -->
      <div class="text-center">
        <button id="feedback-toggle" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-all hover:scale-105 shadow-lg flex items-center gap-2 font-medium" title="Submit Feedback">
          <i class="fas fa-comment-dots text-lg"></i>
          Submit Feedback
        </button>
        <p class="text-xs text-gray-500 mt-1">Feedback automatically sent to Google Sheets</p>
      </div>
    </div>
  </header>

  <!-- Notification Tray -->
  <div id="notification-tray" class="notification-tray">
    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Notifications</h3>
    <div id="notifications-list" class="space-y-2"></div>
    <button id="clear-notifications" class="mt-4 px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 w-full">Clear All</button>
  </div>

  <aside id="sidebar" class="w-64 bg-blue-900 text-white flex flex-col py-6 px-4 fixed top-0 bottom-0 left-0 z-20 transition-transform duration-300" aria-label="Main Navigation">
    <nav class="space-y-4">
      <a href="index.html" class="nav-link group flex items-center px-3 py-2 text-sm font-semibold text-white bg-blue-700 rounded-lg" role="menuitem" tabindex="0">
        <i class="fas fa-tachometer-alt fa-fw mr-3"></i><span class="nav-text">Dashboard</span>
      </a>
      <a href="vehicles.html" class="nav-link group flex items-center px-3 py-2 text-sm font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-700" role="menuitem" tabindex="0">
        <i class="fas fa-truck fa-fw mr-3"></i><span class="nav-text">Vehicles</span>
      </a>
      <a href="#" class="nav-link group flex items-center px-3 py-2 text-sm font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-700" role="menuitem" tabindex="0">
        <i class="fas fa-cogs fa-fw mr-3"></i><span class="nav-text">Settings</span>
      </a>
      <a href="#" class="nav-link group flex items-center px-3 py-2 text-sm font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-700" role="menuitem" tabindex="0">
        <i class="fas fa-question-circle fa-fw mr-3"></i><span class="nav-text">Help & Support</span>
      </a>
    </nav>
  </aside>
  <main id="main-content-container" class="flex-1 ml-0 md:ml-64 pt-32 md:pt-36 lg:pt-32 px-4 md:px-8" aria-label="Main Content">
    <!-- Filter Modal -->
    <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="filter-modal-title">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
        <h3 id="filter-modal-title" class="text-lg font-bold text-gray-900 dark:text-white mb-4">Filter Vehicles</h3>
        <div class="space-y-4">
          <div>
            <label for="filter-status" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Status</label>
            <select id="filter-status" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2">
              <option value="">All</option>
              <option value="Driving">Driving</option>
              <option value="Idling">Idling</option>
              <option value="Parked">Parked</option>
              <option value="Offline">Offline</option>
              <option value="Maintenance">Maintenance</option>
              <option value="Alert">Alert</option>
            </select>
          </div>
          <div>
            <label for="filter-group" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Group</label>
            <select id="filter-group" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2">
              <option value="">All</option>
              <option value="Delivery">Delivery</option>
              <option value="Service">Service</option>
              <option value="Executive">Executive</option>
            </select>
          </div>
          <div>
            <label for="filter-driver" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Driver</label>
            <input type="text" id="filter-driver" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2" placeholder="Enter driver name">
          </div>
          <div class="flex justify-between gap-2">
            <button id="save-filter-preset" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700" title="Save current filter as preset">Save Preset</button>
            <div class="flex gap-2">
              <button id="clear-filter" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">Clear</button>
              <button id="apply-filter" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Apply</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Geofence Settings Modal -->
    <div id="geofence-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="geofence-modal-title">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
          <h3 id="geofence-modal-title" class="text-lg font-bold text-gray-900 dark:text-white">Geofence Settings</h3>
          <button id="close-geofence-modal" class="text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-xl" aria-label="Close Modal">×</button>
        </div>
        <div class="space-y-4">
          <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg">
            <div class="flex items-center gap-2 text-blue-800 dark:text-blue-200 text-sm">
              <i class="fas fa-lightbulb"></i>
              <span>Tip: Click on the map to quickly set the geofence center, or enter coordinates manually below.</span>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="geofence-lat" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Center Latitude</label>
              <input type="number" id="geofence-lat" value="51.5074" step="0.0001" min="-90" max="90" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., 51.5074">
            </div>
            <div>
              <label for="geofence-lng" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Center Longitude</label>
              <input type="number" id="geofence-lng" value="-0.1278" step="0.0001" min="-180" max="180" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., -0.1278">
            </div>
          </div>
          
          <div>
            <label for="geofence-radius" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Radius (km)</label>
            <div class="flex items-center gap-3">
              <input type="range" id="geofence-radius-slider" min="0.1" max="50" step="0.1" value="5" class="flex-1">
              <input type="number" id="geofence-radius" value="5" step="0.1" min="0.1" max="50" class="w-20 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <span class="text-sm text-gray-500">km</span>
            </div>
            <div class="text-xs text-gray-500 mt-1">Area: <span id="geofence-area">78.54</span> km²</div>
          </div>
          
          <div>
            <label for="geofence-name" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Geofence Name (Optional)</label>
            <input type="text" id="geofence-name" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., City Center Zone">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Alert Settings</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" id="geofence-entry-alert" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Alert when vehicle enters geofence</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" id="geofence-exit-alert" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Alert when vehicle exits geofence</span>
              </label>
            </div>
          </div>
          
          <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
            <button id="cancel-geofence" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancel</button>
            <button id="preview-geofence" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Preview on Map</button>
            <button id="apply-geofence" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Apply Geofence</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Analytics Widgets -->
    <div id="analytics-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div class="analytics-widget flex items-center justify-between" data-widget="total-vehicles">
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Total Vehicles</div>
          <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="total-vehicles">--</div>
        </div>
        <i class="fas fa-truck text-3xl text-blue-400 dark:text-blue-300"></i>
      </div>
      <div class="analytics-widget flex items-center justify-between" data-widget="active-vehicles">
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Active (Driving)</div>
          <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="active-vehicles">--</div>
        </div>
        <i class="fas fa-route text-3xl text-green-400 dark:text-green-300"></i>
      </div>
      <div class="analytics-widget flex items-center justify-between" data-widget="maintenance-vehicles">
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400">In Maintenance</div>
          <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="maintenance-vehicles">--</div>
        </div>
        <i class="fas fa-tools text-3xl text-yellow-400 dark:text-yellow-300"></i>
      </div>
      <div class="analytics-widget flex items-center justify-between" data-widget="alert-vehicles">
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Alerts</div>
          <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="alert-vehicles">--</div>
        </div>
        <i class="fas fa-exclamation-triangle text-3xl text-red-400 dark:text-red-300"></i>
      </div>
      <div class="analytics-widget flex items-center justify-between" data-widget="avg-driver-score">
        <div>
          <div class="text-sm text-gray-600 dark:text-gray-400">Avg Driver Score</div>
          <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="avg-driver-score">--</div>
        </div>
        <i class="fas fa-star text-3xl text-purple-400 dark:text-purple-300"></i>
      </div>
    </div>
    

    
    <!-- Vehicle Types & Shifts Management -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Vehicle Types Section -->
      <section class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">Vehicle Types</h2>
          <button id="add-vehicle-type" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 flex items-center text-sm">
            <i class="fas fa-plus mr-2"></i>Add Type
          </button>
        </div>
        <div id="vehicle-types-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Vehicle types will be rendered here -->
        </div>
      </section>

      <!-- Shift Schedules Section -->
      <section class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">Shift Schedules</h2>
          <button id="add-shift-schedule" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 flex items-center text-sm">
            <i class="fas fa-plus mr-2"></i>Add Shift
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <th class="text-left py-2 px-3 text-sm font-medium text-gray-900 dark:text-white">Shift</th>
                <th class="text-left py-2 px-3 text-sm font-medium text-gray-900 dark:text-white">Time</th>
                <th class="text-left py-2 px-3 text-sm font-medium text-gray-900 dark:text-white">Days</th>
                <th class="text-left py-2 px-3 text-sm font-medium text-gray-900 dark:text-white">Drivers</th>
                <th class="text-left py-2 px-3 text-sm font-medium text-gray-900 dark:text-white">Actions</th>
              </tr>
            </thead>
            <tbody id="shifts-table-body">
              <!-- Shifts will be rendered here -->
            </tbody>
          </table>
        </div>
      </section>
    </div>
    
    <!-- Fleet Map Widget -->
    <section class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white">Fleet Map</h2>
        <div class="flex gap-2">
          <button id="vehicles-map-controls-btn" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 text-sm flex items-center">
            <i class="fas fa-cog mr-2"></i>Controls
          </button>
        </div>
      </div>
      
      <!-- Map Container -->
      <div class="relative bg-gray-100 dark:bg-gray-700 rounded-lg overflow-hidden" style="height: 500px;">
        <div id="vehicles-fleet-map-container" class="w-full h-full relative">
          <!-- Map will be rendered here -->
          <div class="absolute inset-0 flex items-center justify-center text-gray-500 dark:text-gray-400">
            <div class="text-center">
              <i class="fas fa-map text-4xl mb-4"></i>
              <div>Initializing map...</div>
            </div>
          </div>
        </div>
        
        <!-- Map Controls -->
        <div class="absolute top-4 right-4 flex flex-col gap-2" style="z-index: var(--z-map-controls, 28);">
          <button id="vehicles-center-map" class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 p-2 rounded-lg shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500" title="Center Map">
            <i class="fas fa-crosshairs"></i>
          </button>
          <button id="vehicles-toggle-satellite" class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 p-2 rounded-lg shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500" title="Toggle Satellite View">
            <i class="fas fa-satellite"></i>
          </button>
          <button id="vehicles-toggle-clustering" class="bg-green-600 text-white p-2 rounded-lg shadow-lg hover:bg-green-700 focus:ring-2 focus:ring-blue-500" title="Disable Clustering">
            <i class="fas fa-layer-group"></i>
          </button>
          <button id="vehicles-create-geofence" class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 p-2 rounded-lg shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500" title="Create Geofence">
            <i class="fas fa-draw-polygon"></i>
          </button>
          <button id="vehicles-refresh-map" class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 p-2 rounded-lg shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500" title="Refresh Map">
            <i class="fas fa-sync"></i>
          </button>
          <button id="vehicles-clear-geofences" class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 p-2 rounded-lg shadow-lg hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-blue-500" title="Clear Geofences">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        
        <!-- Vehicle Legend -->
        <div class="absolute bottom-4 left-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-3" style="z-index: var(--z-map-elements, 25);">
          <div class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">Vehicle Status</div>
          <div class="flex flex-col gap-1 text-xs">
            <div class="flex items-center">
              <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
              <span class="text-gray-600 dark:text-gray-400">Active</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
              <span class="text-gray-600 dark:text-gray-400">Idling</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
              <span class="text-gray-600 dark:text-gray-400">Parked</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
              <span class="text-gray-600 dark:text-gray-400">Offline</span>
            </div>
          </div>
        </div>
        
        <!-- Map Statistics -->
        <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div class="text-center">
            <div class="font-semibold text-green-600" id="vehicles-active-count">0</div>
            <div class="text-gray-600 dark:text-gray-400">Active Vehicles</div>
          </div>
          <div class="text-center">
            <div class="font-semibold text-blue-600" id="vehicles-total-count">0</div>
            <div class="text-gray-600 dark:text-gray-400">Total Vehicles</div>
          </div>
          <div class="text-center">
            <div class="font-semibold text-orange-600" id="vehicles-idling-count">0</div>
            <div class="text-gray-600 dark:text-gray-400">Idling</div>
          </div>
          <div class="text-center">
            <div class="font-semibold text-purple-600" id="vehicles-parked-count">0</div>
            <div class="text-gray-600 dark:text-gray-400">Parked</div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Vehicle List & Map -->
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Vehicle List -->
      <section class="flex-1">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-900 dark:text-white">Vehicles</h2>
          <div class="flex gap-2 items-center">
            <div class="relative">
              <select id="sort-vehicles" class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white px-3 py-2 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Sort by...</option>
                <option value="status">Status</option>
                <option value="driver-score-desc">Driver Score (High to Low)</option>
                <option value="last-update">Last Update (Recent first)</option>
                <option value="fuel-asc">Fuel Level (Low first)</option>
              </select>
            </div>
            <button class="text-blue-600 dark:text-blue-400 hover:text-blue-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500" id="export-csv-btn">
              <i class="fas fa-download mr-1"></i>Export CSV
            </button>
            <button class="text-blue-600 dark:text-blue-400 hover:text-blue-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500" id="customize-dashboard-btn">
              <i class="fas fa-sliders-h mr-1"></i>Customize
            </button>
          </div>
        </div>
        <div id="vehicle-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          <!-- Loading indicator -->
          <div id="loading-indicator" class="col-span-full flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600 dark:text-gray-400">Loading vehicles...</span>
          </div>
          
          <!-- DEBUG: Static test vehicle to verify page structure -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-gray-900 dark:text-white">TEST-001</h3>
              <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Driving</span>
            </div>
            <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
              <div class="flex justify-between">
                <span>Driver:</span>
                <span class="font-medium">Test Driver</span>
              </div>
              <div class="flex justify-between">
                <span>Vehicle:</span>
                <span>Toyota Test</span>
              </div>
              <div class="flex justify-between">
                <span>Fuel:</span>
                <span>75%</span>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
              <div class="text-xs text-gray-500">
                📍 Last ping: Just now | 🎯 Static test vehicle
              </div>
            </div>
          </div>
        </div>
        <!-- Table View (hidden by default) -->
        <div id="vehicle-table-view" class="hidden overflow-x-auto mt-4">
          <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg shadow">
            <thead>
              <tr>
                <th class="p-2"><input type="checkbox" id="select-all-table"></th>
                <th class="p-2">ID</th>
                <th class="p-2">Make & Model</th>
                <th class="p-2">Driver</th>
                <th class="p-2">Status</th>
                <th class="p-2">Group</th>
                <th class="p-2">Last Ping</th>
                <th class="p-2">Driver Score</th>
                <th class="p-2">Alerts</th>
                <th class="p-2">Actions</th>
              </tr>
            </thead>
            <tbody id="vehicle-table-body"></tbody>
          </table>
        </div>
        <div class="flex justify-between mt-6">
          <button id="prev-page" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300" disabled>Previous</button>
          <span id="page-info" class="text-sm text-gray-600 dark:text-gray-400">Page 1</span>
          <button id="next-page" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">Next</button>
        </div>

        <!-- Create Group Modal -->
        <div id="create-group-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden" role="dialog" aria-labelledby="create-group-modal-title">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
            <h3 id="create-group-modal-title" class="text-lg font-bold text-gray-900 dark:text-white mb-4">Create Vehicle Group</h3>
            <div class="space-y-4">
              <div>
                <label for="group-name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Group Name</label>
                <input type="text" id="group-name" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md p-2" placeholder="Enter group name">
              </div>
              <div class="flex justify-end gap-2">
                <button id="cancel-create-group" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-create-group" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Create</button>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- Analytics -->
      <section class="w-full lg:w-[600px] xl:w-[700px]">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
          <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">Fleet Utilization</h3>
          <canvas id="utilization-chart" height="120"></canvas>
        </div>
      </section>
    </div>
    <!-- Vehicle Details Modal -->
    <div id="vehicle-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden p-4" role="dialog" aria-labelledby="vehicle-modal-title">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] relative flex flex-col">
        <div class="flex-shrink-0 p-6 border-b border-gray-200 dark:border-gray-700">
          <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 text-2xl" aria-label="Close Modal">×</button>
          <h2 class="text-xl font-bold text-gray-900 dark:text-white pr-8">Vehicle Details</h2>
        </div>
        <div class="flex-1 overflow-y-auto p-6">
          <div id="vehicle-modal-content"></div>
        </div>
      </div>
    </div>
  </main>
  <script>
    console.log('🔥 VEHICLES PAGE SCRIPT STARTING...');
    console.log('🔥 Page URL:', window.location.href);
    console.log('🔥 DOM ready state:', document.readyState);
    
    // Immediate test of DOM structure
    setTimeout(() => {
      const vehicleList = document.getElementById('vehicle-list');
      const loadingIndicator = document.getElementById('loading-indicator');
      console.log('🔥 IMMEDIATE DOM CHECK:');
      console.log('  - vehicle-list element:', vehicleList ? 'FOUND' : 'NOT FOUND');
      console.log('  - loading-indicator element:', loadingIndicator ? 'FOUND' : 'NOT FOUND');
      if (vehicleList) {
        console.log('  - vehicle-list innerHTML length:', vehicleList.innerHTML.length);
        console.log('  - vehicle-list children count:', vehicleList.children.length);
      }
    }, 50);
    
    // Vehicle manufacturers and models data
    const vehicleTypes = {
      'Ford': ['Transit', 'E-Series', 'F-150', 'Ranger', 'Transit Connect'],
      'Mercedes-Benz': ['Sprinter', 'Vito', 'Actros', 'Atego', 'Citan'],
      'Volkswagen': ['Crafter', 'Caddy', 'Amarok', 'Transporter'],
      'Iveco': ['Daily', 'Eurocargo', 'Stralis', 'S-Way'],
      'MAN': ['TGE', 'TGM', 'TGS', 'TGX'],
      'Volvo': ['FH', 'FM', 'FE', 'FL'],
      'Scania': ['P-Series', 'G-Series', 'R-Series', 'S-Series'],
      'DAF': ['LF', 'CF', 'XF'],
      'Isuzu': ['D-Max', 'NPR', 'NQR', 'FRR'],
      'Mitsubishi': ['Fuso Canter', 'L200', 'Outlander']
    };

    // Generate realistic plate numbers
    function generatePlateNumber() {
      const formats = [
        () => `${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String(Math.floor(Math.random() * 90) + 10)} ${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}`, // UK format: AB12 CDE
        () => `${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}-${String(Math.floor(Math.random() * 9000) + 1000)}`, // AAA-1234
        () => `${String(Math.floor(Math.random() * 9000) + 1000)}-${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}`, // 1234-AAA
        () => `${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String(Math.floor(Math.random() * 900) + 100)}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}` // A123BB
      ];
      const selectedFormat = formats[Math.floor(Math.random() * formats.length)];
      return selectedFormat();
    }

    // Generate violation history for drivers
    function generateViolationHistory() {
      const violationTypes = [
        { type: 'Speeding', severity: 'High', points: 3, description: 'Exceeded speed limit by 10+ km/h' },
        { type: 'Harsh Braking', severity: 'Medium', points: 2, description: 'Sudden braking detected' },
        { type: 'Harsh Acceleration', severity: 'Medium', points: 2, description: 'Rapid acceleration detected' },
        { type: 'Idling', severity: 'Low', points: 1, description: 'Excessive engine idling' },
        { type: 'Geofence Violation', severity: 'High', points: 3, description: 'Vehicle left designated area' },
        { type: 'Maintenance Overdue', severity: 'Medium', points: 2, description: 'Scheduled maintenance not completed' },
        { type: 'Fuel Waste', severity: 'Low', points: 1, description: 'Poor fuel efficiency detected' },
        { type: 'Route Deviation', severity: 'Medium', points: 2, description: 'Vehicle deviated from assigned route' }
      ];
      
      const history = [];
      const numViolations = Math.floor(Math.random() * 5); // 0-4 violations
      
      for (let i = 0; i < numViolations; i++) {
        const violation = violationTypes[Math.floor(Math.random() * violationTypes.length)];
        const daysAgo = Math.floor(Math.random() * 30) + 1; // 1-30 days ago
        
        history.push({
          ...violation,
          date: new Date(Date.now() - daysAgo * 24 * 3600000).toLocaleDateString(),
          time: new Date(Date.now() - daysAgo * 24 * 3600000).toLocaleTimeString(),
          location: `${(51.5 + (Math.random() - 0.5) * 0.1).toFixed(6)}, ${(-0.09 + (Math.random() - 0.5) * 0.1).toFixed(6)}`,
          resolved: Math.random() > 0.3, // 70% resolved
          warningIssued: Math.random() > 0.5 // 50% had warnings issued
        });
      }
      
      return history;
    }

    // Map fleet status to vehicles page status
    function mapFleetStatusToVehiclesPage(fleetStatus) {
      const statusMap = {
        'active': 'Driving',
        'idle': 'Idling',
        'offline': 'Offline'
      };
      return statusMap[fleetStatus] || 'Parked';
    }

    // Initialize vehicles data with proper error handling and fallbacks
    let vehicles = []; // Will be populated from map data
    
    function initializeVehiclesData() {
      console.log('🔄 Initializing vehicles data...');
      console.log('🔍 Data sources check:');
      console.log('  - UnifiedFleetData available:', typeof window.UnifiedFleetData !== 'undefined');
      console.log('  - SharedVehicleData available:', typeof window.SharedVehicleData !== 'undefined');
      console.log('  - VehiclesDataAPI available:', typeof VehiclesDataAPI !== 'undefined');
      console.log('  - DriversDataAPI available:', typeof DriversDataAPI !== 'undefined');
      
      try {
        // Use the unified fleet data to ensure all systems show identical information
        if (typeof window.UnifiedFleetData !== 'undefined') {
          vehicles = window.UnifiedFleetData.getVehiclesForVehiclesPage();
          console.log('✅ Using unified fleet data system:', vehicles.length, 'vehicles loaded with full compatibility');
        } else if (typeof window.SharedVehicleData !== 'undefined') {
          vehicles = window.SharedVehicleData.getVehiclesForVehiclesPage();
          console.log('✅ Using shared vehicle data store:', vehicles.length, 'vehicles loaded');
        } else if (typeof VehiclesDataAPI !== 'undefined') {
          vehicles = VehiclesDataAPI.generateExtendedFleet(50);
          console.log('✅ Using centralized vehicles data:', vehicles.length, 'vehicles loaded');
        } else {
          console.log('⚠️ No advanced vehicle data sources available, generating fallback data...');
          
          // Generate simple fallback data
          vehicles = Array.from({ length: 20 }, (_, i) => ({
        id: `VEH-${String(i + 1).padStart(3, '0')}`,
            driver: `Driver ${i + 1}`,
            status: ['Driving', 'Idling', 'Parked', 'Maintenance'][i % 4],
            manufacturer: ['Toyota', 'Ford', 'Mercedes', 'Volvo'][i % 4],
            model: ['Hiace', 'Transit', 'Sprinter', 'FH'][i % 4],
            plateNumber: `DEMO-${String(i + 1).padStart(3, '0')}`,
            year: 2020 + (i % 5),
            lat: 31.9539 + (Math.random() - 0.5) * 0.1,
            lng: 35.9106 + (Math.random() - 0.5) * 0.1,
        health: {
              fuel: Math.floor(Math.random() * 80) + 20,
              mileage: 10000 + (i * 1000),
              maintenanceRisk: ['Low', 'Medium', 'High'][i % 3],
              engineTemp: Math.floor(Math.random() * 40) + 80,
              batteryLevel: Math.floor(Math.random() * 50) + 50
            },
        driverBehavior: {
              score: Math.floor(Math.random() * 40) + 60,
              violations: Math.floor(Math.random() * 5),
              safetyRating: ['A', 'B', 'C'][i % 3]
            },
            alerts: Math.random() > 0.7 ? ['Low Fuel'] : [],
            group: ['Delivery', 'Service', 'Executive'][i % 3],
        route: {
          eta: new Date(Date.now() + Math.random() * 2 * 3600000).toLocaleTimeString(),
          distance: (Math.random() * 50 + 10).toFixed(1),
          currentSpeed: Math.floor(Math.random() * 80) + 20,
              destination: `Location ${i + 1}`,
              progress: Math.floor(Math.random() * 100)
            },
            utilization: Math.floor(Math.random() * 40) + 60,
            lastPing: new Date(Date.now() - Math.random() * 1800000).toLocaleTimeString()
          }));
          console.log('✅ Generated fallback vehicle data:', vehicles.length, 'vehicles');
        }
        
        console.log('📊 Final vehicles array length:', vehicles.length);
        return vehicles.length > 0;
        
      } catch (error) {
        console.error('❌ Error initializing vehicles data:', error);
        
        // Emergency fallback if everything fails
        if (vehicles.length === 0) {
          console.log('🆘 Creating emergency fallback data...');
          vehicles = Array.from({ length: 10 }, (_, i) => ({
            id: `VEH-${String(i + 1).padStart(3, '0')}`,
            driver: `Emergency Driver ${i + 1}`,
            status: ['Driving', 'Idling', 'Parked'][i % 3],
            manufacturer: 'Toyota',
            model: 'Emergency',
            plateNumber: `EMG-${String(i + 1).padStart(3, '0')}`,
            year: 2020,
            lat: 31.9539,
            lng: 35.9106,
            health: { fuel: 50, mileage: 10000, maintenanceRisk: 'Low' },
            driverBehavior: { score: 75 },
            alerts: [],
            group: 'Emergency',
            route: { eta: '12:00', distance: '10.0', currentSpeed: 50 },
            utilization: 75,
            lastPing: new Date().toLocaleTimeString()
          }));
          console.log('🆘 Emergency fallback data created:', vehicles.length, 'vehicles');
        }
        return vehicles.length > 0;
      }
    }
    
    // Initialize vehicles data immediately
    console.log('🚀 Starting vehicle data initialization...');
    const dataLoaded = initializeVehiclesData();
    console.log('🎯 Vehicle data initialization completed. Success:', dataLoaded, '| Vehicle count:', vehicles.length);
    
    // Emergency fallback: If no vehicles were loaded, create minimal test data
    if (!vehicles || vehicles.length === 0) {
      console.log('🆘 No vehicles loaded, creating emergency test data...');
      vehicles = Array.from({ length: 10 }, (_, i) => ({
        id: `TEST-${String(i + 1).padStart(3, '0')}`,
        driver: `Test Driver ${i + 1}`,
        status: ['Driving', 'Idling', 'Parked'][i % 3],
        manufacturer: 'Toyota',
        model: 'Test Vehicle',
        plateNumber: `TEST-${i + 1}`,
        year: 2020,
        lat: 31.9539,
        lng: 35.9106,
        health: { fuel: 75, mileage: 10000, maintenanceRisk: 'Low' },
        driverBehavior: { score: 85 },
        alerts: [],
        group: 'Test',
        route: { eta: '12:00', distance: '10.0', currentSpeed: 50 },
        utilization: 80,
        lastPing: new Date().toLocaleTimeString()
      }));
      console.log('🆘 Emergency test data created:', vehicles.length, 'vehicles');
    }
    
    // Force immediate render for debugging
    console.log('🔍 DEBUG: About to check rendering...');
    console.log('🔍 DEBUG: vehicles array:', vehicles);
    console.log('🔍 DEBUG: vehicles length:', vehicles ? vehicles.length : 'undefined');
    
    // Force render the vehicle list immediately
    setTimeout(() => {
      console.log('🔍 DEBUG: Forcing vehicle list render...');
      if (typeof renderVehicleList === 'function') {
        renderVehicleList();
        console.log('✅ DEBUG: renderVehicleList called successfully');
      } else {
        console.error('❌ DEBUG: renderVehicleList function not found');
      }
    }, 100);
    
    // Force map initialization with current vehicles
    setTimeout(() => {
      console.log('🗺️ DEBUG: Forcing map initialization...');
      if (vehicles && vehicles.length > 0) {
        // renderMap(vehicles.slice(0, 30)); // Disabled old map - using OpenLayers map instead
        console.log('✅ DEBUG: Vehicle data ready with', vehicles.length, 'vehicles');
        
        // Force analytics update to sync map widget after initialization
        setTimeout(() => {
          console.log('🔄 DEBUG: Forcing analytics sync with map...');
          updateAnalytics();
        }, 1000);
        
        // Additional delayed sync to ensure everything is fully loaded
        setTimeout(() => {
          console.log('🔄 DEBUG: Final forced sync check...');
          if (window.vehiclesPageMap && window.vehiclesPageMap.vehicleData) {
            console.log('🔍 Final sync: Map has', window.vehiclesPageMap.vehicleData.length, 'vehicles, Analytics uses', vehicles.length, 'vehicles');
            updateAnalytics(); // Force another sync attempt
          }
        }, 3000);
      } else {
        console.log('⚠️ DEBUG: No vehicles available for map initialization');
      }
    }, 500);
    // Broken code removed - fixed vehicle initialization above
    // Initialize vehicles display
    console.log('🚗 Vehicles loaded:', vehicles.length);
    
    // Render the vehicle list initially
    setTimeout(() => {
      console.log('🎬 Triggering initial render...');
      if (vehicles && vehicles.length > 0) {
        renderVehicleList(1, '', {});
        updateAnalytics();
        console.log('✅ Initial render completed');
      } else {
        console.log('❌ No vehicles to render!');
      }
    }, 500);

    // Pagination and Filters
    let currentPage = 1;
    const vehiclesPerPage = 9;
    let filters = { status: '', group: '' };
    let currentSort = '';
    let geofence = null;

    // Dashboard customization
    let dashboardConfig = JSON.parse(localStorage.getItem('dashboardConfig')) || [
      'total-vehicles', 'active-vehicles', 'maintenance-vehicles', 'alert-vehicles', 'avg-driver-score'
    ];

    function sortVehicles(vehicles, sortBy) {
      if (!sortBy) return vehicles;
      
      return [...vehicles].sort((a, b) => {
        switch (sortBy) {
          case 'status':
            const statusOrder = { 'Alert': 0, 'Maintenance': 1, 'Driving': 2, 'Idling': 3, 'Parked': 4, 'Offline': 5 };
            return (statusOrder[a.status] || 999) - (statusOrder[b.status] || 999);
          
          case 'driver-score-desc':
            return b.driverBehavior.score - a.driverBehavior.score;
          
          case 'last-update':
            // Convert time strings to comparable format (most recent first)
            const timeA = new Date(`1970/01/01 ${a.lastPing}`).getTime();
            const timeB = new Date(`1970/01/01 ${b.lastPing}`).getTime();
            return timeB - timeA;
          
          case 'fuel-asc':
            return a.health.fuel - b.health.fuel;
          
          case 'maintenance-risk':
            const riskOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
            return (riskOrder[a.health.maintenanceRisk] || 3) - (riskOrder[b.health.maintenanceRisk] || 3);
          
          case 'speed-desc':
            return b.route.currentSpeed - a.route.currentSpeed;
          
          case 'efficiency-desc':
            return b.driverBehavior.fuelEfficiency - a.driverBehavior.fuelEfficiency;
          
          case 'mileage-desc':
            return b.health.mileage - a.health.mileage;
          
          default:
            return 0;
        }
      });
    }

    function renderVehicleList(page = 1, filter = '', filters = {}, skipHeavyRenders = false) {
      console.log('🎬 renderVehicleList called with:', { page, filter, filters, skipHeavyRenders });
      console.log('🎬 vehicles available:', vehicles ? vehicles.length : 'undefined');
      console.log('🎬 vehicles sample:', vehicles ? vehicles.slice(0, 2) : 'undefined');
      
      // Use the vehicles array directly since this is a demo
      const list = document.getElementById('vehicle-list');
      const loadingIndicator = document.getElementById('loading-indicator');
      
      console.log('🎬 DOM elements:', { 
        list: list ? 'found' : 'NOT FOUND', 
        loadingIndicator: loadingIndicator ? 'found' : 'NOT FOUND' 
      });
      
      // Hide loading indicator and clear list
      if (loadingIndicator) loadingIndicator.style.display = 'none';
      
      // EMERGENCY: If no vehicles available, create immediate test data
      let workingVehicles = vehicles;
      if (!workingVehicles || workingVehicles.length === 0) {
        console.log('🆘 EMERGENCY: No vehicles in renderVehicleList, creating immediate test data');
        workingVehicles = [
          {
            id: 'EMERGENCY-001',
            driver: 'Emergency Driver 1',
            status: 'Driving',
            manufacturer: 'Emergency',
            model: 'Test',
            plateNumber: 'EMG-001',
            health: { fuel: 75 },
            driverBehavior: { score: 85 },
            alerts: [],
            group: 'Emergency'
          },
          {
            id: 'EMERGENCY-002', 
            driver: 'Emergency Driver 2',
            status: 'Idling',
            manufacturer: 'Emergency',
            model: 'Test',
            plateNumber: 'EMG-002',
            health: { fuel: 60 },
            driverBehavior: { score: 90 },
            alerts: ['Low Fuel'],
            group: 'Emergency'
          }
        ];
        console.log('🆘 EMERGENCY test data created for render:', workingVehicles.length);
      }
      
      list.innerHTML = '';
      
      // Optimized filtering - only filter if there's actually a filter
      let filtered = workingVehicles;
      if (filter || filters.status || filters.group) {
        const filterLower = filter.toLowerCase();
        filtered = workingVehicles.filter(v =>
          (!filter || 
           v.id.toLowerCase().includes(filterLower) ||
           v.driver.toLowerCase().includes(filterLower) ||
           v.plateNumber.toLowerCase().includes(filterLower) ||
           v.manufacturer.toLowerCase().includes(filterLower) ||
           v.model.toLowerCase().includes(filterLower)) &&
          (!filters.status || v.status === filters.status) &&
          (!filters.group || v.group === filters.group)
        );
      }

      // Apply sorting
      filtered = sortVehicles(filtered, currentSort);
          const start = (page - 1) * vehiclesPerPage;
          const end = start + vehiclesPerPage;
          const paginated = filtered.slice(start, end);
          
          // Use DocumentFragment for better performance
          const fragment = document.createDocumentFragment();
          
          paginated.forEach(vehicle => {
            const card = document.createElement('div');
            card.className = 'vehicle-card bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex flex-col gap-4 relative';
            card.innerHTML = `
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <input type="checkbox" class="vehicle-checkbox mr-3 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" data-vehicle-id="${vehicle.id}" title="Select for bulk actions">
                  <div>
                    <span class="status-dot status-${vehicle.status.toLowerCase()}"></span>
                    <span class="font-bold text-gray-900 dark:text-white">${vehicle.id}</span>
                    <span class="ml-2 text-xs px-2 py-1 rounded bg-blue-100 dark:bg-blue-600 text-blue-800 dark:text-blue-100">${vehicle.group}</span>
                  </div>
                </div>
                <button class="vehicle-action-btn px-2 py-1 rounded text-blue-600 dark:text-blue-400 hover:bg-blue-100" title="View Details" aria-label="View ${vehicle.id} Details"><i class="fas fa-eye"></i></button>
              </div>
              <div class="text-sm text-gray-600 dark:text-gray-400">
                <span class="font-medium text-gray-900 dark:text-white">${vehicle.manufacturer} ${vehicle.model}</span>
                <span class="ml-2 text-xs text-gray-500">(${vehicle.year})</span>
              </div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Plate: <span class="font-mono font-medium">${vehicle.plateNumber}</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Driver: <span class="font-medium">${vehicle.driver}</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Status: <span class="font-medium">${vehicle.status}</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Last Ping: <span class="font-mono">${vehicle.lastPing}</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Driver Score: <span class="font-medium">${vehicle.driverBehavior.score}/100</span> <span class="text-xs ${vehicle.driverBehavior.weeklyTrend === 'improving' ? 'text-green-600' : 'text-red-600'}">(${vehicle.driverBehavior.weeklyTrend})</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Speed: <span class="font-medium ${vehicle.route.currentSpeed > vehicle.route.speedLimit ? 'text-red-600' : 'text-green-600'}">${vehicle.route.currentSpeed} km/h</span> <span class="text-xs text-gray-500">(limit: ${vehicle.route.speedLimit})</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Fuel Efficiency: <span class="font-medium">${vehicle.route.fuelConsumption}L/100km</span></div>
              <div class="text-sm text-gray-600 dark:text-gray-400">ETA: <span class="font-medium">${vehicle.route.eta}</span></div>
              ${vehicle.health.maintenanceRisk === 'High' ? `<div class="text-xs text-red-600 dark:text-red-400 font-semibold flex items-center"><i class="fas fa-exclamation-triangle mr-1"></i>High Maintenance Risk</div>` : ''}

              <div class="flex flex-wrap gap-2 mt-3 justify-start">
                <button class="vehicle-action-btn locate-map-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-green-600 hover:text-white flex items-center justify-center" title="Locate on Map" aria-label="Locate ${vehicle.id} on Map"><i class="fas fa-map-marker-alt text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-blue-600 hover:text-white flex items-center justify-center" title="Send Message" aria-label="Send Message to ${vehicle.driver}"><i class="fas fa-envelope text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-blue-600 hover:text-white flex items-center justify-center" title="Schedule Maintenance" aria-label="Schedule Maintenance for ${vehicle.id}"><i class="fas fa-tools text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-blue-600 hover:text-white flex items-center justify-center" title="Assign Driver" aria-label="Assign Driver to ${vehicle.id}"><i class="fas fa-user-plus text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-purple-600 hover:text-white flex items-center justify-center" title="View Camera" aria-label="View Camera for ${vehicle.id}"><i class="fas fa-video text-sm"></i></button>

                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-orange-600 hover:text-white flex items-center justify-center" title="View Logs" aria-label="View Logs for ${vehicle.id}"><i class="fas fa-file-alt text-sm"></i></button>
                <button class="vehicle-action-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-teal-600 hover:text-white flex items-center justify-center" title="Set Geofence for Driver" aria-label="Set Geofence for ${vehicle.driver}"><i class="fas fa-draw-polygon text-sm"></i></button>
                <button class="vehicle-action-btn warning-btn flex-shrink-0 w-8 h-8 rounded bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-200 hover:bg-red-600 hover:text-white flex items-center justify-center" title="Issue Warning" aria-label="Issue Warning to ${vehicle.driver}" data-vehicle-id="${vehicle.id}"><i class="fas fa-exclamation-triangle text-sm"></i></button>
              </div>
              ${vehicle.alerts.length > 0 ? `<div class="mt-2 text-xs text-red-600 dark:text-red-400 font-semibold">Alerts: ${vehicle.alerts.join(', ')}</div>` : ''}
            `;
            console.log('🔍 Setting up eye button for vehicle:', vehicle.id);
            const eyeButton = card.querySelector('button[title="View Details"]');
            console.log('🔍 Eye button found:', !!eyeButton, eyeButton);
            if (eyeButton) {
              eyeButton.addEventListener('click', (e) => {
                console.log('🚗 EYE BUTTON CLICKED for vehicle:', vehicle.id);
                e.preventDefault();
                e.stopPropagation();
                showVehicleModal(vehicle);
              });
              // Test with onclick as backup
              eyeButton.onclick = (e) => {
                console.log('🚗 EYE BUTTON ONCLICK for vehicle:', vehicle.id);
                e.preventDefault();
                e.stopPropagation();
                showVehicleModal(vehicle);
              };
            } else {
              console.warn('❌ Eye button not found for vehicle:', vehicle.id);
              // Try alternative selectors
              const altButton = card.querySelector('.fa-eye');
              console.log('🔍 Alternative fa-eye found:', !!altButton);
              if (altButton && altButton.parentElement) {
                console.log('🔍 Using parent element for click handler');
                altButton.parentElement.onclick = (e) => {
                  console.log('🚗 ALT EYE BUTTON CLICKED for vehicle:', vehicle.id);
                  e.preventDefault();
                  e.stopPropagation();
                  showVehicleModal(vehicle);
                };
              }
            }
            
            // Add event listeners for the new action buttons
            card.querySelector('.locate-map-btn').onclick = () => locateVehicleOnMap(vehicle.id);
            card.querySelector('.fa-envelope').parentElement.onclick = () => sendMessageToDriver(vehicle);
            card.querySelector('.fa-tools').parentElement.onclick = () => scheduleMaintenanceForVehicle(vehicle);
            card.querySelector('.fa-user-plus').parentElement.onclick = () => assignDriverToVehicle(vehicle);
            card.querySelector('.fa-video').parentElement.onclick = () => viewVehicleCamera(vehicle);
            card.querySelector('.fa-file-alt').parentElement.onclick = () => viewVehicleLogs(vehicle);
            card.querySelector('.fa-draw-polygon').parentElement.onclick = () => setGeofenceForDriver(vehicle);
            card.querySelector('.warning-btn').onclick = () => issueWarningToDriver(vehicle);
            
            // Add event listener for vehicle selection checkbox
            const checkbox = card.querySelector('.vehicle-checkbox');
            if (checkbox) {
              checkbox.addEventListener('change', function(e) {
                e.stopPropagation();
                toggleVehicleSelection(vehicle.id, this.checked);
              });
            }
            
            fragment.appendChild(card);
          });
          
          list.appendChild(fragment);
          
          document.getElementById('page-info').textContent = `Page ${page}`;
          document.getElementById('prev-page').disabled = page === 1;
          document.getElementById('next-page').disabled = end >= filtered.length;
          
          // Update analytics efficiently
          updateAnalytics();
          
          // Only render heavy components when needed
          if (!skipHeavyRenders) {
            renderUtilizationChart();
            // renderMap(filtered.slice(0, 30)); // Disabled old map - using OpenLayers map instead
          }
    }
    
    // Separate analytics update function for better performance
    function updateAnalytics() {
      console.log('📊 updateAnalytics called with', vehicles.length, 'vehicles');
      
      // Count vehicles by status
      const statusCounts = {
        total: vehicles.length,
        driving: vehicles.filter(v => v.status === 'Driving').length,
        maintenance: vehicles.filter(v => v.status === 'Maintenance').length,
        alerts: vehicles.filter(v => v.alerts && v.alerts.length > 0).length
      };
      
      console.log('📊 Analytics counts:', statusCounts);
      
      // Update DOM elements
      document.getElementById('total-vehicles').textContent = statusCounts.total;
      document.getElementById('active-vehicles').textContent = statusCounts.driving;
      document.getElementById('maintenance-vehicles').textContent = statusCounts.maintenance;
      document.getElementById('alert-vehicles').textContent = statusCounts.alerts;
      document.getElementById('avg-driver-score').textContent = (vehicles.reduce((sum, v) => sum + v.driverBehavior.score, 0) / vehicles.length).toFixed(1);
      
      // FORCE COMPLETE DATA SYNCHRONIZATION: Make both analytics and map use the same source
      if (window.vehiclesPageMap && window.vehiclesPageMap.vehicleData) {
        const mapVehicleCount = window.vehiclesPageMap.vehicleData.length;
        const analyticsVehicleCount = vehicles.length;
        
        console.log('🔄 SYNC CHECK: Map has', mapVehicleCount, 'vehicles, Analytics has', analyticsVehicleCount, 'vehicles');
        
        if (mapVehicleCount !== analyticsVehicleCount) {
          console.log('⚠️ MISMATCH DETECTED! Forcing complete sync...');
          
          // Option 1: If map has more vehicles, use map's data for analytics
          if (mapVehicleCount > analyticsVehicleCount) {
            console.log('🗺️ Using map widget data for analytics (', mapVehicleCount, 'vehicles)');
            
            // Convert map widget data to vehicles page format
            vehicles = window.vehiclesPageMap.vehicleData.map(v => ({
              ...v,
              status: mapWidgetStatusToVehiclesPage(v.status)
            }));
            
            // Recalculate analytics with new data
            const newStatusCounts = {
              total: vehicles.length,
              driving: vehicles.filter(v => v.status === 'Driving').length,
              maintenance: vehicles.filter(v => v.status === 'Maintenance').length,
              alerts: vehicles.filter(v => v.alerts && v.alerts.length > 0).length
            };
            
            console.log('📊 UPDATED Analytics counts:', newStatusCounts);
            
            // Update DOM with corrected counts
            document.getElementById('total-vehicles').textContent = newStatusCounts.total;
            document.getElementById('active-vehicles').textContent = newStatusCounts.driving;
            document.getElementById('maintenance-vehicles').textContent = newStatusCounts.maintenance;
            document.getElementById('alert-vehicles').textContent = newStatusCounts.alerts;
            document.getElementById('avg-driver-score').textContent = (vehicles.reduce((sum, v) => sum + v.driverBehavior.score, 0) / vehicles.length).toFixed(1);
            
            console.log('✅ FORCED SYNC COMPLETE: Both analytics and map now use', vehicles.length, 'vehicles');
          } else {
            // Option 2: If analytics has more, update map with analytics data
            console.log('📊 Using analytics data for map widget (', analyticsVehicleCount, 'vehicles)');
            
            const mapFormattedVehicles = vehicles.map(v => ({
              ...v,
              status: mapFleetStatusToMapWidget(v.status)
            }));
            
            window.vehiclesPageMap.vehicleData = mapFormattedVehicles;
            window.vehiclesPageMap.updateVehicles();
            window.vehiclesPageMap.updateStatistics();
            
            console.log('✅ Map widget updated with analytics data:', mapFormattedVehicles.length, 'vehicles');
          }
        } else {
          console.log('✅ Data already in sync:', analyticsVehicleCount, 'vehicles');
        }
      }
    }
    
    // Convert vehicles page status to map widget status format
    function mapFleetStatusToMapWidget(vehiclePageStatus) {
      const statusMap = {
        'Driving': 'active',
        'Idling': 'idle', 
        'Parked': 'idle',
        'Offline': 'offline',
        'Maintenance': 'offline'
      };
      return statusMap[vehiclePageStatus] || 'idle';
    }
    
    // Convert map widget status back to vehicles page status format
    function mapWidgetStatusToVehiclesPage(mapWidgetStatus) {
      const statusMap = {
        'active': 'Driving',
        'idle': 'Idling',
        'offline': 'Offline'
      };
      return statusMap[mapWidgetStatus] || 'Parked';
    }

    // Render Alert Feed

    // Event Listeners
    document.getElementById('vehicle-search').addEventListener('input', function() {
      currentPage = 1;
      renderVehicleList(currentPage, this.value, filters);
    });
    
    // Select All checkbox
    document.getElementById('select-all-checkbox').addEventListener('change', function() {
      const isChecked = this.checked;
      if (isChecked) {
        selectAllVehicles();
      } else {
        clearAllSelections();
      }
    });

    // Event delegation for warning buttons (fallback)
    document.addEventListener('click', function(event) {
      if (event.target.closest('.warning-btn')) {
        const warningBtn = event.target.closest('.warning-btn');
        const vehicleId = warningBtn.getAttribute('data-vehicle-id');
        const vehicle = vehicles.find(v => v.id === vehicleId);
        
        if (vehicle) {
          console.log('Warning button clicked via event delegation for vehicle:', vehicle.id);
          issueWarningToDriver(vehicle);
        } else {
          console.error('Vehicle not found for ID:', vehicleId);
        }
      }
    });
    document.getElementById('sort-vehicles').addEventListener('change', function() {
      currentSort = this.value;
      currentPage = 1;
      renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
    });
    document.getElementById('prev-page').addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
      }
    });
    document.getElementById('next-page').addEventListener('click', function() {
      currentPage++;
      renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
    });
    document.getElementById('filter-btn').addEventListener('click', () => {
      document.getElementById('filter-modal').classList.remove('hidden');
    });
    document.getElementById('apply-filter').addEventListener('click', () => {
      filters.status = document.getElementById('filter-status').value;
      filters.group = document.getElementById('filter-group').value;
      currentPage = 1;
      renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
      document.getElementById('filter-modal').classList.add('hidden');
    });
    document.getElementById('clear-filter').addEventListener('click', () => {
      filters = { status: '', group: '' };
      document.getElementById('filter-status').value = '';
      document.getElementById('filter-group').value = '';
      currentPage = 1;
      renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
      document.getElementById('filter-modal').classList.add('hidden');
    });
    
    // Notification Bell Functionality
    const notificationToggle = document.getElementById('notification-toggle');
    const notificationTray = document.getElementById('notification-tray');
    const notificationCount = document.getElementById('notification-count');
    const notificationsList = document.getElementById('notifications-list');
    
    let notifications = [];
    
    notificationToggle.addEventListener('click', () => {
      notificationTray.classList.toggle('active');
    });
    
    document.getElementById('clear-notifications').addEventListener('click', () => {
      notifications = [];
      renderNotifications();
    });
    
    function addNotification(message, type = 'info') {
      notifications.push({
        id: `NOTIF-${Date.now()}`,
        message,
        type,
        timestamp: new Date()
      });
      renderNotifications();
    }
    
    function removeNotification(id) {
      notifications = notifications.filter(n => n.id !== id);
      updateNotificationBadge();
      renderNotifications();
    }
    
    function updateNotificationBadge() {
      notificationCount.textContent = notifications.length;
      notificationCount.classList.toggle('hidden', notifications.length === 0);
    }
    
    function renderNotifications() {
      notificationsList.innerHTML = '';
      notifications.forEach(n => {
        const div = document.createElement('div');
        div.className = `p-2 rounded-lg ${n.type === 'error' ? 'bg-red-50 dark:bg-red-900' : n.type === 'warning' ? 'bg-yellow-50 dark:bg-yellow-900' : 'bg-blue-50 dark:bg-blue-900'}`;
        div.innerHTML = `
          <div class="flex justify-between">
            <span class="text-sm">${n.message}</span>
            <span class="text-xs text-gray-400">${n.timestamp.toLocaleTimeString()}</span>
          </div>
        `;
        notificationsList.appendChild(div);
      });
      updateNotificationBadge();
    }
    
    // Make functions globally available
    window.addNotification = addNotification;
    window.removeNotification = removeNotification;
    
    // Example notifications on page load
    setTimeout(() => {
      addNotification('Fleet sync completed successfully', 'info');
      addNotification('Vehicle V001 requires maintenance', 'warning');
      addNotification('System error detected', 'error');
    }, 2000);
    
    document.getElementById('sidebar-toggle').addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      const main = document.getElementById('main-content-container');
      sidebar.classList.toggle('sidebar-hidden');
      main.classList.toggle('ml-64');
      main.classList.toggle('ml-0');
    });
    document.getElementById('theme-toggle').addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const icon = document.getElementById('theme-toggle').querySelector('i');
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
    });

    // Vehicle Modal
    function showVehicleModal(vehicle) {
      console.log('🚗 showVehicleModal called for:', vehicle.id, vehicle);
      console.log('🚗 Modal elements check starting...');
      const modal = document.getElementById('vehicle-modal');
      const content = document.getElementById('vehicle-modal-content');
      console.log('🚗 Modal found:', !!modal);
      console.log('🚗 Content found:', !!content);
      
      if (!modal) {
        console.error('❌ Vehicle modal not found!');
        alert('Vehicle modal not found! Please check console.');
        return;
      }
      
      if (!content) {
        console.error('❌ Vehicle modal content not found!');
        return;
      }
      content.innerHTML = `
        <div class="space-y-6">
          <!-- Vehicle Header -->
          <div class="flex items-center justify-between">
            <div>
              <h3 id="vehicle-modal-title" class="text-2xl font-bold text-gray-900 dark:text-white">${vehicle.id} <span class="ml-2 text-sm px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-600 text-blue-800 dark:text-blue-100">${vehicle.group}</span></h3>
              <div class="flex items-center mt-2">
                <span class="status-dot status-${vehicle.status.toLowerCase()} mr-2"></span>
                <span class="font-medium text-gray-700 dark:text-gray-300">${vehicle.status}</span>
              </div>
            </div>
          </div>

          <!-- Vehicle Info Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Basic Vehicle Info -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h4 class="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                <i class="fas fa-truck mr-2 text-blue-600"></i>Vehicle Information
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Manufacturer:</span>
                  <span class="font-medium">${vehicle.manufacturer} ${vehicle.model}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Year:</span>
                  <span class="font-medium">${vehicle.year}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Plate Number:</span>
                  <span class="font-mono font-medium">${vehicle.plateNumber}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">VIN:</span>
                  <span class="font-mono text-xs">${vehicle.vin}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Driver:</span>
                  <span class="font-medium">${vehicle.driver}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Mileage:</span>
                  <span class="font-medium">${vehicle.health?.mileage ? vehicle.health.mileage.toLocaleString() : 'N/A'} km</span>
                </div>
              </div>
            </div>

            <!-- Current Status -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h4 class="font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
                <i class="fas fa-chart-line mr-2 text-green-600"></i>Current Status
              </h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Last Ping:</span>
                  <span class="font-medium">${vehicle.lastPing}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Current Speed:</span>
                  <span class="font-medium ${vehicle.route.currentSpeed > vehicle.route.speedLimit ? 'text-red-600' : 'text-green-600'}">${vehicle.route.currentSpeed} km/h</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Speed Limit:</span>
                  <span class="font-medium">${vehicle.route.speedLimit} km/h</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Fuel Level:</span>
                  <span class="font-medium">${vehicle.health.fuel}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Battery:</span>
                  <span class="font-medium">${vehicle.health.battery}%</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Engine Temp:</span>
                  <span class="font-medium">${vehicle.health?.engineTemp ? vehicle.health.engineTemp.toFixed(1) : 'N/A'}°C</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Driver Performance Section -->
          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800">
            <h4 class="font-semibold text-blue-800 dark:text-blue-300 mb-3 flex items-center">
              <i class="fas fa-user-check mr-2"></i>Driver Performance
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">${vehicle.driverBehavior.score}</div>
                <div class="text-gray-600 dark:text-gray-400">Overall Score</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold ${vehicle.driverBehavior.safetyRating === 'Excellent' ? 'text-green-600' : vehicle.driverBehavior.safetyRating === 'Poor' ? 'text-red-600' : 'text-yellow-600'}">${vehicle.driverBehavior.safetyRating}</div>
                <div class="text-gray-600 dark:text-gray-400">Safety Rating</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-green-600">${vehicle.driverBehavior.fuelEfficiency}%</div>
                <div class="text-gray-600 dark:text-gray-400">Fuel Efficiency</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-blue-600">${vehicle.driverBehavior.onTimeDelivery}%</div>
                <div class="text-gray-600 dark:text-gray-400">On-Time Delivery</div>
              </div>
            </div>
          </div>

          <!-- Predictive Maintenance Section -->
          ${vehicle.health.maintenanceRisk !== 'Low' || (vehicle.health.predictedFailures && vehicle.health.predictedFailures.length > 0) ? `
          <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 border border-orange-200 dark:border-orange-800">
            <h4 class="font-semibold text-orange-800 dark:text-orange-300 mb-3 flex items-center">
              <i class="fas fa-tools mr-2"></i>Predictive Maintenance
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div class="text-center">
                <div class="text-lg font-semibold ${vehicle.health.maintenanceRisk === 'High' ? 'text-red-600' : 'text-yellow-600'}">${vehicle.health.maintenanceRisk}</div>
                <div class="text-gray-600 dark:text-gray-400">Risk Level</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-blue-600">${vehicle.health.oilLife}%</div>
                <div class="text-gray-600 dark:text-gray-400">Oil Life</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-orange-600">${vehicle.health.brakeWear}%</div>
                <div class="text-gray-600 dark:text-gray-400">Brake Wear</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-semibold text-purple-600">${vehicle.health.transmissionHealth}%</div>
                <div class="text-gray-600 dark:text-gray-400">Transmission</div>
              </div>
            </div>
            ${vehicle.health.predictedFailures && vehicle.health.predictedFailures.length > 0 ? `
            <div class="mt-3 p-3 bg-red-50 dark:bg-red-900/20 rounded border border-red-200 dark:border-red-800">
              <div class="text-sm">
                <strong class="text-red-800 dark:text-red-300">Predicted Issues:</strong>
                <span class="text-red-600 dark:text-red-400 ml-2">${vehicle.health.predictedFailures.join(', ')}</span>
              </div>
            </div>
            ` : ''}
          </div>
          ` : ''}

          <!-- Charts Section -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
              <h4 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Utilization (Last 7 days)</h4>
              <canvas id="modal-utilization-chart" height="200"></canvas>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
              <h4 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Driver Behavior</h4>
              <canvas id="modal-driver-behavior-chart" height="200"></canvas>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
            <button class="vehicle-action-btn px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors" title="Send Message" aria-label="Send Message to ${vehicle.driver}">
              <i class="fas fa-envelope mr-1"></i>Message
            </button>
            <button class="vehicle-action-btn px-4 py-2 rounded bg-yellow-500 text-white hover:bg-yellow-600 transition-colors" title="Schedule Maintenance" aria-label="Schedule Maintenance for ${vehicle.id}">
              <i class="fas fa-tools mr-1"></i>Maintenance
            </button>
            <button class="vehicle-action-btn px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition-colors" title="Assign Driver" aria-label="Assign Driver to ${vehicle.id}">
              <i class="fas fa-user-plus mr-1"></i>Assign
            </button>
            <button class="vehicle-action-btn px-4 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 transition-colors" title="View Camera" aria-label="View Camera for ${vehicle.id}">
              <i class="fas fa-video mr-1"></i>Camera
            </button>
            <button class="vehicle-action-btn px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 transition-colors" title="View on Map" aria-label="View ${vehicle.id} on Map">
              <i class="fas fa-map-marker-alt mr-1"></i>Map
            </button>
            <button class="vehicle-action-btn px-4 py-2 rounded bg-orange-600 text-white hover:bg-orange-700 transition-colors" title="View Logs" aria-label="View Logs for ${vehicle.id}">
              <i class="fas fa-file-alt mr-1"></i>Logs
            </button>
          </div>
        </div>
      `;
      modal.classList.remove('hidden');
      console.log('✅ Vehicle modal opened for:', vehicle.id);
      setTimeout(() => {
        new Chart(document.getElementById('modal-utilization-chart').getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
            datasets: [{
              label: 'Hours Used',
              data: vehicle.utilization,
              backgroundColor: '#2563eb'
            }]
          },
          options: { plugins: { legend: { display: false } } }
        });
        new Chart(document.getElementById('modal-driver-behavior-chart').getContext('2d'), {
          type: 'radar',
          data: {
            labels: ['Harsh Braking', 'Speeding', 'Idling', 'Harsh Acceleration', 'Cornering'],
            datasets: [{
              label: 'Driver Behavior',
              data: [
                vehicle.driverBehavior.harshBraking,
                vehicle.driverBehavior.speeding,
                vehicle.driverBehavior.idling,
                vehicle.driverBehavior.harshAcceleration,
                vehicle.driverBehavior.cornering
              ],
              backgroundColor: 'rgba(37,99,235,0.2)',
              borderColor: '#2563eb'
            }]
          },
          options: { plugins: { legend: { display: false } } }
        });

        // Add event listeners for modal action buttons
        setTimeout(() => {
          const modalCameraBtn = modal.querySelector('.fa-video').parentElement;
          const modalMapBtn = modal.querySelector('.fa-map-marker-alt').parentElement;
          const modalLogsBtn = modal.querySelector('.fa-file-alt').parentElement;
          
          if (modalCameraBtn) modalCameraBtn.onclick = () => viewVehicleCamera(vehicle);
          if (modalMapBtn) modalMapBtn.onclick = () => viewVehicleOnMap(vehicle);
          if (modalLogsBtn) modalLogsBtn.onclick = () => viewVehicleLogs(vehicle);
        }, 50);
      }, 100);
    }
    document.getElementById('close-modal').onclick = () => {
      document.getElementById('vehicle-modal').classList.add('hidden');
    };

    // Vehicle Action Functions
    function viewVehicleCamera(vehicle) {
      showVehicleCameraModal(vehicle.id);
    }

    // Vehicle Camera Modal (similar to index page)
    function showVehicleCameraModal(vehicleId) {
      const vehicle = vehicles.find(v => v.id === vehicleId);
      const isConnected = vehicle.status !== 'Offline';
      
      const modal = document.createElement('div');
      modal.setAttribute('data-modal-type', 'camera');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        font-family: 'Inter', sans-serif;
      `;
      
      const cameraViews = [
        { name: 'Front Camera', id: 'front', status: isConnected ? 'online' : 'offline' },
        { name: 'Rear Camera', id: 'rear', status: isConnected && Math.random() > 0.3 ? 'online' : 'offline' },
        { name: 'Left Side', id: 'left', status: isConnected && Math.random() > 0.5 ? 'online' : 'offline' },
        { name: 'Right Side', id: 'right', status: isConnected && Math.random() > 0.5 ? 'online' : 'offline' },
        { name: 'Interior', id: 'interior', status: isConnected && Math.random() > 0.2 ? 'online' : 'offline' },
        { name: 'Dashboard', id: 'dashboard', status: isConnected && Math.random() > 0.4 ? 'online' : 'offline' }
      ];
      
      modal.innerHTML = `
        <div style="background: #1f2937; border-radius: 16px; padding: 24px; max-width: 95vw; width: 1200px; max-height: 90vh; overflow-y: auto; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 1px solid #374151; padding-bottom: 16px;">
            <div style="display: flex; align-items: center;">
              <div style="width: 48px; height: 48px; border-radius: 50%; background: #ef4444; display: flex; align-items: center; justify-content: center; margin-right: 16px;">
                <i class="fas fa-video" style="color: white; font-size: 20px;"></i>
              </div>
              <div>
                <h3 style="margin: 0; font-size: 24px; font-weight: bold;">${vehicleId} Camera System</h3>
                <div style="font-size: 14px; color: #9ca3af; margin-top: 4px;">
                  <i class="fas ${isConnected ? 'fa-circle' : 'fa-circle'}" style="color: ${isConnected ? '#10b981' : '#ef4444'}; margin-right: 6px;"></i>
                  ${isConnected ? 'Vehicle Connected' : 'Vehicle Offline - Limited Camera Access'}
                </div>
              </div>
            </div>
            <button onclick="closeVehicleModal('camera')" 
                    style="background: #374151; border: none; font-size: 24px; cursor: pointer; color: #9ca3af; padding: 8px 12px; border-radius: 8px; transition: all 0.2s;"
                    onmouseover="this.style.background='#4b5563'" 
                    onmouseout="this.style.background='#374151'">×</button>
          </div>
          
          <!-- Camera Grid -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 24px;">
            ${cameraViews.map(camera => `
              <div style="background: #111827; border-radius: 12px; overflow: hidden; border: 2px solid ${camera.status === 'online' ? '#10b981' : '#374151'};">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #374151;">
                  <div style="display: flex; align-items: center;">
                    <i class="fas fa-video" style="color: ${camera.status === 'online' ? '#10b981' : '#6b7280'}; margin-right: 8px;"></i>
                    <span style="font-weight: 600; font-size: 14px;">${camera.name}</span>
                  </div>
                  <div style="display: flex; align-items: center;">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${camera.status === 'online' ? '#10b981' : '#ef4444'}; margin-right: 6px;"></div>
                    <span style="font-size: 12px; color: #9ca3af; text-transform: uppercase;">${camera.status}</span>
                  </div>
                </div>
                
                <div style="aspect-ratio: 16/9; background: ${camera.status === 'online' ? '#000' : '#1f2937'}; position: relative; display: flex; align-items: center; justify-content: center;">
                  ${camera.status === 'online' ? `
                    <div style="width: 100%; height: 100%; background: linear-gradient(45deg, #1f2937 25%, transparent 25%), linear-gradient(-45deg, #1f2937 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #1f2937 75%), linear-gradient(-45deg, transparent 75%, #1f2937 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; opacity: 0.3; position: absolute;"></div>
                    <div style="text-align: center; z-index: 1;">
                      <div style="width: 60px; height: 60px; border: 3px solid #10b981; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px;"></div>
                      <div style="font-size: 14px; color: #10b981; font-weight: 600;">🔴 LIVE</div>
                      <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">HD 1080p • ${Math.floor(Math.random() * 30) + 25} FPS</div>
                    </div>
                  ` : `
                    <div style="text-align: center;">
                      <i class="fas fa-video-slash" style="font-size: 36px; color: #6b7280; margin-bottom: 12px;"></i>
                      <div style="font-size: 14px; color: #6b7280;">Camera Offline</div>
                      <div style="font-size: 12px; color: #4b5563; margin-top: 4px;">Check connection</div>
                    </div>
                  `}
                </div>
                
                ${camera.status === 'online' ? `
                  <div style="padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; background: #111827;">
                    <div style="display: flex; gap: 8px;">
                      <button onclick="toggleCameraRecording('${vehicleId}', '${camera.id}')" 
                              style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        <i class="fas fa-record-vinyl" style="margin-right: 4px;"></i>REC
                      </button>
                      <button onclick="takeCameraSnapshot('${vehicleId}', '${camera.id}')" 
                              style="padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        <i class="fas fa-camera" style="margin-right: 4px;"></i>SNAP
                      </button>
                    </div>
                    <div style="font-size: 11px; color: #9ca3af;">
                      ${new Date().toLocaleTimeString()}
                    </div>
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
          
          <!-- Camera Controls -->
          <div style="display: flex; justify-content: space-between; align-items: center; background: #111827; padding: 16px; border-radius: 12px;">
            <div style="display: flex; gap: 12px;">
              <button onclick="refreshAllCameras('${vehicleId}')" 
                      style="padding: 10px 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;"
                      onmouseover="this.style.background='#059669'" 
                      onmouseout="this.style.background='#10b981'">
                <i class="fas fa-sync-alt" style="margin-right: 6px;"></i>Refresh All
              </button>
              
              <button onclick="downloadCameraFootage('${vehicleId}')" 
                      style="padding: 10px 16px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;"
                      onmouseover="this.style.background='#7c3aed'" 
                      onmouseout="this.style.background='#8b5cf6'">
                <i class="fas fa-download" style="margin-right: 6px;"></i>Download Footage
              </button>
              
              <button onclick="enableNightVision('${vehicleId}')" 
                      style="padding: 10px 16px; background: #374151; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;"
                      onmouseover="this.style.background='#4b5563'" 
                      onmouseout="this.style.background='#374151'">
                <i class="fas fa-moon" style="margin-right: 6px;"></i>Night Vision
              </button>
            </div>
            
            <div style="display: flex; align-items: center; gap: 16px;">
              <div style="font-size: 12px; color: #9ca3af;">
                <i class="fas fa-hdd" style="margin-right: 6px;"></i>
                Storage: ${Math.floor(Math.random() * 40) + 60}% used
              </div>
              <div style="font-size: 12px; color: #9ca3af;">
                <i class="fas fa-signal" style="margin-right: 6px;"></i>
                Signal: ${isConnected ? Math.floor(Math.random() * 30) + 70 : 0}%
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add CSS animation for spinner
      const style = document.createElement('style');
      style.textContent = `
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(modal);
    }

    // Modal closing function
    function closeVehicleModal(modalType) {
      const modal = document.querySelector(`[data-modal-type="${modalType}"]`);
      if (modal) {
        modal.remove();
      }
    }

    // Camera control functions
    function toggleCameraRecording(vehicleId, cameraId) {
      showToast(`Starting recording on ${cameraId} camera for ${vehicleId}...`, 'info');
      
      setTimeout(() => {
        showToast(`Recording started on ${cameraId} camera`, 'success');
      }, 1000);
    }

    function takeCameraSnapshot(vehicleId, cameraId) {
      showToast(`Taking snapshot from ${cameraId} camera...`, 'info');
      
      setTimeout(() => {
        showToast(`Snapshot saved from ${vehicleId} ${cameraId} camera`, 'success');
      }, 800);
    }

    function refreshAllCameras(vehicleId) {
      showToast(`Refreshing all cameras for ${vehicleId}...`, 'info');
      
      setTimeout(() => {
        showToast(`All cameras refreshed successfully`, 'success');
        // Close and reopen modal to simulate refresh
        closeVehicleModal('camera');
        setTimeout(() => showVehicleCameraModal(vehicleId), 500);
      }, 1500);
    }

    function downloadCameraFootage(vehicleId) {
      showToast(`Preparing camera footage download for ${vehicleId}...`, 'info');
      
      setTimeout(() => {
        showToast(`Camera footage download initiated`, 'success');
      }, 2000);
    }

    function enableNightVision(vehicleId) {
      showToast(`Enabling night vision mode for ${vehicleId}...`, 'info');
      
      setTimeout(() => {
        showToast(`Night vision mode enabled`, 'success');
      }, 1000);
    }

    function viewVehicleOnMap(vehicle) {
      showToast(`Centering map on ${vehicle.id}`, 'info');
      // TODO: Implement map centering functionality
      // This should center the map on the vehicle's current location
      if (window.map && window.vehicles) {
        const vehicleMarker = window.vehicles.find(v => v.id === vehicle.id);
        if (vehicleMarker && vehicleMarker.lat && vehicleMarker.lng) {
          window.map.setView([vehicleMarker.lat, vehicleMarker.lng], 15);
        }
      }
    }

    function viewVehicleLogs(vehicle) {
      showToast(`Opening logs for ${vehicle.id}`, 'info');
      
      // Create logs modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto mx-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Vehicle Logs - ${vehicle.id}</h3>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Recent Activity</h4>
              <div class="space-y-2 text-sm">
                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded">Status: ${vehicle.status}</div>
                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded">Last Update: ${vehicle.lastPing}</div>
                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded">Current Speed: ${vehicle.route?.currentSpeed || 'N/A'} km/h</div>
                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded">Driver Score: ${vehicle.driverBehavior?.score || 'N/A'}/100</div>
              </div>
            </div>
            
            <div>
              <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Vehicle Health</h4>
              <div class="space-y-2 text-sm">
                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded">Fuel: ${vehicle.health?.fuel || 'N/A'}%</div>
                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded">Mileage: ${vehicle.health?.mileage || 'N/A'} km</div>
                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded">Maintenance Risk: ${vehicle.health?.maintenanceRisk || 'Low'}</div>
                <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded">Alerts: ${vehicle.alerts?.length || 0}</div>
              </div>
            </div>
          </div>
          
          <div class="mt-4 flex justify-end">
            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function sendMessageToDriver(vehicle) {
      showToast(`Opening message interface for ${vehicle.driver}`, 'info');
      // Create a simple message modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 max-w-full mx-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Send Message to ${vehicle.driver}</h3>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vehicle: ${vehicle.id}</label>
            <select class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white">
              <option>Return to Base</option>
              <option>Speed Warning</option>
              <option>Route Change</option>
              <option>Break Time</option>
              <option>Custom Message</option>
            </select>
          </div>
          <div class="mb-4">
            <textarea class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 h-24 dark:bg-gray-700 dark:text-white" placeholder="Type your message here..."></textarea>
          </div>
          <div class="flex gap-2 justify-end">
            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400">Cancel</button>
            <button onclick="alert('Message sent to ${vehicle.driver}!'); this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Send</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function scheduleMaintenanceForVehicle(vehicle) {
      showToast(`Scheduling maintenance for ${vehicle.id}`, 'info');
      // Create a maintenance scheduling modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 max-w-full mx-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Schedule Maintenance: ${vehicle.id}</h3>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Maintenance Type</label>
            <select class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white">
              <option>Oil Change</option>
              <option>Tire Replacement</option>
              <option>Engine Check</option>
              <option>Brake Inspection</option>
              <option>Full Service</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Scheduled Date</label>
            <input type="date" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white">
          </div>
          <div class="flex gap-2 justify-end">
            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400">Cancel</button>
            <button onclick="alert('Maintenance scheduled for ${vehicle.id}!'); this.closest('.fixed').remove()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Schedule</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function assignDriverToVehicle(vehicle) {
      showToast(`Assigning driver to ${vehicle.id}`, 'info');
      // Create a driver assignment modal
      const drivers = ['Ahmed Ali', 'Sara Hassan', 'Omar Khalil', 'Fatima Ahmad', 'Mohammed Saeed', 'Layla Ibrahim', 'Yusuf Rahman'];
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 max-w-full mx-4">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Assign Driver: ${vehicle.id}</h3>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Driver: ${vehicle.driver}</label>
            <select class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white">
              ${drivers.map(driver => `<option value="${driver}" ${driver === vehicle.driver ? 'selected' : ''}>${driver}</option>`).join('')}
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Effective Date</label>
            <input type="date" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white" value="${new Date().toISOString().split('T')[0]}">
          </div>
          <div class="flex gap-2 justify-end">
            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400">Cancel</button>
            <button onclick="alert('Driver assigned to ${vehicle.id}!'); this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Assign</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }


    function issueWarningToDriver(vehicle) {
      showToast(`Issuing warning to ${vehicle.driver}`, 'warning');
      // Create a warning modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 max-w-full mx-4">
          <h3 class="text-lg font-semibold text-red-600 mb-4">⚠️ Issue Warning to ${vehicle.driver}</h3>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vehicle: ${vehicle.id}</label>
            <select class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white">
              <option>Speeding Violation</option>
              <option>Harsh Braking</option>
              <option>Harsh Acceleration</option>
              <option>Unauthorized Route</option>
              <option>Extended Idle Time</option>
              <option>Geofence Violation</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Severity</label>
            <select class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 dark:text-white">
              <option value="low" class="text-yellow-600">Low - Verbal Warning</option>
              <option value="medium" class="text-orange-600">Medium - Written Warning</option>
              <option value="high" class="text-red-600">High - Disciplinary Action</option>
            </select>
          </div>
          <div class="mb-4">
            <textarea class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 h-20 dark:bg-gray-700 dark:text-white" placeholder="Additional notes..."></textarea>
          </div>
          <div class="flex gap-2 justify-end">
            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400">Cancel</button>
            <button onclick="alert('Warning issued to ${vehicle.driver}!'); this.closest('.fixed').remove()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Issue Warning</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function setGeofenceForDriver(vehicle) {
      console.log('Setting geofence for driver:', vehicle.driver, 'vehicle:', vehicle.id);
      
      // Center the map on the vehicle location first
      centerMapOnVehicle(vehicle);
      
      // Show driver-specific geofence modal
      showDriverGeofenceModal(vehicle);
    }
    window.onclick = function(event) {
      const vehicleModal = document.getElementById('vehicle-modal');
      const filterModal = document.getElementById('filter-modal');
      const geofenceModal = document.getElementById('geofence-modal');
      const createGroupModal = document.getElementById('create-group-modal');
      
      if (event.target === vehicleModal) vehicleModal.classList.add('hidden');
      if (event.target === filterModal) filterModal.classList.add('hidden');
      if (event.target === geofenceModal) {
        geofenceModal.classList.add('hidden');
        // Clear temporary elements when clicking outside
        if (tempGeofenceCircle) {
          map.removeLayer(tempGeofenceCircle);
          tempGeofenceCircle = null;
        }
      }
      if (event.target === createGroupModal) createGroupModal.classList.add('hidden');
    };

    // Utilization Chart (Fleet)
    let utilizationChart;
    function renderUtilizationChart() {
      const ctx = document.getElementById('utilization-chart').getContext('2d');
      const data = Array(7).fill(0);
      
      vehicles.forEach(v => {
        if (v.utilization) {
          if (Array.isArray(v.utilization)) {
            // If utilization is an array, add each day's value
            v.utilization.forEach((u, i) => {
              if (i < 7) data[i] += u;
            });
          } else if (typeof v.utilization === 'number') {
            // If utilization is a single number, distribute it evenly across days
            const dailyUtilization = Math.floor(v.utilization / 7);
            for (let i = 0; i < 7; i++) {
              data[i] += dailyUtilization;
            }
          }
        }
      });
      
      if (utilizationChart) utilizationChart.destroy();
      utilizationChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
          datasets: [{
            label: 'Total Hours Used',
            data,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37,99,235,0.1)',
            fill: true
          }]
        },
        options: { plugins: { legend: { display: false } } }
      });
    }

    // Map with Geofence (Enhanced)
    let map, markers = [], polylines = [], geofenceCircle = null, tempGeofenceCircle = null;
    let lastRenderedVehicles = new Set();
    let isGeofenceMode = false;
    let geofenceMarker = null;
    let mapReady = false;
    
    // Enhanced geofence variables for polygon support
    let geofencePolygon = null;
    let tempGeofencePolygon = null;
    let geofencePoints = [];
    let isDrawingPolygon = false;
    let geofenceType = 'circle'; // 'circle' or 'polygon'
    
    // Helper function to check if map is ready
    function isMapReady() {
      return (map && mapReady) || window.vehiclesPageMap;
    }

    // Initialize fleet map widget for vehicles page
    async function initializeVehiclesPageMap(vehiclesToShow) {
      try {
        console.log('🗺️ initializeVehiclesPageMap called with', vehiclesToShow ? vehiclesToShow.length : 0, 'vehicles');
        console.log('🗺️ FleetMapWidget type:', typeof FleetMapWidget);
        console.log('🗺️ Map container element:', document.getElementById('map'));
        
        // Create map widget instance
        if (typeof FleetMapWidget !== 'undefined') {
          window.vehiclesPageMap = new FleetMapWidget('map', {
            defaultCenter: [31.9539, 35.9106], // Jordan coordinates
            defaultZoom: 11,
            mapHeight: '450px' // Match the container height exactly
          });

          // Initialize the map
          const success = await window.vehiclesPageMap.init();
          
          if (success) {
            console.log('Vehicles page map widget initialized successfully');
            
            // Force immediate data synchronization with unified fleet data
            if (typeof window.UnifiedFleetData !== 'undefined') {
              const unifiedVehicles = window.UnifiedFleetData.getVehiclesForDashboard(); // ALL 200 vehicles
              window.vehiclesPageMap.vehicleData = unifiedVehicles;
              window.vehiclesPageMap.updateVehicles();
              console.log('Forced sync with unified fleet data on vehicles page map initialization - FULL DATASET:', unifiedVehicles.length, 'vehicles');
            } else {
              // Fallback sync
              syncVehicleDataToMap(vehiclesToShow);
            }
            
            // Force update statistics after data sync
            setTimeout(() => {
              if (window.vehiclesPageMap) {
                window.vehiclesPageMap.updateStatistics();
                console.log('Updated vehicles page map statistics');
              }
              // Update our custom map statistics display
              updateVehiclesMapStatistics();
            }, 100);
            
            // Update map when vehicles data changes
            mapReady = true;
            window.map = window.vehiclesPageMap.map; // For compatibility with existing code
            
            // Expose globally for other functions
            window.vehiclesFleetMap = window.vehiclesPageMap;
            
            return;
          }
        }
        
        throw new Error('FleetMapWidget not available');
        
      } catch (error) {
        console.error('Failed to initialize vehicles page map widget:', error);
        throw error;
      }
    }

    // Sync vehicle data from vehicles page to map widget
    function syncVehicleDataToMap(vehiclesToShow) {
      if (!window.vehiclesPageMap) return;
      
      try {
        // Use unified fleet data for perfect synchronization
        if (typeof window.UnifiedFleetData !== 'undefined') {
          // Get ALL vehicles that the main dashboard uses (same 200 vehicles)
          const unifiedVehicles = window.UnifiedFleetData.getVehiclesForDashboard();
          window.vehiclesPageMap.vehicleData = unifiedVehicles;
          window.vehiclesPageMap.updateVehicles();
          
          // Force update statistics with proper delay
          setTimeout(() => {
            window.vehiclesPageMap.updateStatistics();
            // Update our custom map statistics display
            updateVehiclesMapStatistics();
          }, 50);
          
          console.log(`Synced ${unifiedVehicles.length} vehicles from unified fleet data to vehicles page map (FULL DATASET)`);
          return;
        }
        
        // Fallback: If main dashboard map widget exists, use its data directly for consistency
        if (window.fleetMap && window.fleetMap.vehicleData && window.fleetMap.vehicleData.length > 0) {
          // Use ALL the same vehicle data as main dashboard (all 200 vehicles)
          const dashboardVehicles = window.fleetMap.vehicleData;
          window.vehiclesPageMap.vehicleData = dashboardVehicles;
          window.vehiclesPageMap.updateVehicles();
          
          // Force update statistics with proper delay
          setTimeout(() => {
            window.vehiclesPageMap.updateStatistics();
            // Update our custom map statistics display
            updateVehiclesMapStatistics();
          }, 50);
          
          console.log(`Synced ${dashboardVehicles.length} vehicles from main dashboard to vehicles page map (FULL DATASET)`);
          return;
        }

        // Fallback: convert vehicles page data to map widget format
        if (!vehiclesToShow) return;
        
        const mapVehicles = vehiclesToShow.map((vehicle, index) => ({
          id: vehicle.id.replace('VEH-', 'FL-'), // Convert to fleet ID format
          vehicleId: vehicle.id,
          name: `${vehicle.manufacturer} ${vehicle.model}`,
          driver: vehicle.driver,
          driverId: vehicle.driverId,
          status: mapVehicleStatus(vehicle.status),
          location: [vehicle.lat, vehicle.lng],
          speed: vehicle.route ? vehicle.route.currentSpeed : Math.floor(Math.random() * 60) + 20,
          heading: Math.floor(Math.random() * 360),
          fuel: vehicle.health.fuel,
          lastUpdate: new Date(),
          route: vehicle.route ? vehicle.route.distance + ' km remaining' : 'Available',
          locked: false,
          manufacturer: vehicle.manufacturer,
          model: vehicle.model,
          plateNumber: vehicle.plateNumber,
          year: vehicle.year,
          mileage: vehicle.health.mileage,
          maintenanceRisk: vehicle.health.maintenanceRisk
        }));

        // Update map widget with vehicles data
        window.vehiclesPageMap.vehicleData = mapVehicles;
        window.vehiclesPageMap.updateVehicles();
        
        // Force update statistics with proper delay
        setTimeout(() => {
          window.vehiclesPageMap.updateStatistics();
          // Update our custom map statistics display
          updateVehiclesMapStatistics();
        }, 50);
        
        console.log(`Synced ${mapVehicles.length} vehicles to map widget`);
        
      } catch (error) {
        console.error('Error syncing vehicle data to map:', error);
      }
    }

    // Map vehicle status from vehicles page to map widget format
    function mapVehicleStatus(status) {
      const statusMap = {
        'Driving': 'active',
        'Idling': 'idle', 
        'Parked': 'idle',
        'Maintenance': 'offline',
        'Offline': 'offline',
        'Alert': 'offline'
      };
      return statusMap[status] || 'idle';
    }

    // Global function to sync vehicles data with main dashboard
    window.syncVehiclesPageWithDashboard = function() {
      if (window.vehiclesPageMap) {
        try {
          // Use unified fleet data system for perfect synchronization
          if (typeof window.UnifiedFleetData !== 'undefined') {
            // Get the latest data from unified system (ALL 200 vehicles)
            const unifiedVehicles = window.UnifiedFleetData.getVehiclesForDashboard();
            
            // Update vehicles page map widget
            window.vehiclesPageMap.vehicleData = unifiedVehicles;
            window.vehiclesPageMap.updateVehicles();
            
            // Force update statistics
            setTimeout(() => {
              window.vehiclesPageMap.updateStatistics();
              // Update our custom map statistics display
              updateVehiclesMapStatistics();
            }, 50);
            
            console.log(`Synced ${unifiedVehicles.length} vehicles from unified fleet data to vehicles page (FULL DATASET)`);
            return;
          }
          
          // Fallback: sync with main dashboard map widget
          if (window.fleetMap && window.fleetMap.vehicleData) {
            // Get vehicle data from main dashboard map widget
            const dashboardVehicles = window.fleetMap.vehicleData;
            
            // Update vehicles page map with dashboard data
            if (dashboardVehicles && dashboardVehicles.length > 0) {
              const syncedVehicles = dashboardVehicles; // Take ALL vehicles
              
              // Update vehicles page map widget
              window.vehiclesPageMap.vehicleData = syncedVehicles;
              window.vehiclesPageMap.updateVehicles();
              
              // Force update statistics
              setTimeout(() => {
                window.vehiclesPageMap.updateStatistics();
              }, 50);
              
              console.log(`Synced ${syncedVehicles.length} vehicles from dashboard to vehicles page (FULL DATASET)`);
            }
          }
        } catch (error) {
          console.error('Error syncing vehicles data:', error);
        }
      }
    };

    // Auto-sync with unified data system every 30 seconds
    setInterval(() => {
      if (window.vehiclesPageMap && (window.UnifiedFleetData || window.fleetMap)) {
        window.syncVehiclesPageWithDashboard();
        
        // Verify data synchronization
        if (window.fleetMap && window.vehiclesPageMap && window.UnifiedFleetData) {
          const dashboardData = window.fleetMap.vehicleData;
          const vehiclesPageData = window.vehiclesPageMap.vehicleData;
          
          console.log('=== MAP WIDGET SYNCHRONIZATION VERIFICATION ===');
          console.log('Dashboard map vehicles:', dashboardData.length);
          console.log('Vehicles page map vehicles:', vehiclesPageData.length);
          
          if (dashboardData.length > 0 && vehiclesPageData.length > 0) {
            // Calculate statistics for both
            const dashboardStats = dashboardData.reduce((acc, v) => { acc[v.status] = (acc[v.status] || 0) + 1; return acc; }, {});
            const vehiclesPageStats = vehiclesPageData.reduce((acc, v) => { acc[v.status] = (acc[v.status] || 0) + 1; return acc; }, {});
            
            console.log('Dashboard statistics:', dashboardStats);
            console.log('Vehicles page statistics:', vehiclesPageStats);
            
            const statsMatch = JSON.stringify(dashboardStats) === JSON.stringify(vehiclesPageStats);
            console.log('Statistics match:', statsMatch ? '✅ YES' : '❌ NO');
            
            if (!statsMatch) {
              console.warn('Statistics mismatch detected! Check data synchronization.');
            }
          }
          console.log('=== END VERIFICATION ===');
        }
      }
    }, 30000);
    
    function renderMap(vehiclesToShow) {
      console.log('🗺️ renderMap called (DISABLED - using OpenLayers map instead)');
      console.log('🗺️ Vehicle count:', vehiclesToShow ? vehiclesToShow.length : 0);
      return; // Disabled - using OpenLayers map instead
      
      if (!window.vehiclesPageMap && !map) {
        try {
          console.log('🗺️ Initializing fleet map widget for vehicles page...');
          // Initialize the fleet map widget for vehicles page
          initializeVehiclesPageMap(vehiclesToShow);
          return;
        } catch (error) {
          console.error('🗺️ Failed to initialize fleet map widget, falling back to basic map:', error);
          // Fallback to basic Leaflet map
          map = L.map('map').setView([31.9539, 35.9106], 11); // Jordan coordinates
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(map);
        }
      } else if (window.vehiclesPageMap) {
        // Map widget exists, just update the vehicle data
        syncVehicleDataToMap(vehiclesToShow);
        return;
      }
      
      // Fallback map setup (for basic Leaflet map)
      if (map) {
          // Add map click handler for geofence placement
          map.on('click', function(e) {
            console.log('Map clicked:', e.latlng, 'Geofence mode:', isGeofenceMode, 'Type:', geofenceType);
            if (isGeofenceMode) {
              console.log('Processing geofence click for type:', geofenceType);
              if (geofenceType === 'circle') {
                setGeofenceFromMap(e.latlng.lat, e.latlng.lng);
              } else if (geofenceType === 'polygon') {
                addPolygonPoint(e.latlng.lat, e.latlng.lng);
              }
            } else {
              console.log('Map clicked but not in geofence mode');
            }
          });
          
          // Add double-click handler to finish polygon drawing
          map.on('dblclick', function(e) {
            if (isGeofenceMode && geofenceType === 'polygon' && geofencePoints.length >= 3) {
              finishPolygonDrawing();
            }
          });
          
          // Add map ready event
          map.whenReady(() => {
            console.log('Map is ready');
            mapReady = true;
            showToast('Map loaded successfully', 'success');
          });
      }
      
      // Create a set of current vehicle IDs for comparison
      const currentVehicleIds = new Set(vehiclesToShow.map(v => v.id));
      
      // Remove markers for vehicles no longer in the list
      markers = markers.filter(marker => {
        const vehicleId = marker.vehicleId;
        if (!currentVehicleIds.has(vehicleId)) {
          map.removeLayer(marker);
          return false;
        }
        return true;
      });
      
      // Remove polylines for vehicles no longer driving
      polylines.forEach(p => map.removeLayer(p));
      polylines = [];
      
      vehiclesToShow.forEach(vehicle => {
        // Check if marker already exists for this vehicle
        let existingMarker = markers.find(m => m.vehicleId === vehicle.id);
        
        // Color coding for vehicle status
        let markerColor = '#2563eb'; // default blue
        switch(vehicle.status) {
          case 'Driving': markerColor = '#16a34a'; break; // green
          case 'Alert': markerColor = '#dc2626'; break; // red
          case 'Maintenance': markerColor = '#f59e0b'; break; // yellow
          case 'Offline': markerColor = '#6b7280'; break; // gray
        }
        
        if (existingMarker) {
          // Update existing marker position and popup
          existingMarker.setLatLng([vehicle.lat, vehicle.lng]);
          existingMarker.setPopupContent(`
            <div class="p-2">
              <div class="font-bold text-lg">${vehicle.id}</div>
              <div class="text-sm text-gray-600">Driver: ${vehicle.driver}</div>
              <div class="text-sm">Status: <span class="font-medium" style="color: ${markerColor}">${vehicle.status}</span></div>
              <div class="text-sm">Fuel: ${vehicle.health.fuel}%</div>
              <div class="text-sm">ETA: ${vehicle.route.eta}</div>
              ${vehicle.alerts.length > 0 ? `<div class="text-xs text-red-600 mt-1">⚠️ ${vehicle.alerts.join(', ')}</div>` : ''}
            </div>
          `);
        } else {
          // Create custom icon with color
          const customIcon = L.divIcon({
            className: 'custom-vehicle-marker',
            html: `<div style="background-color: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          });
          
          const marker = L.marker([vehicle.lat, vehicle.lng], { icon: customIcon })
            .bindPopup(`
              <div class="p-2">
                <div class="font-bold text-lg">${vehicle.id}</div>
                <div class="text-sm text-gray-600">Driver: ${vehicle.driver}</div>
                <div class="text-sm">Status: <span class="font-medium" style="color: ${markerColor}">${vehicle.status}</span></div>
                <div class="text-sm">Fuel: ${vehicle.health.fuel}%</div>
                <div class="text-sm">ETA: ${vehicle.route.eta}</div>
                ${vehicle.alerts.length > 0 ? `<div class="text-xs text-red-600 mt-1">⚠️ ${vehicle.alerts.join(', ')}</div>` : ''}
              </div>
            `);
          marker.vehicleId = vehicle.id;
          marker.addTo(map);
          markers.push(marker);
        }
        
        if (vehicle.status === 'Driving') {
          const route = [
            [vehicle.lat, vehicle.lng],
            [vehicle.lat + (Math.random() - 0.5) * 0.02, vehicle.lng + (Math.random() - 0.5) * 0.02]
          ];
          const polyline = L.polyline(route, { 
            color: vehicle.route.trafficDelay > 15 ? '#DC2626' : '#2563eb',
            weight: 3,
            opacity: 0.7
          }).addTo(map);
          polylines.push(polyline);
        }
        
        // Enhanced geofence violation detection
        if (geofence && vehicle.status === 'Driving') {
          try {
            let isInside = false;
            const wasInside = vehicle.wasInsideGeofence || false;
            
            if (geofence.type === 'circle') {
              const distance = map.distance([vehicle.lat, vehicle.lng], [geofence.lat, geofence.lng]) / 1000;
              isInside = distance <= geofence.radius;
            } else if (geofence.type === 'polygon') {
              // Polygon geofence check using ray casting algorithm
              const points = geofence.points;
              const lat = vehicle.lat;
              const lng = vehicle.lng;
              
              for (let i = 0, j = points.length - 1; i < points.length; j = i++) {
                const xi = points[i][0], yi = points[i][1];
                const xj = points[j][0], yj = points[j][1];
                
                if (((yi > lng) !== (yj > lng)) && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi)) {
                  isInside = !isInside;
                }
              }
            }
            
            // Check for entry/exit events
            if (!wasInside && isInside && geofence.entryAlert) {
              // Vehicle entered geofence
              if (!vehicle.alerts.includes('Entered Geofence')) {
                vehicle.alerts.push('Entered Geofence');
                addAlert(vehicle.id, vehicle.group, 'Entered Geofence', 'Info');
              }
            } else if (wasInside && !isInside && geofence.exitAlert) {
              // Vehicle exited geofence
              if (!vehicle.alerts.includes('Exited Geofence')) {
                vehicle.alerts.push('Exited Geofence');
                addAlert(vehicle.id, vehicle.group, 'Exited Geofence', 'Warning');
              }
            }
            
            vehicle.wasInsideGeofence = isInside;
            
          } catch (error) {
            console.warn('Error calculating geofence distance:', error);
          }
        }
      });
      
      // Update geofence circle
      updateGeofenceDisplay();
      
      lastRenderedVehicles = currentVehicleIds;
    }
    
    function setGeofenceFromMap(lat, lng) {
      // Update form values
      document.getElementById('geofence-lat').value = lat.toFixed(6);
      document.getElementById('geofence-lng').value = lng.toFixed(6);
      
      // Place or update geofence marker
      if (geofenceMarker) {
        map.removeLayer(geofenceMarker);
      }
      
      geofenceMarker = L.marker([lat, lng], {
        icon: L.divIcon({
          className: 'geofence-center-marker',
          html: '<div style="background-color: #8b5cf6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(139,92,246,0.5);"></div>',
          iconSize: [22, 22],
          iconAnchor: [11, 11]
        })
      }).bindPopup(`
        <div class="p-2">
          <div class="font-bold text-sm">Geofence Center</div>
          <div class="text-xs">Lat: ${lat.toFixed(6)}</div>
          <div class="text-xs">Lng: ${lng.toFixed(6)}</div>
        </div>
      `).addTo(map);
      
      // Update preview circle with current radius
      const radius = parseFloat(document.getElementById('geofence-radius').value) || 5;
      updateGeofencePreview(lat, lng, radius);
      
      // Exit geofence drawing mode
      isGeofenceMode = false;
      const btn = document.getElementById('geofence-btn');
      btn.innerHTML = '<i class="fas fa-draw-polygon mr-2"></i>Draw Geofence';
      btn.className = 'px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center text-sm';
      document.getElementById('geofence-status').classList.add('hidden');
      map.getContainer().style.cursor = '';
      
      // Auto-open settings modal for configuration
      document.getElementById('geofence-modal').classList.remove('hidden');
      
      showToast('Geofence center set! Configure settings and click Apply.', 'success');
    }
    
    // Polygon drawing functions
    function addPolygonPoint(lat, lng) {
      geofencePoints.push([lat, lng]);
      
      // Add point marker
      const pointMarker = L.marker([lat, lng], {
        icon: L.divIcon({
          className: 'polygon-point-marker',
          html: `<div style="background-color: #8b5cf6; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(139,92,246,0.5);"><span style="color: white; font-size: 8px; font-weight: bold; position: absolute; top: -2px; left: 2px;">${geofencePoints.length}</span></div>`,
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        })
      }).bindPopup(`
        <div class="p-1">
          <div class="font-bold text-xs">Point ${geofencePoints.length}</div>
          <div class="text-xs">Lat: ${lat.toFixed(6)}</div>
          <div class="text-xs">Lng: ${lng.toFixed(6)}</div>
        </div>
      `).addTo(map);
      
      // Store marker reference for cleanup
      if (!window.polygonMarkers) window.polygonMarkers = [];
      window.polygonMarkers.push(pointMarker);
      
      // Update preview polygon
      updatePolygonPreview();
      
      // Update status
      const statusDiv = document.getElementById('geofence-status');
      if (geofencePoints.length < 3) {
        statusDiv.innerHTML = `<i class="fas fa-mouse-pointer mr-2"></i>Point ${geofencePoints.length} added. Need ${3 - geofencePoints.length} more points minimum. Double-click to finish.`;
      } else {
        statusDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${geofencePoints.length} points added. Double-click to finish drawing.`;
      }
      
      showToast(`Point ${geofencePoints.length} added. ${geofencePoints.length < 3 ? `Need ${3 - geofencePoints.length} more.` : 'Double-click to finish.'}`, 'info');
    }
    
    function updatePolygonPreview() {
      if (geofencePoints.length < 2) return;
      
      // Remove existing preview
      if (tempGeofencePolygon) {
        map.removeLayer(tempGeofencePolygon);
        tempGeofencePolygon = null;
      }
      
      // Create preview polygon (line for 2 points, polygon for 3+)
      if (geofencePoints.length === 2) {
        tempGeofencePolygon = L.polyline(geofencePoints, {
          color: '#8b5cf6',
          weight: 3,
          dashArray: '5, 5',
          opacity: 0.8
        }).addTo(map);
      } else {
        tempGeofencePolygon = L.polygon(geofencePoints, {
          color: '#8b5cf6',
          fillColor: '#8b5cf6',
          fillOpacity: 0.2,
          weight: 3,
          dashArray: '5, 5'
        }).addTo(map);
        
        // Calculate and display area
        const area = calculatePolygonArea(geofencePoints);
        tempGeofencePolygon.bindPopup(`
          <div class="p-2">
            <div class="font-bold text-sm">Polygon Preview</div>
            <div class="text-xs">${geofencePoints.length} points</div>
            <div class="text-xs">Area: ${area.toFixed(2)} km²</div>
          </div>
        `);
      }
    }
    
    function calculatePolygonArea(points) {
      if (points.length < 3) return 0;
      
      // Calculate area using the shoelace formula
      let area = 0;
      const n = points.length;
      
      for (let i = 0; i < n; i++) {
        const j = (i + 1) % n;
        area += points[i][0] * points[j][1];
        area -= points[j][0] * points[i][1];
      }
      
      area = Math.abs(area) / 2;
      
      // Convert from square degrees to square kilometers (rough approximation)
      // 1 degree latitude ≈ 111 km, 1 degree longitude ≈ 111 * cos(latitude) km
      const avgLat = points.reduce((sum, p) => sum + p[0], 0) / points.length;
      const latToKm = 111;
      const lngToKm = 111 * Math.cos(avgLat * Math.PI / 180);
      
      return area * latToKm * lngToKm;
    }
    
    function finishPolygonDrawing() {
      if (geofencePoints.length < 3) {
        showToast('Need at least 3 points to create a polygon', 'error');
        return;
      }
      
      // Clear preview
      if (tempGeofencePolygon) {
        map.removeLayer(tempGeofencePolygon);
        tempGeofencePolygon = null;
      }
      
      // Exit drawing mode
      isGeofenceMode = false;
      const btn = document.getElementById('geofence-btn');
      btn.innerHTML = '<i class="fas fa-draw-polygon mr-2"></i>Draw Geofence';
      btn.className = 'px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center text-sm';
      document.getElementById('geofence-status').classList.add('hidden');
      map.getContainer().style.cursor = '';
      
      // Calculate polygon center for form
      const centerLat = geofencePoints.reduce((sum, p) => sum + p[0], 0) / geofencePoints.length;
      const centerLng = geofencePoints.reduce((sum, p) => sum + p[1], 0) / geofencePoints.length;
      
      // Update form with polygon data
      document.getElementById('geofence-lat').value = centerLat.toFixed(6);
      document.getElementById('geofence-lng').value = centerLng.toFixed(6);
      
      // Hide radius controls for polygon
      const radiusControls = document.querySelectorAll('[id*="radius"], [for*="radius"]');
      radiusControls.forEach(el => {
        if (el.closest('.mb-4')) el.closest('.mb-4').style.display = 'none';
      });
      
      // Show polygon info
      const area = calculatePolygonArea(geofencePoints);
      const areaElement = document.getElementById('geofence-area');
      if (areaElement) {
        areaElement.textContent = area.toFixed(2);
        areaElement.parentElement.innerHTML = `Area: <span id="geofence-area">${area.toFixed(2)}</span> km² (${geofencePoints.length} points)`;
      }
      
      // Auto-open settings modal
      document.getElementById('geofence-modal').classList.remove('hidden');
      
      showToast(`Polygon with ${geofencePoints.length} points created! Configure settings and apply.`, 'success');
    }
    
    function clearPolygonPoints() {
      geofencePoints = [];
      
      // Clear polygon markers
      if (window.polygonMarkers) {
        window.polygonMarkers.forEach(marker => map.removeLayer(marker));
        window.polygonMarkers = [];
      }
      
      // Clear preview
      if (tempGeofencePolygon) {
        map.removeLayer(tempGeofencePolygon);
        tempGeofencePolygon = null;
      }
    }
    
    function updateGeofencePreview(lat, lng, radius) {
      if (!map) return;
      
      // Validate inputs
      if (isNaN(lat) || isNaN(lng) || isNaN(radius) || radius <= 0) {
        console.warn('Invalid geofence parameters:', { lat, lng, radius });
        return;
      }
      
      // Remove existing preview circle
      if (tempGeofenceCircle) {
        map.removeLayer(tempGeofenceCircle);
        tempGeofenceCircle = null;
      }
      
      // Create new preview circle
      try {
        tempGeofenceCircle = L.circle([lat, lng], {
          radius: radius * 1000, // Convert km to meters
          color: '#8b5cf6',
          fillColor: '#8b5cf6',
          fillOpacity: 0.2,
          weight: 2,
          dashArray: '5, 5'
        }).addTo(map);
        
        // Update area calculation
        const area = Math.PI * radius * radius;
        const areaElement = document.getElementById('geofence-area');
        if (areaElement) {
          areaElement.textContent = area.toFixed(2);
        }
        
        // Add popup to preview circle
        tempGeofenceCircle.bindPopup(`
          <div class="p-2">
            <div class="font-bold text-sm">Geofence Preview</div>
            <div class="text-xs">Radius: ${radius} km</div>
            <div class="text-xs">Area: ${area.toFixed(2)} km²</div>
          </div>
        `);
        
      } catch (error) {
        console.error('Error creating geofence preview:', error);
        showToast('Error creating geofence preview', 'error');
      }
    }
    
    function updateGeofenceDisplay() {
      if (geofence) {
        // Clear existing geofence displays
        if (geofenceCircle) {
          map.removeLayer(geofenceCircle);
          geofenceCircle = null;
        }
        if (geofencePolygon) {
          map.removeLayer(geofencePolygon);
          geofencePolygon = null;
        }
        if (geofenceMarker) {
          map.removeLayer(geofenceMarker);
          geofenceMarker = null;
        }
        
        if (geofence.type === 'polygon' && geofence.points) {
          // Create polygon geofence
          geofencePolygon = L.polygon(geofence.points, {
            color: '#dc2626',
            fillColor: '#dc2626',
            fillOpacity: 0.15,
            weight: 3
          }).addTo(map);
          
          // Add center marker for polygon
          geofenceMarker = L.marker([geofence.lat, geofence.lng], {
            icon: L.divIcon({
              className: 'geofence-center-marker',
              html: '<div style="background-color: #dc2626; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(220,38,38,0.5);"></div>',
              iconSize: [22, 22],
              iconAnchor: [11, 11]
            })
          }).bindPopup(`
            <div class="p-2">
              <div class="font-bold">Geofence: ${geofence.name || 'Unnamed'}</div>
              <div class="text-sm">Type: Polygon (${geofence.points.length} points)</div>
              <div class="text-sm">Area: ${geofence.area ? geofence.area.toFixed(2) : 'N/A'} km²</div>
            </div>
          `).addTo(map);
          
        } else {
          // Create circle geofence (default)
          geofenceCircle = L.circle([geofence.lat, geofence.lng], {
            radius: geofence.radius * 1000,
            color: '#dc2626',
            fillColor: '#dc2626',
            fillOpacity: 0.15,
            weight: 3
          }).addTo(map);
          
          // Add geofence center marker
          geofenceMarker = L.marker([geofence.lat, geofence.lng], {
            icon: L.divIcon({
              className: 'geofence-center-marker',
              html: '<div style="background-color: #dc2626; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(220,38,38,0.5);"></div>',
              iconSize: [22, 22],
              iconAnchor: [11, 11]
            })
          }).bindPopup(`
            <div class="p-2">
              <div class="font-bold">Geofence: ${geofence.name || 'Unnamed'}</div>
              <div class="text-sm">Radius: ${geofence.radius} km</div>
              <div class="text-sm">Area: ${(Math.PI * geofence.radius * geofence.radius).toFixed(2)} km²</div>
            </div>
          `).addTo(map);
        }
        
        // Show clear button
        document.getElementById('clear-geofence-btn').classList.remove('hidden');
      } else {
        // Hide clear button
        document.getElementById('clear-geofence-btn').classList.add('hidden');
      }
    }
    

    // Enhanced Toast Notifications with Priority System
    function showToast(message, type = 'info', priority = 'normal') {
      const toast = document.createElement('div');
      
      let bgColor, icon;
      switch(type) {
        case 'success':
          bgColor = 'bg-green-600';
          icon = 'fa-check-circle';
          break;
        case 'error':
          bgColor = 'bg-red-600';
          icon = 'fa-exclamation-circle';
          break;
        case 'warning':
          bgColor = 'bg-yellow-600';
          icon = 'fa-exclamation-triangle';
          break;
        case 'critical':
          bgColor = 'bg-red-800';
          icon = 'fa-exclamation-triangle';
          break;
        default:
          bgColor = 'bg-blue-600';
          icon = 'fa-info-circle';
      }
      
      const priorityClass = priority === 'high' ? 'z-60 animate-pulse' : 'z-50';
      const duration = priority === 'high' ? 10000 : 5000;
      
      toast.className = `alert-toast ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg fixed top-20 right-6 ${priorityClass} flex items-center gap-3 max-w-sm`;
      toast.innerHTML = `
        <i class="fas ${icon}"></i>
        <span>${message}</span>
        <button class="ml-2 text-white hover:text-gray-200" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      document.body.appendChild(toast);
      
      // Auto remove
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => {
            toast.remove();
          }, 300);
        }
      }, duration);
    }

    // Real-time Alert System
    function checkCriticalAlerts() {
      vehicles.forEach(vehicle => {
        // Speed limit violations
        if (vehicle.route.currentSpeed > vehicle.route.speedLimit && vehicle.status === 'Driving') {
          if (!vehicle.alerts.includes('Speed Violation')) {
            vehicle.alerts.push('Speed Violation');
            showToast(`${vehicle.id} exceeding speed limit: ${vehicle.route.currentSpeed}/${vehicle.route.speedLimit} km/h`, 'critical', 'high');
            addAlert(vehicle.id, vehicle.group, 'Speed Violation', 'Critical');
          }
        }
        
        // Critical maintenance alerts
        if (vehicle.health.maintenanceRisk === 'High' && !vehicle.alerts.includes('Critical Maintenance')) {
          vehicle.alerts.push('Critical Maintenance');
          showToast(`${vehicle.id} requires immediate maintenance attention`, 'warning', 'high');
          addAlert(vehicle.id, vehicle.group, 'Critical Maintenance', 'Critical');
        }
        
        // Low fuel critical alert
        if (vehicle.health.fuel < 15 && !vehicle.alerts.includes('Critical Fuel Low')) {
          vehicle.alerts.push('Critical Fuel Low');
          showToast(`${vehicle.id} fuel critically low: ${vehicle.health.fuel}%`, 'error', 'high');
          addAlert(vehicle.id, vehicle.group, 'Critical Fuel Low', 'Critical');
        }
      });
    }

    // Export CSV
    document.getElementById('export-csv-btn').onclick = () => {
      try {
        const csv = [
          'ID,VIN,Plate Number,Driver,Status,Group,Last Ping,Fuel,Battery,Engine Temp,Tire Pressure,Mileage,Next Service,Alerts,Driver Score,Harsh Braking,Speeding,Idling,Harsh Acceleration,Cornering,ETA,Distance,Traffic Delay'
        ];
        vehicles.forEach(v => {
          csv.push(
            `${v.id},${v.vin},${v.plateNumber},${v.driver},${v.status},${v.group},${v.lastPing},${v.health.fuel},${v.health.battery},${v.health.engineTemp.toFixed(1)},${v.health.tirePressure.toFixed(1)},${v.health.mileage},${v.health.nextService},"${v.alerts.join(';')}",${v.driverBehavior.score},${v.driverBehavior.harshBraking},${v.driverBehavior.speeding},${v.driverBehavior.idling},${v.driverBehavior.harshAcceleration},${v.driverBehavior.cornering},${v.route.eta},${v.route.distance},${v.route.trafficDelay}`
          );
        });
        const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'vehicles.csv';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Vehicle data exported successfully.');
      } catch (error) {
        console.error('Error exporting CSV:', error);
        showToast('Error exporting vehicle data.');
      }
    };

    // Bulk Actions (Enhanced with Executive Steps)
    let selectedVehicles = new Set();
    
    function toggleVehicleSelection(vehicleId, isChecked = null) {
      if (isChecked !== null) {
        // Use explicit checked state
        if (isChecked) {
          selectedVehicles.add(vehicleId);
        } else {
          selectedVehicles.delete(vehicleId);
        }
      } else {
        // Toggle state
        if (selectedVehicles.has(vehicleId)) {
          selectedVehicles.delete(vehicleId);
        } else {
          selectedVehicles.add(vehicleId);
        }
      }
      
      updateBulkActionButton();
      updateVehicleCardSelection(vehicleId, selectedVehicles.has(vehicleId));
      updateVehicleSelectionUI();
    }
    
    function updateVehicleCardSelection(vehicleId, isSelected) {
      const checkbox = document.querySelector(`[data-vehicle-id="${vehicleId}"]`);
      if (checkbox && checkbox.type === 'checkbox') {
        checkbox.checked = isSelected;
        // Add visual feedback to card
        const card = checkbox.closest('.vehicle-card');
        if (card) {
          if (isSelected) {
            card.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
          } else {
            card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
          }
        }
      }
    }
    
    function updateVehicleSelectionUI() {
      // Update selection counter
      const selectionCounter = document.getElementById('selection-counter');
      if (selectionCounter) {
        if (selectedVehicles.size > 0) {
          selectionCounter.textContent = `${selectedVehicles.size} vehicles selected`;
          selectionCounter.classList.remove('hidden');
        } else {
          selectionCounter.classList.add('hidden');
        }
      }
      
      // Update select-all checkbox state
      const selectAllCheckbox = document.getElementById('select-all-checkbox');
      const visibleVehicles = document.querySelectorAll('.vehicle-checkbox');
      if (selectAllCheckbox && visibleVehicles.length > 0) {
        const allSelected = Array.from(visibleVehicles).every(checkbox => {
          const vehicleId = checkbox.getAttribute('data-vehicle-id');
          return selectedVehicles.has(vehicleId);
        });
        const someSelected = selectedVehicles.size > 0;
        
        selectAllCheckbox.checked = allSelected;
        selectAllCheckbox.indeterminate = someSelected && !allSelected;
      }
      
      // Update all checkboxes to match selectedVehicles set
      document.querySelectorAll('.vehicle-checkbox').forEach(checkbox => {
        const vehicleId = checkbox.getAttribute('data-vehicle-id');
        if (vehicleId) {
          updateVehicleCardSelection(vehicleId, selectedVehicles.has(vehicleId));
        }
      });
    }
    
    function selectAllVehicles() {
      const visibleCheckboxes = document.querySelectorAll('.vehicle-checkbox');
      visibleCheckboxes.forEach(checkbox => {
        const vehicleId = checkbox.getAttribute('data-vehicle-id');
        if (vehicleId) {
          selectedVehicles.add(vehicleId);
        }
      });
      updateBulkActionButton();
      updateVehicleSelectionUI();
    }
    
    function clearAllSelections() {
      selectedVehicles.clear();
      updateBulkActionButton();
      updateVehicleSelectionUI();
    }
    
    function updateBulkActionButton() {
      const bulkBtn = document.getElementById('bulk-action-btn');
      if (bulkBtn) {
        bulkBtn.textContent = selectedVehicles.size > 0 ? 
          `Bulk Actions (${selectedVehicles.size})` : 'Bulk Actions';
        bulkBtn.disabled = selectedVehicles.size === 0;
      }
    }
    
    function updateVehicleSelectionUI() {
      document.querySelectorAll('.vehicle-card').forEach(card => {
        const vehicleId = card.dataset.vehicleId;
        const checkbox = card.querySelector('.vehicle-checkbox');
        if (checkbox && vehicleId) {
          checkbox.checked = selectedVehicles.has(vehicleId);
        }
      });
    }
    
    function showBulkActionsModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-tasks mr-2 text-blue-600"></i>
            Bulk Actions - ${selectedVehicles.size} Vehicle(s) Selected
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button onclick="executeBulkMaintenance()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-tools text-yellow-600 mr-3 text-xl"></i>
                <span class="font-semibold">Schedule Maintenance</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Schedule maintenance for selected vehicles</p>
            </button>
            
            <button onclick="executeBulkDriverAssignment()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-user-plus text-green-600 mr-3 text-xl"></i>
                <span class="font-semibold">Assign Drivers</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Assign or reassign drivers to vehicles</p>
            </button>
            
            <button onclick="executeBulkGroupChange()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-layer-group text-purple-600 mr-3 text-xl"></i>
                <span class="font-semibold">Change Group</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Move vehicles to different groups</p>
            </button>
            
            <button onclick="executeBulkStatusUpdate()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-orange-50 dark:hover:bg-orange-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-exchange-alt text-orange-600 mr-3 text-xl"></i>
                <span class="font-semibold">Update Status</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Change status for multiple vehicles</p>
            </button>
            
            <button onclick="executeBulkExport()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-download text-indigo-600 mr-3 text-xl"></i>
                <span class="font-semibold">Export Data</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Export selected vehicles data</p>
            </button>
            
            <button onclick="executeBulkAlertClear()" class="bulk-action-item p-4 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
              <div class="flex items-center mb-2">
                <i class="fas fa-bell-slash text-red-600 mr-3 text-xl"></i>
                <span class="font-semibold">Clear Alerts</span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Clear all alerts for selected vehicles</p>
            </button>
          </div>
          
          <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Selected Vehicles:</h4>
            <div class="max-h-32 overflow-y-auto bg-gray-50 dark:bg-gray-700 rounded p-3">
              ${Array.from(selectedVehicles).map(id => {
                const vehicle = vehicles.find(v => v.id === id);
                return vehicle ? `<span class="inline-block bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs mr-2 mb-1">${vehicle.id} - ${vehicle.driver}</span>` : '';
              }).join('')}
            </div>
          </div>
          
          <div class="flex justify-end gap-3 mt-6">
            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    document.getElementById('bulk-action-btn').addEventListener('click', () => {
      if (selectedVehicles.size === 0) {
        showToast('Please select vehicles first', 'warning');
        return;
      }
      showBulkActionsModal();
    });

    // Add Vehicle and Create Group event listeners
    document.getElementById('add-vehicle-btn').addEventListener('click', showAddVehicleModal);
    
    // Add create group button functionality
    document.addEventListener('DOMContentLoaded', () => {
      const createGroupBtn = document.createElement('button');
      createGroupBtn.innerHTML = '<i class="fas fa-layer-group mr-2"></i>Create Group';
      createGroupBtn.className = 'px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200';
      createGroupBtn.onclick = showCreateGroupModal;
      
      // Add button to controls section
      const controlsSection = document.querySelector('.flex.flex-wrap.gap-4.mb-6');
      if (controlsSection) {
        controlsSection.appendChild(createGroupBtn);
      }
    });

    // Executive Bulk Action Functions
    function executeBulkMaintenance() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-tools mr-2 text-yellow-600"></i>
            Schedule Bulk Maintenance
          </h3>
          <form id="bulk-maintenance-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Maintenance Type</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select maintenance type</option>
                  <option value="routine">Routine Service</option>
                  <option value="oil-change">Oil Change</option>
                  <option value="brake-inspection">Brake Inspection</option>
                  <option value="tire-rotation">Tire Rotation</option>
                  <option value="transmission">Transmission Service</option>
                  <option value="emergency">Emergency Repair</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Scheduled Date</label>
                <input type="date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required 
                       min="${new Date().toISOString().split('T')[0]}">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="low">Low Priority</option>
                  <option value="medium" selected>Medium Priority</option>
                  <option value="high">High Priority</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Service Provider</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select service provider</option>
                  <option value="main-garage">Main Garage</option>
                  <option value="certified-dealer">Certified Dealer</option>
                  <option value="mobile-service">Mobile Service</option>
                  <option value="third-party">Third Party Contractor</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Additional Notes</label>
                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                          placeholder="Enter any additional maintenance notes..."></textarea>
              </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                Schedule Maintenance
              </button>
            </div>
          </form>
        </div>
      `;
      
      modal.querySelector('#bulk-maintenance-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Process maintenance scheduling
        Array.from(selectedVehicles).forEach(vehicleId => {
          const vehicle = vehicles.find(v => v.id === vehicleId);
          if (vehicle) {
            vehicle.status = 'Maintenance';
            vehicle.alerts.push('Scheduled Maintenance');
          }
        });
        
        showToast(`Maintenance scheduled for ${selectedVehicles.size} vehicles`, 'success');
        selectedVehicles.clear();
        updateBulkActionButton();
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        modal.remove();
        document.querySelector('.fixed.inset-0').remove(); // Close bulk actions modal
      });
      
      document.body.appendChild(modal);
    }

    function executeBulkDriverAssignment() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-user-plus mr-2 text-green-600"></i>
            Bulk Driver Assignment
          </h3>
          <form id="bulk-driver-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assignment Mode</label>
                <select id="assignment-mode" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select assignment mode</option>
                  <option value="specific">Assign Specific Driver</option>
                  <option value="auto">Auto-Assign Available Drivers</option>
                  <option value="unassign">Unassign Current Drivers</option>
                </select>
              </div>
              <div id="specific-driver-section" class="hidden">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Driver</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                  <option value="">Choose a driver</option>
                  ${Array.from({length: 20}, (_, i) => `<option value="Driver ${i + 1}">Driver ${i + 1}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Effective Date</label>
                <input type="datetime-local" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required 
                       value="${new Date().toISOString().slice(0, 16)}">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assignment Notes</label>
                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                          placeholder="Enter assignment notes or special instructions..."></textarea>
              </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                Assign Drivers
              </button>
            </div>
          </form>
        </div>
      `;
      
      // Show/hide specific driver section based on mode
      modal.querySelector('#assignment-mode').addEventListener('change', (e) => {
        const specificSection = modal.querySelector('#specific-driver-section');
        if (e.target.value === 'specific') {
          specificSection.classList.remove('hidden');
        } else {
          specificSection.classList.add('hidden');
        }
      });
      
      modal.querySelector('#bulk-driver-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const mode = modal.querySelector('#assignment-mode').value;
        
        Array.from(selectedVehicles).forEach(vehicleId => {
          const vehicle = vehicles.find(v => v.id === vehicleId);
          if (vehicle) {
            switch(mode) {
              case 'specific':
                const selectedDriver = modal.querySelector('#specific-driver-section select').value;
                if (selectedDriver) vehicle.driver = selectedDriver;
                break;
              case 'auto':
                vehicle.driver = `Driver ${Math.floor(Math.random() * 50) + 1}`;
                break;
              case 'unassign':
                vehicle.driver = 'Unassigned';
                break;
            }
          }
        });
        
        showToast(`Driver assignment completed for ${selectedVehicles.size} vehicles`, 'success');
        selectedVehicles.clear();
        updateBulkActionButton();
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        modal.remove();
        document.querySelector('.fixed.inset-0').remove();
      });
      
      document.body.appendChild(modal);
    }

    function executeBulkGroupChange() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-layer-group mr-2 text-purple-600"></i>
            Change Vehicle Groups
          </h3>
          <form id="bulk-group-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Target Group</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select target group</option>
                  <option value="Delivery">Delivery</option>
                  <option value="Service">Service</option>
                  <option value="Executive">Executive</option>
                  <option value="Maintenance">Maintenance Pool</option>
                  <option value="Reserved">Reserved Fleet</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Transfer Reason</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select reason</option>
                  <option value="operational">Operational Requirements</option>
                  <option value="maintenance">Maintenance Schedule</option>
                  <option value="seasonal">Seasonal Adjustment</option>
                  <option value="capacity">Capacity Optimization</option>
                  <option value="replacement">Vehicle Replacement</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Effective Date</label>
                <input type="date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required 
                       value="${new Date().toISOString().split('T')[0]}">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Transfer Notes</label>
                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                          placeholder="Enter reason for group transfer..."></textarea>
              </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                Transfer Vehicles
              </button>
            </div>
          </form>
        </div>
      `;
      
      modal.querySelector('#bulk-group-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const targetGroup = modal.querySelector('select').value;
        
        Array.from(selectedVehicles).forEach(vehicleId => {
          const vehicle = vehicles.find(v => v.id === vehicleId);
          if (vehicle) {
            vehicle.group = targetGroup;
          }
        });
        
        showToast(`${selectedVehicles.size} vehicles transferred to ${targetGroup} group`, 'success');
        selectedVehicles.clear();
        updateBulkActionButton();
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        modal.remove();
        document.querySelector('.fixed.inset-0').remove();
      });
      
      document.body.appendChild(modal);
    }

    function executeBulkStatusUpdate() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-exchange-alt mr-2 text-orange-600"></i>
            Bulk Status Update
          </h3>
          <form id="bulk-status-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">New Status</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select new status</option>
                  <option value="Driving">Driving</option>
                  <option value="Idling">Idling</option>
                  <option value="Parked">Parked</option>
                  <option value="Offline">Offline</option>
                  <option value="Maintenance">Maintenance</option>
                  <option value="Alert">Alert</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status Change Reason</label>
                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select reason</option>
                  <option value="scheduled">Scheduled Operation</option>
                  <option value="emergency">Emergency Response</option>
                  <option value="maintenance">Maintenance Required</option>
                  <option value="inspection">Inspection Period</option>
                  <option value="administrative">Administrative Action</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Update Notes</label>
                <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                          placeholder="Enter reason for status change..."></textarea>
              </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                Update Status
              </button>
            </div>
          </form>
        </div>
      `;
      
      modal.querySelector('#bulk-status-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const newStatus = modal.querySelector('select').value;
        
        Array.from(selectedVehicles).forEach(vehicleId => {
          const vehicle = vehicles.find(v => v.id === vehicleId);
          if (vehicle) {
            vehicle.status = newStatus;
          }
        });
        
        showToast(`Status updated to "${newStatus}" for ${selectedVehicles.size} vehicles`, 'success');
        selectedVehicles.clear();
        updateBulkActionButton();
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        modal.remove();
        document.querySelector('.fixed.inset-0').remove();
      });
      
      document.body.appendChild(modal);
    }

    function executeBulkExport() {
      const selectedVehicleData = Array.from(selectedVehicles).map(id => 
        vehicles.find(v => v.id === id)
      ).filter(v => v);
      
      const csv = [
        'ID,VIN,Plate Number,Driver,Status,Group,Last Ping,Fuel,Battery,Engine Temp,Tire Pressure,Mileage,Next Service,Alerts,Driver Score'
      ];
      
      selectedVehicleData.forEach(v => {
        csv.push(
          `${v.id},${v.vin},${v.plateNumber},${v.driver},${v.status},${v.group},${v.lastPing},${v.health.fuel},${v.health.battery},${v.health.engineTemp.toFixed(1)},${v.health.tirePressure.toFixed(1)},${v.health.mileage},${v.health.nextService},"${v.alerts.join(';')}",${v.driverBehavior.score}`
        );
      });
      
      const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `selected_vehicles_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast(`Exported ${selectedVehicles.size} vehicles to CSV`, 'success');
      selectedVehicles.clear();
      updateBulkActionButton();
      document.querySelector('.fixed.inset-0').remove();
    }

    function executeBulkAlertClear() {
      Array.from(selectedVehicles).forEach(vehicleId => {
        const vehicle = vehicles.find(v => v.id === vehicleId);
        if (vehicle) {
          vehicle.alerts = [];
        }
      });
      
      // Alerts cleared for selected vehicles
      
      showToast(`Alerts cleared for ${selectedVehicles.size} vehicles`, 'success');
      selectedVehicles.clear();
      updateBulkActionButton();
      renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
      document.querySelector('.fixed.inset-0').remove();
    }

    // Add Vehicle Modal Function
    function showAddVehicleModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-plus-circle mr-2 text-blue-600"></i>
            Add New Vehicle - Executive Registration
          </h3>
          
          <form id="add-vehicle-form">
            <!-- Step 1: Vehicle Information -->
            <div class="space-y-6">
              <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-blue-800 dark:text-blue-300 mb-3">Step 1: Vehicle Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">VIN Number *</label>
                    <input type="text" name="vin" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           required maxlength="17" placeholder="17-character VIN">
                    <small class="text-gray-500">Vehicle Identification Number</small>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Plate Number *</label>
                    <input type="text" name="plateNumber" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           required placeholder="License plate number">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Manufacturer *</label>
                    <select name="manufacturer" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                      <option value="">Select manufacturer</option>
                      <option value="Ford">Ford</option>
                      <option value="Mercedes-Benz">Mercedes-Benz</option>
                      <option value="Volkswagen">Volkswagen</option>
                      <option value="Iveco">Iveco</option>
                      <option value="MAN">MAN</option>
                      <option value="Volvo">Volvo</option>
                      <option value="Scania">Scania</option>
                      <option value="DAF">DAF</option>
                      <option value="Isuzu">Isuzu</option>
                      <option value="Mitsubishi">Mitsubishi</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Model *</label>
                    <input type="text" name="model" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           required placeholder="Vehicle model">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Year *</label>
                    <input type="number" name="year" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           required min="1990" max="2024" placeholder="2024">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vehicle Type *</label>
                    <select name="type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                      <option value="">Select type</option>
                      <option value="Van">Van</option>
                      <option value="Truck">Truck</option>
                      <option value="Car">Car</option>
                      <option value="Bus">Bus</option>
                      <option value="SUV">SUV</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Step 2: Assignment & Operations -->
              <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-green-800 dark:text-green-300 mb-3">Step 2: Assignment & Operations</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fleet Group *</label>
                    <select name="group" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                      <option value="">Select group</option>
                      <option value="Delivery">Delivery</option>
                      <option value="Service">Service</option>
                      <option value="Executive">Executive</option>
                      <option value="Maintenance">Maintenance</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assign Driver</label>
                    <select name="driver" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                      <option value="Unassigned">No Driver Assigned</option>
                      ${Array.from({length: 20}, (_, i) => `<option value="Driver ${i + 1}">Driver ${i + 1}</option>`).join('')}
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Initial Status *</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                      <option value="Parked">Parked</option>
                      <option value="Offline">Offline</option>
                      <option value="Maintenance">Maintenance</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Service Date</label>
                    <input type="date" name="serviceDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                  </div>
                </div>
              </div>

              <!-- Step 3: Technical Specifications -->
              <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-yellow-800 dark:text-yellow-300 mb-3">Step 3: Technical Specifications</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fuel Capacity (L)</label>
                    <input type="number" name="fuelCapacity" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           placeholder="80" min="20" max="200">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Load Capacity (kg)</label>
                    <input type="number" name="loadCapacity" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           placeholder="1000" min="200" max="10000">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Mileage</label>
                    <input type="number" name="mileage" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                           placeholder="50000" min="0">
                  </div>
                </div>
              </div>

              <!-- Step 4: Registration Notes -->
              <div class="bg-gray-50 dark:bg-gray-900/20 p-4 rounded-lg">
                <h4 class="font-semibold text-gray-800 dark:text-gray-300 mb-3">Step 4: Registration Notes</h4>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Additional Notes</label>
                  <textarea name="notes" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                            placeholder="Enter any additional information about this vehicle..."></textarea>
                </div>
              </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                <i class="fas fa-save mr-2"></i>
                Register Vehicle
              </button>
            </div>
          </form>
        </div>
      `;
      
      // VIN validation
      const vinInput = modal.querySelector('input[name="vin"]');
      vinInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (e.target.value.length === 17) {
          // Basic VIN validation (simplified)
          const isValid = /^[A-HJ-NPR-Z0-9]{17}$/.test(e.target.value);
          e.target.style.borderColor = isValid ? 'green' : 'red';
        }
      });
      
      modal.querySelector('#add-vehicle-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        // Create new vehicle object
        const newVehicle = {
          id: vehicles.length + 1,
          vin: formData.get('vin'),
          plateNumber: formData.get('plateNumber'),
          manufacturer: formData.get('manufacturer'),
          model: formData.get('model'),
          year: parseInt(formData.get('year')),
          type: formData.get('type'),
          driver: formData.get('driver'),
          status: formData.get('status'),
          group: formData.get('group'),
          lastPing: 'Just now',
          health: {
            fuel: Math.floor(Math.random() * 100),
            battery: Math.floor(Math.random() * 100),
            engineTemp: 85 + Math.random() * 15,
            tirePressure: 32 + Math.random() * 8,
            mileage: parseInt(formData.get('mileage')) || Math.floor(Math.random() * 100000),
            nextService: formData.get('serviceDate') || '2024-12-01'
          },
          alerts: [],
          driverBehavior: {
            score: 85 + Math.floor(Math.random() * 15),
            violations: Math.floor(Math.random() * 5)
          },
          speed: 0,
          location: { lat: 40.7128 + (Math.random() - 0.5) * 0.1, lng: -74.0060 + (Math.random() - 0.5) * 0.1 }
        };
        
        vehicles.push(newVehicle);
        
        showToast(`Vehicle ${newVehicle.plateNumber} registered successfully`, 'success');
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        updateStatistics();
        modal.remove();
      });
      
      document.body.appendChild(modal);
    }

    function showCreateGroupModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-layer-group mr-2 text-purple-600"></i>
            Create New Fleet Group
          </h3>
          
          <form id="create-group-form">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Group Name *</label>
                <input type="text" name="groupName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                       required placeholder="Enter group name">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Group Type *</label>
                <select name="groupType" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select group type</option>
                  <option value="Operational">Operational</option>
                  <option value="Service">Service</option>
                  <option value="Geographic">Geographic</option>
                  <option value="Temporary">Temporary</option>
                  <option value="Special Purpose">Special Purpose</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority Level *</label>
                <select name="priority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" required>
                  <option value="">Select priority</option>
                  <option value="High">High Priority</option>
                  <option value="Medium">Medium Priority</option>
                  <option value="Low">Low Priority</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Maximum Vehicles</label>
                <input type="number" name="maxVehicles" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" 
                       min="1" max="100" placeholder="50">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Operating Hours</label>
                <div class="grid grid-cols-2 gap-2">
                  <input type="time" name="startTime" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" value="08:00">
                  <input type="time" name="endTime" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" value="18:00">
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Group Manager</label>
                <select name="manager" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700">
                  <option value="">No manager assigned</option>
                  <option value="Manager 1">Manager 1</option>
                  <option value="Manager 2">Manager 2</option>
                  <option value="Manager 3">Manager 3</option>
                  <option value="Manager 4">Manager 4</option>
                  <option value="Manager 5">Manager 5</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Group Description</label>
                <textarea name="description" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" rows="3" 
                          placeholder="Describe the purpose and operations of this group..."></textarea>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Initial Vehicles</label>
                <div class="max-h-32 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                  ${vehicles.slice(0, 10).map(v => `
                    <label class="flex items-center space-x-2 text-sm">
                      <input type="checkbox" name="vehicles" value="${v.id}" class="rounded">
                      <span>${v.plateNumber} - ${v.manufacturer} ${v.model}</span>
                    </label>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
              <button type="button" onclick="this.closest('.fixed').remove()" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                Cancel
              </button>
              <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center">
                <i class="fas fa-plus mr-2"></i>
                Create Group
              </button>
            </div>
          </form>
        </div>
      `;
      
      modal.querySelector('#create-group-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const selectedVehicles = Array.from(formData.getAll('vehicles'));
        
        // Update selected vehicles to new group
        selectedVehicles.forEach(vehicleId => {
          const vehicle = vehicles.find(v => v.id === parseInt(vehicleId));
          if (vehicle) {
            vehicle.group = formData.get('groupName');
          }
        });
        
        showToast(`Group "${formData.get('groupName')}" created with ${selectedVehicles.length} vehicles`, 'success');
        renderVehicleList(currentPage, document.getElementById('vehicle-search').value, filters);
        updateStatistics();
        modal.remove();
      });
      
      document.body.appendChild(modal);
    }



    // =================================================================
    // GEOFENCING FUNCTIONALITY MOVED TO FLEETMAPWIDGET
    // The FleetMapWidget provides complete geofencing capabilities:
    // - Draw circle and polygon geofences
    // - Configure geofence properties and alerts  
    // - Monitor vehicle entry/exit violations
    // - Manage multiple active geofences
    // All duplicate geofencing code has been removed from this page
    // =================================================================
    
    function showGeofenceTypeModal() {
      console.log('Creating geofence type modal');
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-draw-polygon mr-2 text-purple-600"></i>
            Choose Geofence Type
          </h3>
          
          <div class="space-y-4">
            <button id="circle-geofence-btn" class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-circle text-blue-600 text-2xl mr-4"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Circle Geofence</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Click once to set center and radius</div>
                </div>
              </div>
            </button>
            
            <button id="polygon-geofence-btn" class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-draw-polygon text-purple-600 text-2xl mr-4"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Polygon Geofence</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Click to add points, double-click to finish</div>
                </div>
              </div>
            </button>
          </div>
          
          <div class="flex justify-end gap-3 mt-6">
            <button id="cancel-geofence-type" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Add event listeners after modal is created
      document.getElementById('circle-geofence-btn').addEventListener('click', () => {
        console.log('Circle geofence button clicked');
        startGeofenceDrawing('circle');
      });
      
      document.getElementById('polygon-geofence-btn').addEventListener('click', () => {
        console.log('Polygon geofence button clicked');
        startGeofenceDrawing('polygon');
      });
      
      document.getElementById('cancel-geofence-type').addEventListener('click', () => {
        console.log('Cancel geofence type button clicked');
        modal.remove();
      });
    }
    
    function startGeofenceDrawing(type) {
      console.log('Starting geofence drawing, type:', type, 'map ready:', isMapReady());
      
      geofenceType = type;
      isGeofenceMode = true;
      
      // Clear any existing drawing state
      clearPolygonPoints();
      
      const btn = document.getElementById('geofence-btn');
      const statusDiv = document.getElementById('geofence-status');
      
      if (type === 'circle') {
        btn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancel Circle';
        btn.className = 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center text-sm';
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = '<i class="fas fa-crosshairs mr-2"></i>Click on the map to set circle center';
        showToast('Click on the map to set circle center', 'info');
      } else {
        btn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancel Polygon';
        btn.className = 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center text-sm';
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = '<i class="fas fa-mouse-pointer mr-2"></i>Click to add polygon points (min 3), double-click to finish';
        showToast('Click to add polygon points. Need minimum 3 points. Double-click to finish.', 'info');
      }
      
      if (map) {
        map.getContainer().style.cursor = 'crosshair';
        console.log('Map cursor set to crosshair');
      } else {
        console.error('Map not available for geofence drawing');
        showToast('Map not available. Please refresh the page.', 'error');
        return;
      }
      
      // Close type selection modal
      const typeModal = document.querySelector('.fixed.inset-0');
      if (typeModal) {
        typeModal.remove();
      }
      
      console.log('Geofence drawing mode activated:', type);
    }

    function showDriverGeofenceModal(vehicle) {
      console.log('Showing driver geofence modal for:', vehicle.driver);
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-draw-polygon mr-2 text-teal-600"></i>
            Set Geofence for ${vehicle.driver}
          </h3>
          
          <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="text-sm text-gray-600 dark:text-gray-300">
              <strong>Vehicle:</strong> ${vehicle.id} (${vehicle.manufacturer} ${vehicle.model})<br>
              <strong>Current Location:</strong> ${vehicle.lat.toFixed(6)}, ${vehicle.lng.toFixed(6)}<br>
              <strong>Status:</strong> ${vehicle.status}
            </div>
          </div>
          
          <div class="space-y-4">
            <button id="driver-circle-geofence" class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-teal-500 hover:bg-teal-50 dark:hover:bg-teal-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-circle text-teal-600 text-2xl mr-4"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Circle Geofence</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Set radius around current location</div>
                </div>
              </div>
            </button>
            
            <button id="driver-polygon-geofence" class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-teal-500 hover:bg-teal-50 dark:hover:bg-teal-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-draw-polygon text-teal-600 text-2xl mr-4"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Custom Polygon</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Draw custom area on map</div>
                </div>
              </div>
            </button>
            
            <button id="driver-center-map" class="w-full p-4 border-2 border-gray-200 dark:border-gray-600 rounded-lg hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-crosshairs text-blue-600 text-2xl mr-4"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Center Map on Vehicle</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Focus map on current location</div>
                </div>
              </div>
            </button>
          </div>
          
          <div class="flex justify-end gap-3 mt-6">
            <button id="cancel-driver-geofence" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Add event listeners
      document.getElementById('driver-circle-geofence').addEventListener('click', () => {
        modal.remove();
        startDriverGeofenceDrawing(vehicle, 'circle');
      });
      
      document.getElementById('driver-polygon-geofence').addEventListener('click', () => {
        modal.remove();
        startDriverGeofenceDrawing(vehicle, 'polygon');
      });
      
      document.getElementById('driver-center-map').addEventListener('click', () => {
        modal.remove();
        centerMapOnVehicle(vehicle);
      });
      
      document.getElementById('cancel-driver-geofence').addEventListener('click', () => {
        modal.remove();
      });
    }

    function startDriverGeofenceDrawing(vehicle, type) {
      console.log('Starting driver geofence drawing:', type, 'for vehicle:', vehicle.id);
      
      geofenceType = type;
      isGeofenceMode = true;
      
      // Clear any existing drawing state
      if (typeof clearPolygonPoints === 'function') {
        clearPolygonPoints();
      }
      
      // Center map on vehicle
      centerMapOnVehicle(vehicle);
      
      if (type === 'circle') {
        showToast(`Setting circle geofence for ${vehicle.driver}. Click on the map to set the center point.`, 'info');
        
        // Create a simple circle geofence modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
        modal.innerHTML = `
          <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 max-w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Circle Geofence for ${vehicle.driver}</h3>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Center Location</label>
              <input type="text" value="${vehicle.lat ? vehicle.lat.toFixed(6) : 'N/A'}, ${vehicle.lng ? vehicle.lng.toFixed(6) : 'N/A'}" class="w-full p-2 border rounded-lg" readonly>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Radius (km)</label>
              <input type="number" value="5" min="0.1" max="50" step="0.1" class="w-full p-2 border rounded-lg">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Geofence Name</label>
              <input type="text" value="Geofence for ${vehicle.driver}" class="w-full p-2 border rounded-lg">
            </div>
            <div class="flex gap-2 justify-end">
              <button onclick="this.closest('.fixed').remove(); isGeofenceMode = false;" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-400">Cancel</button>
              <button onclick="alert('Circle geofence created for ${vehicle.driver}!'); this.closest('.fixed').remove(); isGeofenceMode = false;" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create Geofence</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
      } else {
        showToast(`Drawing polygon geofence for ${vehicle.driver}. Click on the map to add points, double-click to finish.`, 'info');
        
        // For polygon, we'll just show a simple notification for now
        setTimeout(() => {
          alert(`Polygon drawing mode activated for ${vehicle.driver}. This is a demo - in a full implementation, you would click on the map to draw polygon points.`);
          isGeofenceMode = false;
        }, 1000);
      }
      
      // Change cursor if map is available
      if (map && map.getContainer) {
        map.getContainer().style.cursor = 'crosshair';
      } else if (window.vehiclesPageMap && window.vehiclesPageMap.map && window.vehiclesPageMap.map.getTargetElement) {
        window.vehiclesPageMap.map.getTargetElement().style.cursor = 'crosshair';
      }
    }

    function centerMapOnVehicle(vehicle) {
      if (window.vehiclesPageMap && vehicle.lat && vehicle.lng) {
        // Use fleet map widget
        window.vehiclesPageMap.map.setView([vehicle.lat, vehicle.lng], 15);
        showToast(`Map centered on ${vehicle.driver}'s location`, 'info');
      } else if (map && vehicle.lat && vehicle.lng) {
        // Use fallback Leaflet map
        map.setView([vehicle.lat, vehicle.lng], 15);
        showToast(`Map centered on ${vehicle.driver}'s location`, 'info');
      }
    }

    function issueWarningToDriver(vehicle) {
      console.log('Issuing warning to driver:', vehicle.driver, 'vehicle:', vehicle.id);
      console.log('Vehicle data:', vehicle);
      
      // Check for current violations
      const currentViolations = checkCurrentViolations(vehicle);
      console.log('Current violations found:', currentViolations);
      
      // Show warning modal with violation details
      showWarningModal(vehicle, currentViolations);
    }

    function checkCurrentViolations(vehicle) {
      const violations = [];
      
      // Check for speeding
      if (vehicle.route.currentSpeed > vehicle.route.speedLimit) {
        violations.push({
          type: 'Speeding',
          severity: 'High',
          description: `Current speed: ${Math.round(vehicle.route.currentSpeed)} km/h (Limit: ${vehicle.route.speedLimit} km/h)`,
          points: 3
        });
      }
      
      // Check for harsh driving behavior
      if (vehicle.driverBehavior.harshBraking > 3) {
        violations.push({
          type: 'Harsh Braking',
          severity: 'Medium',
          description: `${vehicle.driverBehavior.harshBraking} harsh braking incidents detected`,
          points: 2
        });
      }
      
      if (vehicle.driverBehavior.harshAcceleration > 3) {
        violations.push({
          type: 'Harsh Acceleration',
          severity: 'Medium',
          description: `${vehicle.driverBehavior.harshAcceleration} harsh acceleration incidents detected`,
          points: 2
        });
      }
      
      // Check for maintenance issues
      if (vehicle.health.maintenanceRisk === 'High') {
        violations.push({
          type: 'Maintenance Risk',
          severity: 'Medium',
          description: 'Vehicle requires immediate maintenance attention',
          points: 2
        });
      }
      
      // Check for fuel efficiency
      if (vehicle.route.fuelConsumption > 12) {
        violations.push({
          type: 'Fuel Inefficiency',
          severity: 'Low',
          description: `High fuel consumption: ${Math.round(vehicle.route.fuelConsumption)}L/100km`,
          points: 1
        });
      }
      
      // Check for geofence violations (if any alerts contain geofence)
      if (vehicle.alerts.includes('Geofence Violation')) {
        violations.push({
          type: 'Geofence Violation',
          severity: 'High',
          description: 'Vehicle has left designated geofence area',
          points: 3
        });
      }
      
      return violations;
    }

    function showWarningModal(vehicle, currentViolations) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60';
      
      const hasCurrentViolations = currentViolations.length > 0;
      const hasViolationHistory = vehicle.driverBehavior.violationHistory.length > 0;
      
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>
            Issue Warning - ${vehicle.driver}
          </h3>
          
          <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="text-sm text-gray-600 dark:text-gray-300">
              <strong>Vehicle:</strong> ${vehicle.id} (${vehicle.manufacturer} ${vehicle.model})<br>
              <strong>Current Status:</strong> ${vehicle.status}<br>
              <strong>Driver Score:</strong> ${Math.round(vehicle.driverBehavior.score)}/100<br>
              <strong>Total Violations:</strong> ${vehicle.driverBehavior.violations}
            </div>
          </div>
          
          ${hasCurrentViolations ? `
            <div class="mb-4">
              <h4 class="font-semibold text-red-600 dark:text-red-400 mb-2 flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Current Violations Detected
              </h4>
              <div class="space-y-2">
                ${currentViolations.map(violation => `
                  <div class="p-3 border-l-4 border-red-500 bg-red-50 dark:bg-red-900/20 rounded-r-lg">
                    <div class="flex justify-between items-start">
                      <div>
                        <div class="font-semibold text-red-700 dark:text-red-300">${violation.type}</div>
                        <div class="text-sm text-red-600 dark:text-red-400">${violation.description}</div>
                      </div>
                      <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                        violation.severity === 'High' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                        violation.severity === 'Medium' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                        'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                      }">${violation.severity}</span>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : `
            <div class="mb-4 p-3 bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 rounded-r-lg">
              <div class="flex items-center">
                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                <span class="text-green-700 dark:text-green-300 font-semibold">No current violations detected</span>
              </div>
            </div>
          `}
          
          ${hasViolationHistory ? `
            <div class="mb-4">
              <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center">
                <i class="fas fa-history mr-2"></i>
                Recent Violation History
              </h4>
              <div class="max-h-40 overflow-y-auto space-y-2">
                ${vehicle.driverBehavior.violationHistory.slice(0, 5).map(violation => `
                  <div class="p-2 border border-gray-200 dark:border-gray-600 rounded-lg text-sm">
                    <div class="flex justify-between items-start">
                      <div>
                        <div class="font-medium">${violation.type}</div>
                        <div class="text-gray-600 dark:text-gray-400">${violation.date} at ${violation.time}</div>
                        <div class="text-xs text-gray-500">${violation.description}</div>
                      </div>
                      <div class="text-right">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                          violation.resolved ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                        }">${violation.resolved ? 'Resolved' : 'Pending'}</span>
                        ${violation.warningIssued ? '<div class="text-xs text-orange-600 mt-1">Warning Issued</div>' : ''}
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <div class="space-y-3">
            <h4 class="font-semibold text-gray-700 dark:text-gray-300">Warning Options</h4>
            
            <button id="issue-verbal-warning" class="w-full p-3 border-2 border-yellow-200 dark:border-yellow-600 rounded-lg hover:border-yellow-500 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-comment text-yellow-600 text-xl mr-3"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Verbal Warning</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Send immediate notification to driver</div>
                </div>
              </div>
            </button>
            
            <button id="issue-written-warning" class="w-full p-3 border-2 border-orange-200 dark:border-orange-600 rounded-lg hover:border-orange-500 hover:bg-orange-50 dark:hover:bg-orange-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-file-alt text-orange-600 text-xl mr-3"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Written Warning</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Issue formal written warning</div>
                </div>
              </div>
            </button>
            
            <button id="schedule-meeting" class="w-full p-3 border-2 border-red-200 dark:border-red-600 rounded-lg hover:border-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all">
              <div class="flex items-center">
                <i class="fas fa-calendar-alt text-red-600 text-xl mr-3"></i>
                <div class="text-left">
                  <div class="font-semibold text-gray-900 dark:text-white">Schedule Meeting</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">Arrange face-to-face discussion</div>
                </div>
              </div>
            </button>
          </div>
          
          <div class="flex justify-end gap-3 mt-6">
            <button id="cancel-warning" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Add event listeners
      document.getElementById('issue-verbal-warning').addEventListener('click', () => {
        issueWarning(vehicle, 'Verbal', currentViolations);
        modal.remove();
      });
      
      document.getElementById('issue-written-warning').addEventListener('click', () => {
        issueWarning(vehicle, 'Written', currentViolations);
        modal.remove();
      });
      
      document.getElementById('schedule-meeting').addEventListener('click', () => {
        issueWarning(vehicle, 'Meeting', currentViolations);
        modal.remove();
      });
      
      document.getElementById('cancel-warning').addEventListener('click', () => {
        modal.remove();
      });
    }

    function issueWarning(vehicle, warningType, violations) {
      const timestamp = new Date().toLocaleString();
      const warningData = {
        vehicleId: vehicle.id,
        driver: vehicle.driver,
        type: warningType,
        violations: violations,
        timestamp: timestamp,
        status: 'Issued'
      };
      
      // Store warning in localStorage (in a real app, this would go to a database)
      const warnings = JSON.parse(localStorage.getItem('driverWarnings') || '[]');
      warnings.push(warningData);
      localStorage.setItem('driverWarnings', JSON.stringify(warnings));
      
      // Update vehicle's violation history
      violations.forEach(violation => {
        vehicle.driverBehavior.violationHistory.push({
          ...violation,
          date: new Date().toLocaleDateString(),
          time: new Date().toLocaleTimeString(),
          location: `${vehicle.lat.toFixed(6)}, ${vehicle.lng.toFixed(6)}`,
          resolved: false,
          warningIssued: true,
          warningType: warningType
        });
      });
      
      // Show confirmation
      const violationText = violations.length > 0 ? 
        ` for ${violations.length} violation${violations.length > 1 ? 's' : ''}` : '';
      
      showToast(`${warningType} warning issued to ${vehicle.driver}${violationText}`, 'warning');
      
      // Log the warning
      console.log(`Warning issued:`, warningData);
      
      // In a real application, this would trigger:
      // - SMS/Email notification to driver
      // - Dashboard notification
      // - Report generation
      // - Escalation if needed
    }
    
    function cancelGeofenceDrawing() {
      isGeofenceMode = false;
      const btn = document.getElementById('geofence-btn');
      btn.innerHTML = '<i class="fas fa-draw-polygon mr-2"></i>Draw Geofence';
      btn.className = 'px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center text-sm';
      document.getElementById('geofence-status').classList.add('hidden');
      
      if (map) {
        map.getContainer().style.cursor = '';
      }
      
      // Clear temporary elements
      if (tempGeofenceCircle) {
        map.removeLayer(tempGeofenceCircle);
        tempGeofenceCircle = null;
      }
      clearPolygonPoints();
      
      if (geofenceMarker && !geofence) {
        map.removeLayer(geofenceMarker);
        geofenceMarker = null;
      }
      
      showToast('Geofence drawing cancelled', 'info');
    }

    // =================================================================
    // GEOFENCING EVENT LISTENERS REMOVED
    // All geofencing functionality has been moved to FleetMapWidget
    // The FleetMapWidget handles all geofencing interactions internally
    // No additional event listeners are needed here
    // =================================================================
    
    // Simulated Real-Time Updates (simplified version)
    function simulateRealTimeUpdates() {
      console.log('🔄 Starting simplified real-time updates...');
      setInterval(() => {
        if (vehicles && vehicles.length > 0) {
          // Update timestamps and basic metrics
          vehicles.forEach(v => {
            if (v && v.route) {
              v.lastPing = new Date().toLocaleTimeString();
              
              // Slight fuel consumption for driving vehicles
              if (v.status === 'Driving' && v.health && v.health.fuel) {
                v.health.fuel = Math.max(0, v.health.fuel - Math.random() * 0.3);
              }
              
              // Update ETA for driving vehicles
              if (v.status === 'Driving' && v.route.eta) {
                v.route.eta = new Date(Date.now() + (Math.random() * 2 + 0.5) * 3600000).toLocaleTimeString();
              }
            }
          });
          
          // Update analytics every few cycles
          if (Math.random() > 0.7) {
            updateAnalytics();
          }
        }
      }, 15000); // Update every 15 seconds
    }
    
    // Check Critical Alerts (simplified version)
    function checkCriticalAlerts() {
      console.log('🚨 Checking critical alerts...');
      if (vehicles && vehicles.length > 0) {
        const criticalCount = vehicles.filter(v => 
          v.alerts && v.alerts.length > 0
        ).length;
        
        if (criticalCount > 0) {
          console.log(`⚠️ Found ${criticalCount} vehicles with alerts`);
        }
      }
    }
    
    // Note: renderMap function already exists earlier in the code (around line 1652)
    // No need for duplicate renderMap function here
    
    // Vehicle Types & Shifts Management System (simplified)
    class VehicleTypesShiftsManager {
      constructor() {
        this.vehicleTypes = [
          {
            id: 'delivery-truck',
            name: 'Delivery Truck',
            category: 'Heavy Duty',
            icon: 'fa-truck',
            color: 'blue',
            maxWeight: '26,000 kg',
            fuelType: 'Diesel',
            licenseRequired: 'CDL-A',
            activeUnits: 45
          },
          {
            id: 'service-van',
            name: 'Service Van',
            category: 'Light Commercial',
            icon: 'fa-shuttle-van',
            color: 'green',
            maxWeight: '3,500 kg',
            fuelType: 'Gasoline',
            licenseRequired: 'Class B',
            activeUnits: 32
          },
          {
            id: 'passenger-car',
            name: 'Passenger Car',
            category: 'Light Duty',
            icon: 'fa-car',
            color: 'purple',
            maxWeight: '2,000 kg',
            fuelType: 'Hybrid',
            licenseRequired: 'Class C',
            activeUnits: 23
          }
        ];

        this.shifts = [
          {
            id: 'morning',
            name: 'Morning Shift',
            startTime: '06:00',
            endTime: '14:00',
            days: 'Mon-Fri',
            icon: 'fa-sun',
            color: 'yellow',
            drivers: 25,
            vehicles: 30
          },
          {
            id: 'afternoon',
            name: 'Afternoon Shift',
            startTime: '14:00',
            endTime: '22:00',
            days: 'Mon-Fri',
            icon: 'fa-cloud-sun',
            color: 'orange',
            drivers: 20,
            vehicles: 25
          },
          {
            id: 'night',
            name: 'Night Shift',
            startTime: '22:00',
            endTime: '06:00',
            days: 'Daily',
            icon: 'fa-moon',
            color: 'blue',
            drivers: 12,
            vehicles: 15
          }
        ];
      }

      init() {
        console.log('🚛 Initializing Vehicle Types & Shifts Manager...');
        this.bindEvents();
        this.renderVehicleTypes();
        this.renderShiftSchedules();
      }

      bindEvents() {
        // Add vehicle type button
        const addVehicleTypeBtn = document.getElementById('add-vehicle-type');
        if (addVehicleTypeBtn) {
          addVehicleTypeBtn.addEventListener('click', () => {
            this.showToast('Add Vehicle Type feature coming soon!', 'info');
          });
        }

        // Add shift schedule button  
        const addShiftBtn = document.getElementById('add-shift-schedule');
        if (addShiftBtn) {
          addShiftBtn.addEventListener('click', () => {
            this.showToast('Add Shift Schedule feature coming soon!', 'info');
          });
        }
      }

      renderVehicleTypes() {
        console.log('🚛 Rendering vehicle types...');
        const grid = document.getElementById('vehicle-types-grid');
        if (!grid) {
          console.warn('🚛 Vehicle types grid element not found');
          return;
        }

        grid.innerHTML = this.vehicleTypes.map(type => `
          <div class="vehicle-type-card bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                  <i class="fas ${type.icon} text-blue-600 dark:text-blue-400 text-lg"></i>
                </div>
                <div>
                  <h4 class="font-semibold text-gray-900 dark:text-white text-sm">${type.name}</h4>
                  <span class="text-xs text-gray-500 dark:text-gray-400">${type.category}</span>
                </div>
              </div>
              <span class="text-sm font-medium text-gray-600 dark:text-gray-400">${type.activeUnits} units</span>
            </div>
            <div class="space-y-2 text-xs text-gray-600 dark:text-gray-400">
              <div class="flex justify-between">
                <span>Max Weight:</span>
                <span>${type.maxWeight}</span>
              </div>
              <div class="flex justify-between">
                <span>Fuel Type:</span>
                <span>${type.fuelType}</span>
              </div>
              <div class="flex justify-between">
                <span>License:</span>
                <span>${type.licenseRequired}</span>
              </div>
            </div>
          </div>
        `).join('');
        
        console.log('✅ Vehicle types rendered:', this.vehicleTypes.length, 'types');
      }

      renderShiftSchedules() {
        console.log('⏰ Rendering shift schedules...');
        const tbody = document.getElementById('shifts-table-body');
        if (!tbody) {
          console.warn('⏰ Shifts table body element not found');
          return;
        }

        tbody.innerHTML = this.shifts.map(shift => `
          <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="py-3 px-3">
              <div class="flex items-center">
                <div class="w-6 h-6 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mr-2">
                  <i class="fas ${shift.icon} text-blue-600 dark:text-blue-400 text-xs"></i>
                </div>
                <span class="font-medium text-gray-900 dark:text-white text-sm">${shift.name}</span>
              </div>
            </td>
            <td class="py-3 px-3">
              <span class="text-sm text-gray-600 dark:text-gray-400">${shift.startTime} - ${shift.endTime}</span>
            </td>
            <td class="py-3 px-3">
              <span class="text-sm text-gray-600 dark:text-gray-400">${shift.days}</span>
            </td>
            <td class="py-3 px-3">
              <span class="text-sm text-gray-600 dark:text-gray-400">${shift.drivers} drivers</span>
            </td>
            <td class="py-3 px-3">
              <span class="text-sm text-gray-600 dark:text-gray-400">${shift.vehicles} vehicles</span>
            </td>
            <td class="py-3 px-3">
              <div class="flex gap-1">
                <button class="text-blue-600 hover:text-blue-700 text-xs">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="text-red-600 hover:text-red-700 text-xs">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
        
        console.log('✅ Shift schedules rendered:', this.shifts.length, 'shifts');
      }

      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
        toast.className = `fixed top-20 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
    }
    
    // Alert feed functionality removed

    // Initial render
    function initDashboard() {
      // Show loading state immediately
      const loadingIndicator = document.getElementById('loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'flex';
      }
      
      // Initialize dashboard layout
      const grid = document.getElementById('analytics-grid');
      const widgets = Array.from(grid.children);
      grid.innerHTML = '';
      dashboardConfig.forEach(widgetId => {
        const widget = widgets.find(w => w.dataset.widget === widgetId);
        if (widget) grid.appendChild(widget);
      });
      
      // Render vehicles immediately (this will hide loading indicator)
      renderVehicleList(1, '', {}, true); // Skip heavy renders initially
      updateAnalytics();
      
      // Load heavy components after a short delay
      setTimeout(() => {
        renderUtilizationChart();
        // renderMap(vehicles.slice(0, 30)); // Disabled old map - using OpenLayers map instead
        }, 200);
      
      // Start real-time updates after everything is loaded
      setTimeout(() => {
        simulateRealTimeUpdates();
        // Initialize critical monitoring
        checkCriticalAlerts();
      }, 600);
    }
    
    // Ensure vehicles are initialized before dashboard
    console.log('🔄 Final check: vehicles before dashboard init:', vehicles ? vehicles.length : 'undefined');
    if (!vehicles || vehicles.length === 0) {
      console.log('🆘 CRITICAL: No vehicles at dashboard init, forcing emergency data...');
      vehicles = Array.from({ length: 15 }, (_, i) => ({
        id: `CRIT-${String(i + 1).padStart(3, '0')}`,
        driver: `Critical Driver ${i + 1}`,
        status: ['Driving', 'Idling', 'Parked'][i % 3],
        manufacturer: 'Emergency',
        model: 'Critical',
        plateNumber: `CRIT-${i + 1}`,
        year: 2023,
        lat: 31.9539,
        lng: 35.9106,
        health: { fuel: 80, mileage: 5000, maintenanceRisk: 'Low' },
        driverBehavior: { score: 90 },
        alerts: [],
        group: 'Critical',
        route: { eta: '12:00', distance: '5.0', currentSpeed: 60 },
        utilization: 85,
        lastPing: new Date().toLocaleTimeString()
      }));
      console.log('🆘 CRITICAL fallback created:', vehicles.length, 'vehicles');
    }
    
    initDashboard();
    
    // Initialize Vehicle Types & Shifts Manager
    console.log('🚛 Initializing Vehicle Types & Shifts Manager...');
    window.vehicleTypesShiftsManager = new VehicleTypesShiftsManager();
    window.vehicleTypesShiftsManager.init();
    

  </script>

  <!-- Fleet Map Widget Implementation -->
  <script>
    let vehiclesFleetMap;
    let vehiclesVectorSource;
    let vehiclesVectorLayer;
    let vehiclesClusterSource;
    let vehiclesOsmLayer;
    let vehiclesSatelliteLayer;
    let vehiclesIsSatelliteView = false;
    let vehiclesIsClusteringEnabled = true;

    // Generate route history for vehicles
    function generateRouteHistory() {
      const routes = [];
      const cities = ['Amman', 'Zarqa', 'Irbid', 'Aqaba', 'Madaba', 'Salt', 'Karak', 'Tafilah'];
      
      // Generate last 7 days of route history
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        
        const origin = cities[Math.floor(Math.random() * cities.length)];
        let destination;
        do {
          destination = cities[Math.floor(Math.random() * cities.length)];
        } while (destination === origin);
        
        routes.push({
          date: date.toLocaleDateString(),
          origin: origin,
          destination: destination,
          distance: Math.floor(Math.random() * 150) + 50, // 50-200 km
          duration: Math.floor(Math.random() * 3) + 1 + ' hours',
          fuelUsed: (Math.random() * 20 + 10).toFixed(1), // 10-30 L
          status: ['Completed', 'Completed', 'Completed', 'In Progress', 'Delayed'][Math.floor(Math.random() * 5)]
        });
      }
      
      return routes;
    }

    // Generate vehicle lifecycle timeline since onboarding
    function generateVehicleLifecycleTimeline() {
      const timeline = [];
      const cities = ['Amman', 'Zarqa', 'Irbid', 'Aqaba', 'Madada'];
      
      // Generate random onboarding date (within last 2 years)
      const onboardingDate = new Date();
      onboardingDate.setFullYear(onboardingDate.getFullYear() - Math.floor(Math.random() * 2) - 1);
      
      // Add onboarding event
      timeline.push({
        date: onboardingDate.toLocaleDateString(),
        type: 'onboarding',
        title: 'Vehicle Added to Platform',
        description: 'Vehicle successfully onboarded and integrated into fleet management system',
        status: 'completed',
        icon: 'fas fa-plus-circle',
        color: 'text-green-600',
        bgColor: 'bg-green-100'
      });
      
      // Add initial inspection (within 1 week of onboarding)
      const inspectionDate = new Date(onboardingDate);
      inspectionDate.setDate(inspectionDate.getDate() + Math.floor(Math.random() * 7) + 1);
      timeline.push({
        date: inspectionDate.toLocaleDateString(),
        type: 'inspection',
        title: 'Initial Vehicle Inspection',
        description: 'Comprehensive assessment completed. Overall condition: Good. Minor wear on tires, engine in excellent condition.',
        status: 'completed',
        icon: 'fas fa-clipboard-check',
        color: 'text-blue-600',
        bgColor: 'bg-blue-100',
        details: {
          condition: ['Excellent', 'Good', 'Fair'][Math.floor(Math.random() * 3)],
          photos: Math.floor(Math.random() * 5) + 3, // 3-7 photos
          issues: Math.random() > 0.7 ? ['Minor tire wear', 'Small scratch on rear bumper'] : [],
          recommendations: ['Schedule first service in 3 months', 'Monitor tire pressure']
        }
      });
      
      // Add registration events (every 1-2 years)
      let currentDate = new Date(inspectionDate);
      for (let i = 0; i < Math.floor(Math.random() * 3) + 1; i++) {
        currentDate.setFullYear(currentDate.getFullYear() + Math.floor(Math.random() * 2) + 1);
        const isPlateChange = Math.random() > 0.7;
        
        timeline.push({
          date: currentDate.toLocaleDateString(),
          type: 'registration',
          title: isPlateChange ? 'License Plate Change' : 'Registration Renewal',
          description: isPlateChange ? 
            `Plate changed from ${generatePlateNumber()} to ${generatePlateNumber()}` :
            'Annual registration renewed successfully',
          status: 'completed',
          icon: 'fas fa-id-card',
          color: 'text-purple-600',
          bgColor: 'bg-purple-100',
          details: {
            oldPlate: isPlateChange ? generatePlateNumber() : null,
            newPlate: isPlateChange ? generatePlateNumber() : null,
            cost: Math.floor(Math.random() * 200) + 50, // 50-250 JD
            office: cities[Math.floor(Math.random() * cities.length)] + ' Traffic Department'
          }
        });
      }
      
      // Add accidents (random occurrence, 10-30% chance)
      if (Math.random() < 0.25) {
        const accidentDate = new Date(onboardingDate);
        accidentDate.setDate(accidentDate.getDate() + Math.floor(Math.random() * 365) + 30);
        
        const accidentTypes = ['Minor Collision', 'Rear-end Accident', 'Side Impact', 'Parking Incident'];
        const accidentType = accidentTypes[Math.floor(Math.random() * accidentTypes.length)];
        const severity = ['Minor', 'Moderate', 'Major'][Math.floor(Math.random() * 3)];
        
        timeline.push({
          date: accidentDate.toLocaleDateString(),
          type: 'accident',
          title: `Vehicle Accident - ${accidentType}`,
          description: `${severity} accident occurred. ${severity === 'Minor' ? 'Minor damage, no injuries' : severity === 'Moderate' ? 'Moderate damage, minor injuries' : 'Significant damage, injuries reported'}`,
          status: 'completed',
          icon: 'fas fa-exclamation-triangle',
          color: 'text-red-600',
          bgColor: 'bg-red-100',
          details: {
            type: accidentType,
            severity: severity,
            location: cities[Math.floor(Math.random() * cities.length)],
            damage: severity === 'Minor' ? 'Scratches and dents' : severity === 'Moderate' ? 'Body damage, mechanical issues' : 'Extensive damage, frame affected',
            cost: severity === 'Minor' ? Math.floor(Math.random() * 500) + 100 : severity === 'Moderate' ? Math.floor(Math.random() * 2000) + 500 : Math.floor(Math.random() * 5000) + 2000,
            insurance: Math.random() > 0.5 ? 'Covered by insurance' : 'Out of pocket expense',
            policeReport: Math.random() > 0.3 ? 'Police report filed' : 'No police involvement'
          }
        });
      }
      
      // Sort timeline by date
      timeline.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      return timeline;
    }

    // Generate 100 fleet vehicles with specified distribution
    function generateVehiclesFleetVehicles() {
      const vehicles = [];
      const drivers = [
        'Ahmed Ali', 'Sara Hassan', 'Omar Khalil', 'Fatima Ahmad', 'Mohammed Saeed',
        'Layla Ibrahim', 'Yusuf Rahman', 'Nour Zayed', 'Khaled Mansour', 'Rania Nasser',
        'Tariq Saleh', 'Dina Khoury', 'Sami Qasem', 'Rana Farid', 'Adnan Ghazi',
        'Lina Hakim', 'Walid Jaber', 'Mona Shami', 'Basel Najjar', 'Aya Hamdan',
        'Fadi Barakat', 'Reem Othman', 'Hani Tawfik', 'Samar Hijazi', 'Nizar Karam'
      ];
      
      // Define status distribution: 61 active, 25 idling, 11 parked, 3 offline
      const statusConfig = [
        { status: 'active', count: 61, speedRange: [20, 80] },
        { status: 'idle', count: 25, speedRange: [0, 5] },
        { status: 'parked', count: 11, speedRange: [0, 0] },
        { status: 'offline', count: 3, speedRange: [0, 0] }
      ];
      
      let vehicleIndex = 1;
      
      statusConfig.forEach(config => {
        for (let i = 0; i < config.count; i++) {
          const lat = 31.9539 + (Math.random() - 0.5) * 0.1; // Spread around Amman
          const lng = 35.9106 + (Math.random() - 0.5) * 0.1;
          const driver = drivers[Math.floor(Math.random() * drivers.length)];
          const speed = Math.floor(Math.random() * (config.speedRange[1] - config.speedRange[0] + 1)) + config.speedRange[0];
          
          vehicles.push({
            id: `FL-${vehicleIndex.toString().padStart(3, '0')}`,
            lat: lat,
            lng: lng,
            status: config.status,
            driver: driver,
            speed: speed,
            // Enhanced vehicle information
            driverContact: `+962-${Math.floor(Math.random() * 90000000) + 10000000}`,
            heading: Math.floor(Math.random() * 360), // 0-359 degrees
            fuelLevel: Math.floor(Math.random() * 100), // 0-100%
            fuelRange: Math.floor(Math.random() * 200) + 100, // 100-300 km
            lastMaintenance: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toLocaleDateString(), // Within last 90 days
            engineHours: Math.floor(Math.random() * 5000) + 1000, // 1000-6000 hours
            mileage: Math.floor(Math.random() * 100000) + 50000, // 50,000-150,000 km
            currentTrip: {
              origin: ['Amman', 'Zarqa', 'Irbid', 'Aqaba', 'Madaba'][Math.floor(Math.random() * 5)],
              destination: ['Amman', 'Zarqa', 'Irbid', 'Aqaba', 'Madaba'][Math.floor(Math.random() * 5)],
              startTime: new Date(Date.now() - Math.random() * 4 * 60 * 60 * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
              estimatedDuration: Math.floor(Math.random() * 3) + 1 + ' hours'
            },
            // Route history data (simulated)
            routeHistory: generateRouteHistory(),
            // Vehicle lifecycle timeline since onboarding
            lifecycleTimeline: generateVehicleLifecycleTimeline()
          });
          
          vehicleIndex++;
        }
      });
      
      return vehicles;
    }
    
    const vehiclesFleetVehicles = generateVehiclesFleetVehicles();

    // Convert map vehicle data to vehicle list format
    function convertMapVehiclesToListFormat(mapVehicles) {
      return mapVehicles.map(vehicle => {
        // Map status names to match vehicle list expectations
        const statusMap = {
          'active': 'Driving',
          'idle': 'Idling', 
          'parked': 'Parked',
          'offline': 'Offline'
        };

        // Generate additional data for vehicle list
        const manufacturers = ['Ford', 'Mercedes-Benz', 'Volkswagen', 'Iveco', 'MAN', 'Volvo', 'Scania'];
        const models = {
          'Ford': ['Transit', 'E-Series', 'F-150', 'Ranger'],
          'Mercedes-Benz': ['Sprinter', 'Vito', 'Actros', 'Atego'],
          'Volkswagen': ['Crafter', 'Caddy', 'Amarok', 'Transporter'],
          'Iveco': ['Daily', 'Eurocargo', 'Stralis'],
          'MAN': ['TGE', 'TGM', 'TGS'],
          'Volvo': ['FH', 'FM', 'FE'],
          'Scania': ['P-Series', 'G-Series', 'R-Series']
        };

        const manufacturer = manufacturers[Math.floor(Math.random() * manufacturers.length)];
        const model = models[manufacturer][Math.floor(Math.random() * models[manufacturer].length)];
        const plateNumber = generatePlateNumber();

        return {
          id: vehicle.id,
          driver: vehicle.driver,
          status: statusMap[vehicle.status] || 'Unknown',
          manufacturer: manufacturer,
          model: model,
          year: 2020 + Math.floor(Math.random() * 4), // 2020-2023
          plateNumber: plateNumber,
          health: {
            fuel: Math.floor(Math.random() * 100),
            engine: Math.floor(Math.random() * 100),
            tires: Math.floor(Math.random() * 100),
            battery: Math.floor(Math.random() * 100),
            maintenanceRisk: ['Low', 'Medium', 'High'][Math.floor(Math.random() * 3)]
          },
          driverBehavior: {
            score: Math.floor(Math.random() * 30) + 70, // 70-100
            violations: Math.floor(Math.random() * 5),
            safetyRating: ['Excellent', 'Good', 'Average', 'Poor'][Math.floor(Math.random() * 4)],
            weeklyTrend: ['improving', 'declining', 'stable'][Math.floor(Math.random() * 3)]
          },
          route: {
            currentSpeed: vehicle.speed,
            speedLimit: Math.floor(Math.random() * 20) + 50, // 50-70 km/h
            fuelConsumption: (Math.random() * 5 + 8).toFixed(1), // 8-13 L/100km
            eta: new Date(Date.now() + Math.random() * 7200000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) // ETA within 2 hours
          },
          alerts: generateVehicleAlerts(vehicle.status),
          group: 'Fleet Group ' + Math.ceil(Math.floor(Math.random() * 5) + 1),
          speed: vehicle.speed,
          lat: vehicle.lat,
          lng: vehicle.lng,
          lastPing: new Date(Date.now() - Math.floor(Math.random() * 300000)).toLocaleTimeString(), // Within last 5 minutes
          lastUpdate: new Date(Date.now() - Math.floor(Math.random() * 3600000)).toISOString(), // Random within last hour
          utilization: Array(7).fill(0).map(() => Math.floor(Math.random() * 8) + 2) // 2-10 hours per day
        };
      });
    }

    // Generate realistic alerts based on vehicle status
    function generateVehicleAlerts(status) {
      const alerts = [];
      if (status === 'offline') {
        alerts.push('Vehicle Offline');
      } else if (status === 'idle') {
        if (Math.random() < 0.3) alerts.push('Excessive Idling');
      } else if (status === 'active') {
        if (Math.random() < 0.1) alerts.push('Speed Limit Exceeded');
        if (Math.random() < 0.05) alerts.push('Harsh Braking');
      }
      if (Math.random() < 0.15) alerts.push('Low Fuel');
      if (Math.random() < 0.05) alerts.push('Maintenance Due');
      return alerts;
    }

    // Create global vehicles array from map data
    vehicles = convertMapVehiclesToListFormat(vehiclesFleetVehicles);
    window.vehicles = vehicles; // Also make it available globally

    // Function to find vehicle on map from list
    function locateVehicleOnMap(vehicleId) {
      const vehicle = vehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        if (window.vehiclesPageMap && window.vehiclesPageMap.map) {
          // Center map on vehicle using OpenLayers
          window.vehiclesPageMap.map.getView().animate({
            center: ol.proj.fromLonLat([vehicle.lng, vehicle.lat]),
            zoom: 16,
            duration: 1000
          });
          showToast(`Located ${vehicleId} on map`, 'success');
        } else {
          showToast(`Vehicle ${vehicleId} location: ${vehicle.lat.toFixed(4)}, ${vehicle.lng.toFixed(4)}`, 'info');
        }
        
        console.log(`🗺️ Located vehicle ${vehicleId} on map`);
        
        // Optionally show a temporary highlight or popup
        const popup = document.getElementById('vehicles-popup');
        if (popup) {
          popup.style.display = 'none'; // Hide any existing popup first
        }
      }
    }

    // Function to refresh both map and list data
    function refreshVehicleData() {
      // Regenerate vehicle data (in a real app, this would fetch from API)
      const newMapVehicles = generateVehiclesFleetVehicles();
      const newListVehicles = convertMapVehiclesToListFormat(newMapVehicles);
      
      // Update map
      if (vehiclesVectorSource) {
        addVehiclesVehicleMarkers();
      }
      
      // Update list
      renderVehicleList();
      
      console.log('🔄 Vehicle data refreshed - Map and List synchronized');
    }

    // Initialize OpenLayers Map for Vehicles Page
    function initVehiclesOpenLayersMap() {
      console.log('🗺️ Initializing Vehicles Page OpenLayers Fleet Map...');
      
      // Check if container exists
      const container = document.getElementById('vehicles-fleet-map-container');
      if (!container) {
        console.error('❌ Map container not found!');
        return;
      }

      // Create vector source for vehicle markers
      vehiclesVectorSource = new ol.source.Vector();

      // Create clustering source
      vehiclesClusterSource = new ol.source.Cluster({
        distance: 40,
        source: vehiclesVectorSource
      });

      // Create style function for vehicle markers
      const vehicleStyleFunction = function(feature) {
        const features = feature.get('features');
        const size = features.length;

        if (size > 1) {
          // Cluster style
          return new ol.style.Style({
            image: new ol.style.Circle({
              radius: Math.min(size * 2 + 15, 30),
              fill: new ol.style.Fill({ color: 'rgba(59, 130, 246, 0.8)' }),
              stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
            }),
            text: new ol.style.Text({
              text: size.toString(),
              fill: new ol.style.Fill({ color: '#fff' }),
              font: 'bold 12px Arial'
            })
          });
        } else {
          // Single vehicle style
          const vehicle = features[0].get('vehicleData');
          const colors = {
            'active': '#16a34a',
            'idle': '#eab308', 
            'parked': '#3b82f6',
            'offline': '#dc2626'
          };

          return new ol.style.Style({
            image: new ol.style.Circle({
              radius: 8,
              fill: new ol.style.Fill({ color: colors[vehicle.status] || '#6b7280' }),
              stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
            }),
            text: new ol.style.Text({
              text: '🚗',
              offsetY: -20,
              font: '14px Arial'
            })
          });
        }
      };

      // Create vector layer
      vehiclesVectorLayer = new ol.layer.Vector({
        source: vehiclesClusterSource,
        style: vehicleStyleFunction,
        title: 'Fleet Vehicles'
      });

      // Create base layers
      vehiclesOsmLayer = new ol.layer.Tile({
        source: new ol.source.OSM(),
        title: 'OpenStreetMap'
      });

      vehiclesSatelliteLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
          attributions: ['Powered by Esri']
        }),
        visible: false,
        title: 'Satellite'
      });

      // Initialize map
      vehiclesFleetMap = new ol.Map({
        target: 'vehicles-fleet-map-container',
        layers: [vehiclesOsmLayer, vehiclesSatelliteLayer, vehiclesVectorLayer],
        view: new ol.View({
          center: ol.proj.fromLonLat([35.9106, 31.9539]), // Amman, Jordan
          zoom: 12,
          maxZoom: 18
        }),
        controls: [
          new ol.control.Attribution(),
          new ol.control.Zoom()
        ]
      });

      // Add vehicle markers
      addVehiclesVehicleMarkers();

      // Set up event handlers
      setupVehiclesMapEventHandlers();

      // Force map to render
      setTimeout(() => {
        vehiclesFleetMap.updateSize();
        console.log('🔄 Vehicles Map size updated');
        
        // Update map statistics
        updateVehiclesMapStatistics();
        
        // Now that map is ready, ensure vehicle list is rendered
        if (vehicles && vehicles.length > 0) {
          console.log('🚗 Rendering vehicle list after map initialization');
          renderVehicleList();
        }
      }, 100);
      
      console.log('✅ Vehicles Page OpenLayers Fleet Map initialized successfully');
    }

    // Add vehicle markers to the map
    function addVehiclesVehicleMarkers() {
      // Clear existing features
      vehiclesVectorSource.clear();

      vehiclesFleetVehicles.forEach(vehicle => {
        const feature = new ol.Feature({
          geometry: new ol.geom.Point(ol.proj.fromLonLat([vehicle.lng, vehicle.lat])),
          vehicleData: vehicle,
          status: vehicle.status
        });

        vehiclesVectorSource.addFeature(feature);
      });
    }

    // Setup map event handlers
    function setupVehiclesMapEventHandlers() {
      // Create popup overlay
      const popup = document.createElement('div');
      popup.id = 'vehicles-popup';
      popup.style.cssText = `
        position: absolute;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 12px;
        display: none;
        max-width: 280px;
        font-family: Inter, sans-serif;
        font-size: 14px;
        z-index: 1000;
        border: 1px solid #e5e7eb;
      `;
      document.body.appendChild(popup);

      const overlay = new ol.Overlay({
        element: popup,
        positioning: 'bottom-center',
        stopEvent: false,
        offset: [0, -10]
      });
      vehiclesFleetMap.addOverlay(overlay);

      // Add click handler to show popups
      vehiclesFleetMap.on('click', function(evt) {
        const feature = vehiclesFleetMap.forEachFeatureAtPixel(evt.pixel, function(feature) {
          return feature;
        });

        if (feature) {
          const features = feature.get('features');
          const coordinate = feature.getGeometry().getCoordinates();
          
          if (features.length === 1) {
            // Single vehicle popup
            const vehicle = features[0].get('vehicleData');
            const statusColors = {
              'active': '#16a34a',
              'idle': '#eab308',
              'parked': '#3b82f6', 
              'offline': '#dc2626'
            };

            popup.innerHTML = `
              <div style="border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; margin-bottom: 8px;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${vehicle.id}</div>
                <div style="display: flex; align-items: center; margin-bottom: 4px;">
                  <div style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColors[vehicle.status]}; margin-right: 6px;"></div>
                  <span style="color: #6b7280; text-transform: capitalize;">${vehicle.status}</span>
                </div>
              </div>
              <div style="margin-bottom: 8px;">
                <div style="color: #6b7280; margin-bottom: 2px;">Driver: <span style="color: #1f2937; font-weight: 500;">${vehicle.driver}</span></div>
                <div style="color: #6b7280;">Speed: <span style="color: #1f2937; font-weight: 500;">${vehicle.speed} km/h</span></div>
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="trackVehicleOnMap('${vehicle.id}')" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">Track</button>
                <button onclick="showVehicleInfo('${vehicle.id}')" style="background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">Details</button>
              </div>
            `;
            
            popup.style.display = 'block';
            overlay.setPosition(coordinate);
          } else {
            // Cluster popup
            popup.innerHTML = `
              <div style="text-align: center;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 8px;">${features.length} Vehicles</div>
                <button onclick="zoomToCluster(${coordinate[0]}, ${coordinate[1]})" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Zoom In</button>
              </div>
            `;
            
            popup.style.display = 'block';
            overlay.setPosition(coordinate);
          }
        } else {
          popup.style.display = 'none';
        }
      });

      // Hide popup when clicking elsewhere
      vehiclesFleetMap.on('pointermove', function(evt) {
        const feature = vehiclesFleetMap.forEachFeatureAtPixel(evt.pixel, function(feature) {
          return feature;
        });
        vehiclesFleetMap.getTargetElement().style.cursor = feature ? 'pointer' : '';
      });

      // Control button handlers
      document.getElementById('vehicles-center-map').addEventListener('click', centerVehiclesOnFleet);
      document.getElementById('vehicles-toggle-satellite').addEventListener('click', toggleVehiclesSatelliteView);
      document.getElementById('vehicles-toggle-clustering').addEventListener('click', toggleVehiclesClustering);
      document.getElementById('vehicles-create-geofence').addEventListener('click', createVehiclesGeofence);
      document.getElementById('vehicles-refresh-map').addEventListener('click', refreshVehiclesMap);
      document.getElementById('vehicles-clear-geofences').addEventListener('click', clearVehiclesGeofences);
    }

    // Center map on fleet
    function centerVehiclesOnFleet() {
      if (vehiclesFleetVehicles.length === 0) return;
      
      const extent = vehiclesVectorSource.getExtent();
      if (extent.every(coord => coord !== Infinity && coord !== -Infinity)) {
        vehiclesFleetMap.getView().fit(extent, {
          padding: [50, 50, 50, 50],
          maxZoom: 15
        });
      }
    }

    // Toggle satellite view
    function toggleVehiclesSatelliteView() {
      vehiclesIsSatelliteView = !vehiclesIsSatelliteView;
      const button = document.getElementById('vehicles-toggle-satellite');
      
      if (vehiclesIsSatelliteView) {
        vehiclesOsmLayer.setVisible(false);
        vehiclesSatelliteLayer.setVisible(true);
        button.classList.remove('bg-white', 'text-gray-700');
        button.classList.add('bg-green-600', 'text-white');
      } else {
        vehiclesOsmLayer.setVisible(true);
        vehiclesSatelliteLayer.setVisible(false);
        button.classList.remove('bg-green-600', 'text-white');
        button.classList.add('bg-white', 'text-gray-700');
      }
    }

    // Track vehicle function
    function trackVehicleOnMap(vehicleId) {
      const vehicle = vehiclesFleetVehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        vehiclesFleetMap.getView().animate({
          center: ol.proj.fromLonLat([vehicle.lng, vehicle.lat]),
          zoom: 16,
          duration: 1000
        });
        
        // Hide popup
        const popup = document.getElementById('vehicles-popup');
        if (popup) {
          popup.style.display = 'none';
        }
      }
    }

    // Show vehicle info function
    function showVehicleInfo(vehicleId) {
      const vehicle = vehiclesFleetVehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        // Update modal title
        document.getElementById('vehicle-info-title').textContent = `Vehicle ${vehicle.id} Information`;
        
        // Populate vehicle info content
        const content = document.getElementById('vehicle-info-content');
        content.innerHTML = `
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Basic Information -->
            <div class="space-y-4">
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                  <i class="fas fa-info-circle text-blue-600"></i>
                  Basic Information
                </h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Vehicle ID:</span>
                    <span class="font-medium">${vehicle.id}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Status:</span>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                      vehicle.status === 'active' ? 'bg-green-100 text-green-800' :
                      vehicle.status === 'idle' ? 'bg-yellow-100 text-yellow-800' :
                      vehicle.status === 'parked' ? 'bg-blue-100 text-blue-800' :
                      'bg-red-100 text-red-800'
                    }">${vehicle.status}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Current Speed:</span>
                    <span class="font-medium">${vehicle.speed} km/h</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Heading:</span>
                    <span class="font-medium">${vehicle.heading}°</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Location:</span>
                    <span class="font-medium">${vehicle.lat ? vehicle.lat.toFixed(4) : 'N/A'}, ${vehicle.lng ? vehicle.lng.toFixed(4) : 'N/A'}</span>
                  </div>
                </div>
              </div>

              <!-- Driver Information -->
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                  <i class="fas fa-user text-green-600"></i>
                  Driver Information
                </h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Driver Name:</span>
                    <span class="font-medium">${vehicle.driver}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Contact:</span>
                    <span class="font-medium">${vehicle.driverContact}</span>
                  </div>
                </div>
              </div>

              <!-- Fuel Information -->
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                  <i class="fas fa-gas-pump text-orange-600"></i>
                  Fuel Information
                </h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Fuel Level:</span>
                    <span class="font-medium">${vehicle.fuelLevel}%</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Range:</span>
                    <span class="font-medium">${vehicle.fuelRange} km</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-4">
              <!-- Maintenance Information -->
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                  <i class="fas fa-tools text-purple-600"></i>
                  Maintenance Information
                </h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Last Maintenance:</span>
                    <span class="font-medium">${vehicle.lastMaintenance}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Engine Hours:</span>
                    <span class="font-medium">${vehicle.engineHours ? vehicle.engineHours.toLocaleString() : 'N/A'}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Mileage:</span>
                    <span class="font-medium">${vehicle.mileage ? vehicle.mileage.toLocaleString() : 'N/A'} km</span>
                  </div>
                </div>
              </div>

              <!-- Current Trip -->
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                  <i class="fas fa-route text-indigo-600"></i>
                  Current Trip
                </h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Origin:</span>
                    <span class="font-medium">${vehicle.currentTrip.origin}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Destination:</span>
                    <span class="font-medium">${vehicle.currentTrip.destination}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Start Time:</span>
                    <span class="font-medium">${vehicle.currentTrip.startTime}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Duration:</span>
                    <span class="font-medium">${vehicle.currentTrip.estimatedDuration}</span>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                  <i class="fas fa-cogs text-gray-600"></i>
                  Actions
                </h4>
                <div class="space-y-3">
                  <button onclick="showVehicleLifecycle('${vehicle.id}')" 
                          class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-history"></i>
                    Vehicle Lifecycle
                  </button>
                  <button onclick="showVehicleRouteHistory('${vehicle.id}')" 
                          class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-route"></i>
                    View Route History
                  </button>
                  <button onclick="centerMapOnVehicle('${vehicle.id}')" 
                          class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-crosshairs"></i>
                    Center on Map
                  </button>
                  <button onclick="sendMessageToDriver('${vehicle.id}')" 
                          class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-comment"></i>
                    Send Message
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Close All Button -->
          <div class="mt-6 pt-4 border-t border-gray-200">
            <button onclick="closeAllVehicleModals()" 
                    class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
              <i class="fas fa-times"></i>
              Close All
            </button>
          </div>
        `;
        
        // Show modal
        document.getElementById('vehicle-info-modal').classList.remove('hidden');
        
        // Hide popup
        const popup = document.getElementById('vehicles-popup');
        if (popup) {
          popup.style.display = 'none';
        }
      }
    }

    // Show vehicle lifecycle timeline
    function showVehicleLifecycle(vehicleId) {
      const vehicle = vehiclesFleetVehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        // Update modal title
        document.getElementById('lifecycle-title').textContent = `Vehicle Lifecycle - ${vehicle.id}`;
        
        // Populate lifecycle content
        const content = document.getElementById('lifecycle-content');
        content.innerHTML = `
          <div class="mb-6">
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
              <h4 class="font-semibold text-indigo-900 mb-2">Vehicle Summary</h4>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <span class="text-indigo-600 font-medium">Vehicle ID:</span>
                  <p class="text-indigo-900">${vehicle.id}</p>
                </div>
                <div>
                  <span class="text-indigo-600 font-medium">Driver:</span>
                  <p class="text-indigo-900">${vehicle.driver}</p>
                </div>
                <div>
                  <span class="text-indigo-600 font-medium">Total Events:</span>
                  <p class="text-indigo-900">${vehicle.lifecycleTimeline.length}</p>
                </div>
                <div>
                  <span class="text-indigo-600 font-medium">Platform Age:</span>
                  <p class="text-indigo-900">${Math.floor((new Date() - new Date(vehicle.lifecycleTimeline[0]?.date)) / (1000 * 60 * 60 * 24))} days</p>
                </div>
              </div>
            </div>
          </div>

          <div class="space-y-4">
            ${vehicle.lifecycleTimeline.map((event, index) => `
              <div class="flex items-start space-x-4">
                <!-- Timeline connector -->
                <div class="flex flex-col items-center">
                  <div class="w-10 h-10 rounded-full ${event.bgColor} flex items-center justify-center">
                    <i class="${event.icon} ${event.color}"></i>
                  </div>
                  ${index < vehicle.lifecycleTimeline.length - 1 ? '<div class="w-0.5 h-16 bg-gray-300 mt-2"></div>' : ''}
                </div>
                
                <!-- Event content -->
                <div class="flex-1 bg-gray-50 rounded-lg p-4">
                  <div class="flex items-center justify-between mb-2">
                    <h5 class="font-semibold text-gray-900">${event.title}</h5>
                    <span class="text-sm text-gray-500">${event.date}</span>
                  </div>
                  <p class="text-gray-600 mb-3">${event.description}</p>
                  
                  ${event.details ? `
                    <div class="bg-white rounded border p-3 space-y-2">
                      ${event.type === 'inspection' ? `
                        <div class="grid grid-cols-2 gap-4 text-sm">
                          <div><span class="font-medium text-gray-700">Condition:</span> ${event.details.condition}</div>
                          <div><span class="font-medium text-gray-700">Photos:</span> ${event.details.photos}</div>
                          ${event.details.issues.length > 0 ? `
                            <div class="col-span-2"><span class="font-medium text-gray-700">Issues:</span> ${event.details.issues.join(', ')}</div>
                          ` : ''}
                          <div class="col-span-2"><span class="font-medium text-gray-700">Recommendations:</span> ${event.details.recommendations.join(', ')}</div>
                        </div>
                      ` : event.type === 'registration' ? `
                        <div class="grid grid-cols-2 gap-4 text-sm">
                          ${event.details.oldPlate ? `<div><span class="font-medium text-gray-700">Old Plate:</span> ${event.details.oldPlate}</div>` : ''}
                          ${event.details.newPlate ? `<div><span class="font-medium text-gray-700">New Plate:</span> ${event.details.newPlate}</div>` : ''}
                          <div><span class="font-medium text-gray-700">Cost:</span> ${event.details.cost} JD</div>
                          <div><span class="font-medium text-gray-700">Office:</span> ${event.details.office}</div>
                        </div>
                      ` : event.type === 'accident' ? `
                        <div class="grid grid-cols-2 gap-4 text-sm">
                          <div><span class="font-medium text-gray-700">Type:</span> ${event.details.type}</div>
                          <div><span class="font-medium text-gray-700">Severity:</span> ${event.details.severity}</div>
                          <div><span class="font-medium text-gray-700">Location:</span> ${event.details.location}</div>
                          <div><span class="font-medium text-gray-700">Damage:</span> ${event.details.damage}</div>
                          <div><span class="font-medium text-gray-700">Cost:</span> ${event.details.cost} JD</div>
                          <div><span class="font-medium text-gray-700">Insurance:</span> ${event.details.insurance}</div>
                          <div class="col-span-2"><span class="font-medium text-gray-700">Police Report:</span> ${event.details.policeReport}</div>
                        </div>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>

          <div class="mt-6 flex justify-center">
            <button onclick="exportLifecycleHistory('${vehicle.id}')" 
                    class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2">
              <i class="fas fa-download"></i>
              Export Lifecycle History
            </button>
          </div>
        `;
        
        // Hide vehicle info modal and show lifecycle modal
        document.getElementById('vehicle-info-modal').classList.add('hidden');
        document.getElementById('vehicle-lifecycle-modal').classList.remove('hidden');
        
        // Store reference to return to vehicle info
        window.currentVehicleId = vehicleId;
      }
    }

    // Back to vehicle info function
    function backToVehicleInfo() {
      if (window.currentVehicleId) {
        // Hide current modal
        document.getElementById('vehicle-lifecycle-modal').classList.add('hidden');
        document.getElementById('vehicle-route-history-modal').classList.add('hidden');
        
        // Show vehicle info modal again
        document.getElementById('vehicle-info-modal').classList.remove('hidden');
      }
    }

    // Close all vehicle modals function
    function closeAllVehicleModals() {
      document.getElementById('vehicle-info-modal').classList.add('hidden');
      document.getElementById('vehicle-lifecycle-modal').classList.add('hidden');
      document.getElementById('vehicle-route-history-modal').classList.add('hidden');
      
      // Clear current vehicle reference
      delete window.currentVehicleId;
      
      showActionNotification('All vehicle modals closed', 'info');
    }

    // Show vehicle route history
    function showVehicleRouteHistory(vehicleId) {
      const vehicle = vehiclesFleetVehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        // Update modal title
        document.getElementById('route-history-title').textContent = `Route History - ${vehicle.id}`;
        
        // Populate route history content
        const content = document.getElementById('route-history-content');
        content.innerHTML = `
          <div class="mb-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h4 class="font-semibold text-blue-900 mb-2">Vehicle Summary</h4>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <span class="text-blue-600 font-medium">Driver:</span>
                  <p class="text-blue-900">${vehicle.driver}</p>
                </div>
                <div>
                  <span class="text-blue-600 font-medium">Total Routes:</span>
                  <p class="text-blue-900">${vehicle.routeHistory ? vehicle.routeHistory.length : 0}</p>
                </div>
                <div>
                  <span class="text-blue-600 font-medium">Total Distance:</span>
                  <p class="text-blue-900">${vehicle.routeHistory ? vehicle.routeHistory.reduce((sum, route) => sum + (route.distance || 0), 0) : 0} km</p>
                </div>
                <div>
                  <span class="text-blue-600 font-medium">Total Fuel Used:</span>
                  <p class="text-blue-900">${vehicle.routeHistory ? vehicle.routeHistory.reduce((sum, route) => sum + parseFloat(route.fuelUsed || 0), 0).toFixed(1) : 'N/A'} L</p>
                </div>
              </div>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Origin</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destination</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Distance</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fuel Used</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                ${vehicle.routeHistory.map(route => `
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">${route.date}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${route.origin}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${route.destination}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${route.distance} km</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${route.duration}</td>
                    <td class="px-4 py-3 text-sm text-sm text-gray-900">${route.fuelUsed} L</td>
                    <td class="px-4 py-3">
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                        route.status === 'Completed' ? 'bg-green-100 text-green-800' :
                        route.status === 'In Progress' ? 'bg-blue-100 text-blue-800' :
                        'bg-yellow-100 text-yellow-800'
                      }">${route.status}</span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>

          <div class="mt-6 flex justify-center">
            <button onclick="exportRouteHistory('${vehicle.id}')" 
                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
              <i class="fas fa-download"></i>
              Export Route History
            </button>
          </div>
        `;
        
        // Hide vehicle info modal and show route history modal
        document.getElementById('vehicle-info-modal').classList.add('hidden');
        document.getElementById('vehicle-route-history-modal').classList.remove('hidden');
        
        // Store reference to return to vehicle info
        window.currentVehicleId = vehicleId;
      }
    }

    // Center map on specific vehicle
    function centerMapOnVehicle(vehicleId) {
      const vehicle = vehiclesFleetVehicles.find(v => v.id === vehicleId);
      if (vehicle && vehiclesFleetMap) {
        const coordinate = [vehicle.lng, vehicle.lat];
        vehiclesFleetMap.getView().animate({
          center: coordinate,
          zoom: 15,
          duration: 1000
        });
        
        showActionNotification(`Map centered on ${vehicle.id}`, 'success');
      }
    }

    // Send message to driver
    function sendMessageToDriver(vehicleId) {
      const vehicle = vehiclesFleetVehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        const message = prompt(`Send message to ${vehicle.driver} (${vehicle.id}):`);
        if (message) {
          showActionNotification(`Message sent to ${vehicle.driver}: "${message}"`, 'success');
          console.log(`Message to ${vehicle.driver} (${vehicle.id}): ${message}`);
        }
      }
    }

    // Export route history
    function exportRouteHistory(vehicleId) {
      const vehicle = vehiclesFleetVehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        const csvContent = [
          ['Date', 'Origin', 'Destination', 'Distance (km)', 'Duration', 'Fuel Used (L)', 'Status'],
          ...vehicle.routeHistory.map(route => [
            route.date,
            route.origin,
            route.destination,
            route.distance,
            route.duration,
            route.fuelUsed,
            route.status
          ])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `route-history-${vehicle.id}-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showActionNotification(`Route history exported for ${vehicle.id}`, 'success');
      }
    }

    // Export lifecycle history
    function exportLifecycleHistory(vehicleId) {
      const vehicle = vehiclesFleetVehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        const csvContent = [
          ['Date', 'Event Type', 'Title', 'Description', 'Status', 'Details'],
          ...vehicle.lifecycleTimeline.map(event => [
            event.date,
            event.type,
            event.title,
            event.description,
            event.status,
            event.details ? JSON.stringify(event.details) : ''
          ])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lifecycle-history-${vehicle.id}-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showActionNotification(`Lifecycle history exported for ${vehicle.id}`, 'success');
      }
    }

    // Toggle clustering for vehicles map
    function toggleVehiclesClustering() {
      if (vehiclesFleetMap && vehiclesClusterSource && vehiclesVectorSource) {
        const button = document.getElementById('vehicles-toggle-clustering');
        if (button) {
          if (button.classList.contains('bg-green-600')) {
            // Disable clustering
            vehiclesVectorLayer.setSource(vehiclesVectorSource);
            button.classList.remove('bg-green-600', 'text-white');
            button.classList.add('bg-white', 'text-gray-700');
            button.title = 'Enable Clustering';
            console.log('✅ Clustering disabled - showing individual vehicles');
          } else {
            // Enable clustering
            vehiclesVectorLayer.setSource(vehiclesClusterSource);
            button.classList.remove('bg-white', 'text-gray-700');
            button.classList.add('bg-green-600', 'text-white');
            button.title = 'Disable Clustering';
            console.log('✅ Clustering enabled - grouping nearby vehicles');
          }
        }
      } else {
        console.log('Clustering not available - OpenLayers map not initialized');
      }
    }

    // Create geofence for vehicles map
    function createVehiclesGeofence() {
      if (vehiclesFleetMap) {
        const button = document.getElementById('vehicles-create-geofence');
        if (button) {
          button.classList.remove('bg-white', 'text-gray-700');
          button.classList.add('bg-orange-600', 'text-white');
          button.title = 'Creating Geofence...';
          
          // Show instruction to user
          showActionNotification('Click on the map to start drawing geofence. Right-click to finish.', 'info');
          
          // Enable geofence drawing mode
          enableGeofenceDrawing();
          
          // Reset button after 5 seconds
          setTimeout(() => {
            button.classList.remove('bg-orange-600', 'text-white');
            button.classList.add('bg-white', 'text-gray-700');
            button.title = 'Create Geofence';
          }, 5000);
        }
      }
    }

    // Clear all geofences
    function clearVehiclesGeofences() {
      if (window.vehiclesGeofences && window.vehiclesGeofences.length > 0) {
        // Remove all geofence layers from map
        window.vehiclesGeofences.forEach(geofence => {
          if (geofence.layer && vehiclesFleetMap) {
            vehiclesFleetMap.removeLayer(geofence.layer);
          }
        });
        
        // Clear the array
        window.vehiclesGeofences = [];
        
        showActionNotification('All geofences cleared successfully! 🗑️', 'success');
        console.log('✅ All geofences cleared from vehicles map');
      } else {
        showActionNotification('No geofences to clear.', 'info');
      }
    }

    // Enable geofence drawing mode
    function enableGeofenceDrawing() {
      if (!vehiclesFleetMap) return;
      
      let geofencePoints = [];
      let geofenceLayer = null;
      
      // Change cursor to crosshair
      vehiclesFleetMap.getTargetElement().style.cursor = 'crosshair';
      
      // Add click handler for drawing
      const clickHandler = function(evt) {
        const coordinate = evt.coordinate;
        geofencePoints.push(coordinate);
        
        if (geofencePoints.length === 1) {
          // First point - create line feature
          const lineString = new ol.geom.LineString(geofencePoints);
          const lineFeature = new ol.Feature(lineString);
          
          geofenceLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
              features: [lineFeature]
            }),
            style: new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: '#f59e0b',
                width: 3,
                lineDash: [5, 5]
              })
            })
          });
          
          vehiclesFleetMap.addLayer(geofenceLayer);
        } else {
          // Update line with new point
          const lineString = new ol.geom.LineString(geofencePoints);
          geofenceLayer.getSource().getFeatures()[0].setGeometry(lineString);
        }
        
        // Show instruction
        if (geofencePoints.length < 3) {
          showActionNotification(`Point ${geofencePoints.length} added. Click to add more points or right-click to finish.`, 'info');
        } else {
          showActionNotification(`Point ${geofencePoints.length} added. Right-click to finish geofence.`, 'info');
        }
      };
      
      // Add right-click handler to finish geofence
      const rightClickHandler = function(evt) {
        evt.preventDefault();
        
        if (geofencePoints.length >= 3) {
          // Create closed polygon
          geofencePoints.push(geofencePoints[0]); // Close the polygon
          const polygon = new ol.geom.Polygon([geofencePoints]);
          const polygonFeature = new ol.Feature(polygon);
          
          // Replace line with polygon
          vehiclesFleetMap.removeLayer(geofenceLayer);
          
          const finalGeofenceLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
              features: [polygonFeature]
            }),
            style: new ol.style.Style({
              fill: new ol.style.Fill({
                color: 'rgba(245, 158, 11, 0.2)'
              }),
              stroke: new ol.style.Stroke({
                color: '#f59e0b',
                width: 2
              })
            })
          });
          
          vehiclesFleetMap.addLayer(finalGeofenceLayer);
          
          // Reset drawing mode
          vehiclesFleetMap.getTargetElement().style.cursor = 'default';
          vehiclesFleetMap.un('click', clickHandler);
          vehiclesFleetMap.un('contextmenu', rightClickHandler);
          
          showActionNotification('Geofence created successfully! 🛡️', 'success');
          
          // Store geofence for later use
          if (!window.vehiclesGeofences) window.vehiclesGeofences = [];
          const geofenceId = window.vehiclesGeofences.length + 1;
          window.vehiclesGeofences.push({
            id: geofenceId,
            layer: finalGeofenceLayer,
            points: geofencePoints,
            name: `Geofence ${geofenceId}`,
            rules: null // Will be set when rules are configured
          });

          // Show geofence rules configuration modal
          showGeofenceRulesModal(geofenceId, finalGeofenceLayer, geofencePoints);
        } else {
          showActionNotification('Need at least 3 points to create a geofence. Continue clicking.', 'warning');
        }
      };
      
      // Add event listeners
      vehiclesFleetMap.on('click', clickHandler);
      vehiclesFleetMap.on('contextmenu', rightClickHandler);
      
      // Add escape key handler to cancel
      const escapeHandler = function(e) {
        if (e.key === 'Escape') {
          vehiclesFleetMap.getTargetElement().style.cursor = 'default';
          vehiclesFleetMap.un('click', clickHandler);
          vehiclesFleetMap.un('contextmenu', rightClickHandler);
          document.removeEventListener('keydown', escapeHandler);
          
          if (geofenceLayer) {
            vehiclesFleetMap.removeLayer(geofenceLayer);
          }
          
          showActionNotification('Geofence creation cancelled.', 'info');
        }
      };
      
      document.addEventListener('keydown', escapeHandler);
    }

    // Show geofence rules configuration modal
    function showGeofenceRulesModal(geofenceId, geofenceLayer, geofencePoints) {
      const modal = document.getElementById('geofence-rules-modal');
      const nameInput = document.getElementById('geofence-name');
      const form = document.getElementById('geofence-rules-form');
      
      // Set default name
      nameInput.value = `Geofence ${geofenceId}`;
      
      // Store only essential geofence data (avoid circular references)
      form.dataset.geofenceId = geofenceId;
      form.dataset.geofencePoints = JSON.stringify(geofencePoints);
      
      // Store reference to the geofence object instead of serializing the layer
      if (!window.tempGeofenceData) window.tempGeofenceData = {};
      window.tempGeofenceData[geofenceId] = {
        layer: geofenceLayer,
        points: geofencePoints
      };
      
      // Show modal
      modal.classList.remove('hidden');
      
      // Focus on name input
      nameInput.focus();
    }

    // Refresh vehicles map
    function refreshVehiclesMap() {
      const button = document.getElementById('vehicles-refresh-map');
      if (button) {
        // Add loading state
        button.classList.remove('bg-white', 'text-gray-700');
        button.classList.add('bg-blue-600', 'text-white');
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Refresh map data
        if (vehiclesFleetMap) {
          // Refresh vehicle markers
          addVehiclesVehicleMarkers();
          
          // Update map size
          vehiclesFleetMap.updateSize();
          
          // Force re-render
          vehiclesFleetMap.render();
          
          console.log('✅ Vehicles map refreshed successfully');
        }
        
        // Update vehicle statistics
        updateVehiclesMapStatistics();
        
        // Reset button after 2 seconds
        setTimeout(() => {
          button.classList.remove('bg-blue-600', 'text-white');
          button.classList.add('bg-white', 'text-gray-700');
          button.innerHTML = '<i class="fas fa-sync"></i>';
        }, 2000);
      }
    }

    // Update vehicles map statistics
    function updateVehiclesMapStatistics() {
      if (vehiclesFleetVehicles && vehiclesFleetVehicles.length > 0) {
        const activeCount = vehiclesFleetVehicles.filter(v => v.status === 'active' || v.status === 'driving').length;
        const totalCount = vehiclesFleetVehicles.length;
        const idlingCount = vehiclesFleetVehicles.filter(v => v.status === 'idle' || v.status === 'idling').length;
        const parkedCount = vehiclesFleetVehicles.filter(v => v.status === 'parked' || v.status === 'stopped').length;
        
        // Update statistics display
        const activeElement = document.getElementById('vehicles-active-count');
        const totalElement = document.getElementById('vehicles-total-count');
        const idlingElement = document.getElementById('vehicles-idling-count');
        const parkedElement = document.getElementById('vehicles-parked-count');
        
        if (activeElement) activeElement.textContent = activeCount;
        if (totalElement) totalElement.textContent = totalCount;
        if (idlingElement) idlingElement.textContent = idlingCount;
        if (parkedElement) parkedElement.textContent = parkedCount;
        
        console.log(`📊 Vehicles map statistics updated: Active: ${activeCount}, Total: ${totalCount}, Idling: ${idlingCount}, Parked: ${parkedCount}`);
      }
    }

    // Show action notification
    function showActionNotification(message, type = 'info') {
      // Create notification element if it doesn't exist
      let notificationContainer = document.getElementById('vehicles-notification-container');
      if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.id = 'vehicles-notification-container';
        notificationContainer.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 10000;
          max-width: 400px;
        `;
        document.body.appendChild(notificationContainer);
      }
      
      // Create notification
      const notification = document.createElement('div');
      const colors = {
        'info': { bg: '#dbeafe', text: '#1e40af', border: '#3b82f6' },
        'success': { bg: '#dcfce7', text: '#166534', border: '#16a34a' },
        'warning': { bg: '#fef3c7', text: '#92400e', border: '#eab308' },
        'error': { bg: '#fee2e2', text: '#991b1b', border: '#dc2626' }
      };
      
      const color = colors[type] || colors.info;
      
      notification.style.cssText = `
        background: ${color.bg};
        color: ${color.text};
        border: 2px solid ${color.border};
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-family: Inter, sans-serif;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: slideInRight 0.3s ease-out;
      `;
      
      // Add icon based on type
      const icons = {
        'info': 'ℹ️',
        'success': '✅',
        'warning': '⚠️',
        'error': '❌'
      };
      
      notification.innerHTML = `
        <span>${icons[type] || icons.info}</span>
        <span>${message}</span>
      `;
      
      // Add to container
      notificationContainer.appendChild(notification);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOutRight 0.3s ease-in';
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }
      }, 5000);
      
      // Add click to dismiss
      notification.style.cursor = 'pointer';
      notification.addEventListener('click', () => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      });
    }

    // Clear all geofences
    function clearVehiclesGeofences() {
      if (window.vehiclesGeofences && window.vehiclesGeofences.length > 0) {
        // Remove all geofence layers from map
        window.vehiclesGeofences.forEach(geofence => {
          if (geofence.layer && vehiclesFleetMap) {
            vehiclesFleetMap.removeLayer(geofence.layer);
          }
        });
        
        // Clear the array
        window.vehiclesGeofences = [];
        
        showActionNotification('All geofences cleared successfully! 🗑️', 'success');
        console.log('✅ All geofences cleared from vehicles map');
      } else {
        showActionNotification('No geofences to clear.', 'info');
      }
    }

    // Zoom to cluster function
    function zoomToCluster(x, y) {
      vehiclesFleetMap.getView().animate({
        center: [x, y],
        zoom: vehiclesFleetMap.getView().getZoom() + 2,
        duration: 500
      });
      
      // Hide popup
      const popup = document.getElementById('vehicles-popup');
      if (popup) {
        popup.style.display = 'none';
      }
    }

    // Initialize map and vehicle list when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🔄 Vehicles page loaded, checking OpenLayers...');
      
      // Render vehicle list with synchronized data
      console.log('🚗 Rendering vehicle list with map data...');
      setTimeout(() => {
        if (vehicles && vehicles.length > 0) {
          renderVehicleList();
          console.log('✅ Vehicle list rendered with', vehicles.length, 'vehicles');
        } else {
          console.log('⚠️ Vehicles array not ready, will render when map initializes');
        }
      }, 100);
      
      // Check if OpenLayers is available
      if (typeof ol !== 'undefined') {
        console.log('✅ OpenLayers available, initializing vehicles map...');
        setTimeout(initVehiclesOpenLayersMap, 500);
      } else {
        console.log('⚠️ OpenLayers not available for vehicles map');
      }
    });

    // ===== FEEDBACK SYSTEM =====
    class FeedbackManager {
      constructor() {
        this.storage = window.feedbackStorage;
        this.setupEventListeners();
      }

      setupEventListeners() {
        // Feedback toggle button
        const feedbackToggle = document.getElementById('feedback-toggle');
        if (feedbackToggle) {
          feedbackToggle.addEventListener('click', () => this.openFeedbackModal());
        }

        // Modal controls
        const closeFeedbackModal = document.getElementById('close-feedback-modal');
        if (closeFeedbackModal) {
          closeFeedbackModal.addEventListener('click', () => this.closeFeedbackModal());
        }

        const cancelFeedbackBtn = document.getElementById('cancel-feedback-btn');
        if (cancelFeedbackBtn) {
          cancelFeedbackBtn.addEventListener('click', () => this.closeFeedbackModal());
        }

        // Form submission
        const feedbackForm = document.getElementById('feedback-form');
        if (feedbackForm) {
          feedbackForm.addEventListener('submit', (e) => this.handleSubmitFeedback(e));
        }

        // Character counter
        const feedbackNote = document.getElementById('feedback-note');
        if (feedbackNote) {
          feedbackNote.addEventListener('input', () => this.updateCharacterCount());
        }

        // Submit another feedback
        const submitAnotherBtn = document.getElementById('submit-another-feedback');
        if (submitAnotherBtn) {
          submitAnotherBtn.addEventListener('click', () => this.resetFeedbackForm());
        }

        // Feedback controls
        const refreshBtn = document.getElementById('refresh-feedback');
        const exportBtn = document.getElementById('export-feedback');
        const clearBtn = document.getElementById('clear-feedback');

        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => this.loadFeedback());
        }
        if (exportBtn) {
          exportBtn.addEventListener('click', () => this.exportFeedback());
        }
        if (clearBtn) {
          clearBtn.addEventListener('click', () => this.clearAllFeedback());
        }
      }

      openFeedbackModal() {
        const modal = document.getElementById('feedback-modal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          
          // Focus on first input
          const nameInput = document.getElementById('feedback-name');
          if (nameInput) {
            setTimeout(() => nameInput.focus(), 100);
          }
        }
      }

      closeFeedbackModal() {
        const modal = document.getElementById('feedback-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      openViewFeedbackModal() {
        const modal = document.getElementById('view-feedback-modal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          this.loadFeedback();
        }
      }

      closeViewFeedbackModal() {
        const modal = document.getElementById('view-feedback-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      updateCharacterCount() {
        const textarea = document.getElementById('feedback-note');
        const counter = document.getElementById('char-count');
        if (textarea && counter) {
          const count = textarea.value.length;
          counter.textContent = count;
          
          if (count > 1000) {
            counter.style.color = '#ef4444';
            textarea.value = textarea.value.substring(0, 1000);
            counter.textContent = '1000';
          } else {
            counter.style.color = '#6b7280';
          }
        }
      }

      async handleSubmitFeedback(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-feedback-btn');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
        submitBtn.disabled = true;

        try {
          const formData = new FormData(e.target);
          const feedbackData = {
            id: Date.now().toString(),
            name: formData.get('name'),
            note: formData.get('note'),
            timestamp: new Date().toISOString(),
            system: 'Vehicles Management System'
          };

          // Validate required fields
          if (!feedbackData.name || !feedbackData.note) {
            throw new Error('Please fill in all required fields');
          }

          // Save using the feedback storage system
          const success = this.storage.saveFeedback(feedbackData);
          if (!success) {
            throw new Error('Failed to save feedback to storage');
          }
          
          // Show success message
          this.showSuccessMessage();
          
        } catch (error) {
          console.error('Error submitting feedback:', error);
          alert('Error submitting feedback: ' + error.message);
          
          // Restore button state
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      showSuccessMessage() {
        const form = document.getElementById('feedback-form');
        const success = document.getElementById('feedback-success');
        
        if (form && success) {
          form.classList.add('hidden');
          success.classList.remove('hidden');
        }
      }

      resetFeedbackForm() {
        const form = document.getElementById('feedback-form');
        const success = document.getElementById('feedback-success');
        const submitBtn = document.getElementById('submit-feedback-btn');
        
        if (form) {
          form.reset();
          form.classList.remove('hidden');
        }
        
        if (success) {
          success.classList.add('hidden');
        }
        
        if (submitBtn) {
          submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Feedback';
          submitBtn.disabled = false;
        }

        // Reset character counter
        const counter = document.getElementById('char-count');
        if (counter) {
          counter.textContent = '0';
        }
      }

      loadFeedback() {
        const feedbackList = document.getElementById('feedback-list');
        if (!feedbackList) return;

        // Get all feedback from storage
        const allFeedback = this.storage.getAllFeedback();

        // Sort by timestamp (newest first)
        allFeedback.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (allFeedback.length === 0) {
          feedbackList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-comments text-4xl mb-3"></i>
              <p>No feedback submitted yet. Encourage your team to share their thoughts!</p>
            </div>
          `;
          return;
        }

        // Render feedback items
        feedbackList.innerHTML = allFeedback.map(item => this.renderFeedbackItem(item)).join('');
      }

      renderFeedbackItem(feedback) {
        const date = new Date(feedback.timestamp).toLocaleDateString();
        const time = new Date(feedback.timestamp).toLocaleTimeString();

        return `
          <div class="border border-gray-200 rounded-lg p-4 bg-white hover:shadow-md transition-shadow">
            <div class="flex items-start gap-3 mb-3">
              <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                <span class="text-orange-600 font-semibold">${feedback.name.charAt(0).toUpperCase()}</span>
              </div>
              <div class="flex-1">
                <h4 class="font-semibold text-gray-900">${feedback.name}</h4>
                <p class="text-xs text-gray-500">${date} at ${time}</p>
              </div>
            </div>
            
            <div class="mb-3">
              <p class="text-gray-700 leading-relaxed">${feedback.note}</p>
            </div>
          </div>
        `;
      }

      exportFeedback() {
        try {
          this.storage.exportFeedback();
          this.showNotification('Feedback exported successfully!', 'success');
        } catch (error) {
          console.error('Error exporting feedback:', error);
          this.showNotification('Error exporting feedback', 'error');
        }
      }

      clearAllFeedback() {
        if (confirm('Are you sure you want to clear all feedback? This action cannot be undone.')) {
          this.storage.clearAllFeedback();
          this.loadFeedback();
          this.showNotification('All feedback cleared successfully!', 'success');
        }
      }

      showNotification(message, type = 'info') {
        // Create a simple notification
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
          type === 'success' ? 'bg-green-500 text-white' :
          type === 'error' ? 'bg-red-500 text-white' :
          'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }
    }

    // Initialize feedback system
    let feedbackManager;
    document.addEventListener('DOMContentLoaded', function() {
      feedbackManager = new FeedbackManager();
    });
  </script>



  <!-- Feedback Submission Modal -->
  <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-comment-dots text-orange-600"></i>
          Submit Feedback & Suggestions
        </h3>
        <button id="close-feedback-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="mb-6">
        <p class="text-gray-600 text-sm leading-relaxed">
          Help us improve the vehicles management system! Share your thoughts on the design, features, usability, or suggest new functionality. Your feedback is valuable and will be reviewed by our development team.
        </p>
      </div>

      <form id="feedback-form" class="space-y-6">
        <!-- Name Field -->
        <div>
          <label for="feedback-name" class="block text-sm font-medium text-gray-700 mb-2">
            Your Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="feedback-name" 
            name="name"
            required
            placeholder="Enter your full name"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors"
          >
        </div>

        <!-- Feedback/Note Field -->
        <div>
          <label for="feedback-note" class="block text-sm font-medium text-gray-700 mb-2">
            Feedback & Comments <span class="text-red-500">*</span>
          </label>
          <textarea 
            id="feedback-note" 
            name="note"
            required
            rows="8"
            placeholder="Please describe your feedback, suggestions, or issues in detail. Be specific about what you liked, what could be improved, or what new features you'd like to see..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors resize-vertical"
          ></textarea>
          <div class="mt-1 text-xs text-gray-500">
            <span id="char-count">0</span>/1000 characters
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row gap-3 pt-4">
          <button 
            type="submit" 
            id="submit-feedback-btn"
            class="flex-1 px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 focus:ring-4 focus:ring-orange-500/20 transition-all font-medium flex items-center justify-center gap-2"
          >
            <i class="fas fa-paper-plane"></i>
            Submit Feedback
          </button>
          <button 
            type="button" 
            id="cancel-feedback-btn"
            class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:ring-4 focus:ring-gray-500/20 transition-all font-medium"
          >
            Cancel
          </button>
        </div>
      </form>

      <!-- Success Message -->
      <div id="feedback-success" class="hidden text-center py-8">
        <div class="mb-4">
          <i class="fas fa-check-circle text-5xl text-green-500"></i>
        </div>
        <h4 class="text-xl font-bold text-gray-900 mb-2">Feedback Submitted Successfully!</h4>
        <p class="text-gray-600 mb-4">Thank you for your valuable feedback. Our team will review it and get back to you if needed.</p>
        <button id="submit-another-feedback" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
          Submit Another Feedback
        </button>
      </div>
    </div>
  </div>

  <!-- View Feedback Modal -->
  <div id="view-feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-comments text-orange-600"></i>
          Submitted Feedback & Comments
        </h3>
        <button id="close-view-feedback-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- Feedback Controls -->
      <div class="mb-6 flex flex-wrap gap-3">
        <button id="refresh-feedback" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
          <i class="fas fa-sync mr-1"></i> Refresh
        </button>
        <button id="export-feedback" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
          <i class="fas fa-download mr-1"></i> Export JSON
        </button>
        <button id="clear-feedback" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">
          <i class="fas fa-trash mr-1"></i> Clear All
        </button>
      </div>

      <!-- Feedback List -->
      <div id="feedback-list" class="space-y-4 max-h-96 overflow-y-auto">
        <!-- Feedback items will be populated here -->
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-comments text-4xl mb-3"></i>
          <p>No feedback submitted yet. Encourage your team to share their thoughts!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Vehicle Info Modal -->
  <div id="vehicle-info-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-truck text-blue-600"></i>
          <span id="vehicle-info-title">Vehicle Information</span>
        </h3>
        <button id="close-vehicle-info-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div id="vehicle-info-content" class="space-y-6">
        <!-- Loading state -->
        <div class="text-center py-8">
          <i class="fas fa-spinner fa-spin text-3xl text-blue-600"></i>
          <p class="mt-2 text-gray-600">Loading vehicle information...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Vehicle Route History Modal -->
  <div id="vehicle-route-history-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <button onclick="backToVehicleInfo()" 
                  class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2">
            <i class="fas fa-arrow-left"></i>
            Back to Vehicle Info
          </button>
          <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
            <i class="fas fa-route text-green-600"></i>
            <span id="route-history-title">Route History</span>
          </h3>
        </div>
        <button id="close-route-history-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div id="route-history-content" class="space-y-6">
        <!-- Route history content will be populated here -->
      </div>
    </div>
  </div>

  <!-- Vehicle Lifecycle Modal -->
  <div id="vehicle-lifecycle-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <button onclick="backToVehicleInfo()" 
                  class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2">
            <i class="fas fa-arrow-left"></i>
            Back to Vehicle Info
          </button>
          <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
            <i class="fas fa-history text-indigo-600"></i>
            <span id="lifecycle-title">Vehicle Lifecycle Timeline</span>
          </h3>
        </div>
        <button id="close-lifecycle-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div id="lifecycle-content" class="space-y-6">
        <!-- Lifecycle content will be populated here -->
      </div>
    </div>
  </div>

  <!-- Geofence Rules Modal -->
  <div id="geofence-rules-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-shield-alt text-orange-600"></i>
          Configure Geofence Rules
        </h3>
        <button id="close-geofence-rules-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form id="geofence-rules-form" class="space-y-6">
        <!-- Geofence Name -->
        <div>
          <label for="geofence-name" class="block text-sm font-medium text-gray-700 mb-2">
            Geofence Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="geofence-name" 
            name="name"
            required
            placeholder="Enter geofence name (e.g., Office Zone, Warehouse Area)"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors"
          >
        </div>

        <!-- Geofence Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Geofence Type <span class="text-red-500">*</span>
          </label>
          <div class="space-y-2">
            <label class="flex items-center">
              <input type="radio" name="type" value="restricted" class="mr-2 text-orange-600" checked>
              <span class="text-sm text-gray-700">Restricted Zone (Alerts when vehicles enter)</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="type" value="allowed" class="mr-2 text-orange-600">
              <span class="text-sm text-gray-700">Allowed Zone (Alerts when vehicles leave)</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="type" value="monitoring" class="mr-2 text-orange-600">
              <span class="text-sm text-gray-700">Monitoring Zone (Track all movements)</span>
            </label>
          </div>
        </div>

        <!-- Alert Settings -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Alert Settings
          </label>
          <div class="space-y-2">
            <label class="flex items-center">
              <input type="checkbox" name="alerts" value="entry" class="mr-2 text-orange-600" checked>
              <span class="text-sm text-gray-700">Entry Alerts</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="alerts" value="exit" class="mr-2 text-orange-600" checked>
              <span class="text-sm text-gray-700">Exit Alerts</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="alerts" value="dwell" class="mr-2 text-orange-600">
              <span class="text-sm text-gray-700">Dwell Time Alerts (after 5+ minutes)</span>
            </label>
          </div>
        </div>

        <!-- Notification Methods -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Notification Methods
          </label>
          <div class="space-y-2">
            <label class="flex items-center">
              <input type="checkbox" name="notifications" value="dashboard" class="mr-2 text-orange-600" checked>
              <span class="text-sm text-gray-700">Dashboard Alerts</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="notifications" value="email" class="mr-2 text-orange-600">
              <span class="text-sm text-gray-700">Email Notifications</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="notifications" value="sms" class="mr-2 text-orange-600">
              <span class="text-sm text-gray-700">SMS Alerts</span>
            </label>
          </div>
        </div>

        <!-- Time Restrictions -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Time Restrictions (Optional)
          </label>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="start-time" class="block text-xs text-gray-600 mb-1">Start Time</label>
              <input type="time" id="start-time" name="startTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label for="end-time" class="block text-xs text-gray-600 mb-1">End Time</label>
              <input type="time" id="end-time" name="endTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
        </div>

        <!-- Description -->
        <div>
          <label for="geofence-description" class="block text-sm font-medium text-gray-700 mb-2">
            Description (Optional)
          </label>
          <textarea 
            id="geofence-description" 
            name="description"
            rows="3"
            placeholder="Additional notes about this geofence..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors resize-vertical"
          ></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 pt-4">
          <button 
            type="submit" 
            id="save-geofence-rules-btn"
            class="flex-1 px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 focus:ring-4 focus:ring-orange-500/20 transition-all font-medium flex items-center justify-center gap-2"
          >
            <i class="fas fa-save"></i>
            Save Geofence Rules
          </button>
          <button 
            type="button" 
            id="cancel-geofence-rules-btn"
            class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:ring-4 focus:ring-gray-500/20 transition-all font-medium"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Geofence Rules Modal Event Handlers
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('geofence-rules-modal');
      const form = document.getElementById('geofence-rules-form');
      const closeBtn = document.getElementById('close-geofence-rules-modal');
      const cancelBtn = document.getElementById('cancel-geofence-rules-btn');
      
      // Close modal handlers
      function closeModal() {
        modal.classList.add('hidden');
        form.reset();
        
        // Clean up stored data
        const geofenceId = form.dataset.geofenceId;
        if (geofenceId && window.tempGeofenceData) {
          delete window.tempGeofenceData[geofenceId];
        }
        
        // Remove stored data
        delete form.dataset.geofenceId;
        delete form.dataset.geofencePoints;
      }
      
      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);
      
      // Close modal when clicking outside
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // Close modal with Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
          closeModal();
        }
      });
      
      // Form submission handler
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const geofenceId = parseInt(form.dataset.geofenceId);
        const geofencePoints = JSON.parse(form.dataset.geofencePoints);
        
        // Get form data
        const formData = new FormData(form);
        const rules = {
          name: formData.get('name'),
          type: formData.get('type'),
          alerts: formData.getAll('alerts'),
          notifications: formData.getAll('notifications'),
          startTime: formData.get('startTime'),
          endTime: formData.get('endTime'),
          description: formData.get('description'),
          createdAt: new Date().toISOString()
        };
        
        // Update geofence with rules using temporary storage
        if (window.vehiclesGeofences && window.tempGeofenceData && window.tempGeofenceData[geofenceId]) {
          const geofence = window.vehiclesGeofences.find(g => g.id === geofenceId);
          if (geofence) {
            geofence.rules = rules;
            geofence.name = rules.name;
            
            // Update geofence layer with name
            if (geofence.layer && geofence.layer.getSource()) {
              const feature = geofence.layer.getSource().getFeatures()[0];
              if (feature) {
                feature.set('name', rules.name);
                feature.set('type', rules.type);
              }
            }
          }
          
          // Clean up temporary data
          delete window.tempGeofenceData[geofenceId];
        }
        
        // Show success message
        showActionNotification(`Geofence "${rules.name}" configured successfully! 🛡️`, 'success');
        
        // Log geofence creation
        console.log('✅ Geofence created with rules:', {
          id: geofenceId,
          rules: rules,
          points: geofencePoints.length
        });
        
        // Close modal
        closeModal();
      });
    });

    // Vehicle Info Modal Event Handlers
    document.addEventListener('DOMContentLoaded', function() {
      const vehicleInfoModal = document.getElementById('vehicle-info-modal');
      const routeHistoryModal = document.getElementById('vehicle-route-history-modal');
      const lifecycleModal = document.getElementById('vehicle-lifecycle-modal');
      
      // Close vehicle info modal
      document.getElementById('close-vehicle-info-modal').addEventListener('click', function() {
        vehicleInfoModal.classList.add('hidden');
        // Clear current vehicle reference when closing main modal
        delete window.currentVehicleId;
      });
      
      // Close route history modal
      document.getElementById('close-route-history-modal').addEventListener('click', function() {
        routeHistoryModal.classList.add('hidden');
      });
      
      // Close lifecycle modal
      document.getElementById('close-lifecycle-modal').addEventListener('click', function() {
        lifecycleModal.classList.add('hidden');
      });
      
      // Close modals when clicking outside
      vehicleInfoModal.addEventListener('click', function(e) {
        if (e.target === vehicleInfoModal) {
          vehicleInfoModal.classList.add('hidden');
          // Clear current vehicle reference when closing main modal
          delete window.currentVehicleId;
        }
      });
      
      routeHistoryModal.addEventListener('click', function(e) {
        if (e.target === routeHistoryModal) {
          routeHistoryModal.classList.add('hidden');
        }
      });
      
      lifecycleModal.addEventListener('click', function(e) {
        if (e.target === lifecycleModal) {
          lifecycleModal.classList.add('hidden');
        }
      });
      
      // Close modals with Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          if (!vehicleInfoModal.classList.contains('hidden')) {
            vehicleInfoModal.classList.add('hidden');
            // Clear current vehicle reference when closing main modal
            delete window.currentVehicleId;
          }
          if (!routeHistoryModal.classList.contains('hidden')) {
            routeHistoryModal.classList.add('hidden');
          }
          if (!lifecycleModal.classList.contains('hidden')) {
            lifecycleModal.classList.add('hidden');
          }
        }
      });
      
      // Final safety check - ensure vehicles are rendered
      setTimeout(() => {
        console.log('🎯 Final safety render check...');
        console.log('Vehicles array:', vehicles ? vehicles.length : 'undefined');
        console.log('Vehicle list element:', document.getElementById('vehicle-list') ? 'found' : 'missing');
        
        if (vehicles && vehicles.length > 0 && document.getElementById('vehicle-list')) {
          console.log('🔄 Executing final safety render...');
          renderVehicleList(1, '', {});
          updateAnalytics();
          console.log('✅ Final safety render completed');
        }
      }, 2000);
    });
  </script>
</body>
</html>
