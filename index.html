<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lynx Lite Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- <script src="drivers-data.js"></script> Driver data removed - leaderboard is now empty placeholder -->
  <!-- <script src="vehicles-data.js"></script> Vehicle data removed - not needed for clean dashboard -->
  
  <!-- Feedback Storage System -->
  <script src="feedback-storage.js"></script>
  
  <!-- Map Widget Dependencies removed - keeping dashboard clean without map conflicts -->
  
  <!-- Dashboard Styles (map widget styles removed) -->
  <!-- Fleet Map Widget - Scripts now loaded synchronously above -->
  <script>
    // Dashboard dependencies check (map widgets removed)
    console.log('=== DASHBOARD DEPENDENCIES CHECK ===');
    console.log('Chart.js available:', typeof Chart !== 'undefined');
    console.log('DriversDataAPI available:', typeof DriversDataAPI !== 'undefined');
    console.log('VehiclesDataAPI available:', typeof VehiclesDataAPI !== 'undefined');
    console.log('=== END DEPENDENCIES CHECK ===');
  </script>
  <link rel="stylesheet" href="styles.css">

</head>
  <body class="bg-gradient-to-br from-blue-50 via-white to-gray-100 font-sans min-h-screen m-0 p-0">
  
  <!-- Onboarding Tutorial System -->
  <div id="tutorial-overlay" class="tutorial-overlay">
    <div id="tutorial-spotlight" class="tutorial-spotlight"></div>
  </div>
  
  <!-- Tutorial Start Modal -->
  <div id="tutorial-start-modal" data-modal-type="tutorial" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-md mx-4">
      <div class="text-center">
        <div class="mb-4">
          <i class="fas fa-graduation-cap text-4xl text-blue-600 mb-3"></i>
          <h3 class="text-2xl font-bold text-gray-900 mb-2">Welcome to Fleet Dashboard</h3>
          <p class="text-gray-600 text-sm leading-relaxed">
            Take a guided tour to learn about all the features and get the most out of your fleet management experience.
          </p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <button id="start-tour-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
            <i class="fas fa-play"></i>
            Start Tour
          </button>
          <button id="skip-tour-btn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
            Skip for Now
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-4">You can always restart the tour from the help button</p>
      </div>
    </div>
  </div>
    
    <!-- Tutorial Tooltip -->
    <div id="tutorial-tooltip" class="tutorial-tooltip hidden">
      <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
          <span id="tutorial-step-counter" class="text-sm font-medium text-blue-600">Step 1 of 8</span>
          <button id="tutorial-close" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5 mb-3">
          <div id="tutorial-progress" class="tutorial-progress" style="width: 12.5%;"></div>
        </div>
      </div>
      
      <div class="mb-4">
        <h3 id="tutorial-title" class="text-lg font-semibold text-gray-900 mb-2">Dashboard Overview</h3>
        <p id="tutorial-description" class="text-gray-600 text-sm leading-relaxed">
          This is your main dashboard where you can monitor your entire fleet in real-time.
        </p>
      </div>
      
      <div class="flex items-center justify-between">
        <button id="tutorial-prev" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <i class="fas fa-chevron-left mr-1"></i> Previous
        </button>
        <button id="tutorial-next" class="px-4 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
          Next <i class="fas fa-chevron-right ml-1"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Tutorial Skip Button (Always Visible During Tutorial) -->
  <button id="tutorial-skip-floating" class="tutorial-skip-btn hidden px-3 py-2 text-sm text-gray-600 rounded-lg hover:bg-white transition-colors">
    <i class="fas fa-times mr-1"></i> Skip Tour
  </button>



  <!-- Help Button (Always Visible) -->
  <button id="help-toggle" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-all hover:scale-110 z-50" title="Get Help or Restart Tour">
    <i class="fas fa-question text-lg"></i>
  </button>

  <!-- Quick Actions FAB (Floating Action Button) -->
  <div class="fixed bottom-6 left-6 z-50">
    <!-- Main FAB Button -->
    <button id="quick-actions-fab" class="w-16 h-16 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-full shadow-2xl hover:shadow-3xl transition-all duration-300 hover:scale-110 focus:outline-none focus:ring-4 focus:ring-blue-300" title="Quick Actions">
      <i class="fas fa-plus text-2xl"></i>
    </button>
    
    <!-- Quick Actions Menu -->
    <div id="quick-actions-menu" class="absolute bottom-20 left-0 bg-white rounded-2xl shadow-2xl border border-gray-200 p-3 hidden transform transition-all duration-300 scale-95 opacity-0">
      <div class="space-y-2">
        <!-- Add Vehicle -->
        <button class="quick-action-btn flex items-center gap-3 px-4 py-3 hover:bg-blue-50 rounded-xl w-full transition-all duration-200 group" data-action="add-vehicle">
          <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition-colors">
            <i class="fas fa-truck text-blue-600 text-lg"></i>
          </div>
          <div class="text-left">
            <div class="font-medium text-gray-900">Add Vehicle</div>
            <div class="text-xs text-gray-500">Register new vehicle</div>
          </div>
        </button>
        
        <!-- Add Driver -->
        <button class="quick-action-btn flex items-center gap-3 px-4 py-3 hover:bg-green-50 rounded-xl w-full transition-all duration-200 group" data-action="add-driver">
          <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 transition-colors">
            <i class="fas fa-user-plus text-green-600 text-lg"></i>
          </div>
          <div class="text-left">
            <div class="font-medium text-gray-900">Add Driver</div>
            <div class="text-xs text-gray-500">Register new driver</div>
          </div>
        </button>
        
        <!-- Create Route -->
        <button class="quick-action-btn flex items-center gap-3 px-4 py-3 hover:bg-purple-50 rounded-xl w-full transition-all duration-200 group" data-action="create-route">
          <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center group-hover:bg-purple-200 transition-colors">
            <i class="fas fa-route text-purple-600 text-lg"></i>
          </div>
          <div class="text-left">
            <div class="font-medium text-gray-900">Create Route</div>
            <div class="text-xs text-gray-500">Plan new route</div>
          </div>
        </button>
        
        <!-- Schedule Maintenance -->
        <button class="quick-action-btn flex items-center gap-3 px-4 py-3 hover:bg-orange-50 rounded-xl w-full transition-all duration-200 group" data-action="schedule-maintenance">
          <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center group-hover:bg-orange-200 transition-colors">
            <i class="fas fa-tools text-orange-600 text-lg"></i>
          </div>
          <div class="text-left">
            <div class="font-medium text-gray-900">Schedule Maintenance</div>
            <div class="text-xs text-gray-500">Book service appointment</div>
          </div>
        </button>
        
        <!-- Create Alert -->
        <button class="quick-action-btn flex items-center gap-3 px-4 py-3 hover:bg-red-50 rounded-xl w-full transition-all duration-200 group" data-action="create-alert">
          <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center group-hover:bg-red-200 transition-colors">
            <i class="fas fa-exclamation-triangle text-red-600 text-lg"></i>
          </div>
          <div class="text-left">
            <div class="font-medium text-gray-900">Create Alert</div>
            <div class="text-xs text-gray-500">Set up new alert</div>
          </div>
        </button>
        
        <!-- Generate Report -->
        <button class="quick-action-btn flex items-center gap-3 px-4 py-3 hover:bg-indigo-50 rounded-xl w-full transition-all duration-200 group" data-action="generate-report">
          <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center group-hover:bg-indigo-200 transition-colors">
            <i class="fas fa-chart-bar text-indigo-600 text-lg"></i>
          </div>
          <div class="text-left">
            <div class="font-medium text-gray-900">Generate Report</div>
            <div class="text-xs text-gray-500">Create performance report</div>
          </div>
        </button>
        

      </div>
    </div>
  </div>

  <!-- Help Menu -->
  <div id="help-menu" class="fixed bottom-20 right-6 bg-white rounded-lg shadow-xl border border-gray-200 p-4 w-64 hidden z-40">
    <h4 class="font-semibold text-gray-900 mb-3">Need Help?</h4>
    <div class="space-y-2">
      <button id="restart-tutorial" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-lg flex items-center gap-2">
        <i class="fas fa-redo text-blue-600"></i> Restart Tutorial
      </button>
      <button id="show-hotkeys" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-lg flex items-center gap-2">
        <i class="fas fa-keyboard text-green-600"></i> Keyboard Shortcuts
      </button>
      <button id="feature-highlights" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-lg flex items-center gap-2">
        <i class="fas fa-lightbulb text-yellow-600"></i> Feature Highlights
      </button>
      <a href="#" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 rounded-lg flex items-center gap-2">
        <i class="fas fa-book text-purple-600"></i> Documentation
      </a>
    </div>
  </div>
  <!-- Main Dashboard Header - Positioned after sidebar on desktop, full width on mobile -->
  <header class="bg-white/90 backdrop-blur shadow-lg flex items-center px-6 py-4 z-30 fixed top-0 left-72 right-0 border-b border-blue-100" aria-label="Dashboard Header">
    <!-- Left Section: Dashboard Title -->
    <div class="flex items-center min-w-0 flex-shrink-0">
      <h1 class="text-2xl font-extrabold text-blue-800 tracking-tight drop-shadow truncate">Lynx Lite Dashboard</h1>
      <span class="offline-indicator text-red-600 text-sm font-medium hidden ml-2">Offline</span>
    </div>
    
    <!-- Center Section: User Info and Role Badges -->
    <div class="flex items-center justify-center flex-1 min-w-0 mx-4">
      <div class="flex items-center space-x-3 min-w-0">
        <!-- Avatar and Welcome Message -->
        <img src="https://ui-avatars.com/api/?name=Owner&background=3b82f6&color=fff&rounded=true&size=40" alt="User Avatar" class="w-10 h-10 rounded-full shadow border-2 border-blue-200 flex-shrink-0">
        <div class="flex flex-col min-w-0">
          <span class="font-semibold text-blue-800 text-sm truncate">Welcome, whoever you are :)</span>
          <!-- Role Badges Container -->
          <div class="flex items-center space-x-1 flex-wrap mt-1 overflow-hidden">
            <span class="px-2 py-0.5 rounded-full bg-blue-700 text-white ring-1 ring-blue-400 font-bold shadow text-xs flex-shrink-0">Admin</span>
            <span class="px-2 py-0.5 rounded-full bg-green-600 text-white ring-1 ring-green-400 font-bold shadow text-xs flex-shrink-0">Fleet Manager</span>
            <span class="px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 text-xs font-medium flex-shrink-0 hidden sm:inline">Owner CEO</span>
            <span class="px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800 text-xs font-medium flex-shrink-0 hidden md:inline">Dispatcher</span>
            <span class="px-2 py-0.5 rounded-full bg-red-100 text-red-800 text-xs font-medium flex-shrink-0 hidden lg:inline">Driver</span>
            <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-800 text-xs font-medium flex-shrink-0 hidden xl:inline">Accountant</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Right Section: Controls and User Menu -->
    <div class="flex items-center space-x-3 min-w-0 flex-shrink-0">
      <button id="dark-mode-toggle" class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 p-2" aria-label="Toggle Dark Mode" tabindex="0">
        <i class="fas fa-moon"></i>
      </button>
      
      <!-- Notification Bell Button -->
      <div class="relative" style="z-index: 999998;">
        <button id="notifications-bell" class="relative text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 p-2 transition-colors" aria-label="View Notifications" aria-expanded="false" tabindex="0">
          <i class="fas fa-bell text-lg"></i>
          <!-- Notification Badge -->
          <span id="notification-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] h-[18px] flex items-center justify-center font-bold shadow-sm">3</span>
        </button>
        

      </div>
      
      <!-- Feedback Button -->
      <div class="text-center">
        <button id="feedback-toggle" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-all hover:scale-105 shadow-lg flex items-center gap-2 font-medium" title="Submit Feedback">
          <i class="fas fa-comment-dots text-lg"></i>
          Submit Feedback
        </button>
        <p class="text-xs text-gray-500 mt-1">Feedback automatically sent to Google Sheets</p>
      </div>
      

      
      <div class="relative">
        <input type="text" id="search-input" placeholder="Search..." class="border border-gray-300 px-3 py-2 rounded-lg w-48 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm" aria-label="Search">
        <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
      </div>
      <button id="filter-toggle" class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 p-2" aria-label="Toggle Filter" tabindex="0">
        <i class="fas fa-filter"></i>
      </button>
      <button id="logout-btn" class="bg-gradient-to-tr from-red-500 to-red-400 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:scale-105 transition-all focus:outline-none focus:ring-2 focus:ring-red-500" aria-label="Log Out" tabindex="0" title="Click to Log Out">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </header>

  <!-- Notifications Dropdown (moved outside header to avoid clipping) -->
  <div id="notifications-dropdown" class="hidden fixed w-80 bg-white rounded-xl shadow-2xl border-2 border-blue-500 max-h-96" style="box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); z-index: 9999999; top: 80px; right: 20px;">
    <!-- Header -->
    <div class="px-4 py-3 border-b border-gray-100 bg-gray-50 rounded-t-xl">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold text-gray-900">Latest Alerts</h3>
        <button id="mark-all-read" class="text-xs text-blue-600 hover:text-blue-800 font-medium">Mark all read</button>
      </div>
    </div>
    
    <!-- Notifications List -->
    <div id="notifications-list" class="max-h-80 overflow-y-auto">
      <!-- Critical Alert -->
      <div class="notification-item p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer" data-alert-type="critical">
        <div class="flex items-start gap-3">
          <div class="w-2 h-2 bg-red-500 rounded-full mt-2 flex-shrink-0"></div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs font-medium text-red-600 uppercase tracking-wide">Critical</span>
              <span class="text-xs text-gray-500">2 min ago</span>
            </div>
            <p class="text-sm font-medium text-gray-900 mb-1">Engine Overheating Detected</p>
            <p class="text-xs text-gray-600">Vehicle FL-001 engine temperature critical</p>
          </div>
        </div>
      </div>
      
      <!-- Warning Alert -->
      <div class="notification-item p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors cursor-pointer" data-alert-type="warning">
        <div class="flex items-start gap-3">
          <div class="w-2 h-2 bg-yellow-500 rounded-full mt-2 flex-shrink-0"></div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs font-medium text-yellow-600 uppercase tracking-wide">Warning</span>
              <span class="text-xs text-gray-500">5 min ago</span>
            </div>
            <p class="text-sm font-medium text-gray-900 mb-1">Low Tire Pressure</p>
            <p class="text-xs text-gray-600">Vehicle FL-023 front left tire pressure low</p>
          </div>
        </div>
      </div>
      
      <!-- Info Alert -->
      <div class="notification-item p-4 hover:bg-gray-50 transition-colors cursor-pointer" data-alert-type="info">
        <div class="flex items-start gap-3">
          <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs font-medium text-blue-600 uppercase tracking-wide">Info</span>
              <span class="text-xs text-gray-500">12 min ago</span>
            </div>
            <p class="text-sm font-medium text-gray-900 mb-1">Maintenance Reminder</p>
            <p class="text-xs text-gray-600">Vehicle FL-045 scheduled maintenance due in 2 days</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Modal -->
  <div id="filter-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40" role="dialog" aria-label="Filter Vehicles Modal">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Filter Vehicles</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Status</label>
          <div class="space-y-2">
            <label class="flex items-center">
              <input type="checkbox" value="Driving" class="status-filter" aria-label="Filter by Driving Status">
              <span class="ml-2 text-sm text-gray-600">Driving</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" value="Idling" class="status-filter" aria-label="Filter by Idling Status">
              <span class="ml-2 text-sm text-gray-600">Idling</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" value="Parked" class="status-filter" aria-label="Filter by Parked Status">
              <span class="ml-2 text-sm text-gray-600">Parked</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" value="Offline" class="status-filter" aria-label="Filter by Offline Status">
              <span class="ml-2 text-sm text-gray-600">Offline</span>
            </label>
          </div>
        </div>
        <div>
          <label for="driver-filter" class="block text-sm font-medium text-gray-700">Driver</label>
          <select id="driver-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" aria-label="Filter by Driver">
            <option value="all">All</option>
            <option value="Driver 1">Driver 1</option>
            <option value="Driver 2">Driver 2</option>
          </select>
        </div>
        <div>
          <label for="group-filter" class="block text-sm font-medium text-gray-700">Vehicle Group</label>
          <select id="group-filter" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" aria-label="Filter by Group">
            <option value="all">All</option>
            <option value="Delivery">Delivery Trucks</option>
            <option value="Service">Service Vans</option>
          </select>
        </div>
        <div class="flex justify-end space-x-2">
          <button id="filter-apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition-all" tabindex="0">Apply</button>
          <button id="filter-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 focus:ring-2 focus:ring-gray-500 transition-all" tabindex="0">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Geofence Creation Modal -->
  <div id="geofence-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40" role="dialog" aria-label="Create Geofence Modal">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Create Geofence</h3>
      <div class="space-y-4">
        <div>
          <label for="geofence-name" class="block text-sm font-medium text-gray-700">Geofence Name</label>
          <input id="geofence-name" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter name" aria-label="Geofence Name">
        </div>
        <div>
          <label for="geofence-alert" class="block text-sm font-medium text-gray-700">Alert on</label>
          <select id="geofence-alert" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" aria-label="Alert Type">
            <option value="entry">Entry</option>
            <option value="exit">Exit</option>
            <option value="both">Both</option>
          </select>
        </div>
        <div class="flex justify-end space-x-2">
          <button id="geofence-save" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition-all" tabindex="0">Save</button>
          <button id="geofence-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 focus:ring-2 focus:ring-gray-500 transition-all" tabindex="0">Cancel</button>
        </div>
      </div>
    </div>
  </div>


      

  <!-- Fleet Metrics Dashboard now properly positioned inside dashboard container -->

  <!-- Broken fleet metrics HTML content removed for cleaner file structure -->



    <script>
    // --- KPI Cards Logic ---

    function randomSparklineData(n, base, spread) {
      return Array.from({length: n}, () => Math.round(base + (Math.random()-0.5)*spread));
    }
    // Store chart instances to allow destruction
    window.sparklineCharts = window.sparklineCharts || {};
    
    function renderSparkline(canvasId, data, color) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) {
        console.warn(`Canvas element with id '${canvasId}' not found`);
        return;
      }
      
      // Destroy existing chart if it exists
      if (window.sparklineCharts[canvasId]) {
        window.sparklineCharts[canvasId].destroy();
        delete window.sparklineCharts[canvasId];
      }
      
      const ctx = canvas.getContext('2d');
      window.sparklineCharts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels: data.map((_,i)=>i+1), datasets: [{ data, borderColor: color, backgroundColor: 'rgba(59,130,246,0.08)', borderWidth: 2, pointRadius: 0, fill: true }] },
        options: { responsive: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, elements: { line: { tension: 0.4 } } }
      });
    }
    function updateKpiCards() {
      // KPI values will now be updated by the map widget
      // Initialize with default values if map widget hasn't loaded yet
      if (!window.fleetMap) {
        const total = 100, active = 61, idling = 25, parked = 11, offline = 3, efficiency = 8.5; // km/L realistic fuel efficiency
        
        // Safely update KPI elements only if they exist
        const kpiElements = {
          'kpi-total-vehicles': total,
          'kpi-active': active,
          'kpi-idling': idling,
          'kpi-parked': parked,
          'kpi-offline': offline,
          'kpi-efficiency': efficiency.toFixed(1) // km/L value, no % needed
        };
        
        Object.entries(kpiElements).forEach(([elementId, value]) => {
          const element = document.getElementById(elementId);
          if (element) {
            element.textContent = value;
          }
        });
        
        // Render sparklines only if canvas elements exist
        const sparklineElements = [
          { id: 'sparkline-total-vehicles', data: randomSparklineData(12, total, 20), color: '#3B82F6' },
          { id: 'sparkline-active', data: randomSparklineData(12, active, 15), color: '#16A34A' },
          { id: 'sparkline-idling', data: randomSparklineData(12, idling, 8), color: '#EAB308' },
          { id: 'sparkline-parked', data: randomSparklineData(12, parked, 8), color: '#3B82F6' },
          { id: 'sparkline-offline', data: randomSparklineData(12, offline, 5), color: '#6B7280' },
          { id: 'sparkline-efficiency', data: randomSparklineData(12, efficiency, 5), color: '#16A34A' }
        ];
        
        sparklineElements.forEach(sparkline => {
          if (document.getElementById(sparkline.id)) {
            renderSparkline(sparkline.id, sparkline.data, sparkline.color);
          }
        });
      }
      
      // Show goals
      const goals = JSON.parse(localStorage.getItem('dashboardGoals') || '{}');
      function setGoalDisplay(id, value, goal, isHigherBetter, suffix = '') {
        const el = document.getElementById('goal-' + id);
        if (!el) return; // Skip if element doesn't exist
        if (!goal) { 
          el.textContent = ''; 
          el.className = 'text-xs font-semibold mt-1'; 
          return; 
        }
        let met = isHigherBetter ? Number(value) >= Number(goal) : Number(value) <= Number(goal);
        el.textContent = `Goal: ${goal}${suffix}`;
        el.className = `text-xs font-semibold mt-1 ${met ? 'text-green-600' : 'text-red-600'}`;
      }
      
      // Only set goals if we have values defined
      if (typeof total !== 'undefined') {
        setGoalDisplay('total-vehicles', total, goals['total-vehicles'], true);
        setGoalDisplay('active', active, goals['active'], true);
        setGoalDisplay('idling', idling, goals['idling'], false);
        setGoalDisplay('parked', parked, goals['parked'], false);
        setGoalDisplay('offline', offline, goals['offline'], false);
        setGoalDisplay('efficiency', efficiency, goals['efficiency'], true, 'km/L');
      }
    }
    
    // Function to update sparklines with real data from map widget
    window.updateFleetSparklines = function(stats) {
      console.log('Updating fleet sparklines with stats:', stats);
      
      // Convert efficiency percentage to km/L for sparklines
      const efficiencyKmL = 5 + (stats.efficiency / 100) * 4; // Convert % to 5-9 km/L range
      
      // Only update sparklines that have corresponding canvas elements
      const sparklineUpdates = [
        { id: 'sparkline-total-vehicles', value: stats.total, color: '#3B82F6', spread: 0.1 },
        { id: 'sparkline-active', value: stats.active, color: '#16A34A', spread: 0.15 },
        { id: 'sparkline-idling', value: stats.idle, color: '#EAB308', spread: 0.2 },
        { id: 'sparkline-parked', value: stats.idle, color: '#3B82F6', spread: 0.2 },
        { id: 'sparkline-offline', value: stats.offline, color: '#6B7280', spread: 0.3 },
        { id: 'sparkline-efficiency', value: efficiencyKmL, color: '#16A34A', spread: 0.1 }
      ];
      
      sparklineUpdates.forEach(update => {
        if (document.getElementById(update.id)) {
          const spread = Math.max(2, update.value * update.spread);
          renderSparkline(update.id, randomSparklineData(12, update.value, spread), update.color);
        }
      });
    };
    

    // Animate fade-in for widgets
    document.querySelectorAll('.widget-card').forEach(card => {
      card.classList.add('animate-fade-in');
    });
    // Initial render
    updateKpiCards();

    // Fleet time filter functionality
    document.querySelectorAll('.fleet-time-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        // Remove active styling from all buttons
        document.querySelectorAll('.fleet-time-btn').forEach(b => {
          b.classList.remove('bg-blue-600', 'text-white');
          b.classList.add('hover:bg-blue-200');
        });
        
        // Add active styling to clicked button
        this.classList.add('bg-blue-600', 'text-white');
        this.classList.remove('hover:bg-blue-200');
        
        // Handle custom date range visibility
        const customRange = document.getElementById('fleet-custom-date-range');
        if (this.dataset.range === 'custom') {
          customRange.classList.remove('hidden');
        } else {
          customRange.classList.add('hidden');
        }
        
        // Update KPI data (in real app, this would fetch from API)
        updateKpiCards();
      });
    });

    // Custom date range apply button
    const applyBtn = document.getElementById('fleet-date-apply');
    if (applyBtn) {
      applyBtn.addEventListener('click', function() {
        const fromDate = document.getElementById('fleet-date-from').value;
        const toDate = document.getElementById('fleet-date-to').value;
        
        if (fromDate && toDate) {
          // In real app, this would fetch data for the date range
          updateKpiCards();
        }
      });
    }
  </script>


  <!-- Alerts Sidebar -->
  <div id="alerts-sidebar" class="fixed top-20 inset-y-16 right-0 w-80 bg-white p-6 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-20 hidden" role="dialog" aria-label="Alerts Sidebar">
    <h3 class="text-xl font-bold text-gray-900 mb-4">Active Alerts</h3>
    <ul id="alerts-list" class="space-y-2 max-h-[500px] overflow-y-auto">
      <li class="bg-red-100 text-red-800 px-4 py-2 rounded-lg shadow">Critical Alert: Engine Overheating</li>
      <li class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg shadow">Warning: Low Tire Pressure</li>
      <li class="bg-green-100 text-green-800 px-4 py-2 rounded-lg shadow">Info: Scheduled Maintenance Due</li>
    </ul>
  </div>

  <div class="flex min-h-[calc(100vh-80px)]">
    <aside id="sidebar" class="w-72 bg-gradient-to-b from-blue-900 via-blue-800 to-blue-700 text-white flex flex-col pb-8 px-6 fixed inset-y-0 left-0 z-20 shadow-2xl border-r-2 border-blue-200" aria-label="Main Navigation">
      <nav class="space-y-6 flex flex-col pt-4">
        <!-- Dashboard (always on top) -->
        <a href="Main Dashboard.html" class="nav-link group flex items-center gap-4 px-5 py-3 text-base font-bold text-white bg-gradient-to-r from-blue-700 to-blue-600 rounded-xl shadow hover:scale-105 transition-transform" role="menuitem">
          <i class="fas fa-tachometer-alt fa-fw text-xl flex-shrink-0"></i>
          <span class="nav-text flex-1">Dashboard</span>
        </a>

        <!-- Fleet Management Main Section -->
        <div class="sidebar-section">
          <div class="flex items-center gap-4 px-5 py-2 text-base font-bold text-blue-200 uppercase tracking-wide mb-2">
            <i class="fas fa-layer-group fa-fw flex-shrink-0"></i>
            <span class="nav-text flex-1">Fleet Management</span>
          </div>
          <div class="ml-8 space-y-3 flex flex-col">
            <a href="vehicles.html" class="nav-link flex items-center gap-4 px-4 py-2 text-base font-medium text-blue-100 rounded-lg hover:text-white hover:bg-blue-600 transition" role="menuitem" onclick="window.location.href='vehicles.html'; return false;">
              <i class="fas fa-truck fa-fw flex-shrink-0"></i>
              <span class="nav-text flex-1">Vehicles</span>
            </a>
            <a href="drivers.html" class="nav-link flex items-center gap-4 px-4 py-2 text-base font-medium text-blue-100 rounded-lg hover:text-white hover:bg-blue-600 transition" role="menuitem">
              <i class="fas fa-id-card fa-fw flex-shrink-0"></i>
              <span class="nav-text flex-1">Drivers</span>
            </a>
            <a href="devices.html" class="nav-link flex items-center gap-4 px-4 py-2 text-base font-medium text-blue-100 rounded-lg hover:text-white hover:bg-blue-600 transition" role="menuitem">
              <i class="fas fa-satellite-dish fa-fw flex-shrink-0"></i>
              <span class="nav-text flex-1">Devices</span>
            </a>
          </div>
        </div>

        <!-- Alerts Main Section -->
        <div class="sidebar-section">
          <div class="flex items-center gap-4 px-5 py-2 text-base font-bold text-yellow-300 uppercase tracking-wide mb-2">
            <i class="fas fa-bell fa-fw flex-shrink-0"></i>
            <span class="nav-text flex-1">Alerts</span>
          </div>
          <div class="ml-8 space-y-3 flex flex-col">
            <a href="active-alerts.html" class="nav-link flex items-center gap-4 px-4 py-2 text-base font-medium text-yellow-100 rounded-lg hover:text-white hover:bg-yellow-400/20 transition" role="menuitem">
              <i class="fas fa-exclamation-triangle fa-fw flex-shrink-0"></i>
              <span class="nav-text flex-1">Active Alerts</span>
            </a>
            <a href="closed-alerts.html" class="nav-link flex items-center gap-4 px-4 py-2 text-base font-medium text-yellow-100 rounded-lg hover:text-white hover:bg-yellow-400/20 transition" role="menuitem">
              <i class="fas fa-check-circle fa-fw flex-shrink-0"></i>
              <span class="nav-text flex-1">Closed Alerts</span>
            </a>
          </div>
        </div>

        <!-- Reports Main Section -->
        <div class="sidebar-section">
          <div class="flex items-center gap-4 px-5 py-2 text-base font-bold text-green-300 uppercase tracking-wide mb-2">
            <i class="fas fa-chart-line fa-fw flex-shrink-0"></i>
            <span class="nav-text flex-1">Reports</span>
          </div>
          <div class="ml-8 space-y-3 flex flex-col">
            <a href="vehicle-activity.html" class="nav-link flex items-center gap-4 px-4 py-2 text-base font-medium text-green-100 rounded-lg hover:text-white hover:bg-green-400/20 transition" role="menuitem">
              <i class="fas fa-chart-bar fa-fw flex-shrink-0"></i>
              <span class="nav-text flex-1">Vehicle Activity</span>
            </a>
            <a href="driver-activity.html" class="nav-link flex items-center gap-4 px-4 py-2 text-base font-medium text-green-100 rounded-lg hover:text-white hover:bg-green-400/20 transition" role="menuitem">
              <i class="fas fa-user-clock fa-fw flex-shrink-0"></i>
              <span class="nav-text flex-1">Driver Activity</span>
            </a>
          </div>
        </div>



        <!-- Other -->
        <div class="sidebar-section mt-8 flex flex-col gap-3">
          <a href="#" class="nav-link flex items-center gap-4 px-4 py-2 text-base font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-600 transition" role="menuitem">
            <i class="fas fa-cogs fa-fw flex-shrink-0"></i>
            <span class="nav-text flex-1">Settings</span>
          </a>
          <a href="my-profile.html" class="nav-link flex items-center gap-4 px-4 py-2 text-base font-medium text-blue-200 rounded-lg hover:text-white hover:bg-blue-600 transition" role="menuitem">
            <i class="fas fa-user fa-fw flex-shrink-0"></i>
            <span class="nav-text flex-1">My Profile</span>
          </a>
        </div>
      </nav>
    </aside>

    <main id="main-content-container" class="flex-1 bg-transparent pt-20 w-full" aria-label="Main Content">

      <div id="dashboard-wrapper" class="w-full">
        <div id="dashboard" class="px-0 py-0 w-full">
          
          <!-- Fleet Metrics Section -->
          <section class="fleet-metrics-section mt-2">
            <div class="dashboard-widget w-full bg-gradient-to-br from-blue-50 via-white to-green-50 relative">
              <div class="flex justify-between items-center mb-6 pt-2">
                <h3 class="text-2xl font-extrabold text-blue-800 flex items-center gap-3">
                  <i class="fas fa-chart-line text-green-500 text-2xl"></i>
                  Fleet Performance Dashboard
                </h3>
              </div>

              <!-- Time Filter Controls -->
              <div class="fleet-time-filter mb-8 flex flex-col gap-3">
                <div class="flex gap-2 mb-2">
                  <button class="fleet-time-btn px-4 py-2 rounded-lg bg-blue-100 text-blue-800 font-semibold hover:bg-blue-200 transition-colors" data-range="day">Day</button>
                  <button class="fleet-time-btn px-4 py-2 rounded-lg bg-green-100 text-green-800 font-semibold hover:bg-green-200 transition-colors" data-range="week">Week</button>
                  <button class="fleet-time-btn px-4 py-2 rounded-lg bg-purple-100 text-purple-800 font-semibold hover:bg-purple-200 transition-colors" data-range="month">Month</button>
                  <button class="fleet-time-btn px-4 py-2 rounded-lg bg-gray-100 text-gray-800 font-semibold hover:bg-gray-200 transition-colors" data-range="custom">Custom</button>
                </div>
                <div id="fleet-custom-date-range" class="hidden flex gap-2 items-center">
                  <label class="text-sm text-gray-600 font-medium">From</label>
                  <input type="date" id="fleet-date-from" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                  <label class="text-sm text-gray-600 font-medium">To</label>
                  <input type="date" id="fleet-date-to" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                  <button id="fleet-date-apply" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Apply</button>
                </div>
              </div>

              <!-- Primary KPI Metrics -->
              <div class="mb-8">
                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <i class="fas fa-tachometer-alt text-blue-600"></i>
                  Real-Time Fleet Status
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 mb-6" style="gap: var(--grid-gap);">
                  <div class="kpi-card bg-white shadow-lg rounded-xl p-4 flex flex-col items-center min-w-[140px] transition-transform duration-300 hover:scale-105 border border-blue-100">
                    <div class="flex items-center space-x-2 mb-2">
                      <i class="fas fa-truck text-blue-600 text-xl"></i>
                      <span class="font-bold text-2xl" id="kpi-total-vehicles">100</span>
                    </div>
                    <div class="text-sm text-gray-600 font-medium">Total Vehicles</div>
                    <canvas id="sparkline-total-vehicles" width="80" height="24" class="mt-2"></canvas>
                    <span id="goal-total-vehicles" class="text-xs font-semibold mt-1"></span>
                  </div>
                  <div class="kpi-card bg-white shadow-lg rounded-xl p-4 flex flex-col items-center min-w-[140px] transition-transform duration-300 hover:scale-105 border border-green-100">
                    <div class="flex items-center space-x-2 mb-2">
                      <i class="fas fa-bolt text-green-600 text-xl"></i>
                      <span class="font-bold text-2xl" id="kpi-active">61</span>
                    </div>
                    <div class="text-sm text-gray-600 font-medium">Active</div>
                    <canvas id="sparkline-active" width="80" height="24" class="mt-2"></canvas>
                    <span id="goal-active" class="text-xs font-semibold mt-1"></span>
                  </div>
                  <div class="kpi-card bg-white shadow-lg rounded-xl p-4 flex flex-col items-center min-w-[140px] transition-transform duration-300 hover:scale-105 border border-yellow-100">
                    <div class="flex items-center space-x-2 mb-2">
                      <i class="fas fa-parking text-yellow-500 text-xl"></i>
                      <span class="font-bold text-2xl" id="kpi-idling">25</span>
                    </div>
                    <div class="text-sm text-gray-600 font-medium">Idling</div>
                    <canvas id="sparkline-idling" width="80" height="24" class="mt-2"></canvas>
                    <span id="goal-idling" class="text-xs font-semibold mt-1"></span>
                  </div>
                  <div class="kpi-card bg-white shadow-lg rounded-xl p-4 flex flex-col items-center min-w-[140px] transition-transform duration-300 hover:scale-105 border border-blue-100">
                    <div class="flex items-center space-x-2 mb-2">
                      <i class="fas fa-car-side text-blue-500 text-xl"></i>
                      <span class="font-bold text-2xl" id="kpi-parked">11</span>
                    </div>
                    <div class="text-sm text-gray-600 font-medium">Parked</div>
                    <canvas id="sparkline-parked" width="80" height="24" class="mt-2"></canvas>
                    <span id="goal-parked" class="text-xs font-semibold mt-1"></span>
                  </div>
                  <div class="kpi-card bg-white shadow-lg rounded-xl p-4 flex flex-col items-center min-w-[140px] transition-transform duration-300 hover:scale-105 border border-gray-100">
                    <div class="flex items-center space-x-2 mb-2">
                      <i class="fas fa-power-off text-gray-500 text-xl"></i>
                      <span class="font-bold text-2xl" id="kpi-offline">3</span>
                    </div>
                    <div class="text-sm text-gray-600 font-medium">Offline</div>
                    <canvas id="sparkline-offline" width="80" height="24" class="mt-2"></canvas>
                    <span id="goal-offline" class="text-xs font-semibold mt-1"></span>
                  </div>
                  <div class="kpi-card bg-white shadow-lg rounded-xl p-4 flex flex-col items-center min-w-[140px] transition-transform duration-300 hover:scale-105 border border-green-100">
                    <div class="flex items-center space-x-2 mb-2">
                      <i class="fas fa-gas-pump text-green-600 text-xl"></i>
                      <span class="font-bold text-2xl" id="kpi-efficiency">8.5</span>
                      <span class="text-base text-gray-500">km/L</span>
                    </div>
                    <div class="text-sm text-gray-600 font-medium">Avg Efficiency</div>
                    <canvas id="sparkline-efficiency" width="80" height="24" class="mt-2"></canvas>
                    <span id="goal-efficiency" class="text-xs font-semibold mt-1"></span>
                  </div>
                </div>
              </div>

              <!-- Extended Fleet Analytics -->
              <div>
                <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                  <i class="fas fa-analytics text-purple-600"></i>
                  Fleet Analytics & Performance
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6" style="gap: var(--grid-gap);">
                  <div class="fleet-metric-card bg-white/90 rounded-xl p-5 shadow-lg flex flex-col items-center border border-blue-100 hover:shadow-xl transition-all">
                    <div class="flex items-center gap-2 mb-2">
                      <i class="fas fa-road text-blue-600 text-lg"></i>
                      <span class="text-sm text-gray-600 font-medium">Total Distance</span>
                    </div>
                    <div class="text-2xl font-bold text-blue-700">12,450 km</div>
                    <span class="text-xs text-gray-500">This month</span>
                  </div>
                  <div class="fleet-metric-card bg-white/90 rounded-xl p-5 shadow-lg flex flex-col items-center border border-orange-100 hover:shadow-xl transition-all">
                    <div class="flex items-center gap-2 mb-2">
                      <i class="fas fa-shipping-fast text-orange-600 text-lg"></i>
                      <span class="text-sm text-gray-600 font-medium">Total Deliveries</span>
                    </div>
                    <div class="text-2xl font-bold text-orange-700">1,847</div>
                    <span class="text-xs text-gray-500">This month</span>
                  </div>
                  <div class="fleet-metric-card bg-white/90 rounded-xl p-5 shadow-lg flex flex-col items-center border border-purple-100 hover:shadow-xl transition-all">
                    <div class="flex items-center gap-2 mb-2">
                      <i class="fas fa-clock text-purple-600 text-lg"></i>
                      <span class="text-sm text-gray-600 font-medium">Avg Trip Duration</span>
                    </div>
                    <div class="text-2xl font-bold text-purple-700">1h 15m</div>
                    <span class="text-xs text-gray-500">Per trip</span>
                  </div>
                  <div class="fleet-metric-card bg-white/90 rounded-xl p-5 shadow-lg flex flex-col items-center border border-yellow-100 hover:shadow-xl transition-all">
                    <div class="flex items-center gap-2 mb-2">
                      <i class="fas fa-tachometer-alt text-yellow-500 text-lg"></i>
                      <span class="text-sm text-gray-600 font-medium">Avg Speed</span>
                    </div>
                    <div class="text-2xl font-bold text-yellow-700">62 km/h</div>
                    <span class="text-xs text-gray-500">Fleet-wide</span>
                  </div>
                  <div class="fleet-metric-card bg-white/90 rounded-xl p-5 shadow-lg flex flex-col items-center border border-red-100 hover:shadow-xl transition-all">
                    <div class="flex items-center gap-2 mb-2">
                      <i class="fas fa-exclamation-triangle text-red-500 text-lg"></i>
                      <span class="text-sm font-medium text-red-600">Critical Alerts</span>
                    </div>
                    <div class="text-2xl font-bold text-red-600">39</div>
                    <span class="text-xs text-gray-500">Last 24h</span>
                  </div>
                  <div class="fleet-metric-card bg-white/90 rounded-xl p-5 shadow-lg flex flex-col items-center border border-gray-100 hover:shadow-xl transition-all">
                    <div class="flex items-center gap-2 mb-2">
                      <i class="fas fa-tools text-gray-700 text-lg"></i>
                      <span class="text-sm text-gray-600 font-medium">Maintenance Due</span>
                    </div>
                    <div class="text-2xl font-bold text-gray-700">77</div>
                    <span class="text-xs text-gray-500">Vehicles</span>
                  </div>
                </div>
              </div>
            </div>
          </section>
          
          <!-- Google Maps Fleet Tracking Section -->
          <section class="google-maps-section mt-6">
            <div class="dashboard-widget w-full bg-gradient-to-br from-gray-50 via-white to-blue-50 relative">
              <div class="flex justify-between items-center mb-4 pt-2">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                  <i class="fas fa-map-marked-alt text-blue-500"></i>
                  Fleet Tracking Map
                </h3>
                <div class="flex gap-2">
                  <span class="px-3 py-1 bg-blue-100 text-blue-600 rounded text-sm">
                    <i class="fas fa-layer-group"></i> OpenLayers
                  </span>
                  <span class="px-3 py-1 bg-green-100 text-green-600 rounded text-sm">
                    <i class="fas fa-wifi"></i> Live Updates
                  </span>
                </div>
              </div>
              
              <!-- Map Controls -->
              <div class="mb-4 flex flex-wrap gap-2">
                <button id="center-fleet" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                  <i class="fas fa-crosshairs mr-1"></i>Center Fleet
                </button>
                <button id="toggle-clustering" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">
                  <i class="fas fa-layer-group mr-1"></i>Clustering ON
                </button>
                <button id="create-geofence" class="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm">
                  <i class="fas fa-draw-polygon mr-1"></i>Create Geofence
                </button>
                <button id="toggle-traffic" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">
                  <i class="fas fa-road mr-1"></i>Traffic Layer
                </button>
                <button id="toggle-satellite" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">
                  <i class="fas fa-satellite mr-1"></i>Satellite View
                </button>
                <button id="refresh-vehicles" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                  <i class="fas fa-sync mr-1"></i>Refresh
                </button>
              </div>
              
              <!-- Fleet Map Container -->
              <div id="fleet-map-container" style="height: 450px; width: 100%; border-radius: 8px; border: 1px solid #e5e7eb; position: relative; overflow: hidden;"></div>
              
              <!-- Map Statistics -->
              <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="text-center">
                  <div class="font-semibold text-green-600" id="active-vehicles">0</div>
                  <div class="text-gray-600">Active Vehicles</div>
                </div>
                <div class="text-center">
                  <div class="font-semibold text-blue-600" id="total-routes">0</div>
                  <div class="text-gray-600">Active Routes</div>
                </div>
                <div class="text-center">
                  <div class="font-semibold text-orange-600" id="traffic-alerts">0</div>
                  <div class="text-gray-600">Traffic Alerts</div>
                </div>
                <div class="text-center">
                  <div class="font-semibold text-purple-600" id="coverage-area">0 km</div>
                  <div class="text-gray-600">Coverage Area</div>
                </div>
              </div>
            </div>
          </section>
          


          <!-- Driver Leaderboard Section -->
          <section class="driver-leaderboard-section">
            <div class="dashboard-widget w-full bg-gradient-to-br from-white via-blue-50 to-purple-50">
      <!-- Header Section -->
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-8">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-red-500 rounded-full flex items-center justify-center shadow-lg">
            <i class="fas fa-trophy text-white text-xl"></i>
          </div>
          <div>
            <h2 class="text-3xl font-bold text-gray-900">Driver Leaderboard</h2>
            <p class="text-gray-600">Real-time performance rankings and analytics</p>
          </div>
        </div>
        
        <!-- Controls Section -->
        <div class="flex flex-wrap gap-3 items-center">
          <!-- Time Period Filter -->
          <div class="flex bg-white rounded-lg border border-gray-200 shadow-sm">
            <button class="leaderboard-time-btn active px-4 py-2 text-sm font-medium rounded-l-lg bg-blue-600 text-white" data-period="today">Today</button>
            <button class="leaderboard-time-btn px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" data-period="week">Week</button>
            <button class="leaderboard-time-btn px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" data-period="month">Month</button>
            <button class="leaderboard-time-btn px-4 py-2 text-sm font-medium rounded-r-lg text-gray-700 hover:bg-gray-50" data-period="custom">Custom</button>
          </div>
          
          <!-- Category Filter -->
          <select id="leaderboard-category" class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium bg-white shadow-sm">
            <option value="overall">Overall Ranking</option>
            <option value="safety">Safety Score</option>
            <option value="fuel">Fuel Efficiency</option>
            <option value="compliance">Compliance</option>
            <option value="productivity">Productivity</option>
            <option value="vehicle-health">Vehicle Health</option>
          </select>

          <!-- Team Filter -->
          <select id="leaderboard-team" class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium bg-white shadow-sm">
            <option value="all">All Teams</option>
            <option value="delivery">Delivery Team</option>
            <option value="service">Service Team</option>
            <option value="logistics">Logistics Team</option>
          </select>

          <!-- Anonymization Toggle -->
          <label class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg shadow-sm cursor-pointer">
            <input type="checkbox" id="anonymize-toggle" class="w-4 h-4 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Anonymize</span>
          </label>

          <!-- Action Buttons -->
          <div class="flex gap-2">
            <button id="assign-coaching-btn" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm font-medium flex items-center gap-2">
              <i class="fas fa-chalkboard-teacher"></i>
              <span>Assign Coaching</span>
            </button>
            <button id="grant-recognition-btn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium flex items-center gap-2">
              <i class="fas fa-medal"></i>
              <span>Grant Recognition</span>
            </button>
            <button id="reward-performer-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium flex items-center gap-2">
              <i class="fas fa-gift"></i>
              <span>Reward Top Performers</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Custom Date Range -->
      <div id="custom-date-range" class="hidden mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <div class="flex flex-wrap gap-4 items-center">
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-700">From:</label>
            <input type="date" id="leaderboard-date-from" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-700">To:</label>
            <input type="date" id="leaderboard-date-to" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
          </div>
          <button id="apply-custom-date" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">Apply</button>
        </div>
      </div>

      <!-- KPI Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
        <div class="bg-white rounded-xl p-4 shadow-lg border border-blue-100">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-shield-alt text-blue-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Avg Safety Score</p>
              <p class="text-xl font-bold text-gray-900" id="avg-safety-score">92.5</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl p-4 shadow-lg border border-green-100">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-gas-pump text-green-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Avg Fuel Eff.</p>
              <p class="text-xl font-bold text-gray-900" id="avg-fuel-efficiency">8.7 km/L</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl p-4 shadow-lg border border-purple-100">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-clock text-purple-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Avg Compliance</p>
              <p class="text-xl font-bold text-gray-900" id="avg-compliance">96.2%</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl p-4 shadow-lg border border-orange-100">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-chart-line text-orange-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Productivity</p>
              <p class="text-xl font-bold text-gray-900" id="avg-productivity">24.5 trips/day</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl p-4 shadow-lg border border-red-100">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-tools text-red-600"></i>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Vehicle Health</p>
              <p class="text-xl font-bold text-gray-900" id="avg-vehicle-health">94.1%</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Leaderboard Table -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
        <div class="table-wrap">
          <table class="table">
            <thead class="bg-gradient-to-r from-gray-50 to-blue-50">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Driver</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Overall Score</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Safety</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fuel Eff.</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Compliance</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trips/Day</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profitability/Day</th>
                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="leaderboard-table-body" class="bg-white divide-y divide-gray-200">
              <!-- Dynamic content will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Goal Setting Panel Removed -->

    </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Goal Setting Modal -->
  <div id="goal-setting-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900">Set Performance Goals</h3>
        <button id="close-goal-modal" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form id="goal-setting-form" class="space-y-6">
        <!-- Driver Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Driver</label>
          <select id="goal-driver-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="">Choose a driver...</option>
            <option value="all">All Drivers</option>
            <option value="driver1">John Mitchell</option>
            <option value="driver2">Sarah Wilson</option>
            <option value="driver3">Mike Johnson</option>
          </select>
        </div>

  <!-- Goal Setting Modal Removed -->
            <option value="year">1 Year</option>
          </select>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
          <button type="button" id="cancel-goals" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Save Goals
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Feedback Submission Modal -->
  <div id="feedback-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-comment-dots text-orange-600"></i>
          Submit Feedback & Suggestions
        </h3>
        <button id="close-feedback-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="mb-6">
        <p class="text-gray-600 text-sm leading-relaxed">
          Help us improve the dashboard! Share your thoughts on the design, features, usability, or suggest new functionality. Your feedback is valuable and will be reviewed by our development team.
        </p>
      </div>

      <form id="feedback-form" class="space-y-6">
        <!-- Name Field -->
        <div>
          <label for="feedback-name" class="block text-sm font-medium text-gray-700 mb-2">
            Your Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="feedback-name" 
            name="name"
            required
            placeholder="Enter your full name"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors"
          >
        </div>

        <!-- Feedback/Note Field -->
        <div>
          <label for="feedback-note" class="block text-sm font-medium text-gray-700 mb-2">
            Feedback & Comments <span class="text-red-500">*</span>
          </label>
          <textarea 
            id="feedback-note" 
            name="note"
            required
            rows="8"
            placeholder="Please describe your feedback, suggestions, or issues in detail. Be specific about what you liked, what could be improved, or what new features you'd like to see..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors resize-vertical"
          ></textarea>
          <div class="mt-1 text-xs text-gray-500">
            <span id="char-count">0</span>/1000 characters
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex flex-col sm:flex-row gap-3 pt-4">
          <button 
            type="submit" 
            id="submit-feedback-btn"
            class="flex-1 px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 focus:ring-4 focus:ring-orange-500/20 transition-all font-medium flex items-center justify-center gap-2"
          >
            <i class="fas fa-paper-plane"></i>
            Submit Feedback
          </button>
          <button 
            type="button" 
            id="cancel-feedback-btn"
            class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:ring-4 focus:ring-gray-500/20 transition-all font-medium"
          >
            Cancel
          </button>
        </div>
      </form>

      <!-- Success Message -->
      <div id="feedback-success" class="hidden text-center py-8">
        <div class="mb-4">
          <i class="fas fa-check-circle text-5xl text-green-500"></i>
        </div>
        <h4 class="text-xl font-bold text-gray-900 mb-2">Feedback Submitted Successfully!</h4>
        <p class="text-gray-600 mb-4">Thank you for your valuable feedback. Our team will review it and get back to you if needed.</p>
        <button id="submit-another-feedback" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
          Submit Another Feedback
        </button>
      </div>
    </div>
  </div>



  <!-- Coaching Assignment Modal -->
  <div id="coaching-assignment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-chalkboard-teacher text-orange-600"></i>
          Assign Coaching & Training
        </h3>
        <button id="close-coaching-modal" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form id="coaching-assignment-form" class="space-y-6">
        <!-- Driver Selection -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Select Driver(s)</label>
            <div class="max-h-48 overflow-y-auto border border-gray-300 rounded-lg p-3 space-y-2">
              <label class="flex items-center gap-2">
                <input type="checkbox" value="all" class="driver-checkbox text-orange-600">
                <span class="text-sm font-medium">All Drivers</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" value="low-performers" class="driver-checkbox text-orange-600">
                <span class="text-sm font-medium">Low Performers (Score < 85)</span>
              </label>
              <hr class="my-2">
              <label class="flex items-center gap-2">
                <input type="checkbox" value="driver1" class="driver-checkbox text-orange-600">
                <span class="text-sm">John Mitchell (Score: 96.5)</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" value="driver2" class="driver-checkbox text-orange-600">
                <span class="text-sm">Sarah Wilson (Score: 94.2)</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" value="driver3" class="driver-checkbox text-orange-600">
                <span class="text-sm">Mike Johnson (Score: 91.8)</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" value="driver4" class="driver-checkbox text-orange-600">
                <span class="text-sm">Emma Davis (Score: 98.1)</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" value="driver5" class="driver-checkbox text-orange-600">
                <span class="text-sm">Alex Rodriguez (Score: 89.5) - Needs Improvement</span>
              </label>
            </div>
          </div>

          <!-- Course Selection -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Training Courses</label>
            <div class="space-y-3">
              <div class="border border-gray-200 rounded-lg p-4">
                <label class="flex items-start gap-3">
                  <input type="checkbox" value="defensive-driving" class="course-checkbox text-orange-600 mt-1">
                  <div>
                    <h4 class="font-medium text-gray-900">Defensive Driving</h4>
                    <p class="text-sm text-gray-600">Advanced safety techniques and hazard awareness</p>
                    <p class="text-xs text-gray-500">Duration: 4 hours | Online/In-person</p>
                  </div>
                </label>
              </div>
              
              <div class="border border-gray-200 rounded-lg p-4">
                <label class="flex items-start gap-3">
                  <input type="checkbox" value="eco-driving" class="course-checkbox text-orange-600 mt-1">
                  <div>
                    <h4 class="font-medium text-gray-900">Eco-Driving Techniques</h4>
                    <p class="text-sm text-gray-600">Fuel-efficient driving and environmental awareness</p>
                    <p class="text-xs text-gray-500">Duration: 3 hours | Online</p>
                  </div>
                </label>
              </div>
              
              <div class="border border-gray-200 rounded-lg p-4">
                <label class="flex items-start gap-3">
                  <input type="checkbox" value="compliance-training" class="course-checkbox text-orange-600 mt-1">
                  <div>
                    <h4 class="font-medium text-gray-900">Compliance & Regulations</h4>
                    <p class="text-sm text-gray-600">DOT regulations, route adherence, and documentation</p>
                    <p class="text-xs text-gray-500">Duration: 2 hours | Online</p>
                  </div>
                </label>
              </div>
              
              <div class="border border-gray-200 rounded-lg p-4">
                <label class="flex items-start gap-3">
                  <input type="checkbox" value="customer-service" class="course-checkbox text-orange-600 mt-1">
                  <div>
                    <h4 class="font-medium text-gray-900">Customer Service Excellence</h4>
                    <p class="text-sm text-gray-600">Professional communication and service delivery</p>
                    <p class="text-xs text-gray-500">Duration: 2.5 hours | In-person</p>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule and Priority -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Priority Level</label>
            <select id="coaching-priority" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
              <option value="low">Low Priority</option>
              <option value="medium">Medium Priority</option>
              <option value="high">High Priority</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Completion Deadline</label>
            <input type="date" id="coaching-deadline" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Method</label>
            <select id="coaching-method" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
              <option value="online">Online</option>
              <option value="in-person">In-Person</option>
              <option value="hybrid">Hybrid</option>
              <option value="self-paced">Self-Paced</option>
            </select>
          </div>
        </div>

        <!-- Additional Notes -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
          <textarea id="coaching-notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" 
                    placeholder="Any specific requirements or notes for the training assignment..."></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
          <button type="button" id="cancel-coaching" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
            Assign Coaching
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Recognition Grant Modal -->
  <div id="recognition-grant-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-medal text-purple-600"></i>
          Grant Recognition & Awards
        </h3>
        <button id="close-recognition-modal" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form id="recognition-grant-form" class="space-y-6">
        <!-- Driver Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Driver</label>
          <select id="recognition-driver" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            <option value="">Choose a driver...</option>
            <option value="driver1">John Mitchell (Safety Champion)</option>
            <option value="driver2">Sarah Wilson (Reliable Performer)</option>
            <option value="driver3">Mike Johnson (High Mileage)</option>
            <option value="driver4">Emma Davis (Top Performer)</option>
            <option value="driver5">Alex Rodriguez (Improvement Progress)</option>
          </select>
        </div>

        <!-- Recognition Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Recognition Type</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="recognition-type" value="safety-champion" class="text-purple-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-green-600"></i>
                    Safety Champion
                  </h4>
                  <p class="text-sm text-gray-600">Outstanding safety record and practices</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="recognition-type" value="eco-driver" class="text-purple-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-leaf text-green-600"></i>
                    Eco Driver Award
                  </h4>
                  <p class="text-sm text-gray-600">Exceptional fuel efficiency performance</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="recognition-type" value="reliability-award" class="text-purple-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-clock text-blue-600"></i>
                    Reliability Award
                  </h4>
                  <p class="text-sm text-gray-600">Consistent on-time performance and compliance</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="recognition-type" value="customer-service" class="text-purple-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-handshake text-orange-600"></i>
                    Customer Service Excellence
                  </h4>
                  <p class="text-sm text-gray-600">Outstanding customer feedback and service</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="recognition-type" value="improvement" class="text-purple-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-chart-line text-purple-600"></i>
                    Most Improved
                  </h4>
                  <p class="text-sm text-gray-600">Significant performance improvement</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="recognition-type" value="custom" class="text-purple-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-star text-yellow-600"></i>
                    Custom Recognition
                  </h4>
                  <p class="text-sm text-gray-600">Create a custom recognition</p>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- Custom Recognition Details -->
        <div id="custom-recognition-details" class="hidden space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Custom Award Title</label>
            <input type="text" id="custom-award-title" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                   placeholder="e.g., Innovation Champion, Team Leader">
          </div>
        </div>

        <!-- Recognition Details -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Recognition Message</label>
          <textarea id="recognition-message" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                    placeholder="Personalized message explaining the recognition and achievements..."></textarea>
        </div>

        <!-- Public Recognition Options -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Public Recognition Options</label>
          <div class="space-y-2">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="recognition-dashboard" class="text-purple-600">
              <span class="text-sm">Display on company dashboard</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="recognition-email" class="text-purple-600">
              <span class="text-sm">Send congratulatory email to team</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="recognition-newsletter" class="text-purple-600">
              <span class="text-sm">Include in company newsletter</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="recognition-certificate" class="text-purple-600">
              <span class="text-sm">Generate printable certificate</span>
            </label>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
          <button type="button" id="cancel-recognition" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
            Grant Recognition
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reward Top Performers Modal -->
  <div id="reward-performers-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-gift text-green-600"></i>
          Reward Top Performers
        </h3>
        <button id="close-reward-modal" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form id="reward-performers-form" class="space-y-6">
        <!-- Top Performers Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Automatic Selection Criteria</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="selection-criteria" value="top-overall" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900">Top Overall Performers</h4>
                  <p class="text-sm text-gray-600">Top 3 drivers by overall score</p>
                  <p class="text-xs text-gray-500">Current: Emma Davis (98.1), John Mitchell (96.5), Sarah Wilson (94.2)</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="selection-criteria" value="top-safety" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900">Safety Leaders</h4>
                  <p class="text-sm text-gray-600">Highest safety scores</p>
                  <p class="text-xs text-gray-500">Current: Emma Davis (98.1), John Mitchell (96.5), Sarah Wilson (94.2)</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="selection-criteria" value="top-efficiency" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900">Fuel Efficiency Champions</h4>
                  <p class="text-sm text-gray-600">Best fuel efficiency ratings</p>
                  <p class="text-xs text-gray-500">Current: Emma Davis (8.8 km/L), John Mitchell (8.6 km/L), Sarah Wilson (8.6 km/L)</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="selection-criteria" value="most-improved" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900">Most Improved</h4>
                  <p class="text-sm text-gray-600">Biggest improvement over time period</p>
                  <p class="text-xs text-gray-500">Based on trend analysis</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="selection-criteria" value="custom" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900">Custom Selection</h4>
                  <p class="text-sm text-gray-600">Manually select drivers</p>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- Custom Driver Selection -->
        <div id="custom-driver-selection" class="hidden">
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Drivers Manually</label>
          <div class="max-h-48 overflow-y-auto border border-gray-300 rounded-lg p-3 space-y-2">
            <label class="flex items-center gap-2">
              <input type="checkbox" value="driver1" class="reward-driver-checkbox text-green-600">
              <span class="text-sm">John Mitchell (Overall: 96.5)</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" value="driver2" class="reward-driver-checkbox text-green-600">
              <span class="text-sm">Sarah Wilson (Overall: 94.2)</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" value="driver3" class="reward-driver-checkbox text-green-600">
              <span class="text-sm">Mike Johnson (Overall: 91.8)</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" value="driver4" class="reward-driver-checkbox text-green-600">
              <span class="text-sm">Emma Davis (Overall: 98.1)</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" value="driver5" class="reward-driver-checkbox text-green-600">
              <span class="text-sm">Alex Rodriguez (Overall: 89.5)</span>
            </label>
          </div>
        </div>

        <!-- Reward Type Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Reward Type</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="reward-type" value="monetary" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-dollar-sign text-green-600"></i>
                    Monetary Bonus
                  </h4>
                  <p class="text-sm text-gray-600">Cash bonus or gift card</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="reward-type" value="time-off" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-calendar-alt text-blue-600"></i>
                    Extra Time Off
                  </h4>
                  <p class="text-sm text-gray-600">Additional paid time off days</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="reward-type" value="parking" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-parking text-purple-600"></i>
                    Prime Parking Spot
                  </h4>
                  <p class="text-sm text-gray-600">Reserved parking for one month</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="reward-type" value="merchandise" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-tshirt text-orange-600"></i>
                    Company Merchandise
                  </h4>
                  <p class="text-sm text-gray-600">Branded apparel and accessories</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="reward-type" value="experience" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-ticket-alt text-red-600"></i>
                    Experience Reward
                  </h4>
                  <p class="text-sm text-gray-600">Event tickets, dinner vouchers, etc.</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="reward-type" value="custom" class="text-green-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-star text-yellow-600"></i>
                    Custom Reward
                  </h4>
                  <p class="text-sm text-gray-600">Define your own reward</p>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- Reward Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div id="monetary-details" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Bonus Amount</label>
            <div class="flex gap-2">
              <span class="inline-flex items-center px-3 py-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500 rounded-l-lg">$</span>
              <input type="number" id="bonus-amount" min="0" step="50" class="flex-1 px-4 py-3 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-green-500" 
                     placeholder="250">
            </div>
          </div>
          
          <div id="time-off-details" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Number of Days</label>
            <input type="number" id="time-off-days" min="1" max="5" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" 
                   placeholder="1">
          </div>
          
          <div id="custom-reward-details" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Custom Reward Description</label>
            <input type="text" id="custom-reward-desc" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" 
                   placeholder="Describe the custom reward...">
          </div>
        </div>

        <!-- Reward Message -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Reward Message</label>
          <textarea id="reward-message" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" 
                    placeholder="Personalized message for the rewarded drivers..."></textarea>
        </div>

        <!-- Announcement Options -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Announcement Options</label>
          <div class="space-y-2">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="announce-dashboard" class="text-green-600" checked>
              <span class="text-sm">Announce on dashboard</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="announce-email" class="text-green-600" checked>
              <span class="text-sm">Send congratulatory email</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="announce-meeting" class="text-green-600">
              <span class="text-sm">Announce in next team meeting</span>
            </label>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
          <button type="button" id="cancel-reward" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
            Process Rewards
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Task Assignment Modal -->
  <div id="task-assignment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
          <i class="fas fa-tasks text-blue-600"></i>
          Assign Task/Trip
        </h3>
        <button id="close-task-modal" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form id="task-assignment-form" class="space-y-6">
        <!-- Driver Information -->
        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
          <h4 class="font-medium text-gray-900 mb-2">Selected Driver</h4>
          <div id="selected-driver-info" class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-medium">
              <span id="driver-initials">JM</span>
            </div>
            <div>
              <p class="font-medium text-gray-900" id="driver-name">John Mitchell</p>
              <p class="text-sm text-gray-600" id="driver-current-status">Currently: Free</p>
            </div>
          </div>
        </div>

        <!-- Task Type Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Task Type</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="task-type" value="delivery" class="text-blue-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-shipping-fast text-blue-600"></i>
                    Delivery Trip
                  </h4>
                  <p class="text-sm text-gray-600">Standard delivery route assignment</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="task-type" value="pickup" class="text-blue-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-truck-loading text-green-600"></i>
                    Pickup Assignment
                  </h4>
                  <p class="text-sm text-gray-600">Collection and pickup tasks</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="task-type" value="maintenance" class="text-blue-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-tools text-orange-600"></i>
                    Maintenance Run
                  </h4>
                  <p class="text-sm text-gray-600">Vehicle maintenance or inspection</p>
                </div>
              </label>
            </div>
            
            <div class="border border-gray-200 rounded-lg p-4">
              <label class="flex items-start gap-3">
                <input type="radio" name="task-type" value="emergency" class="text-blue-600 mt-1">
                <div>
                  <h4 class="font-medium text-gray-900 flex items-center gap-2">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                    Emergency Task
                  </h4>
                  <p class="text-sm text-gray-600">Urgent priority assignment</p>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- Task Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Origin Address</label>
            <input type="text" id="origin-address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                   placeholder="Enter pickup/start location">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Destination Address</label>
            <input type="text" id="destination-address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                   placeholder="Enter delivery/end location">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Scheduled Start Time</label>
            <input type="datetime-local" id="start-time" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Expected Duration</label>
            <select id="expected-duration" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Select duration...</option>
              <option value="1">1 hour</option>
              <option value="2">2 hours</option>
              <option value="3">3 hours</option>
              <option value="4">4 hours</option>
              <option value="6">6 hours</option>
              <option value="8">8+ hours</option>
            </select>
          </div>
        </div>

        <!-- Vehicle Assignment -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Assign Vehicle</label>
          <select id="assigned-vehicle" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="">Select available vehicle...</option>
            <option value="vehicle1">Ford Transit - FT001 (Available)</option>
            <option value="vehicle2">Mercedes Sprinter - MS002 (Available)</option>
            <option value="vehicle3">Isuzu NPR - IN003 (Available)</option>
            <option value="vehicle4">Volvo FH - VF004 (Maintenance)</option>
          </select>
        </div>

        <!-- Priority and Notes -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Priority Level</label>
            <select id="task-priority" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="low">Low Priority</option>
              <option value="normal" selected>Normal Priority</option>
              <option value="high">High Priority</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Customer/Client</label>
            <input type="text" id="customer-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                   placeholder="Enter customer name">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Task Notes & Instructions</label>
          <textarea id="task-notes" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                    placeholder="Enter any special instructions, delivery notes, or additional information..."></textarea>
        </div>

        <!-- Notification Options -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Notification Options</label>
          <div class="space-y-2">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="notify-driver-sms" class="text-blue-600" checked>
              <span class="text-sm">Send SMS notification to driver</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="notify-driver-app" class="text-blue-600" checked>
              <span class="text-sm">Push notification to driver app</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="notify-customer" class="text-blue-600">
              <span class="text-sm">Notify customer of assignment</span>
            </label>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
          <button type="button" id="cancel-task-assignment" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
          <button type="button" id="save-draft-task" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
            Save as Draft
          </button>
          <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Assign Task
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="flex flex-col md:flex-row gap-6 mt-8 items-start justify-center">
    <div class="w-full md:w-2/3">
      <!-- ...existing dashboard content... -->
    </div>

  <!-- Clean Bell Notification System -->
  <script>
    // Clean bell notification dropdown with unread badge
    document.addEventListener('DOMContentLoaded', function() {
      const bellButton = document.getElementById('notifications-bell');
      const dropdown = document.getElementById('notifications-dropdown');
      const notificationCount = document.getElementById('notification-count');
      const markAllReadBtn = document.getElementById('mark-all-read');
      
      if (bellButton && dropdown && notificationCount) {
        let unreadCount = 3; // Initial unread count
        
        // Update badge count
        function updateBadgeCount(count = unreadCount) {
          unreadCount = count;
          notificationCount.textContent = unreadCount;
          notificationCount.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
        
        // Toggle dropdown
        bellButton.addEventListener('click', function(e) {
          e.stopPropagation();
          const isHidden = dropdown.classList.contains('hidden');
          
          if (isHidden) {
            dropdown.classList.remove('hidden');
            dropdown.style.display = 'block';
            dropdown.style.visibility = 'visible';
            dropdown.style.opacity = '1';
            bellButton.setAttribute('aria-expanded', 'true');
          } else {
            dropdown.classList.add('hidden');
            dropdown.style.display = 'none';
            bellButton.setAttribute('aria-expanded', 'false');
          }
        });
        
        // Mark all as read
        if (markAllReadBtn) {
          markAllReadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            updateBadgeCount(0);
            
            // Mark all notification items as read visually
            const notificationItems = dropdown.querySelectorAll('.notification-item');
            notificationItems.forEach(item => {
              item.style.opacity = '0.6';
              item.classList.add('read');
            });
          });
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!dropdown.contains(e.target) && !bellButton.contains(e.target)) {
            dropdown.classList.add('hidden');
            bellButton.setAttribute('aria-expanded', 'false');
          }
        });
        
        // Close dropdown on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && !dropdown.classList.contains('hidden')) {
            dropdown.classList.add('hidden');
            bellButton.setAttribute('aria-expanded', 'false');
            bellButton.focus();
          }
        });
        
        // Initialize badge count
        updateBadgeCount();
        
        // Expose function for external use
        window.updateNotificationCount = updateBadgeCount;
        
        // Test function to manually show dropdown
        window.testShowDropdown = function() {
          console.log('Testing dropdown show...');
          dropdown.classList.remove('hidden');
          dropdown.style.display = 'block';
          dropdown.style.visibility = 'visible';
          dropdown.style.opacity = '1';
          dropdown.style.backgroundColor = 'red';
          console.log('Test dropdown should be visible');
        };
        
        console.log('Bell notification system initialized');
        console.log('Bell button:', bellButton);
        console.log('Dropdown:', dropdown);
        console.log('Test with: testShowDropdown()');
      }
    });
  </script>

  <!-- Quick Actions FAB JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const quickActionsFab = document.getElementById('quick-actions-fab');
      const quickActionsMenu = document.getElementById('quick-actions-menu');
      let isMenuOpen = false;

      // Toggle menu on FAB click
      if (quickActionsFab) {
        quickActionsFab.addEventListener('click', function() {
          isMenuOpen = !isMenuOpen;
          
          if (isMenuOpen) {
            // Show menu
            quickActionsMenu.classList.remove('hidden');
            setTimeout(() => {
              quickActionsMenu.classList.remove('scale-95', 'opacity-0');
              quickActionsMenu.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // Rotate FAB icon
            const icon = quickActionsFab.querySelector('i');
            icon.style.transform = 'rotate(45deg)';
          } else {
            // Hide menu
            quickActionsMenu.classList.remove('scale-100', 'opacity-100');
            quickActionsMenu.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
              quickActionsMenu.classList.add('hidden');
            }, 300);
            
            // Reset FAB icon
            const icon = quickActionsFab.querySelector('i');
            icon.style.transform = 'rotate(0deg)';
          }
        });
      }

      // Handle quick action button clicks
      const quickActionBtns = document.querySelectorAll('.quick-action-btn');
      quickActionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const action = this.getAttribute('data-action');
          const actionName = this.querySelector('.font-medium').textContent;
          
          // Close menu first
          isMenuOpen = false;
          quickActionsMenu.classList.remove('scale-100', 'opacity-100');
          quickActionsMenu.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
            quickActionsMenu.classList.add('hidden');
          }, 300);
          
          // Reset FAB icon
          const icon = quickActionsFab.querySelector('i');
          icon.style.transform = 'rotate(0deg)';
          
          // Handle the specific action
          handleQuickAction(action, actionName);
        });
      });

      // Close menu when clicking outside
      document.addEventListener('click', function(event) {
        if (isMenuOpen && !quickActionsFab.contains(event.target) && !quickActionsMenu.contains(event.target)) {
          isMenuOpen = false;
          quickActionsMenu.classList.remove('scale-100', 'opacity-100');
          quickActionsMenu.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
            quickActionsMenu.classList.add('hidden');
          }, 300);
          
          // Reset FAB icon
          const icon = quickActionsFab.querySelector('i');
          icon.style.transform = 'rotate(0deg)';
        }
      });

      // Handle quick actions
      function handleQuickAction(action, actionName) {
        switch(action) {
          case 'add-vehicle':
            openAddVehicleModal();
            break;
          case 'add-driver':
            openAddDriverModal();
            break;
          case 'create-route':
            openCreateRouteModal();
            break;
          case 'schedule-maintenance':
            openScheduleMaintenanceModal();
            break;
          case 'create-alert':
            openCreateAlertModal();
            break;
          case 'generate-report':
            openGenerateReportModal();
            break;
          default:
            alert(`Action: ${actionName}\n\nThis feature would be implemented based on your specific requirements.`);
        }
      }
      
      // Add Vehicle Modal
      function openAddVehicleModal() {
        createModal('add-vehicle-modal', 'Add New Vehicle', `
          <form id="add-vehicle-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Vehicle Information -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Vehicle Information</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Vehicle ID</label>
                  <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="FL-XXX" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Make & Model</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Vehicle Type</option>
                    <option value="Mercedes Sprinter">Mercedes Sprinter</option>
                    <option value="Ford Transit">Ford Transit</option>
                    <option value="Iveco Daily">Iveco Daily</option>
                    <option value="Volkswagen Crafter">Volkswagen Crafter</option>
                    <option value="Renault Master">Renault Master</option>
                    <option value="Peugeot Boxer">Peugeot Boxer</option>
                    <option value="Fiat Ducato">Fiat Ducato</option>
                    <option value="MAN TGE">MAN TGE</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">VIN Number</label>
                  <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="1HGBH41JXMN109186" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">License Plate</label>
                  <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ABC-123" required>
                </div>
              </div>
              
              <!-- Vehicle Details -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Vehicle Details</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Year</label>
                  <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="2023" min="2000" max="2025" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Fuel Type</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Fuel Type</option>
                    <option value="Diesel">Diesel</option>
                    <option value="Gasoline">Gasoline</option>
                    <option value="Electric">Electric</option>
                    <option value="Hybrid">Hybrid</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Capacity (kg)</label>
                  <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="1500" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Assign Driver</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Unassigned</option>
                    <option value="DR-001">Sarah Johnson</option>
                    <option value="DR-002">Michael Chen</option>
                    <option value="DR-003">Emma Davis</option>
                    <option value="DR-004">David Wilson</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-6 border-t">
              <button type="button" onclick="closeModal('add-vehicle-modal')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add Vehicle</button>
            </div>
          </form>
        `, handleAddVehicleSubmit);
      }
      
      // Add Driver Modal
      function openAddDriverModal() {
        createModal('add-driver-modal', 'Add New Driver', `
          <form id="add-driver-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Personal Information -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Personal Information</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                  <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="John Doe" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                  <input type="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="john.doe@company.com" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                  <input type="tel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+1 (555) 123-4567" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                  <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
              </div>
              
              <!-- License & Employment -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">License & Employment</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Driver's License</label>
                  <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="DL123456789" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">License Expiry</label>
                  <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Employment Start Date</label>
                  <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Assign Vehicle</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">No Vehicle Assigned</option>
                    <option value="FL-001">FL-001 - Mercedes Sprinter</option>
                    <option value="FL-002">FL-002 - Ford Transit</option>
                    <option value="FL-003">FL-003 - Iveco Daily</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-6 border-t">
              <button type="button" onclick="closeModal('add-driver-modal')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Add Driver</button>
            </div>
          </form>
        `, handleAddDriverSubmit);
      }
      
      // Create Route Modal
      function openCreateRouteModal() {
        createModal('create-route-modal', 'Create New Route', `
          <form id="create-route-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Route Information -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Route Information</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Route Name</label>
                  <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Downtown Delivery Route" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Starting Point</label>
                  <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Warehouse A - Main St 123" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Ending Point</label>
                  <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Customer Location" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Duration</label>
                  <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
              </div>
              
              <!-- Assignment & Schedule -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Assignment & Schedule</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Assign Driver</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Driver</option>
                    <option value="DR-001">Sarah Johnson - Mercedes Sprinter</option>
                    <option value="DR-002">Michael Chen - Ford Transit</option>
                    <option value="DR-003">Emma Davis - Iveco Daily</option>
                    <option value="DR-004">David Wilson - Volkswagen Crafter</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Scheduled Date</label>
                  <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Start Time</label>
                  <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="low">Low Priority</option>
                    <option value="medium" selected>Medium Priority</option>
                    <option value="high">High Priority</option>
                    <option value="urgent">Urgent</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="space-y-4">
              <h4 class="font-semibold text-gray-900 border-b pb-2">Waypoints</h4>
              <div class="bg-gray-50 p-4 rounded-lg">
                <p class="text-sm text-gray-600 mb-3">Add stops along the route:</p>
                <div id="waypoints-container" class="space-y-2">
                  <div class="flex gap-2">
                    <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Stop 1: Address or landmark">
                    <button type="button" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600" onclick="this.parentElement.remove()">Remove</button>
                  </div>
                </div>
                <button type="button" onclick="addWaypoint()" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">+ Add Waypoint</button>
              </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-6 border-t">
              <button type="button" onclick="closeModal('create-route-modal')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">Create Route</button>
            </div>
          </form>
        `, handleCreateRouteSubmit);
      }
      
      // Schedule Maintenance Modal
      function openScheduleMaintenanceModal() {
        createModal('schedule-maintenance-modal', 'Schedule Maintenance', `
          <form id="schedule-maintenance-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Vehicle & Service -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Vehicle & Service</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Select Vehicle</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Choose Vehicle</option>
                    <option value="FL-001">FL-001 - Mercedes Sprinter (Sarah Johnson)</option>
                    <option value="FL-002">FL-002 - Ford Transit (Michael Chen)</option>
                    <option value="FL-003">FL-003 - Iveco Daily (Emma Davis)</option>
                    <option value="FL-004">FL-004 - Volkswagen Crafter (David Wilson)</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Service Type</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Service Type</option>
                    <option value="oil-change">Oil Change</option>
                    <option value="brake-service">Brake Service</option>
                    <option value="tire-rotation">Tire Rotation</option>
                    <option value="engine-tune">Engine Tune-up</option>
                    <option value="inspection">Annual Inspection</option>
                    <option value="transmission">Transmission Service</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Current Mileage</label>
                  <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="45000" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Service Description</label>
                  <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Describe the maintenance needed..."></textarea>
                </div>
              </div>
              
              <!-- Scheduling -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Scheduling</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Date</label>
                  <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Time</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Time Slot</option>
                    <option value="8:00">8:00 AM - 10:00 AM</option>
                    <option value="10:00">10:00 AM - 12:00 PM</option>
                    <option value="13:00">1:00 PM - 3:00 PM</option>
                    <option value="15:00">3:00 PM - 5:00 PM</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Service Provider</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Choose Service Provider</option>
                    <option value="garage-a">Central Auto Service</option>
                    <option value="garage-b">Fleet Pro Maintenance</option>
                    <option value="garage-c">QuickFix Auto Center</option>
                    <option value="dealer">Authorized Dealer</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="routine">Routine Maintenance</option>
                    <option value="scheduled">Scheduled Service</option>
                    <option value="urgent">Urgent Repair</option>
                    <option value="emergency">Emergency</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-6 border-t">
              <button type="button" onclick="closeModal('schedule-maintenance-modal')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">Schedule Service</button>
            </div>
          </form>
        `, handleScheduleMaintenanceSubmit);
      }
      
      // Create Alert Modal
      function openCreateAlertModal() {
        createModal('create-alert-modal', 'Create New Alert', `
          <form id="create-alert-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Alert Configuration -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Alert Configuration</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Alert Name</label>
                  <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Speeding Alert" required>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Alert Type</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Alert Type</option>
                    <option value="speed">Speed Limit Violation</option>
                    <option value="fuel">Low Fuel Level</option>
                    <option value="maintenance">Maintenance Due</option>
                    <option value="route">Route Deviation</option>
                    <option value="idle">Excessive Idling</option>
                    <option value="geofence">Geofence Violation</option>
                    <option value="schedule">Schedule Delay</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Severity Level</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="info">Info</option>
                    <option value="warning">Warning</option>
                    <option value="critical">Critical</option>
                    <option value="emergency">Emergency</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Trigger Condition</label>
                  <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Speed > 80 km/h" required>
                </div>
              </div>
              
              <!-- Targeting & Notifications -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Targeting & Notifications</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Apply To</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="all">All Vehicles</option>
                    <option value="specific">Specific Vehicle</option>
                    <option value="driver">Specific Driver</option>
                    <option value="route">Specific Route</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Notification Methods</label>
                  <div class="space-y-2">
                    <label class="flex items-center">
                      <input type="checkbox" class="mr-2" value="email" checked>
                      <span class="text-sm">Email</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" class="mr-2" value="sms">
                      <span class="text-sm">SMS</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" class="mr-2" value="dashboard" checked>
                      <span class="text-sm">Dashboard Notification</span>
                    </label>
                    <label class="flex items-center">
                      <input type="checkbox" class="mr-2" value="mobile">
                      <span class="text-sm">Mobile App Push</span>
                    </label>
                  </div>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Recipients</label>
                  <select multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-24">
                    <option value="admin">Fleet Administrator</option>
                    <option value="supervisor">Supervisors</option>
                    <option value="driver">Assigned Driver</option>
                    <option value="dispatcher">Dispatchers</option>
                  </select>
                  <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
                </div>
              </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-6 border-t">
              <button type="button" onclick="closeModal('create-alert-modal')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Create Alert</button>
            </div>
          </form>
        `, handleCreateAlertSubmit);
      }
      
      // Generate Report Modal
      function openGenerateReportModal() {
        createModal('generate-report-modal', 'Generate Report', `
          <form id="generate-report-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Report Type -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Report Type</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Report Category</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Report Type</option>
                    <option value="performance">Driver Performance</option>
                    <option value="fuel">Fuel Consumption</option>
                    <option value="maintenance">Maintenance Schedule</option>
                    <option value="safety">Safety & Compliance</option>
                    <option value="routes">Route Efficiency</option>
                    <option value="financial">Financial Summary</option>
                    <option value="custom">Custom Report</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Data Range</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="last-7-days">Last 7 Days</option>
                    <option value="last-30-days">Last 30 Days</option>
                    <option value="last-3-months">Last 3 Months</option>
                    <option value="last-6-months">Last 6 Months</option>
                    <option value="last-year">Last Year</option>
                    <option value="custom">Custom Date Range</option>
                  </select>
                </div>
                
                <div id="custom-date-range" class="hidden space-y-2">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                    <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                    <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                </div>
              </div>
              
              <!-- Filters & Options -->
              <div class="space-y-4">
                <h4 class="font-semibold text-gray-900 border-b pb-2">Filters & Options</h4>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Include Vehicles</label>
                  <select multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-20">
                    <option value="all" selected>All Vehicles</option>
                    <option value="FL-001">FL-001 - Mercedes Sprinter</option>
                    <option value="FL-002">FL-002 - Ford Transit</option>
                    <option value="FL-003">FL-003 - Iveco Daily</option>
                    <option value="FL-004">FL-004 - Volkswagen Crafter</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Include Drivers</label>
                  <select multiple class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-20">
                    <option value="all" selected>All Drivers</option>
                    <option value="DR-001">Sarah Johnson</option>
                    <option value="DR-002">Michael Chen</option>
                    <option value="DR-003">Emma Davis</option>
                    <option value="DR-004">David Wilson</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Export Format</label>
                  <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="pdf">PDF Document</option>
                    <option value="excel">Excel Spreadsheet</option>
                    <option value="csv">CSV File</option>
                    <option value="email">Email Report</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h5 class="font-medium text-blue-900 mb-2">Report Preview</h5>
              <p class="text-sm text-blue-700">Your report will include: Performance metrics, fuel consumption data, safety scores, and compliance records for the selected time period.</p>
            </div>
            
            <div class="flex justify-end space-x-3 pt-6 border-t">
              <button type="button" onclick="closeModal('generate-report-modal')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
              <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Generate Report</button>
            </div>
          </form>
        `, handleGenerateReportSubmit);
      }
      
      // Universal Modal Creator
      function createModal(modalId, title, content, submitHandler) {
        // Remove existing modal if any
        const existingModal = document.getElementById(modalId);
        if (existingModal) {
          existingModal.remove();
        }
        
        const modalHTML = `
          <div id="${modalId}" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-12 mx-auto p-6 border max-w-4xl shadow-lg rounded-lg bg-white">
              <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 class="text-2xl font-bold text-gray-900">${title}</h3>
                <button onclick="closeModal('${modalId}')" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
              </div>
              ${content}
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Add form submit handler
        if (submitHandler) {
          const form = document.querySelector(`#${modalId} form`);
          if (form) {
            form.addEventListener('submit', submitHandler);
          }
        }
        
        // Close modal when clicking outside
        document.getElementById(modalId).addEventListener('click', function(e) {
          if (e.target === this) {
            closeModal(modalId);
          }
        });
      }
      
      // Close Modal Function
      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.remove();
        }
      }
      
      // Helper function for waypoints
      window.addWaypoint = function() {
        const container = document.getElementById('waypoints-container');
        const waypointCount = container.children.length + 1;
        const waypointHTML = `
          <div class="flex gap-2">
            <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Stop ${waypointCount}: Address or landmark">
            <button type="button" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600" onclick="this.parentElement.remove()">Remove</button>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', waypointHTML);
      };
      
      // Form submission handlers
      function handleAddVehicleSubmit(e) {
        e.preventDefault();
        alert(' Vehicle added successfully!\n\nThe new vehicle has been registered and is ready for assignment.');
        closeModal('add-vehicle-modal');
      }
      
      function handleAddDriverSubmit(e) {
        e.preventDefault();
        alert(' Driver added successfully!\n\nThe new driver has been registered and can now be assigned to vehicles.');
        closeModal('add-driver-modal');
      }
      
      function handleCreateRouteSubmit(e) {
        e.preventDefault();
        alert(' Route created successfully!\n\nThe new route has been saved and assigned to the selected driver.');
        closeModal('create-route-modal');
      }
      
      function handleScheduleMaintenanceSubmit(e) {
        e.preventDefault();
        alert(' Maintenance scheduled successfully!\n\nThe service appointment has been booked and notifications sent.');
        closeModal('schedule-maintenance-modal');
      }
      
      function handleCreateAlertSubmit(e) {
        e.preventDefault();
        alert(' Alert created successfully!\n\nThe new alert rule is now active and monitoring your fleet.');
        closeModal('create-alert-modal');
      }
      
      function handleGenerateReportSubmit(e) {
        e.preventDefault();
        alert(' Report generated successfully!\n\nYour report is being processed and will be available for download shortly.');
        closeModal('generate-report-modal');
      }
    });
  </script>

  <!-- Driver Leaderboard (Empty - Ready for Real Data) -->
  <script>
    // Jordan Taxi Fleet Data - Define globally first
    const jordanTaxiDrivers = [
         {
           id: 'AM-001',
           name: 'Ahmed Al-Zahra',
           vehicle: 'Yellow Taxi - Hyundai Elantra',
           status: 'Active',
           overallScore: 92.5,
           safety: 94.2,
           efficiency: 88.7,
           compliance: 96.1,
           tripsPerDay: 18,
           profitabilityPerDay: 285.75,
           location: 'Downtown Amman',
           lastUpdate: '2 mins ago'
         },
         {
           id: 'AM-007',
           name: 'Salim Naser',
           vehicle: 'Yellow Taxi - Toyota Corolla',
           status: 'Busy',
           overallScore: 90.8,
           safety: 92.4,
           efficiency: 87.2,
           compliance: 94.5,
           tripsPerDay: 15,
           profitabilityPerDay: 271.40,
           location: 'Abdali District',
           lastUpdate: '1 min ago'
         },
         {
           id: 'AM-012',
           name: 'Fadi Qasemi',
           vehicle: 'Yellow Taxi - Kia Cerato',
           status: 'Busy',
           overallScore: 89.3,
           safety: 91.7,
           efficiency: 85.9,
           compliance: 93.2,
           tripsPerDay: 17,
           profitabilityPerDay: 265.20,
           location: 'En route to Dead Sea',
           lastUpdate: '3 mins ago'
         },
         {
           id: 'AM-015',
           name: 'Omar Hijazi',
           vehicle: 'Yellow Taxi - Nissan Sunny',
           status: 'Available',
           overallScore: 88.6,
           safety: 90.3,
           efficiency: 86.1,
           compliance: 92.8,
           tripsPerDay: 14,
           profitabilityPerDay: 248.90,
           location: 'Sweifieh Mall',
           lastUpdate: '1 min ago'
         },
         {
           id: 'AM-023',
           name: 'Mohammad Khatib',
           vehicle: 'Yellow Taxi - Hyundai Accent',
           status: 'Active',
           overallScore: 87.2,
           safety: 89.1,
           efficiency: 84.3,
           compliance: 91.5,
           tripsPerDay: 22,
           profitabilityPerDay: 295.80,
           location: 'Airport Road',
           lastUpdate: '4 mins ago'
         },
         {
           id: 'AM-031',
           name: 'Khalil Masri',
           vehicle: 'Yellow Taxi - Toyota Yaris',
           status: 'Available',
           overallScore: 86.4,
           safety: 88.7,
           efficiency: 83.2,
           compliance: 90.3,
           tripsPerDay: 12,
           profitabilityPerDay: 225.60,
           location: 'University of Jordan',
           lastUpdate: '2 mins ago'
         },
         {
           id: 'AM-045',
           name: 'Youssef Khalil',
           vehicle: 'Yellow Taxi - Mitsubishi Lancer',
           status: 'Break',
           overallScore: 85.1,
           safety: 87.2,
           efficiency: 82.1,
           compliance: 88.9,
           tripsPerDay: 13,
           profitabilityPerDay: 242.30,
           location: 'Rainbow Street',
           lastUpdate: '8 mins ago'
         },
         {
           id: 'AM-052',
           name: 'Marwan Shadid',
           vehicle: 'Yellow Taxi - Chevrolet Aveo',
           status: 'Offline',
           overallScore: 84.7,
           safety: 86.8,
           efficiency: 81.5,
           compliance: 87.4,
           tripsPerDay: 8,
           profitabilityPerDay: 165.40,
           location: 'Garage - Marka',
           lastUpdate: '25 mins ago'
         }
               ];

    // Make jordanTaxiDrivers globally accessible for modals
    window.jordanTaxiDrivers = jordanTaxiDrivers;

    function initializeJordanTaxiLeaderboard() {
         console.log(' Jordan taxi fleet leaderboard initialized');
         console.log(' Driver data length:', jordanTaxiDrivers.length);
         
         // Populate the table with Jordan taxi data
         const tableBody = document.getElementById('leaderboard-table-body');
         console.log(' Table body element found:', !!tableBody);
         
         if (tableBody && jordanTaxiDrivers.length > 0) {
           console.log(' Starting table population...');
           tableBody.innerHTML = jordanTaxiDrivers.map((driver, index) => {
             const efficiencyKmL = (12 + (driver.efficiency / 100) * 6).toFixed(1); // Realistic taxi efficiency
             const rank = index + 1;
             
             // Status styling
             const statusClass = driver.status === 'Active' ? 'bg-green-100 text-green-800' : 
                                driver.status === 'Available' ? 'bg-blue-100 text-blue-800' :
                                driver.status === 'Busy' ? 'bg-yellow-100 text-yellow-800' :
                                driver.status === 'Break' ? 'bg-orange-100 text-orange-800' :
                                'bg-gray-100 text-gray-800';
             
             return `
               <tr class="hover:bg-gray-50 transition-colors">
                 <!-- Rank -->
                 <td class="px-6 py-4 whitespace-nowrap">
                   <div class="h-8 w-8 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center text-white font-bold text-sm">
                     ${rank}
                   </div>
                 </td>
                 
                 <!-- Driver -->
                 <td class="px-6 py-4 whitespace-nowrap">
                   <div class="flex items-center">
                     <div class="flex-shrink-0 h-10 w-10">
                       <div class="h-10 w-10 rounded-full bg-yellow-200 flex items-center justify-center text-yellow-800 font-semibold text-sm border-2 border-yellow-400">
                         ${driver.name.split(' ').map(n => n[0]).join('')}
                       </div>
                     </div>
                     <div class="ml-4">
                       <div class="text-sm font-medium text-gray-900">${driver.name}</div>
                       <div class="text-sm text-gray-500"> ${driver.vehicle}</div>
                     </div>
                   </div>
                 </td>
                 
                 <!-- Status -->
                 <td class="px-6 py-4 whitespace-nowrap">
                   <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">
                     ${driver.status}
                   </span>
                   <div class="text-xs text-gray-500 mt-1">${driver.lastUpdate}</div>
                 </td>
                 
                 <!-- Overall Score -->
                 <td class="px-6 py-4 whitespace-nowrap">
                   <div class="text-sm font-semibold text-gray-900">${driver.overallScore.toFixed(1)}</div>
                   <div class="text-xs text-gray-500">Overall</div>
                 </td>
                 
                 <!-- Safety -->
                 <td class="px-6 py-4 whitespace-nowrap">
                   <div class="text-sm text-gray-900">${driver.safety.toFixed(1)}</div>
                   <div class="text-xs text-gray-500">Safety Score</div>
                 </td>
                 
                 <!-- Fuel Efficiency -->
                 <td class="px-6 py-4 whitespace-nowrap">
                   <div class="text-sm text-gray-900">${efficiencyKmL} km/L</div>
                   <div class="text-xs text-gray-500">Efficiency</div>
                 </td>
                 
                 <!-- Compliance -->
                 <td class="px-6 py-4 whitespace-nowrap">
                   <div class="text-sm text-gray-900">${driver.compliance.toFixed(1)}</div>
                   <div class="text-xs text-gray-500">Compliance</div>
                 </td>
                 
                 <!-- Trips/Day -->
                 <td class="px-6 py-4 whitespace-nowrap">
                   <div class="text-sm text-gray-900 font-semibold">${driver.tripsPerDay}</div>
                   <div class="text-xs text-gray-500">Daily Trips</div>
                 </td>
                 
                 <!-- Profitability/Day -->
                 <td class="px-6 py-4 whitespace-nowrap">
                   <div class="text-sm text-green-600 font-semibold">$${driver.profitabilityPerDay.toFixed(2)}</div>
                   <div class="text-xs text-gray-500">Daily Profit</div>
                 </td>
                 
                 <!-- Actions -->
                 <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                   <button onclick="viewDriverDetails('${driver.id}')" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 px-3 py-1 rounded-full transition-colors mr-2">
                     View
                   </button>
                   <button onclick="sendMessage('${driver.id}')" class="text-green-600 hover:text-green-900 bg-green-50 hover:bg-green-100 px-3 py-1 rounded-full transition-colors">
                     Message
                   </button>
                 </td>
               </tr>
             `;
           }).join('');
           console.log(' Table populated successfully with', jordanTaxiDrivers.length, 'drivers');
         } else {
           console.log(' Table body not found or no driver data');
           console.log('Table body:', tableBody);
           console.log('Driver data length:', jordanTaxiDrivers.length);
         }
         console.log(' Function completed');
         
         // Add action functions for buttons
         window.viewDriverDetails = function(driverId) {
           const driver = jordanTaxiDrivers.find(d => d.id === driverId);
           if (driver) {
             showJordanTaxiDriverModal(driver, driverId);
           }
         };

         window.sendMessage = function(driverId) {
           const driver = jordanTaxiDrivers.find(d => d.id === driverId);
           if (driver) {
            showDriverCommunicationModal(driver, driverId);
           }
         };
       }
       
       // Jordan Taxi Driver details modal
       function showJordanTaxiDriverModal(driverData, driverId) {
         const efficiencyKmL = (12 + (driverData.efficiency / 100) * 6).toFixed(1);
         
         const modalHTML = `
           <div id="driver-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
             <div class="relative top-12 mx-auto p-6 border max-w-2xl shadow-lg rounded-lg bg-white">
               <div class="flex justify-between items-center border-b pb-4 mb-6">
                 <h3 class="text-2xl font-bold text-gray-900"> Jordan Taxi Driver Details</h3>
                 <button onclick="closeDriverModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
               </div>
               
               <div class="space-y-6">
                 <!-- Driver Info -->
                 <div class="flex items-center space-x-4">
                   <div class="h-16 w-16 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 flex items-center justify-center text-white font-bold text-xl">
                     ${driverData.name.split(' ').map(n => n[0]).join('')}
                   </div>
                   <div>
                     <h4 class="text-xl font-semibold text-gray-900">${driverData.name}</h4>
                     <p class="text-gray-600">Taxi ID: ${driverData.id}</p>
                     <p class="text-gray-600"> ${driverData.vehicle}</p>
                     <p class="text-gray-600"> ${driverData.location}</p>
                   </div>
                 </div>
                 
                 <!-- Performance Metrics -->
                 <div class="grid grid-cols-2 gap-4 mb-4">
                   <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                     <h5 class="font-semibold text-yellow-900">Overall Rating</h5>
                     <p class="text-2xl font-bold text-yellow-600">${driverData.overallScore.toFixed(1)}</p>
                     <p class="text-sm text-yellow-700">Excellent performance</p>
                   </div>
                   <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                     <h5 class="font-semibold text-green-900">Fuel Efficiency</h5>
                     <p class="text-2xl font-bold text-green-600">${efficiencyKmL} km/L</p>
                     <p class="text-sm text-green-700">Above average</p>
                   </div>
                 </div>
                 
                 <!-- Performance & Financial Metrics -->
                 <div class="grid grid-cols-2 gap-4">
                   <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                     <h5 class="font-semibold text-blue-900">Daily Trips</h5>
                     <p class="text-2xl font-bold text-blue-600">${driverData.tripsPerDay}</p>
                     <p class="text-sm text-blue-700">Trips completed today</p>
                   </div>
                   <div class="bg-emerald-50 p-4 rounded-lg border border-emerald-200">
                     <h5 class="font-semibold text-emerald-900">Daily Profitability</h5>
                     <p class="text-2xl font-bold text-emerald-600">$${driverData.profitabilityPerDay.toFixed(2)}</p>
                     <p class="text-sm text-emerald-700">Total daily profit</p>
                   </div>
                 </div>
                 
                 <!-- Current Status & Location -->
                 <div class="bg-gray-50 p-4 rounded-lg">
                   <h5 class="font-semibold text-gray-900 mb-2">Current Status & Location</h5>
                   <div class="space-y-2">
                     <p class="text-gray-700"> Status: <span class="font-semibold text-yellow-600">${driverData.status}</span></p>
                     <p class="text-gray-700"> Current Location: ${driverData.location}</p>
                     <p class="text-gray-700"> Last Update: ${driverData.lastUpdate}</p>
                     <p class="text-gray-700"> Safety Score: ${driverData.safety.toFixed(1)}/100</p>
                     <p class="text-gray-700"> Compliance: ${driverData.compliance.toFixed(1)}/100</p>
                   </div>
                 </div>
                 
                 <!-- Action Buttons -->
                 <div class="flex justify-end space-x-3 pt-6 border-t">
                   <button onclick="sendMessage('${driverId}')" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">
                      Send Message
                   </button>
                   <button onclick="closeDriverModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                     Close
                   </button>
                 </div>
               </div>
             </div>
           </div>
         `;
         
         document.body.insertAdjacentHTML('beforeend', modalHTML);
         
         // Close modal when clicking outside
         document.getElementById('driver-details-modal').addEventListener('click', function(e) {
           if (e.target === this) {
             closeDriverModal();
           }
         });
       }
       
       // Close driver modal
       window.closeDriverModal = function() {
         const modal = document.getElementById('driver-details-modal');
         if (modal) {
           modal.remove();
         }
       };

      // Driver Communication Modal
      function showDriverCommunicationModal(driver, driverId) {
        // Close any existing modals first
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.setAttribute('data-modal-type', 'driver-communication');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10001;
          font-family: 'Inter', sans-serif;
        `;
        
        modal.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0; color: #1f2937; font-size: 20px; font-weight: bold;">
                <i class="fas fa-comments" style="color: #eab308; margin-right: 8px;"></i>
                Message Driver
              </h3>
              <button onclick="closeModal('driver-communication')" 
                      style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;"></button>
            </div>
            
            <div style="margin-bottom: 16px;">
              <div style="display: flex; align-items: center; margin-bottom: 12px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #eab308, #f59e0b); 
                           display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                  <i class="fas fa-user" style="color: white; font-size: 20px;"></i>
                </div>
                <div>
                  <div style="font-weight: 600; color: #1f2937; font-size: 16px;">${driver.name}</div>
                  <div style="font-size: 14px; color: #6b7280;">Driver ID: ${driverId}  ${driver.status.charAt(0).toUpperCase() + driver.status.slice(1)}</div>
                  <div style="font-size: 12px; color: #10b981; font-weight: 500;">
                    <i class="fas fa-car" style="margin-right: 4px;"></i>Vehicle: ${driver.vehicle || 'JTX-' + String(driverId).padStart(3, '0')}
                  </div>
                </div>
              </div>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Message Type:</label>
              <select id="driverMessageType" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="instruction">Instruction</option>
                <option value="alert">Alert</option>
                <option value="pickup">Pickup Request</option>
                <option value="route">Route Change</option>
                <option value="break">Break Time</option>
                <option value="emergency">Emergency</option>
                <option value="general">General Message</option>
              </select>
            </div>
            
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Language:</label>
              <select id="driverMessageLanguage" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="both">Arabic & English</option>
                <option value="arabic">Arabic Only</option>
                <option value="english">English Only</option>
              </select>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Message:</label>
              <textarea id="driverMessageContent" placeholder="Type your message to the driver..." 
                       style="width: 100%; height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; font-family: inherit;"></textarea>
              <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                Message will be sent to driver's mobile app and dashboard
              </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="closeModal('driver-communication')" 
                      style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer;">
                Cancel
              </button>
              <button onclick="sendDriverMessage('${driverId}', '${driver.name}')" 
                      style="padding: 10px 20px; border: none; background: #eab308; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
                <i class="fas fa-paper-plane" style="margin-right: 6px;"></i>Send Message
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      // Send message to driver function
      function sendDriverMessage(driverId, driverName) {
        const messageType = document.getElementById('driverMessageType').value;
        const messageLanguage = document.getElementById('driverMessageLanguage').value;
        const messageContent = document.getElementById('driverMessageContent').value;
        
        if (!messageContent.trim()) {
          showActionNotification('Please enter a message', 'error');
          return;
        }
        
        showActionNotification(`Sending ${messageType} to ${driverName}...`, 'info');
        
        setTimeout(() => {
          const languageText = messageLanguage === 'both' ? 'Arabic & English' : 
                              messageLanguage === 'arabic' ? 'Arabic' : 'English';
          showActionNotification(`${messageType.charAt(0).toUpperCase() + messageType.slice(1)} sent to ${driverName} in ${languageText} successfully! `, 'success');
          // Close modal
          closeModal('driver-communication');
        }, 1000);
      }
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
       console.log(' Initializing Jordan Taxi Leaderboard...');
       initializeJordanTaxiLeaderboard();
    });
  </script>
  <!-- Tutorial Start Modal JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tutorialModal = document.getElementById('tutorial-start-modal');
      const startTourBtn = document.getElementById('start-tour-btn');
      const skipTourBtn = document.getElementById('skip-tour-btn');
      const helpToggle = document.getElementById('help-toggle');
      const restartTutorialBtn = document.getElementById('restart-tutorial');
      
      // Check if user has seen tutorial before
      const hasSeenTutorial = localStorage.getItem('fleet-dashboard-tutorial-seen');
      
      // Show tutorial modal for first-time users
      if (!hasSeenTutorial) {
        setTimeout(() => {
          tutorialModal.classList.remove('hidden');
        }, 1000); // Show after 1 second
      }
      
      // Start tour button functionality
      startTourBtn?.addEventListener('click', function() {
        closeModal('tutorial');
        startTutorial();
      });
      
      // Skip tour button functionality
      skipTourBtn?.addEventListener('click', function() {
        closeModal('tutorial');
      });
      
      // Help button - show tutorial modal
      helpToggle?.addEventListener('click', function() {
        showTutorialModal();
      });
      
      // Restart tutorial from help menu
      restartTutorialBtn?.addEventListener('click', function() {
        showTutorialModal();
        // Close help menu if it's open
        const helpMenu = document.querySelector('[role="menu"]');
        if (helpMenu && !helpMenu.classList.contains('hidden')) {
          helpMenu.classList.add('hidden');
        }
      });
      
      // Close modal when clicking outside
      tutorialModal?.addEventListener('click', function(e) {
        if (e.target === tutorialModal) {
          closeModal('tutorial');
        }
      });
      
      // Tutorial state management
      let currentTutorialStep = 1;
      const totalTutorialSteps = 8;
      
      // Tutorial steps data
      const tutorialSteps = [
        {
          title: "Dashboard Overview",
          description: "This is your main dashboard where you can monitor your entire fleet in real-time. View key metrics and get insights about your fleet performance."
        },
        {
          title: "Vehicle Map",
          description: "The interactive map shows all your vehicles with real-time locations. Use the controls to zoom, center, and view different map layers."
        },
        {
          title: "Driver Leaderboard",
          description: "Track your top-performing drivers and their achievements. See rankings based on performance metrics and safety scores."
        },
        {
          title: "Quick Actions",
          description: "Use the floating action button (blue circle with +) to quickly add vehicles, drivers, or perform common tasks."
        },
        {
          title: "Fleet Statistics",
          description: "Monitor key performance indicators like active vehicles, total distance, fuel consumption, and driver performance."
        },
        {
          title: "Navigation Menu",
          description: "Access different sections of the fleet management system using the sidebar navigation menu."
        },
        {
          title: "Notifications",
          description: "Stay updated with the bell icon for alerts, maintenance reminders, and important fleet notifications."
        },
        {
          title: "User Settings",
          description: "Click the logout button (red button) in the top-right to log out and return to the login page when done."
        }
      ];

      // Tutorial start function
      function startTutorial() {
        console.log('Starting tutorial...');
        currentTutorialStep = 1;
        
        // Show tutorial overlay and tooltip
        const overlay = document.getElementById('tutorial-overlay');
        const tooltip = document.getElementById('tutorial-tooltip');
        const skipButton = document.getElementById('tutorial-skip-floating');
        
        if (overlay && tooltip) {
          overlay.classList.remove('hidden');
          tooltip.classList.remove('hidden');
          skipButton.classList.remove('hidden');
          
          // Set up navigation event listeners
          setupTutorialNavigation();
          
          // Show first step
          showTutorialStep(currentTutorialStep);
        }
      }
      
      // Setup tutorial navigation event listeners
      function setupTutorialNavigation() {
        const nextBtn = document.getElementById('tutorial-next');
        const prevBtn = document.getElementById('tutorial-prev');
        const skipBtn = document.getElementById('tutorial-skip-floating');
        const closeBtn = document.getElementById('tutorial-close');
        
        // Remove existing listeners to avoid duplicates
        nextBtn.replaceWith(nextBtn.cloneNode(true));
        prevBtn.replaceWith(prevBtn.cloneNode(true));
        
        // Get fresh references after cloning
        const newNextBtn = document.getElementById('tutorial-next');
        const newPrevBtn = document.getElementById('tutorial-prev');
        
        // Next button
        newNextBtn.addEventListener('click', function() {
          if (currentTutorialStep < totalTutorialSteps) {
            currentTutorialStep++;
            showTutorialStep(currentTutorialStep);
          } else {
            // Tutorial complete
            completeTutorial();
          }
        });
        
        // Previous button
        newPrevBtn.addEventListener('click', function() {
          if (currentTutorialStep > 1) {
            currentTutorialStep--;
            showTutorialStep(currentTutorialStep);
          }
        });
        
        // Skip button
        skipBtn.addEventListener('click', function() {
          completeTutorial();
        });
        
        // Close button
        closeBtn.addEventListener('click', function() {
          completeTutorial();
        });
      }
      
      // Show tutorial step function
      function showTutorialStep(step) {
        const stepCounter = document.getElementById('tutorial-step-counter');
        const title = document.getElementById('tutorial-title');
        const description = document.getElementById('tutorial-description');
        const progress = document.getElementById('tutorial-progress');
        const nextBtn = document.getElementById('tutorial-next');
        const prevBtn = document.getElementById('tutorial-prev');
        
        // Update step content
        if (step <= tutorialSteps.length && tutorialSteps[step - 1]) {
          stepCounter.textContent = `Step ${step} of ${totalTutorialSteps}`;
          title.textContent = tutorialSteps[step - 1].title;
          description.textContent = tutorialSteps[step - 1].description;
          
          // Update progress bar
          const progressPercent = (step / totalTutorialSteps) * 100;
          progress.style.width = `${progressPercent}%`;
          
          // Update button states
          prevBtn.disabled = step === 1;
          if (step === totalTutorialSteps) {
            nextBtn.textContent = 'Finish';
            nextBtn.innerHTML = 'Finish <i class="fas fa-check ml-1"></i>';
          } else {
            nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right ml-1"></i>';
          }
        }
      }
      
      // Complete tutorial function
      function completeTutorial() {
        const overlay = document.getElementById('tutorial-overlay');
        const tooltip = document.getElementById('tutorial-tooltip');
        const skipButton = document.getElementById('tutorial-skip-floating');
        
        // Hide tutorial elements
        overlay.classList.add('hidden');
        tooltip.classList.add('hidden');
        skipButton.classList.add('hidden');
        
        // Mark tutorial as seen
        localStorage.setItem('fleet-dashboard-tutorial-seen', 'true');
        
        // Show completion message
        alert('Tutorial completed! You can restart it anytime using the help button.');
        
        console.log('Tutorial completed');
      }
    });
  </script>

  <!-- OpenLayers (Advanced Free Mapping Library) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" />
  <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
  
  <!-- Map Container Styles -->
  <style>
    #fleet-map-container {
      background: #f8fafc;
    }
    #fleet-map-container .ol-viewport {
      border-radius: 8px;
    }
    .ol-popup {
      z-index: 1000 !important;
    }
    
    /* Notification animations */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    
    /* Tutorial progress bar */
    .tutorial-progress {
      background: linear-gradient(to right, #3b82f6, #1d4ed8);
      height: 100%;
      border-radius: 9999px;
      transition: width 0.3s ease-in-out;
    }
  </style>

  <!-- OpenLayers Advanced Fleet Tracking Implementation -->
  <script>
    let fleetMap;
    let vectorSource;
    let vectorLayer;
    let clusterSource;
    let osmLayer;
    let satelliteLayer;
    let isTrafficLayerVisible = false;
    let isSatelliteView = false;
    let isClusteringEnabled = true;

    // Generate 100 fleet vehicles with specified distribution
    function generateFleetVehicles() {
      const vehicles = [];
      const drivers = [
        'Ahmed Ali', 'Sara Hassan', 'Omar Khalil', 'Fatima Ahmad', 'Mohammed Saeed',
        'Layla Ibrahim', 'Yusuf Rahman', 'Nour Zayed', 'Khaled Mansour', 'Rania Nasser',
        'Tariq Saleh', 'Dina Khoury', 'Sami Qasem', 'Rana Farid', 'Adnan Ghazi',
        'Lina Hakim', 'Walid Jaber', 'Mona Shami', 'Basel Najjar', 'Aya Hamdan',
        'Fadi Barakat', 'Reem Othman', 'Hani Tawfik', 'Samar Hijazi', 'Nizar Karam'
      ];
      
      // Define status distribution: 61 active, 25 idling, 11 parked, 3 offline
      const statusConfig = [
        { status: 'active', count: 61, speedRange: [20, 80] },
        { status: 'idle', count: 25, speedRange: [0, 5] },
        { status: 'parked', count: 11, speedRange: [0, 0] },
        { status: 'offline', count: 3, speedRange: [0, 0] }
      ];
      
      let vehicleIndex = 1;
      
      statusConfig.forEach(config => {
        for (let i = 0; i < config.count; i++) {
          const lat = 31.9539 + (Math.random() - 0.5) * 0.1; // Spread around Amman
          const lng = 35.9106 + (Math.random() - 0.5) * 0.1;
          const driver = drivers[Math.floor(Math.random() * drivers.length)];
          const speed = Math.floor(Math.random() * (config.speedRange[1] - config.speedRange[0] + 1)) + config.speedRange[0];
          
          vehicles.push({
            id: `FL-${vehicleIndex.toString().padStart(3, '0')}`,
            lat: lat,
            lng: lng,
            status: config.status,
            driver: driver,
            speed: speed
          });
          
          vehicleIndex++;
        }
      });
      
      return vehicles;
    }
    
    const fleetVehicles = generateFleetVehicles();

    // Executive Action Functions
    function toggleConnection(vehicleId, currentlyConnected) {
      const action = currentlyConnected ? 'Disconnecting' : 'Connecting';
      const newStatus = currentlyConnected ? 'offline' : 'active';
      
      showActionNotification(`${action} vehicle ${vehicleId}...`, 'info');
      
      // Simulate API call delay
      setTimeout(() => {
        // Update vehicle status in data
        const vehicle = fleetVehicles.find(v => v.id === vehicleId);
        if (vehicle) {
          vehicle.status = newStatus;
          if (!currentlyConnected) {
            vehicle.speed = Math.floor(Math.random() * 50) + 10;
          } else {
            vehicle.speed = 0;
          }
        }
        
        // Refresh map
        addVehicleMarkers();
        updateMapStatistics();
        
        const successMsg = currentlyConnected ? 'disconnected from' : 'connected to';
        showActionNotification(`Successfully ${successMsg} vehicle ${vehicleId}`, 'success');
        
        // Close popup to show updated status
        document.getElementById('popup').style.display = 'none';
      }, 1500);
    }

    function toggleLock(vehicleId, currentlyLocked) {
      const action = currentlyLocked ? 'Unlocking' : 'Locking';
      
      showActionNotification(`${action} vehicle ${vehicleId}...`, 'info');
      
      // Simulate API call delay
      setTimeout(() => {
        const successMsg = currentlyLocked ? 'unlocked' : 'locked';
        showActionNotification(`Vehicle ${vehicleId} ${successMsg} successfully`, 'success');
        
        // Close popup to show updated status
        document.getElementById('popup').style.display = 'none';
      }, 1000);
    }

    function communicateWithVehicle(vehicleId) {
      showCommunicationModal(vehicleId);
    }

    function viewVehicleDetails(vehicleId) {
      showVehicleDetailsModal(vehicleId);
    }

    function viewVehicleCamera(vehicleId) {
      showVehicleCameraModal(vehicleId);
    }

    function viewRouteHistory(vehicleId) {
      showRouteHistoryModal(vehicleId);
    }

    // Modal Management System
    function closeAllModals() {
      // Close all modals and popups
      const modals = document.querySelectorAll('[data-modal-type]');
      modals.forEach(modal => {
        if (modal.getAttribute('data-modal-type') === 'tutorial') {
          // For tutorial modal, just hide it instead of removing
          modal.classList.add('hidden');
        } else {
          // For other modals, remove them
          modal.remove();
        }
      });
      
      // Also hide the map popup
      const popup = document.getElementById('popup');
      if (popup) {
        popup.style.display = 'none';
      }
    }

    function closeModal(modalType) {
      const modal = document.querySelector(`[data-modal-type="${modalType}"]`);
      if (modal) {
        if (modalType === 'tutorial') {
          // For tutorial modal, just hide it instead of removing
          modal.classList.add('hidden');
          localStorage.setItem('fleet-dashboard-tutorial-seen', 'true');
        } else {
          // For other modals, remove them
          modal.remove();
        }
      }
    }

    function showTutorialModal() {
      // Close any other modals first
      const nonTutorialModals = document.querySelectorAll('[data-modal-type]:not([data-modal-type="tutorial"])');
      nonTutorialModals.forEach(modal => modal.remove());
      
      // Hide map popup
      const popup = document.getElementById('popup');
      if (popup) {
        popup.style.display = 'none';
      }
      
      // Show tutorial modal
      const tutorialModal = document.getElementById('tutorial-start-modal');
      if (tutorialModal) {
        tutorialModal.classList.remove('hidden');
      }
    }

    // Add keyboard and click-outside-to-close functionality
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeAllModals();
      }
    });

    // Handle click-outside-to-close for modals
    document.addEventListener('click', function(e) {
      const modals = document.querySelectorAll('[data-modal-type]');
      modals.forEach(modal => {
        if (e.target === modal && !modal.classList.contains('hidden')) {
          const modalType = modal.getAttribute('data-modal-type');
          closeModal(modalType);
        }
      });
    });

    // Show action notification
    function showActionNotification(message, type = 'info') {
      // Remove existing notifications
      const existingNotifications = document.querySelectorAll('.action-notification');
      existingNotifications.forEach(n => n.remove());
      
      const notification = document.createElement('div');
      notification.className = 'action-notification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        font-size: 14px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
      `;
      
      notification.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}" 
           style="margin-right: 8px;"></i>
        ${message}
      `;
      
      document.body.appendChild(notification);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        if (notification && notification.parentNode) {
          notification.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => notification.remove(), 300);
        }
      }, 3000);
    }

    // Communication Modal
    function showCommunicationModal(vehicleId) {
      const vehicle = fleetVehicles.find(v => v.id === vehicleId);
      
      // Close the vehicle info popup first
      const popup = document.getElementById('popup');
      if (popup) {
        popup.style.display = 'none';
      }
      
      const modal = document.createElement('div');
      modal.setAttribute('data-modal-type', 'communication');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        font-family: 'Inter', sans-serif;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #1f2937; font-size: 20px; font-weight: bold;">
              <i class="fas fa-comments" style="color: #0ea5e9; margin-right: 8px;"></i>
              Communicate with ${vehicleId}
              </h3>
            <button onclick="closeModal('communication')" 
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;"></button>
          </div>
          
          <div style="margin-bottom: 16px;">
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
              <div style="width: 40px; height: 40px; border-radius: 50%; background: ${getStatusColor(vehicle.status)}; 
                         display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                <i class="fas fa-user" style="color: white;"></i>
              </div>
              <div>
                <div style="font-weight: 600; color: #1f2937;">${vehicle.driver}</div>
                <div style="font-size: 14px; color: #6b7280;">${vehicleId}  ${vehicle.status.toUpperCase()}</div>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Message Type:</label>
            <select id="messageType" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="instruction">Instruction</option>
              <option value="alert">Alert</option>
              <option value="request">Request</option>
              <option value="update">Status Update</option>
            </select>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Message:</label>
            <textarea id="messageContent" placeholder="Type your message to the driver..." 
                     style="width: 100%; height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; font-family: inherit;"></textarea>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeModal('communication')" 
                    style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer;">
              Cancel
            </button>
            <button onclick="sendMessage('${vehicleId}')" 
                    style="padding: 10px 20px; border: none; background: #0ea5e9; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-paper-plane" style="margin-right: 6px;"></i>Send Message
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Vehicle Details Modal
    function showVehicleDetailsModal(vehicleId) {
      const vehicle = fleetVehicles.find(v => v.id === vehicleId);
      
      // Close the vehicle info popup first
      const popup = document.getElementById('popup');
      if (popup) {
        popup.style.display = 'none';
      }
      
      const modal = document.createElement('div');
      modal.setAttribute('data-modal-type', 'details');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        font-family: 'Inter', sans-serif;
      `;
      
      const lastSeen = new Date(Date.now() - Math.random() * 3600000).toLocaleString();
      const batteryLevel = Math.floor(Math.random() * 40) + 60;
      const fuelLevel = Math.floor(Math.random() * 30) + 70;
      const mileage = Math.floor(Math.random() * 50000) + 150000;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 95%; max-height: 85vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h3 style="margin: 0; color: #1f2937; font-size: 24px; font-weight: bold;">
              <i class="fas fa-car" style="color: #8b5cf6; margin-right: 8px;"></i>
              ${vehicleId} Details
            </h3>
            <button onclick="closeModal('details')" 
                    style="background: none; border: none; font-size: 28px; cursor: pointer; color: #6b7280;"></button>
          </div>
          
          <!-- Status Overview -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-bottom: 24px;">
            <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 8px;">
              <div style="font-size: 24px; font-weight: bold; color: ${getStatusColor(vehicle.status)}">${vehicle.speed}</div>
              <div style="font-size: 12px; color: #6b7280; text-transform: uppercase;">km/h</div>
            </div>
            <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 8px;">
              <div style="font-size: 24px; font-weight: bold; color: #10b981">${fuelLevel}%</div>
              <div style="font-size: 12px; color: #6b7280; text-transform: uppercase;">Fuel</div>
            </div>
            <div style="text-align: center; padding: 16px; background: #f8fafc; border-radius: 8px;">
              <div style="font-size: 24px; font-weight: bold; color: #3b82f6">${batteryLevel}%</div>
              <div style="font-size: 12px; color: #6b7280; text-transform: uppercase;">Battery</div>
            </div>
          </div>
          
          <!-- Vehicle Information -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div>
              <h4 style="color: #1f2937; font-size: 16px; font-weight: 600; margin-bottom: 12px;">Vehicle Info</h4>
              <div style="space-y: 8px;">
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                  <span style="color: #6b7280;">Status:</span>
                  <span style="color: ${getStatusColor(vehicle.status)}; font-weight: 600;">${vehicle.status.toUpperCase()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                  <span style="color: #6b7280;">Driver:</span>
                  <span style="font-weight: 500;">${vehicle.driver}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                  <span style="color: #6b7280;">Mileage:</span>
                  <span style="font-weight: 500;">${mileage.toLocaleString()} km</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                  <span style="color: #6b7280;">Last Seen:</span>
                  <span style="font-weight: 500;">${lastSeen}</span>
                </div>
              </div>
            </div>
            
            <div>
              <h4 style="color: #1f2937; font-size: 16px; font-weight: 600; margin-bottom: 12px;">Location</h4>
              <div style="space-y: 8px;">
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                  <span style="color: #6b7280;">Latitude:</span>
                  <span style="font-weight: 500;">${vehicle.lat.toFixed(6)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                  <span style="color: #6b7280;">Longitude:</span>
                  <span style="font-weight: 500;">${vehicle.lng.toFixed(6)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
                  <span style="color: #6b7280;">Heading:</span>
                  <span style="font-weight: 500;">${Math.floor(Math.random() * 360)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                  <span style="color: #6b7280;">Altitude:</span>
                  <span style="font-weight: 500;">${Math.floor(Math.random() * 200) + 800}m</span>
                </div>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeModal('details')" 
                    style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer;">
              Close
            </button>
            <button onclick="trackVehicle('${vehicleId}')" 
                    style="padding: 10px 20px; border: none; background: #8b5cf6; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-crosshairs" style="margin-right: 6px;"></i>Track Vehicle
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Send message function
    function sendMessage(vehicleId) {
      const messageType = document.getElementById('messageType').value;
      const messageContent = document.getElementById('messageContent').value;
      
      if (!messageContent.trim()) {
        showActionNotification('Please enter a message', 'error');
        return;
      }
      
      showActionNotification(`Sending ${messageType} to ${vehicleId}...`, 'info');
      
      setTimeout(() => {
        showActionNotification(`Message sent to ${vehicleId} successfully`, 'success');
        // Close modal
        closeModal('communication');
      }, 1000);
    }

    // Track vehicle function
    function trackVehicle(vehicleId) {
      const vehicle = fleetVehicles.find(v => v.id === vehicleId);
      if (vehicle) {
        // Close all modals first
        closeAllModals();
        
        // Center map on vehicle
        fleetMap.getView().animate({
          center: ol.proj.fromLonLat([vehicle.lng, vehicle.lat]),
          zoom: 16,
          duration: 1000
        });
        
        showActionNotification(`Tracking ${vehicleId}`, 'success');
      }
    }

    // Vehicle Camera Modal
    function showVehicleCameraModal(vehicleId) {
      const vehicle = fleetVehicles.find(v => v.id === vehicleId);
      const isConnected = vehicle.status !== 'offline';
      
      // Close the vehicle info popup first
      const popup = document.getElementById('popup');
      if (popup) {
        popup.style.display = 'none';
      }
      
      const modal = document.createElement('div');
      modal.setAttribute('data-modal-type', 'camera');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        font-family: 'Inter', sans-serif;
      `;
      
      const cameraViews = [
        { name: 'Front Camera', id: 'front', status: isConnected ? 'online' : 'offline' },
        { name: 'Rear Camera', id: 'rear', status: isConnected && Math.random() > 0.3 ? 'online' : 'offline' },
        { name: 'Left Side', id: 'left', status: isConnected && Math.random() > 0.5 ? 'online' : 'offline' },
        { name: 'Right Side', id: 'right', status: isConnected && Math.random() > 0.5 ? 'online' : 'offline' },
        { name: 'Interior', id: 'interior', status: isConnected && Math.random() > 0.2 ? 'online' : 'offline' },
        { name: 'Dashboard', id: 'dashboard', status: isConnected && Math.random() > 0.4 ? 'online' : 'offline' }
      ];
      
      modal.innerHTML = `
        <div style="background: #1f2937; border-radius: 16px; padding: 24px; max-width: 95vw; width: 1200px; max-height: 90vh; overflow-y: auto; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 1px solid #374151; padding-bottom: 16px;">
            <div style="display: flex; align-items: center;">
              <div style="width: 48px; height: 48px; border-radius: 50%; background: #ef4444; display: flex; align-items: center; justify-content: center; margin-right: 16px;">
                <i class="fas fa-video" style="color: white; font-size: 20px;"></i>
              </div>
              <div>
                <h3 style="margin: 0; font-size: 24px; font-weight: bold;">${vehicleId} Camera System</h3>
                <div style="font-size: 14px; color: #9ca3af; margin-top: 4px;">
                  <i class="fas ${isConnected ? 'fa-circle' : 'fa-circle'}" style="color: ${isConnected ? '#10b981' : '#ef4444'}; margin-right: 6px;"></i>
                  ${isConnected ? 'Vehicle Connected' : 'Vehicle Offline - Limited Camera Access'}
                </div>
              </div>
            </div>
            <button onclick="closeModal('camera')" 
                    style="background: #374151; border: none; font-size: 24px; cursor: pointer; color: #9ca3af; padding: 8px 12px; border-radius: 8px; transition: all 0.2s;"
                    onmouseover="this.style.background='#4b5563'" 
                    onmouseout="this.style.background='#374151'"></button>
          </div>
          
          <!-- Camera Grid -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 24px;">
            ${cameraViews.map(camera => `
              <div style="background: #111827; border-radius: 12px; overflow: hidden; border: 2px solid ${camera.status === 'online' ? '#10b981' : '#374151'};">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #374151;">
                  <div style="display: flex; align-items: center;">
                    <i class="fas fa-video" style="color: ${camera.status === 'online' ? '#10b981' : '#6b7280'}; margin-right: 8px;"></i>
                    <span style="font-weight: 600; font-size: 14px;">${camera.name}</span>
                  </div>
                  <div style="display: flex; align-items: center;">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${camera.status === 'online' ? '#10b981' : '#ef4444'}; margin-right: 6px;"></div>
                    <span style="font-size: 12px; color: #9ca3af; text-transform: uppercase;">${camera.status}</span>
                  </div>
                </div>
                
                <div style="aspect-ratio: 16/9; background: ${camera.status === 'online' ? '#000' : '#1f2937'}; position: relative; display: flex; align-items: center; justify-content: center;">
                  ${camera.status === 'online' ? `
                    <div style="width: 100%; height: 100%; background: linear-gradient(45deg, #1f2937 25%, transparent 25%), linear-gradient(-45deg, #1f2937 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #1f2937 75%), linear-gradient(-45deg, transparent 75%, #1f2937 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; opacity: 0.3; position: absolute;"></div>
                    <div style="text-align: center; z-index: 1;">
                      <div style="width: 60px; height: 60px; border: 3px solid #10b981; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px;"></div>
                      <div style="font-size: 14px; color: #10b981; font-weight: 600;"> LIVE</div>
                      <div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">HD 1080p  ${Math.floor(Math.random() * 30) + 25} FPS</div>
                    </div>
                  ` : `
                    <div style="text-align: center;">
                      <i class="fas fa-video-slash" style="font-size: 36px; color: #6b7280; margin-bottom: 12px;"></i>
                      <div style="font-size: 14px; color: #6b7280;">Camera Offline</div>
                      <div style="font-size: 12px; color: #4b5563; margin-top: 4px;">Check connection</div>
                    </div>
                  `}
                </div>
                
                ${camera.status === 'online' ? `
                  <div style="padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; background: #111827;">
                    <div style="display: flex; gap: 8px;">
                      <button onclick="toggleCameraRecording('${vehicleId}', '${camera.id}')" 
                              style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        <i class="fas fa-record-vinyl" style="margin-right: 4px;"></i>REC
                      </button>
                      <button onclick="takeCameraSnapshot('${vehicleId}', '${camera.id}')" 
                              style="padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        <i class="fas fa-camera" style="margin-right: 4px;"></i>SNAP
                      </button>
                    </div>
                    <div style="font-size: 11px; color: #9ca3af;">
                      ${new Date().toLocaleTimeString()}
                    </div>
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
          
          <!-- Camera Controls -->
          <div style="display: flex; justify-content: space-between; align-items: center; background: #111827; padding: 16px; border-radius: 12px;">
            <div style="display: flex; gap: 12px;">
              <button onclick="refreshAllCameras('${vehicleId}')" 
                      style="padding: 10px 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;"
                      onmouseover="this.style.background='#059669'" 
                      onmouseout="this.style.background='#10b981'">
                <i class="fas fa-sync-alt" style="margin-right: 6px;"></i>Refresh All
              </button>
              
              <button onclick="downloadCameraFootage('${vehicleId}')" 
                      style="padding: 10px 16px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;"
                      onmouseover="this.style.background='#7c3aed'" 
                      onmouseout="this.style.background='#8b5cf6'">
                <i class="fas fa-download" style="margin-right: 6px;"></i>Download Footage
              </button>
              
              <button onclick="enableNightVision('${vehicleId}')" 
                      style="padding: 10px 16px; background: #374151; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;"
                      onmouseover="this.style.background='#4b5563'" 
                      onmouseout="this.style.background='#374151'">
                <i class="fas fa-moon" style="margin-right: 6px;"></i>Night Vision
              </button>
            </div>
            
            <div style="display: flex; align-items: center; gap: 16px;">
              <div style="font-size: 12px; color: #9ca3af;">
                <i class="fas fa-hdd" style="margin-right: 6px;"></i>
                Storage: ${Math.floor(Math.random() * 40) + 60}% used
              </div>
              <div style="font-size: 12px; color: #9ca3af;">
                <i class="fas fa-signal" style="margin-right: 6px;"></i>
                Signal: ${isConnected ? Math.floor(Math.random() * 30) + 70 : 0}%
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Camera control functions
    function toggleCameraRecording(vehicleId, cameraId) {
      showActionNotification(`Starting recording on ${cameraId} camera for ${vehicleId}...`, 'info');
      
      setTimeout(() => {
        showActionNotification(`Recording started on ${cameraId} camera`, 'success');
      }, 1000);
    }

    function takeCameraSnapshot(vehicleId, cameraId) {
      showActionNotification(`Taking snapshot from ${cameraId} camera...`, 'info');
      
      setTimeout(() => {
        showActionNotification(`Snapshot saved from ${vehicleId} ${cameraId} camera`, 'success');
      }, 800);
    }

    function refreshAllCameras(vehicleId) {
      showActionNotification(`Refreshing all cameras for ${vehicleId}...`, 'info');
      
      setTimeout(() => {
        showActionNotification(`All cameras refreshed successfully`, 'success');
        // Close and reopen modal to simulate refresh
        closeModal('camera');
        setTimeout(() => showVehicleCameraModal(vehicleId), 500);
      }, 1500);
    }

    function downloadCameraFootage(vehicleId) {
      showActionNotification(`Preparing camera footage download for ${vehicleId}...`, 'info');
      
      setTimeout(() => {
        showActionNotification(`Camera footage download initiated`, 'success');
      }, 2000);
    }

    function enableNightVision(vehicleId) {
      showActionNotification(`Enabling night vision mode for ${vehicleId}...`, 'info');
      
      setTimeout(() => {
        showActionNotification(`Night vision mode enabled`, 'success');
      }, 1000);
    }

    // Route History Modal
    function showRouteHistoryModal(vehicleId) {
      const vehicle = fleetVehicles.find(v => v.id === vehicleId);
      
      // Close the vehicle info popup first
      const popup = document.getElementById('popup');
      if (popup) {
        popup.style.display = 'none';
      }
      
      // Generate realistic route history data
      const routeHistory = generateRouteHistory(vehicleId);
      
      const modal = document.createElement('div');
      modal.setAttribute('data-modal-type', 'route-history');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        font-family: 'Inter', sans-serif;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #1f2937; font-size: 20px; font-weight: bold;">
              <i class="fas fa-route" style="color: #059669; margin-right: 8px;"></i>
              Route History - ${vehicleId}
            </h3>
            <button onclick="closeModal('route-history')" 
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;"></button>
          </div>
          
          <!-- Vehicle Info Header -->
          <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; color: #1f2937; font-size: 16px;">
                  <i class="fas fa-car" style="color: #059669; margin-right: 8px;"></i>
                  ${vehicle.driver}  ${vehicleId}
                </div>
                <div style="font-size: 14px; color: #6b7280; margin-top: 4px;">
                  Current Status: <span style="color: ${getStatusColor(vehicle.status)}; font-weight: 600;">${vehicle.status.toUpperCase()}</span>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 14px; color: #374151;">
                  <strong>Total Distance Today:</strong> ${(Math.random() * 150 + 50).toFixed(1)} km
                </div>
                <div style="font-size: 14px; color: #374151; margin-top: 4px;">
                  <strong>Active Hours:</strong> ${Math.floor(Math.random() * 8) + 4}h ${Math.floor(Math.random() * 60)}m
                </div>
              </div>
            </div>
          </div>

          <!-- Time Period Filter -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Time Period:</label>
            <select id="routeTimePeriod" onchange="filterRouteHistory('${vehicleId}')" 
                    style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white;">
              <option value="today">Today</option>
              <option value="yesterday">Yesterday</option>
              <option value="week">Last 7 days</option>
              <option value="month">Last 30 days</option>
            </select>
          </div>
          
          <!-- Route Timeline -->
          <div style="border: 1px solid #e5e7eb; border-radius: 8px; max-height: 400px; overflow-y: auto;">
            <div style="background: #f8fafc; padding: 12px; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #374151;">
              <i class="fas fa-clock" style="margin-right: 8px;"></i>Route Timeline
            </div>
            <div id="routeTimelineContent" style="padding: 16px;">
              ${routeHistory.map(route => `
                <div style="display: flex; align-items: flex-start; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #f3f4f6;">
                  <div style="width: 40px; height: 40px; border-radius: 50%; background: ${getRouteTypeColor(route.type)}; 
                             display: flex; align-items: center; justify-content: center; margin-right: 16px; flex-shrink: 0;">
                    <i class="fas ${getRouteTypeIcon(route.type)}" style="color: white; font-size: 14px;"></i>
                  </div>
                  <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                      <div>
                        <div style="font-weight: 600; color: #1f2937; font-size: 14px;">${route.from}  ${route.to}</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
                          ${route.startTime} - ${route.endTime} (${route.duration})
                        </div>
                      </div>
                      <div style="text-align: right;">
                        <div style="font-size: 12px; color: #374151;">
                          <i class="fas fa-route" style="margin-right: 4px;"></i>${route.distance} km
                        </div>
                        <div style="font-size: 12px; color: #374151; margin-top: 2px;">
                          <i class="fas fa-tachometer-alt" style="margin-right: 4px;"></i>Avg: ${route.avgSpeed} km/h
                        </div>
                      </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                      <span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                        <i class="fas fa-users" style="margin-right: 4px;"></i>${route.passengers} passengers
                      </span>
                      <span style="background: #dcfce7; color: #16a34a; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                        <i class="fas fa-gas-pump" style="margin-right: 4px;"></i>${route.fuelUsed}L fuel
                      </span>
                      <span style="background: #fef3c7; color: #d97706; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                        <i class="fas fa-money-bill-wave" style="margin-right: 4px;"></i>${route.fare} JOD
              </span>
            </div>
              </div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
            <button onclick="exportRouteHistory('${vehicleId}')" 
                    style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-download" style="margin-right: 6px;"></i>Export Report
            </button>
            <button onclick="closeModal('route-history')" 
                    style="padding: 10px 20px; border: none; background: #059669; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-times" style="margin-right: 6px;"></i>Close
            </button>
            </div>
          </div>
        `;
        
      document.body.appendChild(modal);
    }

    // Generate realistic route history data
    function generateRouteHistory(vehicleId) {
      const locations = [
        'Amman City Center', 'Queen Alia Airport', 'Abdali Mall', 'Rainbow Street', 'University of Jordan',
        'King Hussein Medical Center', 'Dead Sea Resort', 'Jerash Archaeological Site', 'Wadi Rum Village',
        'Aqaba Port', 'Salt Historic Town', 'Madaba Mosaic City', 'Petra Visitor Center', 'Zarqa City Center',
        'Irbid University Area', 'Karak Castle', 'Ajloun Forest Reserve', 'Azraq Wetland Reserve'
      ];
      
      const routeTypes = ['pickup', 'delivery', 'tour', 'transfer'];
      const routes = [];
      
      // Generate 5-8 routes for today
      const routeCount = Math.floor(Math.random() * 4) + 5;
      
      for (let i = 0; i < routeCount; i++) {
        const startHour = 6 + Math.floor(Math.random() * 12);
        const startMinute = Math.floor(Math.random() * 60);
        const duration = Math.floor(Math.random() * 90) + 15; // 15-105 minutes
        const endTime = new Date();
        endTime.setHours(startHour, startMinute + duration, 0, 0);
        
        const distance = (Math.random() * 25 + 5).toFixed(1);
        const avgSpeed = (Math.random() * 30 + 40).toFixed(0);
        const passengers = Math.floor(Math.random() * 4) + 1;
        const fuelUsed = (distance * 0.08 + Math.random() * 2).toFixed(1);
        const fare = (distance * 0.5 + Math.random() * 5 + 2).toFixed(2);
        
        routes.push({
          type: routeTypes[Math.floor(Math.random() * routeTypes.length)],
          from: locations[Math.floor(Math.random() * locations.length)],
          to: locations[Math.floor(Math.random() * locations.length)],
          startTime: `${startHour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`,
          endTime: `${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`,
          duration: `${Math.floor(duration / 60)}h ${duration % 60}m`,
          distance: distance,
          avgSpeed: avgSpeed,
          passengers: passengers,
          fuelUsed: fuelUsed,
          fare: fare
        });
      }
      
      return routes.sort((a, b) => a.startTime.localeCompare(b.startTime));
    }

    // Helper functions for route history
    function getRouteTypeColor(type) {
      switch (type) {
        case 'pickup': return '#3b82f6';
        case 'delivery': return '#f59e0b';
        case 'tour': return '#8b5cf6';
        case 'transfer': return '#10b981';
        default: return '#6b7280';
      }
    }

    function getRouteTypeIcon(type) {
      switch (type) {
        case 'pickup': return 'fa-user-plus';
        case 'delivery': return 'fa-box';
        case 'tour': return 'fa-camera';
        case 'transfer': return 'fa-exchange-alt';
        default: return 'fa-route';
      }
    }

    function filterRouteHistory(vehicleId) {
      const period = document.getElementById('routeTimePeriod').value;
      showActionNotification(`Loading route history for ${period}...`, 'info');
      
      setTimeout(() => {
        showActionNotification(`Route history updated for ${period}`, 'success');
        // In a real implementation, this would reload the route data
      }, 1000);
    }

    function exportRouteHistory(vehicleId) {
      showActionNotification(`Generating route history report for ${vehicleId}...`, 'info');
      
      setTimeout(() => {
        showActionNotification(`Route history report downloaded successfully! `, 'success');
        closeModal('route-history');
      }, 2000);
    }

    // Geofencing Variables
    let isGeofenceMode = false;
    let geofencePoints = [];
    let geofenceLayer = null;
    let geofenceSource = null;
    let currentGeofence = null;
    let geofences = [];

    // Start Geofence Creation
    function startGeofenceCreation() {
      const button = document.getElementById('create-geofence');
      
      if (!isGeofenceMode) {
        // Start geofence creation mode
        isGeofenceMode = true;
        geofencePoints = [];
        
        button.innerHTML = '<i class="fas fa-stop mr-1"></i>Cancel Geofence';
        button.classList.remove('bg-orange-600', 'hover:bg-orange-700');
        button.classList.add('bg-red-600', 'hover:bg-red-700');
        
        showActionNotification(' Click on empty map areas to draw geofence points. After 3 points: right-click, press Enter, or use the Finish button.', 'info');
        
        // Enable drawing mode
        setupGeofenceDrawing();
        } else {
        // Cancel geofence creation
        cancelGeofenceCreation();
      }
    }

    function setupGeofenceDrawing() {
      // Create geofence layer if it doesn't exist
      if (!geofenceLayer) {
        geofenceSource = new ol.source.Vector();
        geofenceLayer = new ol.layer.Vector({
          source: geofenceSource,
          style: new ol.style.Style({
            fill: new ol.style.Fill({
              color: 'rgba(255, 165, 0, 0.2)'
            }),
            stroke: new ol.style.Stroke({
              color: '#ff9500',
              width: 3,
              lineDash: [5, 5]
            }),
            image: new ol.style.Circle({
              radius: 6,
              fill: new ol.style.Fill({
                color: '#ff9500'
              }),
              stroke: new ol.style.Stroke({
                color: 'white',
                width: 2
              })
            })
          })
        });
        fleetMap.addLayer(geofenceLayer);
      }

      // Add click handler for drawing
      fleetMap.on('click', handleGeofenceClick);
      
      // Add right-click handler for finishing
      fleetMap.on('contextmenu', handleGeofenceRightClick);
      
      // Add keyboard handler for finishing
      document.addEventListener('keydown', handleGeofenceKeydown);
      
      // Set cursor to crosshair for drawing mode
      fleetMap.getTargetElement().style.cursor = 'crosshair';
    }

    function handleGeofenceClick(evt) {
      if (!isGeofenceMode) return;
      
      // Check if we clicked on a vehicle feature
      const feature = fleetMap.forEachFeatureAtPixel(evt.pixel, function(feature) {
        return feature;
      });
      
      // If we clicked on a vehicle, don't add geofence point
      if (feature && feature.get('features')) {
        showActionNotification('Cannot place geofence point on a vehicle. Click on empty map area.', 'warning');
        return;
      }
      
      // Prevent default map click behavior during geofence creation
      evt.stopPropagation();
      
      const coordinate = evt.coordinate;
      
      // Add the new point
      geofencePoints.push(coordinate);
      
      // Create point feature
      const pointFeature = new ol.Feature({
        geometry: new ol.geom.Point(coordinate),
        type: 'geofence-point',
        index: geofencePoints.length - 1
      });
      
      geofenceSource.addFeature(pointFeature);
      
      // Show progress feedback
      showActionNotification(`Point ${geofencePoints.length} added ${geofencePoints.length >= 3 ? '(Right-click or press Enter to finish)' : ''}`, 'success');
      
      // Draw connecting lines
      updateGeofencePreview();
      
      // Add finish button if we have enough points
      if (geofencePoints.length >= 3) {
        addFinishGeofenceButton();
      }
    }

    function handleGeofenceRightClick(evt) {
      if (!isGeofenceMode || geofencePoints.length < 3) return;
      
      // Prevent context menu
      evt.preventDefault();
      evt.stopPropagation();
      
      finishGeofence();
    }

    function handleGeofenceKeydown(evt) {
      if (!isGeofenceMode || geofencePoints.length < 3) return;
      
      if (evt.key === 'Enter' || evt.key === 'Escape') {
        evt.preventDefault();
        if (evt.key === 'Enter') {
          finishGeofence();
        } else {
          cancelGeofenceCreation();
        }
      }
    }

    function addFinishGeofenceButton() {
      // Remove existing finish button if any
      const existingButton = document.getElementById('finish-geofence-btn');
      if (existingButton) {
        existingButton.remove();
      }
      
      // Create finish button
      const finishButton = document.createElement('button');
      finishButton.id = 'finish-geofence-btn';
      finishButton.innerHTML = '<i class="fas fa-check mr-1"></i>Finish Geofence';
      finishButton.className = 'px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-semibold shadow-lg';
      finishButton.style.cssText = `
        position: fixed;
        top: 120px;
        right: 20px;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
      `;
      
      finishButton.onclick = finishGeofence;
      document.body.appendChild(finishButton);
      
      // Add animation style if not exists
      if (!document.getElementById('geofence-animations')) {
        const style = document.createElement('style');
        style.id = 'geofence-animations';
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
    }

    function removeFinishGeofenceButton() {
      const button = document.getElementById('finish-geofence-btn');
      if (button) {
        button.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (button.parentNode) {
            button.remove();
          }
        }, 300);
      }
    }

    function finishGeofence() {
      if (geofencePoints.length < 3) {
        showActionNotification('A geofence needs at least 3 points', 'error');
        return;
      }
      
      showActionNotification('Finishing geofence...', 'info');
      removeFinishGeofenceButton();
      
      // Small delay for better UX
      setTimeout(() => {
        closeGeofence();
      }, 300);
    }



    function updateGeofencePreview() {
      // Remove existing preview line
      const existingLines = geofenceSource.getFeatures().filter(f => f.get('type') === 'geofence-line');
      existingLines.forEach(line => geofenceSource.removeFeature(line));
      
      if (geofencePoints.length > 1) {
        // Draw lines between points
        for (let i = 0; i < geofencePoints.length - 1; i++) {
          const lineFeature = new ol.Feature({
            geometry: new ol.geom.LineString([geofencePoints[i], geofencePoints[i + 1]]),
            type: 'geofence-line'
          });
          geofenceSource.addFeature(lineFeature);
        }
        
        // Draw line from last point to first point for preview
        if (geofencePoints.length > 2) {
          const previewLine = new ol.Feature({
            geometry: new ol.geom.LineString([geofencePoints[geofencePoints.length - 1], geofencePoints[0]]),
            type: 'geofence-preview'
          });
          previewLine.setStyle(new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: '#ff9500',
              width: 2,
              lineDash: [10, 10]
            })
          }));
          geofenceSource.addFeature(previewLine);
        }
      }
    }

    function closeGeofence() {
      if (geofencePoints.length < 3) {
        showActionNotification('A geofence needs at least 3 points', 'error');
        return;
      }
      
      // Remove preview elements and create final polygon
      geofenceSource.clear();
      
      // Create closed polygon
      const closedPoints = [...geofencePoints, geofencePoints[0]];
      const polygonFeature = new ol.Feature({
        geometry: new ol.geom.Polygon([closedPoints]),
        type: 'geofence-polygon',
        id: 'temp-geofence'
      });
      
      geofenceSource.addFeature(polygonFeature);
      
      // Show geofence rules modal
      showGeofenceRulesModal(geofencePoints);
    }

    function showGeofenceTooltip(coordinate, message) {
      // Create temporary tooltip
      const tooltip = document.createElement('div');
      tooltip.style.cssText = `
        position: absolute;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        white-space: nowrap;
      `;
      tooltip.textContent = message;
      document.body.appendChild(tooltip);
      
      const pixel = fleetMap.getPixelFromCoordinate(coordinate);
      tooltip.style.left = (pixel[0] + 10) + 'px';
      tooltip.style.top = (pixel[1] - 40) + 'px';
      
      setTimeout(() => {
        if (tooltip.parentNode) {
          tooltip.parentNode.removeChild(tooltip);
        }
      }, 3000);
    }

    function cancelGeofenceCreation() {
      isGeofenceMode = false;
      geofencePoints = [];
      
      const button = document.getElementById('create-geofence');
      button.innerHTML = '<i class="fas fa-draw-polygon mr-1"></i>Create Geofence';
      button.classList.remove('bg-red-600', 'hover:bg-red-700');
      button.classList.add('bg-orange-600', 'hover:bg-orange-700');
      
      // Remove event handlers
      fleetMap.un('click', handleGeofenceClick);
      fleetMap.un('contextmenu', handleGeofenceRightClick);
      document.removeEventListener('keydown', handleGeofenceKeydown);
      
      // Remove finish button
      removeFinishGeofenceButton();
      
      // Reset cursor
      fleetMap.getTargetElement().style.cursor = 'default';
      
      // Clear temporary geofence
      if (geofenceSource) {
        const tempFeatures = geofenceSource.getFeatures().filter(f => 
          f.get('type') && f.get('type').startsWith('geofence')
        );
        tempFeatures.forEach(feature => geofenceSource.removeFeature(feature));
      }
      
      showActionNotification('Geofence creation cancelled', 'info');
    }

    function showGeofenceRulesModal(points) {
      // Close any existing modals
      closeAllModals();
      
      const modal = document.createElement('div');
      modal.setAttribute('data-modal-type', 'geofence-rules');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        font-family: 'Inter', sans-serif;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #1f2937; font-size: 20px; font-weight: bold;">
              <i class="fas fa-shield-alt" style="color: #ff9500; margin-right: 8px;"></i>
              Geofence Rules Configuration
            </h3>
            <button onclick="closeModal('geofence-rules')" 
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;"></button>
          </div>
          
          <!-- Geofence Info -->
          <div style="background: #fef3c7; border-radius: 8px; padding: 16px; margin-bottom: 20px; border: 1px solid #fbbf24;">
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
              <i class="fas fa-info-circle" style="color: #d97706; margin-right: 8px;"></i>
              <span style="font-weight: 600; color: #92400e;">Geofence Area Details</span>
            </div>
            <div style="font-size: 14px; color: #7c2d12;">
              <div>Points: ${points.length}</div>
              <div>Area: ~${calculateGeofenceArea(points)} km</div>
            </div>
          </div>

          <!-- Geofence Name -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Geofence Name:</label>
            <input id="geofenceName" type="text" placeholder="Enter geofence name (e.g., Downtown Area, Airport Zone)" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>

          <!-- Rule Type -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Rule Type:</label>
            <select id="geofenceRuleType" onchange="updateRuleOptions()" 
                    style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="restricted">Restricted Zone (No Entry)</option>
              <option value="speed-limit">Speed Limit Zone</option>
              <option value="allowed-only">Allowed Zone Only</option>
              <option value="notification">Notification Zone</option>
              <option value="parking">Parking Zone</option>
            </select>
          </div>

          <!-- Speed Limit (conditional) -->
          <div id="speedLimitSection" style="margin-bottom: 16px; display: none;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Speed Limit (km/h):</label>
            <input id="speedLimit" type="number" min="5" max="120" value="30" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>

          <!-- Notification Settings -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Notifications:</label>
            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="notifyEntry" checked style="margin-right: 6px;" />
                <span style="font-size: 14px;">Entry Alert</span>
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="notifyExit" checked style="margin-right: 6px;" />
                <span style="font-size: 14px;">Exit Alert</span>
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="notifyViolation" checked style="margin-right: 6px;" />
                <span style="font-size: 14px;">Rule Violation</span>
              </label>
            </div>
          </div>

          <!-- Vehicle Selection -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Apply to Vehicles:</label>
            <select id="vehicleSelection" onchange="updateRuleOptions()" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="all">All Vehicles</option>
              <option value="active">Active Vehicles Only</option>
              <option value="specific">Specific Vehicles</option>
            </select>
            <div id="specificVehicles" style="display: none; margin-top: 8px; max-height: 100px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px;">
              ${generateVehicleCheckboxes()}
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="cancelGeofenceCreation(); closeModal('geofence-rules');" 
                    style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer;">
              Cancel
            </button>
            <button onclick="saveGeofence()" 
                    style="padding: 10px 20px; border: none; background: #ff9500; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-save" style="margin-right: 6px;"></i>Create Geofence
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function calculateGeofenceArea(points) {
      // Simple polygon area calculation (approximate)
      if (points.length < 3) return 0;
      
      // Create polygon to get more accurate area using OpenLayers
      try {
        const polygon = new ol.geom.Polygon([points]);
        const area = polygon.getArea();
        // Convert from square meters to square kilometers
        return (area / 1000000).toFixed(2);
      } catch (error) {
        // Fallback to simple calculation
        let area = 0;
        for (let i = 0; i < points.length; i++) {
          const j = (i + 1) % points.length;
          area += points[i][0] * points[j][1];
          area -= points[j][0] * points[i][1];
        }
        area = Math.abs(area) / 2;
        return (area / 1000000000).toFixed(2);
      }
    }

    function generateVehicleCheckboxes() {
      return fleetVehicles.map(vehicle => 
        `<label style="display: block; margin-bottom: 4px; cursor: pointer;">
          <input type="checkbox" name="vehicleSelect" value="${vehicle.id}" style="margin-right: 6px;" />
          <span style="font-size: 14px;">${vehicle.id} - ${vehicle.driver}</span>
        </label>`
      ).join('');
    }

    function updateRuleOptions() {
      const ruleType = document.getElementById('geofenceRuleType').value;
      const speedSection = document.getElementById('speedLimitSection');
      const vehicleSection = document.getElementById('specificVehicles');
      const vehicleSelection = document.getElementById('vehicleSelection');
      
      if (ruleType === 'speed-limit') {
        speedSection.style.display = 'block';
      } else {
        speedSection.style.display = 'none';
      }
      
      if (vehicleSelection.value === 'specific') {
        vehicleSection.style.display = 'block';
      } else {
        vehicleSection.style.display = 'none';
      }
    }

    function saveGeofence() {
      const name = document.getElementById('geofenceName').value.trim();
      const ruleType = document.getElementById('geofenceRuleType').value;
      const speedLimit = document.getElementById('speedLimit').value;
      const notifyEntry = document.getElementById('notifyEntry').checked;
      const notifyExit = document.getElementById('notifyExit').checked;
      const notifyViolation = document.getElementById('notifyViolation').checked;
      const vehicleSelection = document.getElementById('vehicleSelection').value;
      
      if (!name) {
        showActionNotification('Please enter a geofence name', 'error');
        return;
      }
      
      // Get selected vehicles if specific selection
      let selectedVehicles = [];
      if (vehicleSelection === 'specific') {
        const checkboxes = document.querySelectorAll('input[name="vehicleSelect"]:checked');
        selectedVehicles = Array.from(checkboxes).map(cb => cb.value);
        if (selectedVehicles.length === 0) {
          showActionNotification('Please select at least one vehicle', 'error');
          return;
        }
      }
      
      // Create geofence object
      const geofence = {
        id: 'gf_' + Date.now(),
        name: name,
        points: geofencePoints,
        ruleType: ruleType,
        speedLimit: speedLimit,
        notifications: {
          entry: notifyEntry,
          exit: notifyExit,
          violation: notifyViolation
        },
        vehicles: vehicleSelection === 'all' ? 'all' : 
                 vehicleSelection === 'active' ? 'active' : selectedVehicles,
        createdAt: new Date().toISOString(),
        active: true
      };
      
      // Save geofence
      geofences.push(geofence);
      
      // Update the polygon feature with final styling
      const polygonFeature = geofenceSource.getFeatures().find(f => f.get('id') === 'temp-geofence');
      if (polygonFeature) {
        polygonFeature.set('id', geofence.id);
        polygonFeature.set('geofence', geofence);
        polygonFeature.setStyle(createGeofenceStyle(ruleType));
      }
      
      // Reset geofence creation mode
      isGeofenceMode = false;
      geofencePoints = [];
      
      const button = document.getElementById('create-geofence');
      button.innerHTML = '<i class="fas fa-draw-polygon mr-1"></i>Create Geofence';
      button.classList.remove('bg-red-600', 'hover:bg-red-700');
      button.classList.add('bg-orange-600', 'hover:bg-orange-700');
      
      // Remove event handlers
      fleetMap.un('click', handleGeofenceClick);
      fleetMap.un('contextmenu', handleGeofenceRightClick);
      document.removeEventListener('keydown', handleGeofenceKeydown);
      
      // Remove finish button
      removeFinishGeofenceButton();
      
      // Reset cursor
      fleetMap.getTargetElement().style.cursor = 'default';
      
      // Close modal
      closeModal('geofence-rules');
      
      showActionNotification(`Geofence "${name}" created successfully! `, 'success');
      
      console.log('Geofence created:', geofence);
    }

    // Handle geofence interaction (click on existing geofence)
    function handleGeofenceInteraction(feature, coordinate) {
      const geofence = feature.get('geofence');
      if (!geofence) return;
      
      // Close any existing popups
      const popup = document.getElementById('popup');
      if (popup) {
        popup.style.display = 'none';
      }
      
      showGeofenceInteractionModal(geofence, coordinate);
    }

    function showGeofenceInteractionModal(geofence, coordinate) {
      // Close any existing modals
      closeAllModals();
      
      const modal = document.createElement('div');
      modal.setAttribute('data-modal-type', 'geofence-interaction');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        font-family: 'Inter', sans-serif;
      `;
      
      const ruleTypeInfo = {
        'restricted': { icon: 'fa-ban', color: '#dc2626', label: 'Restricted Zone' },
        'speed-limit': { icon: 'fa-tachometer-alt', color: '#f59e0b', label: 'Speed Limit Zone' },
        'allowed-only': { icon: 'fa-check-circle', color: '#10b981', label: 'Allowed Zone Only' },
        'notification': { icon: 'fa-bell', color: '#3b82f6', label: 'Notification Zone' },
        'parking': { icon: 'fa-parking', color: '#8b5cf6', label: 'Parking Zone' }
      };
      
      const ruleInfo = ruleTypeInfo[geofence.ruleType] || ruleTypeInfo['notification'];
      const createdDate = new Date(geofence.createdAt).toLocaleDateString();
      const vehicleCount = geofence.vehicles === 'all' ? 'All Vehicles' : 
                          geofence.vehicles === 'active' ? 'Active Vehicles' : 
                          `${geofence.vehicles.length} Selected Vehicles`;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #1f2937; font-size: 20px; font-weight: bold;">
              <i class="fas ${ruleInfo.icon}" style="color: ${ruleInfo.color}; margin-right: 8px;"></i>
              ${geofence.name}
            </h3>
            <button onclick="closeModal('geofence-interaction')" 
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;"></button>
          </div>
          
          <!-- Geofence Info -->
          <div style="background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <div style="display: grid; grid-cols-2; gap: 12px;">
              <div>
                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Type</div>
                <div style="font-size: 14px; color: #374151; font-weight: 500;">${ruleInfo.label}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Created</div>
                <div style="font-size: 14px; color: #374151; font-weight: 500;">${createdDate}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Vehicles</div>
                <div style="font-size: 14px; color: #374151; font-weight: 500;">${vehicleCount}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Status</div>
                <div style="font-size: 14px; color: ${geofence.active ? '#10b981' : '#ef4444'}; font-weight: 600;">
                  ${geofence.active ? 'Active' : 'Inactive'}
                </div>
              </div>
            </div>
            
            ${geofence.ruleType === 'speed-limit' ? `
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Speed Limit</div>
                <div style="font-size: 14px; color: #374151; font-weight: 500;">${geofence.speedLimit} km/h</div>
              </div>
            ` : ''}
          </div>

          <!-- Notifications Status -->
          <div style="margin-bottom: 20px;">
            <div style="font-size: 14px; color: #374151; font-weight: 600; margin-bottom: 8px;">Notifications</div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <span style="background: ${geofence.notifications.entry ? '#dcfce7' : '#fef2f2'}; 
                           color: ${geofence.notifications.entry ? '#16a34a' : '#dc2626'}; 
                           padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                Entry: ${geofence.notifications.entry ? 'ON' : 'OFF'}
              </span>
              <span style="background: ${geofence.notifications.exit ? '#dcfce7' : '#fef2f2'}; 
                           color: ${geofence.notifications.exit ? '#16a34a' : '#dc2626'}; 
                           padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                Exit: ${geofence.notifications.exit ? 'ON' : 'OFF'}
              </span>
              <span style="background: ${geofence.notifications.violation ? '#dcfce7' : '#fef2f2'}; 
                           color: ${geofence.notifications.violation ? '#16a34a' : '#dc2626'}; 
                           padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                Violations: ${geofence.notifications.violation ? 'ON' : 'OFF'}
              </span>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="editGeofence('${geofence.id}')" 
                    style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-edit" style="margin-right: 6px;"></i>Edit
            </button>
            <button onclick="toggleGeofenceStatus('${geofence.id}')" 
                    style="padding: 10px 20px; border: none; background: ${geofence.active ? '#f59e0b' : '#10b981'}; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
              <i class="fas ${geofence.active ? 'fa-pause' : 'fa-play'}" style="margin-right: 6px;"></i>
              ${geofence.active ? 'Disable' : 'Enable'}
            </button>
            <button onclick="deleteGeofence('${geofence.id}')" 
                    style="padding: 10px 20px; border: none; background: #dc2626; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-trash" style="margin-right: 6px;"></i>Delete
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Geofence management functions
    function editGeofence(geofenceId) {
      const geofence = geofences.find(g => g.id === geofenceId);
      if (!geofence) return;
      
      // Close interaction modal
      closeModal('geofence-interaction');
      
      // Show edit modal (reuse the rules modal but pre-populate it)
      showGeofenceEditModal(geofence);
    }

    function toggleGeofenceStatus(geofenceId) {
      const geofence = geofences.find(g => g.id === geofenceId);
      if (!geofence) return;
      
      geofence.active = !geofence.active;
      
      // Update visual styling
      const feature = geofenceSource.getFeatures().find(f => f.get('id') === geofenceId);
      if (feature) {
        if (geofence.active) {
          feature.setStyle(createGeofenceStyle(geofence.ruleType));
        } else {
          // Set inactive style (grayed out)
          feature.setStyle(createInactiveGeofenceStyle());
        }
      }
      
      // Close modal and show feedback
      closeModal('geofence-interaction');
      showActionNotification(`Geofence "${geofence.name}" ${geofence.active ? 'enabled' : 'disabled'}`, 'success');
    }

    function deleteGeofence(geofenceId) {
      const geofence = geofences.find(g => g.id === geofenceId);
      if (!geofence) return;
      
      // Show confirmation dialog
      if (confirm(`Are you sure you want to delete the geofence "${geofence.name}"?\\n\\nThis action cannot be undone.`)) {
        // Remove from geofences array
        const index = geofences.findIndex(g => g.id === geofenceId);
        if (index > -1) {
          geofences.splice(index, 1);
        }
        
        // Remove from map
        const feature = geofenceSource.getFeatures().find(f => f.get('id') === geofenceId);
        if (feature) {
          geofenceSource.removeFeature(feature);
        }
        
        // Close modal and show feedback
        closeModal('geofence-interaction');
        showActionNotification(`Geofence "${geofence.name}" deleted successfully`, 'success');
      }
    }

    function createInactiveGeofenceStyle() {
      return new ol.style.Style({
        fill: new ol.style.Fill({
          color: 'rgba(156, 163, 175, 0.2)'
        }),
        stroke: new ol.style.Stroke({
          color: '#9ca3af',
          width: 2,
          lineDash: [5, 5]
        })
      });
    }

    function showGeofenceEditModal(geofence) {
      // Close any existing modals
      closeAllModals();
      
      const modal = document.createElement('div');
      modal.setAttribute('data-modal-type', 'geofence-edit');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        font-family: 'Inter', sans-serif;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #1f2937; font-size: 20px; font-weight: bold;">
              <i class="fas fa-edit" style="color: #3b82f6; margin-right: 8px;"></i>
              Edit Geofence
            </h3>
            <button onclick="closeModal('geofence-edit')" 
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;"></button>
          </div>
          
          <!-- Geofence Name -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Geofence Name:</label>
            <input id="editGeofenceName" type="text" value="${geofence.name}" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>

          <!-- Rule Type -->
          <div style="margin-bottom: 16px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Rule Type:</label>
            <select id="editGeofenceRuleType" onchange="updateEditRuleOptions()" 
                    style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
              <option value="restricted" ${geofence.ruleType === 'restricted' ? 'selected' : ''}>Restricted Zone (No Entry)</option>
              <option value="speed-limit" ${geofence.ruleType === 'speed-limit' ? 'selected' : ''}>Speed Limit Zone</option>
              <option value="allowed-only" ${geofence.ruleType === 'allowed-only' ? 'selected' : ''}>Allowed Zone Only</option>
              <option value="notification" ${geofence.ruleType === 'notification' ? 'selected' : ''}>Notification Zone</option>
              <option value="parking" ${geofence.ruleType === 'parking' ? 'selected' : ''}>Parking Zone</option>
            </select>
          </div>

          <!-- Speed Limit (conditional) -->
          <div id="editSpeedLimitSection" style="margin-bottom: 16px; display: ${geofence.ruleType === 'speed-limit' ? 'block' : 'none'};">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Speed Limit (km/h):</label>
            <input id="editSpeedLimit" type="number" min="5" max="120" value="${geofence.speedLimit || 30}" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" />
          </div>

          <!-- Notification Settings -->
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px;">Notifications:</label>
            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="editNotifyEntry" ${geofence.notifications.entry ? 'checked' : ''} style="margin-right: 6px;" />
                <span style="font-size: 14px;">Entry Alert</span>
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="editNotifyExit" ${geofence.notifications.exit ? 'checked' : ''} style="margin-right: 6px;" />
                <span style="font-size: 14px;">Exit Alert</span>
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="editNotifyViolation" ${geofence.notifications.violation ? 'checked' : ''} style="margin-right: 6px;" />
                <span style="font-size: 14px;">Rule Violation</span>
              </label>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeModal('geofence-edit')" 
                    style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer;">
              Cancel
            </button>
            <button onclick="saveGeofenceEdit('${geofence.id}')" 
                    style="padding: 10px 20px; border: none; background: #3b82f6; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
              <i class="fas fa-save" style="margin-right: 6px;"></i>Save Changes
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function updateEditRuleOptions() {
      const ruleType = document.getElementById('editGeofenceRuleType').value;
      const speedSection = document.getElementById('editSpeedLimitSection');
      
      if (ruleType === 'speed-limit') {
        speedSection.style.display = 'block';
      } else {
        speedSection.style.display = 'none';
      }
    }

    function saveGeofenceEdit(geofenceId) {
      const geofence = geofences.find(g => g.id === geofenceId);
      if (!geofence) return;
      
      const name = document.getElementById('editGeofenceName').value.trim();
      const ruleType = document.getElementById('editGeofenceRuleType').value;
      const speedLimit = document.getElementById('editSpeedLimit').value;
      const notifyEntry = document.getElementById('editNotifyEntry').checked;
      const notifyExit = document.getElementById('editNotifyExit').checked;
      const notifyViolation = document.getElementById('editNotifyViolation').checked;
      
      if (!name) {
        showActionNotification('Please enter a geofence name', 'error');
        return;
      }
      
      // Update geofence object
      geofence.name = name;
      geofence.ruleType = ruleType;
      geofence.speedLimit = speedLimit;
      geofence.notifications = {
        entry: notifyEntry,
        exit: notifyExit,
        violation: notifyViolation
      };
      
      // Update visual styling
      const feature = geofenceSource.getFeatures().find(f => f.get('id') === geofenceId);
      if (feature) {
        feature.set('geofence', geofence);
        if (geofence.active) {
          feature.setStyle(createGeofenceStyle(ruleType));
        }
      }
      
      // Close modal and show feedback
      closeModal('geofence-edit');
      showActionNotification(`Geofence "${name}" updated successfully! `, 'success');
    }

    function createGeofenceStyle(ruleType) {
      const colors = {
        'restricted': { fill: 'rgba(220, 38, 38, 0.2)', stroke: '#dc2626' },
        'speed-limit': { fill: 'rgba(245, 158, 11, 0.2)', stroke: '#f59e0b' },
        'allowed-only': { fill: 'rgba(16, 185, 129, 0.2)', stroke: '#10b981' },
        'notification': { fill: 'rgba(59, 130, 246, 0.2)', stroke: '#3b82f6' },
        'parking': { fill: 'rgba(139, 92, 246, 0.2)', stroke: '#8b5cf6' }
      };
      
      const color = colors[ruleType] || colors['notification'];
      
      return new ol.style.Style({
        fill: new ol.style.Fill({
          color: color.fill
        }),
        stroke: new ol.style.Stroke({
          color: color.stroke,
          width: 2
        })
      });
    }

    // Initialize OpenLayers Map
    function initOpenLayersMap() {
      console.log(' Initializing OpenLayers Fleet Map...');
      
      // Check if container exists
      const container = document.getElementById('fleet-map-container');
      if (!container) {
        console.error(' Map container not found!');
        return;
      }
      
      try {

      // Create vector source and clustering source
      vectorSource = new ol.source.Vector();
      
      // Create cluster source for grouping nearby vehicles
      clusterSource = new ol.source.Cluster({
        distance: 40, // Distance in pixels for clustering
        minDistance: 20, // Minimum distance between clusters
        source: vectorSource
      });
      
      // Create vector layer with clustering
      vectorLayer = new ol.layer.Vector({
        source: clusterSource,
        style: (feature) => {
          return createClusterStyle(feature);
        }
      });

      // Create OpenStreetMap layer
      osmLayer = new ol.layer.Tile({
        source: new ol.source.OSM(),
        title: 'OpenStreetMap'
      });

      // Create satellite layer (initially hidden)
      satelliteLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
          attributions: [' Esri', ' DigitalGlobe', ' GeoEye']
        }),
        visible: false,
        title: 'Satellite'
      });

      // Initialize map
      fleetMap = new ol.Map({
        target: 'fleet-map-container',
        layers: [osmLayer, satelliteLayer, vectorLayer],
        view: new ol.View({
          center: ol.proj.fromLonLat([35.9106, 31.9539]), // Amman, Jordan
          zoom: 12,
          projection: 'EPSG:3857'
        }),
        controls: [
          new ol.control.Attribution({
            collapsible: false
          }),
          new ol.control.Zoom()
        ]
      });

      // Add popup overlay
      createPopupOverlay();

      // Add vehicle markers
      addVehicleMarkers();
      
      // Update statistics
      updateMapStatistics();
      
      // Set up auto-refresh
      setInterval(updateVehiclePositions, 30000); // Update every 30 seconds
      
      // Force map to render
      setTimeout(() => {
        fleetMap.updateSize();
        console.log(' Map size updated');
      }, 100);
      
      console.log(' OpenLayers Fleet Map initialized successfully');
      
      } catch (error) {
        console.error(' Error initializing OpenLayers map:', error);
        // Fallback to basic content
        container.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8fafc; border-radius: 8px;">
            <div style="text-align: center; color: #6b7280;">
              <i class="fas fa-map text-4xl mb-4"></i>
              <p style="font-size: 16px; margin: 0;">Map initialization failed</p>
              <p style="font-size: 14px; margin: 8px 0 0 0;">Please refresh the page</p>
            </div>
              </div>
        `;
      }
    }

    // Create cluster style for grouped vehicles
    function createClusterStyle(feature) {
      const features = feature.get('features');
      const size = features.length;
      
      if (size === 1) {
        // Single vehicle - use individual style
        const vehicle = features[0];
        const status = vehicle.get('status');
        return createVehicleStyle(status);
      } else {
        // Multiple vehicles - create cluster style
        const statusCounts = {};
        features.forEach(f => {
          const status = f.get('status');
          statusCounts[status] = (statusCounts[status] || 0) + 1;
        });
        
        // Determine dominant status for cluster color
        const dominantStatus = Object.keys(statusCounts).reduce((a, b) => 
          statusCounts[a] > statusCounts[b] ? a : b
        );
        
        const clusterColor = getClusterColor(dominantStatus);
        const radius = Math.min(Math.max(12 + size * 2, 20), 40); // Scale radius with cluster size
        
        return new ol.style.Style({
          image: new ol.style.Circle({
            radius: radius,
            fill: new ol.style.Fill({
              color: clusterColor
            }),
            stroke: new ol.style.Stroke({
              color: [255, 255, 255, 1],
              width: 3
            })
          }),
          text: new ol.style.Text({
            text: size.toString(),
            font: 'bold 14px sans-serif',
            fill: new ol.style.Fill({
              color: '#ffffff'
            }),
            stroke: new ol.style.Stroke({
              color: '#000000',
              width: 2
            })
          })
        });
      }
    }
    
    // Create vehicle style based on status (for individual vehicles)
    function createVehicleStyle(status) {
      let color, textContent;
      
      switch(status) {
        case 'active': 
          color = [16, 185, 129, 1]; // green
          textContent = '';
          break;
        case 'idle': 
          color = [245, 158, 11, 1]; // yellow/orange
          textContent = '';
          break;
        case 'parked': 
          color = [59, 130, 246, 1]; // blue
          textContent = '';
          break;
        case 'offline': 
          color = [107, 114, 128, 1]; // gray
          textContent = '';
          break;
        default: 
          color = [107, 114, 128, 1]; // gray
          textContent = '';
          break;
      }

      return new ol.style.Style({
        image: new ol.style.Circle({
          radius: 15,
          fill: new ol.style.Fill({
            color: color
          }),
          stroke: new ol.style.Stroke({
            color: [255, 255, 255, 1],
            width: 3
          })
        }),
        text: new ol.style.Text({
          text: textContent,
          font: '14px sans-serif',
          fill: new ol.style.Fill({
            color: '#000'
          })
        })
      });
    }
    
    // Get cluster color based on dominant status
    function getClusterColor(status) {
      switch(status) {
        case 'active': return [16, 185, 129, 0.8]; // green with transparency
        case 'idle': return [245, 158, 11, 0.8];   // orange with transparency
        case 'parked': return [59, 130, 246, 0.8]; // blue with transparency
        case 'offline': return [107, 114, 128, 0.8]; // gray with transparency
        default: return [107, 114, 128, 0.8];
      }
    }

    // Create popup overlay
    function createPopupOverlay() {
      // Create popup element
      const popup = document.createElement('div');
      popup.id = 'popup';
      popup.style.cssText = `
        position: absolute;
        background: white;
        border-radius: 8px;
        border: 1px solid #ccc;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 12px;
        max-width: 250px;
        display: none;
        z-index: 1000;
      `;
      document.body.appendChild(popup);

      const overlay = new ol.Overlay({
        element: popup,
        positioning: 'bottom-center',
        stopEvent: false,
        offset: [0, -10]
      });
      fleetMap.addOverlay(overlay);

            // Add click handler to show popups
      fleetMap.on('click', function(evt) {
        const feature = fleetMap.forEachFeatureAtPixel(evt.pixel, function(feature) {
          return feature;
        });

        if (feature) {
          // Check if it's a geofence feature
          if (feature.get('type') === 'geofence-polygon' || feature.get('geofence')) {
            handleGeofenceInteraction(feature, evt.coordinate);
            return;
          }
          
          const features = feature.get('features');
          const coordinate = feature.getGeometry().getCoordinates();
          
          if (features.length === 1) {
            // Single vehicle popup with executive controls
            const vehicle = features[0].get('vehicleData');
            const isConnected = vehicle.status !== 'offline';
            const isLocked = Math.random() > 0.7; // Simulate some vehicles being locked
            
            popup.innerHTML = `
              <div style="font-family: 'Inter', sans-serif; max-width: 320px;">
                <!-- Vehicle Header -->
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 12px;">
                  <h4 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: bold;">${vehicle.id}</h4>
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: ${getStatusColor(vehicle.status)}; margin-left: auto;"></div>
                </div>
                
                <!-- Vehicle Info -->
                <div style="font-size: 14px; color: #6b7280; line-height: 1.6; margin-bottom: 16px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span><strong>Driver:</strong></span>
                    <span>${vehicle.driver}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span><strong>Status:</strong></span>
                    <span style="color: ${getStatusColor(vehicle.status)}; font-weight: bold;">${vehicle.status.toUpperCase()}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span><strong>Speed:</strong></span>
                    <span>${vehicle.speed} km/h</span>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span><strong>Location:</strong></span>
                    <span>${vehicle.lat.toFixed(4)}, ${vehicle.lng.toFixed(4)}</span>
                  </div>
                </div>
                
                <!-- Executive Action Buttons -->
                <div style="border-top: 1px solid #e5e7eb; padding-top: 12px;">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                    <button onclick="toggleConnection('${vehicle.id}', ${isConnected})" 
                            style="padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; 
                                   background: ${isConnected ? '#dc2626' : '#10b981'}; color: white; transition: all 0.2s;"
                            onmouseover="this.style.opacity='0.8'" 
                            onmouseout="this.style.opacity='1'">
                      <i class="fas ${isConnected ? 'fa-unlink' : 'fa-link'}" style="margin-right: 4px;"></i>
                      ${isConnected ? 'Disconnect' : 'Connect'}
                    </button>
                    
                    <button onclick="toggleLock('${vehicle.id}', ${isLocked})" 
                            style="padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; 
                                   background: ${isLocked ? '#f59e0b' : '#6366f1'}; color: white; transition: all 0.2s;"
                            onmouseover="this.style.opacity='0.8'" 
                            onmouseout="this.style.opacity='1'">
                      <i class="fas ${isLocked ? 'fa-unlock' : 'fa-lock'}" style="margin-right: 4px;"></i>
                      ${isLocked ? 'Unlock' : 'Lock'}
                    </button>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                    <button onclick="communicateWithVehicle('${vehicle.id}')" 
                            style="padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; 
                                   background: #0ea5e9; color: white; transition: all 0.2s;"
                            onmouseover="this.style.opacity='0.8'" 
                            onmouseout="this.style.opacity='1'">
                      <i class="fas fa-comments" style="margin-right: 4px;"></i>
                      Communicate
                    </button>
                    
                    <button onclick="viewVehicleDetails('${vehicle.id}')" 
                            style="padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; 
                                   background: #8b5cf6; color: white; transition: all 0.2s;"
                            onmouseover="this.style.opacity='0.8'" 
                            onmouseout="this.style.opacity='1'">
                      <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                      Details
                    </button>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button onclick="viewVehicleCamera('${vehicle.id}')" 
                            style="padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; 
                                   background: #ef4444; color: white; transition: all 0.2s;"
                            onmouseover="this.style.opacity='0.8'" 
                            onmouseout="this.style.opacity='1'">
                      <i class="fas fa-video" style="margin-right: 4px;"></i>
                      Camera
                    </button>
                    
                    <button onclick="viewRouteHistory('${vehicle.id}')" 
                            style="padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; 
                                   background: #059669; color: white; transition: all 0.2s;"
                            onmouseover="this.style.opacity='0.8'" 
                            onmouseout="this.style.opacity='1'">
                      <i class="fas fa-route" style="margin-right: 4px;"></i>
                      Route History
                    </button>
                  </div>
                </div>
                
                <!-- Connection Status -->
                <div style="margin-top: 12px; padding: 8px; background: ${isConnected ? '#dcfce7' : '#fef2f2'}; 
                           border-radius: 6px; text-align: center; font-size: 12px;">
                  <i class="fas ${isConnected ? 'fa-wifi' : 'fa-wifi-slash'}" 
                     style="color: ${isConnected ? '#16a34a' : '#dc2626'}; margin-right: 4px;"></i>
                  <span style="color: ${isConnected ? '#16a34a' : '#dc2626'}; font-weight: 600;">
                    ${isConnected ? 'Connected' : 'Disconnected'}
                  </span>
                </div>
              </div>
            `;
          } else {
            // Cluster popup with summary
            const statusCounts = {};
            features.forEach(f => {
              const status = f.get('status');
              statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            let statusSummary = '';
            Object.entries(statusCounts).forEach(([status, count]) => {
              statusSummary += `<div style="margin: 2px 0;"><span style="color: ${getStatusColor(status)}; font-weight: bold;">${count} ${status.toUpperCase()}</span></div>`;
            });
            
            popup.innerHTML = `
              <div style="font-family: 'Inter', sans-serif;">
                <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px; font-weight: bold;">Vehicle Cluster (${features.length})</h4>
                <div style="font-size: 14px; color: #6b7280; line-height: 1.5;">
                  <div style="margin-bottom: 8px;"><strong>Vehicles:</strong> ${features.length} total</div>
                  <div><strong>Status Breakdown:</strong></div>
                  ${statusSummary}
                  <div style="margin-top: 8px; font-size: 12px; color: #9ca3af;">Zoom in to see individual vehicles</div>
                </div>
              </div>
            `;
          }
          
          overlay.setPosition(coordinate);
          popup.style.display = 'block';
        } else {
          popup.style.display = 'none';
        }
      });

      // Hide popup when clicking elsewhere
      fleetMap.on('pointermove', function(evt) {
        const feature = fleetMap.forEachFeatureAtPixel(evt.pixel, function(feature) {
          return feature;
        });
        fleetMap.getTargetElement().style.cursor = feature ? 'pointer' : '';
      });
    }

    // Add vehicle markers to the map
    function addVehicleMarkers() {
      // Clear existing features
      vectorSource.clear();

      fleetVehicles.forEach(vehicle => {
        const feature = new ol.Feature({
          geometry: new ol.geom.Point(ol.proj.fromLonLat([vehicle.lng, vehicle.lat])),
          vehicleData: vehicle,
          status: vehicle.status
        });

        vectorSource.addFeature(feature);
      });
    }

    // Get status color
    function getStatusColor(status) {
      switch(status) {
        case 'active': return '#10b981';   // green
        case 'idle': return '#f59e0b';     // orange
        case 'parked': return '#3b82f6';   // blue
        case 'offline': return '#6b7280';  // gray
        default: return '#6b7280';
      }
    }

    // Update map statistics
    function updateMapStatistics() {
      const totalVehicles = fleetVehicles.length;
      const activeVehicles = fleetVehicles.filter(v => v.status === 'active').length;
      const idlingVehicles = fleetVehicles.filter(v => v.status === 'idle').length;
      const parkedVehicles = fleetVehicles.filter(v => v.status === 'parked').length;
      const offlineVehicles = fleetVehicles.filter(v => v.status === 'offline').length;
      
      // Calculate some realistic metrics
      const activeRoutes = activeVehicles;
      const trafficAlerts = Math.floor(activeVehicles * 0.15); // 15% of active vehicles might have alerts
      const coverageArea = Math.floor(totalVehicles * 2.5); // Rough calculation

      document.getElementById('active-vehicles').textContent = activeVehicles;
      document.getElementById('total-routes').textContent = activeRoutes;
      document.getElementById('traffic-alerts').textContent = trafficAlerts;
      document.getElementById('coverage-area').textContent = coverageArea + ' km';
      
      console.log(` Fleet Statistics: Total: ${totalVehicles}, Active: ${activeVehicles}, Idling: ${idlingVehicles}, Parked: ${parkedVehicles}, Offline: ${offlineVehicles}`);
    }

    // Update vehicle positions (simulated)
    function updateVehiclePositions() {
      fleetVehicles.forEach(vehicle => {
        if (vehicle.status === 'active') {
          // Simulate small movement
          vehicle.lat += (Math.random() - 0.5) * 0.002;
          vehicle.lng += (Math.random() - 0.5) * 0.002;
          vehicle.speed = Math.floor(Math.random() * 60) + 10;
        }
      });
      
      addVehicleMarkers();
      updateMapStatistics();
      console.log(' Vehicle positions updated');
    }

    // Center map on fleet
    function centerOnFleet() {
      if (fleetVehicles.length === 0) return;
      
      const extent = vectorSource.getExtent();
      if (extent.every(coord => coord !== Infinity && coord !== -Infinity)) {
        fleetMap.getView().fit(extent, {
          padding: [50, 50, 50, 50],
          maxZoom: 15
        });
      }
    }

    // Toggle traffic layer (simulated for OpenStreetMap)
    function toggleTrafficLayer() {
      isTrafficLayerVisible = !isTrafficLayerVisible;
      const button = document.getElementById('toggle-traffic');
      
      if (isTrafficLayerVisible) {
        button.classList.remove('bg-gray-200', 'text-gray-700');
        button.classList.add('bg-blue-600', 'text-white');
        console.log('Traffic layer simulation enabled (OpenLayers)');
        } else {
        button.classList.remove('bg-blue-600', 'text-white');
        button.classList.add('bg-gray-200', 'text-gray-700');
        console.log('Traffic layer simulation disabled');
      }
    }

    // Toggle clustering
    function toggleClustering() {
      isClusteringEnabled = !isClusteringEnabled;
      const button = document.getElementById('toggle-clustering');
      
      if (isClusteringEnabled) {
        // Enable clustering
        vectorLayer.setSource(clusterSource);
        vectorLayer.setStyle((feature) => {
          return createClusterStyle(feature);
        });
        button.innerHTML = '<i class="fas fa-layer-group mr-1"></i>Clustering ON';
        button.classList.remove('bg-gray-200', 'text-gray-700');
        button.classList.add('bg-purple-600', 'text-white');
        console.log(' Clustering enabled');
      } else {
        // Disable clustering - show individual vehicles
        vectorLayer.setSource(vectorSource);
        vectorLayer.setStyle((feature) => {
          // Individual vehicle style
          const status = feature.get('status');
          const color = getStatusColor(status);
          return new ol.style.Style({
            image: new ol.style.Circle({
              radius: 8,
              fill: new ol.style.Fill({ color: color }),
              stroke: new ol.style.Stroke({ color: 'white', width: 2 })
            })
          });
        });
        button.innerHTML = '<i class="fas fa-layer-group mr-1"></i>Clustering OFF';
        button.classList.remove('bg-purple-600', 'text-white');
        button.classList.add('bg-gray-200', 'text-gray-700');
        console.log(' Clustering disabled - showing individual vehicles');
      }
    }

    // Toggle satellite view
    function toggleSatelliteView() {
      isSatelliteView = !isSatelliteView;
      const button = document.getElementById('toggle-satellite');
      
      if (isSatelliteView) {
        osmLayer.setVisible(false);
        satelliteLayer.setVisible(true);
        button.classList.remove('bg-gray-200', 'text-gray-700');
        button.classList.add('bg-green-600', 'text-white');
      } else {
        osmLayer.setVisible(true);
        satelliteLayer.setVisible(false);
        button.classList.remove('bg-green-600', 'text-white');
        button.classList.add('bg-gray-200', 'text-gray-700');
      }
    }

    // Fallback function if OpenLayers fails
    function initFallbackMap() {
      console.log(' Initializing fallback map...');
      const container = document.getElementById('fleet-map-container');
      if (container) {
        container.innerHTML = `
          <div style="
            height: 100%; 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            position: relative;
            color: #1976d2;
          ">
            <div style="text-align: center; z-index: 10;">
              <i class="fas fa-map-marked-alt text-6xl mb-4"></i>
              <h3 style="font-size: 24px; font-weight: bold; margin: 0 0 8px 0;">Fleet Tracking Map</h3>
              <p style="font-size: 16px; margin: 0 0 16px 0;">100 Total Vehicles in Amman, Jordan</p>
              <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
                <div style="background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; min-width: 80px;">
                  <div style="font-size: 16px; font-weight: bold; color: #10b981;">61</div>
                  <div style="font-size: 11px; color: #6b7280;">Active</div>
                </div>
                <div style="background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; min-width: 80px;">
                  <div style="font-size: 16px; font-weight: bold; color: #f59e0b;">25</div>
                  <div style="font-size: 11px; color: #6b7280;">Idling</div>
                </div>
                <div style="background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; min-width: 80px;">
                  <div style="font-size: 16px; font-weight: bold; color: #3b82f6;">11</div>
                  <div style="font-size: 11px; color: #6b7280;">Parked</div>
                </div>
                <div style="background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; min-width: 80px;">
                  <div style="font-size: 16px; font-weight: bold; color: #6b7280;">3</div>
                  <div style="font-size: 11px; color: #6b7280;">Offline</div>
                </div>
              </div>
            </div>
            <!-- Simulated vehicle positions -->
            <div style="position: absolute; top: 20%; left: 30%; background: #10b981; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>
            <div style="position: absolute; top: 40%; left: 60%; background: #10b981; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>
            <div style="position: absolute; top: 60%; left: 40%; background: #f59e0b; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>
            <div style="position: absolute; top: 30%; left: 70%; background: #10b981; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>
            <div style="position: absolute; top: 70%; left: 25%; background: #ef4444; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>
          </div>
        `;
        
        // Update statistics for fallback
        updateMapStatistics();
      }
    }

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log(' Page loaded, checking OpenLayers...');
      
      // Check if OpenLayers is available
      if (typeof ol !== 'undefined') {
        console.log(' OpenLayers available, initializing...');
        setTimeout(initOpenLayersMap, 500);
      } else {
        console.log(' OpenLayers not available, using fallback...');
        setTimeout(initFallbackMap, 500);
      }
      
      // Set up event listeners
      document.getElementById('center-fleet').addEventListener('click', centerOnFleet);
      document.getElementById('toggle-clustering').addEventListener('click', toggleClustering);
      document.getElementById('create-geofence').addEventListener('click', startGeofenceCreation);
      document.getElementById('toggle-traffic').addEventListener('click', toggleTrafficLayer);
      document.getElementById('toggle-satellite').addEventListener('click', toggleSatelliteView);
      document.getElementById('refresh-vehicles').addEventListener('click', updateVehiclePositions);
      
      // Logout functionality
      setupLogoutFunctionality();
    });

    // Simple Logout Functionality
    function setupLogoutFunctionality() {
      const logoutBtn = document.getElementById('logout-btn');
      
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          handleDirectLogout();
        });
      }
    }

    // ===== FEEDBACK SYSTEM =====
    class FeedbackManager {
      constructor() {
        this.storage = window.feedbackStorage;
        this.setupEventListeners();
      }

      setupEventListeners() {
        // Feedback toggle button
        const feedbackToggle = document.getElementById('feedback-toggle');
        if (feedbackToggle) {
          feedbackToggle.addEventListener('click', () => this.openFeedbackModal());
        }



        // Modal controls
        const closeFeedbackModal = document.getElementById('close-feedback-modal');
        if (closeFeedbackModal) {
          closeFeedbackModal.addEventListener('click', () => this.closeFeedbackModal());
        }



        const cancelFeedbackBtn = document.getElementById('cancel-feedback-btn');
        if (cancelFeedbackBtn) {
          cancelFeedbackBtn.addEventListener('click', () => this.closeFeedbackModal());
        }

        // Form submission
        const feedbackForm = document.getElementById('feedback-form');
        if (feedbackForm) {
          feedbackForm.addEventListener('submit', (e) => this.handleSubmitFeedback(e));
        }

        // Character counter
        const feedbackNote = document.getElementById('feedback-note');
        if (feedbackNote) {
          feedbackNote.addEventListener('input', () => this.updateCharacterCount());
        }

        // Submit another feedback
        const submitAnotherBtn = document.getElementById('submit-another-feedback');
        if (submitAnotherBtn) {
          submitAnotherBtn.addEventListener('click', () => this.resetFeedbackForm());
        }


      }

      openFeedbackModal() {
        const modal = document.getElementById('feedback-modal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
          
          // Focus on first input
          const nameInput = document.getElementById('feedback-name');
          if (nameInput) {
            setTimeout(() => nameInput.focus(), 100);
          }
        }
      }

      closeFeedbackModal() {
        const modal = document.getElementById('feedback-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }



      updateCharacterCount() {
        const textarea = document.getElementById('feedback-note');
        const counter = document.getElementById('char-count');
        if (textarea && counter) {
          const count = textarea.value.length;
          counter.textContent = count;
          
          if (count > 1000) {
            counter.style.color = '#ef4444';
            textarea.value = textarea.value.substring(0, 1000);
            counter.textContent = '1000';
          } else {
            counter.style.color = '#6b7280';
          }
        }
      }



      async handleSubmitFeedback(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-feedback-btn');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
        submitBtn.disabled = true;

        try {
          const formData = new FormData(e.target);
          const feedbackData = {
            id: Date.now().toString(),
            name: formData.get('name'),
            note: formData.get('note'),
            timestamp: new Date().toISOString(),
            system: 'Fleet Dashboard'
          };

          // Validate required fields
          if (!feedbackData.name || !feedbackData.note) {
            throw new Error('Please fill in all required fields');
          }

          // Save to localStorage and Google Sheets
          const success = await this.storage.saveFeedback(feedbackData);
          
          if (success) {
            // Show success message
            this.showSuccessMessage();
          } else {
            throw new Error('Failed to save feedback');
          }
          
        } catch (error) {
          console.error('Error submitting feedback:', error);
          alert('Error submitting feedback: ' + error.message);
          
          // Restore button state
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      async saveFeedback(feedbackData) {
        // Simulate API call delay
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // In a real application, you would send this to your backend API
        // Example:
        // const response = await fetch('/api/feedback', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify(feedbackData)
        // });
        // if (!response.ok) throw new Error('Failed to save feedback');

        // Save using the feedback storage system
        const success = this.storage.saveFeedback(feedbackData);
        if (!success) {
          throw new Error('Failed to save feedback to storage');
        }
        
        console.log('Feedback saved:', feedbackData);
      }

      showSuccessMessage() {
        const form = document.getElementById('feedback-form');
        const success = document.getElementById('feedback-success');
        
        if (form && success) {
          form.classList.add('hidden');
          success.classList.remove('hidden');
        }
      }

      resetFeedbackForm() {
        const form = document.getElementById('feedback-form');
        const success = document.getElementById('feedback-success');
        const submitBtn = document.getElementById('submit-feedback-btn');
        
        if (form) {
          form.reset();
          form.classList.remove('hidden');
        }
        
        if (success) {
          success.classList.add('hidden');
        }
        
        if (submitBtn) {
          submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Feedback';
          submitBtn.disabled = false;
        }

        // Reset character counter
        const counter = document.getElementById('char-count');
        if (counter) {
          counter.textContent = '0';
        }
      }









      showNotification(message, type = 'info') {
        // Create a simple notification
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
          type === 'success' ? 'bg-green-500 text-white' :
          type === 'error' ? 'bg-red-500 text-white' :
          'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }
    }

    // Initialize feedback system
    let feedbackManager;
    document.addEventListener('DOMContentLoaded', function() {
      feedbackManager = new FeedbackManager();
      

    });

    function handleDirectLogout() {
      // Clear all session data
      sessionStorage.clear();
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      localStorage.removeItem('isAuthenticated');
      
      // Clear any other app-specific data
      localStorage.removeItem('fleet-dashboard-tutorial-seen');
      localStorage.removeItem('disclaimerAcknowledged');
      
      // Direct redirect to login page
      window.location.href = 'login.html';
    }
  </script>

  <!-- Bell Notification System -->
  <script>
    // Clean bell notification dropdown with unread badge
    document.addEventListener('DOMContentLoaded', function() {
      const bellButton = document.getElementById('notifications-bell');
      const dropdown = document.getElementById('notifications-dropdown');
      const notificationCount = document.getElementById('notification-count');
      const markAllReadBtn = document.getElementById('mark-all-read');
      
      if (bellButton && dropdown && notificationCount) {
        let unreadCount = 3; // Initial unread count
        
        // Update badge count
        function updateBadgeCount(count = unreadCount) {
          unreadCount = count;
          notificationCount.textContent = unreadCount;
          notificationCount.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
        
        // Toggle dropdown
        bellButton.addEventListener('click', function(e) {
          e.stopPropagation();
          
          const isHidden = dropdown.classList.contains('hidden');
          
          if (isHidden) {
            // Show dropdown
            dropdown.classList.remove('hidden');
            dropdown.style.display = 'block';
            dropdown.style.visibility = 'visible';
            dropdown.style.opacity = '1';
            dropdown.style.zIndex = '9999999';
            dropdown.style.position = 'fixed';
            dropdown.style.top = '80px';
            dropdown.style.right = '20px';
            dropdown.style.pointerEvents = 'auto';
            bellButton.setAttribute('aria-expanded', 'true');
            
            console.log('Dropdown shown:', {
              hidden: dropdown.classList.contains('hidden'),
              display: dropdown.style.display,
              visibility: dropdown.style.visibility,
              opacity: dropdown.style.opacity,
              zIndex: dropdown.style.zIndex,
              position: dropdown.style.position,
              top: dropdown.style.top,
              right: dropdown.style.right
            });
          } else {
            // Hide dropdown
            dropdown.classList.add('hidden');
            dropdown.style.display = 'none';
            dropdown.style.visibility = 'hidden';
            dropdown.style.opacity = '0';
            bellButton.setAttribute('aria-expanded', 'false');
          }
        });
        
        // Mark all as read
        if (markAllReadBtn) {
          markAllReadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            updateBadgeCount(0);
            
            // Mark all notification items as read visually
            const notificationItems = dropdown.querySelectorAll('.notification-item');
            notificationItems.forEach(item => {
              item.style.opacity = '0.6';
              item.classList.add('read');
            });
          });
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!dropdown.contains(e.target) && !bellButton.contains(e.target)) {
            dropdown.classList.add('hidden');
            bellButton.setAttribute('aria-expanded', 'false');
          }
        });
        
        // Close dropdown on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && !dropdown.classList.contains('hidden')) {
            dropdown.classList.add('hidden');
            bellButton.setAttribute('aria-expanded', 'false');
            bellButton.focus();
          }
        });
        
        // Initialize badge count
        updateBadgeCount();
        
        // Expose function for external use
        window.updateNotificationCount = updateBadgeCount;
        
        // Test function to debug dropdown visibility
        window.testNotificationDropdown = function() {
          console.log('Testing notification dropdown...');
          console.log('Dropdown element:', dropdown);
          console.log('Dropdown classes:', dropdown.className);
          console.log('Dropdown styles:', {
            display: dropdown.style.display,
            visibility: dropdown.style.visibility,
            opacity: dropdown.style.opacity,
            zIndex: dropdown.style.zIndex,
            position: dropdown.style.position,
            top: dropdown.style.top,
            right: dropdown.style.right,
            hidden: dropdown.classList.contains('hidden')
          });
          console.log('Dropdown computed styles:', window.getComputedStyle(dropdown));
          
          // Force show dropdown for testing with debugging styles
          dropdown.classList.remove('hidden');
          dropdown.style.display = 'block';
          dropdown.style.visibility = 'visible';
          dropdown.style.opacity = '1';
          dropdown.style.zIndex = '9999999';
          dropdown.style.position = 'fixed';
          dropdown.style.top = '80px';
          dropdown.style.right = '20px';
          dropdown.style.pointerEvents = 'auto';
          dropdown.style.background = 'red';
          dropdown.style.border = '5px solid yellow';
          dropdown.style.minHeight = '200px';
          dropdown.style.minWidth = '320px';
          
          console.log('Dropdown forced visible for testing with red background and yellow border');
          console.log('Check if you can see a red box with yellow border at top-right of screen');
        };
        
        console.log('Bell notification system initialized successfully');
        console.log('Test dropdown with: testNotificationDropdown()');
      } else {
        console.error('Bell notification elements not found:', {
          bellButton: !!bellButton,
          dropdown: !!dropdown,
          notificationCount: !!notificationCount
        });
      }
    });
  </script>

  <!-- Driver Leaderboard Action Buttons Functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get button elements
      const assignCoachingBtn = document.getElementById('assign-coaching-btn');
      const grantRecognitionBtn = document.getElementById('grant-recognition-btn');
      const rewardPerformerBtn = document.getElementById('reward-performer-btn');
      
      // Get modal elements
      const coachingModal = document.getElementById('coaching-assignment-modal');
      const recognitionModal = document.getElementById('recognition-grant-modal');
      const rewardModal = document.getElementById('reward-performers-modal');
      
      // Get close buttons
      const closeCoachingModal = document.getElementById('close-coaching-modal');
      const closeRecognitionModal = document.getElementById('close-recognition-modal');
      const closeRewardModal = document.getElementById('close-reward-modal');
      
      // Get cancel buttons
      const cancelCoaching = document.getElementById('cancel-coaching');
      const cancelRecognition = document.getElementById('cancel-recognition');
      const cancelReward = document.getElementById('cancel-reward');
      
      // Assign Coaching Button
      if (assignCoachingBtn && coachingModal) {
        assignCoachingBtn.addEventListener('click', function() {
          coachingModal.classList.remove('hidden');
          console.log(' Coaching assignment modal opened');
        });
      }
      
      // Grant Recognition Button
      if (grantRecognitionBtn && recognitionModal) {
        grantRecognitionBtn.addEventListener('click', function() {
          recognitionModal.classList.remove('hidden');
          console.log(' Recognition grant modal opened');
        });
      }
      
      // Reward Top Performers Button
      if (rewardPerformerBtn && rewardModal) {
        rewardPerformerBtn.addEventListener('click', function() {
          rewardModal.classList.remove('hidden');
          console.log(' Reward performers modal opened');
        });
      }
      
      // Close Modal Functions
      function closeModal(modal) {
        if (modal) {
          modal.classList.add('hidden');
        }
      }
      
      // Close button event listeners
      if (closeCoachingModal) {
        closeCoachingModal.addEventListener('click', () => closeModal(coachingModal));
      }
      if (closeRecognitionModal) {
        closeRecognitionModal.addEventListener('click', () => closeModal(recognitionModal));
      }
      if (closeRewardModal) {
        closeRewardModal.addEventListener('click', () => closeModal(rewardModal));
      }
      
      // Cancel button event listeners
      if (cancelCoaching) {
        cancelCoaching.addEventListener('click', () => closeModal(coachingModal));
      }
      if (cancelRecognition) {
        cancelRecognition.addEventListener('click', () => closeModal(recognitionModal));
      }
      if (cancelReward) {
        cancelReward.addEventListener('click', () => closeModal(rewardModal));
      }
      
      // Close modal when clicking outside
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('bg-black')) {
          closeModal(coachingModal);
          closeModal(recognitionModal);
          closeModal(rewardModal);
        }
      });
      
      // Close modal on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal(coachingModal);
          closeModal(recognitionModal);
          closeModal(rewardModal);
        }
      });
      
      // Form submission handlers
      const coachingForm = document.getElementById('coaching-assignment-form');
      const recognitionForm = document.getElementById('recognition-grant-form');
      const rewardForm = document.getElementById('reward-performers-form');
      
      if (coachingForm) {
        coachingForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(coachingForm);
          console.log(' Coaching assignment submitted:', {
            driver: formData.get('coaching-driver'),
            type: formData.get('coaching-type'),
            priority: formData.get('coaching-priority'),
            notes: formData.get('coaching-notes')
          });
          
          // Show success message
          showActionNotification('Coaching assignment created successfully!', 'success');
          closeModal(coachingModal);
          coachingForm.reset();
        });
      }
      
      if (recognitionForm) {
        recognitionForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(recognitionForm);
          console.log(' Recognition granted:', {
            driver: formData.get('recognition-driver'),
            type: formData.get('recognition-type'),
            message: formData.get('recognition-message')
          });
          
          // Show success message
          showActionNotification('Recognition granted successfully!', 'success');
          closeModal(recognitionModal);
          recognitionForm.reset();
        });
      }
      
      if (rewardForm) {
        rewardForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const formData = new FormData(rewardForm);
          console.log(' Rewards distributed:', {
            criteria: formData.get('selection-criteria'),
            message: formData.get('reward-message')
          });
          
          // Show success message
          showActionNotification('Rewards distributed successfully!', 'success');
          closeModal(rewardModal);
          rewardForm.reset();
        });
      }
      
      // Handle custom recognition type toggle
      const customRecognitionDetails = document.getElementById('custom-recognition-details');
      const recognitionTypeRadios = document.querySelectorAll('input[name="recognition-type"]');
      
      if (customRecognitionDetails && recognitionTypeRadios.length > 0) {
        recognitionTypeRadios.forEach(radio => {
          radio.addEventListener('change', function() {
            if (this.value === 'custom') {
              customRecognitionDetails.classList.remove('hidden');
            } else {
              customRecognitionDetails.classList.add('hidden');
            }
          });
        });
      }
      
      console.log(' Driver leaderboard action buttons initialized successfully');
    });
  </script>

</body>
</html>
